<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vynix Channel</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+akarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <style>
        :root {
            --primary: #3a76f0;
            --primary-dark: #2563eb;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border-light: #e5e7eb;
            --chat-sent: #3a76f0;
            --chat-received: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --online: #10b981;
            --danger: #ef4444;
            --typing: #f59e0b;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #4f86f7;
                --bg-body: #000000;
                --bg-card: #1c1c1e;
                --text-main: #f9fafb;
                --text-muted: #9ca3af;
                --border-light: #27272a;
                --chat-sent: #3a76f0;
                --chat-received: #2c2c2e;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            background: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Header - Fixed at top */
        #chatHeader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 12px;
            z-index: 100;
            padding-top: env(safe-area-inset-top);
        }

        @media (prefers-color-scheme: dark) { 
            #chatHeader { 
                background: rgba(28,28,30,0.98); 
            } 
        }

        #channelInfo {
            display: flex;
            align-items: center;
            flex: 1;
            overflow: hidden;
            margin-left: 8px;
        }

        #channelAvatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        #channelName {
            font-weight: 700;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #channelStatus {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #onlineCount {
            display: flex;
            align-items: center;
            gap: 3px;
            color: var(--online);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-actions span {
            font-size: 22px;
            cursor: pointer;
            color: var(--text-main);
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        /* Message List - Scrollable area */
        #messageList {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            padding-top: calc(56px + env(safe-area-inset-top) + 12px);
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: var(--bg-body);
            -webkit-overflow-scrolling: touch;
        }

        .date-separator {
            text-align: center;
            margin: 16px 0;
            position: sticky;
            top: 8px;
            z-index: 5;
        }

        .date-separator span {
            background: var(--bg-card);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .message-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 6px;
            max-width: 85%;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-group.own {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message-group.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-sender {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
            padding: 0 4px;
        }

        .sender-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }

        .sender-name {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .message-bubble {
            background: var(--chat-received);
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
            max-width: 100%;
        }

        .message-group.own .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-group.other .message-bubble {
            border-bottom-left-radius: 4px;
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            font-size: 11px;
            opacity: 0.7;
            justify-content: flex-end;
        }

        .message-group.other .message-meta {
            justify-content: flex-start;
            padding-left: 4px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: 8px;
            box-shadow: var(--shadow-sm);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Floating Input Area - WhatsApp Style */
        #chatInputContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-body);
            padding: 8px 12px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            z-index: 100;
            border-top: 1px solid transparent;
        }

        #chatInputContainer.has-content {
            border-top-color: var(--border-light);
        }

        #chatInputArea {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 100%;
        }

        .input-wrapper {
            flex: 1;
            background: var(--bg-card);
            border-radius: 24px;
            padding: 8px 16px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-height: 120px;
            overflow: hidden;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 16px;
            min-height: 24px;
            max-height: 100px;
            resize: none;
            color: var(--text-main);
            padding: 4px 0;
            line-height: 1.4;
            outline: none;
            -webkit-appearance: none;
        }

        #messageInput::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-bottom: 2px;
        }

        .input-actions span {
            font-size: 22px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .input-actions span:hover {
            background: var(--bg-body);
            color: var(--primary);
        }

        #sendBtn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            border: none;
            transition: all 0.2s;
            opacity: 0.6;
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(58, 118, 240, 0.3);
        }

        #sendBtn.active {
            opacity: 1;
            transform: scale(1);
        }

        #sendBtn:active {
            transform: scale(0.95);
        }

        #sendBtn span {
            font-size: 20px;
        }

        /* Scroll to bottom button */
        #scrollBottomBtn {
            position: fixed;
            bottom: 90px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-card);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            border: none;
        }

        #scrollBottomBtn.show {
            opacity: 1;
            transform: translateY(0);
        }

        #scrollBottomBtn span {
            font-size: 20px;
        }

        #scrollBottomBtn .unread-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        /* User List Sidebar */
        #userSidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 320px;
            height: 100%;
            background: var(--bg-card);
            box-shadow: -4px 0 24px rgba(0,0,0,0.15);
            z-index: 3000;
            transition: right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        #userSidebar.open {
            right: 0;
        }

        .sidebar-header {
            padding: 16px;
            padding-top: calc(16px + env(safe-area-inset-top));
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
        }

        .sidebar-close {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .sidebar-close:hover {
            background: var(--bg-body);
        }

        #userList {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: var(--bg-body);
        }

        .user-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }

        .user-item .user-info {
            flex: 1;
        }

        .user-item .user-name {
            font-weight: 600;
            font-size: 15px;
        }

        .user-item .user-status {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online);
        }

        .status-dot.offline {
            background: var(--text-muted);
        }

        #sidebarOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2500;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #sidebarOverlay.show {
            display: block;
            opacity: 1;
        }

        /* Profile Setup Modal */
        #profileModal {
            position: fixed;
            inset: 0;
            background: var(--bg-body);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .profile-setup-container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .profile-setup-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .profile-setup-subtitle {
            color: var(--text-muted);
            margin-bottom: 32px;
            font-size: 15px;
        }

        .avatar-upload {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--bg-card);
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 3px dashed var(--border-light);
            transition: all 0.2s;
        }

        .avatar-upload:hover {
            border-color: var(--primary);
        }

        .avatar-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload .material-symbols-rounded {
            font-size: 40px;
            color: var(--text-muted);
        }

        .avatar-upload input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .name-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-main);
            margin-bottom: 24px;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
        }

        .name-input:focus {
            border-color: var(--primary);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Toast */
        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            z-index: 4000;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #toast.show {
            opacity: 1;
        }

        /* Loading */
        #pageLoader {
            position: fixed;
            inset: 0;
            background: var(--primary);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.5s;
        }

        .loader-content {
            text-align: center;
        }

        .loader-logo {
            width: 72px;
            height: 72px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .loader-logo .material-symbols-rounded {
            font-size: 40px;
            color: var(--primary);
        }

        .hidden {
            display: none !important;
        }

        /* Message Actions */
        .message-actions {
            position: absolute;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 8px 0;
            z-index: 200;
            display: none;
            min-width: 160px;
        }

        .message-actions.show {
            display: block;
        }

        .message-action-item {
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-action-item:hover {
            background: var(--bg-body);
        }

        .message-action-item.delete {
            color: var(--danger);
        }

        /* Reactions */
        .reactions-bar {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .reaction {
            background: rgba(0,0,0,0.05);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.2s;
            user-select: none;
        }

        .reaction:hover {
            transform: scale(1.1);
        }

        .reaction.active {
            background: var(--primary);
            color: white;
        }

        .reaction-picker {
            position: fixed;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 12px;
            display: none;
            gap: 8px;
            z-index: 300;
        }

        .reaction-picker.show {
            display: flex;
        }

        .reaction-emoji {
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s;
            user-select: none;
        }

        .reaction-emoji:hover {
            transform: scale(1.2);
            background: var(--bg-body);
        }

        /* System Message */
        .system-message {
            text-align: center;
            padding: 8px 16px;
            margin: 8px 0;
        }

        .system-message span {
            background: rgba(0,0,0,0.05);
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }

        @media (prefers-color-scheme: dark) {
            .system-message span {
                background: rgba(255,255,255,0.05);
            }
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .message-group {
                max-width: 90%;
            }
            
            #messageList {
                padding: 10px;
                padding-top: calc(56px + env(safe-area-inset-top) + 10px);
                padding-bottom: calc(76px + env(safe-area-inset-bottom));
            }
        }

        /* iPhone specific fixes */
        @supports (-webkit-touch-callout: none) {
            #chatInputContainer {
                transform: translateZ(0);
            }
        }
    </style>
</head>
<body>
    <!-- Page Loader -->
    <div id="pageLoader">
        <div class="loader-content">
            <div class="loader-logo">
                <span class="material-symbols-rounded">chat</span>
            </div>
            <h2 style="font-size: 20px; margin-bottom: 6px;">Vynix Channel</h2>
            <p style="opacity: 0.8; font-size: 14px;">Connecting...</p>
        </div>
    </div>

    <!-- Profile Setup Modal -->
    <div id="profileModal" class="hidden">
        <div class="profile-setup-container">
            <h1 class="profile-setup-title">Join the Channel</h1>
            <p class="profile-setup-subtitle">Set up your profile to start chatting</p>
            
            <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
                <span class="material-symbols-rounded">add_a_photo</span>
                <img id="avatarPreview" class="hidden">
                <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarSelect(event)">
            </div>
            
            <input type="text" id="nameInput" class="name-input" placeholder="Your name" maxlength="20">
            <button class="btn-primary" onclick="joinChannel()">Join Channel</button>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="mainInterface" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Fixed Header -->
        <div id="chatHeader">
            <span class="material-symbols-rounded" onclick="toggleUserSidebar()" style="padding: 8px;">menu</span>
            <div id="channelInfo">
                <div id="channelAvatar">V</div>
                <div>
                    <div id="channelName">Global Channel</div>
                    <div id="channelStatus">
                        <span id="onlineCount">
                            <span class="material-symbols-rounded" style="font-size: 14px;">group</span>
                            <span id="onlineNumber">0</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <span class="material-symbols-rounded" onclick="toggleSound()" id="soundBtn">volume_up</span>
                <span class="material-symbols-rounded" onclick="toggleUserSidebar()">more_vert</span>
            </div>
        </div>

        <!-- Scrollable Message List -->
        <div id="messageList"></div>

        <!-- Scroll to Bottom Button -->
        <button id="scrollBottomBtn" onclick="scrollToBottom()">
            <span class="material-symbols-rounded">arrow_downward</span>
        </button>

        <!-- Floating Input Area -->
        <div id="chatInputContainer">
            <div id="chatInputArea">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        rows="1" 
                        placeholder="Message..." 
                        oninput="handleInput()" 
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <div class="input-actions">
                        <span class="material-symbols-rounded" onclick="showEmojiPicker()">mood</span>
                        <span class="material-symbols-rounded" onclick="attachFile()">attach_file</span>
                    </div>
                </div>
                <button id="sendBtn" onclick="sendMessage()">
                    <span class="material-symbols-rounded">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- User Sidebar -->
    <div id="sidebarOverlay" onclick="toggleUserSidebar()"></div>
    <div id="userSidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Online Users</div>
            <span class="material-symbols-rounded sidebar-close" onclick="toggleUserSidebar()">close</span>
        </div>
        <div id="userList"></div>
    </div>

    <!-- Reaction Picker -->
    <div id="reactionPicker" class="reaction-picker">
        <span class="reaction-emoji" onclick="addReaction('üëç')">üëç</span>
        <span class="reaction-emoji" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="reaction-emoji" onclick="addReaction('üòÇ')">üòÇ</span>
        <span class="reaction-emoji" onclick="addReaction('üòÆ')">üòÆ</span>
        <span class="reaction-emoji" onclick="addReaction('üî•')">üî•</span>
        <span class="reaction-emoji" onclick="addReaction('üëè')">üëè</span>
    </div>

    <!-- Message Actions -->
    <div id="messageActions" class="message-actions">
        <div class="message-action-item" onclick="copyMessage()">
            <span class="material-symbols-rounded">content_copy</span> Copy
        </div>
        <div class="message-action-item delete" onclick="deleteMessage()">
            <span class="material-symbols-rounded">delete</span> Delete
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // State
        let currentUser = null;
        let userProfile = null;
        let messagesRef = null;
        let usersRef = null;
        let typingRef = null;
        let selectedMessage = null;
        let soundEnabled = true;
        let lastMessageDate = null;
        let unreadCount = 0;
        let isNearBottom = true;

        // Audio context for notification sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playNotificationSound() {
            if (!soundEnabled) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Anonymous auth
        auth.signInAnonymously().catch(console.error);

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                checkUserProfile();
            }
        });

        function checkUserProfile() {
            db.ref(`channel/users/${currentUser.uid}`).once('value', snap => {
                const profile = snap.val();
                if (profile && profile.name) {
                    userProfile = profile;
                    enterChannel();
                } else {
                    showProfileSetup();
                }
            });
        }

        function showProfileSetup() {
            document.getElementById('pageLoader').style.display = 'none';
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('avatarPreview').src = e.target.result;
                    document.getElementById('avatarPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function joinChannel() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                toast('Please enter your name');
                return;
            }

            const avatarInput = document.getElementById('avatarInput');
            let photoURL = null;

            if (avatarInput.files[0]) {
                const file = avatarInput.files[0];
                const storageRef = storage.ref(`avatars/${currentUser.uid}`);
                await storageRef.put(file);
                photoURL = await storageRef.getDownloadURL();
            } else {
                photoURL = generateLetterAvatar(name);
            }

            userProfile = {
                name: name,
                photo: photoURL,
                joinedAt: Date.now(),
                lastSeen: Date.now()
            };

            await db.ref(`channel/users/${currentUser.uid}`).set(userProfile);
            enterChannel();
        }

        function generateLetterAvatar(name) {
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            const colors = ['#3a76f0', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            const hash = name.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            const bg = colors[hash % colors.length];
            
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, 100, 100);
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 40px "Plus Jakarta Sans", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name.charAt(0).toUpperCase(), 50, 50);
            
            return canvas.toDataURL();
        }

        function enterChannel() {
            document.getElementById('profileModal').classList.add('hidden');
            document.getElementById('pageLoader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('pageLoader').style.display = 'none';
                document.getElementById('mainInterface').classList.remove('hidden');
                setupScrollListener();
            }, 500);

            setupPresence();
            loadMessages();
            loadUsers();
            setupTypingIndicator();
        }

        function setupScrollListener() {
            const list = document.getElementById('messageList');
            
            list.addEventListener('scroll', () => {
                const threshold = 100;
                const position = list.scrollHeight - list.scrollTop - list.clientHeight;
                isNearBottom = position < threshold;
                
                const btn = document.getElementById('scrollBottomBtn');
                if (!isNearBottom && unreadCount > 0) {
                    btn.classList.add('show');
                    if (!btn.querySelector('.unread-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.textContent = unreadCount;
                        btn.appendChild(badge);
                    } else {
                        btn.querySelector('.unread-badge').textContent = unreadCount;
                    }
                } else {
                    btn.classList.remove('show');
                    unreadCount = 0;
                }
            });
        }

        function scrollToBottom() {
            const list = document.getElementById('messageList');
            list.scrollTop = list.scrollHeight;
            unreadCount = 0;
            document.getElementById('scrollBottomBtn').classList.remove('show');
        }

        function setupPresence() {
            const userStatusRef = db.ref(`channel/users/${currentUser.uid}/lastSeen`);
            const connectedRef = db.ref('.info/connected');
            
            connectedRef.on('value', snap => {
                if (snap.val()) {
                    userStatusRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                    userStatusRef.set(firebase.database.ServerValue.TIMESTAMP);
                }
            });

            setInterval(() => {
                userStatusRef.set(firebase.database.ServerValue.TIMESTAMP);
            }, 30000);
        }

        function loadMessages() {
            messagesRef = db.ref('channel/messages').limitToLast(100);
            
            messagesRef.on('child_added', snap => {
                const msg = snap.val();
                msg.key = snap.key;
                displayMessage(msg);
                
                if (msg.sender !== currentUser.uid && !msg.system) {
                    playNotificationSound();
                    if (!isNearBottom) {
                        unreadCount++;
                    }
                }
            });

            messagesRef.on('child_changed', snap => {
                updateMessageReactions(snap.key, snap.val().reactions);
            });

            messagesRef.on('child_removed', snap => {
                removeMessage(snap.key);
            });
        }

        function displayMessage(msg) {
            const list = document.getElementById('messageList');
            const isOwn = msg.sender === currentUser.uid;
            
            const msgDate = new Date(msg.timestamp).toDateString();
            if (msgDate !== lastMessageDate) {
                lastMessageDate = msgDate;
                const separator = document.createElement('div');
                separator.className = 'date-separator';
                separator.innerHTML = `<span>${formatDate(msg.timestamp)}</span>`;
                list.appendChild(separator);
            }

            if (msg.system) {
                const div = document.createElement('div');
                div.className = 'system-message';
                div.innerHTML = `<span>${msg.text}</span>`;
                div.dataset.key = msg.key;
                list.appendChild(div);
            } else {
                const group = document.createElement('div');
                group.className = `message-group ${isOwn ? 'own' : 'other'}`;
                group.dataset.key = msg.key;
                group.dataset.sender = msg.sender;

                const sender = document.createElement('div');
                sender.className = 'message-sender';
                
                if (!isOwn) {
                    sender.innerHTML = `
                        <img src="${msg.senderPhoto || generateLetterAvatar(msg.senderName)}" class="sender-avatar">
                        <span class="sender-name">${escapeHtml(msg.senderName)}</span>
                    `;
                }

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = msg.text;

                const meta = document.createElement('div');
                meta.className = 'message-meta';
                meta.innerHTML = formatTime(msg.timestamp);

                if (msg.reactions) {
                    const reactionsBar = document.createElement('div');
                    reactionsBar.className = 'reactions-bar';
                    reactionsBar.id = `reactions-${msg.key}`;
                    
                    Object.entries(msg.reactions).forEach(([emoji, users]) => {
                        if (users.length > 0) {
                            const reaction = document.createElement('div');
                            reaction.className = 'reaction';
                            if (users.includes(currentUser.uid)) reaction.classList.add('active');
                            reaction.innerHTML = `${emoji} ${users.length}`;
                            reaction.onclick = () => toggleReaction(msg.key, emoji);
                            reactionsBar.appendChild(reaction);
                        }
                    });
                    
                    bubble.appendChild(reactionsBar);
                }

                let pressTimer;
                bubble.addEventListener('touchstart', e => {
                    pressTimer = setTimeout(() => showReactionPicker(e, msg.key), 500);
                });
                bubble.addEventListener('touchend', () => clearTimeout(pressTimer));
                bubble.addEventListener('touchmove', () => clearTimeout(pressTimer));
                bubble.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    showReactionPicker(e, msg.key);
                });

                if (isOwn) {
                    bubble.addEventListener('click', e => showMessageActions(e, msg));
                }

                group.appendChild(sender);
                group.appendChild(bubble);
                group.appendChild(meta);
                list.appendChild(group);
            }

            if (isNearBottom) {
                list.scrollTop = list.scrollHeight;
            }
        }

        function updateMessageReactions(msgKey, reactions) {
            const msgEl = document.querySelector(`[data-key="${msgKey}"]`);
            if (!msgEl) return;

            let reactionsBar = msgEl.querySelector('.reactions-bar');
            if (!reactionsBar && reactions) {
                reactionsBar = document.createElement('div');
                reactionsBar.className = 'reactions-bar';
                reactionsBar.id = `reactions-${msgKey}`;
                msgEl.querySelector('.message-bubble').appendChild(reactionsBar);
            }

            if (reactionsBar) {
                reactionsBar.innerHTML = '';
                Object.entries(reactions).forEach(([emoji, users]) => {
                    if (users.length > 0) {
                        const reaction = document.createElement('div');
                        reaction.className = 'reaction';
                        if (users.includes(currentUser.uid)) reaction.classList.add('active');
                        reaction.innerHTML = `${emoji} ${users.length}`;
                        reaction.onclick = () => toggleReaction(msgKey, emoji);
                        reactionsBar.appendChild(reaction);
                    }
                });
            }
        }

        function removeMessage(msgKey) {
            const msgEl = document.querySelector(`[data-key="${msgKey}"]`);
            if (msgEl) msgEl.remove();
        }

        function loadUsers() {
            usersRef = db.ref('channel/users');
            
            usersRef.on('value', snap => {
                const users = [];
                let onlineCount = 0;
                const now = Date.now();
                
                snap.forEach(child => {
                    const user = child.val();
                    user.uid = child.key;
                    user.isOnline = (now - user.lastSeen) < 120000;
                    if (user.isOnline) onlineCount++;
                    users.push(user);
                });

                document.getElementById('onlineNumber').textContent = onlineCount;
                renderUserList(users);
            });
        }

        function renderUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            
            users.sort((a, b) => {
                if (a.isOnline !== b.isOnline) return b.isOnline - a.isOnline;
                return a.name.localeCompare(b.name);
            });

            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'user-item';
                item.innerHTML = `
                    <img src="${user.photo || generateLetterAvatar(user.name)}" class="avatar">
                    <div class="user-info">
                        <div class="user-name">${escapeHtml(user.name)} ${user.uid === currentUser.uid ? '(You)' : ''}</div>
                        <div class="user-status">
                            <span class="status-dot ${user.isOnline ? '' : 'offline'}"></span>
                            ${user.isOnline ? 'Online' : 'Offline'}
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function setupTypingIndicator() {
            const input = document.getElementById('messageInput');
            let typingTimeout;
            
            input.addEventListener('input', () => {
                const typingRef = db.ref(`channel/typing/${currentUser.uid}`);
                typingRef.set(true);
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    typingRef.remove();
                }, 3000);
            });

            db.ref('channel/typing').on('value', snap => {
                const typing = snap.val() || {};
                const othersTyping = Object.keys(typing).filter(uid => uid !== currentUser.uid);
                
                const indicator = document.getElementById('typingIndicator');
                if (othersTyping.length > 0) {
                    if (!document.getElementById('typingIndicator')) {
                        const div = document.createElement('div');
                        div.id = 'typingIndicator';
                        div.className = 'typing-indicator';
                        div.innerHTML = `
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <span style="font-size: 13px; color: var(--text-muted);">Someone is typing...</span>
                        `;
                        document.getElementById('messageList').appendChild(div);
                    }
                    scrollToBottom();
                } else {
                    const existing = document.getElementById('typingIndicator');
                    if (existing) existing.remove();
                }
            });
        }

        function handleInput() {
            const input = document.getElementById('messageInput');
            const btn = document.getElementById('sendBtn');
            const container = document.getElementById('chatInputContainer');
            
            input.style.height = 'auto';
            const newHeight = Math.min(input.scrollHeight, 100);
            input.style.height = newHeight + 'px';
            
            if (input.value.trim().length > 0) {
                btn.classList.add('active');
                container.classList.add('has-content');
            } else {
                btn.classList.remove('active');
                container.classList.remove('has-content');
            }
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;

            const message = {
                text: text,
                sender: currentUser.uid,
                senderName: userProfile.name,
                senderPhoto: userProfile.photo,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                reactions: {}
            };

            await db.ref('channel/messages').push(message);
            
            db.ref(`channel/typing/${currentUser.uid}`).remove();
            
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('sendBtn').classList.remove('active');
            document.getElementById('chatInputContainer').classList.remove('has-content');
            
            scrollToBottom();
        }

        function showReactionPicker(e, msgKey) {
            e.stopPropagation();
            const picker = document.getElementById('reactionPicker');
            picker.dataset.msgKey = msgKey;
            
            const x = e.pageX || (e.touches && e.touches[0].pageX) || window.innerWidth / 2;
            const y = e.pageY || (e.touches && e.touches[0].pageY) || window.innerHeight / 2;
            
            const pickerWidth = 280;
            const pickerHeight = 60;
            
            let left = Math.min(x - pickerWidth / 2, window.innerWidth - pickerWidth - 16);
            left = Math.max(16, left);
            
            let top = y - pickerHeight - 10;
            if (top < 100) top = y + 20;
            
            picker.style.left = left + 'px';
            picker.style.top = top + 'px';
            picker.classList.add('show');
            
            setTimeout(() => {
                document.addEventListener('click', hideReactionPicker);
            }, 100);
        }

        function hideReactionPicker() {
            document.getElementById('reactionPicker').classList.remove('show');
            document.removeEventListener('click', hideReactionPicker);
        }

        function addReaction(emoji) {
            const picker = document.getElementById('reactionPicker');
            const msgKey = picker.dataset.msgKey;
            if (msgKey) toggleReaction(msgKey, emoji);
            hideReactionPicker();
        }

        async function toggleReaction(msgKey, emoji) {
            const ref = db.ref(`channel/messages/${msgKey}/reactions/${emoji}`);
            const snap = await ref.once('value');
            const users = snap.val() || [];
            
            if (users.includes(currentUser.uid)) {
                const updated = users.filter(uid => uid !== currentUser.uid);
                if (updated.length === 0) {
                    ref.remove();
                } else {
                    ref.set(updated);
                }
            } else {
                ref.set([...users, currentUser.uid]);
            }
        }

        function showMessageActions(e, msg) {
            e.stopPropagation();
            selectedMessage = msg;
            
            const actions = document.getElementById('messageActions');
            const rect = e.target.getBoundingClientRect();
            
            let left = rect.left;
            let top = rect.bottom + 5;
            
            if (left + 160 > window.innerWidth) {
                left = window.innerWidth - 170;
            }
            
            actions.style.left = left + 'px';
            actions.style.top = top + 'px';
            actions.classList.add('show');
            
            setTimeout(() => {
                document.addEventListener('click', hideMessageActions);
            }, 100);
        }

        function hideMessageActions() {
            document.getElementById('messageActions').classList.remove('show');
            document.removeEventListener('click', hideMessageActions);
        }

        function copyMessage() {
            if (selectedMessage) {
                navigator.clipboard.writeText(selectedMessage.text);
                toast('Copied');
            }
            hideMessageActions();
        }

        async function deleteMessage() {
            if (selectedMessage && selectedMessage.sender === currentUser.uid) {
                await db.ref(`channel/messages/${selectedMessage.key}`).remove();
                toast('Deleted');
            }
            hideMessageActions();
        }

        function toggleUserSidebar() {
            const sidebar = document.getElementById('userSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundBtn');
            btn.textContent = soundEnabled ? 'volume_up' : 'volume_off';
            toast(soundEnabled ? 'Sound on' : 'Sound off');
        }

        function showEmojiPicker() {
            toast('Emoji picker coming soon');
        }

        function attachFile() {
            toast('File sharing coming soon');
        }

        function toast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
            return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined });
        }

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && userProfile) {
                db.ref(`channel/users/${currentUser.uid}/lastSeen`).set(firebase.database.ServerValue.TIMESTAMP);
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                db.ref(`channel/typing/${currentUser.uid}`).remove();
            }
        });

        // Prevent zoom on iOS
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('gesturechange', e => e.preventDefault());
        document.addEventListener('gestureend', e => e.preventDefault());
    </script>
</body>
</html>
