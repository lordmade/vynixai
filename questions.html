<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Secure • Study Chat</title>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary: #4285F4;
      --bg: #F8FAFD;
      --surface: #FFFFFF;
      --text: #1F1F1F;
      --text-muted: #70757a;
      --shimmer: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
    body { background: var(--bg); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

    /* Header */
    .header { 
      padding: 16px 24px; background: var(--surface); 
      border-bottom: 1px solid #E1E5EA; display: flex; 
      justify-content: space-between; align-items: center;
      z-index: 10;
    }

    /* Chat Body */
    #chatContainer { 
      flex: 1; overflow-y: auto; padding: 20px; 
      display: flex; flex-direction: column; gap: 16px;
      scroll-behavior: smooth;
    }

    /* Bubbles */
    .msg-group { display: flex; flex-direction: column; max-width: 80%; position: relative; animation: fadeIn 0.3s ease; }
    .msg-group.me { align-self: flex-end; align-items: flex-end; }
    .msg-group.them { align-self: flex-start; align-items: flex-start; }

    .msg-bubble { 
      padding: 10px 14px; border-radius: 18px; position: relative; 
      display: flex; flex-direction: column; gap: 2px;
    }
    .me .msg-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .them .msg-bubble { background: var(--surface); color: var(--text); border-bottom-left-radius: 4px; border: 1px solid #E1E5EA; }

    .msg-info { font-size: 0.75rem; font-weight: 600; margin-bottom: 2px; color: var(--text-muted); }
    .me .msg-info { color: var(--primary); margin-right: 4px; }

    .msg-text { font-size: 0.95rem; line-height: 1.4; word-break: break-word; }
    .msg-time { font-size: 0.65rem; align-self: flex-end; opacity: 0.7; margin-top: 2px; }

    /* Delete Button */
    .delete-btn { 
      position: absolute; left: -25px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: #EA4335; cursor: pointer; opacity: 0; transition: 0.2s;
    }
    .msg-group.me:hover .delete-btn { opacity: 1; }

    /* Skeleton Loading */
    .skeleton-wrapper { display: flex; flex-direction: column; gap: 12px; padding: 20px; }
    .skeleton { height: 60px; border-radius: 18px; background: var(--shimmer); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    .skeleton.sm { width: 60%; }
    .skeleton.lg { width: 85%; align-self: flex-end; }

    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Input Area */
    .input-area { padding: 16px 20px; background: var(--surface); border-top: 1px solid #E1E5EA; display: flex; gap: 12px; }
    .input-wrap { flex: 1; background: #F1F3F4; border-radius: 24px; padding: 4px 16px; display: flex; align-items: center; }
    input { flex: 1; border: none; background: transparent; padding: 10px; outline: none; font-size: 16px; }
    .btn-send { background: var(--primary); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; }
  </style>
</head>
<body>

<div class="header">
  <div>
    <h2 style="font-size: 1rem; color: var(--text);">Study Session</h2>
    <p style="font-size: 0.7rem; color: #34A853;">• Online & Encrypted</p>
  </div>
  <button onclick="auth.signOut()" style="border:none; background:none; cursor:pointer; color:var(--text-muted);">
    <span class="material-symbols-rounded">logout</span>
  </button>
</div>

<div id="chatContainer">
  <div class="skeleton-wrapper" id="loader">
    <div class="skeleton sm"></div>
    <div class="skeleton lg"></div>
    <div class="skeleton sm"></div>
  </div>
</div>

<div class="input-area">
  <div class="input-wrap">
    <input type="text" id="userInput" placeholder="Type a secure message..." autocomplete="off">
  </div>
  <button id="sendBtn" class="btn-send"><span class="material-symbols-rounded">send</span></button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
    projectId: "fire-b-a8878",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();
  const ENCRYPTION_KEY = "vynix-secret-key-123";

  const chatContainer = document.getElementById('chatContainer');
  const loader = document.getElementById('loader');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;
  let isInitialLoad = true;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      initChat();
    } else {
      auth.signInAnonymously();
    }
  });

  function initChat() {
    // Reference the messages
    const chatRef = database.ref('chats/main');

    chatRef.on('value', snapshot => {
      // Hide loader once we get the first data (or even if it's empty)
      loader.style.display = 'none';
      chatContainer.innerHTML = '';
      
      snapshot.forEach(child => {
        renderMessage(child.key, child.val());
      });

      scrollToBottom();
      isInitialLoad = false;
    });
  }

  function renderMessage(id, data) {
    const isMe = data.uid === currentUser.uid;
    const decryptedText = decrypt(data.text);
    
    // Format timestamp
    const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

    const group = document.createElement('div');
    group.className = `msg-group ${isMe ? 'me' : 'them'}`;
    
    group.innerHTML = `
      <div class="msg-info">${isMe ? 'You' : data.name}</div>
      <div class="msg-bubble">
        <div class="msg-text">${decryptedText}</div>
        <div class="msg-time">${time}</div>
      </div>
      ${isMe ? `<button class="delete-btn" onclick="deleteMsg('${id}')"><span class="material-symbols-rounded" style="font-size:18px;">delete</span></button>` : ''}
    `;
    chatContainer.appendChild(group);
  }

  function scrollToBottom() {
    // If it's the first time loading, jump instantly. If new message, smooth scroll.
    const behavior = isInitialLoad ? 'auto' : 'smooth';
    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior });
  }

  sendBtn.onclick = () => {
    const text = userInput.value.trim();
    if (!text) return;

    database.ref('chats/main').push({
      uid: currentUser.uid,
      name: currentUser.displayName || 'Learner',
      text: encrypt(text),
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    userInput.value = '';
    userInput.focus();
  };

  function encrypt(text) { return CryptoJS.AES.encrypt(text, ENCRYPTION_KEY).toString(); }
  function decrypt(cipher) {
    try {
      const bytes = CryptoJS.AES.decrypt(cipher, ENCRYPTION_KEY);
      return bytes.toString(CryptoJS.enc.Utf8) || cipher;
    } catch { return "..." }
  }

  function deleteMsg(id) { if(confirm("Delete message?")) database.ref(`chats/main/${id}`).remove(); }
  userInput.onkeypress = e => { if(e.key === 'Enter') sendBtn.click(); };
</script>

</body>
</html>
