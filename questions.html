<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix WhatsApp â€¢ Study Group</title>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --wa-bg: #e5ddd5; /* Classic WhatsApp Background */
      --wa-header: #075e54;
      --wa-header-light: #128c7e;
      --wa-bubble-me: #dcf8c6;
      --wa-bubble-them: #ffffff;
      --wa-text: #111b21;
      --wa-muted: #667781;
      --wa-check: #53bdeb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Outfit', sans-serif; }
    
    body { 
      background-color: var(--wa-bg);
      /* WhatsApp Wallpaper Pattern (Simulated) */
      background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
    }

    /* WhatsApp Header */
    .header { 
      padding: 10px 16px; background: var(--wa-header); color: white;
      display: flex; align-items: center; gap: 12px; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .group-avatar { width: 40px; height: 40px; border-radius: 50%; background: #eee; }
    .header-info { flex: 1; }
    .header-info h2 { font-size: 1rem; font-weight: 500; }
    .header-info p { font-size: 0.75rem; opacity: 0.9; }

    /* Chat Area */
    #chatContainer { 
      flex: 1; overflow-y: auto; padding: 12px 6% 20px; 
      display: flex; flex-direction: column; gap: 4px;
      scroll-behavior: smooth;
    }

    /* Bubbles */
    .msg-row { display: flex; width: 100%; margin-bottom: 2px; }
    .msg-row.me { justify-content: flex-end; }
    .msg-row.them { justify-content: flex-start; }

    .msg-content { 
      display: flex; gap: 8px; max-width: 85%; align-items: flex-end;
    }

    .msg-avatar { width: 28px; height: 28px; border-radius: 50%; margin-bottom: 4px; flex-shrink: 0; }

    .bubble { 
      padding: 6px 10px 4px; border-radius: 8px; position: relative; 
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); font-size: 0.92rem;
      min-width: 60px;
    }

    .me .bubble { 
      background: var(--wa-bubble-me); color: var(--wa-text); 
      border-top-right-radius: 0; 
    }
    .them .bubble { 
      background: var(--wa-bubble-them); color: var(--wa-text); 
      border-top-left-radius: 0; 
    }

    /* Distinct Colors for Names (WhatsApp Style) */
    .sender-name { font-size: 0.75rem; font-weight: 600; margin-bottom: 2px; display: block; }
    .name-color-1 { color: #e542a3; }
    .name-color-2 { color: #20c659; }
    .name-color-3 { color: #007bfc; }

    .msg-text { line-height: 1.4; word-break: break-word; }

    .bubble-meta { 
      display: flex; align-items: center; justify-content: flex-end; 
      gap: 3px; margin-top: 2px; font-size: 0.65rem; color: var(--wa-muted);
    }
    .me .bubble-meta { color: #667781; }

    /* Skeleton Loading */
    #loader { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
    .skeleton { height: 40px; border-radius: 8px; background: rgba(255,255,255,0.5); width: 60%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 50% { opacity: 0.5; } }

    /* Input Area */
    .input-bar { padding: 8px 12px; display: flex; align-items: center; gap: 8px; background: transparent; }
    .input-wrap { 
      flex: 1; background: white; border-radius: 24px; 
      display: flex; align-items: center; padding: 0 16px;
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }
    input { flex: 1; border: none; padding: 12px 0; outline: none; font-size: 1rem; }
    
    .btn-circle { 
      width: 45px; height: 45px; border-radius: 50%; border: none;
      background: var(--wa-header-light); color: white; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .material-symbols-rounded { font-variation-settings: 'FILL' 1; }
  </style>
</head>
<body>

<div class="header">
  <img src="https://ui-avatars.com/api/?name=Study+Group&background=128c7e&color=fff" class="group-avatar" alt="Group">
  <div class="header-info">
    <h2>Study Group ðŸ“š</h2>
    <p>Tap here for group info</p>
  </div>
  <div style="display: flex; gap: 15px;">
    <span class="material-symbols-rounded">videocam</span>
    <span class="material-symbols-rounded">call</span>
    <span class="material-symbols-rounded">more_vert</span>
  </div>
</div>

<div id="chatContainer">
  <div id="loader">
    <div class="skeleton"></div>
    <div class="skeleton" style="align-self: flex-end; width: 40%;"></div>
    <div class="skeleton"></div>
  </div>
</div>

<div class="input-bar">
  <div class="input-wrap">
    <span class="material-symbols-rounded" style="color: #8696a0; margin-right: 10px;">mood</span>
    <input type="text" id="userInput" placeholder="Message" autocomplete="off">
    <span class="material-symbols-rounded" style="color: #8696a0; margin-left: 10px;">attach_file</span>
  </div>
  <button id="sendBtn" class="btn-circle">
    <span class="material-symbols-rounded">send</span>
  </button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
    projectId: "fire-b-a8878",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();
  const ENCRYPTION_KEY = "vynix-whatsapp-key-2024";

  const chatContainer = document.getElementById('chatContainer');
  const loader = document.getElementById('loader');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      initChat();
    } else {
      auth.signInAnonymously();
    }
  });

  function initChat() {
    database.ref('chats/main').on('value', snapshot => {
      loader.style.display = 'none';
      chatContainer.innerHTML = '';
      snapshot.forEach(child => renderMessage(child.key, child.val()));
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });
  }

  function renderMessage(id, data) {
    const isMe = data.uid === currentUser.uid;
    const decryptedText = decrypt(data.text);
    const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : '';

    const row = document.createElement('div');
    row.className = `msg-row ${isMe ? 'me' : 'them'}`;
    
    // Assign a fixed "color class" based on UID length for variety
    const colorIndex = (data.uid.charCodeAt(0) % 3) + 1;

    row.innerHTML = `
      <div class="msg-content">
        ${!isMe ? `<img src="https://ui-avatars.com/api/?name=${data.name}&background=random" class="msg-avatar">` : ''}
        <div class="bubble">
          ${!isMe ? `<span class="sender-name name-color-${colorIndex}">${data.name}</span>` : ''}
          <div class="msg-text">${decryptedText}</div>
          <div class="bubble-meta">
            ${time}
            ${isMe ? `<span class="material-symbols-rounded" style="font-size: 14px; color: var(--wa-check);">done_all</span>` : ''}
          </div>
        </div>
      </div>
    `;
    chatContainer.appendChild(row);
  }

  sendBtn.onclick = () => {
    const text = userInput.value.trim();
    if (!text) return;

    database.ref('chats/main').push({
      uid: currentUser.uid,
      name: currentUser.displayName || 'Friend',
      text: CryptoJS.AES.encrypt(text, ENCRYPTION_KEY).toString(),
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    userInput.value = '';
    userInput.focus();
  };

  function decrypt(cipher) {
    try {
      const bytes = CryptoJS.AES.decrypt(cipher, ENCRYPTION_KEY);
      return bytes.toString(CryptoJS.enc.Utf8) || cipher;
    } catch { return "..." }
  }

  userInput.onkeypress = e => { if(e.key === 'Enter') sendBtn.click(); };
</script>

</body>
</html>
