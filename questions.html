<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Vynix AI • Practice Questions</title>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <!-- MathJax for LaTeX rendering -->
  <script>
    MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-body: #F0F4F9;
      --bg-surface: #FFFFFF;
      --primary-blue: #4285F4;
      --primary-coral: #D96570;
      --primary-gradient: linear-gradient(135deg, #4285F4, #D96570);
      --text-main: #1F1F1F;
      --text-secondary: #5F6368;
      --text-muted: #8E918F;
      --border-color: #E1E5EA;
      --success: #34A853;
      --warning: #FBBC05;
      --error: #EA4335;
      --header-height: 64px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }
    #qaView {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      background: var(--bg-body);
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-container {
      background: white;
      border-radius: 24px;
      padding: 32px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-align: center;
    }
    .modal-overlay.active .modal-container {
      transform: scale(1) translateY(0);
    }
    .modal-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 32px;
    }
    .modal-icon.success { background: rgba(52,168,83,0.1); color: var(--success); }
    .modal-icon.error   { background: rgba(234,67,53,0.1);  color: var(--error); }
    .modal-icon.warning { background: rgba(251,188,5,0.1);  color: var(--warning); }
    .modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 12px; }
    .modal-message { color: var(--text-secondary); font-size: 1rem; line-height: 1.5; margin-bottom: 24px; }
    .modal-actions { display: flex; gap: 12px; justify-content: center; }
    .btn-modal {
      padding: 12px 24px;
      border-radius: 20px;
      border: none;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
      flex: 1;
    }
    .btn-modal-secondary { background: var(--bg-body); color: var(--text-secondary); }
    .btn-modal-secondary:hover { background: #E1E5EA; }
    .btn-modal-primary { background: var(--primary-gradient); color: white; }
    .btn-modal-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(66,133,244,0.3); }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }
    .toast {
      background: white;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 400px;
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
      pointer-events: auto;
      border-left: 4px solid var(--primary-blue);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { border-left-color: var(--success); }
    .toast.error   { border-left-color: var(--error); }
    .toast.warning { border-left-color: var(--warning); }
    .toast-icon { font-size: 24px; }
    .toast-content { flex: 1; }
    .toast-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
    .toast-message { font-size: 0.85rem; color: var(--text-secondary); }

    .qa-top-bar {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .qa-title-group { display: flex; align-items: center; gap: 12px; }
    .back-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .back-btn:hover { background: var(--bg-body); }
    .page-title {
      font-weight: 600;
      font-size: 1.25rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .qa-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 900px;
      margin-top: 20px;
    }
    .header-text { grid-column: 1 / -1; margin-bottom: 16px; text-align: center; }
    .subject-card {
      background: var(--bg-surface);
      border-radius: 24px;
      padding: 28px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .subject-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(66,133,244,0.15);
      border-color: var(--primary-blue);
    }
    .subject-icon-wrapper {
      width: 56px; height: 56px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      background: rgba(66,133,244,0.1);
      color: var(--primary-blue);
    }
    .subject-card.physics .subject-icon-wrapper { background: rgba(217,101,112,0.1); color: var(--primary-coral); }
    .subject-card.life-science .subject-icon-wrapper { background: rgba(52,168,83,0.1); color: var(--success); }
    .subject-name { font-size: 1.5rem; font-weight: 600; }
    .subject-desc { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5; }
    .start-btn {
      margin-top: auto;
      color: var(--primary-blue);
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quiz-interface { display: none; width: 100%; max-width: 800px; flex-direction: column; gap: 24px; }
    .quiz-header {
      background: var(--bg-surface);
      padding: 20px 24px;
      border-radius: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .quiz-meta h2 { font-size: 1.2rem; margin-bottom: 4px; }
    .quiz-meta span { color: var(--text-muted); font-size: 0.9rem; }
    .timer-badge {
      background: #FCE8E6; color: #D93025;
      padding: 8px 16px; border-radius: 20px;
      font-weight: 600; display: flex; align-items: center; gap: 6px;
    }
    .timer-badge.warning { background: #FEF3E8; color: #B06000; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .progress-container {
      width: 100%; height: 6px; background: var(--border-color);
      border-radius: 3px; overflow: hidden;
    }
    .progress-bar {
      height: 100%; background: var(--primary-gradient); width: 0%; transition: width 0.5s ease;
    }
    .question-card {
      background: var(--bg-surface);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    }
    .question-number {
      color: var(--primary-blue);
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      margin-bottom: 12px;
    }
    .question-text { font-size: 1.25rem; line-height: 1.6; margin-bottom: 32px; font-weight: 500; }
    .options-list { display: flex; flex-direction: column; gap: 12px; }
    .option {
      padding: 18px 20px;
      border: 2px solid var(--border-color);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .option:hover { border-color: var(--primary-blue); background: rgba(66,133,244,0.03); }
    .option.selected { border-color: var(--primary-blue); background: rgba(66,133,244,0.08); }
    .option-key {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--bg-body);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: var(--text-secondary);
    }
    .option.selected .option-key { background: var(--primary-blue); color: white; }
    .written-input-area textarea {
      width: 100%; min-height: 140px; padding: 16px;
      border: 2px solid var(--border-color); border-radius: 16px;
      font-family: inherit; font-size: 1rem; resize: vertical; outline: none;
    }
    .written-input-area textarea:focus { border-color: var(--primary-blue); }
    .quiz-footer {
      display: flex; justify-content: space-between; gap: 12px; margin-top: 20px;
    }
    .btn {
      padding: 14px 28px; border-radius: 24px; border: none;
      font-family: inherit; font-weight: 600; cursor: pointer;
      transition: all 0.2s; font-size: 1rem; display: flex; align-items: center; gap: 8px;
    }
    .btn-secondary { background: var(--bg-body); color: var(--text-secondary); }
    .btn-secondary:hover { background: #E1E5EA; }
    .btn-primary {
      background: var(--primary-gradient); color: white;
      box-shadow: 0 4px 12px rgba(66,133,244,0.3);
    }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(66,133,244,0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    .results-screen {
      display: none; flex-direction: column; align-items: center; text-align: center; padding: 40px 20px;
    }
    .results-icon {
      width: 120px; height: 120px; background: var(--primary-gradient);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin-bottom: 24px; color: white; font-size: 60px;
      box-shadow: 0 12px 40px rgba(66,133,244,0.3);
    }
    .results-title { font-size: 2rem; font-weight: 700; margin-bottom: 12px; }
    .results-stats {
      display: flex; gap: 32px; margin: 32px 0; flex-wrap: wrap; justify-content: center;
    }
    .stat-item { text-align: center; min-width: 120px; }
    .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--primary-blue); }
    .stat-label { color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px; }

    @media (max-width: 640px) {
      .subject-grid { grid-template-columns: 1fr; }
      .qa-content { padding: 16px; }
      .question-card { padding: 24px; }
      .results-stats { gap: 20px; }
      .stat-value { font-size: 2rem; }
    }
  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-container">
      <div class="modal-icon" id="modalIcon"><span class="material-symbols-rounded">info</span></div>
      <div class="modal-title" id="modalTitle">Title</div>
      <div class="modal-message" id="modalMessage">Message</div>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

  <div id="qaView">
    <div class="qa-top-bar">
      <div class="qa-title-group">
        <button class="back-btn" onclick="confirmExit()" title="Back">
          <span class="material-symbols-rounded">arrow_back</span>
        </button>
        <div class="page-title">Practice Questions</div>
      </div>
    </div>

    <div class="qa-content">

      <!-- Subject Selection -->
      <div id="subjectSelection" class="subject-grid">
        <div class="header-text">
          <h1 style="font-size: 2rem; margin-bottom: 8px;">Choose Your Subject</h1>
          <p style="color: var(--text-secondary); font-size: 1.1rem;">
            Sign in to save your progress and track improvement over time.
          </p>
        </div>

        <div class="subject-card" onclick="startQuiz('mathematics')">
          <div class="subject-icon-wrapper"><span class="material-symbols-rounded">calculate</span></div>
          <div class="subject-name">Mathematics</div>
          <div class="subject-desc">Algebra, Calculus, Geometry, Statistics</div>
          <div class="start-btn">Start Practice <span class="material-symbols-rounded">arrow_forward</span></div>
        </div>

        <div class="subject-card physics" onclick="startQuiz('physics')">
          <div class="subject-icon-wrapper"><span class="material-symbols-rounded">bolt</span></div>
          <div class="subject-name">Physical Sciences</div>
          <div class="subject-desc">Physics & Chemistry</div>
          <div class="start-btn">Start Practice <span class="material-symbols-rounded">arrow_forward</span></div>
        </div>

        <div class="subject-card life-science" onclick="startQuiz('lifescience')">
          <div class="subject-icon-wrapper"><span class="material-symbols-rounded">genetics</span></div>
          <div class="subject-name">Life Sciences</div>
          <div class="subject-desc">Biology, Ecology, Anatomy</div>
          <div class="start-btn">Start Practice <span class="material-symbols-rounded">arrow_forward</span></div>
        </div>
      </div>

      <!-- Quiz Interface -->
      <div id="quizInterface" class="quiz-interface">
        <div class="quiz-header">
          <div class="quiz-meta">
            <h2 id="quizSubjectTitle">Subject</h2>
            <span>Question <span id="currentQ">1</span> of <span id="totalQ">—</span></span>
          </div>
          <div class="timer-badge" id="timerBadge">
            <span class="material-symbols-rounded">timer</span>
            <span id="timer">05:00</span>
          </div>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="question-card">
          <div class="question-number">Question <span id="qNumber">1</span></div>
          <div class="question-text" id="questionText"></div>
          <div class="options-list" id="optionsContainer"></div>
          <div class="written-input-area" id="writtenContainer" style="display:none;">
            <textarea id="writtenAnswer" placeholder="Type your answer or explanation here..."></textarea>
          </div>
        </div>
        <div class="quiz-footer">
          <button class="btn btn-secondary" onclick="confirmExit()">
            <span class="material-symbols-rounded">close</span> Exit
          </button>
          <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>
            Next <span class="material-symbols-rounded">arrow_forward</span>
          </button>
        </div>
      </div>

      <!-- Results Screen -->
      <div id="resultsScreen" class="results-screen">
        <div class="results-icon"><span class="material-symbols-rounded">emoji_events</span></div>
        <h2 class="results-title">Practice Complete!</h2>
        <p style="color: var(--text-secondary); margin-bottom: 32px;">Your result has been saved to your profile.</p>

        <div class="results-stats">
          <div class="stat-item">
            <div class="stat-value" id="resultScore">—</div>
            <div class="stat-label">Accuracy</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="resultTime">—</div>
            <div class="stat-label">Time Taken</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="resultCorrect">—</div>
            <div class="stat-label">Correct Answers</div>
          </div>
        </div>

        <div style="display: flex; gap: 16px; margin-top: 32px;">
          <button class="btn btn-secondary" onclick="returnToSubjects()">
            <span class="material-symbols-rounded">home</span> Home
          </button>
          <button class="btn btn-primary" onclick="restartQuiz()">
            <span class="material-symbols-rounded">replay</span> Try Again
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ────────────────────────────────────────────────
    //  Firebase Initialization
    // ────────────────────────────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ────────────────────────────────────────────────
    //  State Variables
    // ────────────────────────────────────────────────
    let currentSubject = '';
    let currentQuestions = [];
    let currentIndex = 0;
    let timerInterval = null;
    let timeRemaining = 300;
    let score = 0;
    let answers = [];

    // ────────────────────────────────────────────────
    //  Utility Functions
    // ────────────────────────────────────────────────
    function showToast({ type = 'info', title, message, duration = 3000 }) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="toast-icon">
          <span class="material-symbols-rounded">${
            type === 'success' ? 'check_circle' :
            type === 'error'   ? 'error' :
            type === 'warning' ? 'warning' : 'info'
          }</span>
        </div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
      }, duration);
    }

    function showModal({ type = 'info', title, message, buttons = [] }) {
      const overlay = document.getElementById('modalOverlay');
      document.getElementById('modalIcon').className = `modal-icon ${type}`;
      document.getElementById('modalIcon').innerHTML = `<span class="material-symbols-rounded">${
        type === 'success' ? 'check_circle' :
        type === 'error'   ? 'error' :
        type === 'warning' ? 'warning' : 'info'
      }</span>`;
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;

      const actions = document.getElementById('modalActions');
      actions.innerHTML = '';
      buttons.forEach(b => {
        const btn = document.createElement('button');
        btn.className = `btn-modal ${b.primary ? 'btn-modal-primary' : 'btn-modal-secondary'}`;
        btn.textContent = b.text;
        btn.onclick = () => {
          hideModal();
          if (b.onClick) b.onClick();
        };
        actions.appendChild(btn);
      });
      overlay.classList.add('active');
    }

    function hideModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    function getSubjectDisplayName(subject) {
      const map = {
        mathematics: 'Mathematics',
        physics:     'Physical Sciences',
        lifescience: 'Life Sciences'
      };
      return map[subject] || subject.charAt(0).toUpperCase() + subject.slice(1);
    }

    // ────────────────────────────────────────────────
    //  Load Questions from Firebase Realtime Database
    // ────────────────────────────────────────────────
    async function loadQuestions(subject) {
      try {
        const snap = await db.ref(`practice-questions/${subject}`).once('value');
        if (!snap.exists()) return [];

        const questions = [];
        snap.forEach(child => {
          const q = child.val();
          questions.push({
            id: child.key,
            type: q.type || 'mcq',
            question: q.question || '',
            options: q.options || [],
            correct: q.correct !== undefined ? Number(q.correct) : null,
            difficulty: q.difficulty || 'medium'
          });
        });

        // Shuffle for variety
        questions.sort(() => Math.random() - 0.5);
        return questions;
      } catch (err) {
        console.error("Failed to load questions:", err);
        showToast({ type: 'error', title: 'Error', message: 'Could not load questions. Please try again.' });
        return [];
      }
    }

    // ────────────────────────────────────────────────
    //  Start Quiz – requires authentication
    // ────────────────────────────────────────────────
    async function startQuiz(subject) {
      // Require sign-in
      if (!auth.currentUser) {
        showModal({
          type: 'warning',
          title: 'Sign in Required',
          message: 'Please sign in with Google to save your progress and track your improvement over time.',
          buttons: [
            {
              text: 'Sign in with Google',
              primary: true,
              onClick: () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                  .then(() => startQuiz(subject))  // retry after login
                  .catch(err => {
                    showToast({ type: 'error', title: 'Sign-in failed', message: err.message });
                  });
              }
            },
            { text: 'Cancel', onClick: hideModal }
          ]
        });
        return;
      }

      currentSubject = subject;
      currentQuestions = await loadQuestions(subject);

      if (currentQuestions.length === 0) {
        showModal({
          type: 'warning',
          title: 'No Questions Available',
          message: `There are currently no practice questions for ${getSubjectDisplayName(subject)}. Please check back later.`,
          buttons: [{ text: 'Back to Subjects', primary: true, onClick: returnToSubjects }]
        });
        return;
      }

      currentIndex = 0;
      score = 0;
      answers = [];
      timeRemaining = Math.min(300, currentQuestions.length * 60); // adaptive timer

      document.getElementById('quizSubjectTitle').textContent = getSubjectDisplayName(subject);
      document.getElementById('totalQ').textContent = currentQuestions.length;
      document.getElementById('subjectSelection').style.display = 'none';
      document.getElementById('resultsScreen').style.display = 'none';
      document.getElementById('quizInterface').style.display = 'flex';

      startTimer();
      renderQuestion();

      showToast({
        type: 'success',
        title: 'Quiz Started',
        message: `Good luck, ${auth.currentUser.displayName?.split(' ')[0] || 'student'}!`
      });
    }

    // ────────────────────────────────────────────────
    //  Render Current Question
    // ────────────────────────────────────────────────
    function renderQuestion() {
      const q = currentQuestions[currentIndex];

      document.getElementById('currentQ').textContent = currentIndex + 1;
      document.getElementById('qNumber').textContent = currentIndex + 1;
      const progress = ((currentIndex) / currentQuestions.length) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;

      document.getElementById('questionText').innerHTML = q.question;
      if (window.MathJax) MathJax.typesetPromise();

      const optionsContainer = document.getElementById('optionsContainer');
      const writtenContainer = document.getElementById('writtenContainer');
      const nextBtn = document.getElementById('nextBtn');

      if (q.type === 'mcq') {
        optionsContainer.style.display = 'flex';
        writtenContainer.style.display = 'none';
        nextBtn.disabled = true;

        optionsContainer.innerHTML = q.options.map((opt, idx) => `
          <div class="option" onclick="selectOption(this, ${idx})">
            <div class="option-key">${String.fromCharCode(65 + idx)}</div>
            <div>${opt}</div>
          </div>
        `).join('');

        if (window.MathJax) MathJax.typesetPromise();
      } else {
        optionsContainer.style.display = 'none';
        writtenContainer.style.display = 'block';
        document.getElementById('writtenAnswer').value = '';
        nextBtn.disabled = false;
      }

      nextBtn.innerHTML = currentIndex === currentQuestions.length - 1
        ? `Finish <span class="material-symbols-rounded">check</span>`
        : `Next <span class="material-symbols-rounded">arrow_forward</span>`;
    }

    function selectOption(el, idx) {
      document.querySelectorAll('.option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      currentQuestions[currentIndex].userAnswer = idx;
      document.getElementById('nextBtn').disabled = false;
    }

    function nextQuestion() {
      const q = currentQuestions[currentIndex];

      if (q.type === 'mcq') {
        if (q.userAnswer === q.correct) score++;
        answers.push(q.userAnswer === q.correct);
      } else {
        answers.push(document.getElementById('writtenAnswer').value.trim());
      }

      if (currentIndex < currentQuestions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        finishQuiz();
      }
    }

    // ────────────────────────────────────────────────
    //  Finish Quiz & Save Result
    // ────────────────────────────────────────────────
    async function finishQuiz() {
      clearInterval(timerInterval);

      const mcqCount = currentQuestions.filter(q => q.type === 'mcq').length;
      const accuracy = mcqCount > 0 ? Math.round((score / mcqCount) * 100) : 0;
      const timeTaken = 300 - timeRemaining;

      document.getElementById('resultScore').textContent = `${accuracy}%`;
      document.getElementById('resultTime').textContent = `${Math.floor(timeTaken/60)}:${(timeTaken%60).toString().padStart(2,'0')}`;
      document.getElementById('resultCorrect').textContent = `${score}/${mcqCount}`;

      document.getElementById('quizInterface').style.display = 'none';
      document.getElementById('resultsScreen').style.display = 'flex';

      // Save result to Firebase
      if (auth.currentUser) {
        const result = {
          subject: currentSubject,
          score,
          totalQuestions: currentQuestions.length,
          mcqCount,
          accuracy,
          timeTakenSeconds: timeTaken,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          displayName: auth.currentUser.displayName || 'Anonymous',
          email: auth.currentUser.email || null,
          answers: currentQuestions.map((q, i) => ({
            id: q.id || `q${i+1}`,
            type: q.type,
            userAnswer: q.type === 'mcq' ? q.userAnswer : answers[i],
            correct: q.type === 'mcq' ? (q.userAnswer === q.correct) : null
          }))
        };

        try {
          await db.ref(`users/${auth.currentUser.uid}/quiz-results`).push(result);
          showToast({
            type: 'success',
            title: 'Result Saved',
            message: `Your ${accuracy}% score has been recorded.`
          });
        } catch (err) {
          console.error("Failed to save result:", err);
          showToast({
            type: 'error',
            title: 'Save Failed',
            message: 'Could not save your result. Please try again later.'
          });
        }
      }

      showModal({
        type: 'success',
        title: 'Well Done!',
        message: `You scored ${accuracy}% on ${getSubjectDisplayName(currentSubject)}. Keep practicing!`,
        buttons: [
          { text: 'Review Answers', onClick: () => console.log('Review not implemented yet') },
          { text: 'Continue', primary: true, onClick: hideModal }
        ]
      });
    }

    // ────────────────────────────────────────────────
    //  Timer Logic
    // ────────────────────────────────────────────────
    function startTimer() {
      clearInterval(timerInterval);
      const timerEl = document.getElementById('timer');
      const badge = document.getElementById('timerBadge');

      timerInterval = setInterval(() => {
        timeRemaining--;
        const m = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
        const s = (timeRemaining % 60).toString().padStart(2, '0');
        timerEl.textContent = `${m}:${s}`;

        if (timeRemaining <= 60) badge.classList.add('warning');
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          finishQuiz();
        }
      }, 1000);
    }

    // ────────────────────────────────────────────────
    //  Navigation & Exit
    // ────────────────────────────────────────────────
    function confirmExit() {
      showModal({
        type: 'warning',
        title: 'Exit Quiz?',
        message: 'Your current progress will be lost if you leave now. Are you sure?',
        buttons: [
          { text: 'Stay', onClick: hideModal },
          {
            text: 'Exit',
            primary: true,
            onClick: () => {
              clearInterval(timerInterval);
              document.getElementById('quizInterface').style.display = 'none';
              document.getElementById('resultsScreen').style.display = 'none';
              document.getElementById('subjectSelection').style.display = 'grid';
            }
          }
        ]
      });
    }

    function returnToSubjects() {
      document.getElementById('resultsScreen').style.display = 'none';
      document.getElementById('subjectSelection').style.display = 'grid';
    }

    function restartQuiz() {
      startQuiz(currentSubject);
    }

    // Close modal on overlay click
    document.getElementById('modalOverlay').onclick = e => {
      if (e.target === e.currentTarget) hideModal();
    };
  </script>
</body>
</html>
