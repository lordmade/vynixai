<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover, user-scalable=yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4285F4">
  <meta name="description" content="Vynix AI • Group Study Chat">
  <title>Vynix Group Chat • Secure Study</title>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <script>
    MathJax = {
      loader: { load: ['[tex]/mhchem'] },
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], packages: {'[+]': ['mhchem']} },
      chtml: { linebreaks: { automatic: true } },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' }
    };
  </script>
  <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-body: #F0F4F9;
      --bg-sidebar: #F0F4F9;
      --bg-surface: #FFFFFF;
      --primary-gradient: linear-gradient(135deg, #4285F4, #D96570);
      --text-main: #1F1F1F;
      --text-secondary: #444746;
      --text-muted: #8E918F;
      --icon-hover: #E1E5EA;
      --sidebar-width: 300px;
      --sidebar-collapsed: 72px;
      --header-height: 64px;
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --recording-red: #EA4335;
      --thinking-bg: #E8F0FE;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; -webkit-user-select:none; touch-action:manipulation; }
    .msg-text, .msg-text *, .chat-input { user-select:text !important; -webkit-user-select:text !important; -webkit-touch-callout:default; }

    html, body { height:100%; width:100%; overflow:hidden; background:var(--bg-body); font-family:'Outfit', system-ui, sans-serif; color:var(--text-main); }
    body { display:flex; height:100dvh; }

    .sidebar {
      background:var(--bg-sidebar);
      width:var(--sidebar-collapsed);
      display:flex; flex-direction:column;
      padding:12px;
      z-index:1000;
      transition:width 0.3s cubic-bezier(0.2,0,0,1);
      position:relative;
    }

    @media(min-width:769px) {
      .sidebar:hover { width:var(--sidebar-width); }
      .sidebar:not(:hover) .nav-label, .sidebar:not(:hover) .member-name { opacity:0; }
    }

    @media(max-width:768px) {
      .sidebar { position:fixed; inset:0 auto 0 0; width:85vw; max-width:320px; transform:translateX(-100%); transition:transform 0.28s cubic-bezier(0.32,0.72,0,1); background:white; box-shadow:4px 0 32px rgba(0,0,0,0.18); }
      .sidebar.open { transform:translateX(0); }
      .sidebar .nav-label, .sidebar .member-name { opacity:1; }
    }

    .main { flex:1; display:flex; flex-direction:column; background:var(--bg-surface); border-radius:24px; margin:16px 16px 16px 0; overflow:hidden; box-shadow:0 0 0 1px rgba(0,0,0,0.02); }
    @media(max-width:768px) { .main { margin:0; border-radius:0; height:100dvh; } }

    .top-bar { height:var(--header-height); display:flex; align-items:center; justify-content:space-between; padding:0 16px; background:rgba(255,255,255,0.8); backdrop-filter:blur(12px); z-index:20; position:sticky; top:0; }

    .mobile-menu-trigger { width:40px; height:40px; border-radius:50%; background:transparent; border:none; color:var(--text-secondary); cursor:pointer; display:flex; align-items:center; justify-content:center; }

    .chat-scroll { flex:1; overflow-y:auto; padding:80px 16px 180px; scroll-behavior:smooth; }

    .message-row { display:flex; margin:12px 0; animation:fadeIn 0.4s ease; }
    .message-row.ai, .message-row.user { justify-content:flex-start; }

    .message-content.group { max-width:78%; display:flex; gap:12px; align-items:flex-start; }

    .msg-avatar.group { width:36px; height:36px; border-radius:50%; flex-shrink:0; margin-top:4px; background-size:cover; background-position:center; }

    .msg-bubble.group { background:#F0F4F9; border-radius:20px 20px 20px 4px; padding:10px 16px; font-size:0.97rem; line-height:1.55; word-break:break-word; }
    .msg-bubble.group.ai { background:linear-gradient(135deg, #E8F0FE, #D3E3FD); border-radius:20px 20px 4px 20px; }

    .sender-name { font-weight:600; font-size:0.9rem; color:#4285F4; margin-bottom:3px; display:block; }

    .msg-text { font-size:1rem; line-height:1.6; }

    .input-container { position:fixed; bottom:0; left:0; right:0; padding:16px 16px calc(16px + var(--safe-area-inset-bottom)); background:linear-gradient(to top, var(--bg-surface) 60%, transparent); z-index:30; pointer-events:none; }

    .input-wrapper { pointer-events:auto; background:#F0F4F9; border-radius:28px; padding:8px; display:flex; align-items:center; gap:8px; box-shadow:0 4px 24px rgba(0,0,0,0.10); border:1px solid rgba(0,0,0,0.04); }

    .input-wrapper.recording { background:#FCE8E6; border-color:var(--recording-red); animation:pulse-recording 2s infinite; }
    @keyframes pulse-recording { 0%,100% { box-shadow:0 0 0 0 rgba(234,67,53,0.4); } 50% { box-shadow:0 0 0 10px rgba(234,67,53,0); } }

    .chat-input { flex:1; border:none; background:transparent; font-size:16px; color:var(--text-main); outline:none; padding:12px 8px; font-family:inherit; }

    .input-actions { display:flex; gap:4px; }

    .input-tool-btn, .send-btn {
      width:40px; height:40px; border-radius:50%; border:none; background:transparent; color:var(--text-secondary); cursor:pointer;
      display:flex; align-items:center; justify-content:center; transition:all 0.2s;
    }

    .input-tool-btn:hover, .send-btn:hover { background:#E1E5EA; }
    .send-btn.active { background:var(--text-main); color:white; }

    .typing-indicator {
      position: absolute;
      bottom: 90px;
      left: 24px;
      right: 24px;
      padding: 12px 16px;
      background: rgba(66, 133, 244, 0.08);
      border-radius: 16px;
      color: #4285F4;
      font-size: 0.9rem;
      font-style: italic;
      opacity: 0.9;
      pointer-events: none;
      transition: opacity 0.3s ease;
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }

    .typing-indicator.hidden { opacity: 0; pointer-events: none; }

    @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
  </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div style="padding:16px 0; text-align:center;">
    <div style="width:56px;height:56px;margin:0 auto 12px;background:var(--primary-gradient);border-radius:16px;color:white;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:1.6rem;box-shadow:0 4px 12px rgba(66,133,244,0.3);">G</div>
    <div style="font-weight:600;color:#4285F4;font-size:1.1rem;">Group Study</div>
  </div>

  <div style="padding:0 12px;margin:20px 0 8px;font-size:0.85rem;color:var(--text-muted);">Active Members</div>

  <div id="memberList" style="flex:1;overflow-y:auto;padding:0 4px;"></div>

  <div style="margin-top:auto;padding:12px 0;">
    <button id="logoutBtn" class="nav-item" style="display:none;width:100%;" onclick="handleSignOut()">
      <span class="material-symbols-rounded">logout</span>
      <span class="nav-label">Sign out</span>
    </button>
  </div>
</aside>

<main class="main">
  <div class="top-bar">
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="mobile-menu-trigger" onclick="document.getElementById('sidebar').classList.toggle('open')">
        <span class="material-symbols-rounded">menu</span>
      </button>
      <div>
        <div style="font-weight:600;font-size:1.1rem;">Group Study Room</div>
        <div style="font-size:0.8rem;color:var(--text-muted);"><span class="material-symbols-rounded" style="font-size:12px;vertical-align:middle;color:#34A853;">lock</span> End-to-End Encrypted</div>
      </div>
    </div>

    <div id="userPill" style="width:36px;height:36px;border-radius:50%;background-size:cover;background-position:center;border:2px solid #4285F4;"></div>
  </div>

  <div class="chat-scroll" id="chatContainer"></div>

  <div id="typingIndicator" class="typing-indicator hidden">
    <span id="typingText"></span>
  </div>

  <div class="input-container">
    <div class="input-wrapper" id="inputWrapper">
      <input type="file" id="imageInput" accept="image/*" style="display:none">

      <button class="input-tool-btn" onclick="document.getElementById('imageInput').click()" title="Attach image">
        <span class="material-symbols-rounded">image</span>
      </button>

      <input type="text" class="chat-input" id="userInput" placeholder="Type your message..." autocomplete="off">

      <div class="input-actions">
        <button class="input-tool-btn" id="micBtn" title="Voice message">
          <span class="material-symbols-rounded">mic</span>
        </button>
        <button class="send-btn" id="sendBtn">
          <span class="material-symbols-rounded">send</span>
        </button>
      </div>
    </div>
  </div>
</main>

<script>
  // ────────────────────────────────────────────────
  //                Firebase Config
  // ────────────────────────────────────────────────
  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
    projectId: "fire-b-a8878",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // ────────────────────────────────────────────────
  //              Configuration
  // ────────────────────────────────────────────────
  const GROUP_ID = "main-group";
  // NOTE: For a real production app, never hardcode keys in client-side JS.
  // For a private study group, this provides basic privacy from database snoopers.
  const ENCRYPTION_KEY = "vynix-study-group-secret-123"; 

  // ────────────────────────────────────────────────
  //                  DOM Elements
  // ────────────────────────────────────────────────
  const els = {
    chat: document.getElementById('chatContainer'),
    input: document.getElementById('userInput'),
    sendBtn: document.getElementById('sendBtn'),
    userAvatar: document.getElementById('userPill'),
    memberList: document.getElementById('memberList'),
    logoutBtn: document.getElementById('logoutBtn'),
    typingIndicator: document.getElementById('typingIndicator'),
    typingText: document.getElementById('typingText')
  };

  let currentUser = null;
  let typingTimeout = null;
  let myTypingRef = null;

  // ────────────────────────────────────────────────
  //              Auth & Setup
  // ────────────────────────────────────────────────
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      els.userAvatar.style.backgroundImage = `url(${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'User')})`;
      els.logoutBtn.style.display = 'flex';
      els.input.placeholder = "Type a secure message...";
      els.input.disabled = false;
      els.sendBtn.disabled = false;

      myTypingRef = database.ref(`groups/${GROUP_ID}/typing/${user.uid}`);

      listenToMessages();
      listenToMembers();
      listenToTyping();
      setupTypingListener();
    } else {
      els.userAvatar.style.backgroundImage = "url('https://ui-avatars.com/api/?name=Guest')";
      els.logoutBtn.style.display = 'none';
      els.input.placeholder = "Sign in to participate";
      els.input.disabled = true;
      els.sendBtn.disabled = true;
    }
  });

  // ────────────────────────────────────────────────
  //               Typing Logic
  // ────────────────────────────────────────────────
  function setupTypingListener() {
    let isTyping = false;

    els.input.addEventListener('input', () => {
      if (!currentUser) return;
      if (!isTyping) {
        isTyping = true;
        myTypingRef.set({
          name: currentUser.displayName || currentUser.email.split('@')[0],
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        isTyping = false;
        myTypingRef.remove();
      }, 4000);
    });

    els.input.addEventListener('blur', () => {
      if (isTyping) {
        isTyping = false;
        myTypingRef.remove();
      }
      clearTimeout(typingTimeout);
    });
  }

  function listenToTyping() {
    const typingRef = database.ref(`groups/${GROUP_ID}/typing`);
    typingRef.on('value', snapshot => {
      const typingUsers = [];
      snapshot.forEach(child => {
        const data = child.val();
        if (data && child.key !== currentUser?.uid) {
          typingUsers.push(data.name || 'Someone');
        }
      });
      updateTypingDisplay(typingUsers);
    });
  }

  function updateTypingDisplay(users) {
    if (users.length === 0) {
      els.typingIndicator.classList.add('hidden');
      return;
    }
    let text = '';
    if (users.length === 1) text = `${users[0]} is typing...`;
    else if (users.length === 2) text = `${users[0]} and ${users[1]} are typing...`;
    else text = `${users.length} people are typing...`;
    
    els.typingText.textContent = text;
    els.typingIndicator.classList.remove('hidden');
  }

  // ────────────────────────────────────────────────
  //              Messages & Encryption
  // ────────────────────────────────────────────────
  function listenToMessages() {
    database.ref(`groups/${GROUP_ID}/messages`)
      .orderByChild('timestamp')
      .limitToLast(100)
      .on('child_added', snapshot => {
        const msg = snapshot.val();
        appendMessage(msg);
      });
  }

  function appendMessage(msg) {
    const isAI = msg.role === 'ai';
    
    // ─── DECRYPTION ───
    let displayContent = msg.content;
    
    // Try to decrypt only if it looks encrypted (or simply try/catch all)
    if (msg.content) {
      try {
        const bytes = CryptoJS.AES.decrypt(msg.content, ENCRYPTION_KEY);
        const originalText = bytes.toString(CryptoJS.enc.Utf8);
        if (originalText) {
          displayContent = originalText;
        }
      } catch (e) {
        // console.log("Message was not encrypted or key failed, showing raw content.");
      }
    }

    const row = document.createElement('div');
    row.className = `message-row ${isAI ? 'ai' : 'user'}`;

    const content = document.createElement('div');
    content.className = 'message-content group';

    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar group';
    avatar.style.backgroundImage = `url(${msg.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(msg.senderName || 'User')})`;

    const bubble = document.createElement('div');
    bubble.className = `msg-bubble group ${isAI ? 'ai' : ''}`;

    const name = document.createElement('span');
    name.className = 'sender-name';
    name.textContent = msg.senderName || (isAI ? 'Vynix AI' : 'You');
    bubble.appendChild(name);

    const text = document.createElement('div');
    text.className = 'msg-text';
    text.innerHTML = formatMessage(displayContent);
    bubble.appendChild(text);

    content.append(avatar, bubble);
    row.appendChild(content);
    els.chat.appendChild(row);

    els.chat.scrollTo({ top: els.chat.scrollHeight, behavior: 'smooth' });

    if (isAI) {
      setTimeout(() => {
        MathJax.typesetPromise([text]);
        hljs.highlightAll();
      }, 100);
    }
  }

  function formatMessage(text) {
    if (!text) return '';
    return text
      .replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code>$1</code>')
      .replace(/\n/g, '<br>');
  }

  // ────────────────────────────────────────────────
  //                  Members
  // ────────────────────────────────────────────────
  function listenToMembers() {
    const fakeMembers = [
      { name: currentUser?.displayName || "You", photo: currentUser?.photoURL, isYou: true },
      { name: "Thabo", photo: "https://ui-avatars.com/api/?name=Thabo" },
      { name: "Lerato", photo: "https://ui-avatars.com/api/?name=Lerato&background=34A853" },
      { name: "Vynix AI", photo: "https://ui-avatars.com/api/?name=Vynix+AI&background=4285F4" }
    ];

    els.memberList.innerHTML = '';
    fakeMembers.forEach(m => {
      const item = document.createElement('div');
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.gap = '12px';
      item.style.padding = '10px 12px';
      item.style.borderRadius = '12px';
      if (m.isYou) item.style.background = 'rgba(66,133,244,0.08)';

      item.innerHTML = `
        <div style="width:36px;height:36px;border-radius:50%;background:url('${m.photo}') center/cover;"></div>
        <span style="font-weight:${m.isYou?'600':'500'};color:${m.isYou?'#4285F4':'var(--text-main)'};">${m.name}</span>
      `;
      els.memberList.appendChild(item);
    });
  }

  // ────────────────────────────────────────────────
  //               Send & Actions
  // ────────────────────────────────────────────────
  els.sendBtn.onclick = () => {
    const text = els.input.value.trim();
    if (!text || !currentUser) return;

    if (myTypingRef) myTypingRef.remove();

    // ─── ENCRYPT BEFORE SENDING ───
    const encryptedText = CryptoJS.AES.encrypt(text, ENCRYPTION_KEY).toString();

    const message = {
      role: 'user',
      content: encryptedText,
      senderName: currentUser.displayName || currentUser.email.split('@')[0],
      photoURL: currentUser.photoURL || null,
      timestamp: firebase.database.ServerValue.TIMESTAMP,
      uid: currentUser.uid
    };

    database.ref(`groups/${GROUP_ID}/messages`).push(message);
    els.input.value = '';
  };

  els.input.onkeypress = e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      els.sendBtn.click();
    }
  };

  function handleSignOut() {
    if (myTypingRef) myTypingRef.remove();
    auth.signOut().then(() => window.location.reload());
  }

  window.addEventListener('beforeunload', () => {
    if (myTypingRef) myTypingRef.remove();
  });

  // Initial State
  els.input.disabled = true;
  els.sendBtn.disabled = true;
</script>
</body>
</html>
