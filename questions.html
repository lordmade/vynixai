<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Study Group â€¢ WhatsApp Secure</title>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --wa-bg: #e5ddd5;
      --wa-header: #075e54;
      --wa-header-light: #128c7e;
      --wa-bubble-me: #dcf8c6;
      --wa-bubble-them: #ffffff;
      --wa-text: #111b21;
      --wa-muted: #667781;
      --wa-check: #53bdeb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
    
    body { 
      background-color: var(--wa-bg);
      background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
      visibility: hidden; /* Hide UI until auth check is done */
    }

    .header { 
      padding: 10px 16px; background: var(--wa-header); color: white;
      display: flex; align-items: center; gap: 12px; z-index: 10;
    }
    .group-avatar { width: 40px; height: 40px; border-radius: 50%; background: #eee; }
    .header-info { flex: 1; }
    .header-info h2 { font-size: 1rem; font-weight: 500; }
    .header-info p { font-size: 0.7rem; opacity: 0.8; }

    #chatContainer { 
      flex: 1; overflow-y: auto; padding: 15px 7% 20px; 
      display: flex; flex-direction: column; gap: 6px;
      scroll-behavior: smooth;
    }

    .msg-row { display: flex; width: 100%; }
    .msg-row.me { justify-content: flex-end; }
    .msg-content { display: flex; gap: 8px; max-width: 85%; align-items: flex-end; }
    .msg-avatar { width: 28px; height: 28px; border-radius: 50%; margin-bottom: 4px; }

    .bubble { 
      padding: 6px 10px 4px; border-radius: 8px; position: relative; 
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.1); font-size: 0.9rem;
      min-width: 80px;
    }
    .me .bubble { background: var(--wa-bubble-me); border-top-right-radius: 0; }
    .them .bubble { background: var(--wa-bubble-them); border-top-left-radius: 0; }

    .sender-name { font-size: 0.75rem; font-weight: 600; margin-bottom: 2px; display: block; }
    .msg-text { line-height: 1.4; word-break: break-word; color: var(--wa-text); }

    .bubble-meta { 
      display: flex; align-items: center; justify-content: flex-end; 
      gap: 3px; margin-top: 2px; font-size: 0.6rem; color: var(--wa-muted);
    }

    .input-bar { padding: 10px; display: flex; align-items: center; gap: 8px; }
    .input-wrap { 
      flex: 1; background: white; border-radius: 25px; 
      display: flex; align-items: center; padding: 0 15px;
    }
    input { flex: 1; border: none; padding: 12px 0; outline: none; font-size: 1rem; }
    .btn-send { 
      width: 48px; height: 48px; border-radius: 50%; border: none;
      background: var(--wa-header-light); color: white; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    #loader { position: fixed; inset: 0; background: white; display: flex; justify-content: center; align-items: center; z-index: 999; }
  </style>
</head>
<body>

<div id="loader">
  <div style="text-align: center;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="60" alt="Loading...">
    <p style="margin-top: 15px; color: #667781; font-family: sans-serif;">Connecting to Vynix Secure...</p>
  </div>
</div>

<div class="header">
  <img src="https://ui-avatars.com/api/?name=Study+Group&background=128c7e&color=fff" class="group-avatar">
  <div class="header-info">
    <h2 id="groupName">Study Group ðŸ“š</h2>
    <p id="userCount">Encrypted Session</p>
  </div>
  <button onclick="handleLogout()" style="background:none; border:none; color:white; cursor:pointer;">
    <span class="material-symbols-rounded">logout</span>
  </button>
</div>

<div id="chatContainer"></div>

<div class="input-bar">
  <div class="input-wrap">
    <span class="material-symbols-rounded" style="color:#8696a0;">mood</span>
    <input type="text" id="userInput" placeholder="Message" autocomplete="off">
    <span class="material-symbols-rounded" style="color:#8696a0;">attach_file</span>
  </div>
  <button id="sendBtn" class="btn-send">
    <span class="material-symbols-rounded">send</span>
  </button>
</div>

<script>
  // 1. FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
    projectId: "fire-b-a8878",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();
  const ENCRYPTION_KEY = "vynix-whatsapp-key-2024";

  const els = {
    chat: document.getElementById('chatContainer'),
    input: document.getElementById('userInput'),
    sendBtn: document.getElementById('sendBtn'),
    loader: document.getElementById('loader')
  };

  let currentUser = null;

  // 2. AUTHENTICATION GUARD
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.body.style.visibility = 'visible';
      els.loader.style.display = 'none';
      initChat();
    } else {
      // REDIRECT TO INDEX IF NOT AUTHENTICATED
      console.log("Not authenticated, redirecting...");
      window.location.href = "index.html"; 
    }
  });

  // 3. FETCH DATA FROM FIREBASE
  function initChat() {
    // Listen for new messages in Realtime
    database.ref('chats/main').on('value', snapshot => {
      els.chat.innerHTML = '';
      snapshot.forEach(child => {
        renderMessage(child.key, child.val());
      });
      els.chat.scrollTop = els.chat.scrollHeight;
    });
  }

  // 4. RENDER WHATSAPP UI
  function renderMessage(id, data) {
    const isMe = data.uid === currentUser.uid;
    const decryptedText = decrypt(data.text);
    const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

    const row = document.createElement('div');
    row.className = `msg-row ${isMe ? 'me' : 'them'}`;
    
    // Assign random-ish colors to names based on UID
    const colors = ['#e542a3', '#20c659', '#007bfc', '#f19066'];
    const nameColor = colors[data.uid.charCodeAt(0) % colors.length];

    row.innerHTML = `
      <div class="msg-content">
        ${!isMe ? `<img src="https://ui-avatars.com/api/?name=${data.name}&background=random" class="msg-avatar">` : ''}
        <div class="bubble">
          ${!isMe ? `<span class="sender-name" style="color:${nameColor}">${data.name}</span>` : ''}
          <div class="msg-text">${decryptedText}</div>
          <div class="bubble-meta">
            ${time}
            ${isMe ? `<span class="material-symbols-rounded" style="font-size:14px; color:var(--wa-check);">done_all</span>` : ''}
          </div>
        </div>
      </div>
    `;
    els.chat.appendChild(row);
  }

  // 5. SEND MESSAGE (ENCRYPTED)
  els.sendBtn.onclick = () => {
    const text = els.input.value.trim();
    if (!text || !currentUser) return;

    database.ref('chats/main').push({
      uid: currentUser.uid,
      name: currentUser.displayName || currentUser.email.split('@')[0],
      text: encrypt(text),
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    els.input.value = '';
    els.input.focus();
  };

  // 6. HELPERS
  function encrypt(text) { return CryptoJS.AES.encrypt(text, ENCRYPTION_KEY).toString(); }
  function decrypt(cipher) {
    try {
      const bytes = CryptoJS.AES.decrypt(cipher, ENCRYPTION_KEY);
      return bytes.toString(CryptoJS.enc.Utf8) || "Encrypted Message";
    } catch { return "..." }
  }

  function handleLogout() {
    auth.signOut().then(() => window.location.href = "index.html");
  }

  els.input.onkeypress = e => { if(e.key === 'Enter') els.sendBtn.click(); };
</script>

</body>
</html>
