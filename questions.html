<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Realtime • Secure Chat</title>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary: #4285F4;
      --bg: #F0F4F9;
      --surface: #FFFFFF;
      --text: #1F1F1F;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
    body { background: var(--bg); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

    /* Header */
    .header { 
      padding: 16px 24px; background: var(--surface); 
      border-bottom: 1px solid #E1E5EA; display: flex; 
      justify-content: space-between; align-items: center;
      z-index: 10;
    }
    .status { font-size: 0.8rem; color: #34A853; font-weight: 600; display: flex; align-items: center; gap: 4px; }

    /* Chat Body */
    #chatContainer { 
      flex: 1; overflow-y: auto; padding: 20px; 
      display: flex; flex-direction: column; gap: 12px;
      scroll-behavior: smooth;
    }

    .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; position: relative; animation: slideUp 0.2s ease-out; }
    .msg.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .msg.them { align-self: flex-start; background: var(--surface); color: var(--text); border-bottom-left-radius: 4px; border: 1px solid #E1E5EA; }

    .msg-info { font-size: 0.7rem; margin-bottom: 4px; opacity: 0.8; }
    .msg-text { word-wrap: break-word; line-height: 1.4; }
    
    .delete-btn { 
      position: absolute; top: -8px; right: -8px; background: #EA4335; 
      color: white; border: none; border-radius: 50%; width: 20px; 
      height: 20px; cursor: pointer; display: none; font-size: 12px;
    }
    .msg.me:hover .delete-btn { display: flex; align-items: center; justify-content: center; }

    /* Input Area */
    .input-area { padding: 16px 20px; background: var(--surface); border-top: 1px solid #E1E5EA; display: flex; gap: 12px; }
    .input-wrap { flex: 1; background: var(--bg); border-radius: 24px; padding: 4px 16px; display: flex; align-items: center; }
    input { flex: 1; border: none; background: transparent; padding: 10px; outline: none; font-size: 16px; }
    
    .btn-send { background: var(--primary); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; }

    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="header">
  <div>
    <h2 style="font-size: 1.1rem;">Vynix Study Room</h2>
    <p class="status"><span class="material-symbols-rounded" style="font-size: 14px;">cloud_done</span> Live Sync Active</p>
  </div>
  <button onclick="auth.signOut()" style="border:none; background:none; cursor:pointer; color:#8E918F;">
    <span class="material-symbols-rounded">logout</span>
  </button>
</div>

<div id="chatContainer"></div>

<div class="input-area">
  <div class="input-wrap">
    <input type="text" id="userInput" placeholder="Type a message..." autocomplete="off">
  </div>
  <button id="sendBtn" class="btn-send"><span class="material-symbols-rounded">send</span></button>
</div>

<script>
  // 1. Firebase Setup
  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
    projectId: "fire-b-a8878",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();
  const ENCRYPTION_KEY = "vynix-secret-key-123";

  const chatContainer = document.getElementById('chatContainer');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;

  // 2. Auth State
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      initChat();
    } else {
      // For demo purposes: Simple login if not authenticated
      auth.signInAnonymously();
    }
  });

  // 3. Realtime Listener
  function initChat() {
    database.ref('chats/main').on('value', snapshot => {
      chatContainer.innerHTML = '';
      snapshot.forEach(child => {
        const data = child.val();
        renderMessage(child.key, data);
      });
      scrollToBottom();
    });
  }

  // 4. Render & Decrypt
  function renderMessage(id, data) {
    const isMe = data.uid === currentUser.uid;
    const decryptedText = decrypt(data.text);
    
    const div = document.createElement('div');
    div.className = `msg ${isMe ? 'me' : 'them'}`;
    div.innerHTML = `
      <div class="msg-info">${isMe ? 'You' : data.name}</div>
      <div class="msg-text">${decryptedText}</div>
      ${isMe ? `<button class="delete-btn" onclick="deleteMsg('${id}')">×</button>` : ''}
    `;
    chatContainer.appendChild(div);
  }

  // 5. Scroll Engine
  function scrollToBottom() {
    // Timeout ensures DOM has rendered the new elements before scrolling
    setTimeout(() => {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 50);
  }

  // 6. Send Message
  sendBtn.onclick = () => {
    const text = userInput.value.trim();
    if (!text) return;

    const encrypted = encrypt(text);
    database.ref('chats/main').push({
      uid: currentUser.uid,
      name: currentUser.displayName || 'Guest',
      text: encrypted,
      timestamp: Date.now()
    });

    userInput.value = '';
    userInput.focus();
  };

  // 7. Helpers
  function encrypt(text) { return CryptoJS.AES.encrypt(text, ENCRYPTION_KEY).toString(); }
  function decrypt(cipher) {
    try {
      return CryptoJS.AES.decrypt(cipher, ENCRYPTION_KEY).toString(CryptoJS.enc.Utf8) || cipher;
    } catch { return "Error decrypting..."; }
  }

  function deleteMsg(id) { database.ref(`chats/main/${id}`).remove(); }

  userInput.onkeypress = e => { if(e.key === 'Enter') sendBtn.click(); };
</script>

</body>
</html>
