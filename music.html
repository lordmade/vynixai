<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Vynix â€¢ Immersive Music</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-main: #ffffff;
      --bg-secondary: #f8f7fc;
      --bg-glass: rgba(248, 247, 252, 0.94);
      --accent-primary: #8D32D9;
      --accent-secondary: #A754CF;
      --accent-glow: rgba(141, 50, 217, 0.28);
      --text-main: #1a1a2e;
      --text-muted: #6b7280;
      --border-light: rgba(0,0,0,0.08);
      --radius-l: 24px;
      --radius-m: 20px;
      --radius-s: 14px;
      --sidebar-width: 260px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      font-family: 'Plus Jakarta Sans', sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      touch-action: manipulation;
    }

    .hidden { display: none !important; }
    .scroll-hide::-webkit-scrollbar { display: none; }

    .glass {
      background: var(--bg-glass);
      backdrop-filter: blur(24px);
      border: 1px solid var(--border-light);
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }

    /* Search enhancements */
    .search-box {
      position: relative;
      background: rgba(0,0,0,0.04);
      border-radius: 999px;
      padding: 0.85rem 3.2rem 0.85rem 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.9rem;
      width: 380px;
      border: 1px solid rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .search-box:focus-within {
      background: white;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(141,50,217,0.12);
    }

    .search-box input {
      background: transparent;
      border: none;
      color: var(--text-main);
      width: 100%;
      font-weight: 500;
    }

    .clear-search {
      position: absolute;
      right: 14px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.3rem;
      opacity: 0.7;
      transition: all 0.2s;
    }

    .clear-search:hover {
      opacity: 1;
      color: var(--accent-primary);
    }

    .clear-search.hidden {
      display: none;
    }

    /* Rest of your original styles (kept mostly unchanged) */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      padding: 2.2rem 1.6rem;
      border-right: 1px solid var(--border-light);
      overflow-y: auto;
      transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
    }

    .logo {
      font-size: 1.9rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 2.8rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.95rem 1.2rem;
      margin-bottom: 0.6rem;
      color: var(--text-muted);
      border-radius: var(--radius-s);
      cursor: pointer;
      transition: all 0.25s;
      font-weight: 600;
    }

    .nav-item:hover { color: var(--text-main); background: rgba(141,50,217,0.08); }

    .nav-item.active {
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .category-chip {
      padding: 0.55rem 1.2rem;
      background: rgba(141,50,217,0.08);
      border-radius: 999px;
      font-size: 0.86rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .category-chip:hover, .category-chip.active { background: var(--accent-primary); color: white; }

    .playlist-item {
      padding: 0.8rem 1.1rem;
      border-radius: var(--radius-s);
      cursor: pointer;
      color: var(--text-main);
      transition: all 0.2s;
    }

    .playlist-item:hover { background: rgba(141,50,217,0.1); }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        inset: 0 auto 0 0;
        width: 82vw;
        max-width: 320px;
        transform: translateX(-100%);
        z-index: 300;
      }
      .sidebar.open { transform: translateX(0); }

      .drawer-scrim {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 299;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.35s;
      }
      .drawer-scrim.show { opacity: 1; pointer-events: all; }

      .menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(0,0,0,0.05);
        color: var(--text-main);
        margin-right: 0.9rem;
      }
    }

    @media (min-width: 769px) {
      .menu-toggle, .drawer-scrim { display: none !important; }
    }

    .main-view {
      flex: 1;
      overflow-y: auto;
      padding: 2rem 2.5rem 10rem;
      background: linear-gradient(to bottom, #fff, #f9f7fd);
    }

    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.5rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.4rem;
    }

    .grid-scroller {
      display: flex;
      gap: 1.6rem;
      overflow-x: auto;
      padding-bottom: 1.2rem;
    }

    .track-card {
      min-width: 168px;
      width: 168px;
      background: white;
      border-radius: var(--radius-m);
      padding: 1.1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.3s;
    }

    .track-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 32px rgba(141,50,217,0.18);
    }

    .card-img-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--radius-s);
      overflow: hidden;
      margin-bottom: 0.9rem;
    }

    .card-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s;
    }

    .track-card:hover img { transform: scale(1.08); }

    .play-overlay {
      position: absolute;
      inset: 0;
      background: rgba(141,50,217,0.4);
      opacity: 0;
      transition: opacity 0.25s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .track-card:hover .play-overlay { opacity: 1; }

    .song-row {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      padding: 0.9rem;
      border-radius: var(--radius-s);
      cursor: pointer;
      transition: all 0.25s;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .song-row:hover { background: rgba(141,50,217,0.06); }

    .song-row img {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .row-actions {
      display: flex;
      gap: 1.2rem;
      opacity: 0;
      transition: opacity 0.25s;
    }

    .song-row:hover .row-actions { opacity: 1; }

    .action-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.4rem;
      cursor: pointer;
      transition: color 0.2s;
    }

    .action-btn:hover, .action-btn.liked { color: var(--accent-primary); }

    /* Compact Mobile Player Bar */
    .player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 62px;
      z-index: 100;
      background: var(--bg-glass);
      backdrop-filter: blur(24px);
      border-top: 1px solid var(--border-light);
      padding: 0 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: height 0.28s ease;
    }

    .player-bar.active {
      height: 66px;
      box-shadow: 0 -6px 24px rgba(141,50,217,0.16);
    }

    .track-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 65%;
      cursor: pointer;
    }

    .track-meta img {
      width: 42px;
      height: 42px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .meta-text {
      overflow: hidden;
      line-height: 1.2;
    }

    .meta-text div:first-child {
      font-size: 0.94rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta-text div:last-child {
      font-size: 0.76rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .play-fab-mobile {
      width: 44px;
      height: 44px;
      background: var(--accent-primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px var(--accent-glow);
      font-size: 1.8rem;
    }

    .play-fab-mobile:active { transform: scale(0.94); }

    @media (max-width: 768px) {
      .player-bar {
        border-radius: 18px 18px 0 0;
        margin: 0 8px 8px;
        box-shadow: 0 -8px 32px rgba(0,0,0,0.14);
      }
      .play-fab-mobile { display: flex; }
    }

    /* Lyrics Overlay */
    .lyrics-view {
      position: absolute;
      inset: 0;
      background: var(--bg-main);
      z-index: 50;
      padding: 5rem 2.5rem 10rem;
      overflow-y: auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .lyrics-view.open { transform: translateY(0); }

    .close-lyrics {
      position: absolute;
      top: 2.5rem;
      right: 2.5rem;
      background: rgba(0,0,0,0.08);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      color: var(--text-main);
      cursor: pointer;
      font-size: 1.6rem;
    }

    /* Auth Overlay */
    #authOverlay {
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.4rem;
    }
  </style>
</head>
<body>

<!-- Custom Modal -->
<div class="modal-overlay" id="customModal">
  <div class="modal-content">
    <div class="modal-title" id="modalTitle">Vynix</div>
    <div id="modalBody"></div>
    <div class="modal-error" id="modalError"></div>
    <div class="modal-buttons">
      <button class="btn btn-secondary" id="modalCancel">Cancel</button>
      <button class="btn btn-primary" id="modalConfirm">OK</button>
    </div>
  </div>
</div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="logo">VYNIX</div>
  <div class="nav-item active" onclick="switchView('home')">
    <span class="material-symbols-rounded">home</span> Home
  </div>
  <div class="nav-item" onclick="switchView('discover')">
    <span class="material-symbols-rounded">search</span> Discover
  </div>
  <div class="nav-item" onclick="switchView('library')">
    <span class="material-symbols-rounded">library_music</span> Library
  </div>

  <div class="library-section" style="margin-top:2rem;flex:1;overflow-y:auto;">
    <div class="section-head">GENRES</div>
    <div id="sidebarGenres" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
    <div class="section-head" style="margin-top:2.2rem">MY PLAYLISTS</div>
    <div id="playlistContainer"></div>
    <div class="nav-item" style="margin-top:1.2rem;color:var(--accent-primary)" onclick="createNewPlaylist()">
      <span class="material-symbols-rounded">add</span> New Playlist
    </div>
  </div>

  <!-- Sign Out at bottom -->
  <div class="sidebar-bottom">
    <div class="logout-btn" onclick="auth.signOut()">
      <span class="material-symbols-rounded">logout</span>
      Sign Out
    </div>
  </div>
</aside>

<!-- Drawer Scrim -->
<div class="drawer-scrim" onclick="toggleDrawer()"></div>

<!-- Main Content -->
<main class="main-view scroll-hide" id="mainContent">
  <header class="top-header">
    <div style="display:flex;align-items:center">
      <span class="menu-toggle" onclick="toggleDrawer()">
        <span class="material-symbols-rounded">menu</span>
      </span>
      <div class="search-box">
        <span class="material-symbols-rounded">search</span>
        <input type="text" id="globalSearch" placeholder="Search songs, artists..."/>
        <button class="clear-search hidden" id="clearSearchBtn" onclick="clearSearch()">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
    </div>
  </header>

  <div id="view-home">
    <div class="category-filter-bar" id="mainGenreChips"></div>
    <div class="section-title"><span id="currentSectionTitle">Trending Now</span></div>
    <div class="grid-scroller" id="trendingGrid"></div>
    <div class="section-title" style="margin-top:3rem"><span id="listSectionTitle">Recent Uploads</span></div>
    <div id="songsList"></div>
  </div>

  <div id="view-library" class="hidden">
    <h1 style="margin-bottom:2rem">Your Library</h1>
    <div class="section-title">Liked Songs</div>
    <div id="likedSongsList"></div>
  </div>

  <div id="view-playlist" class="hidden">
    <h1 style="margin-bottom:1rem" id="playlistTitle">Playlist</h1>
    <div id="playlistTracksList"></div>
  </div>
</main>

<!-- Compact Player Bar -->
<footer class="player-bar glass" id="playerBar">
  <div class="track-meta" onclick="toggleLyrics()">
    <img id="pCover" src="https://via.placeholder.com/42"/>
    <div class="meta-text">
      <div id="pTitle">Not Playing</div>
      <div id="pArtist">Select a track</div>
    </div>
  </div>

  <button class="play-fab-mobile" onclick="togglePlay()">
    <span class="material-symbols-rounded" id="mobPlayIcon">play_arrow</span>
  </button>
</footer>

<audio id="audio"></audio>

<script>
// =============================================
// CUSTOM MODAL SYSTEM
// =============================================
const modal = {
  overlay: document.getElementById('customModal'),
  title: document.getElementById('modalTitle'),
  body: document.getElementById('modalBody'),
  error: document.getElementById('modalError'),
  cancelBtn: document.getElementById('modalCancel'),
  confirmBtn: document.getElementById('modalConfirm'),

  show(title, content = '', isPrompt = false, defaultValue = '', callback) {
    this.title.textContent = title;
    this.body.innerHTML = content;
    this.error.textContent = '';
    if (isPrompt) {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'modal-input';
      input.value = defaultValue;
      input.placeholder = 'Enter name...';
      this.body.appendChild(input);
      input.focus();
      this.confirmBtn.onclick = () => {
        const val = input.value.trim();
        if (val) callback(val);
        this.hide();
      };
      input.onkeyup = e => { if (e.key === 'Enter') this.confirmBtn.click(); };
    } else {
      this.confirmBtn.onclick = () => { callback?.(); this.hide(); };
    }
    this.cancelBtn.onclick = () => this.hide();
    this.overlay.classList.add('show');
  },

  hide() {
    this.overlay.classList.remove('show');
    this.body.innerHTML = '';
  },

  alert(msg) {
    this.show('Vynix', `<p style="line-height:1.6">${msg}</p>`);
  }
};

// =============================================
// FIREBASE & GLOBAL STATE
// =============================================
firebase.initializeApp({
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
});

const auth = firebase.auth();
const db = firebase.database();

let allTracks = [];
let allGenres = [];
let playlists = {};
let currentPlaylistId = null;
let currentTrack = null;
let likedTracks = new Set();
let currentGenreFilter = null;

const audio = document.getElementById('audio');

// =============================================
// SEARCH FUNCTIONALITY
// =============================================
function applySearchFilter() {
  const term = document.getElementById('globalSearch').value.toLowerCase().trim();
  const clearBtn = document.getElementById('clearSearchBtn');

  // Toggle clear button visibility
  clearBtn.classList.toggle('hidden', term.length === 0);

  // Filter all song-row elements across views
  document.querySelectorAll('.song-row').forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(term) ? 'flex' : 'none';
  });
}

function clearSearch() {
  document.getElementById('globalSearch').value = '';
  document.getElementById('clearSearchBtn').classList.add('hidden');
  applySearchFilter();
}

// =============================================
// RENDERING FUNCTIONS
// =============================================
function getFilteredTracks() {
  let tracks = allTracks;
  if (currentGenreFilter) {
    tracks = tracks.filter(t =>
      (t.genres && t.genres.includes(currentGenreFilter)) ||
      t.genre === currentGenreFilter
    );
  }
  return tracks;
}

function createTrackCard(track) {
  const div = document.createElement('div');
  div.className = 'track-card';
  div.innerHTML = `
    <div class="card-img-wrap">
      <img src="${track.cover || 'https://via.placeholder.com/168?text=Music'}" alt="${track.title}">
      <div class="play-overlay">
        <div class="card-play-btn"><span class="material-symbols-rounded">play_arrow</span></div>
      </div>
    </div>
    <div style="font-weight:700;font-size:1rem;margin-bottom:0.3rem">${track.title || 'Unknown'}</div>
    <div style="color:var(--text-muted);font-size:0.84rem">${track.artist || 'Unknown'}</div>
  `;
  div.onclick = () => playTrack(track);
  return div;
}

function createSongRow(track) {
  const div = document.createElement('div');
  div.className = 'song-row';
  div.innerHTML = `
    <img src="${track.cover || 'https://via.placeholder.com/48?text=M'}" alt="${track.title}">
    <div style="flex:1">
      <div style="font-weight:600">${track.title || 'Unknown'}</div>
      <div style="color:var(--text-muted);font-size:0.86rem">${track.artist || 'Unknown'}</div>
    </div>
    <div class="row-actions">
      <button class="action-btn ${likedTracks.has(track.id) ? 'liked' : ''}" onclick="event.stopPropagation();toggleLike('${track.id}')">
        <span class="material-symbols-rounded">favorite</span>
      </button>
      <button class="action-btn" onclick="event.stopPropagation();addToPlaylist('${track.id}')">
        <span class="material-symbols-rounded">playlist_add</span>
      </button>
    </div>
  `;
  div.onclick = () => playTrack(track);
  return div;
}

function renderHome() {
  const grid = document.getElementById('trendingGrid');
  const list = document.getElementById('songsList');
  const titleEl = document.getElementById('currentSectionTitle');
  const listTitleEl = document.getElementById('listSectionTitle');

  grid.innerHTML = '';
  list.innerHTML = '';

  const filtered = getFilteredTracks();

  titleEl.textContent = currentGenreFilter || 'Trending Now';
  listTitleEl.textContent = currentGenreFilter ? `${currentGenreFilter} Tracks` : 'Recent Uploads';

  filtered.slice(0, 10).forEach(t => grid.appendChild(createTrackCard(t)));
  filtered.forEach(t => list.appendChild(createSongRow(t)));

  // Apply current search filter after rendering
  applySearchFilter();
}

function renderLibrary() {
  const container = document.getElementById('likedSongsList');
  container.innerHTML = '';

  const liked = allTracks.filter(t => likedTracks.has(t.id));

  if (liked.length === 0) {
    container.innerHTML = '<div style="color:#9ca3af;padding:2rem;text-align:center;">No liked songs yet...</div>';
    return;
  }

  liked.forEach(t => container.appendChild(createSongRow(t)));

  applySearchFilter();
}

function renderPlaylistTracks() {
  const container = document.getElementById('playlistTracksList');
  container.innerHTML = '';

  const tracks = playlists[currentPlaylistId]?.tracks || {};
  const ids = Object.keys(tracks);

  if (ids.length === 0) {
    container.innerHTML = '<div style="color:#9ca3af;padding:2rem;text-align:center;">This playlist is empty</div>';
    return;
  }

  ids.forEach(id => {
    const track = allTracks.find(t => t.id === id);
    if (track) container.appendChild(createSongRow(track));
  });

  applySearchFilter();
}

function renderGenreChips() {
  const containers = [document.getElementById('sidebarGenres'), document.getElementById('mainGenreChips')];
  containers.forEach(cont => {
    if (!cont) return;
    cont.innerHTML = '';
    const allChip = document.createElement('div');
    allChip.className = `category-chip ${!currentGenreFilter ? 'active' : ''}`;
    allChip.textContent = 'All';
    allChip.onclick = () => { currentGenreFilter = null; renderGenreChips(); renderHome(); };
    cont.appendChild(allChip);
    allGenres.forEach(g => {
      const chip = document.createElement('div');
      chip.className = `category-chip ${currentGenreFilter === g ? 'active' : ''}`;
      chip.textContent = g;
      chip.onclick = () => { currentGenreFilter = g; renderGenreChips(); renderHome(); };
      cont.appendChild(chip);
    });
  });
}

function renderPlaylists() {
  const container = document.getElementById('playlistContainer');
  container.innerHTML = '';
  Object.entries(playlists).forEach(([id, pl]) => {
    const item = document.createElement('div');
    item.className = 'playlist-item';
    item.textContent = pl.name || 'Untitled';
    item.onclick = () => {
      currentPlaylistId = id;
      document.getElementById('playlistTitle').textContent = pl.name || 'Playlist';
      switchView('playlist');
      renderPlaylistTracks();
    };
    container.appendChild(item);
  });
}

// =============================================
// PLAYER FUNCTIONS
// =============================================
function playTrack(track) {
  currentTrack = track;
  document.getElementById('pTitle').textContent = track.title || 'Unknown';
  document.getElementById('pArtist').textContent = track.artist || 'Unknown';
  document.getElementById('pCover').src = track.cover || 'https://via.placeholder.com/42';
  document.getElementById('lyricsCover').src = track.cover || 'https://via.placeholder.com/220';
  document.getElementById('lyricsTitle').textContent = track.title || 'Unknown';
  document.getElementById('lyricsArtist').textContent = track.artist || 'Unknown';
  audio.src = track.audio || '';
  audio.play().catch(() => {});

  document.getElementById('playerBar').classList.add('active');
  updatePlayIcons(true);
  updatePlayerLikeBtn(track.id);
}

function togglePlay() {
  if (audio.paused) audio.play(); else audio.pause();
  updatePlayIcons(!audio.paused);
}

function updatePlayIcons(playing) {
  document.getElementById('mobPlayIcon').textContent = playing ? 'pause' : 'play_arrow';
}

function toggleLike(trackId) {
  const uid = auth.currentUser?.uid;
  if (!uid || !trackId) return;
  if (likedTracks.has(trackId)) {
    db.ref(`users/${uid}/likes/${trackId}`).remove();
  } else {
    db.ref(`users/${uid}/likes/${trackId}`).set(true);
  }
}

function updatePlayerLikeBtn(id = null) {
  const btn = document.getElementById('likeBtn');
  if (!btn) return;
  const span = btn.querySelector('span');
  const isLiked = id && likedTracks.has(id);
  span.className = `material-symbols-rounded ${isLiked ? 'liked' : ''}`;
}

// =============================================
// NAVIGATION & UTILITIES
// =============================================
function switchView(view) {
  document.querySelectorAll('#mainContent > div[id^="view-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(`view-${view}`)?.classList.remove('hidden');

  document.querySelectorAll('.nav-item').forEach(el => {
    el.classList.toggle('active', el.textContent.toLowerCase().includes(view));
  });

  applySearchFilter(); // Re-apply search when switching views
}

function toggleDrawer() {
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.drawer-scrim').classList.toggle('show');
}

function toggleLyrics() {
  document.getElementById('lyricsOverlay').classList.toggle('open');
}

// =============================================
// DATA LOADING & AUTH
// =============================================
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('authOverlay')?.classList.add('hidden');
    loadData(user.uid);
  } else {
    document.getElementById('authOverlay')?.classList.remove('hidden');
  }
});

function loadData(uid) {
  db.ref('content/music').on('value', snap => {
    allTracks = [];
    snap.forEach(child => {
      const t = child.val();
      t.id = child.key;
      allTracks.push(t);
    });
    renderHome();
    if (currentPlaylistId) renderPlaylistTracks();
  });

  db.ref(`users/${uid}/likes`).on('value', snap => {
    likedTracks.clear();
    if (snap.val()) Object.keys(snap.val()).forEach(k => likedTracks.add(k));
    renderLibrary();
    updatePlayerLikeBtn(currentTrack?.id);
  });

  db.ref('/content/musicGenres').on('value', snap => {
    allGenres = [];
    snap.forEach(c => {
      const name = c.val()?.name;
      if (name) allGenres.push(name);
    });
    allGenres.sort();
    renderGenreChips();
  });

  db.ref(`users/${uid}/playlists`).on('value', snap => {
    playlists = snap.val() || {};
    renderPlaylists();
  });
}

function createNewPlaylist() {
  modal.show('New Playlist', 'Enter playlist name:', true, '', name => {
    if (!name) return modal.alert('Name required');
    const uid = auth.currentUser.uid;
    db.ref(`users/${uid}/playlists`).push().set({ name, tracks: {} })
      .then(() => modal.alert(`"${name}" created!`));
  });
}

function addToPlaylist(trackId) {
  const options = Object.entries(playlists).map(([id, p]) => ({id, name: p.name || 'Untitled'}));
  if (options.length === 0) return modal.alert('Create a playlist first');
  let html = '<p style="margin-bottom:1rem">Choose playlist:</p><select class="modal-input" id="plSelect">';
  options.forEach(o => html += `<option value="${o.id}">${o.name}</option>`);
  html += '</select>';
  modal.show('Add to Playlist', html, false, '', () => {
    const selected = document.getElementById('plSelect').value;
    if (selected) {
      const uid = auth.currentUser.uid;
      db.ref(`users/${uid}/playlists/${selected}/tracks/${trackId}`).set(true)
        .then(() => modal.alert('Added!'));
    }
  });
}

// =============================================
// EVENT LISTENERS
// =============================================
document.getElementById('globalSearch').addEventListener('input', applySearchFilter);

document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);

// Close drawer on desktop resize
window.addEventListener('resize', () => {
  if (window.innerWidth > 768) {
    document.getElementById('sidebar').classList.remove('open');
    document.querySelector('.drawer-scrim')?.classList.remove('show');
  }
});

// Init
switchView('home');
</script>
</body>
</html>
