<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#ffffff"/>
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1a2e"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="description" content="Vynix - Immersive music experience"/>
  <title>Vynix • Immersive Music</title>

  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png"/>
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png"/>
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png"/>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-main: #ffffff;
      --bg-secondary: #f8f7fc;
      --bg-glass: rgba(248, 247, 252, 0.94);
      --accent-primary: #8D32D9;
      --accent-secondary: #A754CF;
      --accent-glow: rgba(141, 50, 217, 0.28);
      --text-main: #1a1a2e;
      --text-muted: #6b7280;
      --border-light: rgba(0,0,0,0.07);
      --radius-l: 24px;
      --radius-m: 20px;
      --radius-s: 14px;
      --sidebar-width: 260px;
      --header-height: 72px;
      --player-height-compact: 94px;
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --touch-target: 48px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      font-family: 'Plus Jakarta Sans', sans-serif;
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
    }

    .hidden { display: none !important; }
    .scroll-hide::-webkit-scrollbar { display: none; }

    .glass {
      background: var(--bg-glass);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--border-light);
    }

    .default-cover {
      background: linear-gradient(135deg, #6b21a8, #a855f7);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
    }

    /* ── MODAL ─────────────────────────────────────────────── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      z-index: 5000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1);
    }
    .modal-overlay.show { opacity: 1; pointer-events: all; }

    .modal-content {
      background: white;
      border-radius: var(--radius-l);
      width: 90%;
      max-width: 420px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      transform: scale(0.88);
      opacity: 0;
      transition: all 0.42s cubic-bezier(0.34,1.56,0.64,1);
    }
    .modal-overlay.show .modal-content { transform: scale(1); opacity: 1; }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .modal-input {
      width: 100%;
      padding: 1rem 1.3rem;
      border: 1px solid #e5e7eb;
      border-radius: var(--radius-s);
      font-size: 1rem;
      margin-bottom: 1.2rem;
    }
    .modal-input:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(141,50,217,0.15);
    }

    .modal-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end; }
    .btn {
      padding: 0.9rem 1.8rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .btn-primary { background: var(--accent-primary); color: white; }
    .btn-primary:hover { background: var(--accent-secondary); transform: translateY(-2px); }
    .btn-secondary { background: #f3f4f6; color: var(--text-main); }

    /* ── FIXED HEADER ──────────────────────────────────────── */
    .top-header-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      height: var(--header-height);
      background: var(--bg-main);
      border-bottom: 1px solid var(--border-light);
      backdrop-filter: blur(20px);
    }

    .top-header {
      height: 100%;
      padding: 0 1.4rem;
      display: flex;
      align-items: center;
    }

    /* ── SEARCH ────────────────────────────────────────────── */
    .search-container {
      position: relative;
      flex: 1;
      max-width: 420px;
      margin-left: 1rem;
    }

    .search-box {
      background: rgba(0,0,0,0.04);
      border-radius: 999px;
      padding: 0.72rem 3rem 0.72rem 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      border: 1px solid rgba(0,0,0,0.08);
      transition: all 0.3s;
      width: 100%;
    }

    .search-box:focus-within {
      background: white;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(141,50,217,0.14);
    }

    .search-box input {
      background: transparent;
      border: none;
      color: var(--text-main);
      width: 100%;
      font-size: 0.92rem;
      font-weight: 500;
    }

    .clear-search {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.3rem;
      opacity: 0.7;
      cursor: pointer;
    }
    .clear-search:hover { opacity: 1; color: var(--accent-primary); }
    .clear-search.hidden { display: none; }

    /* ── MAIN CONTENT AREA ─────────────────────────────────── */
    .main-content-area {
      flex: 1;
      overflow-y: auto;
      padding: calc(var(--header-height) + 1rem) 0 calc(var(--player-height-compact) + 1rem + var(--safe-area-inset-bottom)) 0;
      -webkit-overflow-scrolling: touch;
    }

    .content-padding {
      padding: 0 1.4rem;
    }

    .section-title {
      font-size: 1.48rem;
      font-weight: 700;
      margin: 1.8rem 0 1.2rem;
    }

    .grid-scroller {
      display: flex;
      gap: 1.3rem;
      overflow-x: auto;
      padding-bottom: 1rem;
      scroll-snap-type: x mandatory;
    }

    .track-card {
      min-width: 158px;
      width: 158px;
      background: white;
      border-radius: var(--radius-m);
      padding: 0.9rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      scroll-snap-align: start;
    }

    .track-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(141,50,217,0.18);
    }

    .card-img-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--radius-s);
      overflow: hidden;
      margin-bottom: 0.8rem;
    }

    .card-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s;
    }

    .track-card:hover img { transform: scale(1.07); }

    .play-overlay {
      position: absolute;
      inset: 0;
      background: rgba(141,50,217,0.38);
      opacity: 0;
      transition: opacity 0.25s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .track-card:hover .play-overlay { opacity: 1; }

    .song-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.85rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      cursor: pointer;
      transition: background 0.2s;
    }

    .song-row:hover { background: rgba(141,50,217,0.05); }

    .song-row img {
      width: 46px;
      height: 46px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .row-actions {
      display: flex;
      gap: 1rem;
      opacity: 0;
      transition: opacity 0.22s;
    }

    .song-row:hover .row-actions { opacity: 1; }

    .action-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.48rem;
      width: var(--touch-target);
      height: var(--touch-target);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
    }

    .action-btn:active { transform: scale(0.9); }
    .action-btn:hover, .action-btn.liked { color: var(--accent-primary); }

    /* ── PLAYER BAR ────────────────────────────────────────── */
    .player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 900;
      background: linear-gradient(to bottom, rgba(248,247,252,0.97), rgba(248,247,252,0.89));
      backdrop-filter: blur(24px);
      border-top: 1px solid var(--border-light);
      box-shadow: 0 -6px 30px rgba(0,0,0,0.16);
      border-radius: 20px 20px 0 0;
      margin: 0 8px 8px;
      padding: 10px 14px;
      transition: all 0.38s cubic-bezier(0.16,1,0.3,1);
    }

    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .player-bar {
        padding-bottom: calc(12px + var(--safe-area-inset-bottom));
        margin-bottom: calc(8px + var(--safe-area-inset-bottom));
      }
    }

    .track-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .track-meta img {
      width: 52px;
      height: 52px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .meta-text {
      flex: 1;
      min-width: 0;
    }

    #pTitle {
      font-weight: 600;
      font-size: 0.98rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #pArtist {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .controls-and-progress {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .main-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 360px;
    }

    .ctrl-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.6rem;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.18s;
    }

    .ctrl-btn:active { transform: scale(0.92); }

    .play-fab-mobile {
      width: 56px;
      height: 56px;
      background: var(--accent-primary);
      color: white;
      border-radius: 50%;
      box-shadow: 0 6px 24px var(--accent-glow);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress-area {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.76rem;
      color: var(--text-muted);
      font-family: monospace;
    }

    .prog-bar {
      flex: 1;
      height: 5px;
      background: rgba(0,0,0,0.11);
      border-radius: 5px;
      cursor: pointer;
      overflow: hidden;
    }

    .prog-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      transition: width 0.12s linear;
    }

    .volume-area { display: none; }

    /* Desktop player improvements */
    @media (min-width: 769px) {
      .player-bar {
        flex-direction: row;
        align-items: center;
        height: 110px;
        margin: 0;
        border-radius: 0;
        padding: 0 2.5rem;
        gap: 2rem;
      }

      .track-meta {
        max-width: 38%;
        margin-bottom: 0;
      }

      .track-meta img { width: 68px; height: 68px; }

      .controls-and-progress {
        flex: 1;
        max-width: 580px;
      }

      .main-controls {
        justify-content: center;
        gap: 2.8rem;
      }

      .play-fab-mobile { display: none; }

      .volume-area {
        display: flex;
        width: 180px;
        justify-content: flex-end;
      }
    }

    /* ── LYRICS ────────────────────────────────────────────── */
    .lyrics-view {
      position: fixed;
      inset: 0;
      background: var(--bg-main);
      z-index: 950;
      padding: 5rem 1.8rem 14rem;
      overflow-y: auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.22,1,0.36,1);
      padding-bottom: calc(140px + var(--safe-area-inset-bottom));
    }

    .lyrics-view.open { transform: translateY(0); }

    .close-lyrics {
      position: absolute;
      top: 1.8rem;
      right: 1.8rem;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(0,0,0,0.08);
      border: none;
      font-size: 1.6rem;
      color: var(--text-main);
      cursor: pointer;
    }

    /* ── SIDEBAR (mobile drawer) ───────────────────────────── */
    .sidebar {
      position: fixed;
      inset: 0 auto 0 0;
      width: 82vw;
      max-width: 320px;
      background: var(--bg-secondary);
      padding: 2rem 1.4rem;
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
      z-index: 1100;
      height: 100dvh;
      overflow-y: auto;
    }

    .sidebar.open { transform: translateX(0); }

    .drawer-scrim {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(4px);
      z-index: 1090;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s;
    }

    .drawer-scrim.show { opacity: 1; pointer-events: all; }

    .menu-toggle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(0,0,0,0.04);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.8rem;
      cursor: pointer;
    }

    .logo {
      font-size: 2.1rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 2.4rem;
    }

    /* ── SIGN OUT PILL ─────────────────────────────────────── */
    .signout-pill {
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
      border-radius: 999px;
      padding: 0.9rem;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      box-shadow: 0 4px 16px rgba(141,50,217,0.25);
      transition: all 0.25s;
    }

    .signout-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 22px rgba(141,50,217,0.35);
    }
  </style>
</head>
<body>

<!-- Custom Modal -->
<div class="modal-overlay" id="customModal">
  <div class="modal-content">
    <div class="modal-title" id="modalTitle">Vynix</div>
    <div id="modalBody"></div>
    <div class="modal-error" id="modalError"></div>
    <div class="modal-buttons">
      <button class="btn btn-secondary" id="modalCancel">Cancel</button>
      <button class="btn btn-primary" id="modalConfirm">OK</button>
    </div>
  </div>
</div>

<!-- Sidebar / Drawer -->
<aside class="sidebar" id="sidebar">
  <div class="logo">VYNIX</div>
  <div class="nav-item active" onclick="switchView('home')"><span class="material-symbols-rounded">home</span>Home</div>
  <div class="nav-item" onclick="switchView('discover')"><span class="material-symbols-rounded">search</span>Discover</div>
  <div class="nav-item" onclick="switchView('library')"><span class="material-symbols-rounded">library_music</span>Library</div>

  <div style="margin: 2rem 0 1rem; font-weight:600; color:var(--text-muted);">GENRES</div>
  <div id="sidebarGenres" style="display:flex; flex-wrap:wrap; gap:10px;"></div>

  <div style="margin: 2.2rem 0 1rem; font-weight:600; color:var(--text-muted);">MY PLAYLISTS</div>
  <div id="playlistContainer"></div>

  <div class="nav-item" style="color:var(--accent-primary); margin-top:1.2rem;" onclick="createNewPlaylist()">
    <span class="material-symbols-rounded">add</span>New Playlist
  </div>

  <div style="margin-top:auto; padding-top:2rem;">
    <button class="signout-pill" onclick="auth.signOut()">
      <span class="material-symbols-rounded">logout</span> Sign Out
    </button>
  </div>
</aside>

<div class="drawer-scrim" onclick="toggleDrawer()"></div>

<!-- Fixed Header -->
<div class="top-header-container glass">
  <header class="top-header">
    <span class="menu-toggle" onclick="toggleDrawer()">
      <span class="material-symbols-rounded">menu</span>
    </span>
    <div class="search-container">
      <div class="search-box">
        <span class="material-symbols-rounded">search</span>
        <input type="text" id="globalSearch" placeholder="Artists, songs, albums..."/>
      </div>
      <button class="clear-search hidden" id="clearSearchBtn" onclick="clearSearch()">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
  </header>
</div>

<!-- Main scrollable content -->
<div class="main-content-area scroll-hide" id="mainContent">
  <div class="content-padding">

    <!-- Home -->
    <div id="view-home">
      <div id="mainGenreChips" style="display:flex; flex-wrap:wrap; gap:0.8rem; margin-bottom:1.8rem;"></div>
      <div class="section-title"><span id="currentSectionTitle">Trending Now</span></div>
      <div class="grid-scroller" id="trendingGrid"></div>

      <div class="section-title" style="margin-top:2.8rem">
        <span id="listSectionTitle">Recent Uploads</span>
      </div>
      <div id="songsList"></div>
    </div>

    <!-- Library -->
    <div id="view-library" class="hidden">
      <h1 style="font-size:1.9rem; margin:1.8rem 0 1.6rem;">Your Library</h1>
      <div class="section-title">Liked Songs</div>
      <div id="likedSongsList"></div>
    </div>

    <!-- Playlist -->
    <div id="view-playlist" class="hidden">
      <h1 id="playlistTitle" style="font-size:1.9rem; margin:1.8rem 0 1.6rem;">Playlist</h1>
      <div id="playlistTracksList"></div>
    </div>

  </div>
</div>

<!-- Lyrics Overlay -->
<div class="lyrics-view" id="lyricsOverlay">
  <button class="close-lyrics" onclick="toggleLyrics()">
    <span class="material-symbols-rounded">keyboard_arrow_down</span>
  </button>
  <div class="card-img-wrap" style="width:220px;height:220px;margin:2.5rem 0;">
    <img id="lyricsCover" src="" alt="cover" onerror="this.style.display='none';this.nextSibling.style.display='flex'">
    <div class="default-cover" style="display:none;">♪</div>
  </div>
  <h2 id="lyricsTitle">Song Title</h2>
  <p id="lyricsArtist" style="color:var(--accent-primary);font-weight:500;margin:0.8rem 0 3rem;">Artist</p>
  <div id="lyricsLines" style="font-size:1.12rem; line-height:1.85; max-width:680px;">No lyrics available</div>
</div>

<!-- Player Bar -->
<footer class="player-bar glass" id="playerBar">
  <div class="track-meta" onclick="toggleLyrics()">
    <div class="card-img-wrap" style="width:52px;height:52px;">
      <img id="pCover" src="" alt="cover" onerror="this.style.display='none';this.nextSibling.style.display='flex'">
      <div class="default-cover" style="display:none;font-size:1.7rem;">♪</div>
    </div>
    <div class="meta-text">
      <div id="pTitle">Not Playing</div>
      <div id="pArtist">Select a track</div>
    </div>
  </div>

  <div class="controls-and-progress">
    <div class="main-controls">
      <button class="ctrl-btn" onclick="toggleShuffle()">
        <span class="material-symbols-rounded">shuffle</span>
      </button>
      <button class="ctrl-btn" onclick="playPrevTrack()">
        <span class="material-symbols-rounded">skip_previous</span>
      </button>
      <button class="play-fab-mobile" onclick="togglePlay()">
        <span class="material-symbols-rounded" id="mobPlayIcon">play_arrow</span>
      </button>
      <button class="ctrl-btn" onclick="playNextTrack()">
        <span class="material-symbols-rounded">skip_next</span>
      </button>
      <button class="ctrl-btn" onclick="toggleRepeat()">
        <span class="material-symbols-rounded">repeat</span>
      </button>
    </div>

    <div class="progress-area">
      <span id="currTime">0:00</span>
      <div class="prog-bar" id="progBar">
        <div class="prog-fill" id="progFill"></div>
      </div>
      <span id="durTime">--:--</span>
    </div>
  </div>
</footer>

<audio id="audio"></audio>

<script>
// ──────────────────────────────────────────────
//  INITIALIZATION & FIREBASE
// ──────────────────────────────────────────────
firebase.initializeApp({
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
});

const auth = firebase.auth();
const db = firebase.database();

let allTracks = [];
let allGenres = [];
let playlists = {};
let currentPlaylistId = null;
let currentTrack = null;
let likedTracks = new Set();
let currentGenreFilter = null;
let isShuffled = false;
let isRepeating = false;
let currentTrackIndex = 0;
let shuffledIndices = [];

const audio = document.getElementById('audio');
const DEFAULT_COVER = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%236b21a8"/><text x="50%" y="50%" font-size="80" text-anchor="middle" dy=".3em" fill="white" font-family="sans-serif">♪</text></svg>';

// ──────────────────────────────────────────────
//  PLAYER FUNCTIONS
// ──────────────────────────────────────────────
function updatePlayerVisibility() {
  document.getElementById('playerBar').classList.toggle('hidden', !currentTrack);
}

function formatTime(sec) {
  if (!sec) return '--:--';
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${s < 10 ? '0' : ''}${s}`;
}

audio.ontimeupdate = () => {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  document.getElementById('progFill').style.width = pct + '%';
  document.getElementById('currTime').textContent = formatTime(audio.currentTime);
  document.getElementById('durTime').textContent = formatTime(audio.duration);
};

audio.onloadedmetadata = () => {
  document.getElementById('durTime').textContent = formatTime(audio.duration);
};

document.getElementById('progBar').onclick = e => {
  const rect = e.currentTarget.getBoundingClientRect();
  const pos = (e.clientX - rect.left) / rect.width;
  audio.currentTime = pos * audio.duration;
};

function playTrack(track) {
  currentTrack = track;
  const tracks = getFilteredTracks();
  currentTrackIndex = tracks.findIndex(t => t.id === track.id);

  document.getElementById('pTitle').textContent = track.title || 'Unknown';
  document.getElementById('pArtist').textContent = track.artist || 'Unknown';

  const imgs = [document.getElementById('pCover'), document.getElementById('lyricsCover')];
  imgs.forEach(img => {
    img.src = track.cover || DEFAULT_COVER;
    img.onerror = () => img.src = DEFAULT_COVER;
  });

  document.getElementById('lyricsTitle').textContent = track.title || 'Unknown';
  document.getElementById('lyricsArtist').textContent = track.artist || 'Unknown';

  audio.src = track.audio || '';
  audio.play().catch(() => {});
  updatePlayIcons(true);
  updatePlayerVisibility();
}

function togglePlay() {
  if (!currentTrack) {
    const tracks = getFilteredTracks();
    if (tracks.length) playTrack(tracks[0]);
    return;
  }
  audio[audio.paused ? 'play' : 'pause']().catch(() => {});
  updatePlayIcons(!audio.paused);
}

function updatePlayIcons(playing) {
  const icon = playing ? 'pause' : 'play_arrow';
  document.getElementById('mobPlayIcon').textContent = icon;
}

function playNextTrack() {
  const idx = getNextTrackIndex();
  if (idx !== -1) playTrack(getFilteredTracks()[idx]);
}

function playPrevTrack() {
  const idx = getPrevTrackIndex();
  if (idx !== -1) playTrack(getFilteredTracks()[idx]);
}

function getNextTrackIndex() {
  const tracks = getFilteredTracks();
  if (!tracks.length) return -1;
  if (isShuffled) {
    if (!shuffledIndices.length) shuffledIndices = shuffleArray(tracks.length);
    let i = shuffledIndices.indexOf(currentTrackIndex);
    return shuffledIndices[(i + 1) % shuffledIndices.length];
  }
  return (currentTrackIndex + 1) % tracks.length;
}

function getPrevTrackIndex() {
  const tracks = getFilteredTracks();
  if (!tracks.length) return -1;
  if (isShuffled) {
    if (!shuffledIndices.length) shuffledIndices = shuffleArray(tracks.length);
    let i = shuffledIndices.indexOf(currentTrackIndex);
    return shuffledIndices[(i - 1 + shuffledIndices.length) % shuffledIndices.length];
  }
  return (currentTrackIndex - 1 + tracks.length) % tracks.length;
}

function shuffleArray(length) {
  const arr = Array.from({length}, (_,i)=>i);
  for (let i = arr.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function toggleShuffle() {
  isShuffled = !isShuffled;
  const btn = document.querySelector('.main-controls .ctrl-btn:first-child span');
  btn.style.fontVariationSettings = isShuffled ? "'FILL' 1" : "'FILL' 0";
  btn.style.color = isShuffled ? 'var(--accent-primary)' : '';
  if (isShuffled) shuffledIndices = shuffleArray(getFilteredTracks().length);
}

function toggleRepeat() {
  isRepeating = !isRepeating;
  const btn = document.querySelector('.main-controls .ctrl-btn:last-child span');
  btn.style.fontVariationSettings = isRepeating ? "'FILL' 1" : "'FILL' 0";
  btn.style.color = isRepeating ? 'var(--accent-primary)' : '';
}

audio.onended = () => {
  if (isRepeating) {
    audio.currentTime = 0;
    audio.play().catch(()=>{});
  } else {
    playNextTrack();
  }
};

// ──────────────────────────────────────────────
//  RENDER & UI FUNCTIONS (unchanged core logic)
// ──────────────────────────────────────────────
function getFilteredTracks() {
  if (!currentGenreFilter) return allTracks;
  return allTracks.filter(t => 
    (t.genres?.includes(currentGenreFilter)) || t.genre === currentGenreFilter
  );
}

function createTrackCard(track) {
  const div = document.createElement('div');
  div.className = 'track-card';
  div.innerHTML = `
    <div class="card-img-wrap">
      <img src="${track.cover || DEFAULT_COVER}" alt="${track.title||'Unknown'}" 
           onerror="this.src='${DEFAULT_COVER}'">
      <div class="play-overlay"><span class="material-symbols-rounded">play_arrow</span></div>
    </div>
    <div style="font-weight:700">${track.title||'Unknown'}</div>
    <div style="color:var(--text-muted);font-size:0.84rem">${track.artist||'Unknown'}</div>
  `;
  div.onclick = () => playTrack(track);
  return div;
}

function createSongRow(track) {
  const div = document.createElement('div');
  div.className = 'song-row';
  div.innerHTML = `
    <div class="card-img-wrap" style="width:46px;height:46px;">
      <img src="${track.cover || DEFAULT_COVER}" alt="${track.title||'Unknown'}" 
           onerror="this.src='${DEFAULT_COVER}'">
    </div>
    <div style="flex:1;min-width:0">
      <div style="font-weight:600">${track.title||'Unknown'}</div>
      <div style="color:var(--text-muted);font-size:0.86rem">${track.artist||'Unknown'}</div>
    </div>
    <div class="row-actions">
      <button class="action-btn ${likedTracks.has(track.id)?'liked':''}" 
              onclick="event.stopPropagation();toggleLike('${track.id}')">
        <span class="material-symbols-rounded">favorite</span>
      </button>
      <button class="action-btn" onclick="event.stopPropagation();addToPlaylist('${track.id}')">
        <span class="material-symbols-rounded">playlist_add</span>
      </button>
    </div>
  `;
  div.onclick = () => playTrack(track);
  return div;
}

function renderHome() {
  const grid = document.getElementById('trendingGrid');
  const list = document.getElementById('songsList');
  grid.innerHTML = list.innerHTML = '';

  const tracks = getFilteredTracks();
  document.getElementById('currentSectionTitle').textContent = currentGenreFilter || 'Trending Now';
  document.getElementById('listSectionTitle').textContent = currentGenreFilter ? `${currentGenreFilter} Tracks` : 'Recent Uploads';

  tracks.slice(0,10).forEach(t => grid.appendChild(createTrackCard(t)));
  tracks.forEach(t => list.appendChild(createSongRow(t)));

  applySearchFilter();
}

function renderLibrary() {
  const container = document.getElementById('likedSongsList');
  container.innerHTML = '';
  const liked = allTracks.filter(t => likedTracks.has(t.id));

  if (!liked.length) {
    container.innerHTML = '<div style="padding:3rem;text-align:center;color:#9ca3af;">No liked songs yet...</div>';
    return;
  }

  liked.forEach(t => container.appendChild(createSongRow(t)));
  applySearchFilter();
}

function renderPlaylistTracks() {
  const container = document.getElementById('playlistTracksList');
  container.innerHTML = '';
  const trackIds = Object.keys(playlists[currentPlaylistId]?.tracks || {});

  if (!trackIds.length) {
    container.innerHTML = '<div style="padding:3rem;text-align:center;color:#9ca3af;">Playlist is empty</div>';
    return;
  }

  trackIds.forEach(id => {
    const track = allTracks.find(t => t.id === id);
    if (track) container.appendChild(createSongRow(track));
  });

  applySearchFilter();
}

// ──────────────────────────────────────────────
//  SEARCH & GENRE FILTER
// ──────────────────────────────────────────────
function applySearchFilter() {
  const term = document.getElementById('globalSearch').value.toLowerCase().trim();
  document.getElementById('clearSearchBtn').classList.toggle('hidden', !term);

  document.querySelectorAll('.song-row').forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
}

function clearSearch() {
  document.getElementById('globalSearch').value = '';
  document.getElementById('clearSearchBtn').classList.add('hidden');
  applySearchFilter();
}

function renderGenreChips() {
  const containers = [
    document.getElementById('sidebarGenres'),
    document.getElementById('mainGenreChips')
  ];

  containers.forEach(cont => {
    if (!cont) return;
    cont.innerHTML = '';

    const all = document.createElement('div');
    all.className = `category-chip ${!currentGenreFilter ? 'active' : ''}`;
    all.textContent = 'All';
    all.onclick = () => { currentGenreFilter = null; renderGenreChips(); renderHome(); };
    cont.appendChild(all);

    allGenres.forEach(g => {
      const chip = document.createElement('div');
      chip.className = `category-chip ${currentGenreFilter === g ? 'active' : ''}`;
      chip.textContent = g;
      chip.onclick = () => { currentGenreFilter = g; renderGenreChips(); renderHome(); };
      cont.appendChild(chip);
    });
  });
}

function renderPlaylists() {
  const cont = document.getElementById('playlistContainer');
  cont.innerHTML = '';
  Object.entries(playlists).forEach(([id, pl]) => {
    const el = document.createElement('div');
    el.className = 'playlist-item';
    el.textContent = pl.name || 'Untitled';
    el.onclick = () => {
      currentPlaylistId = id;
      document.getElementById('playlistTitle').textContent = pl.name || 'Playlist';
      switchView('playlist');
      renderPlaylistTracks();
    };
    cont.appendChild(el);
  });
}

// ──────────────────────────────────────────────
//  NAVIGATION & UI
// ──────────────────────────────────────────────
function switchView(view) {
  document.querySelectorAll('[id^="view-"]').forEach(el => {
    el.classList.toggle('hidden', !el.id.includes(view));
  });

  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.textContent.toLowerCase().includes(view));
  });

  applySearchFilter();
}

function toggleDrawer() {
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.drawer-scrim').classList.toggle('show');
}

function toggleLyrics() {
  document.getElementById('lyricsOverlay').classList.toggle('open');
}

// ──────────────────────────────────────────────
//  DATA & AUTH
// ──────────────────────────────────────────────
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.replace('login.html');
    return;
  }

  loadData(user.uid);
});

function loadData(uid) {
  db.ref('content/music').on('value', snap => {
    allTracks = [];
    snap.forEach(child => {
      const t = child.val();
      t.id = child.key;
      allTracks.push(t);
    });
    renderHome();
    if (currentPlaylistId) renderPlaylistTracks();
  });

  db.ref(`users/${uid}/likes`).on('value', snap => {
    likedTracks.clear();
    if (snap.val()) Object.keys(snap.val()).forEach(k => likedTracks.add(k));
    renderLibrary();
  });

  db.ref('/content/musicGenres').on('value', snap => {
    allGenres = [];
    snap.forEach(c => {
      const name = c.val()?.name;
      if (name) allGenres.push(name);
    });
    allGenres.sort();
    renderGenreChips();
  });

  db.ref(`users/${uid}/playlists`).on('value', snap => {
    playlists = snap.val() || {};
    renderPlaylists();
  });
}

function createNewPlaylist() {
  modal.show('New Playlist', 'Enter playlist name:', true, '', name => {
    if (!name?.trim()) return modal.alert('Name is required');
    const uid = auth.currentUser.uid;
    db.ref(`users/${uid}/playlists`).push().set({ name, tracks: {} })
      .then(() => modal.alert(`Playlist "${name}" created!`));
  });
}

function addToPlaylist(trackId) {
  const options = Object.entries(playlists).map(([id,p])=>({id, name:p.name||'Untitled'}));
  if (!options.length) return modal.alert('Create a playlist first');

  let html = '<p style="margin-bottom:1rem">Select playlist:</p><select class="modal-input" id="plSelect">';
  options.forEach(o => html += `<option value="${o.id}">${o.name}</option>`);
  html += '</select>';

  modal.show('Add to Playlist', html, false, '', () => {
    const plId = document.getElementById('plSelect')?.value;
    if (plId) {
      db.ref(`users/${auth.currentUser.uid}/playlists/${plId}/tracks/${trackId}`).set(true)
        .then(() => modal.alert('Track added!'));
    }
  });
}

// ──────────────────────────────────────────────
//  EVENT LISTENERS
// ──────────────────────────────────────────────
document.getElementById('globalSearch').oninput = applySearchFilter;

window.addEventListener('resize', () => {
  if (window.innerWidth > 768 && document.getElementById('sidebar').classList.contains('open')) {
    toggleDrawer();
  }
});

// Init
switchView('home');
updatePlayerVisibility();
</script>
</body>
</html>
