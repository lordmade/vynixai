<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Vynix Max • Music</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    /* --- KEEPING YOUR EXISTING STYLES --- */
    :root {
      --bg-main: #f8f9fa; --bg-panel: #ffffff; --bg-hover: #f0f0f0;
      --text-primary: #121212; --text-secondary: #5e5e5e;
      --accent: #e50914; --accent-hover: #b20710;
      --card-bg: #ffffff; --border: #e0e0e0;
      --radius: 12px; --pill-radius: 999px;
      --shadow: 0 4px 12px rgba(0,0,0,0.06);
      --modal-bg: rgba(0,0,0,0.6);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
    body { background: var(--bg-main); color: var(--text-primary); font-family: 'Inter', sans-serif; }
    .hidden { display: none !important; }

    /* UI Layout */
    .top-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: var(--bg-main); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); }
    .auth-container { max-width: 420px; margin: 10vh auto; background: var(--bg-panel); padding: 2.5rem; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border); }
    .auth-form { display: flex; flex-direction: column; gap: 1.2rem; }
    input { padding: 1rem; background: var(--bg-hover); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); }
    .auth-btn { padding: 1rem; background: var(--accent); color: white; border: none; border-radius: var(--pill-radius); font-weight: 600; cursor: pointer; }
    
    .app { height: 100vh; display: flex; flex-direction: column; }
    .main-wrapper { flex: 1; display: flex; position: relative; overflow: hidden; margin-top: 70px; }
    .sidebar { width: 260px; background: var(--bg-panel); padding: 1.5rem; border-right: 1px solid var(--border); overflow-y: auto; transition: transform 0.3s ease; z-index: 1000; position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .logo { font-size: 1.8rem; font-weight: 900; color: var(--accent); margin-bottom: 2rem; }
    .nav-pill { display: flex; align-items: center; gap: 1rem; padding: 0.9rem 1.2rem; border-radius: var(--pill-radius); color: var(--text-secondary); cursor: pointer; font-weight: 600; margin-bottom: 0.5rem; }
    .nav-pill:hover, .nav-pill.active { background: var(--bg-hover); color: var(--text-primary); }
    
    .main-content { flex: 1; overflow-y: auto; padding: 1.5rem 1.5rem 9rem; }
    .section-title { font-size: 1.75rem; font-weight: 800; margin: 1.5rem 0 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1.5rem; }
    
    /* CARD STYLING & LONG PRESS ANIMATION */
    .card { background: var(--card-bg); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); transition: 0.2s ease; cursor: pointer; position: relative; box-shadow: var(--shadow); }
    .card:active { transform: scale(0.96); } /* Press effect */
    .card img { width: 100%; aspect-ratio: 1; object-fit: cover; pointer-events: none; }
    .card-info { padding: 1rem; text-align: center; pointer-events: none; }
    
    .player { height: 90px; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; position: fixed; bottom: 0; width: 100%; z-index: 1100; }
    .player-track-info { display: flex; align-items: center; gap: 1rem; flex: 1; max-width: 45%; }
    .player-cover { width: 56px; height: 56px; border-radius: 8px; border: 1px solid var(--border); object-fit: cover; }
    .player-controls { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.6rem; }
    .control-btns { display: flex; gap: 2rem; color: var(--text-secondary); font-size: 2.2rem; align-items: center; }
    .play-trigger { font-size: 3.5rem !important; color: var(--text-primary); cursor: pointer; }
    .progress-bar-wrapper { width: 100%; max-width: 600px; display: flex; align-items: center; gap: 12px; font-size: 0.85rem; font-weight: 600; }
    .progress-bg { flex: 1; height: 6px; background: #ddd; border-radius: 5px; cursor: pointer; position: relative; }
    .progress-fill { width: 0%; height: 100%; background: var(--text-primary); border-radius: 5px; }

    .pill-tabs { display: flex; gap: 0.9rem; overflow-x: auto; padding: 0.5rem 0; scrollbar-width: none; }
    .pill-tab { flex: 0 0 auto; padding: 0.6rem 1.4rem; background: var(--bg-panel); color: var(--text-secondary); border: 1px solid var(--border); border-radius: var(--pill-radius); font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
    .pill-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

    .hamburger { position: fixed; top: 1rem; left: 1rem; z-index: 1100; width: 48px; height: 48px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); cursor: pointer; }
    .overlay { position: fixed; inset: 0; background: var(--modal-bg); backdrop-filter: blur(4px); z-index: 900; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .overlay.active { opacity: 1; pointer-events: all; }

    /* --- NEW: CONTEXT MENU STYLES --- */
    .context-menu {
      position: fixed;
      z-index: 9999;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      width: 220px;
      display: none;
      flex-direction: column;
      animation: fadeIn 0.1s ease;
    }
    .context-menu.active { display: flex; }
    .context-menu-header {
        padding: 8px 12px;
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 700;
        border-bottom: 1px solid #eee;
        margin-bottom: 4px;
    }
    .ctx-item {
      padding: 10px 12px;
      font-size: 0.9rem;
      color: #333;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ctx-item:hover { background: var(--bg-hover); color: var(--accent); }
    .ctx-divider { height: 1px; background: #eee; margin: 4px 0; }
    
    /* MODAL */
    .modal { position: fixed; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
    .modal.active { opacity: 1; pointer-events: all; }
    .modal-content { background: white; width: 90%; max-width: 400px; padding: 2rem; border-radius: 16px; position: relative; text-align: center; }
    .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .hamburger { display: flex; }
      .player { padding: 0.8rem; height: 110px; }
      .main-content { padding-bottom: 140px !important; }
      .top-bar { padding-left: 1.5rem; }
    }
    @media (min-width: 1025px) {
      .hamburger { display: none !important; }
      .sidebar { transform: none !important; left: 0; }
      .main-wrapper { margin-left: 260px; margin-top: 0; }
      .top-bar { padding-left: 280px; }
      .player { position: sticky; bottom: 0; }
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>

<div class="top-bar">
  <input type="text" id="searchInput" placeholder="Search songs or artists..."
         style="width:100%; max-width:480px; padding:1rem 1rem 1rem 3rem; border-radius:99px; border:1px solid var(--border);"/>
</div>

<div id="contextMenu" class="context-menu">
    <div id="ctxTitle" class="context-menu-header">Song Options</div>
    <div class="ctx-item" id="ctxPlay"><span class="material-symbols-rounded">play_arrow</span> Play Now</div>
    <div class="ctx-divider"></div>
    <div class="context-menu-header">Add to Playlist</div>
    <div id="ctxPlaylistsContainer">
        </div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" onclick="hideContextMenu()"><span class="material-symbols-rounded">close</span> Close</div>
</div>

<div id="authScreen" class="auth-container">
  <div class="logo" style="font-size:2.2rem; margin-bottom:2rem;">VYNIX MAX</div>
  <div id="loginForm" class="auth-form">
    <input type="email" id="loginEmail" placeholder="Email" required/>
    <input type="password" id="loginPassword" placeholder="Password" required/>
    <button id="loginBtn" class="auth-btn">Log In</button>
    <div id="loginError" class="error-msg" style="color:red"></div>
    <span onclick="toggleAuth()" style="cursor:pointer; color:var(--accent);">Create Account</span>
  </div>
  <div id="signupForm" class="auth-form hidden">
    <input type="email" id="signupEmail" placeholder="Email" required/>
    <input type="password" id="signupPassword" placeholder="Password" required/>
    <button id="signupBtn" class="auth-btn">Sign Up</button>
    <div id="signupError" class="error-msg" style="color:red"></div>
    <span onclick="toggleAuth()" style="cursor:pointer; color:var(--accent);">Back to Login</span>
  </div>
</div>

<div id="mainApp" class="app hidden">
  <div class="hamburger" id="hamburgerBtn"><span class="material-symbols-rounded">menu</span></div>
  <div class="overlay" id="overlay"></div>

  <div class="main-wrapper">
    <aside class="sidebar" id="sidebar">
      <div class="logo">VYNIX MAX</div>
      <nav>
        <div class="nav-pill active" onclick="resetView()"><span class="material-symbols-rounded">home</span> Home</div>
      </nav>
      <div style="margin-top:2rem;">
        <div style="font-size:0.8rem; font-weight:700; color:#888; margin-bottom:1rem;">YOUR LIBRARY</div>
        <div id="playlistList"></div>
        <div class="nav-pill" id="createPlaylistBtn" style="color:var(--accent);">
          <span class="material-symbols-rounded">add_circle</span> New Playlist
        </div>
      </div>
      <button id="signOutBtn" class="auth-btn" style="margin-top:auto; background:#eee; color:#333;">Sign Out</button>
    </aside>

    <main class="main-content">
      <div style="max-width: 1280px; margin: 0 auto;">
        <div class="pill-tabs" id="categoryTabs"></div>
        <h2 class="section-title" id="currentViewTitle">All Tracks</h2>
        <div class="grid" id="musicGrid"></div>
      </div>
    </main>
  </div>

  <footer class="player" id="player">
    <div class="player-track-info">
      <img id="playerCover" src="" class="player-cover" style="background:#eee"/>
      <div style="overflow:hidden;">
        <div id="playerTitle" style="font-weight:700; font-size:1rem; white-space:nowrap;">Select a song</div>
        <div id="playerArtist" style="color:var(--text-secondary); font-size:0.88rem;">--</div>
      </div>
    </div>
    <div class="player-controls">
      <div class="control-btns">
        <span class="material-symbols-rounded" style="cursor:pointer" id="prevBtn">skip_previous</span>
        <span id="playPauseBtn" class="material-symbols-rounded play-trigger">play_circle</span>
        <span class="material-symbols-rounded" style="cursor:pointer" id="nextBtn">skip_next</span>
      </div>
      <div class="progress-bar-wrapper">
        <span id="curTime">0:00</span>
        <div class="progress-bg" id="progressClick"><div class="progress-fill" id="progressFill"></div></div>
        <span id="durTime">0:00</span>
      </div>
    </div>
  </footer>
</div>

<div id="playlistModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closePlaylistModal()">×</button>
    <h2>New Playlist</h2>
    <input type="text" id="playlistNameInput" placeholder="My Awesome Mix" style="width:100%; margin:1.5rem 0;"/>
    <button id="savePlaylistBtn" class="auth-btn" style="width:100%;">Create</button>
  </div>
</div>

<audio id="audioElement"></audio>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const DEFAULT_COVER = 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=200&h=200&fit=crop';
let currentUser = null;
let allTracks = [];
let userPlaylists = {};
let currentContextTrack = null; // Track selected for long press

// --- AUTH ---
auth.onAuthStateChanged(user => {
  currentUser = user;
  if(user) {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    loadContent();
  } else {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  }
});

function toggleAuth() {
  document.getElementById('loginForm').classList.toggle('hidden');
  document.getElementById('signupForm').classList.toggle('hidden');
}

document.getElementById('loginBtn').onclick = () => {
  auth.signInWithEmailAndPassword(
    document.getElementById('loginEmail').value,
    document.getElementById('loginPassword').value
  ).catch(e => document.getElementById('loginError').textContent = e.message);
};

document.getElementById('signupBtn').onclick = () => {
  auth.createUserWithEmailAndPassword(
    document.getElementById('signupEmail').value,
    document.getElementById('signupPassword').value
  ).catch(e => document.getElementById('signupError').textContent = e.message);
};

document.getElementById('signOutBtn').onclick = () => auth.signOut();

// --- CONTENT LOADING ---
function loadContent() {
  // Load Tracks
  db.ref("/content/music").on("value", snap => {
    allTracks = [];
    snap.forEach(child => {
      let t = child.val(); t.id = child.key;
      allTracks.push(t);
    });
    renderTracks(allTracks);
  });

  // Load Playlists
  db.ref(`users/${currentUser.uid}/playlists`).on("value", snap => {
    userPlaylists = snap.val() || {};
    renderSidebarPlaylists();
  });

  // Load Categories (Simplified)
  db.ref("/content/musicGenres").once("value", snap => {
    const tabs = document.getElementById('categoryTabs');
    tabs.innerHTML = `<div class="pill-tab active" onclick="filterTracks('all', this)">All</div>`;
    if(snap.val()) {
        Object.values(snap.val()).forEach(g => {
            tabs.innerHTML += `<div class="pill-tab" onclick="filterTracks('${g.name}', this)">${g.name}</div>`;
        });
    }
  });
}

// --- RENDER & LOGIC ---
function renderTracks(tracks) {
  const grid = document.getElementById('musicGrid');
  grid.innerHTML = '';
  
  tracks.forEach(track => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${track.cover || DEFAULT_COVER}">
      <div class="card-info">
        <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${track.title}</div>
        <div style="color:var(--text-secondary); font-size:0.8rem;">${track.artist}</div>
      </div>
    `;

    // --- LONG PRESS & RIGHT CLICK LOGIC ---
    let pressTimer;
    let isLongPress = false;

    // Mobile: Touch
    card.addEventListener('touchstart', (e) => {
        isLongPress = false;
        pressTimer = setTimeout(() => {
            isLongPress = true;
            showContextMenu(e.touches[0].clientX, e.touches[0].clientY, track);
        }, 600); // 600ms hold time
    });

    card.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
        if(!isLongPress) {
            playTrack(track); // Regular tap plays song
        }
    });

    // Desktop: Right Click
    card.addEventListener('contextmenu', (e) => {
        e.preventDefault(); // Stop default browser menu
        showContextMenu(e.clientX, e.clientY, track);
    });

    // Desktop: Left Click
    card.addEventListener('click', () => {
        // Only play if not triggered by long press logic (mostly handled by touchend on mobile)
        if (window.matchMedia("(min-width: 1025px)").matches) {
            playTrack(track);
        }
    });

    grid.appendChild(card);
  });
}

function filterTracks(cat, element) {
    document.querySelectorAll('.pill-tab').forEach(e => e.classList.remove('active'));
    element.classList.add('active');
    
    if(cat === 'all') return renderTracks(allTracks);
    
    const filtered = allTracks.filter(t => 
        (t.genres && t.genres.includes(cat)) || (t.moods && t.moods.includes(cat))
    );
    renderTracks(filtered);
}

// --- CONTEXT MENU LOGIC ---
const ctxMenu = document.getElementById('contextMenu');

function showContextMenu(x, y, track) {
    currentContextTrack = track;
    document.getElementById('ctxTitle').textContent = track.title;
    
    // Prevent menu going off screen
    const w = window.innerWidth;
    const h = window.innerHeight;
    
    // Adjust position if too close to edge
    let finalX = x;
    let finalY = y;
    if(x + 220 > w) finalX = w - 230;
    if(y + 300 > h) finalY = h - 310;

    ctxMenu.style.left = `${finalX}px`;
    ctxMenu.style.top = `${finalY}px`;
    
    // Populate Playlist Options
    const plContainer = document.getElementById('ctxPlaylistsContainer');
    plContainer.innerHTML = '';
    
    if(Object.keys(userPlaylists).length === 0) {
        plContainer.innerHTML = `<div class="ctx-item" style="color:#888; font-style:italic;">No playlists found</div>`;
    } else {
        Object.keys(userPlaylists).forEach(key => {
            const pl = userPlaylists[key];
            const item = document.createElement('div');
            item.className = 'ctx-item';
            item.innerHTML = `<span class="material-symbols-rounded">playlist_add</span> ${pl.name}`;
            item.onclick = (e) => {
                e.stopPropagation();
                addToPlaylist(key, track);
            };
            plContainer.appendChild(item);
        });
    }

    // Play button inside menu
    document.getElementById('ctxPlay').onclick = () => {
        playTrack(track);
        hideContextMenu();
    }

    ctxMenu.classList.add('active');
    
    // Vibrator feedback for mobile
    if(navigator.vibrate) navigator.vibrate(50);
}

function hideContextMenu() {
    ctxMenu.classList.remove('active');
    currentContextTrack = null;
}

// Close menu when clicking elsewhere
document.addEventListener('click', (e) => {
    if(!ctxMenu.contains(e.target)) hideContextMenu();
});

// --- PLAYLIST LOGIC ---
function addToPlaylist(pid, track) {
    db.ref(`users/${currentUser.uid}/playlists/${pid}/tracks`).push(track.id)
      .then(() => {
          hideContextMenu();
          alert(`Added "${track.title}" to playlist!`);
      });
}

document.getElementById('createPlaylistBtn').onclick = () => document.getElementById('playlistModal').classList.add('active');
function closePlaylistModal() { document.getElementById('playlistModal').classList.remove('active'); }

document.getElementById('savePlaylistBtn').onclick = () => {
    const name = document.getElementById('playlistNameInput').value;
    if(!name) return;
    db.ref(`users/${currentUser.uid}/playlists`).push({
        name: name,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    });
    closePlaylistModal();
};

function renderSidebarPlaylists() {
    const list = document.getElementById('playlistList');
    list.innerHTML = '';
    Object.keys(userPlaylists).forEach(key => {
        const div = document.createElement('div');
        div.className = 'nav-pill';
        div.innerHTML = `<span class="material-symbols-rounded">queue_music</span> ${userPlaylists[key].name}`;
        div.onclick = () => loadPlaylistView(key);
        list.appendChild(div);
    });
}

function loadPlaylistView(pid) {
    const playlist = userPlaylists[pid];
    document.getElementById('currentViewTitle').textContent = playlist.name;
    
    // Fetch tracks for this playlist
    db.ref(`users/${currentUser.uid}/playlists/${pid}/tracks`).once("value", snap => {
        const trackIds = [];
        snap.forEach(c => trackIds.push(c.val()));
        
        // Filter allTracks to find matches
        const playlistTracks = allTracks.filter(t => trackIds.includes(t.id));
        renderTracks(playlistTracks);
    });
}

// --- PLAYER ---
const audio = document.getElementById('audioElement');
const playBtn = document.getElementById('playPauseBtn');

function playTrack(track) {
    audio.src = track.audio;
    audio.play();
    document.getElementById('playerTitle').textContent = track.title;
    document.getElementById('playerArtist').textContent = track.artist;
    document.getElementById('playerCover').src = track.cover || DEFAULT_COVER;
    playBtn.textContent = 'pause_circle';
}

playBtn.onclick = () => {
    if(audio.paused) { audio.play(); playBtn.textContent = 'pause_circle'; }
    else { audio.pause(); playBtn.textContent = 'play_circle'; }
}

audio.ontimeupdate = () => {
    if(audio.duration) {
        document.getElementById('progressFill').style.width = (audio.currentTime/audio.duration)*100 + '%';
        document.getElementById('curTime').textContent = fmtTime(audio.currentTime);
        document.getElementById('durTime').textContent = fmtTime(audio.duration);
    }
}

function fmtTime(s) { return new Date(s * 1000).toISOString().substr(14, 5); }

// Search
document.getElementById('searchInput').oninput = (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = allTracks.filter(t => t.title.toLowerCase().includes(term) || t.artist.toLowerCase().includes(term));
    renderTracks(filtered);
}

// Sidebar Mobile
document.getElementById('hamburgerBtn').onclick = () => {
    document.getElementById('sidebar').classList.add('open');
    document.getElementById('overlay').classList.add('active');
}
document.getElementById('overlay').onclick = () => {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('active');
}
</script>
</body>
</html>
