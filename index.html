<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Two Minutes Food</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1A3C34">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preload" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js" as="script">
  <style>
    /* Custom Scrollbar */
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    /* Toast Notification */
    .toast {
      @apply fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50;
    }
    /* Spinner */
    .spinner {
      @apply fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center z-50;
    }
    .spinner.hidden {
      @apply hidden;
    }
    /* Button Styles */
    .btn-primary {
      @apply bg-green-900 text-white hover:bg-green-800 transition duration-200 rounded-lg px-4 py-2;
    }
    .btn-secondary {
      @apply bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-200 rounded-lg px-4 py-2;
    }
    /* Card Style */
    .card {
      @apply bg-white rounded-xl shadow-md p-4 transition transform hover:scale-105 hover:shadow-lg cursor-pointer;
    }
    /* Input Style */
    .input-field {
      @apply w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-900 focus:border-green-900;
    }
    /* Modal Styles */
    .modal {
      @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
    }
    .modal-content {
      @apply bg-white rounded-xl p-6 w-11/12 sm:w-96;
    }
    /* Bottom Nav (Mobile) */
    .bottom-nav {
      @apply fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-2 z-40 sm:hidden;
    }
    .bottom-nav a {
      @apply flex flex-col items-center text-gray-600 text-xs transition;
    }
    .bottom-nav a.active, .bottom-nav a:hover {
      @apply text-green-900;
    }
    .bottom-nav .cart-icon .cart-count {
      @apply absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-2 py-1;
    }
    /* Sidebar (Desktop) */
    .sidebar {
      @apply fixed top-0 left-0 w-64 h-full bg-green-900 text-white p-6 hidden sm:block;
    }
    .sidebar a {
      @apply flex items-center text-white hover:bg-green-800 rounded-lg p-2 transition;
    }
    /* Unavailable Overlay */
    .unavailable-overlay {
      @apply absolute inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center rounded-xl;
    }
    .unavailable-text {
      @apply text-white text-lg font-semibold;
    }
    @media (min-width: 640px) {
      .content-container {
        @apply ml-64; /* Adjust for sidebar */
      }
      .bottom-nav {
        @apply hidden;
      }
      .toast {
        @apply bottom-4;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <!-- Header -->
  <header class="bg-green-900 text-white p-4 flex items-center justify-between sticky top-0 z-20 shadow-md">
    <div class="flex items-center gap-3">
      <button id="menuToggle" class="sm:hidden text-white">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <img src="logo.jpg" alt="My Two Minutes Food Logo" class="w-8 h-8 rounded-full object-cover">
      <div id="userLocation" class="flex items-center gap-2">
        <i class="fas fa-map-marker-alt"></i>
        <span id="locationText" class="text-sm">Fetching location...</span>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="relative hidden sm:block">
        <input type="text" id="searchInput" placeholder="Search restaurants, shops, or cuisines..." class="input-field w-64">
        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
      <button id="cartBtn" class="btn-primary relative hidden sm:block" aria-label="View Cart">
        <i class="fas fa-shopping-cart"></i>
        <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1">0</span>
      </button>
      <div class="flex items-center gap-2">
        <img id="userProfilePic" src="" alt="Profile" class="w-8 h-8 rounded-full">
        <span id="userName" class="text-sm font-semibold hidden sm:block"></span>
        <button id="signOutBtn" class="btn-secondary text-sm hidden sm:block">Sign Out</button>
      </div>
    </div>
  </header>

  <!-- Sidebar (Desktop) / Drawer (Mobile) -->
  <div id="sidebar" class="sidebar sm:block hidden">
    <h2 class="text-xl font-bold mb-6">My Two Minutes Food</h2>
    <ul class="space-y-2">
      <li><a href="index.html" class="active"><i class="fas fa-home mr-2"></i>Home</a></li>
      <li><a href="orders.html"><i class="fas fa-clipboard-list mr-2"></i>Orders</a></li>
      <li><a href="profile.html"><i class="fas fa-user mr-2"></i>Profile</a></li>
      <li><a href="settings.html"><i class="fas fa-cog mr-2"></i>Settings</a></li>
      <li><a href="history.html"><i class="fas fa-history mr-2"></i>Order History</a></li>
      <li><a href="#" id="signOutSidebar"><i class="fas fa-sign-out-alt mr-2"></i>Sign Out</a></li>
    </ul>
  </div>
  <div id="drawer" class="fixed top-0 left-0 w-64 h-full bg-green-900 text-white p-6 transform -translate-x-full transition-transform sm:hidden z-50">
    <h2 class="text-xl font-bold mb-6">Menu</h2>
    <ul class="space-y-2">
      <li><a href="index.html" class="active"><i class="fas fa-home mr-2"></i>Home</a></li>
      <li><a href="orders.html"><i class="fas fa-clipboard-list mr-2"></i>Orders</a></li>
      <li><a href="profile.html"><i class="fas fa-user mr-2"></i>Profile</a></li>
      <li><a href="settings.html"><i class="fas fa-cog mr-2"></i>Settings</a></li>
      <li><a href="history.html"><i class="fas fa-history mr-2"></i>Order History</a></li>
      <li><a href="#" id="signOutDrawer"><i class="fas fa-sign-out-alt mr-2"></i>Sign Out</a></li>
    </ul>
  </div>
  <div id="drawerBackdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

  <!-- Spinner -->
  <div id="spinner" class="spinner hidden">
    <svg class="animate-spin h-10 w-10 text-green-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
  </div>

  <!-- Modals -->
  <div id="locationModal" class="modal hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-map-marker-alt text-green-900 mr-2"></i>Location Required</h3>
      <p class="text-sm text-gray-600 mb-6">Enable location services to find restaurants and shops near you.</p>
      <div class="flex gap-2">
        <button id="enableLocationBtn" class="btn-primary flex-1">Enable Location</button>
        <button id="dismissLocationBtn" class="btn-secondary flex-1">Dismiss</button>
      </div>
    </div>
  </div>
  <div id="installModal" class="modal hidden">
    <div class="modal-content">
      <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-mobile-alt text-green-900 mr-2"></i>Install App</h3>
      <p class="text-sm text-gray-600 mb-6">Install My Two Minutes Food for a seamless experience!</p>
      <div class="flex gap-2">
        <button id="installAppBtn" class="btn-primary flex-1">Install</button>
        <button id="dismissInstallBtn" class="btn-secondary flex-1">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-container container mx-auto px-4 sm:px-6 py-8">
    <!-- Search and Filters (Mobile) -->
    <div class="sm:hidden mb-4">
      <div class="relative">
        <input type="text" id="mobileSearchInput" placeholder="Search restaurants, shops, or cuisines..." class="input-field">
        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
    </div>
    <div class="flex flex-wrap items-center gap-2 mb-6">
      <select id="switchView" class="input-field w-40">
        <option value="restaurants">Restaurants</option>
        <option value="shops">Shops</option>
      </select>
      <select id="sortSelect" class="input-field w-40">
        <option value="rating">Sort by Rating</option>
        <option value="distance">Sort by Distance</option>
        <option value="name">Sort by Name</option>
      </select>
      <button id="filterBtn" class="btn-primary flex items-center gap-1"><i class="fas fa-filter"></i>Filters</button>
    </div>

    <!-- Recommended Section -->
    <div class="mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Recommended for You</h2>
      <div id="recommendedList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <p class="text-sm text-gray-500 text-center col-span-full">Loading recommendations...</p>
      </div>
    </div>

    <!-- Main Content Panels -->
    <div id="restaurantsPanel" role="tabpanel" aria-labelledby="restaurantsPanel">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Restaurants</h2>
      <div id="restaurantList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <p id="loadingMessage" class="text-sm text-gray-500 text-center col-span-full">Loading restaurants...</p>
      </div>
    </div>
    <div id="shopsPanel" class="hidden" role="tabpanel" aria-labelledby="shopsPanel">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Shops</h2>
      <div id="shopList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <p id="loadingShopsMessage" class="text-sm text-gray-500 text-center col-span-full">Loading shops...</p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation (Mobile) -->
  <nav class="bottom-nav">
    <a href="orders.html"><i class="fas fa-clipboard-list text-lg"></i><span>Orders</span></a>
    <a href="profile.html"><i class="fas fa-user text-lg"></i><span>Profile</span></a>
    <a href="index.html" class="active"><i class="fas fa-home text-lg"></i><span>Home</span></a>
    <a href="#" id="cartNavBtn" class="cart-icon"><i class="fas fa-shopping-cart text-lg"></i><span class="cart-count" id="cartNavCount">0</span><span>Cart</span></a>
    <a href="track.html"><i class="fas fa-map text-lg"></i><span>Track</span></a>
  </nav>

  <!-- JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e",
  measurementId: "G-V4W97VMSKL"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();
    mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN';

    // DOM Elements
    const elements = {
      searchInput: document.getElementById('searchInput'),
      mobileSearchInput: document.getElementById('mobileSearchInput'),
      sortSelect: document.getElementById('sortSelect'),
      filterBtn: document.getElementById('filterBtn'),
      switchView: document.getElementById('switchView'),
      restaurantList: document.getElementById('restaurantList'),
      shopList: document.getElementById('shopList'),
      recommendedList: document.getElementById('recommendedList'),
      loadingMessage: document.getElementById('loadingMessage'),
      loadingShopsMessage: document.getElementById('loadingShopsMessage'),
      cartBtn: document.getElementById('cartBtn'),
      cartCount: document.getElementById('cartCount'),
      cartNavBtn: document.getElementById('cartNavBtn'),
      cartNavCount: document.getElementById('cartNavCount'),
      menuToggle: document.getElementById('menuToggle'),
      drawer: document.getElementById('drawer'),
      drawerBackdrop: document.getElementById('drawerBackdrop'),
      signOutBtn: document.getElementById('signOutBtn'),
      signOutSidebar: document.getElementById('signOutSidebar'),
      signOutDrawer: document.getElementById('signOutDrawer'),
      spinner: document.getElementById('spinner'),
      userName: document.getElementById('userName'),
      userProfilePic: document.getElementById('userProfilePic'),
      userLocation: document.getElementById('userLocation'),
      locationText: document.getElementById('locationText'),
      locationModal: document.getElementById('locationModal'),
      enableLocationBtn: document.getElementById('enableLocationBtn'),
      dismissLocationBtn: document.getElementById('dismissLocationBtn'),
      installModal: document.getElementById('installModal'),
      installAppBtn: document.getElementById('installAppBtn'),
      dismissInstallBtn: document.getElementById('dismissInstallBtn'),
      restaurantsPanel: document.getElementById('restaurantsPanel'),
      shopsPanel: document.getElementById('shopsPanel')
    };

    let userId = null, cart = [], restaurants = [], shops = [], ratings = {}, userCoords = null, activeView = 'restaurants', deferredPrompt = null;

    // Utility Functions
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return (R * c).toFixed(2);
    }

    async function geocodeLocation(location) {
      const cacheKey = `geocode_${location}`;
      const cached = localStorage.getItem(cacheKey);
      if (cached) return JSON.parse(cached);
      try {
        const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(location)}.json?access_token=${mapboxgl.accessToken}`);
        const data = await response.json();
        if (data.features && data.features.length > 0) {
          const [longitude, latitude] = data.features[0].center;
          const coords = { latitude, longitude };
          localStorage.setItem(cacheKey, JSON.stringify(coords));
          return coords;
        }
        return null;
      } catch (error) {
        console.error('Geocoding error:', error);
        return null;
      }
    }

    async function getUserLocation(showModalOnError = true) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
            try {
              const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${userCoords.longitude},${userCoords.latitude}.json?access_token=${mapboxgl.accessToken}`);
              const data = await response.json();
              elements.locationText.textContent = data.features[0]?.place_name?.split(',')[0] + ', ZA' || 'Location unavailable';
              elements.userLocation.classList.remove('hidden');
              updateSortOptions();
              renderContent();
            } catch (error) {
              console.error('Mapbox error:', error);
              showToast('Failed to fetch location.');
              elements.locationText.textContent = 'Location unavailable';
              elements.userLocation.classList.remove('hidden');
            }
          },
          (error) => {
            console.error('Geolocation error:', error);
            if (showModalOnError) elements.locationModal.classList.remove('hidden');
            else {
              showToast('Location access denied.');
              elements.locationText.textContent = 'Location unavailable';
              elements.userLocation.classList.remove('hidden');
            }
            updateSortOptions();
          }
        );
      } else {
        if (showModalOnError) elements.locationModal.classList.remove('hidden');
        else {
          showToast('Geolocation not supported.');
          elements.locationText.textContent = 'Location unavailable';
          elements.userLocation.classList.remove('hidden');
        }
      }
    }

    function updateSortOptions() {
      const distanceOption = elements.sortSelect.querySelector('option[value="distance"]');
      if (!userCoords) {
        distanceOption.disabled = true;
        if (elements.sortSelect.value === 'distance') {
          elements.sortSelect.value = 'rating';
          showToast('Enable location to sort by distance.');
        }
      } else {
        distanceOption.disabled = false;
      }
    }

    function loadCart() {
      cart = JSON.parse(localStorage.getItem(`cart-${userId}`)) || [];
      updateCartCount();
    }

    function updateCartCount() {
      const count = cart.reduce((total, c) => total + (c.quantity || 0), 0);
      elements.cartCount.textContent = count;
      elements.cartNavCount.textContent = count;
      elements.cartBtn.classList.toggle('bg-green-800', count > 0);
      elements.cartNavBtn.classList.toggle('active', count > 0);
    }

    async function renderContent() {
      if (activeView === 'restaurants') {
        await renderRestaurants();
        renderRecommended('restaurants');
      } else {
        renderShops();
        renderRecommended('shops');
      }
    }

    async function renderRestaurants() {
      elements.restaurantList.innerHTML = '';
      elements.loadingMessage.style.display = 'none';
      let filteredRestaurants = restaurants.map(r => ({
        ...r,
        rating: ratings[r.id]?.average || r.rating || 0
      }));

      const searchTerm = (elements.searchInput.value || elements.mobileSearchInput.value).toLowerCase();
      filteredRestaurants = filteredRestaurants.filter(r =>
        (r.name || '').toLowerCase().includes(searchTerm) ||
        (r.location || '').toLowerCase().includes(searchTerm) ||
        (r.cuisine || '').toLowerCase().includes(searchTerm)
      );

      if (userCoords) {
        filteredRestaurants = await Promise.all(filteredRestaurants.map(async r => {
          const coords = await geocodeLocation(r.location);
          const distance = coords ? calculateDistance(userCoords.latitude, userCoords.longitude, coords.latitude, coords.longitude) : 'N/A';
          return { ...r, distance };
        }));
      }

      filteredRestaurants.sort((a, b) => {
        const sortBy = elements.sortSelect.value;
        if (sortBy === 'rating') return (b.rating || 0) - (a.rating || 0);
        if (sortBy === 'distance') return (parseFloat(a.distance) || Infinity) - (parseFloat(b.distance) || Infinity);
        return (a.name || '').localeCompare(b.name || '');
      });

      if (filteredRestaurants.length === 0) {
        elements.restaurantList.innerHTML = '<p class="text-sm text-gray-500 text-center col-span-full">No restaurants found.</p>';
        return;
      }

      filteredRestaurants.forEach(r => {
        const card = document.createElement('div');
        card.className = 'card relative';
        card.dataset.id = r.id;
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', `View ${r.name || 'restaurant'} details`);
        card.innerHTML = `
          <img src="${r.image || 'https://via.placeholder.com/150'}" alt="${r.name || 'Restaurant'}" class="w-full h-40 object-cover rounded-t-xl" loading="lazy">
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-800">${r.name || 'Unknown'}</h3>
            <p class="text-sm text-gray-600">${r.cuisine || 'Various'}</p>
            <p class="text-sm text-gray-600">${r.location || 'No location'}</p>
            <div class="flex justify-between items-center mt-2">
              ${r.available === false ? '<span class="text-sm text-red-500">Not Available</span>' : 
                `<span class="text-sm text-gray-600"><i class="fas fa-star text-green-900"></i> ${r.rating ? r.rating.toFixed(1) : 'N/A'}</span>`}
              <span class="text-sm text-gray-600">${r.distance || 'N/A'} km</span>
            </div>
            ${r.available !== false && r.priceRange ? `<p class="text-sm text-gray-600 mt-2">Price: ${r.priceRange} (ZAR)</p>` : ''}
          </div>
          ${r.available === false ? '<div class="unavailable-overlay"><span class="unavailable-text">Not Available</span></div>' : ''}
        `;
        card.addEventListener('click', () => r.available !== false ? window.location.href = `restaurant_menu.html?restaurantId=${r.id}` : showToast('This restaurant is currently not available.'));
        card.addEventListener('keypress', e => (e.key === 'Enter' || e.key === ' ') && card.click());
        elements.restaurantList.appendChild(card);
      });
    }

    function renderShops() {
      elements.shopList.innerHTML = '';
      elements.loadingShopsMessage.style.display = 'none';
      let filteredShops = shops.filter(s =>
        (s.name || '').toLowerCase().includes((elements.searchInput.value || elements.mobileSearchInput.value).toLowerCase()) ||
        (s.location || '').toLowerCase().includes((elements.searchInput.value || elements.mobileSearchInput.value).toLowerCase())
      );

      filteredShops.sort((a, b) => {
        const sortBy = elements.sortSelect.value;
        if (sortBy === 'rating') return (b.rating || 0) - (a.rating || 0);
        if (sortBy === 'distance') return (parseFloat(a.distance) || Infinity) - (parseFloat(b.distance) || Infinity);
        return (a.name || '').localeCompare(b.name || '');
      });

      if (filteredShops.length === 0) {
        elements.shopList.innerHTML = '<p class="text-sm text-gray-500 text-center col-span-full">No shops found.</p>';
        return;
      }

      filteredShops.forEach(s => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = s.id;
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', `View ${s.name || 'shop'} details`);
        card.innerHTML = `
          <img src="${s.image || 'https://via.placeholder.com/150'}" alt="${s.name || 'Shop'}" class="w-full h-40 object-cover rounded-t-xl" loading="lazy">
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-800">${s.name || 'Unknown'}</h3>
            <p class="text-sm text-gray-600">${s.location || 'No location'}</p>
            <div class="flex justify-between items-center mt-2">
              <span class="text-sm text-gray-600"><i class="fas fa-star text-green-900"></i> ${s.rating ? s.rating.toFixed(1) : 'N/A'}</span>
              <span class="text-sm text-gray-600">${s.distance || 'N/A'} km</span>
            </div>
            ${s.priceRange ? `<p class="text-sm text-gray-600 mt-2">Price: ${s.priceRange} (ZAR)</p>` : ''}
          </div>
        `;
        card.addEventListener('click', () => window.location.href = `shop_menu.html?shopId=${s.id}`);
        card.addEventListener('keypress', e => (e.key === 'Enter' || e.key === ' ') && card.click());
        elements.shopList.appendChild(card);
      });
    }

    function renderRecommended(type) {
      elements.recommendedList.innerHTML = '';
      const items = type === 'restaurants' ? restaurants : shops;
      const filteredItems = items.slice(0, 3).map(item => ({ ...item, rating: ratings[item.id]?.average || item.rating || 0 }));
      if (filteredItems.length === 0) {
        elements.recommendedList.innerHTML = '<p class="text-sm text-gray-500 text-center col-span-full">No recommendations available.</p>';
        return;
      }
      filteredItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = item.id;
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', `View ${item.name || 'item'} details`);
        card.innerHTML = `
          <img src="${item.image || 'https://via.placeholder.com/150'}" alt="${item.name || 'Item'}" class="w-full h-40 object-cover rounded-t-xl" loading="lazy">
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-800">${item.name || 'Unknown'}</h3>
            <p class="text-sm text-gray-600">${item.cuisine || item.category || 'Various'}</p>
            <span class="text-sm text-gray-600"><i class="fas fa-star text-green-900"></i> ${item.rating ? item.rating.toFixed(1) : 'N/A'}</span>
          </div>
        `;
        card.addEventListener('click', () => window.location.href = `${type === 'restaurants' ? 'restaurant_menu' : 'shop_menu'}.html?${type === 'restaurants' ? 'restaurantId' : 'shopId'}=${item.id}`);
        card.addEventListener('keypress', e => (e.key === 'Enter' || e.key === ' ') && card.click());
        elements.recommendedList.appendChild(card);
      });
    }

    function loadRestaurants() {
      const restaurantsRef = ref(db, 'restaurants');
      const ratingsRef = ref(db, 'ratings');
      elements.spinner.classList.remove('hidden');
      Promise.all([
        new Promise(resolve => onValue(restaurantsRef, snapshot => resolve(snapshot.val()), { onlyOnce: true })),
        new Promise(resolve => onValue(ratingsRef, snapshot => resolve(snapshot.val()), { onlyOnce: true }))
      ])
        .then(([restaurantsData, ratingsData]) => {
          restaurants = restaurantsData ? Object.keys(restaurantsData).map(id => ({ id, ...restaurantsData[id], available: restaurantsData[id].available !== false })) : [];
          ratings = ratingsData || {};
          elements.loadingMessage.style.display = restaurants.length ? 'none' : 'block';
          elements.loadingMessage.textContent = restaurants.length ? 'Loading restaurants...' : 'No restaurants available.';
          if (activeView === 'restaurants') renderContent();
          elements.spinner.classList.add('hidden');
        })
        .catch(error => {
          console.error('Error loading restaurants:', error);
          elements.loadingMessage.textContent = 'Failed to load restaurants. Please try again.';
          elements.loadingMessage.style.display = 'block';
          showToast('Failed to load restaurants.');
          elements.spinner.classList.add('hidden');
        });
    }

    function loadShops() {
      const shopsRef = ref(db, 'shops');
      onValue(shopsRef, snapshot => {
        shops = snapshot.val() ? Object.keys(snapshot.val()).map(id => ({ id, ...snapshot.val()[id] })) : [];
        elements.loadingShopsMessage.style.display = shops.length ? 'none' : 'block';
        elements.loadingShopsMessage.textContent = shops.length ? 'Loading shops...' : 'No shops available.';
        if (activeView === 'shops') renderContent();
        elements.spinner.classList.add('hidden');
      }, error => {
        console.error('Error loading shops:', error);
        elements.loadingShopsMessage.textContent = 'Failed to load shops. Please try again.';
        elements.loadingShopsMessage.style.display = 'block';
        showToast('Failed to load shops.');
        elements.spinner.classList.add('hidden');
      });
    }

    function validateCartAndRedirect() {
      if (!cart.length) {
        showToast('Your cart is empty.');
        return;
      }
      const firstItem = cart[0];
      const type = firstItem.restaurantId ? 'restaurantId' : 'shopId';
      const id = firstItem.restaurantId || firstItem.shopId;
      const isValid = cart.every(item => item[type] === id);
      if (!isValid) {
        showToast('Cart contains items from multiple sources. Please clear or complete your order.');
        return;
      }
      window.location.href = `checkout.html?${type}=${id}&cart=${encodeURIComponent(JSON.stringify(cart))}`;
    }

    // Event Listeners
    elements.menuToggle.addEventListener('click', () => {
      elements.drawer.classList.toggle('-translate-x-full');
      elements.drawerBackdrop.classList.toggle('hidden');
    });
    elements.drawerBackdrop.addEventListener('click', () => {
      elements.drawer.classList.add('-translate-x-full');
      elements.drawerBackdrop.classList.add('hidden');
    });
    document.querySelectorAll('#drawer a').forEach(link => {
      link.addEventListener('click', () => {
        elements.drawer.classList.add('-translate-x-full');
        elements.drawerBackdrop.classList.add('hidden');
      });
    });
    elements.switchView.addEventListener('change', () => {
      activeView = elements.switchView.value;
      elements.restaurantsPanel.classList.toggle('hidden', activeView !== 'restaurants');
      elements.shopsPanel.classList.toggle('hidden', activeView !== 'shops');
      renderContent();
    });
    elements.searchInput.addEventListener('input', debounce(renderContent, 300));
    elements.mobileSearchInput.addEventListener('input', debounce(renderContent, 300));
    elements.sortSelect.addEventListener('change', renderContent);
    elements.filterBtn.addEventListener('click', () => showToast('Advanced filters coming soon!'));
    elements.cartBtn.addEventListener('click', validateCartAndRedirect);
    elements.cartNavBtn.addEventListener('click', e => { e.preventDefault(); validateCartAndRedirect(); });
    elements.enableLocationBtn.addEventListener('click', () => {
      elements.locationModal.classList.add('hidden');
      getUserLocation(false);
    });
    elements.dismissLocationBtn.addEventListener('click', () => {
      elements.locationModal.classList.add('hidden');
      elements.locationText.textContent = 'Location unavailable';
      elements.userLocation.classList.remove('hidden');
    });
    function handleSignOut() {
      elements.spinner.classList.remove('hidden');
      signOut(auth).then(() => window.location.href = 'login.html').catch(error => {
        console.error('Sign Out Error:', error);
        showToast('Failed to sign out.');
        elements.spinner.classList.add('hidden');
      });
    }
    elements.signOutBtn.addEventListener('click', handleSignOut);
    elements.signOutSidebar.addEventListener('click', handleSignOut);
    elements.signOutDrawer.addEventListener('click', e => { e.preventDefault(); handleSignOut(); });

    // PWA Installation
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      if (!localStorage.getItem('installPromptShown')) {
        elements.installModal.classList.remove('hidden');
        localStorage.setItem('installPromptShown', 'true');
      }
    });
    elements.installAppBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('PWA Install:', outcome);
        deferredPrompt = null;
        elements.installModal.classList.add('hidden');
      }
    });
    elements.dismissInstallBtn.addEventListener('click', () => {
      elements.installModal.classList.add('hidden');
      deferredPrompt = null;
    });
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(reg => console.log('Service Worker registered:', reg)).catch(err => console.error('Service Worker registration failed:', err));
      });
    }

    // Authentication
    onAuthStateChanged(auth, user => {
      elements.spinner.classList.remove('hidden');
      if (user) {
        userId = user.uid;
        elements.userName.textContent = user.displayName || 'User';
        elements.userProfilePic.src = user.photoURL || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
        loadCart();
        loadRestaurants();
        loadShops();
        getUserLocation();
      } else {
        window.location.href = 'login.html';
      }
      elements.spinner.classList.add('hidden');
    }, error => {
      console.error('Auth error:', error);
      showToast('Authentication failed.');
      elements.spinner.classList.add('hidden');
    });
  </script>
</body>
</html>
