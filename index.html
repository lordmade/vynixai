<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root{--bg:#000;--card:#16181c;--text:#fff;--secondary:#71767b;--border:#2f3336;--blue:#1d9bf0;--red:#e11d48;--glow:0 0 12px rgba(29,155,240,.4);}
    body.light{--bg:#fff;--card:#fff;--text:#000;--secondary:#536471;--border:#ccd6dd;}
    body{font-family:'Chirp',system-ui,sans-serif;background:var(--bg);color:var(--text);margin:0;overflow-x:hidden;transition:all .3s;}
    .header{position:fixed;top:0;left:0;right:0;background:var(--card);border-bottom:1px solid var(--border);z-index:100;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;height:64px;box-shadow:0 1px 3px rgba(0,0,0,.1);backdrop-filter:blur(12px);}
    .main-content{padding:84px 16px 120px;min-height:100vh;}
    .status-list{display:flex;flex-direction:column;gap:16px;}
    .status-post{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .status-post-header{padding:12px 16px;display:flex;gap:12px;cursor:pointer;}
    .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;}
    .username{font-weight:700;font-size:15px;display:flex;align-items:center;gap:5px;}
    .verified{color:var(--blue);font-size:19px;}
    .handle{color:var(--secondary);font-size:14px;}
    .time{font-size:13px;color:var(--secondary);margin-left:auto;}
    .content{padding:0 16px 12px;font-size:15.5px;line-height:1.45;white-space:pre-wrap;word-break:break-word;}
    .content a{color:var(--blue);}
    .media{max-height:580px;width:100%;object-fit:contain;background:#000;border-radius:12px;}
    .actions{padding:8px 16px;display:flex;justify-content:space-between;border-top:1px solid var(--border);font-size:14px;}
    .action{cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--secondary);transition:all .2s;padding:8px;border-radius:8px;}
    .action:hover{background:rgba(29,155,240,.1);color:var(--blue);}
    .action.liked{color:var(--red);}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0;z-index:100;backdrop-filter:blur(12px);}
    .nav-item.active{color:var(--blue);}
    .fab{position:fixed;bottom:92px;right:16px;width:56px;height:56px;border-radius:50%;background:var(--blue);color:#fff;box-shadow:var(--glow),0 8px 32px rgba(29,155,240,.4);z-index:99;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:300;}
    .loader{text-align:center;padding:40px;color:var(--secondary);}
    .loader::after{content:'';width:20px;height:20px;border:3px solid var(--blue);border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin 1s linear infinite;margin-left:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    #horizontal-spinner{position:fixed;top:0;left:0;right:0;height:3px;background:var(--blue);transform:scaleX(0);transform-origin:left;transition:transform .4s;z-index:999;}
    #horizontal-spinner.active{transform:scaleX(1);transition:transform .1s;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);opacity:0;pointer-events:none;transition:opacity .3s;z-index:199;}
    .overlay.active{opacity:1;pointer-events:all;}
    .search-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--card);transform:translateY(-100%);transition:transform .35s cubic-bezier(0.32,0.72,0,1);z-index:250;display:flex;flex-direction:column;}
    .search-modal.active{transform:translateY(0);}
    .search-header{padding:16px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px;}
    .search-input{width:100%;background:var(--bg);border:none;color:var(--text);font-size:18px;padding:12px 16px;border-radius:99px;outline:none;}
    .search-back-btn{cursor:pointer;font-size:24px;color:var(--text);}
    .search-results{flex:1;overflow-y:auto;padding:8px 0;}
    .search-item{padding:12px 16px;display:flex;gap:12px;align-items:center;cursor:pointer;transition:background .2s;}
    .search-item:hover{background:rgba(255,255,255,.05);}
    .search-user-avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;}
    .search-no-results{padding:40px;text-align:center;color:var(--secondary);}
    .search-history-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);}
    .clear-history-btn{color:var(--secondary);font-size:14px;cursor:pointer;}
    .upload-sheet{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-radius:24px 24px 0 0;padding:20px;transform:translateY(100%);transition:transform .35s;z-index:200;box-shadow:0 -10px 40px rgba(0,0,0,.5);}
    .upload-sheet.active{transform:translateY(0);}
    .longpress-menu{position:absolute;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px 0;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:300;opacity:0;pointer-events:none;transition:opacity .2s;min-width:180px;}
    .longpress-menu.active{opacity:1;pointer-events:all;}
    .menu-item{padding:14px 20px;font-size:15px;cursor:pointer;transition:background .2s;}
    .menu-item:hover{background:rgba(29,155,240,.1);color:var(--blue);}
    .repost-quote{margin:12px 16px;padding:12px;border:1px solid var(--border);border-radius:12px;background:rgba(29,155,240,.05);font-size:14.5px;}
    .voice-preview audio{width:100%;height:60px;}
  </style>
</head>
<body class="dark">

  <div id="horizontal-spinner"></div>
  <div class="overlay" id="overlay" onclick="closeAll()"></div>

  <div class="search-modal" id="search-modal">
    <div class="search-header">
      <span class="search-back-btn" onclick="closeSearch()">Back</span>
      <input type="text" id="search-input" class="search-input" placeholder="Search Vynix" autofocus>
    </div>
    <div class="search-results" id="search-results">
      <div class="search-no-results">Type to search posts, people, and hashtags</div>
    </div>
  </div>

  <div class="upload-sheet" id="upload-sheet">
    <div style="width:40px;height:5px;background:var(--border);border-radius:3px;margin:0 auto 20px;"></div>
    <textarea id="post-text" placeholder="What's happening?" style="width:100%;min-height:120px;background:transparent;border:none;color:var(--text);font-size:18px;resize:none;outline:none;" maxlength="280"></textarea>
    <div id="char-count" style="text-align:right;color:var(--secondary);font-size:13px;">280</div>
    <div style="display:flex;gap:12px;margin:16px 0;align-items:center;">
      <label style="cursor:pointer;"><input type="file" id="media-input" accept="image/*,video/*" style="display:none;"> Photo</label>
      <button onclick="startVoiceRecord()" id="voice-btn">Voice</button>
    </div>
    <div id="media-preview" style="margin:12px 0;"></div>
    <div id="voice-preview" style="display:none;" class="voice-preview"></div>
    <button style="width:100%;padding:14px;background:var(--blue);color:#fff;border:none;border-radius:99px;font-weight:700;font-size:17px;margin-top:12px;" onclick="uploadPost()">Post</button>
  </div>

  <div class="longpress-menu" id="longpress-menu">
    <div class="menu-item" onclick="editPost(currentPostId)">Edit</div>
    <div class="menu-item" onclick="deletePost(currentPostId)">Delete</div>
    <div class="menu-item" onclick="quoteRepost(currentPostId)">Quote Repost</div>
    <div class="menu-item" onclick="copyLink(currentPostId)">Copy Link</div>
  </div>

  <header class="header">
    <div onclick="toggleSlide()" style="display:flex;align-items:center;gap:12px;cursor:pointer;">
      <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
        <rect x="4" y="4" width="28" height="28" rx="10" fill="#000"/>
        <path d="M29.75 8.25h4.5L18 33.75h-4.5L2.25 8.25h4.5l9 20.19L29.75 8.25Z" fill="#FFF"/>
      </svg>
      <h1 style="font-size:24px;font-weight:900;">Vynix</h1>
    </div>
    <button onclick="toggleTheme()" style="font-size:20px;">Theme</button>
  </header>

  <main class="main-content">
    <div style="display:flex;border-bottom:1px solid var(--border);position:sticky;top:64px;background:var(--card);z-index:99;">
      <button class="sub-tab-item active flex-1 py-4 font-bold" data-tab="all">For You</button>
      <button class="sub-tab-item flex-1 py-4 font-bold" data-tab="images">Images</button>
      <button class="sub-tab-item flex-1 py-4 font-bold" data-tab="text">Text</button>
    </div>

    <div id="all-feed" class="status-list"></div>
    <div id="images-feed" class="status-list" style="display:none;"></div>
    <div id="text-feed" class="status-list" style="display:none;"></div>
    <div class="loader" id="feed-loader">Loading more...</div>
  </main>

  <nav class="bottom-nav">
    <button class="nav-item active">Home</button>
    <button class="nav-item" onclick="openSearch()">Search</button>
    <button class="nav-item">Messages</button>
    <button class="nav-item">Notifications</button>
    <button class="nav-item">AI</button>
  </nav>

  <button class="fab" onclick="openUpload()">+</button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js';
    import { getDatabase, ref, push, set, update, remove, onValue, query, orderByChild, limitToLast, startAfter, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js';

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let currentUser, currentUserData = {}, lastKey = null, loading = false, hasMore = true, currentTab = 'all';
    let currentPostId = null, currentPostData = null;
    let mediaFile = null, mediaType = null, mediaUrl = null;
    let recorder = null, audioChunks = [];
    let searchTimeout;

    const spinner = document.getElementById('horizontal-spinner');
    const overlay = document.getElementById('overlay');
    const uploadSheet = document.getElementById('upload-sheet');
    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');

    window.openUpload = () => {
      uploadSheet.classList.add('active');
      overlay.classList.add('active');
      document.getElementById('post-text').focus();
    };

    window.closeAll = () => {
      uploadSheet.classList.remove('active');
      overlay.classList.remove('active');
      document.getElementById('longpress-menu').classList.remove('active');
      closeSearch();
    };

    window.openSearch = () => {
      searchModal.classList.add('active');
      overlay.classList.add('active');
      searchInput.focus();
      loadSearchHistory();
    };

    window.closeSearch = () => {
      searchModal.classList.remove('active');
      searchInput.value = '';
      searchResults.innerHTML = '<div class="search-no-results">Type to search posts, people, and hashtags</div>';
    };

    function saveToHistory(query) {
      if (!query.trim()) return;
      let history = JSON.parse(localStorage.getItem('vynix_search_history') || '[]');
      history = history.filter(h => h !== query);
      history.unshift(query);
      if (history.length > 10) history.pop();
      localStorage.setItem('vynix_search_history', JSON.stringify(history));
    }

    function loadSearchHistory() {
      const history = JSON.parse(localStorage.getItem('vynix_search_history') || '[]');
      if (history.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">No recent searches</div>';
        return;
      }
      searchResults.innerHTML = `
        <div style="padding:12px 16px;color:var(--secondary);font-size:14px;display:flex;justify-content:space-between;">
          <span>Recent</span>
          <span class="clear-history-btn" onclick="localStorage.removeItem('vynix_search_history'); loadSearchHistory()">Clear</span>
        </div>
      ` + history.map(q => `
        <div class="search-history-item" onclick="searchInput.value='${q}'; performSearch('${q}')">
          <span>${q}</span>
          <span style="color:var(--secondary);">Go</span>
        </div>
      `).join('');
    }

    window.performSearch = async (query) => {
      query = query.trim();
      if (!query) return loadSearchHistory();
      saveToHistory(query);

      searchResults.innerHTML = '<div class="loader">Searching...</div>';

      const lowerQuery = query.toLowerCase();
      const postsSnap = await get(query(ref(db, 'statuses'), orderByChild('timestamp'), limitToLast(50)));
      const usersSnap = await get(ref(db, 'users'));

      let results = [];

      postsSnap.forEach(child => {
        const post = child.val();
        const content = (post.content || '').toLowerCase();
        const name = (post.user?.displayName || '').toLowerCase();
        if (content.includes(lowerQuery) || name.includes(lowerQuery)) {
          results.push({ type: 'post', data: { id: child.key, ...post } });
        }
      });

      usersSnap.forEach(child => {
        const user = child.val();
        if (user.displayName?.toLowerCase().includes(lowerQuery) || user.username?.toLowerCase().includes(lowerQuery)) {
          results.push({ type: 'user', data: { uid: child.key, ...user } });
        }
      });

      if (query.startsWith('#')) {
        results.unshift({ type: 'hashtag', data: { tag: query } });
      }

      if (results.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
        return;
      }

      searchResults.innerHTML = results.map(r => {
        if (r.type === 'post') {
          const p = r.data;
          return `<div class="search-item" onclick="location.href='post.html?id=${p.id}'">
            <img src="${p.user?.photoURL || 'https://via.placeholder.com/48'}" class="search-user-avatar">
            <div>
              <div style="font-weight:600;">${p.user?.displayName || 'User'}</div>
              <div style="color:var(--secondary);font-size:14px;">${(p.content || '').slice(0, 80)}${(p.content || '').length > 80 ? '...' : ''}</div>
            </div>
          </div>`;
        }
        if (r.type === 'user') {
          const u = r.data;
          return `<div class="search-item" onclick="location.href='profile.html?id=${u.uid}'">
            <img src="${u.photoURL || 'https://via.placeholder.com/48'}" class="search-user-avatar">
            <div>
              <div style="font-weight:600;">${u.displayName || 'User'}</div>
              <div style="color:var(--secondary);">@${u.username || u.displayName.toLowerCase()}</div>
            </div>
          </div>`;
        }
        if (r.type === 'hashtag') {
          return `<div class="search-item" onclick="location.href='hashtag.html?q=${encodeURIComponent(r.data.tag)}'">
            <div style="width:48px;height:48px;background:var(--blue);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;">#</div>
            <div>
              <div style="font-weight:600;font-size:18px;">${r.data.tag}</div>
              <div style="color:var(--secondary);">Trending topic</div>
            </div>
          </div>`;
        }
      }).join('');
    };

    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => performSearch(searchInput.value), 300);
    });

    document.getElementById('post-text').addEventListener('input', e => {
      const len = e.target.value.length;
      document.getElementById('char-count').textContent = 280 - len;
      document.getElementById('char-count').style.color = len > 260 ? '#e11d48' : 'var(--secondary)';
    });

    document.getElementById('media-input').onchange = e => {
      mediaFile = e.target.files[0];
      if (!mediaFile) return;
      mediaType = mediaFile.type.startsWith('image') ? 'image' : 'video';
      const url = URL.createObjectURL(mediaFile);
      document.getElementById('media-preview').innerHTML = mediaType === 'image' 
        ? `<img src="${url}" style="max-height:400px;border-radius:12px;margin-top:12px;width:100%;object-fit:cover;">`
        : `<video src="${url}" controls style="max-height:500px;border-radius:12px;margin-top:12px;width:100%;"></video>`;
    };

    window.startVoiceRecord = () => {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        recorder = new MediaRecorder(stream);
        audioChunks = [];
        recorder.start();
        document.querySelector('.upload-sheet').classList.add('recording');
        document.getElementById('voice-btn').textContent = 'Stop';
        document.getElementById('voice-btn').onclick = () => recorder.stop();

        recorder.ondataavailable = e => audioChunks.push(e.data);
        recorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          mediaFile = audioBlob;
          mediaType = 'voice';
          mediaUrl = URL.createObjectURL(audioBlob);
          document.getElementById('voice-preview').style.display = 'block';
          document.getElementById('voice-preview').innerHTML = `<audio src="${mediaUrl}" controls></audio>`;
          document.querySelector('.upload-sheet').classList.remove('recording');
          document.getElementById('voice-btn').textContent = 'Voice';
          document.getElementById('voice-btn').onclick = startVoiceRecord;
        };
      }).catch(() => alert("Microphone access denied"));
    };

    window.uploadPost = async () => {
      const text = document.getElementById('post-text').value.trim();
      if (!text && !mediaFile) return alert("Add text or media");

      spinner.classList.add('active');
      const postRef = push(ref(db, 'statuses'));
      let uploadedUrl = '';

      if (mediaFile) {
        const ext = mediaType === 'voice' ? 'webm' : mediaFile.name.split('.').pop();
        const storageRef = sRef(storage, `posts/${postRef.key}.${ext}`);
        await uploadBytes(storageRef, mediaFile);
        uploadedUrl = await getDownloadURL(storageRef);
      }

      await set(postRef, {
        userId: currentUser.uid,
        user: { displayName: currentUser.displayName || "User", photoURL: currentUser.photoURL || "", verified: currentUserData.verified || false },
        content: text,
        mediaUrl: uploadedUrl,
        type: mediaType || 'text',
        timestamp: Date.now(),
        likes: 0,
        likedBy: {},
        reposts: 0,
        comments: 0
      });

      closeAll();
      document.getElementById('post-text').value = '';
      document.getElementById('char-count').textContent = '280';
      document.getElementById('media-preview').innerHTML = '';
      document.getElementById('voice-preview').style.display = 'none';
      mediaFile = null; mediaType = null; mediaUrl = null;
      spinner.classList.remove('active');
    };

    function renderPost(post) {
      if (document.querySelector(`[data-id="${post.id}"]`)) return;
      const container = currentTab === 'all' ? document.getElementById('all-feed') :
                       currentTab === 'images' && post.type === 'image' ? document.getElementById('images-feed') :
                       currentTab === 'text' && post.type === 'text' ? document.getElementById('text-feed') : null;
      if (!container) return;

      const el = document.createElement('div');
      el.className = 'status-post';
      el.dataset.id = post.id;

      const time = new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const isLiked = post.likedBy?.[currentUser.uid];

      let media = '';
      if (post.mediaUrl) {
        if (post.type === 'image') media = `<img src="${post.mediaUrl}" class="media" onclick="window.open(this.src)">`;
        if (post.type === 'video') media = `<video src="${post.mediaUrl}" controls class="media"></video>`;
        if (post.type === 'voice') media = `<audio src="${post.mediaUrl}" controls style="width:100%;margin:12px 0;"></audio>`;
      }

      el.innerHTML = `
        <div class="status-post-header" onclick="location.href='profile.html?id=${post.userId}'">
          <img src="${post.user.photoURL || 'https://via.placeholder.com/44'}" class="avatar">
          <div style="flex:1;">
            <div class="username">${post.user.displayName} ${post.user.verified ? 'Verified' : ''}</div>
            <div class="handle">@${(post.user.displayName || '').toLowerCase().replace(/\s/g,'')} Â· ${time}</div>
          </div>
        </div>
        <div class="content">${linkify(post.content || '')}</div>
        ${media}
        <div class="actions">
          <span class="action ${isLiked ? 'liked' : ''}" onclick="toggleLike(event, '${post.id}')">Heart ${post.likes || 0}</span>
          <span class="action" onclick="location.href='comments.html?id=${post.id}'">Comment ${post.comments || 0}</span>
          <span class="action" onclick="repost('${post.id}')">Repost ${post.reposts || 0}</span>
        </div>
      `;

      let pressTimer;
      el.onmousedown = el.ontouchstart = e => {
        pressTimer = setTimeout(() => {
          currentPostId = post.id;
          currentPostData = post;
          const menu = document.getElementById('longpress-menu');
          const rect = e.touches ? e.touches[0] : e;
          menu.style.left = rect.pageX + 'px';
          menu.style.top = rect.pageY - 120 + 'px';
          menu.classList.add('active');
          overlay.classList.add('active');
          navigator.vibrate?.(50);
        }, 600);
      };
      el.onmouseup = el.ontouchend = el.onmouseleave = () => clearTimeout(pressTimer);

      container.prepend(el);
    }

    window.toggleLike = async (e, id) => {
      e.stopPropagation();
      const postRef = ref(db, `statuses/${id}`);
      const snap = await get(postRef);
      const post = snap.val();
      const liked = post.likedBy?.[currentUser.uid];
      const updates = {};
      updates[`likedBy/${currentUser.uid}`] = !liked || null;
      updates['likes'] = (post.likes || 0) + (!liked ? 1 : -1);
      await update(postRef, updates);
      navigator.vibrate?.(30);
    };

    window.repost = async (id) => {
      await update(ref(db, `statuses/${id}/reposts`), (n || 0) + 1);
    };

    window.quoteRepost = (id) => {
      currentPostId = id;
      document.getElementById('post-text').value = `Quote from @user:\n\n`;
      openUpload();
    };

    window.editPost = async (id) => {
      const newText = prompt("Edit post:", currentPostData.content);
      if (newText && newText !== currentPostData.content) {
        await update(ref(db, `statuses/${id}`), { content: newText });
        closeAll();
      }
    };

    window.deletePost = async (id) => {
      if (confirm("Delete this post permanently?")) {
        await remove(ref(db, `statuses/${id}`));
        document.querySelector(`[data-id="${id}"]`)?.remove();
        closeAll();
      }
    };

    window.copyLink = (id) => {
      navigator.clipboard.writeText(`https://vynix.app/post/${id}`);
      alert("Link copied!");
      closeAll();
    };

    function linkify(text) {
      return text
        .replace(/(#[a-zA-Z0-9_]+)/g, '<a href="hashtag.html?q=$1" style="color:var(--blue)">$1</a>')
        .replace(/(@[a-zA-Z0-9_]+)/g, '<a href="profile.html?u=$1" style="color:var(--blue)">$1</a>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:var(--blue)">$1</a>');
    }

    async function loadMore(restart = false) {
      if (loading || !hasMore) return;
      loading = true;
      document.getElementById('feed-loader').style.display = 'block';

      let q = query(ref(db, 'statuses'), orderByChild('timestamp'), limitToLast(11));
      if (lastKey && !restart) q = query(ref(db, 'statuses'), orderByChild('timestamp'), startAfter(lastKey), limitToLast(10));

      const snap = await get(q);
      const posts = [];
      snap.forEach(child => posts.push({ id: child.key, ...child.val() }));
      posts.reverse();
      if (!restart && posts.length > 10) posts.shift();
      lastKey = posts[posts.length-1]?.timestamp || null;
      hasMore = posts.length >= 10;

      const container = currentTab === 'all' ? document.getElementById('all-feed') :
                       currentTab === 'images' ? document.getElementById('images-feed') :
                       document.getElementById('text-feed');
      if (restart) container.innerHTML = '';

      posts.forEach(p => renderPost(p));
      loading = false;
      document.getElementById('feed-loader').style.display = 'none';
    }

    onValue(ref(db, 'statuses'), snap => {
      const latest = Object.entries(snap.val() || {})
        .map(([id, data]) => ({ id, ...data }))
        .sort((a,b) => b.timestamp - a.timestamp)[0];
      if (latest) renderPost(latest);
    });

    document.querySelectorAll('.sub-tab-item').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.sub-tab-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.status-list').forEach(l => l.style.display = 'none');
        currentTab = btn.dataset.tab;
        document.getElementById(currentTab + '-feed').style.display = 'block';
        lastKey = null; hasMore = true;
        loadMore(true);
      };
    });

    new IntersectionObserver(entries => {
      if (entries[0].isIntersecting && hasMore && !loading) loadMore();
    }, { rootMargin: '400px' }).observe(document.getElementById('feed-loader'));

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const userSnap = await get(ref(db, `users/${user.uid}`));
        currentUserData = userSnap.val() || {};
        loadMore(true);
      } else location.href = 'login.html';
    });

    window.toggleTheme = () => document.body.classList.toggle('light');
  </script>
</body>
</html>
