<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Vynix – Full Social Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"/>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0="/>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #ffffff; --card: #ffffff; --text: #0f1419; --text2: #536471;
      --border: #eff3f4; --accent: #ff2a6d; --hover-accent: rgba(255, 42, 109, 0.1);
    }
    [data-theme="dark"] {
      --bg: #000000; --card: #000000; --text: #e7e9ea; --text2: #71767b;
      --border: #2f3336;
    }
    * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    input, textarea { -webkit-user-select: auto; user-select: auto; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); overflow-y: scroll; }
    /* ---------- desktop 3-col grid ---------- */
    .desktop-grid { display: grid; grid-template-columns: 260px 1fr 350px; max-width: 1265px; margin: 0 auto; min-height: 100vh; }
    @media (max-width: 1023px) { .desktop-grid { grid-template-columns: 1fr; } }
    /* ---------- left rail ---------- */
    .left-rail { position: sticky; top: 0; height: 100vh; padding: 12px 0; display: flex; flex-direction: column; justify-content: space-between; }
    .left-rail a { display: flex; align-items: center; gap: 16px; padding: 12px 16px; border-radius: 9999px; font-size: 20px; font-weight: 400; color: var(--text); transition: background .2s; }
    .left-rail a:hover { background: var(--hover-accent); }
    .left-rail a.active { color: var(--accent); font-weight: 700; }
    .left-rail .logo { width: 52px; height: 52px; display: grid; place-items: center; border-radius: 50%; }
    .left-rail .logo:hover { background: var(--hover-accent); }
    .left-rail .post-btn { width: 90%; margin: 16px auto 0; }
    .left-rail .account-box { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 9999px; cursor: pointer; margin-top: auto; }
    .left-rail .account-box:hover { background: var(--hover-accent); }
    /* ---------- center ---------- */
    .center { border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
    .top-bar { position: sticky; top: 0; z-index: 30; backdrop-filter: blur(12px); background: rgba(255,255,255,.85); }
    [data-theme="dark"] .top-bar { background: rgba(0,0,0,.85); }
    .composer { display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--border); }
    .composer img.avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea { flex: 1; resize: none; background: transparent; color: var(--text); border: none; outline: none; font-size: 20px; padding-top: 10px; min-height: 60px; }
    .media-preview { width: 100%; border-radius: 16px; margin-top: 12px; border: 1px solid var(--border); }
    .composer-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
    .icon-btn { background: none; border: none; color: var(--accent); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--hover-accent); }
    .post-btn { background: var(--accent); color: #fff; border: none; border-radius: 999px; padding: 10px 24px; font-weight: 700; font-size: 15px; cursor: pointer; transition: opacity 0.2s; }
    .post-btn:disabled { opacity: 0.5; cursor: default; }
    .feed { padding-bottom: 40px; }
    .post-card { border-bottom: 1px solid var(--border); padding: 16px; cursor: pointer; transition: background 0.2s; }
    .post-card:hover { background: rgba(0,0,0,0.03); }
    [data-theme="dark"] .post-card:hover { background: rgba(255,255,255,0.03); }
    .post-header { display: flex; gap: 12px; align-items: flex-start; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .user-meta { display: flex; gap: 4px; align-items: center; font-size: 15px; }
    .name { font-weight: 700; color: var(--text); }
    .verified-badge { color: var(--accent); font-size: 16px !important; margin-left: 2px; }
    .handle, .time { color: var(--text2); font-weight: 400; }
    .post-content { margin-top: 4px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; margin-left: 52px; }
    .post-image { border-radius: 16px; margin-top: 12px; max-width: 100%; max-height: 400px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.2s; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; pointer-events: auto; }
    .post-image:hover { opacity: 0.9; }
    .post-video { border-radius: 16px; margin-top: 12px; max-width: 100%; max-height: 400px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.2s; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    .post-video:hover { opacity: 0.9; }
    .post-actions { display: flex; justify-content: space-between; margin-top: 12px; margin-left: 52px; max-width: 400px; color: var(--text2); }
    .action-item { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .action-item .material-icons-outlined { font-size: 18px; padding: 8px; border-radius: 50%; transition: 0.2s; }
    .action-item:hover.reply { color: #1d9bf0; }
    .action-item:hover.repost { color: #00ba7c; }
    .action-item:hover.like { color: #f91880; }
    .delete-btn:hover { color: #f4212e; }
    /* ---------- right rail ---------- */
    .right-rail { position: sticky; top: 0; height: 100vh; padding: 12px 0; overflow-y: auto; }
    .search-box { background: var(--hover-accent); border-radius: 9999px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .search-box input { background: transparent; border: none; outline: none; flex: 1; color: var(--text); }
    .trends-card, .follow-card { background: var(--hover-accent); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .trends-card h2, .follow-card h2 { font-size: 20px; font-weight: 700; margin-bottom: 12px; }
    .trend-item { padding: 8px 0; cursor: pointer; }
    .trend-item:hover { background: rgba(0,0,0,.05); }
    [data-theme="dark"] .trend-item:hover { background: rgba(255,255,255,.05); }
    .follow-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
    .follow-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .follow-item button { margin-left: auto; background: var(--accent); color: #fff; border: none; border-radius: 999px; padding: 6px 16px; font-weight: 600; font-size: 14px; cursor: pointer; }
    /* ---------- mobile bottom nav ---------- */
    nav.mobile-nav { display: none; }
    @media (max-width: 1023px) {
      nav.mobile-nav { display: block; position: fixed; bottom: 0; left: 0; right: 0; height: 64px; background: var(--bg); border-top: 1px solid var(--border); z-index: 40; }
      nav.mobile-nav > div { height: 100%; display: flex; align-items: center; justify-content: around; }
      nav.mobile-nav a { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; color: var(--text2); }
      nav.mobile-nav a.active { color: var(--accent); }
      main, .feed, .composer { padding-bottom: 80px !important; }
    }
    /* ---------- skeleton / toast / modal etc ---------- */
    .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.3) 50%, var(--border) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    [data-theme="dark"] .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.05) 50%, var(--border) 75%); background-size: 200% 100%; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .custom-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: white; padding: 12px 24px; border-radius: 99px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); font-weight: 600; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50; }
    .custom-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    #image-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 150; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
    #image-modal.show { display: flex !important; }
    #modal-image, #modal-video { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- PWA install banner -->
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#ff2a6d] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix for a better experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="bg-white text-[#ff2a6d] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-icons text-xl">close</span>
      </button>
    </div>
  </div>

  <div class="desktop-grid">
    <!-- LEFT RAIL -->
    <aside class="left-rail">
      <div>
        <a class="logo" href="/" title="Home">
          <img src="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png" class="w-8 h-8" alt="logo"/>
        </a>
        <nav class="flex flex-col mt-4">
          <a href="index.html" class="active"><span class="material-icons">home</span><span>Home</span></a>
          <a href="search.html"><span class="material-icons-outlined">search</span><span>Explore</span></a>
          <a href="notifications.html"><span class="material-icons-outlined">notifications</span><span>Notifications</span></a>
          <a href="chat.html"><span class="material-icons-outlined">mail_outline</span><span>Messages</span></a>
          <a href="bookmarks.html"><span class="material-icons-outlined">bookmark_border</span><span>Bookmarks</span></a>
          <a href="profile.html"><span class="material-icons-outlined">person</span><span>Profile</span></a>
        </nav>
        <button id="left-post-btn" class="post-btn">Post</button>
      </div>
      <div class="account-box">
        <img id="my-avatar-mini" class="w-10 h-10 rounded-full object-cover" src="https://ui-avatars.com/api/?background=random&color=fff" alt="avatar"/>
        <div class="flex-1">
          <div class="name font-bold">Loading…</div>
          <div class="handle text-sm text-gray-500">@handle</div>
        </div>
        <span class="material-icons-outlined">more_horiz</span>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div class="top-bar px-4 py-3 border-b border-[var(--border)]">
        <h1 class="text-xl font-bold">Home</h1>
      </div>
      <div class="composer">
        <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=random&color=fff" alt="avatar"/>
        <div class="flex-1">
          <textarea id="post-text" placeholder="What is happening?!"></textarea>
          <video id="media-preview-video" class="media-preview hidden" controls muted loop playsinline></video>
          <img id="media-preview-img" class="media-preview hidden" alt=""/>
          <div class="composer-actions">
            <div>
              <input type="file" id="file-input" accept="image/*,video/*" class="hidden"/>
              <label for="file-input" class="icon-btn" title="Add Photo / Video">
                <span class="material-icons-outlined">image</span>
              </label>
            </div>
            <button id="post-btn" class="post-btn" disabled>
              <span id="btn-text">Post</span>
              <span id="btn-spinner" class="spinner hidden"></span>
            </button>
          </div>
        </div>
      </div>
      <div id="feed" class="feed"></div>
      <div class="text-center p-4">
        <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
      </div>
    </main>

    <!-- RIGHT RAIL -->
    <aside class="right-rail px-4">
      <div class="search-box">
        <span class="material-icons-outlined text-[var(--text2)]">search</span>
        <input type="text" placeholder="Search Vynix"/>
      </div>
      <div class="trends-card">
        <h2>Trends for you</h2>
        <div class="trend-item">
          <div class="text-sm text-[var(--text2)]">Trending</div>
          <div class="font-bold">#VynixLaunch</div>
          <div class="text-sm text-[var(--text2)]">12.8 K posts</div>
        </div>
        <div class="trend-item">
          <div class="text-sm text-[var(--text2)]">Technology</div>
          <div class="font-bold">#WebDev</div>
          <div class="text-sm text-[var(--text2)]">8.4 K posts</div>
        </div>
        <div class="trend-item">
          <div class="text-sm text-[var(--text2)]">Sports</div>
          <div class="font-bold">#NBAFinals</div>
          <div class="text-sm text-[var(--text2)]">6.2 K posts</div>
        </div>
        <div class="trend-item">
          <div class="text-sm text-[var(--text2)]">Music</div>
          <div class="font-bold">#NewAlbum</div>
          <div class="text-sm text-[var(--text2)]">4.1 K posts</div>
        </div>
      </div>
      <div class="follow-card">
        <h2>Who to follow</h2>
        <div class="follow-item">
          <img src="https://i.pravatar.cc/40?u=a" alt="avatar"/>
          <div class="flex-1">
            <div class="font-bold">Alexa</div>
            <div class="text-sm text-[var(--text2)]">@alexa</div>
          </div>
          <button>Follow</button>
        </div>
        <div class="follow-item">
          <img src="https://i.pravatar.cc/40?u=b" alt="avatar"/>
          <div class="flex-1">
            <div class="font-bold">Ben</div>
            <div class="text-sm text-[var(--text2)]">@ben</div>
          </div>
          <button>Follow</button>
        </div>
        <div class="follow-item">
          <img src="https://i.pravatar.cc/40?u=c" alt="avatar"/>
          <div class="flex-1">
            <div class="font-bold">Cara</div>
            <div class="text-sm text-[var(--text2)]">@cara</div>
          </div>
          <button>Follow</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Mobile bottom nav -->
  <nav class="mobile-nav">
    <div>
      <a href="index.html" class="active"><span class="material-icons">home</span><span>Home</span></a>
      <a href="search.html"><span class="material-icons-outlined">search</span><span>Search</span></a>
      <a href="chat.html"><span class="material-icons-outlined">chat_bubble_outline</span><span>Chat</span></a>
      <a href="notifications.html"><span class="material-icons-outlined">notifications</span><span>Alerts</span></a>
      <a href="profile.html"><span class="material-icons-outlined">person</span><span>Profile</span></a>
    </div>
  </nav>

  <!-- Modals / sheets (unchanged) -->
  <div id="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
      <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
      <div class="custom-alert-buttons">
        <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
        <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
      </div>
    </div>
  </div>
  <div id="comment-sheet-overlay">
    <div class="comment-sheet">
      <div class="comment-sheet-header">
        <span>Comments</span>
        <button class="comment-sheet-close material-icons-outlined" id="comment-sheet-close">close</button>
      </div>
      <div class="comment-sheet-list" id="comment-sheet-list"></div>
      <div class="comment-input-box">
        <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
        <button class="comment-send-btn" id="comment-send-btn">
          <span class="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  </div>
  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <video id="modal-video" loop>
      <source src="" type="video/mp4">
    </video>
    <div class="video-controls" id="video-controls" style="display: none;">
      <button id="play-pause-btn"><span class="material-icons-outlined">play_arrow</span></button>
      <span class="video-time" id="video-time">0:00 / 0:00</span>
      <div class="video-progress" id="video-progress"><div class="video-progress-bar" id="video-progress-bar"></div></div>
      <button id="mute-btn"><span class="material-icons-outlined">volume_up</span></button>
    </div>
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>

  <!-- Firebase + App logic (same as you had) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let uid, uname, uavatar;
    const $ = s => document.querySelector(s);
    const postBtn = $('#post-btn'), textEl = $('#post-text'),
          previewImg = $('#media-preview-img'), previewVid = $('#media-preview-video'),
          fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
          loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 50;
    let lastTimestamp = null, lastKey = null, initialLoadDone = false;
    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
      document.body.setAttribute('data-theme', 'dark');
    onAuthStateChanged(auth, user => {
      if (!user) {
        signInAnonymously(auth);
        uid = "guest_" + Math.random().toString(36).slice(2);
        uname = "Guest";
      } else {
        uid = user.uid;
        uname = user.displayName || user.email?.split('@')[0] || 'User';
      }
      uavatar = user?.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
      myAvatarEl.src = uavatar;
      $('#my-avatar-mini').src = uavatar;
      $('.left-rail .name').textContent = uname;
      $('.left-rail .handle').textContent = '@' + uname.replace(/\s/g,'').toLowerCase();
      initFeed();
    });
    function showSkeletonLoaders(count = 5) {
      feedEl.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'post-card';
        skeleton.innerHTML = `
          <div class="post-header">
            <div class="skeleton skeleton-avatar w-10 h-10 rounded-full"></div>
            <div class="flex-1">
              <div class="skeleton skeleton-line w-1/3 mb-2"></div>
              <div class="skeleton skeleton-text w-11/12"></div>
              <div class="skeleton skeleton-text w-3/4"></div>
            </div>
          </div>`;
        feedEl.appendChild(skeleton);
      }
    }
    async function initFeed() {
      showSkeletonLoaders(5);
      try {
        const postsRef = ref(db, 'posts');
        const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
        const snap = await get(q);
        feedEl.innerHTML = '';
        const rows = [];
        snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
        rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
        const last = rows[rows.length-1];
        if (last) { lastTimestamp = last.timestamp; lastKey = last.key; }
        loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
        initialLoadDone = true;
        listenNew();
      } catch (e) {
        feedEl.innerHTML = ''; toast('Error loading posts');
      }
    }
    function listenNew() {
      const postsRef = ref(db, 'posts');
      onChildAdded(postsRef, snap => {
        if (!initialLoadDone) return;
        const data = snap.val();
        if (!data || !data.timestamp) return;
        if (!lastTimestamp || data.timestamp > lastTimestamp) {
          feedEl.prepend(renderPostCard({key: snap.key, ...data}));
          lastTimestamp = data.timestamp;
        }
      });
    }
    loadMoreBtn.onclick = async () => {
      loadMoreBtn.disabled = true; loadMoreBtn.textContent = 'Loading...';
      const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT+1));
      const snap = await get(q);
      const rows = []; snap.forEach(c => rows.push({key: c.key, ...c.val()}));
      const uniq = rows.filter(p => p.key !== lastKey);
      if (!uniq.length) { toast('No more posts'); loadMoreBtn.classList.add('hidden'); return; }
      uniq.reverse().forEach(p => feedEl.appendChild(renderPostCard(p)));
      const last = uniq[uniq.length-1]; lastTimestamp = last.timestamp; lastKey = last.key;
      if (uniq.length < POST_LIMIT) loadMoreBtn.classList.add('hidden');
      loadMoreBtn.disabled = false; loadMoreBtn.textContent = 'Load More Posts';
    };
    let mediaUrl = '', uploading = false;
    function toggleBtn() { postBtn.disabled = uploading || (!textEl.value.trim() && !mediaUrl); }
    fileInput.onchange = e => {
      const file = e.target.files[0]; if (!file) return;
      const isVideo = file.type.startsWith('video/'), isImage = file.type.startsWith('image/');
      if (!isVideo && !isImage) { toast('Only images or videos'); return; }
      const r = new FileReader();
      r.onload = ev => {
        if (isVideo) { previewVid.src = ev.target.result; previewVid.classList.remove('hidden'); previewImg.classList.add('hidden'); }
        else { previewImg.src = ev.target.result; previewImg.classList.remove('hidden'); previewVid.classList.add('hidden'); }
      };
      r.readAsDataURL(file);
      uploadToCloudinary(file);
    };
    function uploadToCloudinary(file) {
      const CLOUD_NAME = "dqkujefxj", UPLOAD_PRESET = "banter_box";
      uploading = true; toggleBtn();
      $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
      const fd = new FormData();
      fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
      fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
        .then(r => r.json()).then(res => { mediaUrl = res.secure_url; toast('Media uploaded'); })
        .catch(err => { toast('Upload failed'); mediaUrl = ''; previewImg.classList.add('hidden'); previewVid.classList.add('hidden'); })
        .finally(() => { uploading = false; $('#btn-spinner').classList.add('hidden'); $('#btn-text').classList.remove('hidden'); toggleBtn(); });
    }
    postBtn.onclick = async () => {
      const text = textEl.value.trim(); if (!text && !mediaUrl) return;
      postBtn.disabled = true; $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
      const newRef = push(ref(db, 'posts'));
      const postData = { authorId: uid, authorName: uname, authorAvatar: uavatar, text, image: mediaUrl, verified: false, likes: 0, replies: 0, reposts: 0, timestamp: serverTimestamp() };
      try {
        await set(newRef, postData);
        textEl.value = ''; mediaUrl = ''; previewImg.classList.add('hidden'); previewVid.classList.add('hidden'); toggleBtn(); toast('Posted!');
      } catch (err) { toast('Error posting'); }
      finally { $('#btn-spinner').classList.add('hidden'); $('#btn-text').classList.remove('hidden'); postBtn.disabled = false; }
    };
    textEl.oninput = () => { textEl.style.height = 'auto'; textEl.style.height = textEl.scrollHeight + 'px'; toggleBtn(); };
    $('#left-post-btn').onclick = () => { textEl.focus(); };
    /* ---------- render post card ---------- */
    const userMetaCache = new Map();
    function listenUserMeta(uid, card) {
      if (userMetaCache.has(uid)) return applyUserMeta(card, userMetaCache.get(uid));
      const unsub = onValue(ref(db, `users/${uid}/profile`), snap => {
        const v = snap.val() || {};
        const meta = { name: v.displayName || 'User', avatar: v.avatar || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${v.displayName || 'User'}`, verified: !!v.verified };
        userMetaCache.set(uid, meta); applyUserMeta(card, meta);
      });
      card._unsubUser = unsub;
    }
    function applyUserMeta(card, meta) {
      card.querySelector('.name').textContent = esc(meta.name);
      card.querySelector('.handle').textContent = `@${meta.name.replace(/\s/g, '').toLowerCase()}`;
      card.querySelector('.post-avatar').src = meta.avatar;
      const badge = card.querySelector('.verified-badge');
      badge.style.display = meta.verified ? 'inline' : 'none';
    }
    function renderPostCard(p) {
      const isMine = p.authorId === uid;
      const div = document.createElement('div'); div.id = `post-${p.key}`; div.className = 'post-card';
      div.innerHTML = `
        <div class="post-header">
          <img src="${p.authorAvatar}" class="post-avatar">
          <div class="flex-1">
            <div class="user-meta">
              <span class="name">${esc(p.authorName)}</span>
              <span class="verified-badge material-icons text-sm" style="display:none">verified</span>
              <span class="handle">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
            </div>
            <div class="post-content">${esc(p.text)}</div>
            ${p.image ? (p.image.includes('/video/upload') || p.image.endsWith('.mp4') ? `
              <video class="post-video" muted loop playsinline data-video-url="${p.image}"><source src="${p.image}" type="video/mp4"></video>` :
              `<img class="post-image" src="${p.image}" loading="lazy">`) : ''}
            <div class="post-actions">
              <div class="action-item reply" data-post="${p.key}" data-action="reply"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg><span id="replies-${p.key}">${p.replies||0}</span></div>
              <div class="action-item repost" data-post="${p.key}" data-action="repost"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 2l4 4-4 4M3 11v-1a4 4 0 0 1 4-4h14M7 22l-4-4 4-4M21 13v1a4 4 0 0 1-4 4H3"/></svg><span id="reposts-${p.key}">${p.reposts||0}</span></div>
              <div class="action-item like" data-post="${p.key}" data-action="like"><svg class="outline-heart" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><svg class="filled-heart hidden" width="24" height="24" fill="#f91880" stroke="#f91880" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span id="likes-${p.key}">${p.likes||0}</span></div>
              <div class="action-item share" data-post="${p.key}" data-action="share"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div>
              ${isMine ? `<div class="action-item delete-btn" data-post="${p.key}" data-action="delete"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></div>` : ''}
            </div>
          </div>
        </div>`;
      div.addEventListener('click', e => {
        if (e.target.classList.contains('post-image')) { openImageModal(e.target.src); return; }
        if (e.target.classList.contains('post-video')) { openVideoModal(e.target.dataset.videoUrl); return; }
        const action = e.target.closest('[data-action]')?.dataset.action, postId = e.target.closest('[data-post]')?.dataset.post;
        if (!action || !postId) return; e.stopPropagation();
        if (action === 'reply') openComments(postId);
        if (action === 'repost') doRepost(postId);
        if (action === 'like') toggleLike(postId);
        if (action === 'share') navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
        if (action === 'delete') confirmDelete(postId);
      });
      listenCounters(p.key); listenUserMeta(p.authorId, div); return div;
    }
    function listenCounters(postId) {
      onValue(ref(db, `likes/${postId}`), s => { $('#likes-'+postId).textContent = s.size; const ic = document.querySelector(`[data-post="${postId}"].like`); if (ic) ic.classList.toggle('liked', s.hasChild(uid)); });
      onValue(ref(db, `comments/${postId}`), s => $('#replies-'+postId).textContent = s.size);
      onValue(ref(db, `reposts/${postId}`), s => $('#reposts-'+postId).textContent = s.size);
    }
    async function toggleLike(postId) { const likeRef = ref(db, `likes/${postId}/${uid}`), snap = await get(likeRef); if (snap.exists()) await remove(likeRef); else await set(likeRef, true); }
    async function doRepost(postId) {
      const orig = (await get(ref(db, `posts/${postId}`))).val(); if (!orig) return;
      const newRef = push(ref(db, 'posts'));
      await set(newRef, { authorId: uid, authorName: uname, authorAvatar: uavatar, text: orig.text, image: orig.image, verified: false, repostOf: {authorName: orig.authorName, key: postId}, likes: 0, replies: 0, reposts: 0, timestamp: Date.now() });
      toast('Re-posted');
    }
    /* ---------- comments sheet ---------- */
    let currentPostId = null, commentsListener = null;
    const commentOverlay = $('#comment-sheet-overlay'), commentList = $('#comment-sheet-list'), commentInput = $('#comment-input'), commentSendBtn = $('#comment-send-btn');
    function openComments(postId) {
      currentPostId = postId; commentInput.value = ''; delete commentInput.dataset.parent; commentInput.placeholder = 'Write a comment...'; commentList.innerHTML = '<div class="skeleton-post"><div class="flex gap-3"><div class="skeleton skeleton-avatar w-8 h-8 rounded-full"></div><div class="flex-1"><div class="skeleton skeleton-line w-1/2 mb-2"></div><div class="skeleton skeleton-text w-3/4"></div></div></div></div>'.repeat(3);
      commentOverlay.classList.add('show');
      if (commentsListener) commentsListener();
      commentsListener = onValue(ref(db, `comments/${postId}`), snap => {
        commentList.innerHTML = '';
        if (!snap.exists()) { commentList.innerHTML = '<div class="p-4 text-sm text-gray-500">No comments yet</div>'; return; }
        snap.forEach(c => {
          const v = c.val(), cid = c.key, isMine = v.authorId === uid;
          const d = document.createElement('div'); d.className = 'flex gap-3 py-3 border-b border-[var(--border)]';
          d.innerHTML = `<img src="${v.authorAvatar}" class="w-8 h-8 rounded-full object-cover"><div class="flex-1"><div class="font-bold text-sm">${esc(v.authorName)}</div><div class="text-sm">${esc(v.text)}</div><div class="flex items-center gap-3 mt-2 text-xs text-[var(--text2)]"><button class="comment-like-btn flex items-center gap-1" data-post="${postId}" data-cid="${cid}"><svg class="outline-heart w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><svg class="filled-heart hidden w-4 h-4" fill="#f91880" stroke="#f91880" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span class="comment-like-count">0</span></button>${isMine ? `<button class="comment-delete-btn text-red-500 text-xs" data-post="${postId}" data-cid="${cid}">Delete</button>` : ''}</div></div>`;
          commentList.appendChild(d); listenCommentLikes(postId, cid);
        });
      });
    }
    $('#comment-sheet-close').onclick = closeComments; commentOverlay.onclick = e => { if (e.target === commentOverlay) closeComments(); };
    function closeComments() { commentOverlay.classList.remove('show'); if (commentsListener) { commentsListener(); commentsListener = null; } currentPostId = null; }
    commentSendBtn.onclick = async () => {
      const text = commentInput.value.trim(); if (!text || !currentPostId) return;
      await set(push(ref(db, `comments/${currentPostId}`)), { authorId: uid, authorName: uname, authorAvatar: uavatar, text, timestamp: Date.now() });
      commentInput.value = ''; toast('Comment posted');
    };
    commentInput.oninput = () => commentSendBtn.disabled = !commentInput.value.trim();
    function listenCommentLikes(pid, cid) {
      const likeRef = ref(db, `comments/${pid}/${cid}/likes`);
      onValue(likeRef, snap => {
        const cnt = snap.size, liked = snap.hasChild(uid);
        const btn = document.querySelector(`.comment-like-btn[data-cid="${cid}"]`);
        if (!btn) return;
        btn.querySelector('.comment-like-count').textContent = cnt || '';
        btn.classList.toggle('liked', liked);
      });
    }
    commentList.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const pid = btn.dataset.post, cid = btn.dataset.cid;
      if (btn.classList.contains('comment-like-btn')) toggleCommentLike(pid, cid);
      if (btn.classList.contains('comment-delete-btn')) { remove(ref(db, `comments/${pid}/${cid}`)); toast('Comment deleted'); }
    });
    async function toggleCommentLike(pid, cid) { const likeRef = ref(db, `comments/${pid}/${cid}/likes/${uid}`), snap = await get(likeRef); if (snap.exists()) await remove(likeRef); else await set(likeRef, true); }
    /* ---------- delete confirm ---------- */
    let deleteKeyStore = null;
    const alertOverlay = $('#custom-alert-overlay'), alertCancel = $('#custom-alert-cancel'), alertConfirm = $('#custom-alert-confirm');
    function confirmDelete(key) { deleteKeyStore = key; alertOverlay.classList.add('show'); }
    alertCancel.onclick = () => { deleteKeyStore = null; alertOverlay.classList.remove('show'); };
    alertConfirm.onclick = async () => {
      if (!deleteKeyStore) return; const key = deleteKeyStore; deleteKeyStore = null; alertOverlay.classList.remove('show');
      try { await remove(ref(db, `posts/${key}`)); const postElement = document.getElementById(`post-${key}`); if (postElement) { postElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease'; postElement.style.opacity = '0'; postElement.style.transform = 'translateY(-10px)'; setTimeout(() => postElement.remove(), 320); } toast('Deleted'); } catch { toast('Error deleting'); }
    };
    /* ---------- media modal ---------- */
    window.openImageModal = src => { const modal = $('#image-modal'), img = $('#modal-image'), video = $('#modal-video'); img.src = src; img.style.display = 'block'; video.style.display = 'none'; modal.classList.add('show'); };
    window.openVideoModal = src => { const modal = $('#image-modal'), img = $('#modal-image'), video = $('#modal-video'), controls = $('#video-controls'); img.style.display = 'none'; video.querySelector('source').src = src; video.load(); video.style.display = 'block'; controls.style.display = 'flex'; modal.classList.add('show'); initVideoControls(); };
    window.closeImageModal = () => { const modal = $('#image-modal'), video = $('#modal-video'); video.pause(); video.currentTime = 0; modal.classList.remove('show'); };
    function initVideoControls() { const video = $('#modal-video'), playBtn = $('#play-pause-btn'), muteBtn = $('#mute-btn'), progressBar = $('#video-progress-bar'), timeEl = $('#video-time'); playBtn.onclick = () => { if (video.paused) { video.play(); playBtn.innerHTML = '<span class="material-icons-outlined">pause</span>'; } else { video.pause(); playBtn.innerHTML = '<span class="material-icons-outlined">play_arrow</span>'; } }; muteBtn.onclick = () => { video.muted = !video.muted; muteBtn.innerHTML = video.muted ? '<span class="material-icons-outlined">volume_off</span>' : '<span class="material-icons-outlined">volume_up</span>'; }; video.ontimeupdate = () => { const pct = (video.currentTime / video.duration) * 100; progressBar.style.width = pct + '%'; timeEl.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`; }; $('#video-progress').onclick = e => { const rect = e.currentTarget.getBoundingClientRect(); video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration; }; video.play(); playBtn.innerHTML = '<span class="material-icons-outlined">pause</span>'; }
    function formatTime(s) { if (isNaN(s)) return '0:00'; const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec.toString().padStart(2,'0')}`; }
    $('#image-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeImageModal(); });
    /* ---------- toast ---------- */
    function toast(msg) { const t = document.createElement('div'); t.className = 'custom-toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000); }
    const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
    const timeAgo = ts => { if (!ts) return 'now'; const s = Math.floor((Date.now() - ts) / 1000); return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`; };
  </script>
  <script>
    /* ---------- mobile nav highlight ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      const current = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('nav.mobile-nav a').forEach(a => {
        if (a.getAttribute('href') === current) { a.classList.add('active'); const icon = a.querySelector('span:first-child'); if (icon) icon.classList.replace('material-icons-outlined', 'material-icons'); }
      });
    });
    /* ---------- PWA install ---------- */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; document.getElementById('pwa-install-banner').classList.remove('-translate-y-full'); });
    document.getElementById('pwa-install-btn')?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; document.getElementById('pwa-install-banner').classList.add('-translate-y-full'); });
    document.getElementById('pwa-install-close')?.addEventListener('click', () => document.getElementById('pwa-install-banner').classList.add('-translate-y-full'));
  </script>
</body>
</html>
