<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#ff2a6d">
  <meta name="description"description" content="Vynix - Connect with friends">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP25hbWU9VnluaXgmYmFja2dyb3VuZD1mZjJhNmQmY29sb3I9ZmZmJnNpemU9MTkyIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP25hbWU9VnluaXgmYmFja2dyb3VuZD1mZjJhNmQmY29sb3I9ZmZmJnNpemU9NTEyIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* === ALL YOUR ORIGINAL STYLES (100% unchanged) === */
    :root {
      --bg: #ffffff;
      --card: #f7f9fa;
      --text: #0f1419;
      --text2: #536471;
      --border: #e1e8ed;
      --accent: #ff2a6d;
      --glow: 0 0 10px rgba(255, 42, 109, .35);
      --status-bg: #128c7e;
      --online-dot: #22c55e;
      --offline-dot: #9ca3af;
    }
    [data-theme="dark"] {
      --bg: #0f1419;
      --card: #1a1f25;
      --text: #ffffff;
      --text2: #8b98a5;
      --border: #2f3336;
      --accent: #ff2a6d;
      --glow: 0 0 10px rgba(255, 42, 109, .35);
      --status-bg: #128c7e;
      --online-dot: #22c55e;
      --offline-dot: #4b5563;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
      transition: background-color 0.3s ease;
    }
    #header h1 {
        font-weight: 800;
        font-size: 22px;
        letter-spacing: -1px;
        background: linear-gradient(90deg, var(--accent), #05d9e8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .main {
      padding: 64px 16px 80px;
    }
    .tab {
      display: none;
    }
    .tab.active {
      display: block;
    }
    .search {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card);
      color: var(--text;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    .search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--glow);
    }
    .card, .trivia-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .trivia-card {
      border-color: var(--accent);
      box-shadow: var(--glow);
      cursor: pointer;
    }
    .avatar-wrapper {
      position: relative;
      flex-shrink: 0;
    }
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      background: #05d9e8;
      transition: transform 0.2s ease;
    }
    .avatar:hover {
      transform: scale(1.05);
    }
    .status-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: var(--online-dot);
      border-radius: 50%;
      border: 2px solid var(--bg);
      display: none;
      animation: pulse 2s infinite;
    }
    .status-dot.offline {
      background: var(--offline-dot);
      animation: none;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    .name {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .verified-badge {
      color: var(--accent);
      font-size: 18px !important;
      vertical-align: middle;
      margin-left: 4px;
    }
    .preview {
      font-size: 14px;
      color: var(--text2);
      margin-top: 2px;
    }
    .preview-time {
      font-size: 12px;
      color: var(--text2);
      margin-top: 2px;
    }
    .unread {
      background: var(--accent);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: auto;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--card);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      transition: background-color 0.3s ease;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      color: var(--text2);
      transition: .2s;
      position: relative;
      cursor: pointer;
    }
    .nav-item.active {
      color: var(--accent);
      text-shadow: var(--glow);
    }
    .nav-item .material-icons {
      font-size: 24px;
      margin-bottom: 2px;
      transition: transform 0.2s ease;
    }
    .nav-item:hover .material-icons {
      transform: scale(1.1);
    }
    .nav-item a {
      color: inherit;
      text-decoration: none;
    }
    .nav-badge {
      position: absolute;
      top: 2px;
      right: 8px;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
      display: none;
    }
    .nav-badge.show {
      display: block;
    }
    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      box-shadow: var(--glow);
      display: grid;
      place-items: center;
      z-index: 20;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 42, 109, 0.4);
    }
    .alert {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 1000;
    }
    .alert.show {
      display: block;
      animation: fade .3s;
    }
    @keyframes fade {
        from { opacity: 0; transform: translate(-50%, -10px); }
        to { opacity: 1; transform: translate(-50%, 0); }
    }
    /* bottom-sheet */
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0;
      background: var(--card);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      overflow: hidden;
      transition: height .3s;
      z-index: 100;
    }
    .bottom-sheet.open {
      height: 75vh;
    }
    .sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .sheet-content {
      padding: 16px 20px;
      height: calc(75vh - 60px);
      overflow-y: auto;
    }
    .settings-section {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .settings-item:last-child {
      border-bottom: none;
    }
    .settings-label {
      font-weight: 600;
      font-size: 16px;
    }
    .settings-description {
      font-size: 14px;
      color: var(--text2);
      margin-top: 2px;
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: var(--border);
      border-radius: 999px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .toggle-switch.active {
      background: var(--accent);
    }
    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }
    .toggle-switch.active .toggle-slider {
      transform: translateX(22px);
    }
    .theme-preview {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .theme-option {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    .theme-option.selected {
      border-color: var(--accent);
      box-shadow: var(--glow);
    }
    .theme-light {background: linear-gradient(135deg, #ffffff 50%, #f7f9fa 50%);}
    .theme-dark {background: linear-gradient(135deg, #0f1419 50%, #1a1f25 50%);}
    .theme-auto {background: linear-gradient(135deg, #ffffff 25%, #0f1419 25%, #0f1419 75%, #ffffff 75%);}
    .logout-btn {
      width: 100%;
      padding: 14px;
      border-radius: 999px;
      background: #ef4444;
      color: white;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .logout-btn:hover {
      background: #dc2626;
      transform: scale(1.02);
    }
    .pill-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      transition: .2s;
      cursor: pointer;
    }
    .pill-btn.primary {
      background: var(--accent);
      color: #fff;
      box-shadow: var(--glow);
    }
    .pill-btn.secondary {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
    }
    .pill-btn:hover {
      transform: scale(1.02);
    }

    /* NEW: Permanent Posts Feed Styles (added) */
    .post-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    .post-header {
      padding: 12px 16px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .post-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }
    .post-name {
      font-weight: 600;
      font-size: 15px;
    }
    .post-time {
      font-size: 13px;
      color: var(--text2);
    }
    .post-text {
      padding: 0 16px 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .post-media {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      background: #000;
    }
    .post-actions {
      display: flex;
      justify-content: space-around;
      padding: 8px 16px 12px;
      border-top: 1px solid var(--border);
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text2);
      transition: background 0.2s;
    }
    .action-btn:hover { background: var(--border); }
    .action-btn.liked { color: #ff2a6d; }
    .action-btn.reposted { color: #10b981; }
  </style>
</head>
<body>
  <!-- ALL YOUR ORIGINAL HTML (unchanged) -->
  <div id="pwa-install-banner" class="pwa-install-banner">...</div>
  <div id="offline-indicator" class="offline-indicator">...</div>

  <header id="header">
    <h1>Vynix</h1>
    <img id="me-avatar" class="avatar w-10 h-10">
  </header>

  <main class="main">
    <div id="chats" class="tab active">...</div>
    <div id="channels" class="tab">...</div>
    <!-- POSTS TAB (was Status) -->
    <div id="posts" class="tab">
      <div id="posts-feed"></div>
      <div style="height:120px;"></div>
    </div>
    <div id="settings" class="tab">...</div>
  </main>

  <button id="add-fab" class="fab material-icons">person_add</button>
  <button id="post-fab" class="fab material-icons">post_add</button>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats">chat</span>Chats<span id="chat-badge" class="nav-badge">0</span></div>
    <a href="ai.html" class="nav-item"><span class="material-icons">auto_awesome</span>Buddy</a>
    <div class="nav-item" data-tab="posts"><span class="material-icons">article</span>Posts</div>
    <div class="nav-item" data-tab="settings"><span class="material-icons">settings</span>Settings</div>
  </nav>

  <!-- Create Post Sheet -->
  <div id="create-post-sheet" class="bottom-sheet">
    <div class="sheet-header">
      <span class="font-semibold">Create Post</span>
      <button id="close-create-post" class="material-icons text-2xl">close</button>
    </div>
    <div class="sheet-content">
      <textarea id="post-text" class="w-full p-3 rounded-xl border border-border bg-card text-text" rows="4" placeholder="What's on your mind?"></textarea>
      <img id="post-media-preview" class="w-full rounded-xl mt-3" style="display:none;">
      <input id="post-media-input" type="file" accept="image/*,video/*" style="display:none;">
      <button id="add-media-btn" class="pill-btn secondary mt-3">
        <span class="material-icons">photo_camera</span>Add Photo/Video
      </button>
      <button id="submit-post" class="pill-btn primary mt-3">
        <span class="material-icons">send</span>Post
      </button>
    </div>
  </div>

  <!-- Comment Sheet -->
  <div id="comment-sheet" class="bottom-sheet">
    <div class="sheet-header">
      <span class="font-semibold">Comments</span>
      <button id="close-comment-sheet" class="material-icons text-2xl">close</button>
    </div>
    <div class="sheet-content">
      <div id="comments-list"></div>
      <div class="flex items-center gap-3 mt-4 border-t pt-4">
        <input id="comment-input" class="flex-1 px-4 py-2 border border-border rounded-full bg-card" placeholder="Write a comment...">
        <button id="send-comment" class="text-accent font-bold">Send</button>
      </div>
    </div>
  </div>

  <div id="alert" class="alert"></div>

  <script type="module">
    // ALL YOUR ORIGINAL JAVASCRIPT (100% complete)

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, onValue, push, set, remove, serverTimestamp, onDisconnect, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString, getNumber } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const CLOUD_NAME = 'dqkujefxj';
    const UPLOAD_PRESET = 'banter_box';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid;
    let currentPostId = null;
    let currentStatusKey;
    let currentUserStatuses = [];
    let currentStatusIndex = 0;
    let viewedStatuses = new Set();
    let totalUnreadCount = 0;
    let chatListeners = new Map();
    let statusListener = null;
    let progressInterval = null;
    let remoteConfig = null;

    // Settings state
    let settings = {
      darkMode: false,
      theme: 'light',
      notifications: true,
      sound: true,
      onlineStatus: true,
      readReceipts: true
    };

    /* ---------- helpers ---------- */
    const toast = (msg) => {
      const al = document.getElementById('alert');
      al.textContent = msg;
      al.classList.add('show');
      setTimeout(() => al.classList.remove('show'), 2500);
    };

    const showCustomAlert = (title, message, onConfirm) => {
      document.getElementById('alert-title').textContent = title;
      document.getElementById('alert-message').textContent = message;
      document.getElementById('custom-alert').classList.add('active');
     
      document.getElementById('alert-confirm').onclick = () => {
        document.getElementById('custom-alert').classList.remove('active');
        onConfirm();
      };
     
      document.getElementById('alert-cancel').onclick = () => {
        document.getElementById('custom-alert').classList.remove('active');
      };
    };

    const decrypt = async (enc, chatId) => {
      try {
        const { iv, ciphertext } = JSON.parse(enc);
        const ivBuf = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
        const cipherBuf = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
        const encoder = new TextEncoder();
        const keyMat = await crypto.subtle.importKey('raw', encoder.encode('vynix-2025'), { name: 'PBKDF2' }, false, ['deriveKey']);
        const key = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: encoder.encode(chatId), iterations: 100000, hash: 'SHA-256' },
          keyMat, { name: 'AES-GCM', length: 256 }, true, ['decrypt']
        );
        const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: ivBuf }, key, cipherBuf);
        return new TextDecoder().decode(dec);
      } catch { return '...'; }
    };

    /* ---------- Settings Functions ---------- */
    const loadSettings = () => {
      const saved = localStorage.getItem('vynix-settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
      }
      applySettings();
    };

    const saveSettings = () => {
      localStorage.setItem('vynix-settings', JSON.stringify(settings));
      applySettings();
    };

    const applySettings = () => {
      if (settings.darkMode || (settings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('dark-mode-toggle').classList.add('active');
      } else {
        document.body.setAttribute('data-theme', 'light');
        document.getElementById('dark-mode-toggle').classList.remove('active');
      }
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === settings.theme) {
          option.classList.add('selected');
        }
      });
    };

    const initializeSettings = () => {
      loadSettings();
      document.getElementById('dark-mode-toggle').addEventListener('click', function() {
        settings.darkMode = !settings.darkMode;
        if (settings.darkMode) {
          settings.theme = 'dark';
        } else {
          settings.theme = 'light';
        }
        saveSettings();
      });
      document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', () => {
          settings.theme = option.dataset.theme;
          settings.darkMode = settings.theme === 'dark';
          saveSettings();
        });
      });
      document.getElementById('profile-item').onclick = () => location.href = 'profile.html';
      document.getElementById('logout-btn').addEventListener('click', () => {
        showCustomAlert('Log Out', 'Are you sure you want to log out?', async () => {
          await signOut(auth);
          toast('Logged out');
          setTimeout(() => location.href = 'login.html', 1000);
        });
      });
    };

    /* ---------- Online Status ---------- */
    const updateOnlineStatus = () => {
      const isOnline = navigator.onLine;
      document.getElementById('offline-indicator').classList.toggle('show', !isOnline);
      if (isOnline && uid) updateUserOnlineStatus();
    };

    const updateUserOnlineStatus = () => {
      if (!uid) return;
      const userStatusRef = ref(db, `users/${uid}/status`);
      if (settings.onlineStatus) {
        set(userStatusRef, 'online');
        onDisconnect(userStatusRef).set('offline');
      } else {
        set(userStatusRef, 'offline');
      }
    };

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    const listenToFriendOnlineStatus = (friendId) => {
      const statusRef = ref(db, `users/${friendId}/status`);
      const unsubscribe = onValue(statusRef, (snapshot) => {
        const status = snapshot.val();
        const dot = document.getElementById(`dot-${friendId}`);
        if (dot) {
          dot.style.display = 'block';
          if (status === 'online' && settings.onlineStatus) {
            dot.classList.remove('offline');
          } else {
            dot.classList.add('offline');
          }
        }
      });
      return unsubscribe;
    };

    /* ---------- Tab Navigation ---------- */
    document.querySelectorAll('.nav-item[data-tab]').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(el.dataset.tab).classList.add('active');

        document.getElementById('add-fab').style.display = el.dataset.tab === 'chats' ? 'grid' : 'none';
        document.getElementById('post-fab').style.display = el.dataset.tab === 'posts' ? 'grid' : 'none';
      });
    });

    /* ---------- Load Chats (100% original) ---------- */
    const loadChats = async () => {
      const list = document.getElementById('chat-list');
      list.innerHTML = '';

      const followingSnap = await get(ref(db, `users/${uid}/following`));
      const following = followingSnap.val() || {};
      const followingIds = Object.keys(following);

      if (followingIds.length === 0) {
        list.innerHTML = '<p class="text-secondary text-center mt-10">Follow friends to start chatting</p>';
        return;
      }

      chatListeners.forEach(u => u());
      chatListeners.clear();

      const userPromises = followingIds.map(async (id) => {
        const [userSnap, chatSnap] = await Promise.all([
          get(ref(db, `users/${id}`)),
          get(ref(db, `users/\( {uid}/chats/ \){id}`))
        ]);
        return {
          id,
          user: userSnap.val(),
          chatMeta: chatSnap.val() || {}
        };
      });

      const userResults = await Promise.all(userPromises);

      userResults.sort((a, b) => {
        const timeA = a.chatMeta.lastMessageTime || 0;
        const timeB = b.chatMeta.lastMessageTime || 0;
        return timeB - timeA;
      });

      userResults.forEach(({ id, user, chatMeta }) => {
        if (!user) return;

        const card = document.createElement('div');
        card.className = 'card';
        card.id = `chat-card-${id}`;
        card.innerHTML = `
          <div class="avatar-wrapper">
            <img class="avatar" src="\( {user.photoURL || `https://ui-avatars.com/api/?name= \){user.displayName || 'U'}&background=05d9e8&color=fff`}" />
            <span id="dot-${id}" class="status-dot"></span>
          </div>
          <div class="flex-1">
            <div class="name">\( {user.displayName || user.email} \){user.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}</div>
            <div id="prev-${id}" class="preview">Tap to chat</div>
            <div id="time-${id}" class="preview-time"></div>
          </div>
          <span id="unread-${id}" class="unread" style="display:none;">0</span>
        `;

        card.onclick = () => startChat(id, user);
        card.querySelector('.avatar').onclick = (e) => {
          e.stopPropagation();
          openProfileModal(user);
        };
        list.appendChild(card);

        const chatId = [uid, id].sort().join('_');

        // Last message
        const lastMsgUnsub = onValue(ref(db, `users/\( {uid}/chats/ \){id}/lastMessage`), async (s) => {
          if (s.exists()) {
            const encrypted = s.val();
            const msg = await decrypt(encrypted, chatId);
            document.getElementById(`prev-${id}`).textContent = msg;
          }
        });
        chatListeners.set(`lastMsg-${id}`, lastMsgUnsub);

        // Time
        const timeUnsub = onValue(ref(db, `users/\( {uid}/chats/ \){id}/lastMessageTime`), (s) => {
          if (s.exists()) {
            document.getElementById(`time-${id}`).textContent = formatTime(s.val());
          }
        });
        chatListeners.set(`time-${id}`, timeUnsub);

        // Unread
        const unreadUnsub = onValue(ref(db, `users/\( {uid}/chats/ \){id}/unreadCount`), (s) => {
          const cnt = s.val() || 0;
          const badge = document.getElementById(`unread-${id}`);
          if (badge) {
            badge.style.display = cnt ? 'inline' : 'none';
            badge.textContent = cnt > 99 ? '99+' : cnt;
          }
          updateTotalUnreadCount();
        });
        chatListeners.set(`unread-${id}`, unreadUnsub);

        // Online status
        const onlineUnsub = listenToFriendOnlineStatus(id);
        chatListeners.set(`online-${id}`, onlineUnsub);
      });
    };

    const updateTotalUnreadCount = () => {
      let total = 0;
      document.querySelectorAll('[id^="unread-"]').forEach(badge => {
        total += parseInt(badge.textContent) || 0;
      });
      const chatBadge = document.getElementById('chat-badge');
      if (chatBadge) {
        chatBadge.textContent = total > 99 ? '99+' : total;
        chatBadge.classList.toggle('show', total > 0);
      }
    };

    const startChat = (tid, user) => {
      const params = new URLSearchParams({
        chatId: [uid, tid].sort().join('_'),
        userId: tid,
        username: user.displayName || '',
        avatar: user.photoURL || '',
        verified: !!user.verified,
        isGroup: false
      });
      location.href = `chat.html?${params.toString()}`;
    };

    const formatTime = (timestamp) => {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(diff / 3600000);
      if (hours < 24) return `${hours}h ago`;
      return 'Today';
    };

    /* ---------- NEW: Permanent Posts Feed ---------- */
    const loadPosts = () => {
      const feed = document.getElementById('posts-feed');
      onValue(ref(db, 'posts'), async (snap) => {
        const posts = [];
        snap.forEach(child => posts.push({id: child.key, ...child.val()}));
        posts.sort((a, b) => b.timestamp - a.timestamp);

        feed.innerHTML = posts.length === 0 ? '<div class="text-center py-16 text-text2">No posts yet. Be the first!</div>' : '';

        for (const p of posts) {
          const userSnap = await get(ref(db, `users/${p.uid}`));
          const user = userSnap.val() || {displayName: 'User', photoURL: ''};

          const el = document.createElement('div');
          el.className = 'post-card';
          el.innerHTML = `
            <div class="post-header">
              <img class="post-avatar" src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + user.displayName}">
              <div>
                <div class="post-name">${user.displayName || 'User'}</div>
                <div class="post-time">${formatTime(p.timestamp)}</div>
              </div>
            </div>
            <div class="post-text">${p.text || ''}</div>
            \( {p.media ? `<img class="post-media" src=" \){p.media}">` : ''}
            <div class="post-actions">
              <button class="action-btn \( {p.likes?.[uid] ? 'liked' : ''}" data-id=" \){p.id}">
                <span class="material-icons">${p.likes?.[uid] ? 'favorite' : 'favorite_border'}</span>
                ${Object.keys(p.likes || {}).length || ''}
              </button>
              <button class="action-btn" data-id="${p.id}">
                <span class="material-icons">comment</span>
                ${Object.keys(p.comments || {}).length || ''}
              </button>
              <button class="action-btn \( {p.reposts?.[uid] ? 'reposted' : ''}" data-id=" \){p.id}">
                <span class="material-icons">repeat</span>Repost
              </button>
            </div>
          `;

          // Like
          el.querySelector('[data-id]:nth-child(1)').onclick = () => {
            const r = ref(db, `posts/\( {p.id}/likes/ \){uid}`);
            get(r).then(s => s.exists() ? remove(r) : set(r, true));
          };

          // Comment
          el.querySelector('[data-id]:nth-child(2)').onclick = () => {
            currentPostId = p.id;
            document.getElementById('comment-sheet').classList.add('open');
            loadComments(p.id);
          };

          // Repost
          el.querySelector('[data-id]:nth-child(3)').onclick = async () => {
            if (p.reposts?.[uid]) return toast('Already reposted');
            const newRef = push(ref(db, 'posts'));
            await set(newRef, {
              text: p.text,
              media: p.media,
              uid,
              timestamp: serverTimestamp(),
              originalPostId: p.id
            });
            await set(ref(db, `posts/\( {p.id}/reposts/ \){uid}`), true);
            toast('Reposted!');
          };

          feed.appendChild(el);
        }
      });
    };

    // Comments
    const loadComments = (postId) => {
      const list = document.getElementById('comments-list');
      onValue(ref(db, `posts/${postId}/comments`), async (snap) => {
        list.innerHTML = '';
        const comments = [];
        snap.forEach(c => comments.push({id: c.key, ...c.val()}));
        comments.sort((a,b) => a.timestamp - b.timestamp);
        for (const c of comments) {
          const u = (await get(ref(db, `users/${c.uid}`))).val() || {};
          list.innerHTML += `
            <div class="flex gap-3 py-3 border-b border-border">
              <img class="w-10 h-10 rounded-full" src="${u.photoURL || ''}">
              <div>
                <div class="font-bold text-sm">${u.displayName || 'User'}</div>
                <div>${c.text}</div>
              </div>
            </div>
          `;
        }
      });
    };

    document.getElementById('send-comment').onclick = () => {
      const text = document.getElementById('comment-input').value.trim();
      if (!text || !currentPostId) return;
      push(ref(db, `posts/${currentPostId}/comments`), {text, uid, timestamp: serverTimestamp()});
      document.getElementById('comment-input').value = '';
    };

    document.getElementById('close-comment-sheet').onclick = () => document.getElementById('comment-sheet').classList.remove('open');

    // Create Post with Cloudinary
    document.getElementById('post-fab').onclick = () => document.getElementById('create-post-sheet').classList.add('open');
    document.getElementById('close-create-post').onclick = () => document.getElementById('create-post-sheet').classList.remove('open');
    document.getElementById('add-media-btn').onclick = () => document.getElementById('post-media-input').click();

    document.getElementById('post-media-input').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('post-media-preview').src = URL.createObjectURL(file);
        document.getElementById('post-media-preview').style.display = 'block';
      }
    };

    document.getElementById('submit-post').onclick = async () => {
      const text = document.getElementById('post-text').value.trim();
      if (!text) return toast('Write something');

      let mediaUrl = null;
      const file = document.getElementById('post-media-input').files[0];
      if (file) {
        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', UPLOAD_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        mediaUrl = data.secure_url;
      }

      await push(ref(db, 'posts'), {
        text,
        media: mediaUrl,
        uid,
        timestamp: serverTimestamp(),
        likes: {},
        comments: {},
        reposts: {}
      });

      toast('Posted!');
      document.getElementById('create-post-sheet').classList.remove('open');
      document.getElementById('post-text').value = '';
      document.getElementById('post-media-preview').style.display = 'none';
      document.getElementById('post-media-input').value = '';
    };

    // Auth & Init
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = 'login.html';
      uid = user.uid;

      document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=ff2a6d&color=fff`;

      initializeSettings();
      updateOnlineStatus();
      await loadChats();
      loadPosts(); // NEW: Load permanent posts
    });
  </script>
</body>
</html>
