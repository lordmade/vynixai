<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Full Social Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #ffffff; --card: #ffffff; --text: #0f1419; --text2: #536471;
      --border: #eff3f4; --accent: #ff2a6d; --hover-accent: rgba(255, 42, 109, 0.1);
    }
    [data-theme="dark"] {
      --bg: #000000; --card: #000000; --text: #e7e9ea; --text2: #71767b;
      --border: #2f3336;
    }
    * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    input, textarea { -webkit-user-select: auto; user-select: auto; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); overflow-y: scroll; }
    .composer { display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--border); }
    .composer img.avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea { flex: 1; resize: none; background: transparent; color: var(--text); border: none; outline: none; font-size: 20px; padding-top: 10px; min-height: 60px; }
    .media-preview { width: 100%; border-radius: 16px; margin-top: 12px; border: 1px solid var(--border); }
    .composer-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
    .icon-btn { background: none; border: none; color: var(--accent); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--hover-accent); }
    .post-btn { background: var(--accent); color: #fff; border: none; border-radius: 999px; padding: 10px 24px; font-weight: 700; font-size: 15px; cursor: pointer; transition: opacity 0.2s; }
    .post-btn:disabled { opacity: 0.5; cursor: default; }
    .feed { padding-bottom: 40px; }
    .post-card { border-bottom: 1px solid var(--border); padding: 16px; cursor: pointer; transition: background 0.2s; }
    .post-card:hover { background: rgba(0,0,0,0.03); }
    [data-theme="dark"] .post-card:hover { background: rgba(255,255,255,0.03); }
    .post-header { display: flex; gap: 12px; align-items: flex-start; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .user-meta { display: flex; gap: 4px; align-items: center; font-size: 15px; }
    .name { font-weight: 700; color: var(--text); }
    .verified-badge { color: var(--accent); font-size: 16px !important; margin-left: 2px; }
    .handle, .time { color: var(--text2); font-weight: 400; }
    .post-content { margin-top: 4px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; margin-left: 52px; }
    .post-image { border-radius: 16px; margin-top: 12px; max-width: 100%; max-height: 400px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.2s; }
    .post-image:hover { opacity: 0.9; }
    .post-video { border-radius: 16px; margin-top: 12px; max-width: 100%; max-height: 400px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.2s; }
    .post-video:hover { opacity: 0.9; }
    .post-actions { display: flex; justify-content: space-between; margin-top: 12px; margin-left: 52px; max-width: 400px; color: var(--text2); }
    .action-item { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .action-item .material-icons-outlined { font-size: 18px; padding: 8px; border-radius: 50%; transition: 0.2s; }
    .action-item:hover.reply { color: #1d9bf0; }
    .action-item:hover.repost { color: #00ba7c; }
    .action-item:hover.like { color: #f91880; }
    .delete-btn:hover { color: #f4212e; }
    #custom-alert-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.25s ease; }
    #custom-alert-overlay.show { opacity: 1; pointer-events: auto; }
    .custom-alert-box { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.25s ease; }
    #custom-alert-overlay.show .custom-alert-box { transform: scale(1); }
    .custom-alert-title { font-weight: 700; font-size: 18px; margin-bottom: 8px; }
    .custom-alert-message { font-size: 15px; color: var(--text2); margin-bottom: 20px; }
    .custom-alert-buttons { display: flex; gap: 12px; justify-content: flex-end; }
    .custom-alert-btn { background: none; border: none; font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 999px; transition: background 0.2s; }
    .custom-alert-btn.cancel { color: var(--text2); }
    .custom-alert-btn.cancel:hover { background: rgba(0,0,0,0.05); }
    }
    [data-theme="dark"] .custom-alert-btn.cancel:hover { background: rgba(255,255,255,0.05); }
    .custom-alert-btn.confirm { background: var(--accent); color: #fff; }
    .custom-alert-btn.confirm:hover { opacity: 0.9; }
    #comment-sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    #comment-sheet-overlay.show { opacity: 1; pointer-events: auto; }
    .comment-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); border-top-left-radius: 20px; border-top-right-radius: 20px; max-height: 75vh; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease; }
    #comment-sheet-overlay.show .comment-sheet { transform: translateY(0); }
    .comment-sheet-header { padding: 16px; font-size: 18px; font-weight: 700; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .comment-sheet-close { background: none; border: none; color: var(--text2); cursor: pointer; }
    .comment-sheet-list { flex: 1; overflow-y: auto; padding: 0 16px; }
    .comment-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .comment-body { flex: 1; }
    .comment-name { font-size: 14px; font-weight: 700; }
    .comment-text { font-size: 15px; margin-top: 2px; }
    .comment-input-box { display: flex; gap: 12px; padding: 16px; border-top: 1px solid var(--border); }
    .comment-input { flex: 1; resize: none; background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 999px; padding: 10px 16px; font-size: 15px; outline: none; }
    .comment-send-btn { background: var(--accent); color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; display: grid; place-items: center; cursor: pointer; transition: opacity 0.2s; }
    .comment-send-btn:disabled { opacity: 0.5; cursor: default; }
    .custom-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: white; padding: 12px 24px; border-radius: 99px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); font-weight: 600; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50; display: flex; align-items: center; gap: 8px; }
    .custom-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .post-actions svg { width: 24px; height: 24px; }
    .post-actions .filled-heart { display: none; }
    .post-actions .like.liked .outline-heart { display: none; }
    .post-actions .like.liked .filled-heart { display: block; }
    .action-item:hover svg { transform: scale(1.1); transition: all 0.2s; }
    .action-item.repost:hover svg { stroke: #00ba7c; transform: scale(1.15); }
    .action-item.share:hover svg { stroke: #0095f6; transform: translateY(-2px) scale(1.1); transition: all 0.2s ease; }
    #image-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 150; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
    #image-modal.show { display: flex !important; }
    #modal-image, #modal-video { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; }
    #modal-video { display: none; }
    #modal-video.show { display: block; }
    .video-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-radius: 50px; padding: 12px 20px; display: flex; align-items: center; gap: 15px; z-index: 160; }
    .video-controls button { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; padding: 5px; border-radius: 50%; transition: all 0.2s; }
    .video-controls button:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
    .video-progress { flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; cursor: pointer; position: relative; min-width: 200px; }
    .video-progress-bar { height: 100%; background: var(--accent); border-radius: 2px; width: 0%; transition: width 0.1s; }
    .video-time { color: white; font-size: 13px; font-weight: 500; min-width: 80px; text-align: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.3) 50%, var(--border) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    [data-theme="dark"] .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.05) 50%, var(--border) 75%); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .skeleton-post { border-bottom: 1px solid var(--border); padding: 16px; }
    .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; }
    .skeleton-line { height: 12px; border-radius: 4px; margin: 8px 0; }
    .skeleton-text { height: 16px; border-radius: 4px; margin: 4px 0; }
    .skeleton-image { width: 100%; height: 300px; border-radius: 16px; margin-top: 12px; }
    .comment-like-btn.liked .outline-heart { display: none; }
    .comment-like-btn.liked .filled-heart { display: block; }
    nav a.text-[#ff2a6d] span:first-child { color: #ff2a6d !important; }
    main, .feed, .composer { padding-bottom: 80px !important; }
    .video-play-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
    .video-play-overlay .material-icons { font-size: 56px; color: var(--accent); text-shadow: 0 2px 8px rgba(0,0,0,.45); background: rgba(0,0,0,.35); border-radius: 50%; padding: 12px; }
    .post-video-wrapper { position: relative; display: inline-block; width: 100%; margin-top: 12px; }
  </style>
</head>
<body>
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#ff2a6d] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix for a better experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="bg-white text-[#ff2a6d] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-icons text-xl">close</span>
      </button>
    </div>
  </div>

  <div class="composer">
    <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=random&color=fff" alt="avatar"/>
    <div class="flex-1">
      <textarea id="post-text" placeholder="What is happening?!"></textarea>
      <video id="media-preview-video" class="media-preview hidden" controls muted loop playsinline></video>
      <img id="media-preview-img" class="media-preview hidden" alt=""/>
      <div class="composer-actions">
        <div>
          <input type="file" id="file-input" accept="image/*,video/*" class="hidden"/>
          <label for="file-input" class="icon-btn" title="Add Photo / Video">
            <span class="material-icons-outlined">image</span>
          </label>
        </div>
        <button id="post-btn" class="post-btn" disabled>
          <span id="btn-text">Post</span>
          <span id="btn-spinner" class="spinner hidden"></span>
        </button>
      </div>
    </div>
  </div>

  <main id="feed" class="feed"></main>
  <div class="text-center p-4">
    <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
  </div>

  <!-- Modals (alert, comments, image/video) -->
  <div id="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
      <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
      <div class="custom-alert-buttons">
        <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
        <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
      </div>
    </div>
  </div>

  <div id="comment-sheet-overlay">
    <div class="comment-sheet">
      <div class="comment-sheet-header">
        <span>Comments</span>
        <button class="comment-sheet-close material-icons-outlined" id="comment-sheet-close">close</button>
      </div>
      <div class="comment-sheet-list" id="comment-sheet-list"></div>
      <div class="comment-input-box">
        <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
        <button class="comment-send-btn" id="comment-send-btn">
          <span class="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  </div>

  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <video id="modal-video" loop>
      <source src="" type="video/mp4">
    </video>
    <div class="video-controls" id="video-controls" style="display: none;">
      <button id="play-pause-btn"><span class="material-icons-outlined">play_arrow</span></button>
      <span class="video-time" id="video-time">0:00 / 0:00</span>
      <div class="video-progress" id="video-progress"><div class="video-progress-bar" id="video-progress-bar"></div></div>
      <button id="mute-btn"><span class="material-icons-outlined">volume_up</span></button>
    </div>
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>

  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 z-40">
    <div class="h-full flex items-center justify-around text-gray-500">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-24">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-24">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-24">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-24">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-24">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-24">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid, uname, uavatar;
    const userMetaCache = new Map();

    const $ = s => document.querySelector(s);
    const postBtn = $('#post-btn'), textEl = $('#post-text'),
          previewImg = $('#media-preview-img'), previewVid = $('#media-preview-video'),
          fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
          loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 50;

    let lastTimestamp = null, lastKey = null, initialLoadDone = false;

    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
      document.body.setAttribute('data-theme', 'dark');

    onAuthStateChanged(auth, user => {
      if (!user) {
        signInAnonymously(auth);
        uid = "guest_" + Math.random().toString(36).slice(2);
        uname = "Guest";
      } else {
        uid = user.uid;
        uname = user.displayName || user.email?.split('@')[0] || 'User';
      }

      uavatar = user?.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
      myAvatarEl.src = uavatar;

      // Real-time avatar update for composer
      if (user) {
        onValue(ref(db, `users/${user.uid}/profile`), snap => {
          const p = snap.val() || {};
          const newAvatar = p.avatar || p.photoURL || uavatar;
          if (newAvatar !== uavatar) {
            uavatar = newAvatar;
            $('#my-avatar').src = newAvatar;
          }
        });
      }

      initFeed();
    });

    function updateUserProfile(updates) {
      return set(ref(db, `users/${uid}/profile`), updates);
    }

    function showSkeletonLoaders(count = 5) {
      feedEl.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton-post';
        skeleton.innerHTML = `
          <div class="post-header">
            <div class="skeleton skeleton-avatar"></div>
            <div class="flex-1">
              <div class="skeleton skeleton-line" style="width: 40%; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 85%;"></div>
              <div class="skeleton skeleton-text" style="width: 70%;"></div>
              <div class="skeleton skeleton-image" style="height: ${Math.random() > 0.5 ? '250px' : '0'}"></div>
            </div>
          </div>
        `;
        feedEl.appendChild(skeleton);
      }
    }

    async function initFeed() {
      showSkeletonLoaders(5);
      try {
        const postsRef = ref(db, 'posts');
        const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
        const snap = await get(q);
        feedEl.innerHTML = '';
        const rows = [];
        snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
        rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
        const last = rows[rows.length-1];
        if (last) { lastTimestamp = last.timestamp; lastKey = last.key; }
        loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
        initialLoadDone = true;
        listenNew();
      } catch (e) {
        feedEl.innerHTML = '';
        console.error(e);
        toast('Error loading posts');
      }
    }

    function listenNew() {
      const postsRef = ref(db, 'posts');
      onChildAdded(postsRef, snap => {
        if (!initialLoadDone) return;
        const data = snap.val();
        if (!data || !data.timestamp) return;
        if (!lastTimestamp || data.timestamp > lastTimestamp) {
          feedEl.prepend(renderPostCard({key: snap.key, ...data}));
          lastTimestamp = data.timestamp;
        }
      });
    }

    loadMoreBtn.onclick = async () => {
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = 'Loading...';
      const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT+1));
      const snap = await get(q);
      const rows = [];
      snap.forEach(c => rows.push({key: c.key, ...c.val()}));
      const uniq = rows.filter(p => p.key !== lastKey);
      if (!uniq.length) { toast('No more posts'); loadMoreBtn.classList.add('hidden'); return; }
      uniq.reverse();
      uniq.forEach(p => feedEl.appendChild(renderPostCard(p)));
      const last = uniq[uniq.length-1];
      lastTimestamp = last.timestamp; lastKey = last.key;
      if (uniq.length < POST_LIMIT) loadMoreBtn.classList.add('hidden');
      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = 'Load More Posts';
    };

    let mediaUrl = '', uploading = false;
    function toggleBtn() { postBtn.disabled = uploading || (!textEl.value.trim() && !mediaUrl); }

    fileInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const isVideo = file.type.startsWith('video/');
      const isImage = file.type.startsWith('image/');
      if (!isVideo && !isImage) { toast('Only images or videos'); return; }
      const r = new FileReader();
      r.onload = ev => {
        if (isVideo) {
          previewVid.src = ev.target.result;
          previewVid.classList.remove('hidden');
          previewImg.classList.add('hidden');
        } else {
          previewImg.src = ev.target.result;
          previewImg.classList.remove('hidden');
          previewVid.classList.add('hidden');
        }
      };
      r.readAsDataURL(file);
      uploadToCloudinary(file);
    };

    function uploadToCloudinary(file) {
      const CLOUD_NAME = "dqkujefxj", UPLOAD_PRESET = "banter_box";
      uploading = true; toggleBtn();
      $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
        .then(r => r.json())
        .then(async res => {
          const newUrl = res.secure_url;
          mediaUrl = newUrl;
          await updateProfile(auth.currentUser, {photoURL: newUrl});
          await updateUserProfile({avatar: newUrl});
          toast('Avatar updated');
        })
        .catch(err => {
          toast('Upload failed');
          mediaUrl = '';
          previewImg.classList.add('hidden');
          previewVid.classList.add('hidden');
        })
        .finally(() => {
          uploading = false;
          $('#btn-spinner').classList.add('hidden');
          $('#btn-text').classList.remove('hidden');
          toggleBtn();
        });
    }

    postBtn.onclick = async () => {
      const text = textEl.value.trim();
      if (!text && !mediaUrl) return;
      postBtn.disabled = true;
      $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
      const newRef = push(ref(db, 'posts'));
      const postData = {
        authorId: uid, authorName: uname, authorAvatar: uavatar, text, image: mediaUrl,
        verified: false, likes: 0, replies: 0, reposts: 0, timestamp: serverTimestamp()
      };
      try {
        await set(newRef, postData);
        textEl.value = ''; mediaUrl = '';
        previewImg.classList.add('hidden'); previewVid.classList.add('hidden');
        toggleBtn(); toast('Posted!');
      } catch (err) {
        console.error(err); toast('Error posting');
      } finally {
        $('#btn-spinner').classList.add('hidden'); $('#btn-text').classList.remove('hidden');
        postBtn.disabled = false;
      }
    };

    textEl.oninput = () => { textEl.style.height = 'auto'; textEl.style.height = textEl.scrollHeight + 'px'; toggleBtn(); };

    // Real-time user metadata
    function listenUserMeta(uid, card) {
      if (userMetaCache.has(uid)) {
        applyUserMeta(card, userMetaCache.get(uid));
        return;
      }
      const unsub = onValue(ref(db, `users/${uid}/profile`), snap => {
        const p = snap.val() || {};
        const meta = {
          name: p.displayName || 'User',
          avatar: p.avatar || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${p.displayName || 'User'}`,
          verified: !!p.verified
        };
        userMetaCache.set(uid, meta);
        applyUserMeta(card, meta);
      });
      card._userUnsub = unsub;
    }

    }

    function applyUserMeta(card, meta) {
      card.querySelector('.name').textContent = meta.name;
      card.querySelector('.handle').textContent = `@${meta.name.replace(/\s/g,'').toLowerCase()}`;
      card.querySelector('.post-avatar').src = meta.avatar;
      const badge = card.querySelector('.verified-badge');
      if (badge) badge.style.display = meta.verified ? 'inline' : 'none';
    }

    function renderPostCard(p) {
      const isMine = p.authorId === uid;
      const div = document.createElement('div');
      div.id = `post-${p.key}`;
      div.className = 'post-card';
      div.style.position = 'relative';
      div.innerHTML = `
        <div class="post-header">
          <a href="profile.html?uid=${encodeURIComponent(p.authorId)}">
            <img src="" class="post-avatar"> <!-- Filled in real-time -->
          </a>
          <div class="flex-1">
            <div class="user-meta">
              <span class="name">${esc(p.authorName)}</span>
              <span class="verified-badge material-icons text-sm" style="display:none">verified</span>
              <span class="handle">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
            </div>
            <div class="post-content">${esc(p.text)}</div>
            ${mediaMarkup(p.image)}
            <div class="post-actions">
              <!-- actions here (reply, repost, like, share, delete) 
            </div>
          </div>
        </div>`;
      listenUserMeta(p.authorId, div);
      div.addEventListener('click', /* your existing click handler */);
      listenCounters(p.key);
      return div;
    }

    // Rest of your functions (mediaMarkup, listenCounters, comments, modals, etc.) remain unchanged

    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'custom-toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.classList.add('show'), 10);
      setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
    }

    const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
    function timeAgo(ts) {
      if (!ts) return 'now';
      const s = Math.floor((Date.now() - ts) / 1000);
      return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s/60)}m` : s < 86400 ? `${Math.floor(s/3600)}h` : `${Math.floor(s/86400)}d`;
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const currentPage = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('nav a').forEach(link => {
        if (link.getAttribute('href') === currentPage) {
          link.classList.add('text-[#ff2a6d]');
          const icon = link.querySelector('span.material-icons-outlined');
          if (icon) icon.classList.replace('material-icons-outlined', 'material-icons');
        }
      });
    });

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('pwa-install-banner').classList.remove('-translate-y-full');
    });

    document.getElementById('pwa-install-btn')?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('pwa-install-banner').classList.add('-translate-y-full');
    });

    document.getElementById('pwa-install-close')?.addEventListener('click', () => {
      document.getElementById('pwa-install-banner').classList.add('-translate-y-full');
    });
  </script>
</body>
</html>
