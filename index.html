<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Full Social Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #ffffff; --card: #ffffff; --text: #0f1419; --text2: #536471;
      --border: #eff3f4; --accent: #ff2a6d; --hover-accent: rgba(255, 42, 109, 0.1);
    }
    [data-theme="dark"] {
      --bg: #000000; --card: #000000; --text: #e7e9ea; --text2: #71767b;
      --border: #2f3336;
    }
    * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    input, textarea { -webkit-user-select: auto; user-select: auto; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); overflow-y: scroll; }
    
    /* Instagram-style Post Cards */
    .post-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0;
      margin: 0 0 20px 0;
      padding: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .post-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    [data-theme="dark"] .post-card:hover {
      box-shadow: 0 2px 8px rgba(255,255,255,0.05);
    }
    
    /* Instagram-style Header */
    .post-header {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }
    .post-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent);
    }
    .user-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .username {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
    }
    .post-time {
      font-size: 12px;
      color: var(--text2);
    }
    .post-options {
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .post-options:hover {
      background: var(--hover-accent);
    }
    
    /* Instagram-style Content */
    .post-media {
      width: 100%;
      max-height: 600px;
      object-fit: cover;
      display: block;
    }
    .post-content-wrapper {
      padding: 16px;
    }
    .post-actions-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .post-actions-left {
      display: flex;
      gap: 16px;
    }
    .action-btn {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .action-btn:hover {
      background: var(--hover-accent);
      transform: scale(1.1);
    }
    .action-btn.liked {
      color: #ed4956;
    }
    .action-btn.saved {
      margin-left: auto;
    }
    
    /* Instagram-style Text Content */
    .post-text {
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 8px;
      word-wrap: break-word;
    }
    .post-text .hashtag {
      color: var(--accent);
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .post-text .hashtag:hover {
      opacity: 0.8;
      text-decoration: underline;
    }
    .post-text .url {
      color: var(--accent);
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .post-text .url:hover {
      opacity: 0.8;
      text-decoration: underline;
    }
    
    /* Instagram-style Stats */
    .post-stats {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .post-caption {
      font-size: 14px;
      line-height: 1.5;
    }
    .view-comments {
      font-size: 14px;
      color: var(--text2);
      cursor: pointer;
      margin-top: 8px;
      transition: color 0.2s;
    }
    .view-comments:hover {
      color: var(--text);
    }
    
    /* Character Counter */
    .char-counter {
      font-size: 12px;
      color: var(--text2);
      margin-top: 4px;
      text-align: right;
    }
    .char-counter.warning {
      color: #f59e0b;
    }
    .char-counter.error {
      color: #ef4444;
    }
    
    .composer { display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--border); }
    .composer img.avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea { flex: 1; resize: none; background: transparent; color: var(--text); border: none; outline: none; font-size: 20px; padding-top: 10px; min-height: 60px; }
    .media-preview { width: 100%; border-radius: 16px; margin-top: 12px; border: 1px solid var(--border); }
    .composer-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
    .icon-btn { background: none; border: none; color: var(--accent); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--hover-accent); }
    .post-btn { background: var(--accent); color: #fff; border: none; border-radius: 999px; padding: 10px 24px; font-weight: 700; font-size: 15px; cursor: pointer; transition: opacity 0.2s; }
    .post-btn:disabled { opacity: 0.5; cursor: default; }
    .feed { padding-bottom: 40px; }
    
    /* Navbar Hide/Show Styles */
    nav {
      transition: transform 0.3s ease-in-out;
      transform: translateY(0);
    }
    nav.hidden {
      transform: translateY(100%);
    }
    
    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(255, 42, 109, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 30;
    }
    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 42, 109, 0.6);
    }
    .fab.hidden {
      transform: scale(0);
    }
    
    #custom-alert-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.25s ease; }
    #custom-alert-overlay.show { opacity: 1; pointer-events: auto; }
    .custom-alert-box { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.25s ease; }
    #custom-alert-overlay.show .custom-alert-box { transform: scale(1); }
    .custom-alert-title { font-weight: 700; font-size: 18px; margin-bottom: 8px; }
    .custom-alert-message { font-size: 15px; color: var(--text2); margin-bottom: 20px; }
    .custom-alert-buttons { display: flex; gap: 12px; justify-content: flex-end; }
    .custom-alert-btn { background: none; border: none; font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 999px; transition: background 0.2s; }
    .custom-alert-btn.cancel { color: var(--text2); }
    .custom-alert-btn.cancel:hover { background: rgba(0,0,0,0.05); }
    [data-theme="dark"] .custom-alert-btn.cancel:hover { background: rgba(255,255,255,0.05); }
    .custom-alert-btn.confirm { background: var(--accent); color: #fff; }
    .custom-alert-btn.confirm:hover { opacity: 0.9; }
    #comment-sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    #comment-sheet-overlay.show { opacity: 1; pointer-events: auto; }
    .comment-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); border-top-left-radius: 20px; border-top-right-radius: 20px; max-height: 75vh; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease; }
    #comment-sheet-overlay.show .comment-sheet { transform: translateY(0); }
    .comment-sheet-header { padding: 16px; font-size: 18px; font-weight: 700; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .comment-sheet-close { background: none; border: none; color: var(--text2); cursor: pointer; }
    .comment-sheet-list { flex: 1; overflow-y: auto; padding: 0 16px; }
    .comment-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .comment-body { flex: 1; }
    .comment-name { font-size: 14px; font-weight: 700; }
    .comment-text { font-size: 15px; margin-top: 2px; }
    .comment-input-box { display: flex; gap: 12px; padding: 16px; border-top: 1px solid var(--border); }
    .comment-input { flex: 1; resize: none; background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 999px; padding: 10px 16px; font-size: 15px; outline: none; }
    .comment-send-btn { background: var(--accent); color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; display: grid; place-items: center; cursor: pointer; transition: opacity 0.2s; }
    .comment-send-btn:disabled { opacity: 0.5; cursor: default; }
    .custom-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: white; padding: 12px 24px; border-radius: 99px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); font-weight: 600; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50; display: flex; align-items: center; gap: 8px; }
    .custom-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .post-actions svg { width: 24px; height: 24px; }
    .post-actions .filled-heart { display: none; }
    .post-actions .like.liked .outline-heart { display: none; }
    .post-actions .like.liked .filled-heart { display: block; }
    .action-item:hover svg { transform: scale(1.1); transition: all 0.2s; }
    .action-item.repost:hover svg { stroke: #00ba7c; transform: scale(1.15); }
    .action-item.share:hover svg { stroke: #0095f6; transform: translateY(-2px) scale(1.1); transition: all 0.2s ease; }
   
    /* Image Modal Styles */
    #image-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 150; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
    #image-modal.show { display: flex !important; }
    #modal-image, #modal-video { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    #modal-video { display: none; }
    #modal-video.show { display: block; }
   
    /* Custom Video Controls */
    .video-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-radius: 50px; padding: 12px 20px; display: flex; align-items: center; gap: 15px; z-index: 160; }
    .video-controls button { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; padding: 5px; border-radius: 50%; transition: all 0.2s; }
    .video-controls button:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
    .video-progress { flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; cursor: pointer; position: relative; min-width: 200px; }
    .video-progress-bar { height: 100%; background: var(--accent); border-radius: 2px; width: 0%; transition: width 0.1s; }
    .video-time { color: white; font-size: 13px; font-weight: 500; min-width: 80px; text-align: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* Shimmer Loading Animation */
    .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.3) 50%, var(--border) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    [data-theme="dark"] .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.05) 50%, var(--border) 75%); background-size: 200% 100%; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .skeleton-post { border-bottom: 1px solid var(--border); padding: 16px; }
    .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; }
    .skeleton-line { height: 12px; border-radius: 4px; margin: 8px 0; }
    .skeleton-text { height: 16px; border-radius: 4px; margin: 4px 0; }
    .skeleton-image { width: 100%; height: 300px; border-radius: 16px; margin-top: 12px; }
    .comment-like-btn.liked .outline-heart { display: none; }
    .comment-like-btn.liked .filled-heart { display: block; }
    nav a.text-[#ff2a6d] span:first-child { color: #ff2a6d !important; }
    main, .feed, .composer { padding-bottom: 80px !important; }
    /* Centered pink play icon on video posts */
    .video-play-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .video-play-overlay .material-icons {
      font-size: 56px;
      color: var(--accent);
      text-shadow: 0 2px 8px rgba(0,0,0,.45);
      background: rgba(0,0,0,.35);
      border-radius: 50%;
      padding: 12px;
    }
    .post-video-wrapper { position: relative; display: inline-block; width: 100%; margin-top: 12px; }
  </style>
</head>
<body>
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#ff2a6d] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix for a better experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="bg-white text-[#ff2a6d] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-icons text-xl">close</span>
      </button>
    </div>
  </div>
  <div class="composer">
    <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=random&color=fff" alt="avatar"/>
    <div class="flex-1">
      <textarea id="post-text" placeholder="What is happening?!" maxlength="250"></textarea>
      <div class="char-counter" id="char-counter">0 / 250</div>
      <video id="media-preview-video" class="media-preview hidden" controls muted loop playsinline></video>
      <img id="media-preview-img" class="media-preview hidden" alt=""/>
      <div class="composer-actions">
        <div>
          <input type="file" id="file-input" accept="image/*,video/*" class="hidden"/>
          <label for="file-input" class="icon-btn" title="Add Photo / Video">
            <span class="material-icons-outlined">image</span>
          </label>
        </div>
        <button id="post-btn" class="post-btn" disabled>
          <span id="btn-text">Post</span>
          <span id="btn-spinner" class="spinner hidden"></span>
        </button>
      </div>
    </div>
  </div>
  <main id="feed" class="feed"></main>
  <div class="text-center p-4">
    <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
  </div>
  
  <!-- Floating Action Button -->
  <div id="fab" class="fab hidden">
    <span class="material-icons">add</span>
  </div>
  
  <div id="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
      <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
      <div class="custom-alert-buttons">
        <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
        <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
      </div>
    </div>
  </div>
  <div id="comment-sheet-overlay">
    <div class="comment-sheet">
      <div class="comment-sheet-header">
        <span>Comments</span>
        <button class="comment-sheet-close material-icons-outlined" id="comment-sheet-close">close</button>
      </div>
      <div class="comment-sheet-list" id="comment-sheet-list"></div>
      <div class="comment-input-box">
        <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
        <button class="comment-send-btn" id="comment-send-btn">
          <span class="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  </div>
  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <video id="modal-video" loop>
      <source src="" type="video/mp4">
    </video>
    <div class="video-controls" id="video-controls" style="display: none;">
      <button id="play-pause-btn">
        <span class="material-icons-outlined">play_arrow</span>
      </button>
      <span class="video-time" id="video-time">0:00 / 0:00</span>
      <div class="video-progress" id="video-progress">
        <div class="video-progress-bar" id="video-progress-bar"></div>
      </div>
      <button id="mute-btn">
        <span class="material-icons-outlined">volume_up</span>
      </button>
    </div>
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>
  <nav id="navbar" class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 z-40">
    <div class="h-full flex items-center justify-around text-gray-500">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">home</span>
        <span class="text-xs mt-0.5">Home</span>
      </a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">chat_bubble_outline</span>
        <span class="text-xs mt-0.5">Chat</span>
      </a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">search</span>
        <span class="text-xs mt-0.5">Search</span>
      </a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">auto_awesome</span>
        <span class="text-xs mt-0.5">AI</span>
      </a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">notifications</span>
        <span class="text-xs mt-0.5">Alerts</span>
      </a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">person</span>
        <span class="text-xs mt-0.5">Profile</span>
      </a>
    </div>
  </nav>
 
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
let uid, uname, uavatar;
const $ = s => document.querySelector(s);
const postBtn = $('#post-btn'), textEl = $('#post-text'),
      previewImg = $('#media-preview-img'), previewVid = $('#media-preview-video'),
      fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
      loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 50;
let lastTimestamp = null, lastKey = null, initialLoadDone = false;
if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.body.setAttribute('data-theme', 'dark');
onAuthStateChanged(auth, user => {
  if (!user) {
    signInAnonymously(auth);
    uid = "guest_" + Math.random().toString(36).slice(2);
    uname = "Guest";
  } else {
    uid = user.uid;
    uname = user.displayName || user.email?.split('@')[0] || 'User';
  }
  uavatar = user?.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
  myAvatarEl.src = uavatar;
  initFeed();
});
/* ---------- helper: write profile fields that feed cards listen to ---------- */
function updateUserProfile(updates) {
  return set(ref(db, `users/${uid}/profile`), updates);
}
function showSkeletonLoaders(count = 5) {
  feedEl.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'post-card';
    skeleton.innerHTML = `
      <div class="post-header">
        <div class="skeleton skeleton-avatar"></div>
        <div class="flex-1">
          <div class="skeleton skeleton-line" style="width: 40%; margin-bottom: 8px;"></div>
        </div>
      </div>
      <div class="skeleton skeleton-image" style="height: 400px;"></div>
      <div class="post-content-wrapper">
        <div class="skeleton skeleton-line" style="width: 60%; margin-bottom: 8px;"></div>
        <div class="skeleton skeleton-text" style="width: 90%;"></div>
      </div>
    `;
    feedEl.appendChild(skeleton);
  }
}
async function initFeed() {
  showSkeletonLoaders(5);
  try {
    const postsRef = ref(db, 'posts');
    const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
    const snap = await get(q);
    feedEl.innerHTML = '';
    const rows = [];
    snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
    rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
    const last = rows[rows.length-1];
    if (last) { lastTimestamp = last.timestamp; lastKey = last.key; }
    loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
    initialLoadDone = true;
    listenNew();
  } catch (e) {
    feedEl.innerHTML = '';
    console.error(e);
    toast('Error loading posts');
  }
}
function listenNew() {
  const postsRef = ref(db, 'posts');
  onChildAdded(postsRef, snap => {
    if (!initialLoadDone) return;
    const data = snap.val();
    if (!data || !data.timestamp) return;
    if (!lastTimestamp || data.timestamp > lastTimestamp) {
      feedEl.prepend(renderPostCard({key: snap.key, ...data}));
      lastTimestamp = data.timestamp;
    }
  });
}
loadMoreBtn.onclick = async () => {
  loadMoreBtn.disabled = true;
  loadMoreBtn.textContent = 'Loading...';
  const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT+1));
  const snap = await get(q);
  const rows = [];
  snap.forEach(c => rows.push({key: c.key, ...c.val()}));
  const uniq = rows.filter(p => p.key !== lastKey);
  if (!uniq.length) { toast('No more posts'); loadMoreBtn.classList.add('hidden'); return; }
  uniq.reverse();
  uniq.forEach(p => feedEl.appendChild(renderPostCard(p)));
  const last = uniq[uniq.length-1];
  lastTimestamp = last.timestamp; lastKey = last.key;
  if (uniq.length < POST_LIMIT) loadMoreBtn.classList.add('hidden');
  loadMoreBtn.disabled = false;
  loadMoreBtn.textContent = 'Load More Posts';
};
let mediaUrl = '', uploading = false;
function toggleBtn() { postBtn.disabled = uploading || (!textEl.value.trim() && !mediaUrl); }
fileInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const isVideo = file.type.startsWith('video/');
  const isImage = file.type.startsWith('image/');
  if (!isVideo && !isImage) { toast('Only images or videos'); return; }
  const r = new FileReader();
  r.onload = ev => {
    if (isVideo) {
      previewVid.src = ev.target.result;
      previewVid.classList.remove('hidden');
      previewImg.classList.add('hidden');
    } else {
      previewImg.src = ev.target.result;
      previewImg.classList.remove('hidden');
      previewVid.classList.add('hidden');
    }
  };
  r.readAsDataURL(file);
  uploadToCloudinary(file);
};
/* ---------- fixed avatar upload – updates BOTH Auth AND Realtime ---------- */
function uploadToCloudinary(file) {
  const CLOUD_NAME = "dqkujefxj", UPLOAD_PRESET = "banter_box";
  uploading = true; toggleBtn();
  $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(async res => {
      const newUrl = res.secure_url;
      mediaUrl = newUrl;
      toast('Media uploaded');
    })
    .catch(err => {
      toast('Upload failed');
      mediaUrl = '';
      previewImg.classList.add('hidden');
      previewVid.classList.add('hidden');
      console.error(err);
    })
    .finally(() => {
      uploading = false;
      $('#btn-spinner').classList.add('hidden');
      $('#btn-text').classList.remove('hidden');
      toggleBtn();
    });
}

// Character counter functionality
const charCounter = $('#char-counter');
textEl.addEventListener('input', () => {
  const length = textEl.value.length;
  charCounter.textContent = `${length} / 250`;
  
  if (length > 230) {
    charCounter.classList.add('warning');
    charCounter.classList.remove('error');
  } else if (length >= 250) {
    charCounter.classList.add('error');
    charCounter.classList.remove('warning');
  } else {
    charCounter.classList.remove('warning', 'error');
  }
  
  toggleBtn();
});

postBtn.onclick = async () => {
  const text = textEl.value.trim();
  if (!text && !mediaUrl) return;
  if (text.length > 250) {
    toast('Post must be 250 characters or less');
    return;
  }
  postBtn.disabled = true;
  $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
  const newRef = push(ref(db, 'posts'));
  const postData = {
    authorId: uid, authorName: uname, authorAvatar: uavatar, text, image: mediaUrl,
    verified: false, likes: 0, replies: 0, reposts: 0, timestamp: serverTimestamp()
  };
  try {
    await set(newRef, postData);
    textEl.value = ''; mediaUrl = '';
    charCounter.textContent = '0 / 250';
    charCounter.classList.remove('warning', 'error');
    previewImg.classList.add('hidden'); previewVid.classList.add('hidden');
    toggleBtn(); toast('Posted!');
  } catch (err) {
    console.error(err); toast('Error posting');
  } finally {
    $('#btn-spinner').classList.add('hidden'); $('#btn-text').classList.remove('hidden');
    postBtn.disabled = false;
  }
};
textEl.oninput = () => { textEl.style.height = 'auto'; textEl.style.height = textEl.scrollHeight + 'px'; };
/* ---------- real-time user-data helper ---------- */
const userMetaCache = new Map(); // uid → {name, avatar, verified}
function listenUserMeta(uid, card) {
  if (userMetaCache.has(uid)) return applyUserMeta(card, userMetaCache.get(uid));
  const unsub = onValue(ref(db, `users/${uid}/profile`), snap => {
    const v = snap.val() || {};
    const meta = { name: v.displayName || 'User', avatar: v.avatar || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${v.displayName || 'User'}`, verified: !!v.verified };
    userMetaCache.set(uid, meta);
    applyUserMeta(card, meta);
  });
  card._unsubUser = unsub;
}
function applyUserMeta(card, meta) {
  card.querySelector('.username').textContent = esc(meta.name);
  card.querySelector('.handle').textContent = `@${meta.name.replace(/\s/g, '').toLowerCase()}`;
  card.querySelector('.post-avatar').src = meta.avatar;
  const badge = card.querySelector('.verified-badge');
  badge.style.display = meta.verified ? 'inline' : 'none';
}

// Function to highlight hashtags and URLs
function highlightText(text) {
  // Highlight hashtags
  text = text.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>');
  // Highlight URLs
  text = text.replace(/(https?:\/\/[^\s]+)/g, '<span class="url">$1</span>');
  return text;
}

function renderPostCard(p) {
  const isMine = p.authorId === uid;
  const div = document.createElement('div');
  div.id = `post-${p.key}`;
  div.className = 'post-card';
  
  div.innerHTML = `
    <div class="post-header">
      <a href="profile.html?uid=${encodeURIComponent(p.authorId)}">
        <img src="${p.authorAvatar}" class="post-avatar">
      </a>
      <div class="user-info">
        <div class="user-meta">
          <span class="username">${esc(p.authorName)}</span>
          <span class="verified-badge material-icons text-sm" style="display:none">verified</span>
        </div>
        <span class="post-time">${timeAgo(p.timestamp)}</span>
      </div>
      <button class="post-options" data-post="${p.key}" data-action="options">
        <span class="material-icons-outlined">more_horiz</span>
      </button>
    </div>
    
    ${p.image ? mediaMarkup(p.image) : ''}
    
    <div class="post-content-wrapper">
      <div class="post-actions-bar">
        <div class="post-actions-left">
          <button class="action-btn like" data-post="${p.key}" data-action="like">
            <svg class="outline-heart" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <svg class="filled-heart hidden" width="24" height="24" viewBox="0 0 24 24" fill="#ed4956" stroke="#ed4956" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          </button>
          <button class="action-btn" data-post="${p.key}" data-action="reply">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
          </button>
          <button class="action-btn" data-post="${p.key}" data-action="share">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
        <button class="action-btn saved" data-post="${p.key}" data-action="save">
          <svg class="outline-bookmark" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          <svg class="filled-bookmark hidden" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
        </button>
      </div>
      
      <div class="post-stats" id="likes-${p.key}">${p.likes||0} likes</div>
      
      <div class="post-caption">
        <a href="profile.html?uid=${encodeURIComponent(p.authorId)}" class="username" style="margin-right: 8px;">${esc(p.authorName)}</a>
        <span class="post-text">${highlightText(esc(p.text))}</span>
      </div>
      
      <div class="view-comments" data-post="${p.key}" data-action="view-comments">
        View all ${p.replies||0} comments
      </div>
    </div>
  `;
  
  div.addEventListener('click', e => {
    if (e.target.classList.contains('post-image') || e.target.classList.contains('post-video')) {
      if (e.target.classList.contains('post-image')) {
        openImageModal(e.target.src);
      } else {
        openVideoModal(e.target.dataset.videoUrl);
      }
      return;
    }
    
    // Handle hashtag clicks
    if (e.target.classList.contains('hashtag')) {
      const hashtag = e.target.textContent.substring(1);
      toast(`Searching for #${hashtag}`);
      return;
    }
    
    // Handle URL clicks
    if (e.target.classList.contains('url')) {
      window.open(e.target.textContent, '_blank');
      return;
    }
    
    const action = e.target.closest('[data-action]')?.dataset.action;
    const postId = e.target.closest('[data-post]')?.dataset.post;
    if (!action || !postId) return;
    e.stopPropagation();
    
    if (action === 'reply' || action === 'view-comments') openComments(postId);
    if (action === 'like') toggleLike(postId);
    if (action === 'share') navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
    if (action === 'save') toggleSave(postId);
    if (action === 'options' && isMine) confirmDelete(postId);
  });
  
  listenCounters(p.key);
  listenUserMeta(p.authorId, div);
  return div;
}
function mediaMarkup(url) {
  if (!url) return '';
  const isVideo = url.includes('/video/upload') || url.endsWith('.mp4');
  if (isVideo) {
    return `
      <div class="post-video-wrapper">
        <video class="post-media post-video" muted loop playsinline data-video-url="${url}">
          <source src="${url}" type="video/mp4">
        </video>
        <div class="video-play-overlay">
          <span class="material-icons">play_circle_filled</span>
        </div>
      </div>`;
  }
  return `<img class="post-media post-image" src="${url}" loading="lazy">`;
}
function listenCounters(postId) {
  onValue(ref(db, `likes/${postId}`), s => {
    const likes = s.size;
    $('#likes-'+postId).textContent = `${likes} like${likes !== 1 ? 's' : ''}`;
    const btn = document.querySelector(`[data-post="${postId}"].like`);
    if (btn) btn.classList.toggle('liked', s.hasChild(uid));
  });
  onValue(ref(db, `comments/${postId}`), s => {
    const comments = s.size;
    const viewComments = document.querySelector(`[data-post="${postId}"].view-comments`);
    if (viewComments) {
      viewComments.textContent = comments > 0 ? `View all ${comments} comment${comments !== 1 ? 's' : ''}` : 'No comments yet';
    }
  });
  onValue(ref(db, `saves/${postId}/${uid}`), s => {
    const btn = document.querySelector(`[data-post="${postId}"].saved`);
    if (btn) btn.classList.toggle('saved', s.exists());
  });
}
async function toggleLike(postId) {
  const likeRef = ref(db, `likes/${postId}/${uid}`);
  const snap = await get(likeRef);
  if (snap.exists()) await remove(likeRef);
  else await set(likeRef, true);
}
async function toggleSave(postId) {
  const saveRef = ref(db, `saves/${postId}/${uid}`);
  const snap = await get(saveRef);
  if (snap.exists()) await remove(saveRef);
  else await set(saveRef, true);
}
async function doRepost(postId) {
  const orig = (await get(ref(db, `posts/${postId}`))).val();
  if (!orig) return;
  const newRef = push(ref(db, 'posts'));
  await set(newRef, {
    authorId: uid, authorName: uname, authorAvatar: uavatar,
    text: orig.text, image: orig.image, verified: false,
    repostOf: {authorName: orig.authorName, key: postId},
    likes: 0, replies: 0, reposts: 0, timestamp: Date.now()
  });
  toast('Re-posted');
}
let currentPostId = null, commentsListener = null;
const commentOverlay = $('#comment-sheet-overlay'),
      commentList = $('#comment-sheet-list'),
      commentInput = $('#comment-input'),
      commentSendBtn = $('#comment-send-btn');
function openComments(postId) {
  currentPostId = postId;
  commentInput.value = '';
  delete commentInput.dataset.parent;
  commentInput.placeholder = 'Write a comment...';
  commentList.innerHTML = '<div class="skeleton-post"><div class="flex gap-3"><div class="skeleton skeleton-avatar"></div><div class="flex-1"><div class="skeleton skeleton-line" style="width:60%"></div><div class="skeleton skeleton-text" style="width:90%"></div></div></div></div>'.repeat(3);
  commentOverlay.classList.add('show');
  if (commentsListener) commentsListener();
  commentsListener = onValue(ref(db, `comments/${postId}`), snap => {
    commentList.innerHTML = '';
    if (!snap.exists()) { commentList.innerHTML = '<div class="p-4 text-sm text-gray-500">No comments yet</div>'; return; }
    snap.forEach(c => {
      const v = c.val(), cid = c.key;
      const isMine = v.authorId === uid;
      const d = document.createElement('div'); d.className = 'comment-item';
      d.innerHTML = `
        <img src="${v.authorAvatar}" class="comment-avatar">
        <div class="comment-body flex-1">
          <div class="comment-name">${esc(v.authorName)}</div>
          <div class="comment-text">${highlightText(esc(v.text))}</div>
          <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
            <button class="comment-like-btn flex items-center gap-1" data-post="${postId}" data-cid="${cid}">
              <svg class="outline-heart" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              <svg class="filled-heart hidden" width="16" height="16" fill="#f91880" stroke="#f91880" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              <span class="comment-like-count">0</span>
            </button>
            <button class="comment-reply-btn flex items-center gap-1" data-post="${postId}" data-cid="${cid}">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
              <span>Reply</span>
            </button>
            ${isMine ? `
            <button class="comment-delete-btn text-red-500" data-post="${postId}" data-cid="${cid}">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </button>` : ''}
          </div>
        </div>`;
      commentList.appendChild(d);
      listenCommentLikes(postId, cid);
    });
  });
}
$('#comment-sheet-close').onclick = closeComments;
commentOverlay.onclick = e => { if (e.target === commentOverlay) closeComments(); };
function closeComments() {
  commentOverlay.classList.remove('show');
  if (commentsListener) { commentsListener(); commentsListener = null; }
  currentPostId = null;
}
commentSendBtn.onclick = async () => {
  const text = commentInput.value.trim();
  if (!text || !currentPostId) return;
  if (text.length > 250) {
    toast('Comment must be 250 characters or less');
    return;
  }
  const parentId = commentInput.dataset.parent || null;
  await set(push(ref(db, `comments/${currentPostId}`)), {
    authorId: uid, authorName: uname, authorAvatar: uavatar, text, parentId, timestamp: Date.now()
  });
  commentInput.value = '';
  delete commentInput.dataset.parent;
  commentInput.placeholder = 'Write a comment...';
  toast('Comment posted');
};
commentInput.oninput = () => commentSendBtn.disabled = !commentInput.value.trim();
function listenCommentLikes(pid, cid) {
  const likeRef = ref(db, `comments/${pid}/${cid}/likes`);
  onValue(likeRef, snap => {
    const cnt = snap.size, liked = snap.hasChild(uid);
    const btn = document.querySelector(`.comment-like-btn[data-cid="${cid}"]`);
    if (!btn) return;
    btn.querySelector('.comment-like-count').textContent = cnt || '';
    btn.classList.toggle('liked', liked);
    btn.querySelector('.outline-heart').style.display = liked ? 'none' : 'inline';
    btn.querySelector('.filled-heart').style.display = liked ? 'inline' : 'none';
  });
}
async function toggleCommentLike(pid, cid) {
  const likeRef = ref(db, `comments/${pid}/${cid}/likes/${uid}`);
  const snap = await get(likeRef);
  if (snap.exists()) await remove(likeRef);
  else await set(likeRef, true);
}
async function deleteComment(pid, cid) {
  await remove(ref(db, `comments/${pid}/${cid}`));
  toast('Comment deleted');
}
commentList.addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const pid = btn.dataset.post, cid = btn.dataset.cid;
  if (btn.classList.contains('comment-like-btn')) toggleCommentLike(pid, cid);
  if (btn.classList.contains('comment-delete-btn')) deleteComment(pid, cid);
  if (btn.classList.contains('comment-reply-btn')) openCommentReply(pid, cid);
});
function openCommentReply(postId, commentId) {
  openComments(postId);
  commentInput.dataset.parent = commentId;
  commentInput.placeholder = 'Replying to comment…';
}
let deleteKeyStore = null;
const alertOverlay = $('#custom-alert-overlay'), alertTitle = $('#custom-alert-title'),
      alertMessage = $('#custom-alert-message'), alertCancel = $('#custom-alert-cancel'), alertConfirm = $('#custom-alert-confirm');
function confirmDelete(key) {
  deleteKeyStore = key;
  alertTitle.textContent = 'Delete Post';
  alertMessage.textContent = 'Are you sure you want to delete this post?';
  alertOverlay.classList.add('show');
}
alertCancel.onclick = () => { deleteKeyStore = null; alertOverlay.classList.remove('show'); };
alertConfirm.onclick = async () => {
  if (!deleteKeyStore) return;
  const key = deleteKeyStore; deleteKeyStore = null; alertOverlay.classList.remove('show');
  try {
    await remove(ref(db, `posts/${key}`));
    const postElement = document.getElementById(`post-${key}`);
    if (postElement) {
      postElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      postElement.style.opacity = '0'; postElement.style.transform = 'translateY(-10px)';
      setTimeout(() => postElement.remove(), 320);
    }
    toast('Deleted');
  } catch {
    toast('Error deleting');
  }
};
function openImageModal(src) {
  const modal = $('#image-modal');
  const img = $('#modal-image');
  const video = $('#modal-video');
  const controls = $('#video-controls');
 
  img.src = src;
  img.style.display = 'block';
  video.style.display = 'none';
  video.classList.remove('show');
  controls.style.display = 'none';
  modal.classList.add('show');
}
function openVideoModal(src) {
  const modal = $('#image-modal');
  const img = $('#modal-image');
  const video = $('#modal-video');
  const controls = $('#video-controls');
 
  img.style.display = 'none';
  video.querySelector('source').src = src;
  video.load();
  video.style.display = 'block';
  video.classList.add('show');
  controls.style.display = 'flex';
  modal.classList.add('show');
 
  initVideoControls();
}
function initVideoControls() {
  const video = $('#modal-video');
  const playPauseBtn = $('#play-pause-btn');
  const muteBtn = $('#mute-btn');
  const videoTime = $('#video-time');
  const videoProgress = $('#video-progress');
  const videoProgressBar = $('#video-progress-bar');
 
  playPauseBtn.onclick = (e) => {
    e.stopPropagation();
    if (video.paused) {
      video.play();
      playPauseBtn.innerHTML = '<span class="material-icons-outlined">pause</span>';
    } else {
      video.pause();
      playPauseBtn.innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
    }
  };
 
  muteBtn.onclick = (e) => {
    e.stopPropagation();
    video.muted = !video.muted;
    muteBtn.innerHTML = video.muted ?
      '<span class="material-icons-outlined">volume_off</span>' :
      '<span class="material-icons-outlined">volume_up</span>';
  };
 
  video.ontimeupdate = () => {
    const progress = (video.currentTime / video.duration) * 100;
    videoProgressBar.style.width = progress + '%';
    videoTime.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
  };
 
  videoProgress.onclick = (e) => {
    e.stopPropagation();
    const rect = videoProgress.getBoundingClientRect();
    const pos = (e.clientX - rect.left) / rect.width;
    video.currentTime = pos * video.duration;
  };
 
  video.play();
  playPauseBtn.innerHTML = '<span class="material-icons-outlined">pause</span>';
}
function formatTime(seconds) {
  if (isNaN(seconds)) return '0:00';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}
window.closeImageModal = function() {
  const modal = $('#image-modal');
  const video = $('#modal-video');
  video.pause();
  video.currentTime = 0;
  modal.classList.remove('show');
};
$('#image-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeImageModal();
  }
});
function toast(msg) {
  const t = document.createElement('div'); t.className = 'custom-toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
}
const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
const timeAgo = ts => {
  if (!ts) return 'now';
  const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
};
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const currentPage = location.pathname.split('/').pop() || 'feed.html';
  document.querySelectorAll('nav a').forEach(link => {
    if (link.getAttribute('href') === currentPage) {
      link.classList.add('text-[#ff2a6d]');
      const icon = link.querySelector('span.material-icons-outlined');
      if (icon) icon.classList.replace('material-icons-outlined', 'material-icons');
    }
  });
});

// Navbar hide/show functionality
let lastScrollTop = 0;
let scrollTimeout;
const navbar = document.getElementById('navbar');
const fab = document.getElementById('fab');

window.addEventListener('scroll', () => {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  // Clear the timeout
  clearTimeout(scrollTimeout);
  
  // Show navbar and FAB when scrolling up
  if (scrollTop < lastScrollTop || scrollTop < 100) {
    navbar.classList.remove('hidden');
    fab.classList.remove('hidden');
  } else {
    // Hide navbar and FAB when scrolling down
    navbar.classList.add('hidden');
    fab.classList.add('hidden');
  }
  
  lastScrollTop = scrollTop;
  
  // Show navbar after scroll stops
  scrollTimeout = setTimeout(() => {
    navbar.classList.remove('hidden');
    fab.classList.remove('hidden');
  }, 1000);
});

// FAB functionality
fab.addEventListener('click', () => {
  document.getElementById('post-text').focus();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('pwa-install-banner').classList.remove('-translate-y-full');
});
document.getElementById('pwa-install-btn')?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('pwa-install-banner').classList.add('-translate-y-full');
});
document.getElementById('pwa-install-close')?.addEventListener('click', () => {
  document.getElementById('pwa-install-banner').classList.add('-translate-y-full');
});
</script>
</body>
</html>
