<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics-compat.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Chirp:wght@400;700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000;--card:#16181c;--text:#fff;--text2:#71767b;--border:#2f3336;--blue:#1d9bf0;--glow:0 0 15px rgba(29,155,240,.6);}
    body.light{--bg:#fff;--card:#f7f9fa;--text:#000;--text2:#536471;--border:#e1e8ed;}
    body{font-family:'Chirp',system-ui;background:var(--bg);color:var(--text);margin:0;overflow-x:hidden;user-select:none;}
    .header{position:fixed;top:0;left:0;right:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:100;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;height:64px;box-shadow:0 1px 3px rgba(0,0,0,.3);}
    .logo{display:flex;align-items:center;gap:10px;font-weight:900;font-size:26px;color:var(--blue);cursor:pointer;}
    .main{padding:80px 16px 120px;max-width:600px;margin:0 auto;}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0;z-index:100;backdrop-filter:blur(20px);}
    .nav-item{padding:10px;border-radius:50%;min-width:56px;position:relative;transition:all .2s;}
    .nav-item.active{color:var(--blue);}
    .nav-item.active::after{content:'';position:absolute;inset:0;background:var(--blue);border-radius:50%;opacity:.15;}
    .fab{position:fixed;bottom:90px;right:20px;width:56px;height:56px;background:var(--blue);color:#000;border:none;border-radius:50%;font-size:28px;box-shadow:var(--glow),0 4px 20px rgba(0,0,0,.4);z-index:200;}
    .post{background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:16px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.2);}
    .post-header{padding:12px 16px;display:flex;gap:12px;}
    .avatar{width:44px;height:44px;border-radius:50%;background:var(--blue);color:#000;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;}
    .name{font-weight:700;font-size:15px;display:flex;align-items:center;gap:6px;}
    .verified{color:#1d9bf0;}
    .content{padding:0 16px 12px;font-size:15.5px;line-height:1.5;white-space:pre-wrap;}
    .media{max-width:100%;border-radius:12px;margin:8px 0;}
    .actions{padding:8px 16px;display:flex;justify-content:space-between;color:var(--text2);font-size:14px;}
    .actions span{display:flex;align-items:center;gap:8px;cursor:pointer;}
    .actions span:hover{color:var(--blue);}
    .spinner{position:fixed;top:0;left:0;right:0;height:3px;background:var(--blue);transform:scaleX(0);transform-origin:left;transition:transform .4s;z-index:101;}
    .spinner.active{transform:scaleX(1);}
    .alert{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--blue);color:#000;padding:12px 28px;border-radius:99px;z-index:1000;font-weight:700;animation:pop .3s;}
    @keyframes pop{0%{transform:translateX(-50%) scale(0)}100%{transform:translateX(-50%) scale(1)}}
    .sheet{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top-left-radius:32px;border-top-right-radius:32px;max-height:90vh;overflow-y:auto;transform:translateY(100%);transition:transform .4s cubic-bezier(0.25,0.46,0.45,0.94);z-index:1000;}
    .sheet.active{transform:translateY(0);}
    .sheet-header{padding:20px 24px;border-bottom:1px solid var(--border);font-size:20px;font-weight:800;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card);z-index:10;}
    video{width:100%;border-radius:12px;background:#000;}
    .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);border-radius:12px;}
    .play-btn{width:70px;height:70px;background:rgba(255,255,255,.9);color:#000;border-radius:50%;font-size:36px;display:flex;align-items:center;justify-content:center;}
    @media(min-width:1024px){.bottom-nav{display:none;}.main{max-width:600px;margin:0 auto;padding-top:100px;}}
  </style>
</head>
<body class="dark">

  <!-- Header -->
  <header class="header">
    <div class="logo" onclick="toggleSlide()">
      <svg width="32" height="32" viewBox="0 0 36 36"><rect x="4" y="4" width="28" height="28" rx="10" fill="#000"/><path d="M29.75 8.25h4.5L18 33.75h-4.5L2.25 8.25h4.5l9 20.19L29.75 8.25Z" fill="#fff"/></svg>
      <span>Vynix</span>
    </div>
    <button onclick="toggleDarkMode()" class="text-2xl">Dark Mode</button>
  </header>

  <!-- Spinner -->
  <div class="spinner" id="spinner"></div>

  <!-- Main Feed -->
  <main class="main" id="feed"></main>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <button class="nav-item active"><span class="material-icons text-2xl">home</span></button>
    <button class="nav-item" onclick="openSearch()"><span class="material-icons text-2xl">search</span></button>
    <button class="nav-item" onclick="location.href='friends.html'"><span class="material-icons text-2xl">chat</span></button>
    <button class="nav-item"><span class="material-icons text-2xl">notifications</span></button>
    <button class="nav-item" onclick="location.href='ai.html'">
      <svg width="28" height="28" viewBox="0 0 28 28"><rect x="2" y="2" width="24" height="24" rx="8" fill="white"/><path d="M22.75 5.25h3L14 24.75h-3L2.25 5.25h3l7.5 17.19L22.75 5.25Z" fill="black"/></svg>
    </button>
    <button class="nav-item" onclick="openSettings()"><span class="material-icons text-2xl">settings</span></button>
  </nav>

  <!-- FAB -->
  <button class="fab" onclick="openComposer()">Edit</button>

  <!-- Composer Sheet -->
  <div class="sheet" id="composer">
    <div class="sheet-header">
      <span>Create Post</span>
      <button onclick="closeComposer()" class="text-3xl">Close</button>
    </div>
    <div class="p-6">
      <textarea id="post-text" placeholder="What's happening?" class="w-full p-4 bg-transparent border border-gray-700 rounded-2xl text-lg resize-none h-32 mb-4"></textarea>
      <div id="media-preview" class="mb-4"></div>
      <input type="file" id="media-input" accept="image/*,video/*" hidden onchange="previewMedia(this)">
      <div class="flex gap-4 mb-4">
        <button onclick="document.getElementById('media-input').click()" class="flex-1 py-4 bg-gray-800 rounded-2xl flex items-center justify-center gap-3">
          <span class="material-icons">photo</span> Photo/Video
        </button>
      </div>
      <button onclick="publishPost()" class="w-full py-4 bg-blue-500 text-black font-bold rounded-2xl text-lg">Post</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js';
    import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js';

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;
    let lastKey = null;

    const spinner = document.getElementById('spinner');
    const feed = document.getElementById('feed');

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (!user) location.href = 'signup.html';
      else loadPosts();
    });

    window.toggleDarkMode = () => {
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    };

    window.openComposer = () => document.getElementById('composer').classList.add('active');
    window.closeComposer = () => document.getElementById('composer').classList.remove('active');

    window.previewMedia = (input) => {
      const file = input.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const preview = document.getElementById('media-preview');
      if (file.type.startsWith('video')) {
        preview.innerHTML = `<div class="relative"><video src="${url}" controls class="media"></video><div class="play-overlay"><button class="play-btn">Play</button></div></div>`;
      } else {
        preview.innerHTML = `<img src="${url}" class="media">`;
      }
    };

    window.publishPost = async () => {
      const text = document.getElementById('post-text').value.trim();
      const file = document.getElementById('media-input').files[0];
      if (!text && !file) return alert('Add something');

      spinner.classList.add('active');
      const postRef = push(ref(db, 'statuses'));
      const post = {
        userId: currentUser.uid,
        userName: currentUser.displayName || "User",
        content: text,
        timestamp: Date.now(),
        likes: 0,
        comments: 0
      };

      if (file) {
        const url = await uploadToCloudinary(file);
        post.mediaUrl = url;
        post.type = file.type.startsWith('video') ? 'video' : 'image';
      }

      await set(postRef, post);
      spinner.classList.remove('active');
      closeComposer();
      document.getElementById('post-text').value = '';
      document.getElementById('media-preview').innerHTML = '';
      document.getElementById('media-input').value = '';
      alert('Posted!');
      loadPosts(true);
    };

    async function uploadToCloudinary(file) {
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', 'vynix');
      const res = await fetch('https://api.cloudinary.com/v1_1/dqkujefxj/auto/upload', {
        method: 'POST',
        body: form
      });
      const data = await res.json();
      return data.secure_url;
    }

    async function loadPosts(reset = false) {
      if (reset) {
        feed.innerHTML = '';
        lastKey = null;
      }

      const q = lastKey
        ? query(ref(db, 'statuses'), orderByChild('timestamp'), limitToLast(10))
        : query(ref(db, 'statuses'), orderByChild('timestamp'), limitToLast(10));

      const snap = await get(q);
      if (!snap.exists()) return;

      const posts = Object.entries(snap.val()).reverse();
      posts.forEach(([id, post]) => renderPost(id, post));
      lastKey = posts[posts.length-1][1].timestamp;
    }

    function renderPost(id, post) {
      const div = document.createElement('div');
      div.className = 'post';
      const media = post.mediaUrl ? (
        post.type === 'video'
          ? `<div class="relative"><video src="${post.mediaUrl}" controls class="media"></video></div>`
          : `<img src="${post.mediaUrl}" class="media">`
      ) : '';

      div.innerHTML = `
        <div class="post-header">
          <div class="avatar">V</div>
          <div>
            <div class="name">${escapeHtml(post.userName || "User")}</div>
            <div style="font-size:13px;color:var(--text2)">Just now</div>
          </div>
        </div>
        ${post.content ? `<div class="content">${escapeHtml(post.content)}</div>` : ''}
        ${media}
        <div class="actions">
          <span>Heart ${post.likes || 0}</span>
          <span>Comment ${post.comments || 0}</span>
          <span>Repost 0</span>
        </div>
      `;
      feed.appendChild(div);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Infinite scroll
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
        loadPosts();
      }
    });

    // Theme persistence
    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');
  </script>
</body>
</html>
