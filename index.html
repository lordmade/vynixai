<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix â€¢ Be Real</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --blue: #1d9bf0; }
    body { font-family: 'Chirp', system-ui; background: #000; color: #fff; }
    .light { background: #fff; color: #000; }
    .post { background: #16181c; border: 1px solid #2f3336; border-radius: 16px; }
    .light .post { background: #fff; border-color: #e1e8ed; }
    #toast { @apply fixed bottom-20 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full z-50 opacity-0 transition; }
    #toast.show { opacity: 1; }
    .spinner { @apply fixed top-0 left-0 right-0 h-1 bg-transparent overflow-hidden z-50; }
    .spinner::after { content: ''; @apply absolute inset-0 bg-blue-500; animation: loading 2s linear infinite; }
    @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  </style>
</head>
<body class="min-h-screen pb-20">

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 bg-black/90 backdrop-blur z-40 border-b border-gray-800 flex items-center justify-between px-4 py-3">
    <h1 class="text-2xl font-bold">Vynix</h1>
    <button onclick="toggleTheme()" class="text-2xl">Dark/Light</button>
  </header>

  <!-- Spinner -->
  <div id="spinner" class="spinner hidden"><div></div></div>

  <!-- Feed -->
  <main class="pt-16" id="feed">Loading posts...</main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-black border-t border-gray-800 flex justify-around py-3 z-40">
    <button onclick="switchTab('home')" id="nav-home" class="text-3xl text-blue-500">Home</button>
    <button onclick="openSearch()" class="text-3xl">Search</button>
    <button onclick="openPost()" class="text-4xl">Post</button>
    <button onclick="switchTab('notifications')" id="nav-notif" class="text-3xl">Notifications</button>
    <button onclick="switchTab('profile')" id="nav-profile" class="text-3xl">Profile</button>
  </nav>

  <!-- Post Modal -->
  <div id="post-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-3xl w-full max-w-lg">
      <div class="flex justify-between p-4 border-b border-gray-700">
        <button onclick="closePost()" class="text-3xl">Ã—</button>
        <button onclick="submitPost()" class="bg-blue-500 px-6 py-2 rounded-full font-bold">Post</button>
      </div>
      <textarea id="post-text" placeholder="What's happening?" class="w-full p-6 text-xl bg-transparent outline-none resize-none" rows="5"></textarea>
      <input type="file" id="post-media" accept="image/*,video/*" class="p-4">
      <div id="media-preview" class="p-4"></div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="search-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col">
    <div class="p-4 border-b border-gray-800">
      <input type="text" id="search-input" placeholder="Search Vynix" class="w-full bg-gray-900 rounded-full px-6 py-4 text-white outline-none" oninput="doSearch(this.value)">
      <button onclick="closeSearch()" class="absolute right-6 top-6 text-3xl">Ã—</button>
    </div>
    <div id="search-results" class="flex-1 overflow-y-auto p-4"></div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, push, update, remove, increment } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    let currentUser = null;
    let currentUserData = {};

    const $ = s => document.querySelector(s);
    const toast = msg => {
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 3000);
    };

    // Theme
    window.toggleTheme = () => {
      document.documentElement.classList.toggle("light");
      localStorage.setItem("theme", document.documentElement.classList.contains("light") ? "light" : "dark");
    };

    if (localStorage.getItem("theme") === "light") document.documentElement.classList.add("light");

    // Auth
    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user) {
        const snap = await get(ref(db, `users/${user.uid}`));
        currentUserData = snap.val() || { displayName: user.email.split("@")[0] };
        loadFeed();
        loadNotifications();
      } else {
        location.href = "login.html";
      }
    });

    // Real-time Feed
    window.loadFeed = () => {
      $("#feed").innerHTML = "<div class='p-10 text-center text-gray-500'>Loading...</div>";
      $("#spinner").classList.remove("hidden");

      onValue(ref(db, 'statuses'), async snap => {
        const posts = [];
        snap.forEach(child => {
          const p = child.val();
          p.id = child.key;
          posts.push(p);
        });
        posts.sort((a, b) => b.timestamp - a.timestamp);

        $("#feed").innerHTML = await Promise.all(posts.map(async post => {
          const userSnap = await get(ref(db, `users/${post.userId}`));
          const user = userSnap.val() || { displayName: "User" };
          const liked = post.likes?.[currentUser.uid];
          const reposted = post.reposts?.[currentUser.uid];

          return `
            <article class="post p-4 mb-4" data-id="\( {post.id}" onclick="navigateToPost(' \){post.id}')">
              <div class="flex gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl font-bold">
                  ${user.displayName[0]}
                </div>
                <div class="flex-1">
                  <div class="font-bold">${user.displayName}</div>
                  <div class="text-gray-500 text-sm">@${user.username || 'user'}</div>
                </div>
              </div>
              <div class="mt-3 text-lg">${post.content || ''}</div>
              \( {post.mediaURL ? `<img src=" \){post.mediaURL}" class="mt-3 rounded-2xl max-h-96 w-full object-cover">` : ''}
              <div class="flex justify-between mt-4 text-2xl">
                <button onclick="event.stopPropagation(); toggleLike('\( {post.id}')"> \){liked ? 'â™¥' : 'â™¡'}</button>
                <button onclick="event.stopPropagation(); repost('\( {post.id}')"> \){reposted ? 'â†»' : 'â†»'}</button>
                <button onclick="event.stopPropagation(); openComments('${post.id}')">ðŸ’¬</button>
                <button onclick="event.stopPropagation(); bookmark('${post.id}')">ðŸ”–</button>
              </div>
            </article>
          `;
        })).then(html => html.join(''));

        $("#spinner").classList.add("hidden");
      });
    };

    // Navigate to post (FIXED)
    window.navigateToPost = async (id) => {
      switchTab('home');
      await new Promise(r => setTimeout(r, 500));
      const el = document.querySelector(`[data-id="${id}"]`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.background = 'rgba(29, 155, 240, 0.2)';
        setTimeout(() => el.style.background = '', 3000);
      }
    };

    // Search
    window.openSearch = () => $("#search-modal").classList.remove("hidden");
    window.closeSearch = () => $("#search-modal").classList.add("hidden");
    window.doSearch = async (q) => {
      if (!q.trim()) return $("#search-results").innerHTML = "";
      const snap = await get(ref(db, 'statuses'));
      const results = [];
      snap.forEach(child => {
        const p = child.val();
        if (p.content?.toLowerCase().includes(q.toLowerCase())) {
          results.push({ id: child.key, ...p });
        }
      });
      $("#search-results").innerHTML = results.map(p => `
        <div class="p-4 border-b border-gray-800" onclick="navigateToPost('${p.id}'); closeSearch()">
          <strong>${p.content.substring(0, 60)}...</strong>
        </div>
      `).join('');
    };

    // Post
    window.openPost = () => $("#post-modal").classList.remove("hidden");
    window.closePost = () => $("#post-modal").classList.add("hidden");
    window.submitPost = async () => {
      const text = $("#post-text").value.trim();
      const file = $("#post-media").files[0];
      if (!text && !file) return toast("Add text or media");

      let mediaURL = "";
      if (file) {
        const storageRef = sRef(storage, `posts/\( {Date.now()}_ \){file.name}`);
        await uploadBytes(storageRef, file);
        mediaURL = await getDownloadURL(storageRef);
      }

      const postRef = push(ref(db, 'statuses'));
      await set(postRef, {
        userId: currentUser.uid,
        content: text,
        mediaURL,
        timestamp: Date.now(),
        likes: {},
        reposts: {}
      });

      closePost();
      $("#post-text").value = "";
      $("#post-media").value = "";
      toast("Posted!");
    };

    // Actions
    window.toggleLike = async (id) => {
      const likeRef = ref(db, `statuses/\( {id}/likes/ \){currentUser.uid}`);
      const snap = await get(likeRef);
      if (snap.exists()) {
        await remove(likeRef);
      } else {
        await set(likeRef, true);
        // Notify
        push(ref(db, `users/\( {(await get(ref(db, `statuses/ \){id}`))).val().userId}/notifications`), {
          type: "like",
          from: currentUser.uid,
          postId: id,
          timestamp: Date.now()
        });
      }
    };

    window.repost = async (id) => {
      const repostRef = ref(db, `statuses/\( {id}/reposts/ \){currentUser.uid}`);
      const snap = await get(repostRef);
      if (snap.exists()) {
        await remove(repostRef);
      } else {
        await set(repostRef, true);
        toast("Reposted!");
      }
    };

    window.openComments = (id) => toast("Comments coming soon!");
    window.bookmark = (id) => toast("Saved!");

    // Tabs
    window.switchTab = (tab) => {
      $$(".nav-btn").forEach(b => b.classList.remove("text-blue-500"));
      \( (`#nav- \){tab}`).classList.add("text-blue-500");
      if (tab === "home") loadFeed();
      if (tab === "notifications") loadNotifications();
    };

    window.loadNotifications = () => {
      $("#feed").innerHTML = "<div class='p-10 text-center'>Notifications coming soon</div>";
    };

    loadFeed();
  </script>
</body>
</html>
