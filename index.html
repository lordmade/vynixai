<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#0f0f14"/>
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f0f14"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="description" content="Vynix â€¢ Premium Immersive Music Experience"/>
  <title>Vynix â€¢ Music</title>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" type="image/png" sizes="192x192" href="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png"/>
  <link rel="apple-touch-icon" sizes="192x192" href="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png"/>
  <link rel="apple-touch-icon" sizes="512x512" href="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg-main: #fafafa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f0f0f5;
      --surface: #ffffff;
      --surface-hover: #f5f5fa;
      --accent: #7c3aed;
      --accent-light: #8b5cf6;
      --accent-dark: #6d28d9;
      --accent-glow: rgba(124, 58, 237, 0.18);
      --text-primary: #1a1a1a;
      --text-secondary: #4b5563;
      --text-muted: #9ca3af;
      --border-subtle: rgba(0, 0, 0, 0.08);
      --border-strong: rgba(0, 0, 0, 0.15);
      --radius-s: 12px;
      --radius-m: 20px;
      --radius-l: 28px;
      --radius-xl: 36px;
      --header-height: 74px;
      --player-mini: 86px;
      --transition: all 0.42s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; }
    body { background:var(--bg-main); color:var(--text-primary); font-family:'Inter',system-ui,sans-serif; height:100dvh; overflow:hidden; display:flex; touch-action:manipulation; }
    .hidden { display:none !important; }
    .glass { background:rgba(255,255,255,0.92); backdrop-filter:saturate(180%) blur(24px); -webkit-backdrop-filter:saturate(180%) blur(24px); border:1px solid var(--border-subtle); box-shadow:0 8px 32px rgba(0,0,0,0.08); }
    .default-cover { background:linear-gradient(135deg,#a78bfa,#7c3aed,#6d28d9); color:white; display:flex; align-items:center; justify-content:center; font-size:2.8rem; font-weight:bold; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px); z-index:6000; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.4s ease; }
    .modal-overlay.show { opacity:1; pointer-events:all; }
    .modal-content { background:var(--surface); border-radius:var(--radius-l); width:90%; max-width:420px; padding:2.2rem; box-shadow:0 24px 60px rgba(0,0,0,0.12); transform:scale(0.92); opacity:0; transition:var(--transition); }
    .modal-overlay.show .modal-content { transform:scale(1); opacity:1; }
    .modal-title { font-size:1.8rem; font-weight:800; margin-bottom:1.2rem; background:linear-gradient(90deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .modal-input { width:100%; padding:1.1rem 1.4rem; background:var(--bg-tertiary); border:1px solid var(--border-subtle); border-radius:var(--radius-s); color:var(--text-primary); font-size:1rem; margin-bottom:1.4rem; transition:all 0.3s ease; }
    .modal-input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 4px rgba(124,58,237,0.22); }
    .btn { padding:1rem 1.8rem; border-radius:999px; font-weight:700; font-size:0.98rem; cursor:pointer; border:none; transition:all 0.32s ease; }
    .btn-primary { background:var(--accent); color:white; }
    .btn-primary:hover { background:var(--accent-light); transform:translateY(-2px); }
    .btn-secondary { background:rgba(0,0,0,0.08); color:var(--text-primary); }
    .search-box { background:rgba(0,0,0,0.04); border-radius:999px; padding:0.9rem 3.4rem 0.9rem 1.3rem; display:flex; align-items:center; gap:0.9rem; border:1px solid var(--border-subtle); transition:all 0.35s ease; }
    .search-box:focus-within { background:rgba(0,0,0,0.08); border-color:var(--accent); box-shadow:0 0 0 4px rgba(124,58,237,0.22); }
    .search-box input { background:transparent; border:none; color:var(--text-primary); width:100%; font-weight:500; font-size:0.98rem; }
    .sidebar { width:300px; background:var(--bg-secondary); box-shadow:4px 0 40px rgba(0,0,0,0.08); padding:1.8rem; transition:transform 0.52s cubic-bezier(0.32,0.72,0.2,1); display:flex; flex-direction:column; position:fixed; left:0; top:0; height:100dvh; z-index:400; transform:translateX(-100%); overflow-y:auto; padding-top:calc(var(--header-height)+1.6rem); }
    .sidebar.open { transform:translateX(0); }
    .logo { font-size:2.6rem; font-weight:900; letter-spacing:-1.8px; background:linear-gradient(90deg,#7c3aed,#8b5cf6,#a78bfa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:3.2rem; padding-left:4px; }
    .nav-item { display:flex; align-items:center; gap:1.2rem; padding:1.2rem 1.4rem; margin:6px 0; color:var(--text-secondary); border-radius:var(--radius-m); cursor:pointer; font-weight:600; font-size:1.05rem; transition:all 0.38s ease; }
    .nav-item:hover { background:rgba(124,58,237,0.12); color:var(--text-primary); transform:translateX(8px); }
    .nav-item.active { background:linear-gradient(90deg,rgba(124,58,237,0.18),rgba(139,92,246,0.12)); color:var(--text-primary); box-shadow:0 0 0 2px rgba(124,58,237,0.25); }
    .drawer-scrim { position:fixed; inset:0; background:rgba(0,0,0,0.3); backdrop-filter:blur(8px); z-index:399; opacity:0; pointer-events:none; transition:opacity 0.52s ease; }
    .drawer-scrim.show { opacity:1; pointer-events:all; }
    .main-view { flex:1; overflow-y:auto; background:linear-gradient(to bottom,var(--bg-main),var(--bg-secondary)); -webkit-overflow-scrolling:touch; padding-bottom:calc(var(--player-mini)+90px); }
    .top-header-container { position:fixed; top:0; left:0; right:0; z-index:1000; background:rgba(255,255,255,0.9); backdrop-filter:blur(20px); border-bottom:1px solid var(--border-subtle); }
    .top-header { display:flex; align-items:center; padding:1.2rem 1.6rem; height:var(--header-height); gap:1.2rem; }
    .menu-toggle { width:48px; height:48px; border-radius:50%; background:rgba(0,0,0,0.06); color:var(--text-primary); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.3s ease; }
    .menu-toggle:active { transform:scale(0.92); }
    .section-title { font-size:1.9rem; font-weight:800; margin:2.2rem 0 1.4rem; padding:0 1.6rem; }
    .track-card { min-width:168px; width:168px; background:var(--surface); border-radius:var(--radius-l); overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.08); transition:var(--transition); }
    .track-card:hover { transform:translateY(-14px) scale(1.05); box-shadow:0 28px 60px rgba(124,58,237,0.15); }
    .card-img-wrap { position:relative; aspect-ratio:1; overflow:hidden; }
    .card-img-wrap img { width:100%; height:100%; object-fit:cover; transition:transform 0.7s cubic-bezier(0.34,1.56,0.64,1); }
    .track-card:hover img { transform:scale(1.16) rotate(3deg); }
    .play-overlay { position:absolute; inset:0; background:rgba(124,58,237,0.42); opacity:0; transition:opacity 0.4s ease; display:flex; align-items:center; justify-content:center; }
    .track-card:hover .play-overlay { opacity:1; }
    .song-row { display:flex; align-items:center; gap:1.2rem; padding:1.1rem 1.6rem; border-radius:var(--radius-m); background:var(--surface); margin:8px 1.6rem; transition:all 0.36s ease; }
    .song-row:hover { background:rgba(124,58,237,0.08); transform:translateX(6px); }
    .player-bar { position:fixed; bottom:78px; left:0; right:0; z-index:200; margin:0 12px; padding:14px 18px; background:linear-gradient(to bottom,rgba(255,255,255,0.94),rgba(245,245,250,0.9)); backdrop-filter:blur(28px) saturate(180%); border-radius:24px 24px 0 0; border-top:1px solid var(--border-subtle); box-shadow:0 -16px 48px rgba(0,0,0,0.08); display:flex; flex-direction:column; gap:12px; transition:var(--transition); }
    .player-bar:hover { transform:translateY(-6px); }
    .track-meta { display:flex; align-items:center; gap:14px; cursor:pointer; }
    .track-meta img { width:60px; height:60px; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,0.1); }
    #pTitle { font-size:1.12rem; font-weight:700; line-height:1.3; }
    #pArtist { font-size:0.92rem; color:var(--text-secondary); margin-top:4px; }
    .main-controls { display:flex; align-items:center; justify-content:space-between; max-width:400px; width:100%; padding:0 12px; }
    .ctrl-btn { background:none; border:none; color:var(--text-secondary); font-size:1.8rem; width:52px; height:52px; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; }
    .ctrl-btn:hover { color:var(--accent); transform:scale(1.12); }
    .play-fab-mobile { width:64px; height:64px; background:var(--accent); border-radius:50%; color:white; box-shadow:0 8px 28px rgba(124,58,237,0.28); display:flex; align-items:center; justify-content:center; }
    .prog-bar { flex:1; height:6px; background:rgba(0,0,0,0.08); border-radius:6px; overflow:hidden; cursor:pointer; }
    .prog-fill { height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-light)); transition:width 0.12s linear; }
    .lyrics-view { position:fixed; inset:0; background:var(--bg-main); z-index:300; padding:calc(var(--header-height)+2.5rem) 2.4rem 10rem; overflow-y:auto; -webkit-overflow-scrolling:touch; text-align:center; transform:translateY(100%); transition:transform 0.6s cubic-bezier(0.22,1,0.36,1); }
    .lyrics-view.open { transform:translateY(0); }
    .lyrics-close-btn { position:fixed; top:calc(var(--header-height)+1rem); right:1.2rem; z-index:310; background:rgba(0,0,0,0.06); backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.08); width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--text-primary); font-size:2.2rem; transition:all 0.3s ease; }
    .lyrics-close-btn:hover { background:rgba(124,58,237,0.2); transform:scale(1.1); }
    #lyricsLines { font-size:clamp(1.2rem,4.5vw,1.45rem); line-height:2.35; font-weight:400; color:var(--text-primary); white-space:pre-wrap; text-align:center; max-width:780px; margin:1.5rem auto 2rem; }
    .bottom-nav { position:fixed; bottom:0; left:0; right:0; height:78px; background:rgba(255,255,255,0.92); backdrop-filter:blur(24px) saturate(180%); border-top:1px solid var(--border-subtle); box-shadow:0 -8px 32px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:space-around; z-index:150; padding:0 8px; }
    .bottom-nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; color:var(--text-secondary); font-size:0.76rem; font-weight:600; cursor:pointer; transition:all 0.32s ease; padding:6px 12px; border-radius:12px; flex:1; max-width:80px; }
    .bottom-nav-item span.material-symbols-rounded { font-size:1.9rem; font-variation-settings:'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; }
    .bottom-nav-item.active { color:var(--accent); }
    .bottom-nav-item.active span.material-symbols-rounded { font-variation-settings:'FILL' 1, 'wght' 600; }
    .bottom-nav-item:active { transform:scale(0.92); }
    @media (min-width:900px) { .sidebar { transform:translateX(0); position:static; padding-top:2.4rem; } .menu-toggle,.drawer-scrim,.bottom-nav { display:none !important; } .main-view { padding-bottom:calc(var(--player-mini)+24px) !important; } .player-bar { bottom:0; margin:0 12px 12px; } }
    @media (max-width:380px) { .bottom-nav { height:72px; padding:0 4px; } .bottom-nav-item { padding:4px 6px; font-size:0.7rem; } .bottom-nav-item span.material-symbols-rounded { font-size:1.7rem; } .main-view { padding-bottom:calc(var(--player-mini)+82px) !important; } .player-bar { margin-bottom:82px; } }
  </style>
</head>
<body>

  <div id="appLoader" class="app-skeleton-loader">
    <div class="skeleton-wrapper">
      <div class="skeleton-header glass">
        <div class="skeleton-avatar"></div>
        <div class="skeleton-search"><div class="skeleton-bar long"></div></div>
      </div>
      <div class="skeleton-genres">
        <div class="skeleton-chip"></div><div class="skeleton-chip"></div><div class="skeleton-chip"></div>
        <div class="skeleton-chip"></div><div class="skeleton-chip"></div><div class="skeleton-chip"></div>
      </div>
      <div class="skeleton-section">
        <div class="skeleton-title"></div>
        <div class="skeleton-grid">
          <div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div>
          <div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div>
        </div>
      </div>
      <div class="skeleton-section">
        <div class="skeleton-title"></div>
        <div class="skeleton-song-list">
          <div class="skeleton-song-row"></div><div class="skeleton-song-row"></div><div class="skeleton-song-row"></div>
          <div class="skeleton-song-row"></div><div class="skeleton-song-row"></div><div class="skeleton-song-row"></div>
          <div class="skeleton-song-row"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="pwaTopSheet" aria-live="polite">
    <div class="pwa-sheet-content">
      <div class="pwa-sheet-left">
        <img src="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png" alt="App icon">
        <div class="pwa-sheet-text">
          <h3>Install Vynix</h3>
          <p id="pwaInstruction">Tap <strong>Share</strong> âžœ <strong>Add to Home Screen</strong></p>
        </div>
      </div>
      <div class="pwa-sheet-actions">
        <button class="pwa-install-btn" id="pwaInstallBtn">Install</button>
        <button class="pwa-later-btn" onclick="pwaDismiss()">Later</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="customModal">
    <div class="modal-content">
      <div class="modal-title" id="modalTitle">Vynix</div>
      <div id="modalBody"></div>
      <div class="modal-error" id="modalError" style="color:#ff6b6b; margin:1rem 0;"></div>
      <div class="modal-buttons" style="display:flex; gap:1rem; justify-content:flex-end; margin-top:1.8rem;">
        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
        <button class="btn btn-primary" id="modalConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editPlaylistModal">
    <div class="modal-content" style="max-width:480px;">
      <div class="modal-title">Edit Playlist</div>
      <div id="editPlaylistBody"></div>
      <div class="modal-error" id="editPlaylistError" style="color:#ff6b6b; margin:1rem 0;"></div>
      <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:2rem;">
        <button class="btn btn-secondary" onclick="closeEditPlaylistModal()">Cancel</button>
        <button class="btn btn-primary" id="saveEditPlaylistBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="logo">VYNIX</div>
    <div class="nav-item active" onclick="switchView('home')">
      <span class="material-symbols-rounded">home</span> Home
    </div>
    <div class="nav-item" onclick="switchView('discover')">
      <span class="material-symbols-rounded">explore</span> Discover
    </div>
    <div class="nav-item" onclick="switchView('library')">
      <span class="material-symbols-rounded">library_music</span> Library
    </div>
    <div style="margin: 2.8rem 0 1.2rem; color:var(--text-muted); font-weight:600; font-size:0.9rem;">GENRES</div>
    <div id="sidebarGenres" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
    <div style="margin: 2.8rem 0 1.2rem; color:var(--text-muted); font-weight:600; font-size:0.9rem;">PLAYLISTS</div>
    <div id="playlistContainer"></div>
    <div class="nav-item" style="color:var(--accent); margin-top:1.2rem;" onclick="createNewPlaylist()">
      <span class="material-symbols-rounded">add</span> New Playlist
    </div>
    <div style="margin-top:auto; padding-top:2.5rem;">
      <button class="btn btn-primary" style="width:100%; justify-content:center; gap:0.8rem;" onclick="auth.signOut()">
        <span class="material-symbols-rounded">logout</span> Sign Out
      </button>
    </div>
  </aside>

  <div class="drawer-scrim" onclick="toggleDrawer()"></div>

  <div class="top-header-container glass">
    <header class="top-header">
      <div class="menu-toggle" onclick="toggleDrawer()">
        <span class="material-symbols-rounded">menu</span>
      </div>
      <div class="search-container" style="flex:1; max-width:480px;">
        <div class="search-box">
          <span class="material-symbols-rounded">search</span>
          <input type="text" id="globalSearch" placeholder="Search songs, artists, albums..."/>
          <button class="clear-search hidden" id="clearSearchBtn" onclick="clearSearch()">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
      </div>
    </header>
  </div>

  <main class="main-view" id="mainContent">
    <div style="padding-top: calc(var(--header-height) + 1.2rem);">
      <div id="view-home">
        <div class="hero-banner glass">
          <div class="hero-content">
            <div class="hero-text">
              <h1 id="heroGreeting">Discover Your Sound</h1>
              <p>Fresh vibes daily â€¢ Just for you</p>
              <div class="hero-cta">
                <button class="btn btn-secondary hero-btn" onclick="scrollToSection('trendingGrid')">
                  See What's Trending
                </button>
              </div>
            </div>
          </div>
        </div>
        <div id="mainGenreChips" style="display:flex; flex-wrap:wrap; gap:12px; padding:0 1.6rem; margin:1.2rem 0 2.4rem;"></div>
        <div class="section-title">
          <span id="currentSectionTitle">Trending</span>
        </div>
        <div style="display:flex; gap:1.4rem; overflow-x:auto; padding:0 1.6rem; padding-bottom:1.8rem;" id="trendingGrid"></div>
        <div class="section-title">
          <span id="listSectionTitle">All Tracks</span>
        </div>
        <div id="songsList"></div>
      </div>

      <div id="view-library" class="hidden">
        <div class="section-title">Liked Songs</div>
        <div id="likedSongsList"></div>
      </div>

      <div id="view-playlist" class="hidden">
        <div class="section-title" id="playlistTitle">Playlist</div>
        <div id="playlistTracksList"></div>
      </div>

      <div id="view-discover" class="hidden">
        <div style="padding: 0 0 6rem;">
          <div class="hero-community">
            <h2>Community Vibes</h2>
            <p>Discover real playlists made by people just like you â€“ from late-night amapiano to focus flows and weekend energy.</p>
            <button class="btn btn-primary" onclick="createNewPlaylist()">
              Share Your Playlist â†’
            </button>
          </div>
          <div class="section-title" style="margin-top: 2.6rem;">Moods & Moments</div>
          <div id="moodCategories" class="discover-scroll">
            <div class="mood-chip" data-mood="chill">Chill</div>
            <div class="mood-chip" data-mood="focus">Focus</div>
            <div class="mood-chip" data-mood="party">Party</div>
            <div class="mood-chip" data-mood="workout">Workout</div>
            <div class="mood-chip" data-mood="sad">Rainy Days</div>
            <div class="mood-chip" data-mood="amapiano">Amapiano Nights</div>
            <div class="mood-chip" data-mood="driving">Road Trip</div>
            <div class="mood-chip" data-mood="romance">Romance</div>
            <div class="mood-chip" data-mood="energy">High Energy</div>
          </div>
          <div class="section-title">Viral & Rising</div>
          <div id="featuredPlaylists" class="discover-scroll"></div>
          <div class="section-title" style="margin-top: 2.4rem;">Fresh Finds</div>
          <div id="newThisWeek" class="discover-scroll"></div>
          <div class="section-title" style="margin-top: 2.8rem;">Community Creations</div>
          <div id="communityPlaylists" class="discover-scroll"></div>
        </div>
      </div>

      <div id="view-search" class="hidden">
        <div class="section-title" style="margin-top:1.8rem;">Search Results</div>
        <div id="searchResults" style="padding:0 1.6rem;"></div>
        <div id="searchEmpty" style="padding:6rem 2rem;text-align:center;color:var(--text-muted);">
          Type something to search songs, artists or albums...
        </div>
      </div>

      <div id="view-profile" class="hidden" style="padding:2rem 1.6rem;">
        <div class="section-title">Profile</div>
        <div class="glass" style="border-radius:var(--radius-l);padding:2rem;margin-bottom:2rem;text-align:center;">
          <div style="width:120px;height:120px;border-radius:50%;overflow:hidden;margin:0 auto 1.2rem;background:var(--accent);">
            <img id="profileAvatar" src="" alt="Profile" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='https://ui-avatars.com/api/?name='+(auth.currentUser?.displayName||'User')+'&background=7c3aed&color=fff'">
          </div>
          <h2 id="profileName" style="font-size:1.8rem;font-weight:800;margin-bottom:0.4rem;">Loading...</h2>
          <p id="profileEmail" style="color:var(--text-secondary);margin-bottom:1.6rem;"></p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;max-width:360px;margin:0 auto;">
            <div class="glass" style="padding:1.2rem;border-radius:var(--radius-m);">
              <div style="font-size:1.6rem;font-weight:700;color:var(--accent);">
                <span id="profileLikedCount">0</span>
              </div>
              <div style="color:var(--text-muted);font-size:0.9rem;">Liked Songs</div>
            </div>
            <div class="glass" style="padding:1.2rem;border-radius:var(--radius-m);">
              <div style="font-size:1.6rem;font-weight:700;color:var(--accent);">
                <span id="profilePlaylistCount">0</span>
              </div>
              <div style="color:var(--text-muted);font-size:0.9rem;">Playlists</div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" style="width:100%;max-width:400px;margin:0 auto;display:block;" onclick="auth.signOut()">
          Sign Out
        </button>
      </div>
    </div>
  </main>

  <div class="lyrics-view" id="lyricsOverlay">
    <button class="lyrics-close-btn" onclick="toggleLyrics()">
      <span class="material-symbols-rounded">keyboard_arrow_down</span>
    </button>
    <div class="card-img-wrap" style="width:260px; height:260px; margin:2rem auto 2.8rem;">
      <img id="lyricsCover" src="" alt="cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
      <div class="default-cover" style="display:none;">â™ª</div>
    </div>
    <h2 id="lyricsTitle" style="margin-bottom:0.6rem; font-size:2.1rem; font-weight:800;">Song Title</h2>
    <p id="lyricsArtist" style="color:var(--accent); font-size:1.2rem; margin-bottom:3.5rem;">Artist</p>
    <div id="lyricsLines" style="max-width:720px; margin:0 auto;">No lyrics available</div>
  </div>

  <nav class="bottom-nav glass" id="bottomNav">
    <div class="bottom-nav-item active" data-view="home">
      <span class="material-symbols-rounded">home</span>
      <span class="label">Home</span>
    </div>
    <div class="bottom-nav-item" data-view="discover">
      <span class="material-symbols-rounded">explore</span>
      <span class="label">Discover</span>
    </div>
    <div class="bottom-nav-item" data-view="search">
      <span class="material-symbols-rounded">search</span>
      <span class="label">Search</span>
    </div>
    <div class="bottom-nav-item" data-view="library">
      <span class="material-symbols-rounded">library_music</span>
      <span class="label">Library</span>
    </div>
    <div class="bottom-nav-item" data-view="profile">
      <span class="material-symbols-rounded">person</span>
      <span class="label">Profile</span>
    </div>
  </nav>

  <footer class="player-bar glass" id="playerBar">
    <div class="track-meta" onclick="toggleLyrics()">
      <div class="card-img-wrap" style="width:60px;height:60px;">
        <img id="pCover" src="" alt="cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="default-cover" style="display:none;font-size:2.2rem;">â™ª</div>
      </div>
      <div>
        <div id="pTitle">Not Playing</div>
        <div id="pArtist">â€”</div>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; align-items:center; gap:12px; width:100%;">
      <div class="main-controls">
        <button class="ctrl-btn" onclick="toggleShuffle()"><span class="material-symbols-rounded">shuffle</span></button>
        <button class="ctrl-btn" onclick="playPrevTrack()"><span class="material-symbols-rounded">skip_previous</span></button>
        <button class="play-fab-mobile" id="mobPlayBtn" onclick="togglePlay()">
          <span class="material-symbols-rounded" id="mobPlayIcon">play_arrow</span>
        </button>
        <button class="ctrl-btn" onclick="playNextTrack()"><span class="material-symbols-rounded">skip_next</span></button>
        <button class="ctrl-btn" onclick="toggleRepeat()"><span class="material-symbols-rounded">repeat</span></button>
      </div>
      <div style="display:flex; align-items:center; gap:12px; width:100%; max-width:480px;">
        <span id="currTime" style="font-size:0.84rem; color:var(--text-muted); min-width:40px;">0:00</span>
        <div class="prog-bar" id="progBar">
          <div class="prog-fill" id="progFill"></div>
        </div>
        <span id="durTime" style="font-size:0.84rem; color:var(--text-muted); min-width:40px;">--:--</span>
      </div>
    </div>
  </footer>

  <audio id="audio"></audio>

<script>
// Firebase Initialization
firebase.initializeApp({
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
});
const auth = firebase.auth();
const db = firebase.database();

// Global State
let likedPlaylists = new Set();
let allTracks = [];
let allGenres = [];
let playlists = {};
let currentPlaylistId = null;
let currentTrack = null;
let likedTracks = new Set();
let currentGenreFilter = null;
let isShuffled = false;
let isRepeating = false;
let currentTrackIndex = 0;
let shuffledIndices = [];
const audio = document.getElementById('audio');
const playerBar = document.getElementById('playerBar');
const currTimeEl = document.getElementById('currTime');
const durTimeEl = document.getElementById('durTime');
const progFill = document.getElementById('progFill');
const DEFAULT_COVER = 'https://i.postimg.cc/8zF8q662/dda96d43-056a-4418-a156-9adf6e0551de.jpg';

// Player Time & Progress
function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${m}:${sec < 10 ? '0' : ''}${sec}`;
}
audio.ontimeupdate = () => {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  progFill.style.width = pct + '%';
  currTimeEl.textContent = formatTime(audio.currentTime);
  durTimeEl.textContent = formatTime(audio.duration);
};
audio.onloadedmetadata = () => {
  durTimeEl.textContent = formatTime(audio.duration || 0);
};
document.getElementById('progBar').onclick = e => {
  const rect = e.currentTarget.getBoundingClientRect();
  const pos = (e.clientX - rect.left) / rect.width;
  audio.currentTime = pos * audio.duration;
};

// Player Controls
function playTrack(track) {
  if (!track?.id) return;
  currentTrack = track;
  const tracks = getFilteredTracks();
  currentTrackIndex = tracks.findIndex(t => t.id === track.id);
  document.getElementById('pTitle').textContent = track.title || 'Unknown';
  document.getElementById('pArtist').textContent = track.artist || 'Unknown';
  const cover = document.getElementById('pCover');
  cover.src = track.cover || DEFAULT_COVER;
  document.getElementById('lyricsCover').src = track.cover || DEFAULT_COVER;
  document.getElementById('lyricsTitle').textContent = track.title || 'Unknown';
  document.getElementById('lyricsArtist').textContent = track.artist || 'Unknown';
  audio.src = track.audio || '';
  audio.play()
    .then(() => {
      updatePlayIcons(true);
      playerBar.classList.remove('hidden');
      db.ref(`content/music/${track.id}/playCount`)
        .set(firebase.database.ServerValue.increment(1))
        .catch(err => console.error("Failed to increment play count:", err));
    })
    .catch(err => console.error("Playback failed:", err));
}
function togglePlay() {
  if (!currentTrack) {
    const tracks = getFilteredTracks();
    if (tracks.length) playTrack(tracks[0]);
    return;
  }
  audio[audio.paused ? 'play' : 'pause']().catch(() => {});
  updatePlayIcons(!audio.paused);
}
function updatePlayIcons(playing) {
  const icon = document.getElementById('mobPlayIcon');
  icon.textContent = playing ? 'pause' : 'play_arrow';
  const fab = document.querySelector('.play-fab-mobile');
  fab.classList.toggle('playing', playing);
}
function playNextTrack() {
  const next = getNextTrackIndex();
  if (next !== -1) playTrack(getFilteredTracks()[next]);
}
function playPrevTrack() {
  const prev = getPrevTrackIndex();
  if (prev !== -1) playTrack(getFilteredTracks()[prev]);
}
function toggleShuffle() {
  isShuffled = !isShuffled;
  const btn = document.querySelector('.main-controls .ctrl-btn:first-child span');
  btn.style.color = isShuffled ? 'var(--accent)' : '';
  if (isShuffled) shuffledIndices = getShuffledIndices(getFilteredTracks().length);
}
function toggleRepeat() {
  isRepeating = !isRepeating;
  const btn = document.querySelector('.main-controls .ctrl-btn:last-child span');
  btn.style.color = isRepeating ? 'var(--accent)' : '';
}
function getShuffledIndices(len) {
  const arr = Array.from({length: len}, (_,i) => i);
  for (let i = len-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function getNextTrackIndex() {
  const tracks = getFilteredTracks();
  if (!tracks.length) return -1;
  if (isShuffled) {
    const idx = shuffledIndices.indexOf(currentTrackIndex);
    return shuffledIndices[(idx + 1) % shuffledIndices.length];
  }
  return (currentTrackIndex + 1) % tracks.length;
}
function getPrevTrackIndex() {
  const tracks = getFilteredTracks();
  if (!tracks.length) return -1;
  if (isShuffled) {
    const idx = shuffledIndices.indexOf(currentTrackIndex);
    return shuffledIndices[(idx - 1 + shuffledIndices.length) % shuffledIndices.length];
  }
  return (currentTrackIndex - 1 + tracks.length) % tracks.length;
}
audio.onended = () => {
  if (isRepeating) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  } else playNextTrack();
};

// Trending Score Calculation
function calculateTrendingScore(playlist) {
  const now = Date.now();
  const likes = playlist.likesCount || 0;
  const lastActivity = playlist.lastLikeAt || playlist.createdAt || now;
  const hoursSinceLastActivity = (now - lastActivity) / (1000 * 60 * 60);
  const hoursSinceCreation = (now - (playlist.createdAt || now)) / (1000 * 60 * 60);
  let score = 0;
  score += Math.log10(likes + 1) * 40;
  if (hoursSinceLastActivity < 2) score += 60;
  else if (hoursSinceLastActivity < 6) score += 45;
  else if (hoursSinceLastActivity < 12) score += 30;
  else if (hoursSinceLastActivity < 48) score += 15;
  score *= Math.pow(0.92, Math.min(hoursSinceLastActivity, 72));
  if (hoursSinceCreation < 24) score += 12;
  score = Math.max(score, Math.sqrt(likes) * 8);
  return Math.round(score * 100) / 100;
}

// Real-time Trending Playlists
function loadTrendingPlaylists() {
  const container = document.getElementById('featuredPlaylists');
  if (!container) return;
  container.innerHTML = '<div style="padding:4rem; text-align:center; color:var(--text-muted);">Loading trending...</div>';
  db.ref('publicPlaylists')
    .orderByChild('likesCount')
    .limitToLast(120)
    .on('value', snap => {
      const playlists = [];
      snap.forEach(child => {
        playlists.push({ id: child.key, ...child.val() });
      });
      const ranked = playlists
        .map(p => ({ ...p, score: calculateTrendingScore(p) }))
        .filter(p => (p.likesCount || 0) >= 1)
        .sort((a, b) => b.score - a.score)
        .slice(0, 12);
      container.innerHTML = '';
      if (ranked.length === 0) {
        container.innerHTML = `
          <div style="padding:4rem; text-align:center; color:var(--text-muted);">
            No trending playlists yet...<br>
            <small>Like some to help them rise! ðŸ”¥</small>
          </div>`;
        return;
      }
      ranked.forEach(pl => appendPlaylistCard(pl, container, true));
    });
}

// UI Navigation
function switchView(view) {
  document.querySelectorAll('[id^="view-"]').forEach(el =>
    el.classList.toggle('hidden', !el.id.includes(view))
  );
  document.querySelectorAll('.nav-item').forEach(el => {
    const text = el.textContent.toLowerCase();
    el.classList.toggle('active', text.includes(view));
  });
  document.querySelectorAll('.bottom-nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.view === view);
  });
  if (view === 'search') document.getElementById('globalSearch')?.focus();
  if (view === 'profile') updateProfileView();
}

function toggleDrawer() {
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.drawer-scrim').classList.toggle('show');
}

function toggleLyrics() {
  document.getElementById('lyricsOverlay').classList.toggle('open');
}

// Custom Modal
const modal = {
  overlay: document.getElementById('customModal'),
  title: document.getElementById('modalTitle'),
  body: document.getElementById('modalBody'),
  error: document.getElementById('modalError'),
  cancel: document.getElementById('modalCancel'),
  confirm: document.getElementById('modalConfirm'),
  show(title, content = '', isPrompt = false, defaultVal = '', callback) {
    this.title.textContent = title;
    this.body.innerHTML = content;
    this.error.textContent = '';
    if (isPrompt) {
      const input = document.createElement('input');
      input.className = 'modal-input';
      input.value = defaultVal;
      input.placeholder = 'Enter name...';
      this.body.appendChild(input);
      input.focus();
      input.onkeyup = e => { if (e.key === 'Enter') this.confirm.click(); };
      this.confirm.onclick = () => {
        const val = input.value.trim();
        if (val) callback(val);
        this.hide();
      };
    } else {
      this.confirm.onclick = () => { callback?.(); this.hide(); };
    }
    this.cancel.onclick = () => this.hide();
    this.overlay.classList.add('show');
  },
  hide() {
    this.overlay.classList.remove('show');
    this.body.innerHTML = '';
  },
  alert(msg) {
    this.show('Vynix', `<p style="line-height:1.6">${msg}</p>`);
  }
};

// Data Loading
function loadData(uid) {
  let initialTracksLoaded = false;
  let initialGenresLoaded = false;
  const loader = document.getElementById('appLoader');
  const checkIfReadyToHideLoader = () => {
    if (initialTracksLoaded && initialGenresLoaded) {
      setTimeout(() => {
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 400);
      }, 300);
    }
  };

  db.ref('content/music').once('value').then(snap => {
    allTracks = [];
    snap.forEach(child => {
      const t = child.val();
      t.id = child.key;
      allTracks.push(t);
    });
    initialTracksLoaded = true;
    renderHome();
    renderLibrary();
    checkIfReadyToHideLoader();
  });

  db.ref('content/music').on('child_changed', snapshot => {
    const updated = snapshot.val();
    if (!updated) return;
    updated.id = snapshot.key;
    const idx = allTracks.findIndex(t => t.id === updated.id);
    if (idx !== -1) {
      allTracks[idx] = { ...allTracks[idx], ...updated };
    } else {
      allTracks.push(updated);
    }
    updateTrackPlayCountInUI(updated.id, updated.playCount || 0);
    renderTrendingCardsOnly();
  });

  db.ref('content/music').on('child_added', snapshot => {
    const newTrack = snapshot.val();
    newTrack.id = snapshot.key;
    if (!allTracks.some(t => t.id === newTrack.id)) {
      allTracks.push(newTrack);
      renderHome();
    }
  });

  db.ref('/content/musicGenres').once('value').then(snap => {
    allGenres = [];
    snap.forEach(c => {
      const name = c.val()?.name;
      if (name) allGenres.push(name);
    });
    allGenres.sort();
    initialGenresLoaded = true;
    renderGenreChips();
    checkIfReadyToHideLoader();
  });

  db.ref('/content/musicGenres').on('value', snap => {
    allGenres = [];
    snap.forEach(c => {
      const name = c.val()?.name;
      if (name) allGenres.push(name);
    });
    allGenres.sort();
    renderGenreChips();
  });

  db.ref(`users/${uid}/likes`).on('value', snap => {
    likedTracks.clear();
    if (snap.val()) Object.keys(snap.val()).forEach(k => likedTracks.add(k));
    renderLibrary();
  });

  db.ref(`users/${uid}/playlists`).on('value', snap => {
    playlists = snap.val() || {};
    renderPlaylists();
    if (currentPlaylistId && playlists[currentPlaylistId]) {
      renderPlaylistTracks();
    }
  });
}

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.replace('login.html');
    return;
  }
  const firstName = user.displayName?.split(' ')[0] || 'Music Lover';
  const heroTitle = document.querySelector('.hero-text h1');
  if (heroTitle) heroTitle.textContent = `Welcome back, ${firstName}!`;
  loadData(user.uid);
  listenToUserLikedPlaylists();
  listenToPublicPlaylistLikeCounts();
  updateProfileView();
});

function listenToUserLikedPlaylists() {
  const uid = auth.currentUser?.uid;
  if (!uid) return;
  db.ref(`users/${uid}/likedPlaylists`).on('value', snap => {
    likedPlaylists.clear();
    if (snap.exists() && snap.val()) Object.keys(snap.val()).forEach(id => likedPlaylists.add(id));
    updateLikeButtonStates();
  });
}

function updateLikeButtonStates() {
  document.querySelectorAll('.like-playlist-btn').forEach(btn => {
    const playlistId = btn.dataset.playlistId;
    if (!playlistId) return;
    const isLiked = likedPlaylists.has(playlistId);
    btn.classList.toggle('liked', isLiked);
    btn.querySelector('span.material-symbols-rounded').textContent = isLiked ? 'favorite' : 'favorite_border';
  });
}

function listenToPublicPlaylistLikeCounts() {
  db.ref('publicPlaylists').on('child_changed', snap => {
    const playlistId = snap.key;
    const newCount = snap.val()?.likesCount ?? 0;
    const countElement = document.querySelector(`.like-playlist-btn[data-playlist-id="${playlistId}"] .like-count`);
    if (countElement) countElement.textContent = newCount;
  });
}

// Rendering Functions
function getFilteredTracks() {
  if (!currentGenreFilter) return allTracks;
  return allTracks.filter(t => (t.genres?.includes(currentGenreFilter)) || t.genre === currentGenreFilter);
}

function createTrackCard(track) {
  const div = document.createElement('div');
  div.className = 'track-card';
  div.dataset.trackId = track.id;
  div.innerHTML = `
    <div class="card-img-wrap">
      <img src="${track.cover || DEFAULT_COVER}" alt="${track.title}" onerror="this.src='${DEFAULT_COVER}'">
      <div class="play-overlay"><span class="material-symbols-rounded" style="font-size:3.8rem;">play_arrow</span></div>
    </div>
    <div style="padding:1rem;">
      <div style="font-weight:700; font-size:1.1rem;">${track.title || 'Unknown'}</div>
      <div style="color:var(--text-secondary); font-size:0.92rem; margin-top:0.3rem;">${track.artist || 'Unknown'}</div>
      <div class="play-count-display" style="margin-top:0.5rem; font-size:0.82rem; color:var(--text-muted);">
        ${track.playCount || 0} plays
      </div>
    </div>
  `;
  div.onclick = () => playTrack(track);
  return div;
}

function createSongRow(track) {
  const div = document.createElement('div');
  div.className = 'song-row';
  div.dataset.trackId = track.id;
  div.innerHTML = `
    <div class="card-img-wrap" style="width:64px;height:64px;">
      <img src="${track.cover || DEFAULT_COVER}" alt="${track.title}" onerror="this.src='${DEFAULT_COVER}'">
    </div>
    <div style="flex:1;">
      <div style="font-weight:600; font-size:1.05rem;">${track.title || 'Unknown'}</div>
      <div style="color:var(--text-secondary); font-size:0.94rem; margin-top:0.3rem;">${track.artist || 'Unknown'}</div>
    </div>
    <div style="display:flex; gap:1.2rem;">
      <button class="ctrl-btn like-btn ${likedTracks.has(track.id) ? 'liked' : ''}" style="font-size:1.8rem;" data-track-id="${track.id}" onclick="event.stopPropagation(); toggleLike('${track.id}', this)">
        <span class="material-symbols-rounded">favorite</span>
      </button>
      <button class="ctrl-btn" style="font-size:1.8rem;" onclick="event.stopPropagation();addToPlaylist('${track.id}')">
        <span class="material-symbols-rounded">playlist_add</span>
      </button>
    </div>
  `;
  div.onclick = () => playTrack(track);
  return div;
}

function renderHome() {
  const grid = document.getElementById('trendingGrid');
  const list = document.getElementById('songsList');
  const title = document.getElementById('currentSectionTitle');
  const listTitle = document.getElementById('listSectionTitle');
  grid.innerHTML = '';
  list.innerHTML = '';
  const filtered = getFilteredTracks();
  title.textContent = currentGenreFilter || 'Trending';
  listTitle.textContent = currentGenreFilter ? currentGenreFilter : 'All Tracks';
  filtered.slice(0, 12).forEach(t => grid.appendChild(createTrackCard(t)));
  filtered.forEach(t => list.appendChild(createSongRow(t)));
  applySearchFilter();
}

function renderTrendingCardsOnly() {
  const grid = document.getElementById('trendingGrid');
  if (!grid) return;
  grid.innerHTML = '';
  const filtered = getFilteredTracks();
  filtered.slice(0, 12).forEach(t => grid.appendChild(createTrackCard(t)));
}

function updateTrackPlayCountInUI(trackId, newCount) {
  document.querySelectorAll(`.track-card[data-track-id="${trackId}"] .play-count-display,
                             .track-card [data-track-id="${trackId}"] .play-count-display`)
    .forEach(el => el.textContent = `${newCount || 0} plays`);
  document.querySelectorAll(`.song-row[data-track-id="${trackId}"] .play-count-display`)
    .forEach(el => el.textContent = `${newCount || 0} plays`);
}

function renderLibrary() {
  const container = document.getElementById('likedSongsList');
  container.innerHTML = '';
  const liked = allTracks.filter(t => likedTracks.has(t.id));
  if (!liked.length) {
    container.innerHTML = '<div style="padding:4rem;text-align:center;color:var(--text-muted);">No liked songs yet...</div>';
    return;
  }
  liked.forEach(t => container.appendChild(createSongRow(t)));
  applySearchFilter();
}

function renderPlaylistTracks() {
  const container = document.getElementById('playlistTracksList');
  container.innerHTML = '';
  const tracks = playlists[currentPlaylistId]?.tracks || {};
  const ids = Object.keys(tracks);
  if (!ids.length) {
    container.innerHTML = '<div style="padding:4rem;text-align:center;color:var(--text-muted);">This playlist is empty</div>';
    return;
  }
  ids.forEach(id => {
    const track = allTracks.find(t => t.id === id);
    if (track) container.appendChild(createSongRow(track));
  });
  applySearchFilter();
}

function renderGenreChips() {
  const containers = [document.getElementById('sidebarGenres'), document.getElementById('mainGenreChips')];
  containers.forEach(cont => {
    if (!cont) return;
    cont.innerHTML = '';
    const all = document.createElement('div');
    all.className = `category-chip ${!currentGenreFilter ? 'active' : ''}`;
    all.textContent = 'All';
    all.style.cssText = 'padding:0.7rem 1.4rem; background:rgba(192,132,252,0.12); border-radius:999px; cursor:pointer; font-weight:600; color:var(--text-primary); transition:all 0.3s;';
    all.onclick = () => {
      currentGenreFilter = null;
      renderGenreChips();
      renderHome();
    };
    cont.appendChild(all);
    allGenres.forEach(g => {
      const chip = document.createElement('div');
      chip.className = `category-chip ${currentGenreFilter === g ? 'active' : ''}`;
      chip.textContent = g;
      chip.style.cssText = 'padding:0.7rem 1.4rem; background:rgba(192,132,252,0.12); border-radius:999px; cursor:pointer; font-weight:600; color:var(--text-primary); transition:all 0.3s;';
      chip.onclick = () => {
        currentGenreFilter = g;
        renderGenreChips();
        renderHome();
      };
      cont.appendChild(chip);
    });
  });
}

function renderPlaylists() {
  const cont = document.getElementById('playlistContainer');
  cont.innerHTML = '';
  Object.entries(playlists).forEach(([id, pl]) => {
    const item = document.createElement('div');
    item.className = 'nav-item';
    item.style.position = 'relative';
    item.innerHTML = `
      <div style="display:flex; align-items:center; gap:0.9rem; flex:1;">
        <div style="width:36px;height:36px;border-radius:8px;overflow:hidden;">
          <img src="${DEFAULT_COVER}" alt="cover" style="width:100%;height:100%;object-fit:cover;">
        </div>
        <span>${pl.name || 'Untitled'} ${pl.public ? 'ðŸ”“' : ''}</span>
      </div>
      <div style="display:flex; gap:0.5rem;">
        <button class="ctrl-btn" title="Edit Playlist" onclick="event.stopPropagation(); openEditPlaylistModal('${id}')">
          <span class="material-symbols-rounded">edit</span>
        </button>
        <button class="ctrl-btn" title="Delete Playlist" style="color:#ef4444;" onclick="event.stopPropagation(); confirmDeletePlaylist('${id}', '${pl.name || 'Untitled'}')">
          <span class="material-symbols-rounded">delete</span>
        </button>
      </div>
    `;
    item.onclick = (e) => {
      if (e.target.closest('.ctrl-btn')) return;
      currentPlaylistId = id;
      document.getElementById('playlistTitle').textContent = pl.name || 'Playlist';
      switchView('playlist');
      renderPlaylistTracks();
    };
    cont.appendChild(item);
  });
}

// Search & Filter
function applySearchFilter() {
  const term = document.getElementById('globalSearch').value.toLowerCase().trim();
  document.getElementById('clearSearchBtn').classList.toggle('hidden', !term);
  document.querySelectorAll('.song-row, .track-card').forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
}

function clearSearch() {
  document.getElementById('globalSearch').value = '';
  applySearchFilter();
}

// Likes & Playlist Management
function toggleLike(trackId, buttonElement = null) {
  const uid = auth.currentUser?.uid;
  if (!uid || !trackId) return;
  const wasLiked = likedTracks.has(trackId);
  const likeRef = db.ref(`users/${uid}/likes/${trackId}`);
  if (wasLiked) {
    likedTracks.delete(trackId);
    if (buttonElement) buttonElement.classList.remove('liked');
  } else {
    likedTracks.add(trackId);
    if (buttonElement) buttonElement.classList.add('liked');
  }
  const updatePromise = wasLiked ? likeRef.remove() : likeRef.set(true);
  updatePromise.catch(error => {
    console.error("Like update failed:", error);
    if (wasLiked) {
      likedTracks.add(trackId);
      if (buttonElement) buttonElement.classList.add('liked');
    } else {
      likedTracks.delete(trackId);
      if (buttonElement) buttonElement.classList.remove('liked');
    }
    modal.alert("Failed to update like status");
  });
  if (currentPlaylistId && wasLiked) {
    const row = document.querySelector(`#playlistTracksList .song-row[data-track-id="${trackId}"]`);
    if (row) {
      row.style.transition = 'all 0.4s ease';
      row.style.opacity = '0';
      row.style.transform = 'translateX(-24px)';
      setTimeout(() => {
        row.remove();
        const container = document.getElementById('playlistTracksList');
        if (container.children.length === 0) {
          container.innerHTML = '<div style="padding:4rem; text-align:center; color:var(--text-muted);">This playlist is empty</div>';
        }
      }, 420);
    }
  }
  renderLibrary();
}

function togglePlaylistLike(playlistId, ownerUserId, buttonElement) {
  const uid = auth.currentUser?.uid;
  if (!uid || !playlistId) return;
  const wasLiked = likedPlaylists.has(playlistId);
  const countEl = buttonElement.querySelector('.like-count');
  const iconEl = buttonElement.querySelector('span.material-symbols-rounded');
  let currentCount = parseInt(countEl?.textContent || '0');
  if (wasLiked) {
    likedPlaylists.delete(playlistId);
    buttonElement.classList.remove('liked');
    iconEl.textContent = 'favorite_border';
    currentCount = Math.max(0, currentCount - 1);
  } else {
    likedPlaylists.add(playlistId);
    buttonElement.classList.add('liked');
    iconEl.textContent = 'favorite';
    currentCount += 1;
  }
  if (countEl) countEl.textContent = currentCount;
  const delta = wasLiked ? -1 : 1;
  const now = firebase.database.ServerValue.TIMESTAMP;
  const updates = {};
  updates[`publicPlaylists/${playlistId}/likesCount`] = firebase.database.ServerValue.increment(delta);
  updates[`users/${ownerUserId}/playlists/${playlistId}/likesCount`] = firebase.database.ServerValue.increment(delta);
  updates[`publicPlaylists/${playlistId}/lastLikeAt`] = now;
  db.ref().update(updates);
  db.ref(`users/${uid}/likedPlaylists/${playlistId}`).set(wasLiked ? null : true)
    .catch(err => {
      console.error('Like failed:', err);
      likedPlaylists[wasLiked ? 'add' : 'delete'](playlistId);
      buttonElement.classList.toggle('liked', !wasLiked);
      iconEl.textContent = wasLiked ? 'favorite' : 'favorite_border';
      if (countEl) countEl.textContent = currentCount + (wasLiked ? 1 : -1);
      modal.alert("Failed to update like. Try again.");
    });
}

function createNewPlaylist() {
  modal.show(
    'Create New Playlist',
    `
      <p style="margin-bottom:1.4rem; color:var(--text-secondary); line-height:1.5;">
        Give your playlist a catchy name:
      </p>
      <input type="text" class="modal-input" id="playlistNameInput" placeholder="e.g. Amapiano Nights 2026" autofocus>
      <div style="margin:1.8rem 0; display:flex; align-items:center; gap:0.9rem;">
        <input type="checkbox" id="makePublicCheckbox" checked style="width:18px;height:18px; accent-color:var(--accent);">
        <label for="makePublicCheckbox" style="font-size:0.96rem; color:var(--text-primary); cursor:pointer; user-select:none;">
          Make this playlist public<br>
          <span style="font-size:0.84rem; color:var(--text-muted);">(visible to everyone in Discover)</span>
        </label>
      </div>
    `,
    false, '', () => {
      const name = document.getElementById('playlistNameInput').value.trim();
      const isPublic = document.getElementById('makePublicCheckbox').checked;
      if (!name) {
        modal.alert('Playlist name is required!');
        return;
      }
      const uid = auth.currentUser.uid;
      const displayName = auth.currentUser.displayName || 'Music Lover';
      const newPlaylistRef = db.ref(`users/${uid}/playlists`).push();
      const playlistId = newPlaylistRef.key;
      const playlistData = {
        name: name,
        tracks: {},
        createdBy: displayName,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        public: isPublic,
        likesCount: 0,
        lastLikeAt: firebase.database.ServerValue.TIMESTAMP,
        coverUrl: null
      };
      const updates = {};
      updates[`users/${uid}/playlists/${playlistId}`] = playlistData;
      if (isPublic) {
        updates[`publicPlaylists/${playlistId}`] = {
          ...playlistData,
          userId: uid,
          trackCount: 0
        };
      }
      db.ref().update(updates)
        .then(() => {
          modal.alert(
            `Playlist <strong>"${name}"</strong> created successfully!` +
            (isPublic ? '<br><br>Itâ€™s now visible to everyone in Discover ðŸŽ‰' : '')
          );
        })
        .catch(err => {
          console.error('Playlist creation failed:', err);
          modal.alert('Something went wrong. Please try again.');
        });
    }
  );
}

function addToPlaylist(trackId) {
  if (!Object.keys(playlists).length) return modal.alert('Create a playlist first');
  let html = '<p style="margin-bottom:1.2rem; color:var(--text-secondary);">Add to which playlist?</p>';
  html += '<select class="modal-input" id="plSelect">';
  Object.entries(playlists).forEach(([id, p]) => {
    html += `<option value="${id}">${p.name || 'Untitled'}</option>`;
  });
  html += '</select>';
  modal.show('Add to Playlist', html, false, '', () => {
    const selected = document.getElementById('plSelect').value;
    if (selected) {
      db.ref(`users/${auth.currentUser.uid}/playlists/${selected}/tracks/${trackId}`).set(true)
        .then(() => modal.alert('Track added!'));
    }
  });
}

// Discover Tab Functions
function loadDiscoverContent() {
  loadTrendingPlaylists();
  loadFreshFinds(10);
  loadAllCommunityPlaylists();
}

function loadFreshFinds(days = 10) {
  const threshold = Date.now() - days * 24 * 60 * 60 * 1000;
  db.ref('publicPlaylists')
    .orderByChild('createdAt')
    .startAt(threshold)
    .limitToLast(20)
    .once('value')
    .then(snap => {
      const container = document.getElementById('newThisWeek');
      container.innerHTML = '';
      if (!snap.exists()) {
        container.innerHTML = '<div class="empty-state">No new playlists this weekâ€¦ be the first! âœ¨</div>';
        return;
      }
      const arr = [];
      snap.forEach(c => arr.push({id: c.key, ...c.val()}));
      arr.sort((a,b) => (b.likesCount||0) - (a.likesCount||0));
      arr.forEach(pl => appendPlaylistCard(pl, container, false));
    });
}

function loadAllCommunityPlaylists() {
  const container = document.getElementById('communityPlaylists');
  if (!container) return;
  container.innerHTML = '<div style="padding:5rem; text-align:center; color:var(--text-muted);">Loading community playlists...</div>';
  db.ref('publicPlaylists')
    .orderByChild('createdAt')
    .limitToLast(30)
    .on('value', snap => {
      container.innerHTML = '';
      if (!snap.exists()) {
        container.innerHTML = '<div style="padding:6rem 1rem; text-align:center; color:var(--text-muted);">No public playlists yet...</div>';
        return;
      }
      const arr = [];
      snap.forEach(c => arr.push({id: c.key, ...c.val()}));
      arr.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
      arr.forEach(pl => appendPlaylistCard(pl, container, false));
    });
}

function appendPlaylistCard(pl, container, isFeatured = false) {
  const coverSrc = pl.coverUrl || DEFAULT_COVER;
  const isLiked = likedPlaylists.has(pl.id);
  const card = document.createElement('div');
  card.className = 'playlist-card' + (isFeatured ? ' featured' : '');
  card.innerHTML = `
    <div class="cover">
      <img src="${coverSrc}" alt="${pl.name || 'Playlist cover'}" loading="lazy" onerror="this.src='${DEFAULT_COVER}'">
    </div>
    <div class="info">
      <div class="name">${pl.name}</div>
      <div class="by">By ${pl.createdBy || 'Someone'}</div>
      <div class="meta" style="font-size:0.9rem; color:var(--text-muted); margin-top:0.4rem;">
        ${pl.trackCount || '?'} tracks
      </div>
      <button class="like-playlist-btn ${isLiked ? 'liked' : ''}" data-playlist-id="${pl.id}">
        <span class="material-symbols-rounded">${isLiked ? 'favorite' : 'favorite_border'}</span>
        <span class="like-count">${pl.likesCount || 0}</span>
      </button>
    </div>
  `;
  card.addEventListener('click', e => {
    if (e.target.closest('.like-playlist-btn')) return;
    loadAndPlayCommunityPlaylist(pl.userId, pl.id, pl.name);
  });
  const likeBtn = card.querySelector('.like-playlist-btn');
  likeBtn.addEventListener('click', e => {
    e.stopPropagation();
    togglePlaylistLike(pl.id, pl.userId, likeBtn);
  });
  container.appendChild(card);
}

function loadAndPlayCommunityPlaylist(userId, playlistId, playlistName) {
  db.ref(`users/${userId}/playlists/${playlistId}`)
    .once('value')
    .then(snap => {
      const playlist = snap.val();
      if (!playlist || !playlist.tracks) {
        modal.alert("This playlist is empty or no longer available.");
        return;
      }
      const trackIds = Object.keys(playlist.tracks);
      if (trackIds.length === 0) {
        modal.alert("This playlist has no tracks yet.");
        return;
      }
      const playlistTracks = [];
      trackIds.forEach(id => {
        const track = allTracks.find(t => t.id === id);
        if (track) playlistTracks.push(track);
      });
      if (playlistTracks.length === 0) {
        modal.alert("None of the tracks in this playlist are available right now.");
        return;
      }
      currentPlaylistId = `community_${playlistId}`;
      document.getElementById('playlistTitle').textContent = playlistName || "Community Playlist";
      switchView('playlist');
      const container = document.getElementById('playlistTracksList');
      container.innerHTML = '';
      playlistTracks.forEach(track => container.appendChild(createSongRow(track)));
      if (playlistTracks.length > 0) playTrack(playlistTracks[0]);
      modal.alert(`Now playing: "${playlistName}" (${playlistTracks.length} tracks)`);
    })
    .catch(err => {
      console.error(err);
      modal.alert("Failed to load this playlist.");
    });
}

// Edit & Delete Playlist Functions
function openEditPlaylistModal(playlistId) {
  const playlist = playlists[playlistId];
  if (!playlist) return modal.alert("Playlist not found.");
  const body = document.getElementById('editPlaylistBody');
  body.innerHTML = `
    <p style="margin-bottom:1.2rem; color:var(--text-secondary);">Update your playlist settings:</p>
    <label style="font-weight:600; display:block; margin-bottom:0.5rem;">Playlist Name</label>
    <input type="text" class="modal-input" id="editPlaylistName" value="${playlist.name || ''}" placeholder="Playlist name">
    <div style="margin:1.8rem 0; display:flex; align-items:center; gap:1rem;">
      <input type="checkbox" id="editPublicCheckbox" ${playlist.public ? 'checked' : ''} style="width:20px;height:20px; accent-color:var(--accent);">
      <div>
        <label for="editPublicCheckbox" style="font-weight:600; cursor:pointer;">Make this playlist public</label>
        <div style="font-size:0.86rem; color:var(--text-muted); margin-top:0.3rem;">
          When public, others can discover and play your playlist in the Community section
        </div>
      </div>
    </div>
  `;
  document.getElementById('editPlaylistModal').classList.add('show');
  document.getElementById('saveEditPlaylistBtn').onclick = () => {
    const newName = document.getElementById('editPlaylistName').value.trim();
    const isPublic = document.getElementById('editPublicCheckbox').checked;
    if (!newName) {
      document.getElementById('editPlaylistError').textContent = "Playlist name cannot be empty!";
      return;
    }
    const uid = auth.currentUser.uid;
    const updates = {
      [`users/${uid}/playlists/${playlistId}/name`]: newName,
      [`users/${uid}/playlists/${playlistId}/public`]: isPublic
    };
    if (isPublic && !playlist.public) {
      updates[`publicPlaylists/${playlistId}`] = {
        name: newName,
        createdBy: auth.currentUser.displayName || 'Someone',
        userId: uid,
        trackCount: Object.keys(playlist.tracks || {}).length,
        likesCount: playlist.likesCount || 0,
        createdAt: playlist.createdAt || firebase.database.ServerValue.TIMESTAMP,
        lastLikeAt: playlist.lastLikeAt || firebase.database.ServerValue.TIMESTAMP
      };
    }
    if (!isPublic && playlist.public) {
      updates[`publicPlaylists/${playlistId}`] = null;
    }
    db.ref().update(updates)
      .then(() => {
        modal.alert("Playlist updated successfully!");
        closeEditPlaylistModal();
        renderPlaylists();
      })
      .catch(err => {
        console.error(err);
        document.getElementById('editPlaylistError').textContent = "Failed to update. Try again.";
      });
  };
}

function confirmDeletePlaylist(playlistId, playlistName) {
  modal.show(
    'Delete Playlist',
    `
      <p style="line-height:1.6; color:var(--text-secondary);">
        Are you sure you want to delete <strong>"${playlistName}"</strong>?<br>
        <span style="color:#ef4444; font-weight:600;">This action cannot be undone.</span>
      </p>
    `,
    false, '', () => deletePlaylist(playlistId)
  );
}

function deletePlaylist(playlistId) {
  const uid = auth.currentUser?.uid;
  if (!uid) return;
  const updates = {
    [`users/${uid}/playlists/${playlistId}`]: null
  };
  if (playlists[playlistId]?.public) {
    updates[`publicPlaylists/${playlistId}`] = null;
  }
  db.ref().update(updates)
    .then(() => {
      modal.alert(`Playlist "${playlists[playlistId]?.name || 'Untitled'}" has been deleted.`);
      if (currentPlaylistId === playlistId) {
        currentPlaylistId = null;
        switchView('home');
      }
    })
    .catch(err => {
      console.error('Delete failed:', err);
      modal.alert('Failed to delete playlist. Please try again.');
    });
}

function closeEditPlaylistModal() {
  document.getElementById('editPlaylistModal').classList.remove('show');
  document.getElementById('editPlaylistBody').innerHTML = '';
}

// Event Listeners & Initialization
document.getElementById('globalSearch').oninput = () => {
  const term = document.getElementById('globalSearch').value.toLowerCase().trim();
  document.getElementById('clearSearchBtn').classList.toggle('hidden', !term);
  const currentView = document.querySelector('[id^="view-"]:not(.hidden)')?.id.replace('view-', '');
  if (currentView === 'search') {
    const container = document.getElementById('searchResults');
    const empty = document.getElementById('searchEmpty');
    container.innerHTML = '';
    if (!term) {
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');
    const filtered = allTracks.filter(t =>
      (t.title?.toLowerCase().includes(term) ||
       t.artist?.toLowerCase().includes(term))
    );
    if (filtered.length === 0) {
      container.innerHTML = '<div style="padding:6rem 2rem;text-align:center;color:var(--text-muted);">No results found</div>';
      return;
    }
    filtered.forEach(t => container.appendChild(createSongRow(t)));
  } else {
    applySearchFilter();
  }
};

window.addEventListener('resize', () => {
  if (window.innerWidth >= 900 && document.getElementById('sidebar').classList.contains('open')) {
    toggleDrawer();
  }
});

document.getElementById('moodCategories').addEventListener('click', function(e) {
  const chip = e.target.closest('.mood-chip');
  if (!chip) return;
  document.querySelectorAll('#moodCategories .mood-chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  const mood = chip.dataset.mood;
  const moodMap = {
    'chill': 'Chill',
    'focus': 'Focus',
    'party': 'Party',
    'workout': 'Workout',
    'sad': 'Sad',
    'amapiano': 'Amapiano',
    'driving': 'Road Trip',
    'romance': 'Romance',
    'energy': 'High Energy'
  };
  currentGenreFilter = moodMap[mood] || null;
  switchView('home');
  renderHome();
  renderGenreChips();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// PWA logic
const sheet = document.getElementById('pwaTopSheet');
const instBtn = document.getElementById('pwaInstallBtn');
const instruction = document.getElementById('pwaInstruction');
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  showTopSheet('native');
});
window.addEventListener('load', () => {
  if (!deferredPrompt && !localStorage.getItem('pwa_dismissed')) {
    showTopSheet('manual');
  }
});
function showTopSheet(mode) {
  if (mode === 'native') {
    instruction.textContent = 'Install Vynix for a full-screen experience';
    instBtn.style.display = 'inline-block';
    instBtn.onclick = () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => pwaDismiss());
    };
  } else {
    const iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const android = /Android/.test(navigator.userAgent);
    if (iOS) {
      instruction.innerHTML = 'Tap <strong>Share</strong> âžœ <strong>Add to Home Screen</strong>';
    } else if (android) {
      instruction.innerHTML = 'Tap <strong>â‹® menu</strong> âžœ <strong>Add to Home Screen</strong>';
    } else {
      instruction.innerHTML = 'Click <strong>Install</strong> in the address bar';
    }
    instBtn.style.display = 'none';
  }
  sheet.classList.add('show');
}
function pwaDismiss() {
  sheet.classList.remove('show');
  localStorage.setItem('pwa_dismissed', '1');
}

// Profile view update
function updateProfileView() {
  const user = auth.currentUser;
  if (!user) return;
  document.getElementById('profileName').textContent = user.displayName || 'Music Lover';
  document.getElementById('profileEmail').textContent = user.email || 'No email';
  db.ref(`users/${user.uid}/likes`).once('value').then(snap => {
    document.getElementById('profileLikedCount').textContent = snap.numChildren() || 0;
  });
  db.ref(`users/${user.uid}/playlists`).once('value').then(snap => {
    document.getElementById('profilePlaylistCount').textContent = snap.numChildren() || 0;
  });
}

// Final initialization
switchView('home');
playerBar.classList.add('hidden');
document.addEventListener('contextmenu', e => {
  if (e.target.tagName === 'IMG') e.preventDefault();
}, { capture: true });
</script>
</body>
</html>
