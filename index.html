<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="description" content="Vynix - Connect with friends">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
  :root {
    --bg:#ffffff; --card:#f7f9fa; --text:#0f1419; --text2:#536471; --border:#e1e8ed;
    --accent:#ff2a6d; --glow:0 0 10px rgba(255,42,109,.35); --online-dot:#22c55e; --offline-dot:#9ca3af;
  }
  [data-theme="dark"] {
    --bg:#0f1419; --card:#1a1f25; --text:#ffffff; --text2:#8b98a5; --border:#2f3336;
  }
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;transition:background-color .3s,color .3s}
  #header{position:fixed;top:0;left:0;right:0;height:64px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:10}
  #header img{height:40px}
  .main{padding:64px 16px 80px}
  .tab{display:none}.tab.active{display:block}
  .search{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--text);margin-bottom:12px;transition:all .3s}
  .search:focus{outline:none;border-color:var(--accent);box-shadow:var(--glow)}
  .card,.trivia-card{display:flex;align-items:center;gap:14px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:12px;transition:all .3s}
  .card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
  .trivia-card{border-color:var(--accent);box-shadow:var(--glow);cursor:pointer}
  .avatar-wrapper{position:relative;flex-shrink:0}
  .avatar{width:52px;height:52px;border-radius:50%;object-fit:cover;background:#05d9e8;transition:transform .2s}
  .avatar:hover{transform:scale(1.05)}
  .status-dot{position:absolute;bottom:2px;right:2px;width:12px;height:12px;background:var(--online-dot);border-radius:50%;border:2px solid var(--bg);display:none;animation:pulse 2s infinite}
  .status-dot.offline{background:var(--offline-dot);animation:none}
  @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.8}}
  .name{font-weight:700;font-size:16px;display:flex;align-items:center;gap:4px}
  .verified-badge{color:var(--accent);font-size:18px!important;vertical-align:middle;margin-left:4px}
  .preview{font-size:14px;color:var(--text2);margin-top:2px}
  .preview-time{font-size:12px;color:var(--text2);margin-top:2px}
  .unread{background:var(--accent);color:#fff;font-size:11px;font-weight:700;padding:2px 6px;border-radius:10px;margin-left:auto}
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center}
  .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--text2);transition:.2s;position:relative;cursor:pointer}
  .nav-item.active{color:var(--accent);text-shadow:var(--glow)}
  .nav-item .material-icons{font-size:24px;margin-bottom:2px;transition:transform .2s}
  .nav-item:hover .material-icons{transform:scale(1.1)}
  .nav-badge{position:absolute;top:2px;right:8px;background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 5px;border-radius:10px;min-width:16px;text-align:center;display:none}
  .nav-badge.show{display:block}
  .fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;border:none;box-shadow:var(--glow);display:grid;place-items:center;z-index:20;cursor:pointer;transition:all .3s}
  .fab:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(255,42,109,.4)}
  .alert{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:600;display:none;z-index:1000}
  .alert.show{display:block;animation:fade .3s}
  @keyframes fade{from{opacity:0;transform:translate(-50%,-10px)}to{opacity:1;transform:translate(-50%,0)}}
  .custom-alert{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;display:none;align-items:center;justify-content:center}
  .custom-alert.active{display:flex}
  .alert-box{background:var(--card);border-radius:24px;padding:24px;margin:20px;max-width:320px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .alert-box h3{font-size:18px;font-weight:700;margin-bottom:12px;color:var(--text)}
  .alert-box p{font-size:14px;color:var(--text2);margin-bottom:20px}
  .alert-buttons{display:flex;gap:12px;justify-content:center}
  .alert-btn{padding:10px 20px;border-radius:999px;border:none;font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
  .alert-btn.primary{background:var(--accent);color:#fff}
  .alert-btn.secondary{background:var(--border);color:var(--text)}
  .alert-btn:hover{transform:scale(1.05)}
  .settings-section{background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid var(--border)}
  .settings-item{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer}
  .settings-item:last-child{border-bottom:none}
  .settings-item:hover{background:var(--bg);margin:0 -16px;padding-left:16px;padding-right:16px}
  .settings-label{font-weight:600;font-size:16px}
  .settings-description{font-size:14px;color:var(--text2);margin-top:2px}
  .toggle-switch{position:relative;width:50px;height:28px;background:var(--border);border-radius:999px;cursor:pointer;transition:background-color .3s}
  .toggle-switch.active{background:var(--accent)}
  .toggle-slider{position:absolute;top:2px;left:2px;width:24px;height:24px;background:#fff;border-radius:50%;transition:transform .3s}
  .toggle-switch.active .toggle-slider{transform:translateX(22px)}
  .theme-preview{display:flex;gap:8px;margin-top:8px}
  .theme-option{width:40px;height:40px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .3s}
  .theme-option:hover{transform:scale(1.1)}
  .theme-option.selected{border-color:var(--accent);box-shadow:var(--glow)}
  .theme-light{background:linear-gradient(135deg,#fff 50%,#f7f9fa 50%)}
  .theme-dark{background:linear-gradient(135deg,#0f1419 50%,#1a1f25 50%)}
  .theme-auto{background:linear-gradient(135deg,#fff 25%,#0f1419 25%,#0f1419 75%,#fff 75%)}
  .bottom-sheet{position:fixed;bottom:0;left:0;right:0;height:0;background:var(--card);border-top-left-radius:24px;border-top-right-radius:24px;overflow:hidden;transition:height .3s;z-index:100}
  .bottom-sheet.open{height:75vh}
  .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
  .sheet-content{padding:16px 20px;height:calc(75vh - 60px);overflow-y:auto}
  .user-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
  .user-row:last-child{border-bottom:none}
  .user-row img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  .user-row .name{flex:1;font-weight:600;display:flex;align-items:center;gap:4px}
  .follow-btn{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:6px 14px;font-size:13px;font-weight:600;cursor:pointer;transition:all .3s}
  .follow-btn.following{background:#e2e8f0;color:#536471}
  .follow-btn.requested{background:#6366f1;color:#fff}
  .follow-btn:hover{transform:scale(1.05)}
  .settings-header{font-size:20px;font-weight:700;margin-bottom:16px;color:var(--text)}
  .version-info{text-align:center;color:var(--text2);font-size:12px;margin-top:24px}
  .logout-btn{width:100%;padding:14px;border-radius:999px;background:#ef4444;color:#fff;border:none;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s}
  .logout-btn:hover{background:#dc2626;transform:scale(1.02)}
  .pwa-install-banner{position:fixed;top:0;left:0;right:0;background:var(--accent);color:#fff;padding:12px 16px;display:none;align-items:center;justify-content:space-between;z-index:1001;box-shadow:var(--glow)}
  .pwa-install-banner.show{display:flex}
  .pwa-install-text{font-weight:600;font-size:14px}
  .pwa-install-buttons{display:flex;gap:12px;align-items:center}
  .pwa-install-btn{background:#fff;color:var(--accent);border:none;border-radius:999px;padding:6px 14px;font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
  .pwa-install-btn:hover{transform:scale(1.05)}
  .pwa-install-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:4px}
  .offline-indicator{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:#666;color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;display:none;z-index:999}
  .offline-indicator.show{display:block}
  .no-long-press{-webkit-user-select:none;-webkit-touch-callout:none;-webkit-user-drag:none}
  .sheet-tabs{display:flex;border-bottom:1px solid var(--border);margin:0 -20px}
  .sheet-tab{flex:1;padding:12px;text-align:center;cursor:pointer;font-weight:600;color:var(--text2);transition:all .3s}
  .sheet-tab.active{color:var(--accent);background:rgba(255,42,109,.1)}
  .sheet-search{margin:16px 0;padding:12px 16px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--text);width:100%}
  .sheet-search:focus{outline:none;border-color:var(--accent);box-shadow:var(--glow)}
  .request-actions{display:flex;gap:8px}
  .request-btn{padding:6px 12px;border-radius:999px;border:none;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
  .request-btn.accept{background:#22c55e;color:#fff}
  .request-btn.decline{background:#ef4444;color:#fff}
  .request-btn:hover{transform:scale(1.05)}
  .verified-badge-gold{background:linear-gradient(45deg,#FFD700,#FFA500,#FFB800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:20px!important;font-weight:900;text-shadow:0 0 10px rgba(255,215,0,.5);animation:gold-shine 4s ease-in-out infinite;margin-left:6px;vertical-align:middle}
  @keyframes gold-shine{0%,100%{opacity:1}50%{opacity:.85;transform:scale(1.05)}}
  #trivia-card{border-color:#FFD700;box-shadow:0 0 16px rgba(255,215,0,.25)}
  .sheet-tab-modern{position:relative;display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 20px;background:transparent;border:none;color:var(--text2);font-weight:600;font-size:14px;transition:all .3s;border-radius:16px;min-width:100px}
  .sheet-tab-modern.active{color:var(--accent);background:rgba(255,42,109,.12);box-shadow:0 4px 12px rgba(255,42,109,.2)}
  .sheet-tab-modern .material-icons{font-size:24px!important}
  .sheet-tab-modern.active::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:30px;height:3px;background:var(--accent);border-radius:2px}
  .sheet-header-relative{position:relative;padding-top:16px}
  .sheet-content{padding:0 20px 20px;height:calc(75vh - 200px);overflow-y:auto}
  #sheet-list:empty::before,#requests-list:empty::before{content:"No users found";display:block;text-align:center;padding:40px 20px;color:var(--text2);font-size:15px}
  #verify-item{position:relative}
  #verify-badge.hidden{display:none}
  #posts-feed{max-height:calc(100vh - 64px - 60px - 12px);overflow-y:auto}
  .post-card{background:var(--card);border:1px solid var(--border);border-radius:16px;margin:12px 16px;padding:12px}
  .post-header{display:flex;align-items:center;gap:10px}
  .post-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
  .post-name{font-weight:700;font-size:15px;display:flex;align-items:center;gap:4px}
  .post-time{font-size:12px;color:var(--text2);margin-left:auto}
  .post-body{margin-top:10px;font-size:15px;white-space:pre-wrap}
  .post-media{width:100%;border-radius:12px;margin-top:10px}
  .post-actions{display:flex;justify-content:space-around;margin-top:12px}
  .post-btn{background:transparent;border:none;color:var(--text2);font-size:14px;cursor:pointer;display:flex;align-items:center;gap:4px;padding:6px 10px;border-radius:999px;transition:.2s}
  .post-btn:hover{background:rgba(255,42,109,.12);color:var(--accent)}
  .post-btn.liked{color:var(--accent)}
  #posts-loader{text-align:center;padding:12px;font-size:14px;color:var(--text2)}
  #composer-btn{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;border:none;box-shadow:var(--glow);display:grid;place-items:center;z-index:20;cursor:pointer}
  #composer-modal{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:30;display:none;align-items:center;justify-content:center}
  #composer-modal.active{display:flex}
  .composer-box{background:var(--card);width:90%;max-width:500px;border-radius:20px;padding:20px}
  #postText{width:100%;resize:none;border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--bg);color:var(--text)}
  .composer-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  #mediaUrl{display:none}
  </style>
</head>
<body>
  <!-- PWA Install Banner -->
  <div id="pwa-install-banner" class="pwa-install-banner">
    <div class="pwa-install-text">Install Vynix for a better experience</div>
    <div class="pwa-install-buttons">
      <button id="pwa-install-btn" class="pwa-install-btn">Install</button>
      <button id="pwa-install-close" class="pwa-install-close material-icons">close</button>
    </div>
  </div>
  <!-- Offline Indicator -->
  <div id="offline-indicator" class="offline-indicator">
    <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px">wifi_off</span>Offline
  </div>

  <header id="header">
    <a href="#" onclick="document.querySelector('.nav-item[data-tab=\'chats\']').click();event.preventDefault()" class="flex items-center h-full px-3 -ml-2">
      <img src="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png" alt="Vynix" class="h-10 w-auto object-contain">
    </a>
    <img id="me-avatar" class="avatar w-10 h-10 cursor-pointer">
  </header>

  <main class="main">
    <!-- POSTS TAB (default) -->
    <div id="posts" class="tab active">
      <div id="posts-feed"></div>
      <div id="posts-loader">Loading…</div>
    </div>

    <!-- CHATS -->
    <div id="chats" class="tab">
      <input class="search" id="search" placeholder="Search chats…">
      <div id="trivia-card" class="trivia-card">
        <div class="avatar-wrapper">
          <img class="avatar" src="https://ui-avatars.com/api/?name=AI&background=ff2a6d&color=fff">
          <span class="status-dot" style="display:block"></span>
        </div>
        <div class="flex-1">
          <div class="name">Smart Mental Health Assistant<span class="material-icons verified-badge-gold">verified</span></div>
          <div class="preview">Get the best professional help you need</div>
          <div class="preview-time">Always available • Verified AI</div>
        </div>
      </div>
      <div id="chat-list"></div>
    </div>

    <!-- CHANNELS -->
    <div id="channels" class="tab">
      <div class="text-secondary text-sm p-4">Channels coming soon.</div>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="tab">
      <div class="settings-section">
        <div class="settings-header">Appearance</div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Dark Mode</div>
            <div class="settings-description">Switch to dark theme</div>
          </div>
          <div class="toggle-switch" id="dark-mode-toggle"><div class="toggle-slider"></div></div>
        </div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Theme</div>
            <div class="settings-description">Choose your color theme</div>
          </div>
          <div class="theme-preview">
            <div class="theme-option theme-light selected" data-theme="light" title="Light"></div>
            <div class="theme-option theme-dark" data-theme="dark" title="Dark"></div>
            <div class="theme-option theme-auto" data-theme="auto" title="Auto"></div>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-header">Notifications</div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Push Notifications</div>
            <div class="settings-description">Receive push notifications</div>
          </div>
          <div class="toggle-switch active" id="notifications-toggle"><div class="toggle-slider"></div></div>
        </div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Sound</div>
            <div class="settings-description">Play notification sounds</div>
          </div>
          <div class="toggle-switch active" id="sound-toggle"><div class="toggle-slider"></div></div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-header">Privacy</div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Online Status</div>
            <div class="settings-description">Show when you're online</div>
          </div>
          <div class="toggle-switch active" id="online-status-toggle"><div class="toggle-slider"></div></div>
        </div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Read Receipts</div>
            <div class="settings-description">Show when you've read messages</div>
          </div>
          <div class="toggle-switch active" id="read-receipts-toggle"><div class="toggle-slider"></div></div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-header">Account</div>
        <div class="settings-item" id="profile-item">
          <div>
            <div class="settings-label">Profile</div>
            <div class="settings-description">Edit your profile information</div>
          </div>
          <span class="material-icons" style="color:var(--text2)">chevron_right</span>
        </div>
        <div class="settings-item" id="verify-item">
          <div>
            <div class="settings-label">Get Verified</div>
            <div class="settings-description">R69 / month – blue check-mark</div>
          </div>
          <span id="verify-badge" class="hidden ml-2 px-2 py-0.5 rounded-full bg-accent text-white text-xs">Active</span>
          <span class="material-icons" style="color:var(--text2)">chevron_right</span>
        </div>
        <div class="settings-item" id="privacy-policy-item">
          <div>
            <div class="settings-label">Privacy Policy</div>
            <div class="settings-description">Read our privacy policy</div>
          </div>
          <span class="material-icons" style="color:var(--text2)">chevron_right</span>
        </div>
        <div class="settings-item" id="terms-item">
          <div>
            <div class="settings-label">Terms of Service</div>
            <div class="settings-description">Read our terms of service</div>
          </div>
          <span class="material-icons" style="color:var(--text2)">chevron_right</span>
        </div>
      </div>
      <button id="logout-btn" class="logout-btn">
        <span class="material-icons" style="vertical-align:middle;margin-right:8px">logout</span>Log Out
      </button>
      <div class="version-info">Vynix v1.0.0 • Made with ❤️</div>
    </div>
  </main>

  <button id="add-fab" class="fab material-icons">person_add</button>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="posts"><span class="material-icons">article</span>Posts</div>
    <div class="nav-item" data-tab="chats">
      <span class="material-icons">chat</span>Chats
      <span id="chat-badge" class="nav-badge">0</span>
    </div>
    <a href="ai.html" class="nav-item"><span class="material-icons">auto_awesome</span>Buddy</a>
    <div class="nav-item" data-tab="settings"><span class="material-icons">settings</span>Settings</div>
  </nav>

  <!-- bottom-sheet -->
  <div id="sheet" class="bottom-sheet">
    <div class="sheet-header-relative">
      <div style="height:5px;width:40px;background:var(--border);border-radius:3px;margin:12px auto"></div>
      <h3 style="text-align:center;font-weight:700;font-size:18px;margin:8px 0 16px">Add Friends</h3>
    </div>
    <div class="flex justify-center gap-8 mb-6 px-6">
      <button class="sheet-tab-modern active" data-tab="suggestions">
        <span class="material-icons text-20">people</span><span>Suggestions</span>
      </button>
      <button class="sheet-tab-modern" data-tab="requests">
        <span class="material-icons text-20">person_add</span><span>Requests</span>
        <span id="request-count" class="nav-badge" style="position:absolute;top:-4px;right:-8px">0</span>
      </button>
    </div>
    <div class="px-5 mb-4">
      <input type="text" class="sheet-search" id="user-search" placeholder="Search users...">
    </div>
    <button id="close-sheet" class="absolute top-4 right-5 text-2xl text-gray-500 hover:text-gray-700">
      <span class="material-icons">close</span>
    </button>
    <div class="sheet-content px-5">
      <div id="suggestions-tab" class="tab-content"><div id="sheet-list"></div></div>
      <div id="requests-tab" class="tab-content" style="display:none"><div id="requests-list"></div></div>
    </div>
  </div>

  <div id="alert" class="alert"></div>

  <div id="custom-alert" class="custom-alert">
    <div class="alert-box">
      <h3 id="alert-title">Confirm</h3>
      <p id="alert-message">Are you sure?</p>
      <div class="alert-buttons">
        <button id="alert-cancel" class="alert-btn secondary">Cancel</button>
        <button id="alert-confirm" class="alert-btn primary">Confirm</button>
      </div>
    </div>
  </div>

  <div id="legal-modal" class="custom-alert">
    <div class="alert-box">
      <h3 id="legal-title">Legal</h3>
      <div class="legal-content" id="legal-content"></div>
      <div class="alert-buttons">
        <button id="legal-close" class="alert-btn primary">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
  import { getDatabase, ref, get, onValue, push, set, remove, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
  import { getRemoteConfig, fetchAndActivate, getValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

  const firebaseConfig = {
    apiKey:"AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain:"fire-b-a8878.firebaseapp.com",
    databaseURL:"https://fire-b-a8878.firebaseio.com",
    projectId:"fire-b-a8878",
    storageBucket:"fire-b-a8878.firebasestorage.app",
    messagingSenderId:"658673187627",
    appId:"1:658673187627:web:6e4c29af661785f0afa36e"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const remoteConfig = getRemoteConfig(app);
  remoteConfig.settings.minimumFetchIntervalMillis = 3600000;
  remoteConfig.defaultConfig = { yoco_public_key:"", payments_enabled:false };

  let uid, totalUnreadCount = 0, chatListeners = new Map();
  let settings = { darkMode:false, theme:"light", notifications:true, sound:true, onlineStatus:true, readReceipts:true };
  let yocoPublicKey = "", paymentsEnabled = false;

  /* ---------- helpers ---------- */
  const toast = msg => {
    const al = document.getElementById('alert');
    al.textContent = msg;
    al.classList.add('show');
    setTimeout(() => al.classList.remove('show'), 2500);
  };
  const showCustomAlert = (title, message, onConfirm) => {
    document.getElementById('alert-title').textContent = title;
    document.getElementById('alert-message').textContent = message;
    document.getElementById('custom-alert').classList.add('active');
    document.getElementById('alert-confirm').onclick = () => {
      document.getElementById('custom-alert').classList.remove('active');
      onConfirm();
    };
    document.getElementById('alert-cancel').onclick = () => document.getElementById('custom-alert').classList.remove('active');
  };
  const decrypt = async (enc, chatId) => {
    try {
      const { iv, ciphertext } = JSON.parse(enc);
      const ivBuf = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
      const cipherBuf = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
      const encoder = new TextEncoder();
      const keyMat = await crypto.subtle.importKey('raw', encoder.encode('vynix-2025'), { name:'PBKDF2' }, false, ['deriveKey']);
      const key = await crypto.subtle.deriveKey({ name:'PBKDF2', salt:encoder.encode(chatId), iterations:100000, hash:'SHA-256' }, keyMat, { name:'AES-GCM', length:256 }, true, ['decrypt']);
      const dec = await crypto.subtle.decrypt({ name:'AES-GCM', iv:ivBuf }, key, cipherBuf);
      return new TextDecoder().decode(dec);
    } catch { return '…'; }
  };

  /* ---------- legal ---------- */
  const legalContent = {
    'privacy-policy':{
      title:'Privacy Policy',
      content:`<h4>1. Introduction</h4><p>Welcome to Vynix. Your privacy is important to us.</p><h4>2. Information We Collect</h4><p>We collect information you provide directly to us.</p><h4>3. How We Use Your Information</h4><p>We use your information to provide and improve our services.</p><h4>4. Data Security</h4><p>We implement appropriate security measures.</p><h4>5. Contact Us</h4><p>support@vynix.com</p>`
    },
    'terms':{
      title:'Terms of Service',
      content:`<h4>1. Acceptance</h4><p>By using Vynix you agree to these Terms.</p><h4>2. License</h4><p>Personal, non-commercial use only.</p><h4>3. Conduct</h4><p>Don't use Vynix for unlawful purposes.</p><h4>4. Content</h4><p>You retain rights to your content.</p><h4>5. Changes</h4><p>We may modify these terms at any time.</p>`
    }
  };
  const showLegalModal = type => {
    const content = legalContent[type];
    if (!content) return;
    document.getElementById('legal-title').textContent = content.title;
    document.getElementById('legal-content').innerHTML = content.content;
    document.getElementById('legal-modal').classList.add('active');
  };
  document.getElementById('legal-close').onclick = () => document.getElementById('legal-modal').classList.remove('active');

  /* ---------- settings ---------- */
  const loadSettings = () => {
    const saved = localStorage.getItem('vynix-settings');
    if (saved) settings = { ...settings, ...JSON.parse(saved) };
    applySettings();
  };
  const saveSettings = () => {
    localStorage.setItem('vynix-settings', JSON.stringify(settings));
    applySettings();
  };
  const applySettings = () => {
    if (settings.darkMode || (settings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.body.setAttribute('data-theme', 'dark');
      document.getElementById('dark-mode-toggle').classList.add('active');
    } else {
      document.body.setAttribute('data-theme', 'light');
      document.getElementById('dark-mode-toggle').classList.remove('active');
    }
    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.theme === settings.theme));
    document.getElementById('notifications-toggle').classList.toggle('active', settings.notifications);
    document.getElementById('sound-toggle').classList.toggle('active', settings.sound);
    document.getElementById('online-status-toggle').classList.toggle('active', settings.onlineStatus);
    document.getElementById('read-receipts-toggle').classList.toggle('active', settings.readReceipts);
  };
  const initializeSettings = () => {
    loadSettings();
    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
      settings.darkMode = !settings.darkMode;
      settings.theme = settings.darkMode ? 'dark' : 'light';
      saveSettings();
    });
    document.querySelectorAll('.theme-option').forEach(opt => opt.addEventListener('click', () => {
      settings.theme = opt.dataset.theme;
      settings.darkMode = settings.theme === 'dark';
      saveSettings();
    }));
    document.getElementById('notifications-toggle').addEventListener('click', () => {
      settings.notifications = !settings.notifications;
      saveSettings();
      toast(settings.notifications ? 'Notifications enabled' : 'Notifications disabled');
    });
    document.getElementById('sound-toggle').addEventListener('click', () => {
      settings.sound = !settings.sound;
      saveSettings();
      toast(settings.sound ? 'Sound enabled' : 'Sound disabled');
    });
    document.getElementById('online-status-toggle').addEventListener('click', () => {
      settings.onlineStatus = !settings.onlineStatus;
      saveSettings();
      toast(settings.onlineStatus ? 'Online status visible' : 'Online status hidden');
      updateUserOnlineStatus();
    });
    document.getElementById('read-receipts-toggle').addEventListener('click', () => {
      settings.readReceipts = !settings.readReceipts;
      saveSettings();
      toast(settings.readReceipts ? 'Read receipts enabled' : 'Read receipts disabled');
    });
    document.getElementById('profile-item').onclick = () => location.href = 'profile.html';
    document.getElementById('privacy-policy-item').onclick = () => showLegalModal('privacy-policy');
    document.getElementById('terms-item').onclick = () => showLegalModal('terms');
    document.getElementById('logout-btn').addEventListener('click', () => {
      showCustomAlert('Log Out', 'Are you sure you want to log out?', async () => {
        try {
          await signOut(auth);
          toast('Logged out successfully');
          setTimeout(() => location.href = 'login.html', 1000);
        } catch { toast('Error logging out'); }
      });
    });
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      if (settings.theme === 'auto') applySettings();
    });
  };

  /* ---------- online ---------- */
  const updateOnlineStatus = () => {
    const isOnline = navigator.onLine;
    document.getElementById('offline-indicator').classList.toggle('show', !isOnline);
    if (isOnline && uid) updateUserOnlineStatus();
  };
  const updateUserOnlineStatus = () => {
    if (!uid) return;
    const userStatusRef = ref(db, `users/${uid}/status`);
    if (settings.onlineStatus) {
      set(userStatusRef, 'online');
      onDisconnect(userStatusRef).set('offline');
    } else {
      set(userStatusRef, 'offline');
      onDisconnect(userStatusRef).set('offline');
    }
  };
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);

  const listenToFriendOnlineStatus = friendId => {
    const statusRef = ref(db, `users/${friendId}/status`);
    return onValue(statusRef, snap => {
      const status = snap.val();
      const dot = document.getElementById(`dot-${friendId}`);
      if (dot) {
        dot.style.display = 'block';
        dot.classList.toggle('offline', status !== 'online' || !settings.onlineStatus);
      }
    });
  };

  /* ---------- PWA ---------- */
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('pwa-install-banner').classList.add('show');
  });
  document.getElementById('pwa-install-btn').onclick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') toast('App installed successfully!');
      deferredPrompt = null;
      document.getElementById('pwa-install-banner').classList.remove('show');
    }
  };
  document.getElementById('pwa-install-close').onclick = () => document.getElementById('pwa-install-banner').classList.remove('show');

  /* ---------- search ---------- */
  document.getElementById('search').addEventListener('input', e => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('#chat-list .card').forEach(card => {
      card.style.display = card.querySelector('.name').textContent.toLowerCase().includes(term) ? '' : 'none';
    });
  });

  /* ---------- trivia ---------- */
  document.getElementById('trivia-card').onclick = () => location.href = 'trivia.html';

  /* ---------- bottom-sheet ---------- */
  const openSheet = () => document.getElementById('sheet').classList.add('open');
  const closeSheet = () => document.getElementById('sheet').classList.remove('open');
  document.getElementById('close-sheet').onclick = closeSheet;

  const loadAllUsers = async () => {
    const list = document.getElementById('sheet-list');
    list.innerHTML = 'Loading…';
    const [snap, followingSnap, sentSnap] = await Promise.all([
      get(ref(db, 'users')),
      get(ref(db, `users/${uid}/following`)),
      get(ref(db, `users/${uid}/sentRequests`))
    ]);
    const following = followingSnap.val() || {};
    const sent = sentSnap.val() || {};
    list.innerHTML = '';
    snap.forEach(child => {
      if (child.key === uid) return;
      const user = child.val();
      const isFollowing = !!following[child.key];
      const hasSent = !!sent[child.key];
      const row = document.createElement('div');
      row.className = 'user-row';
      row.innerHTML = `
        <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=05d9e8&color=fff`}">
        <div class="name">${user.displayName || user.email}${user.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}</div>
        <button class="follow-btn ${isFollowing ? 'following' : hasSent ? 'requested' : ''}" data-uid="${child.key}">
          ${isFollowing ? 'Following' : hasSent ? 'Requested' : 'Follow'}
        </button>`;
      list.appendChild(row);
      const btn = row.querySelector('.follow-btn');
      if (isFollowing) btn.disabled = true;
      else if (hasSent) btn.onclick = () => cancelFollowRequest(child.key);
      else btn.onclick = () => sendFollowRequest(child.key);
    });
  };
  const sendFollowRequest = async tid => {
    await set(ref(db, `users/${uid}/sentRequests/${tid}`), { timestamp: serverTimestamp() });
    await set(ref(db, `users/${tid}/receivedRequests/${uid}`), { timestamp: serverTimestamp() });
    toast('Follow request sent');
    loadAllUsers();
  };
  const cancelFollowRequest = async tid => {
    await remove(ref(db, `users/${uid}/sentRequests/${tid}`));
    await remove(ref(db, `users/${tid}/receivedRequests/${uid}`));
    toast('Request cancelled');
    loadAllUsers();
  };
  const loadFollowRequests = async () => {
    const list = document.getElementById('requests-list');
    const snap = await get(ref(db, `users/${uid}/receivedRequests`));
    const reqs = snap.val() || {};
    document.getElementById('request-count').textContent = Object.keys(reqs).length;
    document.getElementById('request-count').classList.toggle('show', Object.keys(reqs).length > 0);
    list.innerHTML = '';
    for (const id in reqs) {
      const userSnap = await get(ref(db, `users/${id}`));
      const user = userSnap.val();
      const row = document.createElement('div');
      row.className = 'user-row';
      row.innerHTML = `
        <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=05d9e8&color=fff`}">
        <div class="name">${user.displayName || user.email}${user.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}</div>
        <div class="request-actions">
          <button class="request-btn accept" data-uid="${id}">Accept</button>
          <button class="request-btn decline" data-uid="${id}">Decline</button>
        </div>`;
      row.querySelector('.accept').onclick = () => acceptRequest(id);
      row.querySelector('.decline').onclick = () => declineRequest(id);
      list.appendChild(row);
    }
    if (!list.innerHTML) list.innerHTML = '<p class="text-center py-4 text-gray-500">No pending requests</p>';
  };
  const acceptRequest = async tid => {
    await set(ref(db, `users/${uid}/followers/${tid}`), true);
    await set(ref(db, `users/${tid}/following/${uid}`), true);
    await remove(ref(db, `users/${uid}/receivedRequests/${tid}`));
    await remove(ref(db, `users/${tid}/sentRequests/${uid}`));
    toast('Request accepted');
    loadFollowRequests();
    loadChats();
  };
  const declineRequest = async tid => {
    await remove(ref(db, `users/${uid}/receivedRequests/${tid}`));
    await remove(ref(db, `users/${tid}/sentRequests/${uid}`));
    toast('Request declined');
    loadFollowRequests();
  };
  document.getElementById('add-fab').onclick = () => {
    openSheet();
    loadAllUsers();
    loadFollowRequests();
  };
  document.getElementById('user-search').addEventListener('input', e => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('#sheet-list .user-row').forEach(row => {
      row.style.display = row.querySelector('.name').textContent.toLowerCase().includes(term) ? 'flex' : 'none';
    });
  });

  /* ---------- nav ---------- */
  document.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      el.classList.add('active');
      const tab = el.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if (tab) {
        document.getElementById(tab).classList.add('active');
        document.getElementById('add-fab').style.display = tab === 'chats' ? 'grid' : 'none';
      }
    });
  });
  document.querySelectorAll('.sheet-tab-modern').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.sheet-tab-modern').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const pane = tab.dataset.tab;
      document.getElementById('suggestions-tab').style.display = pane === 'suggestions' ? 'block' : 'none';
      document.getElementById('requests-tab').style.display = pane === 'requests' ? 'block' : 'none';
      if (pane === 'requests') loadFollowRequests();
    });
  });

  /* ---------- chats ---------- */
  const loadChats = async () => {
    const list = document.getElementById('chat-list');
    list.innerHTML = '';
    const followingSnap = await get(ref(db, `users/${uid}/following`));
    const following = followingSnap.val() || {};
    const ids = Object.keys(following);
    if (!ids.length) {
      list.innerHTML = '<p class="text-secondary text-center mt-10">Follow friends to start chatting</p>';
      return;
    }
    chatListeners.forEach(u => u());
    chatListeners.clear();
    totalUnreadCount = 0;
    const users = await Promise.all(ids.map(async id => {
      const [u, c] = await Promise.all([get(ref(db, `users/${id}`)), get(ref(db, `users/${uid}/chats/${id}`)]);
      return { id, user: u.val(), chatMeta: c.val() || {} };
    }));
    users.sort((a, b) => (b.chatMeta.lastMessageTime || 0) - (a.chatMeta.lastMessageTime || 0));
    users.forEach(({ id, user, chatMeta }) => {
      if (!user) return;
      const card = document.createElement('div');
      card.className = 'card';
      card.id = `chat-card-${id}`;
      card.innerHTML = `
        <div class="avatar-wrapper">
          <img class="avatar" src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=05d9e8&color=fff`}">
          <span id="dot-${id}" class="status-dot"></span>
        </div>
        <div class="flex-1">
          <div class="name">${user.displayName || user.email}${user.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}</div>
          <div id="prev-${id}" class="preview">Tap to chat</div>
          <div id="time-${id}" class="preview-time"></div>
        </div>
        <span id="unread-${id}" class="unread" style="display:none">0</span>`;
      card.onclick = () => startChat(id, user);
      list.appendChild(card);
      const chatId = [uid, id].sort().join('_');
      const lastUnsub = onValue(ref(db, `users/${uid}/chats/${id}/lastMessage`), async s => {
        if (s.exists()) {
          const msg = await decrypt(s.val(), chatId);
          const el = document.getElementById(`prev-${id}`);
          if (el) el.textContent = msg;
        }
      });
      chatListeners.set(`lastMsg-${id}`, lastUnsub);
      const timeUnsub = onValue(ref(db, `users/${uid}/chats/${id}/lastMessageTime`), s => {
        if (s.exists()) {
          const el = document.getElementById(`time-${id}`);
          if (el) el.textContent = formatTime(s.val());
        }
      });
      chatListeners.set(`time-${id}`, timeUnsub);
      const unreadUnsub = onValue(ref(db, `users/${uid}/chats/${id}/unreadCount`), s => {
        const cnt = s.val() || 0;
        const badge = document.getElementById(`unread-${id}`);
        if (badge) {
          badge.style.display = cnt ? 'inline' : 'none';
          badge.textContent = cnt > 99 ? '99+' : cnt;
        }
        updateTotalUnreadCount();
      });
      chatListeners.set(`unread-${id}`, unreadUnsub);
      const onlineUnsub = listenToFriendOnlineStatus(id);
      chatListeners.set(`online-${id}`, onlineUnsub);
    });
  };
  const updateTotalUnreadCount = () => {
    let total = 0;
    document.querySelectorAll('[id^="unread-"]').forEach(b => total += parseInt(b.textContent) || 0);
    totalUnreadCount = total;
    const badge = document.getElementById('chat-badge');
    if (badge) {
      badge.textContent = total > 99 ? '99+' : total;
      badge.classList.toggle('show', total > 0);
    }
  };
  const startChat = (tid, user) => {
    const params = new URLSearchParams({
      chatId: [uid, tid].sort().join('_'),
      userId: tid,
      username: user.displayName || '',
      avatar: user.photoURL || '',
      verified: !!user.verified,
      isGroup: false
    });
    location.href = `chat.html?${params.toString()}`;
  };
  const formatTime = ts => {
    const diff = Date.now() - ts;
    const m = Math.floor(diff / 60000);
    const h = Math.floor(diff / 3600000);
    if (m < 1) return 'Just now';
    if (m < 60) return `${m}m ago`;
    if (h < 24) return `${h}h ago`;
    return 'Today';
  };

  /* ---------- profile modal ---------- */
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden';
  modal.innerHTML = `
    <div class="bg-card rounded-2xl p-6 w-11/12 max-w-sm">
      <img id="modal-img" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover">
      <div id="modal-name" class="text-center text-lg font-bold"></div>
      <button class="block mt-4 mx-auto px-4 py-2 rounded-full bg-accent text-white close-profile-btn">Close</button>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => {
    if (e.target.classList.contains('close-profile-btn')) modal.classList.add('hidden');
  });
  window.openProfileModal = user => {
    document.getElementById('modal-img').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=05d9e8&color=fff`;
    document.getElementById('modal-name').textContent = user.displayName || user.email;
    modal.classList.remove('hidden');
  };

  /* ---------- auth ---------- */
  onAuthStateChanged(auth, async user => {
    if (!user) return (location.href = 'login.html');
    uid = user.uid;
    document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=ff2a6d&color=fff`;
    document.getElementById('me-avatar').onclick = () => location.href = 'profile.html';

    /* remote config */
    try {
      await fetchAndActivate(remoteConfig);
      yocoPublicKey = getValue(remoteConfig, "yoco_public_key").asString();
      paymentsEnabled = getValue(remoteConfig, "payments_enabled").asBoolean();
    } catch (e) {
      paymentsEnabled = false;
    }

    initializeSettings();
    updateOnlineStatus();
    await loadChats();
    initPosts(); // load posts feed

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
        self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
        self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', e => {
          if (e.request.mode === 'navigate') e.respondWith(fetch(e.request).catch(() => fetch('/')));
        });
      `));
    }
  });

  window.addEventListener('beforeunload', () => chatListeners.forEach(u => u()));

  /* ---------- verified badge ---------- */
  const renderVerifiedStatus = () => {
    if (!uid) return;
    onValue(ref(db, `users/${uid}/verified`), snap => {
      const v = snap.val();
      const badge = document.getElementById('verify-badge');
      if (v?.active && v.expiresAt > Date.now()) {
        badge.classList.remove('hidden');
        badge.textContent = `Active • ${new Date(v.expiresAt).toLocaleDateString()}`;
      } else {
        badge.classList.add('hidden');
      }
    });
  };
  renderVerifiedStatus();

  document.getElementById('verify-item').addEventListener('click', async () => {
    if (!document.getElementById('verify-badge').classList.contains('hidden')) {
      toast("You are already verified!");
      return;
    }
    if (!paymentsEnabled) {
      toast("Verified badges are coming soon");
      return;
    }
    if (!yocoPublicKey) {
      toast("Payment system not ready yet");
      return;
    }
    const label = document.querySelector('#verify-item .settings-label');
    const originalText = label.textContent;
    label.textContent = "Opening payment...";
    document.getElementById('verify-item').style.opacity = "0.6";
    document.getElementById('verify-item').style.pointerEvents = "none";

    try {
      if (!window.YocoSDK) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
          script.onload = resolve;
          script.onerror = () => reject();
          document.head.appendChild(script);
        });
      }
      const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
      const result = await yoco.showPopup({
        amountInCents: 6900,
        currency: 'ZAR',
        title: 'Vynix Verified',
        description: 'R69 – Blue check-mark',
        metadata: { userId: uid }
      });
      if (result.status === 'successful') {
        const expiresAt = Date.now() + 365 * 24 * 60 * 60 * 1000;
        await set(ref(db, `users/${uid}/verified`), {
          active: true,
          chargeId: result.id,
          purchasedAt: serverTimestamp(),
          expiresAt
        });
        toast("Verified! Welcome");
      } else {
        toast("Payment cancelled");
      }
    } catch (e) {
      console.error(e);
      toast("Payment failed");
    } finally {
      label.textContent = originalText;
      document.getElementById('verify-item').style.opacity = "";
      document.getElementById('verify-item').style.pointerEvents = "";
    }
  });

  /* ---------- posts ---------- */
  const $ = q => document.querySelector(q);
  let oldestKey = null, loading = false, postsPerPage = 10, listeners = {};
  $('#composer-btn').onclick = () => $('#composer-modal').classList.add('active');
  $('#cancelPost').onclick = () => $('#composer-modal').classList.remove('active');
  $('#publishPost').onclick = publish;
  $('#uploadMedia').onclick = () => cloudinary.open();

  const cloudinary = window.cloudinary?.createUploadWidget ?
    window.cloudinary.createUploadWidget(
      { cloudName: 'YOUR_CLOUD_NAME', uploadPreset: 'unsigned_preset', sources: ['local', 'camera'], multiple: false },
      (err, res) => { if (!err && res.event === 'success') $('#mediaUrl').value = res.info.secure_url; }
    ) : { open: () => toast('Cloudinary not loaded') };

  async function publish() {
    const text = $('#postText').value.trim();
    const media = $('#mediaUrl').value;
    if (!text && !media) return toast('Empty post');
    $('#publishPost').disabled = true;
    const postRef = push(ref(db, 'posts'));
    await set(postRef, { author: uid, text, media, likes: 0, comments: 0, reposts: 0, timestamp: serverTimestamp() });
    $('#postText').value = $('#mediaUrl').value = '';
    $('#composer-modal').classList.remove('active');
    $('#publishPost').disabled = false;
    toast('Posted!');
  }

  function initPosts() {
    if (loading) return;
    loading = true;
    $('#posts-feed').innerHTML = '';
    oldestKey = null;
    loadBatch();
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) loadBatch();
    });
  }

  async function loadBatch() {
    $('#posts-loader').style.display = 'block';
    const qry = oldestKey ?
      ref(db, 'posts').orderByKey().endBefore(oldestKey).limitToLast(postsPerPage) :
      ref(db, 'posts').orderByKey().limitToLast(postsPerPage);
    onValue(qry, snap => {
      const rows = [];
      snap.forEach(c => rows.unshift({ key: c.key, ...c.val() }));
      if (!rows.length) { $('#posts-loader').textContent = 'No more posts'; return; }
      oldestKey = rows[rows.length - 1].key;
      rows.forEach(renderPost);
      $('#posts-loader').style.display = 'none';
      loading = false;
    }, { onlyOnce: true });
  }

  function renderPost(p) {
    if (listeners[p.key]) return;
    const card = document.createElement('div');
    card.className = 'post-card';
    card.id = `post-${p.key}`;
    card.innerHTML = `
      <div class="post-header">
        <img class="post-avatar" id="ava-${p.key}">
        <div class="post-name" id="name-${p.key}"></div>
        <div class="post-time" id="time-${p.key}"></div>
      </div>
      <div class="post-body" id="body-${p.key}"></div>
      <img class="post-media hidden" id="img-${p.key}">
      <div class="post-actions">
        <button class="post-btn like" data-id="${p.key}"><span class="material-icons">favorite_border</span><span id="likes-${p.key}">${p.likes || 0}</span></button>
        <button class="post-btn comment" data-id="${p.key}"><span class="material-icons">comment</span><span id="comments-${p.key}">${p.comments || 0}</span></button>
        <button class="post-btn repost" data-id="${p.key}"><span class="material-icons">repeat</span><span id="reposts-${p.key}">${p.reposts || 0}</span></button>
      </div>`;
    $('#posts-feed').appendChild(card);
    onValue(ref(db, `users/${p.author}`), s => {
      const u = s.val();
      if (!u) return;
      $(`#ava-${p.key}`).src = u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName || 'U'}&background=05d9e8&color=fff`;
      $(`#name-${p.key}`).innerHTML = `${u.displayName || u.email}${u.verified ? '<span class="material-icons verified">verified</span>' : ''}`;
    });
    $(`#time-${p.key}`).textContent = new Date(p.timestamp || Date.now()).toLocaleString();
    $(`#body-${p.key}`).textContent = p.text || '';
    if (p.media) { $(`#img-${p.key}`).src = p.media; $(`#img-${p.key}`).classList.remove('hidden'); }
    onValue(ref(db, `postLikes/${p.key}/${uid}`), s => card.querySelector('.like').classList.toggle('liked', !!s.val()));
    card.querySelector('.like').onclick = () => toggleLike(p.key);
    card.querySelector('.comment').onclick = () => toast('Comments – coming soon');
    card.querySelector('.repost').onclick = () => toggleRepost(p.key);
    listeners[p.key] = true;
  }

  async function toggleLike(pid) {
    const likeRef = ref(db, `postLikes/${pid}/${uid}`);
    const postRef = ref(db, `posts/${pid}/likes`);
    const snap = await get(likeRef);
    if (snap.exists()) {
      await set(likeRef, null);
      await set(postRef, (await get(postRef)).val() - 1);
    } else {
      await set(likeRef, true);
      await set(postRef, (await get(postRef)).val() + 1);
    }
  }
  async function toggleRepost(pid) {
    const repRef = ref(db, `postReposts/${pid}/${uid}`);
    const postRef = ref(db, `posts/${pid}/reposts`);
    const snap = await get(repRef);
    if (snap.exists()) {
      await set(repRef, null);
      await set(postRef, (await get(postRef)).val() - 1);
    } else {
      await set(repRef, true);
      await set(postRef, (await get(postRef)).val() + 1);
    }
  }
  </script>
</body>
</html>
