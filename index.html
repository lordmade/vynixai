<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#0f0f14"/>
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f0f14"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="description" content="Vynix • Premium Immersive Music Experience"/>
  <title>Vynix • Music</title>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" type="image/png" sizes="192x192" href="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png"/>
  <link rel="apple-touch-icon" sizes="192x192" href="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png"/>
  <link rel="apple-touch-icon" sizes="512x512" href="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png"/>
 
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
:root {
  --bg-main: #fafafa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f0f0f5;
  --surface: #ffffff;
  --surface-hover: #f5f5fa;

  --accent: #7c3aed;
  --accent-light: #8b5cf6;
  --accent-dark: #6d28d9;
  --accent-glow: rgba(124, 58, 237, 0.18);

  --text-primary: #1a1a1a;
  --text-secondary: #4b5563;
  --text-muted: #9ca3af;

  --border-subtle: rgba(0, 0, 0, 0.08);
  --border-strong: rgba(0, 0, 0, 0.15);

  --radius-s: 12px;
  --radius-m: 20px;
  --radius-l: 28px;
  --radius-xl: 36px;

  --header-height: 74px;
  --player-mini: 86px;
  --player-full: 100%;

  --transition: all 0.42s cubic-bezier(0.34, 1.56, 0.64, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

body {
  background: var(--bg-main);
  color: var(--text-primary);
  font-family: 'Inter', system-ui, sans-serif;
  height: 100dvh;
  overflow: hidden;
  display: flex;
  touch-action: manipulation;
}

.hidden { display: none !important; }

.glass {
  background: rgba(255, 255, 255, 0.72);
  backdrop-filter: saturate(180%) blur(22px);
  -webkit-backdrop-filter: saturate(180%) blur(22px);
  border: 1px solid var(--border-subtle);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
}

.default-cover {
  background: linear-gradient(135deg, #a78bfa, #7c3aed, #6d28d9);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.8rem;
  font-weight: bold;
}

/* ── MODAL ── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  z-index: 6000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
.modal-overlay.show { opacity: 1; pointer-events: all; }
.modal-content {
  background: var(--surface);
  border-radius: var(--radius-l);
  width: 90%;
  max-width: 420px;
  padding: 2.2rem;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.12);
  transform: scale(0.92);
  opacity: 0;
  transition: var(--transition);
}
.modal-overlay.show .modal-content { transform: scale(1); opacity: 1; }
.modal-title {
  font-size: 1.8rem;
  font-weight: 800;
  margin-bottom: 1.2rem;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.modal-input {
  width: 100%;
  padding: 1.1rem 1.4rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-s);
  color: var(--text-primary);
  font-size: 1rem;
  margin-bottom: 1.4rem;
  transition: all 0.3s ease;
}
.modal-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.22);
}
.btn {
  padding: 1rem 1.8rem;
  border-radius: 999px;
  font-weight: 700;
  font-size: 0.98rem;
  cursor: pointer;
  border: none;
  transition: all 0.32s ease;
}
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-2px); }
.btn-secondary { background: rgba(0, 0, 0, 0.08); color: var(--text-primary); }

/* ── SEARCH ── */
.search-box {
  background: rgba(0, 0, 0, 0.04);
  border-radius: 999px;
  padding: 0.9rem 3.4rem 0.9rem 1.3rem;
  display: flex;
  align-items: center;
  gap: 0.9rem;
  border: 1px solid var(--border-subtle);
  transition: all 0.35s ease;
}
.search-box:focus-within {
  background: rgba(0, 0, 0, 0.08);
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.22);
}
.search-box input {
  background: transparent;
  border: none;
  color: var(--text-primary);
  width: 100%;
  font-weight: 500;
  font-size: 0.98rem;
}

/* ── SIDEBAR / DRAWER ── */
.sidebar {
  width: 300px;
  background: var(--bg-secondary);
  box-shadow: 4px 0 40px rgba(0, 0, 0, 0.08);
  padding: 1.8rem;
  transition: transform 0.52s cubic-bezier(0.32, 0.72, 0.2, 1);
  display: flex;
  flex-direction: column;
  position: fixed;
  left: 0;
  top: 0;
  height: 100dvh;
  z-index: 400;
  transform: translateX(-100%);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-top: calc(var(--header-height) + 1.6rem);
}
.sidebar.open { transform: translateX(0); }

.sidebar::-webkit-scrollbar {
  width: 6px;
}
.sidebar::-webkit-scrollbar-track {
  background: transparent;
}
.sidebar::-webkit-scrollbar-thumb {
  background: rgba(124, 58, 237, 0.3);
  border-radius: 3px;
}
.sidebar::-webkit-scrollbar-thumb:hover {
  background: rgba(124, 58, 237, 0.55);
}

.logo {
  font-size: 2.6rem;
  font-weight: 900;
  letter-spacing: -1.8px;
  background: linear-gradient(90deg, #7c3aed, #8b5cf6, #a78bfa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 3.2rem;
  padding-left: 4px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 1.2rem;
  padding: 1.2rem 1.4rem;
  margin: 6px 0;
  color: var(--text-secondary);
  border-radius: var(--radius-m);
  cursor: pointer;
  font-weight: 600;
  font-size: 1.05rem;
  transition: all 0.38s ease;
}
.nav-item:hover {
  background: rgba(124, 58, 237, 0.12);
  color: var(--text-primary);
  transform: translateX(8px);
}
.nav-item.active {
  background: linear-gradient(90deg, rgba(124, 58, 237, 0.18), rgba(139, 92, 246, 0.12));
  color: var(--text-primary);
  box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.25);
}

.drawer-scrim {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(8px);
  z-index: 399;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.52s ease;
}
.drawer-scrim.show { opacity: 1; pointer-events: all; }

/* ── MAIN ── */
.main-view {
  flex: 1;
  overflow-y: auto;
  background: linear-gradient(to bottom, var(--bg-main), var(--bg-secondary));
  -webkit-overflow-scrolling: touch;
}

.top-header-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border-subtle);
}

.top-header {
  display: flex;
  align-items: center;
  padding: 1.2rem 1.6rem;
  height: var(--header-height);
  gap: 1.2rem;
}

.menu-toggle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.06);
  color: var(--text-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
}
.menu-toggle:active { transform: scale(0.92); }

.section-title {
  font-size: 1.9rem;
  font-weight: 800;
  margin: 2.2rem 0 1.4rem;
  padding: 0 1.6rem;
}

/* ── CARDS ── */
.track-card {
  min-width: 168px;
  width: 168px;
  background: var(--surface);
  border-radius: var(--radius-l);
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  transition: var(--transition);
}
.track-card:hover {
  transform: translateY(-14px) scale(1.05);
  box-shadow: 0 28px 60px rgba(124, 58, 237, 0.15);
}
.card-img-wrap {
  position: relative;
  aspect-ratio: 1;
  overflow: hidden;
}
.card-img-wrap img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.7s cubic-bezier(0.34,1.56,0.64,1);
}
.track-card:hover img { transform: scale(1.16) rotate(3deg); }
.play-overlay {
  position: absolute;
  inset: 0;
  background: rgba(124, 58, 237, 0.42);
  opacity: 0;
  transition: opacity 0.4s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}
.track-card:hover .play-overlay { opacity: 1; }

/* ── SONG ROW ── */
.song-row {
  display: flex;
  align-items: center;
  gap: 1.2rem;
  padding: 1.1rem 1.6rem;
  border-radius: var(--radius-m);
  background: var(--surface);
  margin: 8px 1.6rem;
  transition: all 0.36s ease;
}
.song-row:hover {
  background: rgba(124, 58, 237, 0.08);
  transform: translateX(6px);
}

/* ── PLAYER BAR ── */
.player-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 200;
  margin: 0 12px 12px;
  padding: 14px 18px;
  background: linear-gradient(to bottom, rgba(255, 255, 255, 0.94), rgba(245, 245, 250, 0.9));
  backdrop-filter: blur(28px) saturate(180%);
  border-radius: 24px 24px 0 0;
  border-top: 1px solid var(--border-subtle);
  box-shadow: 0 -16px 48px rgba(0, 0, 0, 0.08);
  display: flex;
  flex-direction: column;
  gap: 12px;
  transition: var(--transition);
}
.player-bar:hover { transform: translateY(-6px); }

.track-meta {
  display: flex;
  align-items: center;
  gap: 14px;
  cursor: pointer;
}
.track-meta img {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}
#pTitle {
  font-size: 1.12rem;
  font-weight: 700;
  line-height: 1.3;
}
#pArtist {
  font-size: 0.92rem;
  color: var(--text-secondary);
  margin-top: 4px;
}

.main-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 400px;
  width: 100%;
  padding: 0 12px;
}
.ctrl-btn {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 1.8rem;
  width: 52px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}
.ctrl-btn:hover { color: var(--accent); transform: scale(1.12); }

.play-fab-mobile {
  width: 64px;
  height: 64px;
  background: var(--accent);
  border-radius: 50%;
  color: white;
  box-shadow: 0 8px 28px rgba(124, 58, 237, 0.28);
  display: flex;
  align-items: center;
  justify-content: center;
}

.prog-bar {
  flex: 1;
  height: 6px;
  background: rgba(0, 0, 0, 0.08);
  border-radius: 6px;
  overflow: hidden;
  cursor: pointer;
}
.prog-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  transition: width 0.12s linear;
}

/* ── LYRICS ── */
.lyrics-view {
  position: fixed;
  inset: 0;
  background: var(--bg-main);
  z-index: 300;
  padding: 7rem 2.4rem 10rem;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  text-align: center;
  transform: translateY(100%);
  transition: transform 0.6s cubic-bezier(0.22,1,0.36,1);
}
.lyrics-view.open { transform: translateY(0); }

.lyrics-close-btn {
  position: fixed;
  top: 1.2rem;
  right: 1.2rem;
  z-index: 310;
  background: rgba(0, 0, 0, 0.06);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0, 0, 0, 0.08);
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-primary);
  font-size: 2.2rem;
  transition: all 0.3s ease;
}
.lyrics-close-btn:hover {
  background: rgba(124, 58, 237, 0.2);
  transform: scale(1.1);
}

#lyricsLines {
  font-size: clamp(1.2rem, 4.5vw, 1.45rem);
  line-height: 2.35;
  font-weight: 400;
  color: var(--text-primary);
  white-space: pre-wrap;
  text-align: center;
  max-width: 780px;
  margin: 2rem auto;
}

/* ── RESPONSIVE ── */
@media (min-width: 900px) {
  .sidebar { 
    transform: translateX(0); 
    position: static; 
    padding-top: 2.4rem;
  }
  .menu-toggle, .drawer-scrim { display: none !important; }
}

@media (max-width: 400px) {
  .player-bar { margin: 0; border-radius: 0; padding: 12px 16px; }
  .play-fab-mobile { width: 56px; height: 56px; }
}

    /* ---------- PWA Install Top-Sheet ---------- */
#pwaTopSheet {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #ffffff;
  color: #1a1a1a;
  z-index: 9999;
  transform: translateY(-120%);
  transition: transform .35s cubic-bezier(.4,0,.2,1);
  box-shadow: 0 4px 24px rgba(0,0,0,.12);
  border-bottom: 1px solid rgba(0,0,0,.08);
}
#pwaTopSheet.show {
  transform: translateY(0);
}
.pwa-sheet-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.4rem;
  max-width: 800px;
  margin: auto;
}
.pwa-sheet-left {
  display: flex;
  align-items: center;
  gap: .8rem;
}
.pwa-sheet-left img {
  width: 56px;
  height: 56px;
  border-radius: 14px;
  object-fit: cover;
}
.pwa-sheet-text h3 {
  margin: 0 0 .2rem;
  font-size: 1.1rem;
  font-weight: 700;
}
.pwa-sheet-text p {
  margin: 0;
  font-size: .9rem;
  opacity: .7;
}
.pwa-sheet-actions {
  display: flex;
  gap: .6rem;
}
.pwa-sheet-actions button {
  border: none;
  border-radius: 999px;
  padding: .6rem 1.2rem;
  font-weight: 600;
  font-size: .9rem;
  cursor: pointer;
  transition: background .2s;
}
.pwa-install-btn {
  background: #7c3aed;
  color: #fff;
}
.pwa-install-btn:hover {
  background: #6d28d9;
}
.pwa-later-btn {
  background: rgba(0,0,0,.06);
  color: #1a1a1a;
}
.pwa-later-btn:hover {
  background: rgba(0,0,0,.12);
}
@media (max-width: 480px) {
  .pwa-sheet-content {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
  }
}
    /* prevent context-menu + highlight on every image */
img {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;   /* iOS long-press menu */
  pointer-events: none;          /* also ignores drag/long-tap */
}


/* 2. let last card clear the player */
.main-view {
  padding-bottom: calc(var(--player-mini) + 24px);
}

    .app-skeleton-loader {
  position: fixed;
  inset: 0;
  background: var(--bg-main);
  z-index: 9999;
  display: flex;
  justify-content: center;
  overflow: hidden;
}

.skeleton-wrapper {
  width: 100%;
  max-width: 1400px;
  padding: 1rem;
}

.skeleton-header {
  height: var(--header-height);
  display: flex;
  align-items: center;
  gap: 1.2rem;
  padding: 1.2rem 1.6rem;
  margin-bottom: 1.8rem;
}

.skeleton-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.skeleton-search {
  flex: 1;
  max-width: 480px;
  height: 48px;
  border-radius: 999px;
}

@keyframes shimmer {
  0%   { transform: translateX(-100%); }
  100% { transform: translateX(100%);  }
}

.skeleton-bar,
.skeleton-chip,
.skeleton-card,
.skeleton-title,
.skeleton-avatar,
.skeleton-song-row,
.skeleton-search {
  background: linear-gradient(
    90deg,
    rgba(200,200,200,0.12) 0%,
    rgba(200,200,200,0.25) 50%,
    rgba(200,200,200,0.12) 100%
  );
  background-size: 200% 100%;
  animation: shimmer 1.6s infinite linear;
  position: relative;
  overflow: hidden;
}

.skeleton-bar::after,
.skeleton-chip::after,
.skeleton-card::after,
.skeleton-title::after,
.skeleton-avatar::after,
.skeleton-song-row::after,
.skeleton-search::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255,255,255,0.15),
    transparent
  );
  animation: shimmer 1.8s infinite;
}

/* Sizes & Shapes */
.skeleton-bar.long     { height: 100%; width: 100%; border-radius: 999px; }
.skeleton-bar.short    { height: 18px; width: 60%; border-radius: 6px; }
.skeleton-title        { height: 32px; width: 240px; border-radius: 8px; margin-bottom: 1.6rem; }
.skeleton-chip         { height: 38px; width: 110px; border-radius: 999px; }
.skeleton-card         { width: 168px; height: 240px; border-radius: var(--radius-l); flex-shrink: 0; }
.skeleton-song-row     { height: 80px; width: 100%; border-radius: var(--radius-m); margin: 8px 0; }
.skeleton-grid         { display: flex; gap: 1.4rem; overflow-x: auto; padding-bottom: 1.8rem; }
.skeleton-genres       { display: flex; flex-wrap: wrap; gap: 12px; padding: 0 1.6rem; margin: 1.8rem 0; }
.skeleton-section      { padding: 0 1.6rem; }
.skeleton-song-list    { padding: 0 1.6rem; }

    /* ── HERO BANNER ── */
.hero-banner {
  margin: 1.2rem 1.6rem 2.4rem;
  padding: 2.2rem 2.4rem;
  border-radius: var(--radius-xl);
  background: linear-gradient(135deg, 
    rgba(124, 58, 237, 0.18) 0%, 
    rgba(139, 92, 246, 0.12) 100%);
  position: relative;
  overflow: hidden;
  box-shadow: 0 16px 48px rgba(124, 58, 237, 0.15);
  transition: var(--transition);
}

.hero-banner:hover {
  transform: translateY(-6px);
  box-shadow: 0 24px 64px rgba(124, 58, 237, 0.22);
}

.hero-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 3rem;
  position: relative;
  z-index: 2;
}

.hero-text h1 {
  font-size: clamp(2.2rem, 5.5vw, 3.4rem);
  font-weight: 900;
  letter-spacing: -1.2px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light), #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.8rem;
  line-height: 1.1;
}

.hero-text p {
  font-size: clamp(1.1rem, 3vw, 1.38rem);
  color: var(--text-secondary);
  margin-bottom: 1.8rem;
  max-width: 420px;
}

.hero-cta {
  display: flex;
  gap: 1.2rem;
  flex-wrap: wrap;
}

.hero-btn {
  padding: 1.1rem 2.2rem;
  font-size: 1.05rem;
  font-weight: 700;
}

.hero-visual {
  position: relative;
  width: 260px;
  height: 260px;
  flex-shrink: 0;
  display: none;
}

@media (min-width: 768px) {
  .hero-visual { display: block; }
}

.hero-gradient {
  position: absolute;
  inset: -20%;
  background: radial-gradient(circle at 30% 70%, 
    rgba(124,58,237,0.45), 
    rgba(139,92,246,0.25) 40%, 
    transparent 70%);
  border-radius: 50%;
  animation: pulse 8s infinite ease-in-out;
}

.hero-album {
  position: absolute;
  width: 180px;
  height: 180px;
  background: linear-gradient(45deg, #7c3aed, #a78bfa);
  border-radius: 24px;
  box-shadow: 0 16px 48px rgba(0,0,0,0.4);
  transform: rotate(-12deg);
  top: 40px;
  left: 20px;
  background-size: cover;
  background-position: center;
}

.hero-album.rotating {
  animation: rotateSlow 28s linear infinite;
  background-image: url('https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png');
  /* You can replace with a real vibrant album cover */
}

.hero-album.shadow {
  background: rgba(0,0,0,0.35);
  filter: blur(24px);
  transform: rotate(-12deg) scale(1.08);
  top: 48px;
  left: 28px;
  z-index: -1;
}

/* Animations */
@keyframes rotateSlow {
  from { transform: rotate(-12deg); }
  to   { transform: rotate(348deg); }
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50%      { opacity: 0.9; transform: scale(1.12); }
}

/* Responsive adjustments */
@media (max-width: 900px) {
  .hero-content {
    flex-direction: column;
    text-align: center;
  }
  
  .hero-text {
    max-width: 100%;
  }
  
  .hero-cta {
    justify-content: center;
  }
  
  .hero-banner {
    margin: 1rem 1.2rem 2rem;
    padding: 2rem 1.8rem;
  }
}
  </style>
</head>
<body>

  <!-- Full Page Skeleton Loader -->
<div id="appLoader" class="app-skeleton-loader">
  <div class="skeleton-wrapper">
    <!-- Header / Top bar -->
    <div class="skeleton-header glass">
      <div class="skeleton-avatar"></div>
      <div class="skeleton-search">
        <div class="skeleton-bar long"></div>
      </div>
    </div>

    <!-- Genre Chips -->
    <div class="skeleton-genres">
      <div class="skeleton-chip"></div>
      <div class="skeleton-chip"></div>
      <div class="skeleton-chip"></div>
      <div class="skeleton-chip"></div>
      <div class="skeleton-chip"></div>
      <div class="skeleton-chip"></div>
    </div>

    <!-- Section Title + Trending Cards -->
    <div class="skeleton-section">
      <div class="skeleton-title"></div>
      <div class="skeleton-grid">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>

    <!-- Song List -->
    <div class="skeleton-section">
      <div class="skeleton-title"></div>
      <div class="skeleton-song-list">
        <div class="skeleton-song-row"></div>
        <div class="skeleton-song-row"></div>
        <div class="skeleton-song-row"></div>
        <div class="skeleton-song-row"></div>
        <div class="skeleton-song-row"></div>
        <div class="skeleton-song-row"></div>
        <div class="skeleton-song-row"></div>
      </div>
    </div>
  </div>
</div>

  <div id="pwaTopSheet" aria-live="polite">
  <div class="pwa-sheet-content">
    <div class="pwa-sheet-left">
      <img src="https://i.postimg.cc/qvRfMQLN/Gemini-Generated-Image-mkdc7umkdc7umkdc.png" alt="App icon">
      <div class="pwa-sheet-text">
        <h3>Install Vynix</h3>
        <p id="pwaInstruction">Tap <strong>Share</strong> ➜ <strong>Add to Home Screen</strong></p>
      </div>
    </div>
    <div class="pwa-sheet-actions">
      <button class="pwa-install-btn" id="pwaInstallBtn">Install</button>
      <button class="pwa-later-btn" onclick="pwaDismiss()">Later</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="customModal">
  <div class="modal-content">
    <div class="modal-title" id="modalTitle">Vynix</div>
    <div id="modalBody"></div>
    <div class="modal-error" id="modalError" style="color:#ff6b6b; margin:1rem 0;"></div>
    <div class="modal-buttons" style="display:flex; gap:1rem; justify-content:flex-end; margin-top:1.8rem;">
      <button class="btn btn-secondary" id="modalCancel">Cancel</button>
      <button class="btn btn-primary" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<!-- Sidebar / Drawer -->
<aside class="sidebar" id="sidebar">
  <div class="logo">VYNIX</div>

  <div class="nav-item active" onclick="switchView('home')">
    <span class="material-symbols-rounded">home</span> Home
  </div>
  <div class="nav-item" onclick="switchView('discover')">
    <span class="material-symbols-rounded">explore</span> Discover
  </div>
  <div class="nav-item" onclick="switchView('library')">
    <span class="material-symbols-rounded">library_music</span> Library
  </div>

  <div style="margin: 2.8rem 0 1.2rem; color:var(--text-muted); font-weight:600; font-size:0.9rem;">GENRES</div>
  <div id="sidebarGenres" style="display:flex; flex-wrap:wrap; gap:10px;"></div>

  <div style="margin: 2.8rem 0 1.2rem; color:var(--text-muted); font-weight:600; font-size:0.9rem;">PLAYLISTS</div>
  <div id="playlistContainer"></div>

  <div class="nav-item" style="color:var(--accent); margin-top:1.2rem;" onclick="createNewPlaylist()">
    <span class="material-symbols-rounded">add</span> New Playlist
  </div>

  <div style="margin-top:auto; padding-top:2.5rem;">
    <button class="btn btn-primary" style="width:100%; justify-content:center; gap:0.8rem;" onclick="auth.signOut()">
      <span class="material-symbols-rounded">logout</span> Sign Out
    </button>
  </div>
</aside>

<div class="drawer-scrim" onclick="toggleDrawer()"></div>

<!-- Header -->
<div class="top-header-container glass">
  <header class="top-header">
    <div class="menu-toggle" onclick="toggleDrawer()">
      <span class="material-symbols-rounded">menu</span>
    </div>
    <div class="search-container" style="flex:1; max-width:480px;">
      <div class="search-box">
        <span class="material-symbols-rounded">search</span>
        <input type="text" id="globalSearch" placeholder="Search songs, artists, albums..."/>
        <button class="clear-search hidden" id="clearSearchBtn" onclick="clearSearch()">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
    </div>
  </header>
</div>

  <!-- Hero Banner -->
<div class="hero-banner glass" id="heroBanner">
  <div class="hero-content">
    <div class="hero-text">
      <h1>Discover Your Vibe</h1>
      <p>Millions of songs. No limits. Just pure music.</p>
      
      <div class="hero-cta">
        <button class="btn btn-primary hero-btn" onclick="switchView('discover')">
          Explore Now
        </button>
        <button class="btn btn-secondary hero-btn" onclick="document.getElementById('globalSearch').focus()">
          Search Something
        </button>
      </div>
    </div>
    
    <div class="hero-visual">
      <div class="hero-gradient"></div>
      <div class="hero-album rotating"></div>
      <div class="hero-album shadow"></div>
    </div>
  </div>
</div>
  
<!-- Main Content -->
<main class="main-view" id="mainContent">
  <div style="padding-top:calc(var(--header-height) + 1.2rem); padding-bottom:calc(var(--player-mini) + 24px);">
    <div id="view-home">
      <div id="mainGenreChips" style="display:flex; flex-wrap:wrap; gap:12px; padding:0 1.6rem; margin:1.8rem 0;"></div>
      <div class="section-title"><span id="currentSectionTitle">Trending</span></div>
      <div style="display:flex; gap:1.4rem; overflow-x:auto; padding:0 1.6rem; padding-bottom:1.8rem;" id="trendingGrid"></div>
      <div class="section-title"><span id="listSectionTitle">All Tracks</span></div>
      <div id="songsList"></div>
    </div>

    <div id="view-library" class="hidden">
      <div class="section-title">Liked Songs</div>
      <div id="likedSongsList"></div>
    </div>

    <div id="view-playlist" class="hidden">
      <div class="section-title" id="playlistTitle">Playlist</div>
      <div id="playlistTracksList"></div>
    </div>
  </div>
</main>

<!-- Lyrics Overlay -->
<div class="lyrics-view" id="lyricsOverlay">
  <button class="lyrics-close-btn" onclick="toggleLyrics()">
    <span class="material-symbols-rounded">keyboard_arrow_down</span>
  </button>

  <div class="card-img-wrap" style="width:260px; height:260px; margin:2rem auto 2.8rem;">
    <img id="lyricsCover" src="" alt="cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
    <div class="default-cover" style="display:none;">♪</div>
  </div>

  <h2 id="lyricsTitle" style="margin-bottom:0.6rem; font-size:2.1rem; font-weight:800;">Song Title</h2>
  <p id="lyricsArtist" style="color:var(--accent); font-size:1.2rem; margin-bottom:3.5rem;">Artist</p>

  <div id="lyricsLines" style="max-width:720px; margin:0 auto;">No lyrics available</div>
</div>

<!-- Player Bar -->
<footer class="player-bar glass" id="playerBar">
  <div class="track-meta" onclick="toggleLyrics()">
    <div class="card-img-wrap" style="width:60px;height:60px;">
      <img id="pCover" src="" alt="cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
      <div class="default-cover" style="display:none;font-size:2.2rem;">♪</div>
    </div>
    <div>
      <div id="pTitle">Not Playing</div>
      <div id="pArtist">—</div>
    </div>
  </div>

  <div style="display:flex; flex-direction:column; align-items:center; gap:12px; width:100%;">
    <div class="main-controls">
      <button class="ctrl-btn" onclick="toggleShuffle()"><span class="material-symbols-rounded">shuffle</span></button>
      <button class="ctrl-btn" onclick="playPrevTrack()"><span class="material-symbols-rounded">skip_previous</span></button>
      <button class="play-fab-mobile" id="mobPlayBtn" onclick="togglePlay()">
        <span class="material-symbols-rounded" id="mobPlayIcon">play_arrow</span>
      </button>
      <button class="ctrl-btn" onclick="playNextTrack()"><span class="material-symbols-rounded">skip_next</span></button>
      <button class="ctrl-btn" onclick="toggleRepeat()"><span class="material-symbols-rounded">repeat</span></button>
    </div>

    <div style="display:flex; align-items:center; gap:12px; width:100%; max-width:480px;">
      <span id="currTime" style="font-size:0.84rem; color:var(--text-muted); min-width:40px;">0:00</span>
      <div class="prog-bar" id="progBar">
        <div class="prog-fill" id="progFill"></div>
      </div>
      <span id="durTime" style="font-size:0.84rem; color:var(--text-muted); min-width:40px;">--:--</span>
    </div>
  </div>
</footer>

<audio id="audio"></audio>

<script>
// =============================================
// Firebase + Auth
// =============================================
firebase.initializeApp({
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
});

const auth = firebase.auth();
const db = firebase.database();

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.replace('login.html');
  } else {
    // ── User is logged in ───────────────────────────────────────
    // Personalize hero banner greeting
    const firstName = user.displayName?.split(' ')[0] || 'Music Lover';
    const heroTitle = document.querySelector('.hero-text h1');
    if (heroTitle) {
      heroTitle.textContent = `Welcome back, ${firstName}!`;
    }

    loadData(user.uid);
  }
});

// =============================================
// State & Elements
// =============================================
let allTracks = [];
let allGenres = [];
let playlists = {};
let currentPlaylistId = null;
let currentTrack = null;
let likedTracks = new Set();
let currentGenreFilter = null;
let isShuffled = false;
let isRepeating = false;
let currentTrackIndex = 0;
let shuffledIndices = [];

const audio = document.getElementById('audio');
const playerBar = document.getElementById('playerBar');
const currTimeEl = document.getElementById('currTime');
const durTimeEl = document.getElementById('durTime');
const progFill = document.getElementById('progFill');

const DEFAULT_COVER = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300"><rect width="300" height="300" fill="%236b21a8"/><text x="50%" y="50%" font-size="120" text-anchor="middle" dy=".3em" fill="white">♪</text></svg>';

// =============================================
// Player Time & Progress
// =============================================
function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${m}:${sec < 10 ? '0' : ''}${sec}`;
}

audio.ontimeupdate = () => {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  progFill.style.width = pct + '%';
  currTimeEl.textContent = formatTime(audio.currentTime);
  durTimeEl.textContent = formatTime(audio.duration);
};

audio.onloadedmetadata = () => {
  durTimeEl.textContent = formatTime(audio.duration || 0);
};

document.getElementById('progBar').onclick = e => {
  const rect = e.currentTarget.getBoundingClientRect();
  const pos = (e.clientX - rect.left) / rect.width;
  audio.currentTime = pos * audio.duration;
};

// =============================================
// Player Controls
// =============================================
function playTrack(track) {
  currentTrack = track;
  const tracks = getFilteredTracks();
  currentTrackIndex = tracks.findIndex(t => t.id === track.id);

  document.getElementById('pTitle').textContent = track.title || 'Unknown';
  document.getElementById('pArtist').textContent = track.artist || 'Unknown';

  const cover = document.getElementById('pCover');
  cover.src = track.cover || DEFAULT_COVER;

  document.getElementById('lyricsCover').src = track.cover || DEFAULT_COVER;
  document.getElementById('lyricsTitle').textContent = track.title || 'Unknown';
  document.getElementById('lyricsArtist').textContent = track.artist || 'Unknown';

  audio.src = track.audio || '';
  audio.play().catch(() => {});
  updatePlayIcons(true);
  playerBar.classList.remove('hidden');
}

function togglePlay() {
  if (!currentTrack) {
    const tracks = getFilteredTracks();
    if (tracks.length) playTrack(tracks[0]);
    return;
  }
  audio[audio.paused ? 'play' : 'pause']().catch(() => {});
  updatePlayIcons(!audio.paused);
}

function updatePlayIcons(playing) {
  document.getElementById('mobPlayIcon').textContent = playing ? 'pause' : 'play_arrow';
}

function playNextTrack() {
  const next = getNextTrackIndex();
  if (next !== -1) playTrack(getFilteredTracks()[next]);
}

function playPrevTrack() {
  const prev = getPrevTrackIndex();
  if (prev !== -1) playTrack(getFilteredTracks()[prev]);
}

function toggleShuffle() {
  isShuffled = !isShuffled;
  const btn = document.querySelector('.main-controls .ctrl-btn:first-child span');
  if (isShuffled) {
    shuffledIndices = getShuffledIndices(getFilteredTracks().length);
    btn.style.color = 'var(--accent)';
  } else {
    btn.style.color = '';
  }
}

function toggleRepeat() {
  isRepeating = !isRepeating;
  const btn = document.querySelector('.main-controls .ctrl-btn:last-child span');
  btn.style.color = isRepeating ? 'var(--accent)' : '';
}

function getShuffledIndices(len) {
  const arr = Array.from({length: len}, (_,i) => i);
  for (let i = len-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function getNextTrackIndex() {
  const tracks = getFilteredTracks();
  if (!tracks.length) return -1;
  if (isShuffled) {
    const idx = shuffledIndices.indexOf(currentTrackIndex);
    return shuffledIndices[(idx + 1) % shuffledIndices.length];
  }
  return (currentTrackIndex + 1) % tracks.length;
}

function getPrevTrackIndex() {
  const tracks = getFilteredTracks();
  if (!tracks.length) return -1;
  if (isShuffled) {
    const idx = shuffledIndices.indexOf(currentTrackIndex);
    return shuffledIndices[(idx - 1 + shuffledIndices.length) % shuffledIndices.length];
  }
  return (currentTrackIndex - 1 + tracks.length) % tracks.length;
}

audio.onended = () => {
  if (isRepeating) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  } else playNextTrack();
};

// =============================================
// UI / Navigation
// =============================================
function switchView(view) {
  document.querySelectorAll('[id^="view-"]').forEach(el => 
    el.classList.toggle('hidden', !el.id.includes(view))
  );

  document.querySelectorAll('.nav-item').forEach(el => {
    const text = el.textContent.toLowerCase();
    el.classList.toggle('active', text.includes(view));
  });
}

function toggleDrawer() {
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.drawer-scrim').classList.toggle('show');
}

function toggleLyrics() {
  document.getElementById('lyricsOverlay').classList.toggle('open');
}

// =============================================
// Custom Modal
// =============================================
const modal = {
  overlay: document.getElementById('customModal'),
  title: document.getElementById('modalTitle'),
  body: document.getElementById('modalBody'),
  error: document.getElementById('modalError'),
  cancel: document.getElementById('modalCancel'),
  confirm: document.getElementById('modalConfirm'),

  show(title, content = '', isPrompt = false, defaultVal = '', callback) {
    this.title.textContent = title;
    this.body.innerHTML = content;
    this.error.textContent = '';

    if (isPrompt) {
      const input = document.createElement('input');
      input.className = 'modal-input';
      input.value = defaultVal;
      input.placeholder = 'Enter name...';
      this.body.appendChild(input);
      input.focus();
      input.onkeyup = e => { if (e.key === 'Enter') this.confirm.click(); };

      this.confirm.onclick = () => {
        const val = input.value.trim();
        if (val) callback(val);
        this.hide();
      };
    } else {
      this.confirm.onclick = () => { callback?.(); this.hide(); };
    }

    this.cancel.onclick = () => this.hide();
    this.overlay.classList.add('show');
  },

  hide() {
    this.overlay.classList.remove('show');
    this.body.innerHTML = '';
  },

  alert(msg) {
    this.show('Vynix', `<p style="line-height:1.6">${msg}</p>`);
  }
};

// =============================================
// Data & Rendering
// =============================================
function loadData(uid) {
  // ── State for initial loading ───────────────────────────────
  let initialTracksLoaded = false;
  let initialGenresLoaded = false;

  const loader = document.getElementById('appLoader');

  const checkIfReadyToHideLoader = () => {
    if (initialTracksLoaded && initialGenresLoaded) {
      // Small delay prevents flash-of-unstyled-content feeling
      setTimeout(() => {
        loader.style.opacity = '0';
        setTimeout(() => {
          loader.style.display = 'none';
        }, 400); // match transition duration
      }, 300);
    }
  };

  // ── 1. Critical data: Tracks ─────────────────────────────────
  db.ref('content/music')
    .once('value')                    // ← initial full read
    .then(snap => {
      allTracks = [];
      snap.forEach(child => {
        const t = child.val();
        t.id = child.key;
        allTracks.push(t);
      });

      initialTracksLoaded = true;
      renderHome();
      checkIfReadyToHideLoader();

      // After initial load → switch to real-time listener
      db.ref('content/music').on('value', snap => {
        allTracks = [];
        snap.forEach(child => {
          const t = child.val();
          t.id = child.key;
          allTracks.push(t);
        });
        renderHome();
        if (currentPlaylistId) renderPlaylistTracks();
      });
    })
    .catch(err => {
      console.error('Failed to load tracks:', err);
      // Optional: show error state in UI
    });

  // ── 2. Critical data: Genres ─────────────────────────────────
  db.ref('/content/musicGenres')
    .once('value')
    .then(snap => {
      allGenres = [];
      snap.forEach(c => {
        const name = c.val()?.name;
        if (name) allGenres.push(name);
      });
      allGenres.sort();

      initialGenresLoaded = true;
      renderGenreChips();
      checkIfReadyToHideLoader();

      // Real-time updates for genres (usually rare, but good practice)
      db.ref('/content/musicGenres').on('value', snap => {
        allGenres = [];
        snap.forEach(c => {
          const name = c.val()?.name;
          if (name) allGenres.push(name);
        });
        allGenres.sort();
        renderGenreChips();
      });
    })
    .catch(err => {
      console.error('Failed to load genres:', err);
    });

  // ── 3. User-specific data (can load after UI is shown) ───────
  db.ref(`users/${uid}/likes`).on('value', snap => {
    likedTracks.clear();
    if (snap.val()) {
      Object.keys(snap.val()).forEach(k => likedTracks.add(k));
    }
    renderLibrary();
  });

  db.ref(`users/${uid}/playlists`).on('value', snap => {
    playlists = snap.val() || {};
    renderPlaylists();

    // If user was viewing a playlist and it changed → refresh view
    if (currentPlaylistId && playlists[currentPlaylistId]) {
      renderPlaylistTracks();
    }
  });
}

function getFilteredTracks() {
  if (!currentGenreFilter) return allTracks;
  return allTracks.filter(t =>
    (t.genres?.includes(currentGenreFilter)) || t.genre === currentGenreFilter
  );
}

function createTrackCard(track) {
  const div = document.createElement('div');
  div.className = 'track-card';
  div.innerHTML = `
    <div class="card-img-wrap">
      <img src="${track.cover || DEFAULT_COVER}" alt="${track.title}" onerror="this.src='${DEFAULT_COVER}'">
      <div class="play-overlay"><span class="material-symbols-rounded" style="font-size:3.8rem;">play_arrow</span></div>
    </div>
    <div style="padding:1rem;">
      <div style="font-weight:700; font-size:1.1rem;">${track.title || 'Unknown'}</div>
      <div style="color:var(--text-secondary); font-size:0.92rem; margin-top:0.3rem;">${track.artist || 'Unknown'}</div>
    </div>
  `;
  div.onclick = () => playTrack(track);
  return div;
}

function createSongRow(track) {
  const div = document.createElement('div');
  div.className = 'song-row';
  div.innerHTML = `
    <div class="card-img-wrap" style="width:64px;height:64px;">
      <img src="${track.cover || DEFAULT_COVER}" alt="${track.title}" onerror="this.src='${DEFAULT_COVER}'">
    </div>
    <div style="flex:1;">
      <div style="font-weight:600; font-size:1.05rem;">${track.title || 'Unknown'}</div>
      <div style="color:var(--text-secondary); font-size:0.94rem; margin-top:0.3rem;">${track.artist || 'Unknown'}</div>
    </div>
    <div style="display:flex; gap:1.2rem;">
      <button class="ctrl-btn like-btn ${likedTracks.has(track.id) ? 'liked' : ''}" 
              style="font-size:1.8rem;" 
              data-track-id="${track.id}"
              onclick="event.stopPropagation(); toggleLike('${track.id}', this)">
        <span class="material-symbols-rounded">favorite</span>
      </button>
      <button class="ctrl-btn" style="font-size:1.8rem;" 
              onclick="event.stopPropagation();addToPlaylist('${track.id}')">
        <span class="material-symbols-rounded">playlist_add</span>
      </button>
    </div>
  `;

  div.onclick = () => playTrack(track);
  
  return div;
}

function renderHome() {
  const grid = document.getElementById('trendingGrid');
  const list = document.getElementById('songsList');
  const title = document.getElementById('currentSectionTitle');
  const listTitle = document.getElementById('listSectionTitle');

  grid.innerHTML = '';
  list.innerHTML = '';

  const filtered = getFilteredTracks();
  title.textContent = currentGenreFilter || 'Trending';
  listTitle.textContent = currentGenreFilter ? currentGenreFilter : 'All Tracks';

  filtered.slice(0, 12).forEach(t => grid.appendChild(createTrackCard(t)));
  filtered.forEach(t => list.appendChild(createSongRow(t)));

  applySearchFilter();
}

function renderLibrary() {
  const container = document.getElementById('likedSongsList');
  container.innerHTML = '';

  const liked = allTracks.filter(t => likedTracks.has(t.id));
  if (!liked.length) {
    container.innerHTML = '<div style="padding:4rem;text-align:center;color:var(--text-muted);">No liked songs yet...</div>';
    return;
  }

  liked.forEach(t => container.appendChild(createSongRow(t)));
  applySearchFilter();
}

function renderPlaylistTracks() {
  const container = document.getElementById('playlistTracksList');
  container.innerHTML = '';

  const tracks = playlists[currentPlaylistId]?.tracks || {};
  const ids = Object.keys(tracks);

  if (!ids.length) {
    container.innerHTML = '<div style="padding:4rem;text-align:center;color:var(--text-muted);">This playlist is empty</div>';
    return;
  }

  ids.forEach(id => {
    const track = allTracks.find(t => t.id === id);
    if (track) container.appendChild(createSongRow(track));
  });

  applySearchFilter();
}

function renderGenreChips() {
  const containers = [document.getElementById('sidebarGenres'), document.getElementById('mainGenreChips')];
  containers.forEach(cont => {
    if (!cont) return;
    cont.innerHTML = '';

    const all = document.createElement('div');
    all.className = `category-chip ${!currentGenreFilter ? 'active' : ''}`;
    all.textContent = 'All';
    all.style.cssText = 'padding:0.7rem 1.4rem; background:rgba(192,132,252,0.12); border-radius:999px; cursor:pointer; font-weight:600; color:var(--text-primary); transition:all 0.3s;';
    all.onclick = () => {
      currentGenreFilter = null;
      renderGenreChips();
      renderHome();
    };
    cont.appendChild(all);

    allGenres.forEach(g => {
      const chip = document.createElement('div');
      chip.className = `category-chip ${currentGenreFilter === g ? 'active' : ''}`;
      chip.textContent = g;
      chip.style.cssText = 'padding:0.7rem 1.4rem; background:rgba(192,132,252,0.12); border-radius:999px; cursor:pointer; font-weight:600; color:var(--text-primary); transition:all 0.3s;';
      chip.onclick = () => {
        currentGenreFilter = g;
        renderGenreChips();
        renderHome();
      };
      cont.appendChild(chip);
    });
  });
}

function renderPlaylists() {
  const cont = document.getElementById('playlistContainer');
  cont.innerHTML = '';

  Object.entries(playlists).forEach(([id, pl]) => {
    const item = document.createElement('div');
    item.className = 'nav-item';
    item.textContent = pl.name || 'Untitled';
    item.onclick = () => {
      currentPlaylistId = id;
      document.getElementById('playlistTitle').textContent = pl.name || 'Playlist';
      switchView('playlist');
      renderPlaylistTracks();
    };
    cont.appendChild(item);
  });
}

// =============================================
// Search & Filter
// =============================================
function applySearchFilter() {
  const term = document.getElementById('globalSearch').value.toLowerCase().trim();
  document.getElementById('clearSearchBtn').classList.toggle('hidden', !term);

  document.querySelectorAll('.song-row, .track-card').forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
}

function clearSearch() {
  document.getElementById('globalSearch').value = '';
  applySearchFilter();
}

// =============================================
// Likes & Playlists
// =============================================
function toggleLike(trackId, buttonElement = null) {
  const uid = auth.currentUser?.uid;
  if (!uid || !trackId) return;

  const wasLiked = likedTracks.has(trackId);
  const likeRef = db.ref(`users/${uid}/likes/${trackId}`);

  // ── 1. Optimistic UI Update ─────────────────────────────────────
  if (wasLiked) {
    // We're unliking
    likedTracks.delete(trackId);
    if (buttonElement) {
      buttonElement.classList.remove('liked');
    }
  } else {
    // We're liking
    likedTracks.add(trackId);
    if (buttonElement) {
      buttonElement.classList.add('liked');
    }
  }

  // ── 2. Actually update Firebase ─────────────────────────────────
  const updatePromise = wasLiked ? likeRef.remove() : likeRef.set(true);

  updatePromise.catch(error => {
    console.error("Like update failed:", error);
    // Rollback optimistic update on failure
    if (wasLiked) {
      likedTracks.add(trackId);
      if (buttonElement) buttonElement.classList.add('liked');
    } else {
      likedTracks.delete(trackId);
      if (buttonElement) buttonElement.classList.remove('liked');
    }
    // Optional: show toast/notification to user
     modal.alert("Failed to update like status");
  });

  // ── 3. Special behavior: Remove row from playlist view when unliking ──
  if (currentPlaylistId && wasLiked) {
    // Find and remove the song row in current playlist view
    const row = document.querySelector(
      `#playlistTracksList .song-row [data-track-id="${trackId}"]`
    )?.closest('.song-row');

    if (row) {
      row.style.transition = 'all 0.4s ease';
      row.style.opacity = '0';
      row.style.transform = 'translateX(-24px)';

      setTimeout(() => {
        row.remove();

        // Show empty state if playlist became empty
        const container = document.getElementById('playlistTracksList');
        if (container.children.length === 0) {
          container.innerHTML = 
            '<div style="padding:4rem; text-align:center; color:var(--text-muted);">' +
            'This playlist is empty' +
            '</div>';
        }
      }, 420);
    }
  }

  // ── 4. Refresh library view (since likes changed) ───────────────
  renderLibrary();
}

function createNewPlaylist() {
  modal.show('New Playlist', 'Give your playlist a name:', true, '', name => {
    if (!name.trim()) return modal.alert('Name is required');
    const uid = auth.currentUser.uid;
    db.ref(`users/${uid}/playlists`).push({ name, tracks: {} })
      .then(() => modal.alert(`Playlist "${name}" created!`));
  });
}

function addToPlaylist(trackId) {
  if (!Object.keys(playlists).length) return modal.alert('Create a playlist first');

  let html = '<p style="margin-bottom:1.2rem; color:var(--text-secondary);">Add to which playlist?</p>';
  html += '<select class="modal-input" id="plSelect">';
  Object.entries(playlists).forEach(([id, p]) => {
    html += `<option value="${id}">${p.name || 'Untitled'}</option>`;
  });
  html += '</select>';

  modal.show('Add to Playlist', html, false, '', () => {
    const selected = document.getElementById('plSelect').value;
    if (selected) {
      db.ref(`users/${auth.currentUser.uid}/playlists/${selected}/tracks/${trackId}`).set(true)
        .then(() => modal.alert('Track added!'));
    }
  });
}

// =============================================
// Event Listeners + Init
// =============================================
document.getElementById('globalSearch').oninput = applySearchFilter;

window.addEventListener('resize', () => {
  if (window.innerWidth >= 900 && document.getElementById('sidebar').classList.contains('open')) {
    toggleDrawer();
  }
});

switchView('home');
playerBar.classList.add('hidden');

  /* run once, or after dynamic content */
document.addEventListener('contextmenu', e => {
  if (e.target.tagName === 'IMG') e.preventDefault();
}, { capture: true });


  /* ========== PWA Top-Sheet Logic ========== */
const sheet = document.getElementById('pwaTopSheet');
const instBtn = document.getElementById('pwaInstallBtn');
const instruction = document.getElementById('pwaInstruction');

let deferredPrompt = null;

/* (A) Capture native prompt when available */
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;               // save for later
  showTopSheet('native');           // show sheet with native install
});

/* (B) No native prompt → show manual steps */
window.addEventListener('load', () => {
  if (!deferredPrompt && !localStorage.getItem('pwa_dismissed')) {
    showTopSheet('manual');
  }
});

function showTopSheet(mode) {
  if (mode === 'native') {
    instruction.textContent = 'Install Vynix for a full-screen experience';
    instBtn.style.display = 'inline-block';
    instBtn.onclick = () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => {
        pwaDismiss();
      });
    };
  } else {
    /* Manual instructions per OS */
    const iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const android = /Android/.test(navigator.userAgent);
    if (iOS) {
      instruction.innerHTML = 'Tap <strong>Share</strong> ➜ <strong>Add to Home Screen</strong>';
    } else if (android) {
      instruction.innerHTML = 'Tap <strong>⋮ menu</strong> ➜ <strong>Add to Home Screen</strong>';
    } else {
      instruction.innerHTML = 'Click <strong>Install</strong> in the address bar';
    }
    instBtn.style.display = 'none';
  }
  sheet.classList.add('show');
}

function pwaDismiss() {
  sheet.classList.remove('show');
  localStorage.setItem('pwa_dismissed', '1');
}
</script>
</body>
</html>
