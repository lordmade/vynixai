<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Feed + Reels</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #ffffff; --card: #ffffff; --text: #0f1419; --text2: #536471;
      --border: #eff3f4; --accent: #ff2a6d; --hover-accent: rgba(255, 42, 109, 0.1);
    }
    [data-theme="dark"] {
      --bg: #000000; --card: #000000; --text: #e7e9ea; --text2: #71767b;
      --border: #2f3336;
    }
    * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    input, textarea { -webkit-user-select: auto; user-select: auto; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); overflow-y: scroll; }

    /* ---------- Composer / Feed ---------- */
    .composer { display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--border); }
    .composer img.avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea { flex: 1; resize: none; background: transparent; color: var(--text); border: none; outline: none; font-size: 20px; padding-top: 10px; min-height: 60px; }
    .media-preview { width: 100%; border-radius: 16px; margin-top: 12px; border: 1px solid var(--border); }
    .composer-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
    .icon-btn { background: none; border: none; color: var(--accent); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--hover-accent); }
    .post-btn { background: var(--accent); color: #fff; border: none; border-radius: 999px; padding: 10px 24px; font-weight: 700; font-size: 15px; cursor: pointer; transition: opacity 0.2s; }
    .post-btn:disabled { opacity: 0.5; cursor: default; }
    .feed { padding-bottom: 80px; }

    .post-card { border: 1px solid var(--border); border-radius: 16px; margin: 12px; padding: 16px; background: var(--card); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; cursor: pointer; }
    .post-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    [data-theme="dark"] .post-card:hover { box-shadow: 0 4px 16px rgba(255,255,255,0.1); }
    .post-header { display: flex; gap: 12px; align-items: flex-start; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.3); }
    .user-meta { display: flex; gap: 4px; align-items: center; font-size: 15px; }
    .name { font-weight: 700; color: var(--text); }
    .verified-badge { color: var(--accent); font-size: 16px !important; margin-left: 2px; }
    .handle, .time { color: var(--text2); font-weight: 400; }
    .post-content { margin-top: 4px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; margin-left: 52px; }
    .post-image { border-radius: 16px; margin-top: 12px; max-width: 100%; max-height: 400px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.2s; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; pointer-events: auto; }
    .post-image:hover { opacity: 0.9; }
    .post-video { border-radius: 16px; margin-top: 12px; max-width: 100%; max-height: 400px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.2s; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    .post-video:hover { opacity: 0.9; }
    .post-actions { display: flex; justify-content: space-between; margin-top: 12px; margin-left: 52px; max-width: 400px; color: var(--text2); }
    .action-item { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .action-item .material-icons-outlined { font-size: 18px; padding: 8px; border-radius: 50%; transition: 0.2s; }
    .action-item:hover.reply { color: #1d9bf0; }
    .action-item:hover.repost { color: #00ba7c; }
    .action-item:hover.like { color: #f91880; }
    .delete-btn:hover { color: #f4212e; }
    .post-actions svg { width: 24px; height: 24px; }
    .post-actions .filled-heart { display: none; }
    .post-actions .like.liked .outline-heart { display: none; }
    .post-actions .like.liked .filled-heart { display: block; }
    .action-item:hover svg { transform: scale(1.1); transition: all 0.2s; }
    .action-item.repost:hover svg { stroke: #00ba7c; transform: scale(1.15); }
    .action-item.share:hover svg { stroke: #0095f6; transform: translateY(-2px) scale(1.1); transition: all 0.2s ease; }

    /* ---------- Reels (TikTok) ---------- */
    #reels-page { position: fixed; inset: 0; z-index: 200; background: #000; display: none; flex-direction: column; }
    #reels-page.show { display: flex; }
    #reels-close { position: absolute; top: 16px; left: 16px; z-index: 210; background: rgba(0,0,0,0.5); border-radius: 50%; padding: 8px; color: #fff; }
    #reels-progress { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.25); }
    #reels-progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }
    #reels-wrapper { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
    .reel-item { scroll-snap-align: start; width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; position: relative; }
    .reel-video { width: 100%; height: 100%; object-fit: cover; background: #000; }
    .reel-overlay { position: absolute; inset: 0; z-index: 5; }
    .reel-right-bar { position: absolute; right: 12px; bottom: 80px; z-index: 10; display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .reel-avatar { width: 48px; height: 48px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
    .reel-like-btn { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); border-radius: 50%; padding: 12px; color: #fff; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .reel-like-btn:hover { transform: scale(1.15); }
    .reel-comment-btn, .reel-share-btn { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); border-radius: 50%; padding: 12px; color: #fff; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .reel-comment-btn:hover, .reel-share-btn:hover { transform: scale(1.15); }
    .reel-meta { position: absolute; left: 16px; bottom: 80px; color: #fff; max-width: 65%; text-shadow: 0 1px 3px rgba(0,0,0,.45); }
    .reel-meta-name { font-weight: 700; font-size: 16px; }
    .reel-meta-text { font-size: 14px; margin-top: 6px; line-height: 1.4; }
    .heart-burst { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 80px; color: var(--accent); pointer-events: none; z-index: 20; }
    .heart-burst.show { animation: heartPop 0.5s cubic-bezier(.18,.89,.32,1.28); }
    @keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }

    /* ---------- Skeletons / Misc ---------- */
    .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.3) 50%, var(--border) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    [data-theme="dark"] .skeleton { background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.05) 50%, var(--border) 75%); background-size: 200% 100%; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .skeleton-post { border-bottom: 1px solid var(--border); padding: 16px; }
    .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; }
    .skeleton-line { height: 12px; border-radius: 4px; margin: 8px 0; }
    .skeleton-text { height: 16px; border-radius: 4px; margin: 4px 0; }
    .skeleton-image { width: 100%; height: 300px; border-radius: 16px; margin-top: 12px; }

    /* ---------- Nav ---------- */
    nav { transition: transform 0.3s ease-in-out; transform: translateY(0); }
    nav.hidden { transform: translateY(100%); }
    nav a.text-[#ff2a6d] span:first-child { color: #ff2a6d !important; }

    /* ---------- FAB ---------- */
    .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255, 42, 109, 0.4); cursor: pointer; transition: all 0.3s ease; z-index: 30; }
    .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(255, 42, 109, 0.6); }
    .fab.hidden { transform: scale(0); }

    /* ---------- Toast / Alert ---------- */
    .custom-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: white; padding: 12px 24px; border-radius: 99px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); font-weight: 600; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50; display: flex; align-items: center; gap: 8px; }
    .custom-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ---------- Image Modal ---------- */
    #image-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 150; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
    #image-modal.show { display: flex !important; }
    #modal-image, #modal-video { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    #modal-video { display: none; }
    #modal-video.show { display: block; }
    .video-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-radius: 50px; padding: 12px 20px; display: flex; align-items: center; gap: 15px; z-index: 160; }
    .video-controls button { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; padding: 5px; border-radius: 50%; transition: all 0.2s; }
    .video-controls button:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
    .video-progress { flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; cursor: pointer; position: relative; min-width: 200px; }
    .video-progress-bar { height: 100%; background: var(--accent); border-radius: 2px; width: 0%; transition: width 0.1s; }
    .video-time { color: white; font-size: 13px; font-weight: 500; min-width: 80px; text-align: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ---------- Comment Sheet ---------- */
    #comment-sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    #comment-sheet-overlay.show { opacity: 1; pointer-events: auto; }
    .comment-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); border-top-left-radius: 20px; border-top-right-radius: 20px; max-height: 75vh; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease; }
    #comment-sheet-overlay.show .comment-sheet { transform: translateY(0); }
    .comment-sheet-header { padding: 16px; font-size: 18px; font-weight: 700; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .comment-sheet-close { background: none; border: none; color: var(--text2); cursor: pointer; }
    .comment-sheet-list { flex: 1; overflow-y: auto; padding: 0 16px; }
    .comment-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .comment-body { flex: 1; }
    .comment-name { font-size: 14px; font-weight: 700; }
    .comment-text { font-size: 15px; margin-top: 2px; }
    .comment-input-box { display: flex; gap: 12px; padding: 16px; border-top: 1px solid var(--border); }
    .comment-input { flex: 1; resize: none; background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 999px; padding: 10px 16px; font-size: 15px; outline: none; }
    .comment-send-btn { background: var(--accent); color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; display: grid; place-items: center; cursor: pointer; transition: opacity 0.2s; }
    .comment-send-btn:disabled { opacity: 0.5; cursor: default; }
    .comment-like-btn.liked .outline-heart { display: none; }
    .comment-like-btn.liked .filled-heart { display: block; }

    /* ---------- Alert ---------- */
    #custom-alert-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.25s ease; }
    #custom-alert-overlay.show { opacity: 1; pointer-events: auto; }
    .custom-alert-box { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.25s ease; }
    #custom-alert-overlay.show .custom-alert-box { transform: scale(1); }
    .custom-alert-title { font-weight: 700; font-size: 18px; margin-bottom: 8px; }
    .custom-alert-message { font-size: 15px; color: var(--text2); margin-bottom: 20px; }
    .custom-alert-buttons { display: flex; gap: 12px; justify-content: flex-end; }
    .custom-alert-btn { background: none; border: none; font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 999px; transition: background 0.2s; }
    .custom-alert-btn.cancel { color: var(--text2); }
    .custom-alert-btn.cancel:hover { background: rgba(0,0,0,0.05); }
    [data-theme="dark"] .custom-alert-btn.cancel:hover { background: rgba(255,255,255,0.05); }
    .custom-alert-btn.confirm { background: var(--accent); color: #fff; }
    .custom-alert-btn.confirm:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <!-- PWA install banner -->
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#ff2a6d] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix for a better experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="bg-white text-[#ff2a6d] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-icons text-xl">close</span>
      </button>
    </div>
  </div>

  <!-- ========== POSTS FEED ========== -->
  <div id="posts-area">
    <div class="composer">
      <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=random&color=fff" alt="avatar"/>
      <div class="flex-1">
        <textarea id="post-text" placeholder="What is happening?!"></textarea>
        <video id="media-preview-video" class="media-preview hidden" controls muted loop playsinline></video>
        <img id="media-preview-img" class="media-preview hidden" alt=""/>
        <div class="composer-actions">
          <div>
            <input type="file" id="file-input" accept="image/*,video/*" class="hidden"/>
            <label for="file-input" class="icon-btn" title="Add Photo / Video">
              <span class="material-icons-outlined">image</span>
            </label>
          </div>
          <button id="post-btn" class="post-btn" disabled>
            <span id="btn-text">Post</span>
            <span id="btn-spinner" class="spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>
    <main id="feed" class="feed"></main>
    <div class="text-center p-4">
      <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
    </div>
  </div>

  <!-- ========== REELS PAGE ========== -->
  <div id="reels-page">
    <button id="reels-close" class="material-icons">close</button>
    <div id="reels-progress"><div id="reels-progress-bar"></div></div>
    <div id="reels-wrapper"></div>
  </div>

  <!-- Floating Action Button -->
  <div id="fab" class="fab hidden">
    <span class="material-icons">add</span>
  </div>

  <!-- Comment sheet (re-used for both posts & reels) -->
  <div id="comment-sheet-overlay">
    <div class="comment-sheet">
      <div class="comment-sheet-header">
        <span>Comments</span>
        <button class="comment-sheet-close material-icons-outlined" id="comment-sheet-close">close</button>
      </div>
      <div class="comment-sheet-list" id="comment-sheet-list"></div>
      <div class="comment-input-box">
        <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
        <button class="comment-send-btn" id="comment-send-btn">
          <span class="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Image / video modal -->
  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <video id="modal-video" loop>
      <source src="" type="video/mp4">
    </video>
    <div class="video-controls" id="video-controls" style="display: none;">
      <button id="play-pause-btn">
        <span class="material-icons-outlined">play_arrow</span>
      </button>
      <span class="video-time" id="video-time">0:00 / 0:00</span>
      <div class="video-progress" id="video-progress">
        <div class="video-progress-bar" id="video-progress-bar"></div>
      </div>
      <button id="mute-btn">
        <span class="material-icons-outlined">volume_up</span>
      </button>
    </div>
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>

  <!-- Confirmation alert -->
  <div id="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
      <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
      <div class="custom-alert-buttons">
        <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
        <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav id="navbar" class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 z-40">
    <div class="h-full flex items-center justify-around text-gray-500">
      <a href="#" data-tab="home" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">home</span>
        <span class="text-xs mt-0.5">Home</span>
      </a>
      <a href="#" data-tab="videos" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">smart_display</span>
        <span class="text-xs mt-0.5">Videos</span>
      </a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">chat_bubble_outline</span>
        <span class="text-xs mt-0.5">Chat</span>
      </a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">search</span>
        <span class="text-xs mt-0.5">Search</span>
      </a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">auto_awesome</span>
        <span class="text-xs mt-0.5">AI</span>
      </a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">notifications</span>
        <span class="text-xs mt-0.5">Alerts</span>
      </a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">person</span>
        <span class="text-xs mt-0.5">Profile</span>
      </a>
    </div>
  </nav>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let uid, uname, uavatar;
    const $ = s => document.querySelector(s);
    const postBtn = $('#post-btn'), textEl = $('#post-text'),
          previewImg = $('#media-preview-img'), previewVid = $('#media-preview-video'),
          fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
          loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 50;
    let lastTimestamp = null, lastKey = null, initialLoadDone = false;

    /* ---------- Auth ---------- */
    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
      document.body.setAttribute('data-theme', 'dark');
    onAuthStateChanged(auth, user => {
      if (!user) {
        signInAnonymously(auth);
        uid = "guest_" + Math.random().toString(36).slice(2);
        uname = "Guest";
      } else {
        uid = user.uid;
        uname = user.displayName || user.email?.split('@')[0] || 'User';
      }
      uavatar = user?.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
      myAvatarEl.src = uavatar;
      initFeed();
    });

    /* ---------- Feed ---------- */
    function showSkeletonLoaders(count = 5) {
      feedEl.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton-post';
        skeleton.innerHTML = `
          <div class="post-header">
            <div class="skeleton skeleton-avatar"></div>
            <div class="flex-1">
              <div class="skeleton skeleton-line" style="width: 40%; margin-bottom: 8px;"></div>
              <div class="skeleton skeleton-text" style="width: 85%;"></div>
              <div class="skeleton skeleton-text" style="width: 70%;"></div>
              <div class="skeleton skeleton-image" style="height: ${Math.random() > 0.5 ? '250px' : '0'}"></div>
            </div>
          </div>
        `;
        feedEl.appendChild(skeleton);
      }
    }
    async function initFeed() {
      showSkeletonLoaders(5);
      try {
        const postsRef = ref(db, 'posts');
        const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
        const snap = await get(q);
        feedEl.innerHTML = '';
        const rows = [];
        snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
        rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
        const last = rows[rows.length-1];
        if (last) { lastTimestamp = last.timestamp; lastKey = last.key; }
        loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
        initialLoadDone = true;
        listenNew();
      } catch (e) {
        feedEl.innerHTML = '';
        console.error(e);
        toast('Error loading posts');
      }
    }
    function listenNew() {
      const postsRef = ref(db, 'posts');
      onChildAdded(postsRef, snap => {
        if (!initialLoadDone) return;
        const data = snap.val();
        if (!data || !data.timestamp) return;
        if (!lastTimestamp || data.timestamp > lastTimestamp) {
          feedEl.prepend(renderPostCard({key: snap.key, ...data}));
          lastTimestamp = data.timestamp;
        }
      });
    }
    loadMoreBtn.onclick = async () => {
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = 'Loading...';
      const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT+1));
      const snap = await get(q);
      const rows = [];
      snap.forEach(c => rows.push({key: c.key, ...c.val()}));
      const uniq = rows.filter(p => p.key !== lastKey);
      if (!uniq.length) { toast('No more posts'); loadMoreBtn.classList.add('hidden'); return; }
      uniq.reverse();
      uniq.forEach(p => feedEl.appendChild(renderPostCard(p)));
      const last = uniq[uniq.length-1];
      lastTimestamp = last.timestamp; lastKey = last.key;
      if (uniq.length < POST_LIMIT) loadMoreBtn.classList.add('hidden');
      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = 'Load More Posts';
    };

    let mediaUrl = '', uploading = false;
    function toggleBtn() { postBtn.disabled = uploading || (!textEl.value.trim() && !mediaUrl); }
    fileInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const isVideo = file.type.startsWith('video/');
      const isImage = file.type.startsWith('image/');
      if (!isVideo && !isImage) { toast('Only images or videos'); return; }
      const r = new FileReader();
      r.onload = ev => {
        if (isVideo) {
          previewVid.src = ev.target.result;
          previewVid.classList.remove('hidden');
          previewImg.classList.add('hidden');
        } else {
          previewImg.src = ev.target.result;
          previewImg.classList.remove('hidden');
          previewVid.classList.add('hidden');
        }
      };
      r.readAsDataURL(file);
      uploadToCloudinary(file);
    };
    function uploadToCloudinary(file) {
      const CLOUD_NAME = "dqkujefxj", UPLOAD_PRESET = "banter_box";
      uploading = true; toggleBtn();
      $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
        .then(r => r.json())
        .then(async res => {
          mediaUrl = res.secure_url;
          toast('Media uploaded');
        })
        .catch(err => {
          toast('Upload failed');
          mediaUrl = '';
          previewImg.classList.add('hidden');
          previewVid.classList.add('hidden');
          console.error(err);
        })
        .finally(() => {
          uploading = false;
          $('#btn-spinner').classList.add('hidden');
          $('#btn-text').classList.remove('hidden');
          toggleBtn();
        });
    }
    postBtn.onclick = async () => {
      const text = textEl.value.trim();
      if (!text && !mediaUrl) return;
      postBtn.disabled = true;
      $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
      const newRef = push(ref(db, 'posts'));
      const postData = {
        authorId: uid, authorName: uname, authorAvatar: uavatar, text, image: mediaUrl,
        verified: false, likes: 0, replies: 0, reposts: 0, timestamp: serverTimestamp()
      };
      try {
        await set(newRef, postData);
        textEl.value = ''; mediaUrl = '';
        previewImg.classList.add('hidden'); previewVid.classList.add('hidden');
        toggleBtn(); toast('Posted!');
      } catch (err) {
        console.error(err); toast('Error posting');
      } finally {
        $('#btn-spinner').classList.add('hidden'); $('#btn-text').classList.remove('hidden');
        postBtn.disabled = false;
      }
    };
    textEl.oninput = () => { textEl.style.height = 'auto'; textEl.style.height = textEl.scrollHeight + 'px'; toggleBtn(); };

    /* ---------- Post Card ---------- */
    const userMetaCache = new Map();
    function listenUserMeta(uid, card) {
      if (userMetaCache.has(uid)) return applyUserMeta(card, userMetaCache.get(uid));
      const unsub = onValue(ref(db, `users/${uid}/profile`), snap => {
        const v = snap.val() || {};
        const meta = { name: v.displayName || 'User', avatar: v.avatar || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${v.displayName || 'User'}`, verified: !!v.verified };
        userMetaCache.set(uid, meta);
        applyUserMeta(card, meta);
      });
      card._unsubUser = unsub;
    }
    function applyUserMeta(card, meta) {
      card.querySelector('.name').textContent = esc(meta.name);
      card.querySelector('.handle').textContent = `@${meta.name.replace(/\s/g, '').toLowerCase()}`;
      card.querySelector('.post-avatar').src = meta.avatar;
      const badge = card.querySelector('.verified-badge');
      badge.style.display = meta.verified ? 'inline' : 'none';
    }
    function renderPostCard(p) {
      const isMine = p.authorId === uid;
      const div = document.createElement('div');
      div.id = `post-${p.key}`;
      const styleClasses = ['gradient-1', 'gradient-2', 'gradient-3', 'gradient-4', 'gradient-5', 'gradient-6', 'gradient-7', 'gradient-8', 'glass', 'pattern-1', 'pattern-2'];
      const randomStyle = styleClasses[Math.floor(Math.random() * styleClasses.length)];
      div.className = `post-card ${randomStyle}`;
      div.style.position = 'relative';
      div.innerHTML = `
        <div class="post-header">
          <a href="profile.html?uid=${encodeURIComponent(p.authorId)}">
            <img src="${p.authorAvatar}" class="post-avatar">
          </a>
          <div class="flex-1">
            <div class="user-meta">
              <span class="name">${esc(p.authorName)}</span>
              <span class="verified-badge material-icons text-sm" style="display:none">verified</span>
              <span class="handle">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
            </div>
            <div class="post-content">${esc(p.text)}</div>
            ${mediaMarkup(p.image)}
            <div class="post-actions">
              <div class="action-item reply" data-post="${p.key}" data-action="reply">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                <span id="replies-${p.key}">${p.replies||0}</span>
              </div>
              <div class="action-item repost" data-post="${p.key}" data-action="repost">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2l4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
                <span id="reposts-${p.key}">${p.reposts||0}</span>
              </div>
              <div class="action-item like" data-post="${p.key}" data-action="like">
                <svg class="outline-heart" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                <svg class="filled-heart hidden" width="24" height="24" viewBox="0 0 24 24" fill="#f91880" stroke="#f91880" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                <span id="likes-${p.key}">${p.likes||0}</span>
              </div>
              <div class="action-item share" data-post="${p.key}" data-action="share">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
              </div>
              ${isMine ? `<div class="action-item delete-btn" data-post="${p.key}" data-action="delete">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
              </div>` : ''}
            </div>
          </div>
        </div>
      </div>`;
      div.addEventListener('click', e => {
        if (e.target.classList.contains('post-image')) { openImageModal(e.target.src); return; }
        if (e.target.classList.contains('post-video')) { openVideoModal(e.target.dataset.videoUrl); return; }
        const action = e.target.closest('[data-action]')?.dataset.action;
        const postId = e.target.closest('[data-post]')?.dataset.post;
        if (!action || !postId) return;
        e.stopPropagation();
        if (action === 'reply') openComments(postId);
        if (action === 'repost') doRepost(postId);
        if (action === 'like') toggleLike(postId);
        if (action === 'share') navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
        if (action === 'delete') confirmDelete(postId);
      });
      listenCounters(p.key);
      listenUserMeta(p.authorId, div);
      return div;
    }
    function mediaMarkup(url) {
      if (!url) return '';
      const isVideo = url.includes('/video/upload') || url.endsWith('.mp4');
      if (isVideo) {
        return `
          <div class="post-video-wrapper">
            <video class="post-video" muted loop playsinline data-video-url="${url}">
              <source src="${url}" type="video/mp4">
            </video>
            <div class="video-play-overlay">
              <span class="material-icons">play_circle_filled</span>
            </div>
          </div>`;
      }
      return `<img class="post-image" src="${url}" loading="lazy">`;
    }
    function listenCounters(postId) {
      onValue(ref(db, `likes/${postId}`), s => {
        $('#likes-'+postId).textContent = s.size;
        const ic = document.querySelector(`[data-post="${postId}"].like`);
        if (ic) ic.classList.toggle('liked', s.hasChild(uid));
      });
      onValue(ref(db, `comments/${postId}`), s => $('#replies-'+postId).textContent = s.size);
      onValue(ref(db, `reposts/${postId}`), s => $('#reposts-'+postId).textContent = s.size);
    }
    async function toggleLike(postId) {
      const likeRef = ref(db, `likes/${postId}/${uid}`);
      const snap = await get(likeRef);
      if (snap.exists()) await remove(likeRef);
      else await set(likeRef, true);
    }
    async function doRepost(postId) {
      const orig = (await get(ref(db, `posts/${postId}`))).val();
      if (!orig) return;
      const newRef = push(ref(db, 'posts'));
      await set(newRef, {
        authorId: uid, authorName: uname, authorAvatar: uavatar,
        text: orig.text, image: orig.image, verified: false,
        repostOf: {authorName: orig.authorName, key: postId},
        likes: 0, replies: 0, reposts: 0, timestamp: Date.now()
      });
      toast('Re-posted');
    }

    /* ---------- Comments ---------- */
    let currentPostId = null, commentsListener = null;
    const commentOverlay = $('#comment-sheet-overlay'),
          commentList = $('#comment-sheet-list'),
          commentInput = $('#comment-input'),
          commentSendBtn = $('#comment-send-btn');
    function openComments(postId) {
      currentPostId = postId;
      commentInput.value = '';
      delete commentInput.dataset.parent;
      commentInput.placeholder = 'Write a comment...';
      commentList.innerHTML = '<div class="skeleton-post"><div class="flex gap-3"><div class="skeleton skeleton-avatar"></div><div class="flex-1"><div class="skeleton skeleton-line" style="width:60%"></div><div class="skeleton skeleton-text" style="width:90%"></div></div></div></div>'.repeat(3);
      commentOverlay.classList.add('show');
      if (commentsListener) commentsListener();
      commentsListener = onValue(ref(db, `comments/${postId}`), snap => {
        commentList.innerHTML = '';
        if (!snap.exists()) { commentList.innerHTML = '<div class="p-4 text-sm text-gray-500">No comments yet</div>'; return; }
        snap.forEach(c => {
          const v = c.val(), cid = c.key;
          const isMine = v.authorId === uid;
          const d = document.createElement('div'); d.className = 'comment-item';
          d.innerHTML = `
            <img src="${v.authorAvatar}" class="comment-avatar">
            <div class="comment-body flex-1">
              <div class="comment-name">${esc(v.authorName)}</div>
              <div class="comment-text">${esc(v.text)}</div>
              <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
                <button class="comment-like-btn flex items-center gap-1" data-post="${postId}" data-cid="${cid}">
                  <svg class="outline-heart" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                  <svg class="filled-heart hidden" width="16" height="16" fill="#f91880" stroke="#f91880" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                  <span class="comment-like-count">0</span>
                </button>
                <button class="comment-reply-btn flex items-center gap-1" data-post="${postId}" data-cid="${cid}">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                  <span>Reply</span>
                </button>
                ${isMine ? `
                <button class="comment-delete-btn text-red-500" data-post="${postId}" data-cid="${cid}">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                </button>` : ''}
              </div>
            </div>`;
          commentList.appendChild(d);
          listenCommentLikes(postId, cid);
        });
      });
    }
    $('#comment-sheet-close').onclick = closeComments;
    commentOverlay.onclick = e => { if (e.target === commentOverlay) closeComments(); };
    function closeComments() {
      commentOverlay.classList.remove('show');
      if (commentsListener) { commentsListener(); commentsListener = null; }
      currentPostId = null;
    }
    commentSendBtn.onclick = async () => {
      const text = commentInput.value.trim();
      if (!text || !currentPostId) return;
      const parentId = commentInput.dataset.parent || null;
      await set(push(ref(db, `comments/${currentPostId}`)), {
        authorId: uid, authorName: uname, authorAvatar: uavatar, text, parentId, timestamp: Date.now()
      });
      commentInput.value = '';
      delete commentInput.dataset.parent;
      commentInput.placeholder = 'Write a comment...';
      toast('Comment posted');
    };
    commentInput.oninput = () => commentSendBtn.disabled = !commentInput.value.trim();
    function listenCommentLikes(pid, cid) {
      const likeRef = ref(db, `comments/${pid}/${cid}/likes`);
      onValue(likeRef, snap => {
        const cnt = snap.size, liked = snap.hasChild(uid);
        const btn = document.querySelector(`.comment-like-btn[data-cid="${cid}"]`);
        if (!btn) return;
        btn.querySelector('.comment-like-count').textContent = cnt || '';
        btn.classList.toggle('liked', liked);
        btn.querySelector('.outline-heart').style.display = liked ? 'none' : 'inline';
        btn.querySelector('.filled-heart').style.display = liked ? 'inline' : 'none';
      });
    }
    async function toggleCommentLike(pid, cid) {
      const likeRef = ref(db, `comments/${pid}/${cid}/likes/${uid}`);
      const snap = await get(likeRef);
      if (snap.exists()) await remove(likeRef);
      else await set(likeRef, true);
    }
    async function deleteComment(pid, cid) {
      await remove(ref(db, `comments/${pid}/${cid}`));
      toast('Comment deleted');
    }
    commentList.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const pid = btn.dataset.post, cid = btn.dataset.cid;
      if (btn.classList.contains('comment-like-btn')) toggleCommentLike(pid, cid);
      if (btn.classList.contains('comment-delete-btn')) deleteComment(pid, cid);
      if (btn.classList.contains('comment-reply-btn')) openCommentReply(pid, cid);
    });
    function openCommentReply(postId, commentId) {
      openComments(postId);
      commentInput.dataset.parent = commentId;
      commentInput.placeholder = 'Replying to comment…';
    }

    /* ---------- Delete ---------- */
    let deleteKeyStore = null;
    const alertOverlay = $('#custom-alert-overlay'), alertTitle = $('#custom-alert-title'),
          alertMessage = $('#custom-alert-message'), alertCancel = $('#custom-alert-cancel'), alertConfirm = $('#custom-alert-confirm');
    function confirmDelete(key) {
      deleteKeyStore = key;
      alertTitle.textContent = 'Delete Post';
      alertMessage.textContent = 'Are you sure you want to delete this post?';
      alertOverlay.classList.add('show');
    }
    alertCancel.onclick = () => { deleteKeyStore = null; alertOverlay.classList.remove('show'); };
    alertConfirm.onclick = async () => {
      if (!deleteKeyStore) return;
      const key = deleteKeyStore; deleteKeyStore = null; alertOverlay.classList.remove('show');
      try {
        await remove(ref(db, `posts/${key}`));
        const postElement = document.getElementById(`post-${key}`);
        if (postElement) {
          postElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          postElement.style.opacity = '0'; postElement.style.transform = 'translateY(-10px)';
          setTimeout(() => postElement.remove(), 320);
        }
        toast('Deleted');
      } catch {
        toast('Error deleting');
      }
    };

    /* ---------- Image / Video Modal ---------- */
    function openImageModal(src) {
      const modal = $('#image-modal');
      const img = $('#modal-image');
      const video = $('#modal-video');
      const controls = $('#video-controls');
      img.src = src;
      img.style.display = 'block';
      video.style.display = 'none';
      video.classList.remove('show');
      controls.style.display = 'none';
      modal.classList.add('show');
    }
    function openVideoModal(src) {
      const modal = $('#image-modal');
      const img = $('#modal-image');
      const video = $('#modal-video');
      const controls = $('#video-controls');
      img.style.display = 'none';
      video.querySelector('source').src = src;
      video.load();
      video.style.display = 'block';
      video.classList.add('show');
      controls.style.display = 'flex';
      modal.classList.add('show');
      initVideoControls();
    }
    function initVideoControls() {
      const video = $('#modal-video');
      const playPauseBtn = $('#play-pause-btn');
      const muteBtn = $('#mute-btn');
      const videoTime = $('#video-time');
      const videoProgress = $('#video-progress');
      const videoProgressBar = $('#video-progress-bar');
      playPauseBtn.onclick = (e) => {
        e.stopPropagation();
        if (video.paused) {
          video.play();
          playPauseBtn.innerHTML = '<span class="material-icons-outlined">pause</span>';
        } else {
          video.pause();
          playPauseBtn.innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
        }
      };
      muteBtn.onclick = (e) => {
        e.stopPropagation();
        video.muted = !video.muted;
        muteBtn.innerHTML = video.muted ?
          '<span class="material-icons-outlined">volume_off</span>' :
          '<span class="material-icons-outlined">volume_up</span>';
      };
      video.ontimeupdate = () => {
        const progress = (video.currentTime / video.duration) * 100;
        videoProgressBar.style.width = progress + '%';
        videoTime.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
      };
      videoProgress.onclick = (e) => {
        e.stopPropagation();
        const rect = videoProgress.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        video.currentTime = pos * video.duration;
      };
      video.play();
      playPauseBtn.innerHTML = '<span class="material-icons-outlined">pause</span>';
    }
    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    window.closeImageModal = function() {
      const modal = $('#image-modal');
      const video = $('#modal-video');
      video.pause();
      video.currentTime = 0;
      modal.classList.remove('show');
    };
    $('#image-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeImageModal();
      }
    });

    /* ---------- Reels ---------- */
    const reelsPage = $('#reels-page');
    const reelsWrapper = $('#reels-wrapper');
    const reelsClose = $('#reels-close');
    const reelsProgress = $('#reels-progress-bar');
    let reelsData = [];
    let currentReelIndex = 0;
    let reelsObserver;

    function initReels() {
      reelsWrapper.innerHTML = '';
      reelsData = [];
      currentReelIndex = 0;
      const q = query(ref(db, 'posts'), orderByChild('timestamp'));
      onValue(q, snap => {
        const posts = [];
        snap.forEach(c => {
          const p = {key: c.key, ...c.val()};
          if (p.image && (p.image.includes('/video/upload') || p.image.endsWith('.mp4'))) posts.push(p);
        });
        reelsData = posts.reverse();
        renderReels();
        if (reelsData.length) {
          reelsPage.classList.add('show');
          observeReels();
        } else {
          toast('No videos yet');
        }
      }, {onlyOnce: true});
    }
    function renderReels() {
      reelsWrapper.innerHTML = reelsData.map((p, i) => `
        <div class="reel-item" data-index="${i}" data-key="${p.key}">
          <video class="reel-video" src="${p.image}" loop playsinline muted></video>
          <div class="reel-overlay"></div>
          <div class="reel-right-bar">
            <button class="reel-like-btn" data-post="${p.key}" data-action="like">
              <svg class="outline-heart" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              <svg class="filled-heart hidden" width="32" height="32" fill="#f91880" stroke="#f91880" stroke-width="0" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </button>
            <button class="reel-comment-btn" data-post="${p.key}" data-action="reply">
              <span class="material-icons-outlined">comment</span>
            </button>
            <button class="reel-share-btn" data-post="${p.key}" data-action="share">
              <span class="material-icons-outlined">share</span>
            </button>
          </div>
          <div class="reel-meta">
            <div class="reel-meta-name">${esc(p.authorName)}</div>
            <div class="reel-meta-text">${esc(p.text)}</div>
          </div>
          <div class="heart-burst">❤️</div>
        </div>
      `).join('');
    }
    function observeReels() {
      const videos = reelsWrapper.querySelectorAll('.reel-video');
      reelsObserver = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const idx = Number(entry.target.closest('.reel-item').dataset.index);
            currentReelIndex = idx;
            entry.target.play();
            updateProgress(entry.target);
          } else {
            entry.target.pause();
          }
        });
      }, {threshold: 0.7});
      videos.forEach(v => reelsObserver.observe(v));
    }
    function updateProgress(video) {
      if (!video) return;
      const progress = $('#reels-progress-bar');
      const update = () => {
        const pct = (video.currentTime / video.duration) * 100;
        progress.style.width = pct + '%';
        if (!video.paused && !video.ended) requestAnimationFrame(update);
      };
      update();
    }
    reelsClose.onclick = () => {
      reelsPage.classList.remove('show');
      reelsWrapper.innerHTML = '';
      reelsData = [];
      currentReelIndex = 0;
      if (reelsObserver) reelsObserver.disconnect();
    };
    reelsWrapper.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const postId = btn.dataset.post;
      if (action === 'like') {
        toggleLike(postId);
        const heart = btn.closest('.reel-item').querySelector('.heart-burst');
        heart.classList.add('show');
        setTimeout(() => heart.classList.remove('show'), 500);
      }
      if (action === 'reply') openComments(postId);
      if (action === 'share') navigator.share?.({title:'Reel',url:location.href}).catch(()=>toast('Link copied'));
    });
    reelsWrapper.addEventListener('dblclick', e => {
      const item = e.target.closest('.reel-item');
      if (!item) return;
      const postId = item.dataset.key;
      toggleLike(postId);
      const heart = item.querySelector('.heart-burst');
      heart.classList.add('show');
      setTimeout(() => heart.classList.remove('show'), 500);
    });
    let touchStartY = 0;
    reelsWrapper.addEventListener('touchstart', e => touchStartY = e.changedTouches[0].screenY);
    reelsWrapper.addEventListener('touchend', e => {
      const delta = e.changedTouches[0].screenY - touchStartY;
      if (Math.abs(delta) < 50) return;
      if (delta < 0) nextReel();
      else prevReel();
    });
    reelsWrapper.addEventListener('wheel', e => {
      if (e.deltaY > 0) nextReel();
      else prevReel();
    });
    function nextReel() {
      if (currentReelIndex < reelsData.length - 1) {
        currentReelIndex++;
        scrollToReel(currentReelIndex);
      }
    }
    function prevReel() {
      if (currentReelIndex > 0) {
        currentReelIndex--;
        scrollToReel(currentReelIndex);
      }
    }
    function scrollToReel(idx) {
      const item = reelsWrapper.querySelector(`.reel-item[data-index="${idx}"]`);
      if (item) item.scrollIntoView({behavior: 'smooth'});
    }

    /* ---------- Utils ---------- */
    function toast(msg) {
      const t = document.createElement('div'); t.className = 'custom-toast'; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.classList.add('show'), 10);
      setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
    }
    const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
    const timeAgo = ts => {
      if (!ts) return 'now';
      const s = Math.floor((Date.now() - ts) / 1000);
      return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
    };

    /* ---------- Nav ---------- */
    document.querySelectorAll('nav a[data-tab]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const tab = a.dataset.tab;
        if (tab === 'videos') initReels();
      });
    });

    /* ---------- PWA ---------- */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('#pwa-install-banner').classList.remove('-translate-y-full');
    });
    $('#pwa-install-btn')?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      $('#pwa-install-banner').classList.add('-translate-y-full');
    });
    $('#pwa-install-close')?.addEventListener('click', () => {
      $('#pwa-install-banner').classList.add('-translate-y-full');
    });

    /* ---------- FAB / Navbar hide ---------- */
    let lastScrollTop = 0;
    let scrollTimeout;
    const navbar = $('#navbar');
    const fab = $('#fab');
    window.addEventListener('scroll', () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      clearTimeout(scrollTimeout);
      if (scrollTop < lastScrollTop || scrollTop < 100) {
        navbar.classList.remove('hidden');
        fab.classList.remove('hidden');
      } else {
        navbar.classList.add('hidden');
        fab.classList.add('hidden');
      }
      lastScrollTop = scrollTop;
      scrollTimeout = setTimeout(() => {
        navbar.classList.remove('hidden');
        fab.classList.remove('hidden');
      }, 1000);
    });
    fab.addEventListener('click', () => {
      textEl.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>
