<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="description" content="Vynix - Connect with friends">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9 After: #ff2a6dIiwidGhlbWVfY29sb3IiOiIjZmYyYTZkIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vdWktYXZhdGFycy5jb20vYXBpLz9uYW1lPVZ5bml4JmJhY2tncm91bmQ9ZmYyYTZkJmNvbG9yPWZmZiZzaXplPTE5MiIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmciLHsic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP25hbWU9VnluaXgmYmFja2dyb3VuZD1mZjJhNmQmY29sb3I9ZmZmJnNpemU9NTEyIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root{--bg:#ffffff;--card:#f7f9fa;--text:#0f1419;--text2:#536471;--border:#e1e8ed;--accent:#ff2a6d;--glow:0 0 10px rgba(255,42,109,.35);--online-dot:#22c55e;--offline-dot:#9ca3af;}
    [data-theme="dark"]{--bg:#0f1419;--card:#1a1f25;--text:#ffffff;--text2:#8b98a5;--border:#2f3336;--offline-dot:#4b5563;}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);-webkit-user-select:none;user-select:none;transition:all .3s;}
    #header{position:fixed;top:0;left:0;right:0;height:64px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:10;}
    #header h1{font-weight:800;font-size:22px;background:linear-gradient(90deg,var(--accent),#05d9e8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .main{padding:64px 16px 80px;}
    .tab{display:none;}
    .tab.active{display:block;}
    .search{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--text);margin-bottom:12px;}
    .search:focus{outline:none;border-color:var(--accent);box-shadow:var(--glow);}
    .card{display:flex;align-items:center;gap:14px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:12px;transition:all .3s;}
    .card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .avatar-wrapper{position:relative;flex-shrink:0;}
    .avatar{width:52px;height:52px;border-radius:50%;object-fit:cover;transition:transform .2s;}
    .avatar:hover{transform:scale(1.05);}
    .status-dot{position:absolute;bottom:2px;right:2px;width:12px;height:12px;background:var(--online-dot);border:2px solid var(--bg);border-radius:50%;display:none;animation:pulse 2s infinite;}
    .status-dot.offline{background:var(--offline-dot);animation:none;}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    .name{font-weight:700;font-size:16px;display:flex;align-items:center;gap:4px;}
    .verified-badge{color:#1d9bf0;font-size:18px!important;}
    .preview{font-size:14px;color:var(--text2);margin-top:2px;}
    .preview-time{font-size:12px;color:var(--text2);margin-top:2px;}
    .unread{background:var(--accent);color:#fff;font-size:11px;font-weight:700;padding:2px 6px;border-radius:10px;margin-left:auto;}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;align-items:center;}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--text2);cursor:pointer;position:relative;}
    .nav-item.active{color:var(--accent);}
    .nav-item .material-icons{font-size:24px;margin-bottom:2px;}
    .nav-badge{position:absolute;top:2px;right:8px;background:var(--accent);color:#fff;font-size:10px;padding:2px 5px;border-radius:10px;min-width:16px;display:none;}
    .nav-badge.show{display:block;}
    .fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;box-shadow:var(--glow);display:grid;place-items:center;z-index:20;cursor:pointer;}
    .fab:hover{transform:scale(1.1);}
    .status-list{display:flex;flex-direction:column;gap:1px;background:var(--border);}
    .status-item{background:var(--bg);padding:12px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;}
    .status-item:hover{background:var(--card);}
    .status-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid transparent;transition:all .3s;}
    .status-avatar.has-new{border-color:var(--accent);box-shadow:var(--glow);}
    .status-avatar.viewed{border-color:var(--border);}
    .status-count{background:var(--accent);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;min-width:24px;text-align:center;}
    .alert{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:600;display:none;z-index:1000;}
    .alert.show{display:block;animation:fade .3s;}
    @keyframes fade{from{opacity:0;transform:translate(-50%,-10px)}to{opacity:1;transform:translate(-50%,0)}}
    .custom-alert{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;display:none;align-items:center;justify-content:center;}
    .custom-alert.active{display:flex;}
    .alert-box{background:var(--card);border-radius:24px;padding:24px;max-width:320px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
    .alert-btn{padding:10px 20px;border-radius:999px;border:none;font-weight:600;cursor:pointer;}
    .alert-btn.primary{background:var(--accent);color:#fff;}
    .alert-btn.secondary{background:var(--border);color:var(--text);}
    .settings-section{background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid var(--border);}
    .settings-item{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer;}
    .settings-item:last-child{border-bottom:none;}
    .price-badge{background:var(--accent);color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:700;}
    .verified-item{cursor:pointer;}
    .bottom-sheet{position:fixed;bottom:0;left:0;right:0;height:0;background:var(--card);border-top-left-radius:24px;border-top-right-radius:24px;overflow:hidden;transition:height .3s;z-index:100;}
    .bottom-sheet.open{height:75vh;}
    .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);}
    .sheet-content{padding:16px 20px;height:calc(75vh - 60px);overflow-y:auto;}
    .sheet-tabs{display:flex;border-bottom:1px solid var(--border);margin:0 -20px;}
    .sheet-tab{flex:1;padding:12px;text-align:center;cursor:pointer;font-weight:600;color:var(--text2);}
    .sheet-tab.active{color:var(--accent);background:rgba(255,42,109,0.1);}
    .sheet-search{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:999px;background:var(--card);margin:16px 0;}
    .user-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
    .user-row:last-child{border-bottom:none;}
    .user-row img{width:48px;height:48px;border-radius:50%;object-fit:cover;}
    .user-row .name{flex:1;font-weight:600;display:flex;align-items:center;gap:4px;}
    .follow-btn,.request-btn{padding:6px 14px;border-radius:999px;font-size:13px;font-weight:600;cursor:pointer;}
    .follow-btn{background:var(--accent);color:#fff;}
    .follow-btn.following{background:var(--border);color:var(--text2);}
    .follow-btn.requested{background:#6366f1;color:#fff;}
    .request-btn.accept{background:#22c55e;color:white;}
    .request-btn.decline,.request-btn.cancel{background:#ef4444;color:white;}
    .request-actions{display:flex;gap:8px;}
  </style>
</head>
<body class="light">
  <div id="pwa-install-banner" class="pwa-install-banner"><div class="pwa-install-text">Install Vynix for a better experience</div><div class="pwa-install-buttons"><button id="pwa-install-btn" class="pwa-install-btn">Install</button><button id="pwa-install-close" class="pwa-install-close material-icons">close</button></div></div>
  <div id="offline-indicator" class="offline-indicator"><span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px;">wifi_off</span>Offline</div>
  <header id="header"><h1>Vynix</h1><img id="me-avatar" class="avatar w-10 h-10"></header>
  <main class="main">
    <div id="chats" class="tab active">
      <input class="search" id="search" placeholder="Search chatsâ€¦">
      <div id="trivia-card" class="card" style="border-color:var(--accent);box-shadow:var(--glow);cursor:pointer;">
        <span class="material-icons" style="color:#ff2a6d;font-size:32px;text-shadow:0 0 12px rgba(255,42,109,.4);">favorite</span>
        <div><div class="name">Smart Mental Health Assistant</div><div class="preview">get the best professional help you need</div></div>
        <span class="material-icons text-accent ml-auto">arrow_forward</span>
      </div>
      <div id="chat-list"></div>
    </div>
    <div id="status" class="tab"><div class="status-list" id="status-list"></div></div>
    <div id="settings" class="tab">
      <div class="settings-section">
        <div class="settings-header">Appearance</div>
        <div class="settings-item"><div><div class="settings-label">Dark Mode</div><div class="settings-description">Switch to dark theme</div></div><div class="toggle-switch" id="dark-mode-toggle"><div class="toggle-slider"></div></div></div>
      </div>
      <div class="settings-item verified-item" id="get-verified-item">
        <div><div class="settings-label">Get Verified Badge</div><div class="settings-description">Purchase verified badge</div></div>
        <div class="price-badge">R79</div>
      </div>
      <div class="settings-section">
        <div class="settings-header">Account</div>
        <div class="settings-item" id="profile-item"><div><div class="settings-label">Profile</div></div><span class="material-icons" style="color:var(--text2);">chevron_right</span></div>
        <div class="settings-item" id="privacy-policy-item"><div><div class="settings-label">Privacy Policy</div></div><span class="material-icons" style="color:var(--text2);">chevron_right</span></div>
        <div class="settings-item" id="terms-item"><div><div class="settings-label">Terms of Service</div></div><span class="material-icons" style="color:var(--text2);">chevron_right</span></div>
      </div>
      <button id="logout-btn" class="logout-btn"><span class="material-icons" style="vertical-align:middle;margin-right:8px;">logout</span>Log Out</button>
    </div>
  </main>
  <button id="add-fab" class="fab material-icons">person_add</button>
  <button id="status-fab" class="fab material-icons" style="display:none;">add</button>
  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats"><span class="material-icons">chat</span>Chats<span id="chat-badge" class="nav-badge">0</span></div>
    <div class="nav-item" data-tab="status"><span class="material-icons">photo_camera</span>Status</div>
    <div class="nav-item" data-tab="settings"><span class="material-icons">settings</span>Settings</div>
  </nav>

  <div id="sheet" class="bottom-sheet">
    <div class="sheet-header">
      <div class="sheet-tabs">
        <div class="sheet-tab active" data-tab="suggestions">Suggestions</div>
        <div class="sheet-tab" data-tab="requests">Requests <span id="request-count" class="nav-badge">0</span></div>
      </div>
      <button id="close-sheet" class="material-icons text-2xl">close</button>
    </div>
    <div class="sheet-content">
      <div id="suggestions-tab">
        <input type="text" class="sheet-search" id="user-search" placeholder="Search users...">
        <div id="sheet-list"></div>
      </div>
      <div id="requests-tab" style="display:none;"><div id="requests-list"></div></div>
    </div>
  </div>

  <div id="verified-modal" class="custom-alert">
    <div class="alert-box">
      <h3>Get Verified Badge</h3>
      <p>Get the verified badge to show authenticity. <strong>R79</strong></p>
      <div id="yoco-button-container" class="my-4"></div>
      <div class="alert-buttons mt-4"><button id="verified-cancel" class="alert-btn secondary">Cancel</button></div>
    </div>
  </div>

  <div id="alert" class="alert"></div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-box">
      <h3 id="alert-title">Confirm</h3>
      <p id="alert-message">Are you sure?</p>
      <div class="alert-buttons">
        <button id="alert-cancel" class="alert-btn secondary">Cancel</button>
        <button id="alert-confirm" class="alert-btn primary">Confirm</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, onValue, push, set, remove, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let uid, statusListener = null, chatListeners = new Map();

    const toast = (msg) => {
      const al = document.getElementById('alert');
      al.textContent = msg;
      al.classList.add('show');
      setTimeout(() => al.classList.remove('show'), 2500);
    };

    const showCustomAlert = (title, message, onConfirm) => {
      document.getElementById('alert-title').textContent = title;
      document.getElementById('alert-message').textContent = message;
      document.getElementById('custom-alert').classList.add('active');
      const confirm = () => { document.getElementById('custom-alert').classList.remove('active'); onConfirm(); };
      document.getElementById('alert-confirm').onclick = confirm;
      document.getElementById('alert-cancel').onclick = () => document.getElementById('custom-alert').classList.remove('active');
    };

    // === GET VERIFIED (YOCO PAYMENT) ===
    document.getElementById('get-verified-item').onclick = () => {
      document.getElementById('verified-modal').classList.add('active');
      if (!window.YocoSDK) {
        const s = document.createElement('script');
        s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
        s.onload = initYoco;
        document.body.appendChild(s);
      } else initYoco();
      function initYoco() {
        const yoco = new window.YocoSDK({ publicKey: 'pk_test_4d5e6f7g8h9j0k1l2m3n' });
        yoco.showPopup({
          amountInCents: 7900,
          currency: 'ZAR',
          name: 'Vynix Verified Badge',
          description: 'One-time purchase',
          callback: (result) => {
            if (result.error) toast('Payment failed');
            else { set(ref(db, `users/${uid}/verified`), true); toast('You are now verified!'); }
            document.getElementById('verified-modal').classList.remove('active');
          }
        });
      }
    };
    document.getElementById('verified-cancel').onclick = () => document.getElementById('verified-modal').classList.remove('active');

    // === LOAD CHATS (WITH VERIFIED BADGE) ===
    const loadChats = async () => {
      const list = document.getElementById('chat-list');
      list.innerHTML = '';
      const followingSnap = await get(ref(db, `users/${uid}/following`));
      const following = followingSnap.val() || {};
      const ids = Object.keys(following);
      if (!ids.length) { list.innerHTML = '<p class="text-center text-gray-500 mt-10">Follow friends to start chatting</p>'; return; }

      chatListeners.forEach(l => l()); chatListeners.clear();

      ids.forEach(async (id) => {
        const [userSnap, chatSnap] = await Promise.all([
          get(ref(db, `users/${id}`)),
          get(ref(db, `users/${uid}/chats/${id}`))
        ]);
        const user = userSnap.val();
        const chatMeta = chatSnap.val() || {};

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="avatar-wrapper">
            <img class="avatar" src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=05d9e8&color=fff`}">
            <span id="dot-${id}" class="status-dot"></span>
          </div>
          <div style="flex:1">
            <div class="name">${user.displayName || user.email}${user.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}</div>
            <div id="prev-${id}" class="preview">Tap to chat</div>
            <div id="time-${id}" class="preview-time"></div>
          </div>
          <span id="unread-${id}" class="unread" style="display:none;">0</span>
        `;
        card.onclick = () => location.href = `chat.html?chatId=${[uid,id].sort().join('_')}&userId=${id}`;
        list.appendChild(card);

        // Real-time listeners
        onValue(ref(db, `users/${id}/status`), s => {
          const dot = document.getElementById(`dot-${id}`);
          if (s.val() === 'online') { dot.style.display = 'block'; dot.classList.remove('offline'); }
          else { dot.style.display = 'block'; dot.classList.add('offline'); }
        });
        onValue(ref(db, `users/${uid}/chats/${id}/lastMessage`), async s => {
          if (s.exists()) document.getElementById(`prev-${id}`).textContent = await decrypt(s.val(), [uid,id].sort().join('_'));
        });
        onValue(ref(db, `users/${uid}/chats/${id}/lastMessageTime`), s => {
          if (s.exists()) document.getElementById(`time-${id}`).textContent = formatTime(s.val());
        });
        onValue(ref(db, `users/${uid}/chats/${id}/unreadCount`), s => {
          const cnt = s.val() || 0;
          const badge = document.getElementById(`unread-${id}`);
          badge.style.display = cnt ? 'inline' : 'none';
          badge.textContent = cnt > 99 ? '99+' : cnt;
        });
      });
    };

    // === STATUS TAB - FIXED DUPLICATION ===
    const loadStatus = () => {
      const list = document.getElementById('status-list');
      if (statusListener) statusListener();
      statusListener = onValue(ref(db, 'status'), snap => {
        list.innerHTML = '';
        const users = {};
        snap.forEach(child => {
          const s = child.val();
          if (Date.now() - s.timestamp < 24*60*60*1000) {
            if (!users[s.uid]) users[s.uid] = { statuses: [], latest: s.timestamp };
            users[s.uid].statuses.push({ key: child.key, ...s });
            if (s.timestamp > users[s.uid].latest) users[s.uid].latest = s.timestamp;
          }
        });
        Object.keys(users).forEach(async uid => {
          const userSnap = await get(ref(db, `users/${uid}`));
          const user = userSnap.val();
          const arr = users[uid].statuses.sort((a,b) => b.timestamp - a.timestamp);
          const hasNew = arr.some(s => !viewedStatuses.has(s.key));
          const item = document.createElement('div');
          item.className = 'status-item';
          item.innerHTML = `
            <img class="status-avatar ${hasNew ? 'has-new' : 'viewed'}" src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=05d9e8&color=fff`}">
            <div class="status-info">
              <div class="status-name">${user.displayName || user.email}</div>
              <div class="status-time">${formatTime(arr[0].timestamp)}</div>
            </div>
            ${arr.length > 1 ? `<div class="status-count">${arr.length}</div>` : ''}
          `;
          item.onclick = () => openViewer(uid);
          list.appendChild(item);
        });
        if (!Object.keys(users).length) list.innerHTML = '<div class="text-center py-8 text-gray-500">No recent status updates</div>';
      });
    };

    const formatTime = t => {
      const d = Date.now() - t;
      const m = Math.floor(d/60000);
      if (m < 1) return 'Just now';
      if (m < 60) return `${m}m ago`;
      if (d < 24*3600000) return `${Math.floor(m/60)}h ago`;
      return 'Today';
    };

    // === BOTTOM SHEET - REAL-TIME FOLLOW + CANCEL REQUEST ===
    const openSheet = () => document.getElementById('sheet').classList.add('open');
    document.getElementById('add-fab').onclick = () => { openSheet(); loadSuggestions(); loadRequests(); };
    document.getElementById('close-sheet').onclick = () => document.getElementById('sheet').classList.remove('open');

    const loadSuggestions = async () => {
      const list = document.getElementById('sheet-list');
      list.innerHTML = 'Loading...';
      const all = await get(ref(db, 'users'));
      const following = (await get(ref(db, `users/${uid}/following`))).val() || {};
      const sent = (await get(ref(db, `users/${uid}/sentRequests`))).val() || {};
      list.innerHTML = '';
      all.forEach(child => {
        if (child.key === uid) return;
        const u = child.val();
        const isFollowing = following[child.key];
        const requested = sent[child.key];
        const row = document.createElement('div');
        row.className = 'user-row';
        row.innerHTML = `
          <img src="${u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName || 'U'}&background=05d9e8&color=fff`}">
          <div class="name">${u.displayName || u.email}${u.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}</div>
          <button class="follow-btn ${isFollowing ? 'following' : requested ? 'requested' : ''}" data-uid="${child.key}">
            ${isFollowing ? 'Following' : requested ? 'Requested' : 'Follow'}
          </button>
        `;
        const btn = row.querySelector('.follow-btn');
        if (isFollowing) btn.disabled = true;
        else if (requested) btn.onclick = () => cancelRequest(child.key);
        else btn.onclick = () => sendRequest(child.key);
        list.appendChild(row);
      });
    };

    const sendRequest = async (target) => {
      await set(ref(db, `users/${uid}/sentRequests/${target}`), { timestamp: serverTimestamp() });
      await set(ref(db, `users/${target}/receivedRequests/${uid}`), { timestamp: serverTimestamp() });
      toast('Request sent');
      loadSuggestions();
    };
    const cancelRequest = async (target) => {
      await remove(ref(db, `users/${uid}/sentRequests/${target}`));
      await remove(ref(db, `users/${target}/receivedRequests/${uid}`));
      toast('Request cancelled');
      loadSuggestions();
    };

    const loadRequests = async () => {
      const list = document.getElementById('requests-list');
      const snap = await get(ref(db, `users/${uid}/receivedRequests`));
      const requests = snap.val() || {};
      document.getElementById('request-count').textContent = Object.keys(requests).length;
      document.getElementById('request-count').classList.toggle('show', Object.keys(requests).length > 0);
      list.innerHTML = '';
      for (const id in requests) {
        const userSnap = await get(ref(db, `users/${id}`));
        const u = userSnap.val();
        const row = document.createElement('div');
        row.className = 'user-row';
        row.innerHTML = `
          <img src="${u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName || 'U'}`}">
          <div class="name">${u.displayName || u.email}${u.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}</div>
          <div class="request-actions">
            <button class="request-btn accept" data-uid="${id}">Accept</button>
            <button class="request-btn decline" data-uid="${id}">Decline</button>
          </div>
        `;
        row.querySelector('.accept').onclick = () => acceptRequest(id);
        row.querySelector('.decline').onclick = () => declineRequest(id);
        list.appendChild(row);
      }
    };

    const acceptRequest = async (id) => {
      await set(ref(db, `users/${uid}/followers/${id}`), true);
      await set(ref(db, `users/${id}/following/${uid}`), true);
      await remove(ref(db, `users/${uid}/receivedRequests/${id}`));
      await remove(ref(db, `users/${id}/sentRequests/${uid}`));
      toast('Request accepted');
      loadRequests(); loadChats();
    };
    const declineRequest = async (id) => {
      await remove(ref(db, `users/${uid}/receivedRequests/${id}`));
      await remove(ref(db, `users/${id}/sentRequests/${uid}`));
      toast('Request declined');
      loadRequests();
    };

    // === NAVIGATION ===
    document.querySelectorAll('.nav-item').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tab = el.dataset.tab;
        document.getElementById(tab).classList.add('active');
        document.getElementById('add-fab').style.display = tab === 'chats' ? 'grid' : 'none';
        document.getElementById('status-fab').style.display = tab === 'status' ? 'grid' : 'none';
      });
    });

    document.querySelectorAll('.sheet-tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.sheet-tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('suggestions-tab').style.display = t.dataset.tab === 'suggestions' ? 'block' : 'none';
        document.getElementById('requests-tab').style.display = t.dataset.tab === 'requests' ? 'block' : 'none';
        if (t.dataset.tab === 'requests') loadRequests();
      });
    });

    // === AUTH ===
    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = 'login.html';
      uid = user.uid;
      document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=ff2a6d&color=fff`;
      loadChats();
      loadStatus();
    });
  </script>
</body>
</html>
