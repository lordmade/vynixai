<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Vynix AI • Tutor & Calc</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>

  <style>
    :root {
      --bg-page: #09090B;
      --bg-sidebar: #121214;
      --bg-surface: #1E1E22;
      --primary: #6366F1;
      --accent-gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      --text-main: #FFFFFF;
      --text-muted: #A1A1AA;
      --border: #27272A;
      --sidebar-width: 260px;
      --sidebar-mini: 80px;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { background: var(--bg-page); color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; display: flex; overflow: hidden; }

    /* --- SIDEBAR --- */
    .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    
    @media (min-width: 769px) {
      .sidebar { width: var(--sidebar-mini); position: relative; }
      .sidebar:hover { width: var(--sidebar-width); }
      .sidebar:not(:hover) .nav-text, .sidebar:not(:hover) .brand-text, .sidebar:not(:hover) .user-info { opacity: 0; width: 0; overflow: hidden; }
    }

    @media (max-width: 768px) {
      .sidebar { position: fixed; inset: 0 auto 0 0; width: var(--sidebar-width); transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 40; display: none; }
      .overlay.active { display: block; }
    }

    .sidebar-header { height: 80px; display: flex; align-items: center; padding: 0 22px; }
    .brand-logo { width: 36px; height: 36px; background: var(--accent-gradient); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .brand-text { font-weight: 700; margin-left: 14px; white-space: nowrap; }

    .nav-links { flex: 1; padding: 20px 14px; display: flex; flex-direction: column; gap: 8px; }
    .nav-item { display: flex; align-items: center; padding: 12px; border-radius: 16px; color: var(--text-muted); cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .nav-item:hover, .nav-item.active { background: var(--bg-surface); color: white; }
    .nav-item .material-symbols-rounded { font-size: 24px; margin-right: 14px; }

    /* --- MAIN --- */
    .main-wrapper { flex: 1; display: flex; flex-direction: column; position: relative; }
    .header { height: 72px; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(180deg, var(--bg-page) 0%, rgba(9,9,11,0) 100%); z-index: 10; }
    .hamburger { background: none; border: none; color: white; cursor: pointer; display: none; }
    @media (max-width: 768px) { .hamburger { display: block; } }

    .chat-container { flex: 1; overflow-y: auto; padding: 90px 20px 120px; display: flex; flex-direction: column; gap: 20px; }
    
    /* --- BUBBLES --- */
    .message { max-width: 85%; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .message.user { align-self: flex-end; }
    .message.ai { align-self: flex-start; }

    .msg-bubble { padding: 14px 20px; border-radius: 20px; line-height: 1.6; font-size: 0.95rem; }
    .message.user .msg-bubble { background: var(--accent-gradient); color: white; border-bottom-right-radius: 4px; }
    .message.ai .msg-bubble { background: var(--bg-surface); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

    /* Table Styling inside Bubbles */
    table { width: 100%; border-collapse: collapse; margin: 10px 0; background: rgba(255,255,255,0.03); border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; border: 1px solid var(--border); text-align: left; }
    th { background: rgba(255,255,255,0.05); color: var(--primary); }

    /* --- INPUT --- */
    .input-bar { 
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 700px; background: rgba(30, 30, 34, 0.8);
      backdrop-filter: blur(20px); border: 1px solid var(--border);
      border-radius: 100px; padding: 6px 6px 6px 20px; display: flex; align-items: center;
    }
    .input-bar input { flex: 1; background: none; border: none; outline: none; color: white; font-size: 1rem; height: 44px; }
    .send-btn { width: 44px; height: 44px; background: white; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* --- AUTH MODAL --- */
    .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    .auth-card { background: #141416; padding: 40px; border-radius: 24px; text-align: center; border: 1px solid var(--border); width: 90%; max-width: 400px; }
    .google-btn { width: 100%; padding: 14px; background: white; color: black; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 20px; }
  </style>
</head>
<body>

  <div id="authOverlay" class="auth-overlay">
    <div class="auth-card">
      <div class="brand-logo" style="margin: 0 auto 20px;">⚡</div>
      <h2>Welcome to Vynix</h2>
      <p style="color:var(--text-muted); margin-top:8px;">Sign in to start learning</p>
      <button class="google-btn" onclick="signIn()">Sign in with Google</button>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand-logo">⚡</div>
      <span class="brand-text">Vynix AI</span>
    </div>
    <div class="nav-links">
      <div class="nav-item active" onclick="showView('chat')">
        <span class="material-symbols-rounded">chat_bubble</span>
        <span class="nav-text">Chat Tutor</span>
      </div>
      <div class="nav-item" onclick="sendPatternGuide()">
        <span class="material-symbols-rounded">calculate</span>
        <span class="nav-text">Pattern Guide</span>
      </div>
    </div>
    <div class="sidebar-footer" style="padding: 20px; border-top: 1px solid var(--border);">
      <div id="userName" style="font-weight:600; font-size:0.85rem">Guest</div>
      <div onclick="signOut()" style="color:var(--primary); font-size:0.75rem; cursor:pointer; margin-top:5px;">Sign Out</div>
    </div>
  </nav>

  <div class="main-wrapper">
    <header class="header">
      <button class="hamburger" onclick="toggleSidebar()">
        <span class="material-symbols-rounded">menu</span>
      </button>
      <div style="font-weight:700">Mathematics Grade 12</div>
      <div id="status" style="width:10px; height:10px; background: #10B981; border-radius:50%"></div>
    </header>

    <main class="chat-container" id="chatContainer">
      </main>

    <div class="input-bar">
      <input type="text" id="userInput" placeholder="Ask anything about sequences...">
      <button class="send-btn" onclick="handleSend()">
        <span class="material-symbols-rounded" style="color:black">arrow_upward</span>
      </button>
    </div>
  </div>

  <script>
    /* --- CONFIG & STATE --- */
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let XAI_KEY = "";

    /* --- AUTH --- */
    function signIn() {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }
    function signOut() { auth.signOut(); location.reload(); }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('userName').textContent = user.displayName;
        loadAIKey();
        appendMessage('ai', `**Hello ${user.displayName.split(' ')[0]}!** I am your Vynix Math Tutor. Ready to solve some patterns?`);
      }
    });

    async function loadAIKey() {
      const rc = firebase.remoteConfig();
      rc.settings = { minimumFetchIntervalMillis: 3600000 };
      await rc.fetchAndActivate();
      XAI_KEY = rc.getValue('xai_api_key').asString();
    }

    /* --- UI LOGIC --- */
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('overlay').classList.toggle('active');
    }

    function appendMessage(role, text) {
      const container = document.getElementById('chatContainer');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      msgDiv.innerHTML = `<div class="msg-bubble">${formatText(text)}</div>`;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
      
      renderMathInElement(msgDiv, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false}
        ],
        throwOnError: false
      });
    }

    function formatText(text) {
      // Basic markdown replacements for UI cleanliness
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>')
        .replace(/\|/g, ''); // Cleaning up table pipes if any remain
    }

    /* --- SPECIAL: PATTERN GUIDE --- */
    function sendPatternGuide() {
      const guide = `
        ### Finding the $n$-th Term Formula
        
        **1. Analyze the Differences**
        <table>
          <tr><th>Level</th><th>Sequence Type</th><th>Formula</th></tr>
          <tr><td>1st Difference</td><td>Arithmetic</td><td>$a_n = a_1 + (n-1)d$</td></tr>
          <tr><td>2nd Difference</td><td>Quadratic</td><td>$a_n = an^2 + bn + c$</td></tr>
        </table>

        **2. How to Solve**
        - For **Arithmetic**: $d$ is the constant difference.
        - For **Quadratic**: 
          - $2a = \\text{second difference}$
          - $3a + b = \\text{first difference of first two terms}$
          - $a + b + c = \\text{first term}$
      `;
      appendMessage('ai', guide);
      if(window.innerWidth < 768) toggleSidebar();
    }

    /* --- CHAT API --- */
    async function handleSend() {
      const input = document.getElementById('userInput');
      const val = input.value.trim();
      if(!val || !XAI_KEY) return;

      appendMessage('user', val);
      input.value = '';

      try {
        const response = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${XAI_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "grok-4-1-fast-reasoning",
            messages: [
              { role: "system", content: "You are Vynix AI. Use LaTeX for math. Use simple HTML tables for patterns. No markdown stars/hashes in final output." },
              { role: "user", content: val }
            ]
          })
        });
        const data = await response.json();
        appendMessage('ai', data.choices[0].message.content);
      } catch (err) {
        appendMessage('ai', "Sorry, I'm having trouble connecting to the brain. Try again?");
      }
    }

    // Enter Key Support
    document.getElementById('userInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') handleSend();
    });
  </script>
</body>
</html>
