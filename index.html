<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="description" content="Vynix - Connect with friends">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP25hbWU9VnluaXgmYmFja2dyb3VuZD1mZjJhNmQmY29sb3I9ZmZmJnNpemU9MTkyIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP25hbWU9VnluaXgmYmFja2dyb3VuZD1mZjJhNmQmY29sb3I9ZmZmJnNpemU9NTEyIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  
  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  
  <style>
    :root { --bg:#fff;--card:#f7f9fa;--text:#0f1419;--text2:#536471;--border:#e1e8ed;--accent:#ff2a6d;--glow:0 0 10px rgba(255,42,109,.35);--online:#22c55e;--offline:#9ca3af; }
    [data-theme="dark"] { --bg:#000;--card:#151515;--text:#fff;--text2:#71767b;--border:#2f3336; }
    body {font-family:system-ui;background:var(--bg);color:var(--text);margin:0;-webkit-tap-highlight-color:transparent;}
    #header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:10;}
    #header h1{font-weight:800;font-size:21px;background:linear-gradient(90deg,var(--accent),#05d9e8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .main{padding:60px 0 80px;}
    .tab{display:none;}
    .tab.active{display:block;}
    .card{background:var(--card);border-radius:16px;margin:12px 16px;padding:16px;border:1px solid var(--border);}
    .post-actions{display:flex;gap:16px;padding:8px 0;align-items:center;}
    .post-action{display:flex;align-items:center;gap:6px;cursor:pointer;color:var(--text2);}
    .post-action.active{color:#ed4956;}
    .post-action .material-icons,.post-action .material-icons-outlined{font-size:24px!important;}
    .post-actions > :last-child{margin-left:auto;}
    .post-comments{padding:0 16px 16px;display:none;}
    .post-comments.show{display:block;}
    .comment-input-wrapper{display:flex;gap:8px;margin-top:8px;}
    .comment-input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:20px;background:var(--bg);}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--card);border-top:1px solid var(--border);display:flex;z-index:10;}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:var(--text2);cursor:pointer;}
    .nav-item.active{color:var(--accent);}
    .fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:white;box-shadow:var(--glow);display:grid;place-items:center;z-index:20;font-size:28px;cursor:pointer;}
    .alert{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:var(--accent);color:white;padding:12px 24px;border-radius:99px;z-index:1000;display:none;}
    .alert.show{display:block;animation:fade .3s;}
    @keyframes fade{from{opacity:0;transform:translate(-50%,-10px)}to{opacity:1;transform:translate(-50%,0)}}
    .status-dot{position:absolute;bottom:2px;right:2px;width:12px;height:12px;background:var(--online);border:2px solid var(--bg);border-radius:50%;}
    .status-dot.offline{background:var(--offline);}
    .bottom-sheet{position:fixed;bottom:0;left:0;right:0;height:0;background:var(--card);border-top-left-radius:24px;border-top-right-radius:24px;overflow:hidden;transition:height .3s;z-index:100;}
    .bottom-sheet.open{height:75vh;}
    .sheet-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    .user-row{display:flex;gap:12px;padding:12px 0;align-items:center;border-bottom:1px solid var(--border);}
    .follow-btn{background:var(--accent);color:white;padding:6px 16px;border-radius:999px;font-weight:600;cursor:pointer;}
    .follow-btn.following{background:#e2e8f0;color:#333;}
  </style>
</head>
<body>

  <!-- PWA Banner -->
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-accent text-white p-4 text-center hidden z-50">
    Install Vynix for the best experience
    <button id="install-btn" class="ml-4 bg-white text-accent px-4 py-1 rounded-full font-bold">Install</button>
    <button id="close-banner" class="ml-2 text-white text-2xl">×</button>
  </div>

  <header id="header">
    <h1>Vynix</h1>
    <img id="me-avatar" class="w-10 h-10 rounded-full" src="">
  </header>

  <main class="main">

    <!-- Posts Tab -->
    <div id="posts" class="tab active">
      <div class="card">
        <textarea id="post-text" class="w-full p-3 border rounded-lg resize-none min-h-24" placeholder="What's on your mind?"></textarea>
        <div id="attachment-preview" class="my-2"></div>
        <div class="flex justify-between items-center mt-3">
          <input type="file" id="media-input" accept="image/*,video/*" hidden>
          <button onclick="document.getElementById('media-input').click()" class="text-accent text-3xl material-icons">add_photo_alternate</button>
          <button id="create-post-btn" class="bg-accent text-white px-6 py-2 rounded-full font-bold">Post</button>
        </div>
      </div>
      <div id="posts-feed"></div>
    </div>

    <!-- Chats Tab -->
    <div id="chats" class="tab">
      <input type="text" class="w-full p-3 border rounded-full mx-4 mt-4" placeholder="Search chats..." id="chat-search">
      <div id="chat-list" class="mt-4"></div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab">
      <div class="card">
        <div class="flex justify-between items-center py-4">
          <div>Dark Mode</div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="dark-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-400 rounded-full peer-checked:bg-accent after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
          </label>
        </div>
        <button onclick="signOut(auth).then(()=>location.href='login.html')" class="w-full bg-red-500 text-white py-4 rounded-full mt-8 font-bold">Log Out</button>
      </div>
    </div>
  </main>

  <button id="add-fab" class="fab material-icons">person_add</button>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="posts"><span class="material-icons">article</span>Posts</div>
    <div class="nav-item" data-tab="chats"><span class="material-icons">chat</span>Chats</div>
    <a href="ai.html" class="nav-item"><span class="material-icons">auto_awesome</span>Buddy</a>
    <div class="nav-item" data-tab="settings"><span class="material-icons">settings</span>Settings</div>
  </nav>

  <!-- Bottom Sheet -->
  <div id="sheet" class="bottom-sheet">
    <div class="sheet-header">
      <h3 class="font-bold">Add Friends</h3>
      <button onclick="document.getElementById('sheet').classList.remove('open')" class="text-3xl">×</button>
    </div>
    <div class="p-4">
      <input type="text" id="user-search" placeholder="Search users..." class="w-full p-3 border rounded-full mb-4">
      <div id="user-list"></div>
    </div>
  </div>

  <div id="alert" class="alert"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, onValue, push, set, remove, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    // REPLACE THIS WITH YOUR NEW FIREBASE PROJECT CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid = null;
    let currentMedia = null;
    let postsListener = null;
    let chatListeners = new Map();

    const toast = (msg) => {
      const a = document.getElementById('alert');
      a.textContent = msg;
      a.classList.add('show');
      setTimeout(() => a.classList.remove('show'), 3000);
    };

    // Upload to Cloudinary (add your keys)
    const uploadMedia = async (file) => {
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', 'YOUR_CLOUDINARY_PRESET');
      const res = await fetch(`https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/upload`, { method: 'POST', body: form });
      const data = await res.json();
      return { url: data.secure_url, type: file.type.startsWith('image/') ? 'image' : 'video' };
    };

    // Post Actions
    window.toggleLike = async (postId) => {
      const path = ref(db, `posts/${postId}/likes/${uid}`);
      const snap = await get(path);
      snap.exists() ? await remove(path) : await set(path, true);
    };

    window.toggleComments = (id) => document.getElementById(`comments-${id}`).classList.toggle('show');

    window.sharePost = () => {
      if (navigator.share) {
        navigator.share({ title: 'Vynix Post', url: location.href });
      } else {
        navigator.clipboard.writeText(location.href);
        toast('Link copied!');
      }
    };

    window.toggleSave = async (postId) => {
      const path = ref(db, `users/${uid}/savedPosts/${postId}`);
      const snap = await get(path);
      if (snap.exists()) {
        await remove(path);
        toast('Unsaved');
      } else {
        await set(path, true);
        toast('Saved!');
      }
    };

    window.addComment = async (postId) => {
      const input = document.getElementById(`comment-input-${postId}`);
      const text = input.value.trim();
      if (!text) return;
      await push(ref(db, `posts/${postId}/comments`), { userId: uid, text, timestamp: Date.now() });
      input.value = '';
    };

    window.handleCommentKeypress = (e, id) => e.key === 'Enter' && addComment(id);

    // Render Post (Instagram Style)
    const renderPost = async (post) => {
      const userSnap = await get(ref(db, `users/${post.userId}`));
      const user = userSnap.val() || {};
      const isLiked = post.likes?.[uid];
      const isSaved = (await get(ref(db, `users/${uid}/savedPosts/${post.id}`))).exists();
      const likes = Object.keys(post.likes || {}).length;
      const comments = Object.keys(post.comments || {}).length;

      const el = document.createElement('div');
      el.className = 'card';
      el.id = `post-${post.id}`;
      el.innerHTML = `
        <div class="flex items-center gap-3 pb-3">
          <img class="w-12 h-12 rounded-full" src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=ff2a6d`}">
          <div><div class="font-bold">${user.displayName || 'User'}</div></div>
        </div>
        ${post.text ? `<p class="py-2">${post.text}</p>` : ''}
        ${post.mediaUrl ? `<img src="${post.mediaUrl}" class="w-full rounded-lg">` : ''}
        <div class="post-actions">
          <div class="post-action ${isLiked?'active':''}" onclick="toggleLike('${post.id}')">
            <span class="material-icons">${isLiked?'favorite':'favorite_border'}</span>
            <span>${likes}</span>
          </div>
          <div class="post-action" onclick="toggleComments('${post.id}')">
            <span class="material-icons-outlined">mode_comment</span>
            <span>${comments}</span>
          </div>
          <div class="post-action" onclick="sharePost()">
            <span class="material-icons-outlined">send</span>
          </div>
          <div class="post-action ${isSaved?'active':''}" onclick="toggleSave('${post.id}')">
            <span class="material-icons-outlined">${isSaved?'bookmark':'bookmark_border'}</span>
          </div>
        </div>
        <div class="post-comments" id="comments-${post.id}">
          <div class="comment-input-wrapper">
            <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Add a comment..." onkeypress="handleCommentKeypress(event,'${post.id}')">
            <button class="text-accent font-bold" onclick="addComment('${post.id}')">Post</button>
          </div>
        </div>
      `;
      document.getElementById('posts-feed').appendChild(el);
    };

    const loadPosts = () => {
      if (postsListener) postsListener();
      postsListener = onValue(ref(db, 'posts'), async (snap) => {
        document.getElementById('posts-feed').innerHTML = '';
        const posts = [];
        snap.forEach(child => posts.push({ id: child.key, ...child.val() }));
        posts.sort((a, b) => b.timestamp - a.timestamp);
        for (const post of posts) await renderPost(post);
      });
    };

    const loadChats = async () => {
      const list = document.getElementById('chat-list');
      list.innerHTML = '';
      const followingSnap = await get(ref(db, `users/${uid}/following`));
      const following = followingSnap.val() || {};
      for (const id in following) {
        const userSnap = await get(ref(db, `users/${id}`));
        const user = userSnap.val();
        if (!user) continue;
        const card = document.createElement('div');
        card.className = 'card flex items-center gap-4 cursor-pointer';
        card.onclick = () => location.href = `chat.html?with=${id}`;
        card.innerHTML = `
          <div class="relative">
            <img class="w-14 h-14 rounded-full" src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}`}">
            <div id="dot-${id}" class="status-dot"></div>
          </div>
          <div class="flex-1">
            <div class="font-bold">${user.displayName || user.email}</div>
          </div>
        `;
        list.appendChild(card);
        onValue(ref(db, `users/${id}/status`), s => {
          const dot = document.getElementById(`dot-${id}`);
          if (dot) dot.classList.toggle('offline', s.val() !== 'online');
        });
      }
    };

    const loadUsersForFollow = async () => {
      const list = document.getElementById('user-list');
      list.innerHTML = '';
      const snap = await get(ref(db, 'users'));
      const followingSnap = await get(ref(db, `users/${uid}/following`));
      const following = followingSnap.val() || {};
      snap.forEach(child => {
        if (child.key === uid || following[child.key]) return;
        const user = child.val();
        const row = document.createElement('div');
        row.className = 'user-row';
        row.innerHTML = `
          <img class="w-12 h-12 rounded-full" src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}`}">
          <div class="font-bold flex-1">${user.displayName || user.email}</div>
          <button class="follow-btn" onclick="followUser('${child.key}', this)">Follow</button>
        `;
        list.appendChild(row);
      });
    };

    window.followUser = async (targetId, btn) => {
      await set(ref(db, `users/${uid}/following/${targetId}`), true);
      await set(ref(db, `users/${targetId}/followers/${uid}`), true);
      btn.textContent = 'Following';
      btn.classList.add('following');
      btn.disabled = true;
      toast('Now following');
      loadChats();
    };

    // Create Post
    document.getElementById('create-post-btn').onclick = async () => {
      const text = document.getElementById('post-text').value.trim();
      if (!text && !currentMedia) return toast('Add text or media');
      let media = null;
      if (currentMedia) media = await uploadMedia(currentMedia);
      const postRef = push(ref(db, 'posts'));
      await set(postRef, {
        userId: uid,
        text,
        mediaUrl: media?.url || null,
        mediaType: media?.type || null,
        timestamp: Date.now(),
        likes: {},
        comments: {}
      });
      document.getElementById('post-text').value = '';
      document.getElementById('attachment-preview').innerHTML = '';
      currentMedia = null;
      toast('Posted!');
    };

    document.getElementById('media-input').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      currentMedia = file;
      const url = URL.createObjectURL(file);
      document.getElementById('attachment-preview').innerHTML = 
        file.type.startsWith('image/') ? `<img src="${url}" class="w-full rounded-lg">` : `<video src="${url}" controls class="w-full rounded-lg"></video>`;
    };

    document.getElementById('add-fab').onclick = () => {
      document.getElementById('sheet').classList.add('open');
      loadUsersForFollow();
    };

    // Tab Navigation
    document.querySelectorAll('.nav-item[data-tab]').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(el.dataset.tab).classList.add('active');
        document.getElementById('add-fab').style.display = el.dataset.tab === 'chats' ? 'grid' : 'none';
      });
    });

    // Auth
    onAuthStateChanged(auth, user => {
      if (!user) return location.href = 'login.html';
      uid = user.uid;
      document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=ff2a6d`;
      set(ref(db, `users/${uid}/status`), 'online');
      onDisconnect(ref(db, `users/${uid}/status`)).set('offline');
      loadPosts();
      loadChats();
    });

    // PWA Install
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('pwa-install-banner').classList.remove('hidden');
    });
    document.getElementById('install-btn').onclick = () => { deferredPrompt?.prompt(); };
    document.getElementById('close-banner').onclick = () => document.getElementById('pwa-install-banner').classList.add('hidden');

    // Dark Mode
    document.getElementById('dark-toggle').onchange = (e) => {
      document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
    };
  </script>
</body>
</html>
