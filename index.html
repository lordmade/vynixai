<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --text: #0f1419;
      --text2: #536471;
      --border: #e1e8ed;
      --accent: #ff2a6d;
      --glow: 0 0 10px rgba(255, 42, 109, .35);
      --online-dot: #22c55e;
    }
    [data-theme="dark"] {
      --bg: #0f1419;
      --card: #1a1f25;
      --text: #ffffff;
      --text2: #8b98a5;
      --border: #2f3336;
    }
    body {font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);margin:0;-webkit-user-select:none;user-select:none;}
    #header{position:fixed;top:0;left:0;right:0;height:64px;background:var(--card);border-bottom:1px solid var(--border);z-index:10;display:flex;align-items:center;justify-content:space-between;padding:0 20px;}
    #header h1{font-weight:800;font-size:22px;background:linear-gradient(90deg,var(--accent),#05d9e8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .main{padding:64px 16px 80px;}
    .tab{display:none;}
    .tab.active{display:block;}

    /* Search & Chats */
    .search{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:999px;background:var(--card);margin-bottom:12px;}
    .card{display:flex;gap:14px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:12px;}
    .avatar{width:52px;height:52px;border-radius:50%;object-fit:cover;}
    .avatar-wrapper{position:relative;}
    .status-dot{position:absolute;bottom:2px;right:2px;width:12px;height:12px;background:var(--online-dot);border-radius:50%;border:2px solid var(--bg);display:none;}
    .status-dot.show{display:block;}
    .name{font-weight:700;font-size:16px;}
    .preview{color:var(--text2);font-size:14px;margin-top:4px;}
    .preview-time{font-size:12px;color:var(--text2);}
    .unread{background:var(--accent);color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;margin-left:auto;}

    /* Stories Bar */
    .stories-bar{overflow-x:auto;white-space:nowrap;padding:12px 0;background:var(--card);border-bottom:1px solid var(--border);display:flex;gap:16px;align-items:center;-ms-overflow-style:none;scrollbar-width:none;}
    .stories-bar::-webkit-scrollbar{display:none;}
    .story-item{text-align:center;flex-shrink:0;cursor:pointer;}
    .story-ring{width:72px;height:72px;border-radius:50%;padding:3px;background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);box-shadow:var(--glow);display:grid;place-items:center;}
    .story-ring.me{background:var(--border);box-shadow:none;}
    .story-avatar{width:100%;height:100%;border-radius:50%;object-fit:cover;border:3px solid var(--card);}
    .story-name{font-size:12px;margin-top:6px;color:var(--text);max-width:72px;overflow:hidden;text-overflow:ellipsis;}

    /* Posts */
    .post-card{background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:16px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);}
    .post-header{padding:12px 16px;display:flex;gap:12px;align-items:center;}
    .post-avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;}
    .post-name{font-weight:600;font-size:15px;}
    .post-time{font-size:13px;color:var(--text2);}
    .post-text{padding:0 16px 12px;white-space:pre-wrap;word-break:break-word;}
    .post-media{width:100%;max-height:520px;object-fit:contain;background:#000;}
    .post-actions{display:flex;justify-content:space-around;padding:8px 0;border-top:1px solid var(--border);}
    .action-btn{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;color:var(--text2);font-weight:600;}
    .action-btn.liked{color:#ff2a6d;}
    .action-btn.reposted{color:#10b981;}

    /* FABs & Nav */
    .fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;box-shadow:var(--glow);display:grid;place-items:center;z-index:20;}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--card);border-top:1px solid var(--border);display:flex;}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text2);font-size:12px;cursor:pointer;}
    .nav-item.active{color:var(--accent);}
    .nav-item .material-icons{font-size:24px;margin-bottom:4px;}

    /* Bottom Sheets */
    .bottom-sheet{position:fixed;bottom:0;left:0;right:0;height:0;background:var(--card);border-top-left-radius:24px;border-top-right-radius:24px;overflow:hidden;transition:height .3s;z-index:100;}
    .bottom-sheet.open{height:85vh;}
    .sheet-header{padding:16px 20px;border-bottom:1px solid var(--border);font-weight:600;display:flex;justify-content:space-between;align-items:center;}
    .sheet-content{padding:20px;overflow-y:auto;height:calc(85vh - 60px);}

    /* Story Viewer */
    #story-viewer{position:fixed;inset:0;background:#000;z-index:200;display:none;flex-direction:column;}
    #story-viewer.active{display:flex;}
    .story-progress-container{position:absolute;top:10px;left:10px;right:10px;display:flex;gap:4px;z-index:10;}
    .story-progress{flex:1;height:4px;background:rgba(255,255,255,0.3);border-radius:2px;overflow:hidden;}
    .story-progress-fill{height:100%;background:#fff;width:0%;transition:none;}
    .story-content{flex:1;display:flex;align-items:center;justify-content:center;position:relative;}
    .story-media{max-width:100%;max-height:100%;object-fit:contain;}
    .story-text{color:#fff;font-size:32px;font-weight:700;text-align:center;padding:40px;line-height:1.4;}
    .story-close{position:absolute;top:16px;right:16px;color:#fff;font-size:32px;cursor:pointer;z-index:20;}

    .alert{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;padding:10px 20px;border-radius:20px;display:none;z-index:1000;}
    .alert.show{display:block;animation:fade .3s;}
    @keyframes fade{from{opacity:0;transform:translate(-50%,-10px)}to{opacity:1;transform:translate(-50%,0)}}

    #create-post-sheet textarea{width:100%;min-height:120px;padding:14px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text);resize:none;font-size:16px;}
    #post-media-preview{max-width:100%;max-height:300px;border-radius:12px;margin:12px 0;display:none;}
  </style>
</head>
<body data-theme="light">

  <header id="header">
    <h1>Vynix</h1>
    <img id="me-avatar" class="w-10 h-10 rounded-full object-cover">
  </header>

  <main class="main">

    <!-- CHATS TAB -->
    <div id="chats" class="tab active">
      <input class="search" placeholder="Search chatsâ€¦" id="search">
      <div id="trivia-card" class="card cursor-pointer">
        <span class="material-icons text-4xl text-accent">favorite</span>
        <div><div class="name">Smart Mental Health Assistant</div><div class="preview">get the best professional help you need</div></div>
        <span class="material-icons ml-auto">arrow_forward</span>
      </div>
      <div id="chat-list"></div>
    </div>

    <!-- POSTS + STORIES TAB -->
    <div id="posts" class="tab">
      <!-- Stories Bar -->
      <div class="stories-bar" id="stories-bar">
        <div class="story-item">
          <div class="story-ring me" id="my-story-ring">
            <img class="story-avatar" id="my-story-avatar">
          </div>
          <div class="story-name">Your Story</div>
        </div>
      </div>

      <!-- Posts Feed -->
      <div id="posts-feed"></div>
      <div style="height:100px;"></div>
    </div>

    <!-- SETTINGS TAB -->
    <div id="settings" class="tab">
      <div class="p-6 space-y-6">
        <div class="bg-card rounded-2xl p-5 border border-border">
          <h2 class="text-xl font-bold mb-4">Appearance</h2>
          <div class="flex justify-between items-center">
            <div><div class="font-semibold">Dark Mode</div><div class="text-sm text-text2">Switch to dark theme</div></div>
            <div class="relative inline-block w-12 h-7 rounded-full bg-gray-300 transition" id="dark-toggle">
              <div class="toggle-slider absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition"></div>
            </div>
          </div>
        </div>
        <button id="logout-btn" class="w-full py-4 bg-red-600 text-white rounded-full font-bold">Log Out</button>
      </div>
    </div>
  </main>

  <!-- FABs -->
  <button id="add-fab" class="fab material-icons">person_add</button>
  <button id="post-fab" class="fab material-icons">post_add</button>
  <button id="story-fab" class="fab material-icons hidden" onclick="document.getElementById('story-sheet').classList.add('open')">photo_camera</button>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats"><span class="material-icons">chat</span>Chats<span id="chat-badge" class="nav-badge">0</span></div>
    <div class="nav-item" data-tab="posts"><span class="material-icons">article</span>Posts</div>
    <div class="nav-item" data-tab="settings"><span class="material-icons">settings</span>Settings</div>
  </nav>

  <!-- Create Post Sheet -->
  <div id="create-post-sheet" class="bottom-sheet">
    <div class="sheet-header"><span class="font-bold">Create Post</span><button id="close-create-post" class="material-icons">close</button></div>
    <div class="sheet-content">
      <textarea id="post-text" placeholder="What's on your mind?"></textarea>
      <img id="post-media-preview">
      <input type="file" id="post-media-input" accept="image/*,video/*" style="display:none;">
      <button id="add-media-btn" class="w-full py-3 border-2 border-dashed rounded-xl mt-3 flex items-center justify-center gap-2 text-accent">
        <span class="material-icons">add_photo_alternate</span>Add Photo/Video
      </button>
      <button id="submit-post" class="w-full bg-accent text-white py-4 rounded-full font-bold mt-4">Post</button>
    </div>
  </div>

  <!-- Create Story Sheet -->
  <div id="story-sheet" class="bottom-sheet">
    <div class="sheet-header"><span class="font-bold">Add to Story</span><button id="close-story-sheet" class="material-icons">close</button></div>
    <div class="sheet-content text-center">
      <button id="story-media-btn" class="w-full py-5 bg-accent text-white rounded-2xl font-bold text-lg">Photo/Video Story</button>
      <input type="file" id="story-media-input" accept="image/*,video/*" style="display:none;">
      <p class="text-text2 mt-4">or</p>
      <button id="story-text-btn" class="w-full py-4 border border-accent text-accent rounded-2xl font-bold mt-3">Text Story</button>
    </div>
  </div>

  <!-- Story Viewer -->
  <div id="story-viewer">
    <div class="story-progress-container" id="story-progress-container"></div>
    <button class="story-close material-icons" id="close-story-viewer">close</button>
    <div class="story-content" id="story-content"></div>
  </div>

  <!-- Comment Sheet -->
  <div id="comment-sheet" class="bottom-sheet">
    <div class="sheet-header"><span class="font-bold">Comments</span><button id="close-comment-sheet" class="material-icons">close</button></div>
    <div class="sheet-content">
      <div id="comments-list"></div>
      <div class="flex items-center border-t pt-4 mt-4">
        <input id="comment-input" class="flex-1 px-4 py-2 border rounded-full" placeholder="Write a comment...">
        <button id="send-comment" class="ml-3 text-accent font-bold">Send</button>
      </div>
    </div>
  </div>

  <div id="alert" class="alert"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js';
    import { getDatabase, ref, onValue, push, set, remove, serverTimestamp, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js';

    // Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const CLOUD_NAME = 'dqkujefxj';
    const UPLOAD_PRESET = 'banter_box';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid = null;
    let currentPostId = null;
    let currentStoryUser = null;
    let currentStoryIndex = 0;
    let storyTimer = null;
    let chatListeners = new Map();

    const toast = (msg) => {
      const a = document.getElementById('alert');
      a.textContent = msg;
      a.classList.add('show');
      setTimeout(() => a.classList.remove('show'), 3000);
    };

    // Tab Navigation
    document.querySelectorAll('.nav-item[data-tab]').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(el.dataset.tab).classList.add('active');

        const isPosts = el.dataset.tab === 'posts';
        document.getElementById('post-fab').style.display = isPosts ? 'grid' : 'none';
        document.getElementById('story-fab').style.display = isPosts ? 'grid' : 'none';
        document.getElementById('add-fab').style.display = el.dataset.tab === 'chats' ? 'grid' : 'none';

        if (isPosts) loadStories();
      });
    });

    // Load Chats
    const loadChats = async () => {
      const list = document.getElementById('chat-list');
      list.innerHTML = '<div class="text-center py-8 text-gray-500">Loading...</div>';

      const followingSnap = (await get(ref(db, `users/${uid}/following`))).val() || {};
      const ids = Object.keys(following);

      if (ids.length === 0) {
        list.innerHTML = '<div class="text-center py-12 text-gray-500">Follow friends to start chatting</div>';
        return;
      }

      list.innerHTML = '';
      chatListeners.forEach(u => u());
      chatListeners.clear();

      for (const id of ids) {
        const [userSnap, chatSnap] = await Promise.all([
          get(ref(db, `users/${id}`)),
          get(ref(db, `users/\( {uid}/chats/ \){id}`))
        ]);

        const user = userSnap.val();
        const chat = chatSnap.val() || {};

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="avatar-wrapper">
            <img class="avatar" src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + user.displayName}">
            <span id="dot-${id}" class="status-dot"></span>
          </div>
          <div class="flex-1">
            <div class="name">${user.displayName || user.email}</div>
            <div id="prev-${id}" class="preview">Tap to chat</div>
            <div id="time-${id}" class="preview-time"></div>
          </div>
          <span id="unread-${id}" class="unread" style="display:none;">0</span>
        `;

        card.onclick = () => location.href = `chat.html?chatId=\( {[uid,id].sort().join('_')}&userId= \){id}`;
        list.appendChild(card);

        // Online status
        const unsub = onValue(ref(db, `users/${id}/status`), s => {
          document.getElementById(`dot-${id}`).classList.toggle('show', s.val() === 'online');
        });
        chatListeners.set(`online-${id}`, unsub);
      }
    };

    // Load Stories
    const loadStories = async () => {
      const bar = document.getElementById('stories-bar');
      bar.innerHTML = `<div class="story-item">
        <div class="story-ring me" id="my-story-ring">
          <img class="story-avatar" id="my-story-avatar">
        </div>
        <div class="story-name">Your Story</div>
      </div>`;

      const snap = await get(ref(db, 'stories'));
      const users = new Set();

      snap.forEach(child => {
        const s = child.val();
        if (Date.now() - s.timestamp < 24*60*60*1000) {
          users.add(s.uid);
        }
      });

      for (const userId of users) {
        const userSnap = await get(ref(db, `users/${userId}`));
        const user = userSnap.val();
        const userStoriesSnap = await get(ref(db, `stories`));
        const hasNew = Array.from(userStoriesSnap.val() || {}).some(s => s.uid === userId && !s.viewedBy?.[uid]);

        const div = document.createElement('div');
        div.className = 'story-item';
        div.innerHTML = `
          <div class="story-ring ${hasNew ? '' : 'opacity-60'}">
            <img class="story-avatar" src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + user.displayName}">
          </div>
          <div class="story-name">${(user.displayName || 'User').split(' ')[0]}</div>
        `;
        div.onclick = () => openStoryViewer(userId);
        bar.appendChild(div);
      }

      document.getElementById('my-story-avatar').src = document.getElementById('me-avatar').src;
      document.getElementById('my-story-ring').onclick = () => document.getElementById('story-sheet').classList.add('open');
    };

    // Story Viewer
    const openStoryViewer = async (userId) => {
      const snap = await get(ref(db, 'stories'));
      const stories = [];
      snap.forEach(child => {
        const s = child.val();
        if (s.uid === userId && Date.now() - s.timestamp < 24*60*60*1000) {
          stories.push({key: child.key, ...s});
        }
      });
      if (stories.length === 0) return;

      stories.sort((a,b) => a.timestamp - b.timestamp);
      currentStoryUser = userId;
      currentStoryIndex = 0;
      showStory(stories);
      document.getElementById('story-viewer').classList.add('active');
    };

    const showStory = async (stories) => {
      const story = stories[currentStoryIndex];
      const user = (await get(ref(db, `users/${currentStoryUser}`))).val();

      const container = document.getElementById('story-progress-container');
      container.innerHTML = '';
      stories.forEach((_, i) => {
        const bar = document.createElement('div');
        bar.className = 'story-progress';
        const fill = document.createElement('div');
        fill.className = 'story-progress-fill';
        fill.style.width = i < currentStoryIndex ? '100%' : '0%';
        bar.appendChild(fill);
        container.appendChild(bar);
      });

      const content = document.getElementById('story-content');
      content.innerHTML = story.media
        ? `<img class="story-media" src="${story.media}">`
        : `<div class="story-text">${story.text}</div>`;

      if (storyTimer) clearInterval(storyTimer);
      const fill = container.children[currentStoryIndex].querySelector('.story-progress-fill');
      let progress = 0;
      storyTimer = setInterval(() => {
        progress += 1;
        fill.style.width = progress + '%';
        if (progress >= 100) {
          clearInterval(storyTimer);
          if (currentStoryIndex < stories.length - 1) {
            currentStoryIndex++;
            showStory(stories);
          } else {
            document.getElementById('story-viewer').classList.remove('active');
          }
        }
      }, 80);

      if (!story.viewedBy?.[uid]) {
        set(ref(db, `stories/\( {story.key}/viewedBy/ \){uid}`), true);
      }
    };

    document.getElementById('close-story-viewer').onclick = () => {
      document.getElementById('story-viewer').classList.remove('active');
      if (storyTimer) clearInterval(storyTimer);
    };

    // Create Story
    document.getElementById('story-media-btn').onclick = () => document.getElementById('story-media-input').click();
    document.getElementById('story-media-input').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);

      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      await push(ref(db, 'stories'), {
        media: data.secure_url,
        uid,
        timestamp: serverTimestamp(),
        viewedBy: {}
      });

      toast('Story added!');
      document.getElementById('story-sheet').classList.remove('open');
      loadStories();
    };

    document.getElementById('story-text-btn').onclick = () => {
      const text = prompt('Enter text for your story:');
      if (text?.trim()) {
        push(ref(db, 'stories'), {text: text.trim(), uid, timestamp: serverTimestamp(), viewedBy: {}});
        toast('Story added!');
        document.getElementById('story-sheet').classList.remove('open');
        loadStories();
      }
    };

    document.getElementById('close-story-sheet').onclick = () => document.getElementById('story-sheet').classList.remove('open');

    // Load Posts (Permanent)
    const loadPosts = () => {
      const feed = document.getElementById('posts-feed');
      onValue(ref(db, 'posts'), async (snap) => {
        const posts = [];
        snap.forEach(c => posts.push({id: c.key, ...c.val()}));
        posts.sort((a,b) => b.timestamp - a.timestamp);

        feed.innerHTML = posts.length === 0 ? '<div class="text-center py-16 text-gray-500">No posts yet. Be the first!</div>' : '';

        for (const p of posts) {
          const user = (await get(ref(db, `users/${p.uid}`))).val() || {displayName:'User', photoURL:''};

          const el = document.createElement('div');
          el.className = 'post-card';
          el.innerHTML = `
            <div class="post-header">
              <img class="post-avatar" src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + user.displayName}">
              <div><div class="post-name">\( {user.displayName}</div><div class="post-time"> \){formatTime(p.timestamp)}</div></div>
            </div>
            <div class="post-text">${p.text || ''}</div>
            \( {p.media ? `<img class="post-media" src=" \){p.media}">` : ''}
            <div class="post-actions">
              <button class="action-btn \( {p.likes?.[uid] ? 'liked' : ''}" data-id=" \){p.id}">
                <span class="material-icons">${p.likes?.[uid] ? 'favorite' : 'favorite_border'}</span>
                ${Object.keys(p.likes || {}).length || ''}
              </button>
              <button class="action-btn" data-id="${p.id}">
                <span class="material-icons">comment</span>
                ${Object.keys(p.comments || {}).length || ''}
              </button>
              <button class="action-btn \( {p.reposts?.[uid] ? 'reposted' : ''}" data-id=" \){p.id}">
                <span class="material-icons">repeat</span>Repost
              </button>
            </div>
          `;

          el.querySelector('[data-id]:nth-child(1)').onclick = () => {
            const r = ref(db, `posts/\( {p.id}/likes/ \){uid}`);
            get(r).then(s => s.exists() ? remove(r) : set(r, true));
          };

          el.querySelector('[data-id]:nth-child(2)').onclick = () => {
            currentPostId = p.id;
            document.getElementById('comment-sheet').classList.add('open');
            loadComments(p.id);
          };

          el.querySelector('[data-id]:nth-child(3)').onclick = async () => {
            if (p.reposts?.[uid]) return toast('Already reposted');
            const newRef = push(ref(db, 'posts'));
            await set(newRef, {text: p.text, media: p.media, uid, timestamp: serverTimestamp(), originalPostId: p.id});
            await set(ref(db, `posts/\( {p.id}/reposts/ \){uid}`), true);
            toast('Reposted!');
          };

          feed.appendChild(el);
        }
      });
    };

    const formatTime = (ts) => {
      const d = Date.now() - ts;
      const m = Math.floor(d / 60000);
      if (m < 60) return m + 'm';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'h';
      return Math.floor(h/24) + 'd';
    };

    // Comments
    const loadComments = (postId) => {
      const list = document.getElementById('comments-list');
      onValue(ref(db, `posts/${postId}/comments`), async (snap) => {
        list.innerHTML = '';
        const comments = [];
        snap.forEach(c => comments.push({id: c.key, ...c.val()}));
        comments.sort((a,b) => a.timestamp - b.timestamp);
        for (const c of comments) {
          const u = (await get(ref(db, `users/${c.uid}`))).val() || {};
          const div = document.createElement('div');
          div.className = 'flex gap-3 py-3 border-b border-border last:border-0';
          div.innerHTML = `
            <img class="w-10 h-10 rounded-full" src="${u.photoURL || ''}">
            <div><div class="font-bold text-sm">\( {u.displayName || 'User'}</div><div> \){c.text}</div></div>
          `;
          list.appendChild(div);
        }
      });
    };

    document.getElementById('send-comment').onclick = () => {
      const text = document.getElementById('comment-input').value.trim();
      if (!text || !currentPostId) return;
      push(ref(db, `posts/${currentPostId}/comments`), {text, uid, timestamp: serverTimestamp()});
      document.getElementById('comment-input').value = '';
    };

    document.getElementById('close-comment-sheet').onclick = () => document.getElementById('comment-sheet').classList.remove('open');

    // Create Post (Cloudinary)
    document.getElementById('post-fab').onclick = () => document.getElementById('create-post-sheet').classList.add('open');
    document.getElementById('close-create-post').onclick = () => document.getElementById('create-post-sheet').classList.remove('open');
    document.getElementById('add-media-btn').onclick = () => document.getElementById('post-media-input').click();

    document.getElementById('post-media-input').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('post-media-preview').src = URL.createObjectURL(file);
        document.getElementById('post-media-preview').style.display = 'block';
      }
    };

    document.getElementById('submit-post').onclick = async () => {
      const text = document.getElementById('post-text').value.trim();
      if (!text) return toast('Write something');

      let mediaUrl = null;
      const file = document.getElementById('post-media-input').files[0];
      if (file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: formData});
        const data = await res.json();
        mediaUrl = data.secure_url;
      }

      await push(ref(db, 'posts'), {
        text, media: mediaUrl, uid,
        timestamp: serverTimestamp(),
        likes: {}, comments: {}, reposts: {}
      });

      toast('Posted!');
      document.getElementById('create-post-sheet').classList.remove('open');
      document.getElementById('post-text').value = '';
      document.getElementById('post-media-preview').style.display = 'none';
      document.getElementById('post-media-input').value = '';
    };

    // Dark Mode
    document.getElementById('dark-toggle').onclick = () => {
      const isDark = document.body.dataset.theme === 'dark';
      document.body.dataset.theme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', document.body.dataset.theme);
    };
    if (localStorage.getItem('theme') === 'dark') document.body.dataset.theme = 'dark';

    // Logout
    document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.href = 'login.html');

    // Init
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = 'login.html';
      uid = user.uid;
      document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=ff2a6d&color=fff`;
      document.getElementById('my-story-avatar').src = document.getElementById('me-avatar').src;

      loadChats();
      loadPosts();
      loadStories();
    });
  </script>
</body>
</html>
