<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="white-translucent">
  <meta name="theme-color" content="#ffffff">
  <title>Vynix Lingua</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  
  <style>
    :root {
      --bg-color: #ffffff;
      --surface-color: #f4f6f8;
      --text-primary: #1a1a1a;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --logo-gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 100%);
      --input-bg: #f0f2f5;
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.06);
      --font-main: 'Outfit', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--surface-color); 
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: row; 
      overflow: hidden;
      user-select: none;
    }
    
    /* --- HISTORY SIDEBAR / DRAWER --- */
    #historySidebar {
      width: 0; 
      background: var(--bg-color);
      border-right: 1px solid rgba(0,0,0,0.05);
      overflow-y: auto;
      transition: width 0.3s ease, transform 0.3s ease;
      z-index: 50;
      flex-shrink: 0;
      position: fixed; 
      top: 0; bottom: 0; left: 0;
      transform: translateX(-100%);
    }
    #historySidebar.open {
      width: 80%; 
      max-width: 320px;
      transform: translateX(0);
      box-shadow: 4px 0 15px rgba(0,0,0,0.15);
    }
    .history-header {
      padding: 20px 15px;
      font-size: 1.2rem;
      font-weight: 700;
      border-bottom: 1px solid #e0e0e0;
      display: flex; align-items: center; justify-content: space-between;
    }
    #historyList {
        padding-bottom: 20px;
    }
    .history-item {
      padding: 12px 15px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-radius: 0 50px 50px 0;
      margin-right: 15px;
      margin-top: 5px;
      transition: all 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .history-item:hover, .history-item.active {
      background: var(--surface-color);
      color: var(--text-primary);
    }
    .history-item.active {
        font-weight: 500;
        background: #e0f2fe; 
    }

    /* --- MAIN CHAT CONTAINER --- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-color); 
      min-width: 0;
      transition: margin-left 0.3s ease;
    }

    /* --- Header (Mobile & Desktop) --- */
    .header {
      height: 64px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      z-index: 10;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .menu-btn {
        margin-right: 15px;
        background: none; border: none; font-size: 24px; cursor: pointer;
        color: var(--text-primary); padding: 5px;
    }
    .vynix-logo {
      display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px 10px; border-radius: 12px;
    }
    .vynix-logo:active { transform: scale(0.96); }
    .logo-icon {
      font-size: 26px; background: var(--logo-gradient); -webkit-background-clip: text;
      -webkit-text-fill-color: transparent; font-variation-settings: 'FILL' 1, 'wght' 600;
    }
    .logo-text { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; color: #1a1a1a; }

    /* --- Chat Area --- */
    .chat-container {
      flex: 1; overflow-y: auto; padding: 20px 0 160px 0; display: flex; flex-direction: column; scroll-behavior: smooth;
      max-width: 800px; width: 100%; margin: 0 auto;
    }
    .welcome-screen {
      flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; padding: 40px; animation: fadeIn 0.5s ease;
    }
    .welcome-icon {
      font-size: 64px; background: var(--logo-gradient); -webkit-background-clip: text;
      -webkit-text-fill-color: transparent; margin-bottom: 24px; font-variation-settings: 'wght' 200;
    }
    #install-pill-container {
      margin-bottom: 20px; display: none; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .install-pill-btn {
      background: var(--logo-gradient); color: white; border: none; padding: 10px 24px; border-radius: 50px;
      font-family: var(--font-main); font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;
      cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: transform 0.2s, box-shadow 0.2s;
    }
    .install-pill-btn:active { transform: scale(0.95); }
    .install-pill-btn span { font-size: 18px; }
    .welcome-text { font-size: 32px; font-weight: 600; margin-bottom: 12px; }
    .welcome-sub { color: var(--text-muted); font-size: 16px; max-width: 300px; line-height: 1.5; }

    /* Messages */
    .message-row {
      display: flex; flex-direction: column; padding: 10px 20px; max-width: 900px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease forwards;
    }
    .message-bubble-container { display: flex; gap: 12px; }
    .message-row.user .message-bubble-container { justify-content: flex-end; }
    .avatar {
      width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; margin-top: 4px;
    }
    .avatar.ai { background: white; border: 1px solid #e0e0e0; }
    .avatar.ai span {
      background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
      font-size: 20px; font-variation-settings: 'FILL' 1;
    }
    .message-content { max-width: 85%; line-height: 1.6; font-size: 16px; word-wrap: break-word; }
    .message-row.ai .message-content { color: var(--text-primary); padding-top: 6px; }
    .message-row.user .message-content {
      background: var(--surface-color); color: var(--text-primary);
      padding: 12px 18px; border-radius: 20px 20px 4px 20px;
    }
    .message-content pre {
      background: #1e1e1e; color: #e0e0e0; padding: 15px; border-radius: 12px; overflow-x: auto; 
      font-family: var(--font-mono); font-size: 13px; margin-top: 10px;
    }
    .copy-actions { margin-left: 44px; margin-top: 4px; }
    .copy-btn {
      background: none; border: none; display: flex; align-items: center; gap: 4px; color: var(--text-muted); 
      font-size: 12px; cursor: pointer; padding: 4px 0;
    }
    
    /* Input Area */
    .input-wrapper-fixed {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 30;
      background: var(--bg-color);
      padding: 12px max(20px, env(safe-area-inset-left)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-right));
      box-shadow: 0 -2px 10px rgba(0,0,0,0.04);
      display: flex; flex-direction: column; align-items: center;
    }
    .input-wrapper {
      width: 100%; background: var(--input-bg); border-radius: 28px; padding: 6px;
      display: flex; align-items: center; transition: background 0.2s; max-width: 800px;
    }
    .input-wrapper:focus-within { background: white; outline: 1px solid #e0e0e0; box-shadow: var(--shadow-soft); }
    input {
      flex: 1; border: none; background: none; outline: none; font-size: 16px; font-family: var(--font-main); 
      color: var(--text-primary); padding: 12px 14px; user-select: text;
    }
    .mic-btn, .send-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none; background: transparent; color: var(--text-muted); 
      cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;
    }
    .mic-btn.listening { color: #dc2626; background: rgba(220, 38, 38, 0.1); animation: pulse-red 1.5s infinite; }
    .send-btn.active { background: var(--text-primary); color: white; }
    .send-btn span { font-size: 22px; margin-left: 2px; }

    .disclaimer { font-size: 11px; color: var(--text-muted); margin-top: 8px; text-align: center; opacity: 0.8; }
    
    /* Loading States */
    .thinking { display: flex; gap: 5px; padding: 10px 0; }
    .dot { width: 5px; height: 5px; background: #9aa0a6; border-radius: 50%; animation: pulse 1s infinite alternate; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { to { opacity: 0.3; transform: translateY(-2px); } }

    /* --- RESPONSIVE LAYOUT (Desktop Sidebar) --- */
    @media (min-width: 768px) {
        #historySidebar {
            width: 280px; 
            position: static;
            transform: translateX(0);
            box-shadow: none;
        }
        .main-content {
            flex-grow: 1;
        }
        .header {
            justify-content: flex-start;
        }
        .menu-btn {
            display: none; 
        }
        #closeSidebarBtn {
             display: none !important;
        }
    }
  </style>
</head>
<body>

  <div class="ios-modal" id="iosModal" onclick="closeIosModal()">
    <div class="ios-card" onclick="event.stopPropagation()">
      <div class="material-symbols-rounded" style="font-size:40px; color:#000; margin-bottom:10px;">ios_share</div>
      <h3 style="margin:0 0 10px 0; font-size:18px;">Install Vynix Lingua</h3>
      <p style="font-size:14px; color:#666; margin-bottom:20px;">Install app to your home screen for the best experience.</p>
      <div class="ios-step"><span class="material-symbols-rounded ios-icon">ios_share</span><span>1. Tap the <strong>Share</strong> button on the toolbar.</span></div>
      <div class="ios-step"><span class="material-symbols-rounded ios-icon" style="color:#000">add_box</span><span>2. Select <strong>Add to Home Screen</strong>.</span></div>
      <button style="margin-top:20px; width:100%; padding:12px; border:none; background:#f0f2f5; color:#007aff; font-weight:600; border-radius:12px; font-size:16px;" onclick="closeIosModal()">Got it</button>
    </div>
  </div>

  <nav id="historySidebar">
    <div class="history-header">
        Conversations
        <button id="closeSidebarBtn" class="menu-btn" style="display: none;">
            <span class="material-symbols-rounded">close</span>
        </button>
    </div>
    <div id="historyList">
        <div class="history-item active" id="new-chat-btn" data-id="new">
             <span class="material-symbols-rounded" style="font-size:16px;">add</span> New Chat
        </div>
        <p style="padding:15px; font-size:12px; color:var(--text-muted);">Loading history...</p>
    </div>
  </nav>

  <div class="main-content">
    <header class="header">
      <button class="menu-btn" id="openSidebarBtn">
          <span class="material-symbols-rounded">menu</span>
      </button>
      <div class="vynix-logo" onclick="location.reload()">
        <span class="material-symbols-rounded logo-icon">language</span>
        <span class="logo-text">Vynix Lingua</span>
      </div>
    </header>

    <main class="chat-container" id="chatContainer">
      <div class="welcome-screen" id="welcomeScreen">
        <div class="material-symbols-rounded welcome-icon">language</div>

        <div id="install-pill-container">
          <button id="install-pill-btn" class="install-pill-btn">
            <span class="material-symbols-rounded">download</span>
            Install App
          </button>
        </div>

        <div class="welcome-text">Molo! Unjani?</div>
        <div class="welcome-sub">I'm Vynix Lingua, your **Multilingual Assistant** for all 11 official SA languages. Ask me to translate, simplify a contract, or draft a formal letter!</div>
      </div>
      <div id="messagesList"></div>
    </main>

    <div class="input-wrapper-fixed">
      <div class="input-wrapper">
        <button class="mic-btn" id="micBtn">
          <span class="material-symbols-rounded">mic</span>
        </button>
        <input type="text" id="input" placeholder="Message Vynix Lingua..." autocomplete="off">
        <button class="send-btn" id="sendBtn">
          <span class="material-symbols-rounded">arrow_upward</span>
        </button>
      </div>
      <p class="disclaimer">Vynix Lingua can make mistakes. Check important info. **Chat history is encrypted and saved.**</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, set, update, onValue, push } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    /* --- CONFIGURATION --- */
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com", // Ensure your Realtime DB URL is here
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    /* --- STATE & CONSTANTS --- */
    let currentUser = null;
    let currentChatId = null; 
    let historyStack = [];
    const ENCRYPTION_SECRET = "VYNIX_LINGUA_SA_2025_KEY"; // VULNERABLE, FOR DEMO ONLY

    const systemInstructions = `
      You are Vynix Lingua, the ultimate Multilingual South African Assistant. Your primary goal is to break down language barriers across all 11 official languages of South Africa (English, Afrikaans, isiZulu, isiXhosa, Sepedi, Sesotho, Setswana, Xitsonga, Tshivenda, isiNdebele, SiSwati).
      Instructions:
      1. Translate and simplify complex documents (legal, medical, financial) into the user's requested home language.
      2. Maintain high fluency and cultural sensitivity in all languages, understanding and using code-switching naturally.
      3. Assist with practical, real-life tasks like drafting formal letters, generating invoices, or explaining municipal processes.
      4. Crucial Safety Rule: Do not engage in or assist with any vulgar, harmful, or criminal activity.
      5. Use a warm, respectful, and highly competent tone. Use Markdown for formatting.
    `;
    
    // --- ENCRYPTION/DECRYPTION FUNCTIONS ---
    function encrypt(text) {
        if (!text) return null;
        return CryptoJS.AES.encrypt(text, ENCRYPTION_SECRET).toString();
    }
    function decrypt(ciphertext) {
        if (!ciphertext) return null;
        try {
            const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_SECRET);
            return bytes.toString(CryptoJS.enc.Utf8);
        } catch (e) {
            console.error("Decryption failed:", e);
            return "Decryption Error: Could not load message.";
        }
    }

    /* --- FIREBASE AUTH & INIT --- */
    async function initializeAppAndAuth() {
        try {
            await fetchAndActivate(rc);
            const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";
            window.XAI_KEY = XAI_KEY; // Make the key globally available for sendMessage

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    newChatSession();
                    loadHistory(); // Start listening to history updates
                } else {
                    signInAnonymously(auth).catch(e => console.error("Anon Auth Failed:", e));
                }
            });
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }
    }
    initializeAppAndAuth();

    /* --- CHAT HISTORY (REALTIME DB) --- */

    function newChatSession() {
        currentChatId = null; // New chats start with null ID
        historyStack = [{ role: "system", content: systemInstructions }];
        $list.innerHTML = '';
        $welcome.style.display = 'flex';
        document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
        $('#new-chat-btn').classList.add('active');
        closeSidebar(); 
    }

    // --- SAVE TO REALTIME DB ---
    async function saveConversation(userMsg, aiReply) {
        if (!currentUser) return;

        const userMsgObj = { role: "user", content: userMsg };
        const aiReplyObj = { role: "assistant", content: aiReply };
        
        // Encrypt the new messages
        const encryptedUserMsg = encrypt(JSON.stringify(userMsgObj));
        const encryptedAiReply = encrypt(JSON.stringify(aiReplyObj));

        if (!currentChatId) {
            // New chat: Push a new entry to the user's chat list
            const newChatRef = push(ref(db, `chats/${currentUser.uid}`));
            currentChatId = newChatRef.key;
            
            const historyTitle = userMsg.substring(0, 30) + '...';
            const newChatData = {
                title: encrypt(historyTitle), 
                createdAt: Date.now(),
                messages: [encryptedUserMsg, encryptedAiReply]
            };
            
            await set(newChatRef, newChatData);

        } else {
            // Existing chat: Append the new messages
            const chatRef = ref(db, `chats/${currentUser.uid}/${currentChatId}`);
            
            // Fetch existing messages, append new ones, and update the whole array (RTDB standard practice)
            const snapshot = await get(chatRef);
            if (snapshot.exists()) {
                const existingData = snapshot.val();
                const existingMessages = existingData.messages || [];
                const updatedMessages = [...existingMessages, encryptedUserMsg, encryptedAiReply];
                
                await update(chatRef, { messages: updatedMessages });
            }
        }
    }

    // --- LOAD HISTORY (REALTIME LISTENER) ---
    function loadHistory() {
        if (!currentUser) return;
        const chatsRef = ref(db, `chats/${currentUser.uid}`);
        
        onValue(chatsRef, (snapshot) => {
            const historyList = $('#historyList');
            // Preserve the 'New Chat' button
            historyList.innerHTML = `<div class="history-item active" id="new-chat-btn" data-id="new"><span class="material-symbols-rounded" style="font-size:16px;">add</span> New Chat</div>`;
            $('#new-chat-btn').addEventListener('click', newChatSession);

            if (snapshot.exists()) {
                const chats = snapshot.val();
                // Convert object to array for sorting by creation time
                const sortedChats = Object.keys(chats).map(key => ({
                    id: key,
                    ...chats[key]
                })).sort((a, b) => b.createdAt - a.createdAt); // Sort newest first

                sortedChats.forEach((chat) => {
                    const decryptedTitle = decrypt(chat.title) || "Untitled Chat";
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.textContent = decryptedTitle;
                    item.dataset.id = chat.id;
                    item.addEventListener('click', () => loadConversation(chat.id));
                    historyList.appendChild(item);
                    
                    // Re-apply active class to the current chat if it exists
                    if (chat.id === currentChatId) {
                        document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                    }
                });
            }
        });
    }

    // --- LOAD SINGLE CONVERSATION ---
    async function loadConversation(chatId) {
        if (currentChatId === chatId) return;

        currentChatId = chatId;
        $list.innerHTML = '';
        $welcome.style.display = 'none';

        // Update active class in sidebar
        document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`[data-id="${chatId}"]`).classList.add('active');
        
        closeSidebar(); 

        try {
            const chatRef = ref(db, `chats/${currentUser.uid}/${chatId}`);
            const snapshot = await get(chatRef);
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                const encryptedMessages = data.messages || [];
                historyStack = [{ role: "system", content: systemInstructions }]; // Start with System Prompt
                
                encryptedMessages.forEach(encMsg => {
                    const decryptedMsgStr = decrypt(encMsg);
                    try {
                        const msg = JSON.parse(decryptedMsgStr);
                        historyStack.push(msg);
                        addMessage(msg.content, msg.role); // Display user/assistant messages
                    } catch (e) {
                        console.error("Error parsing decrypted message:", e);
                    }
                });
            } else {
                addMessage("Chat not found or access denied.", 'ai');
                newChatSession(); 
            }
        } catch (e) {
            console.error("Error fetching conversation:", e);
            addMessage("An error occurred loading the conversation.", 'ai');
        }
    }

    /* --- SELECTORS, LAYOUT, AND UTILITIES --- */
    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn'), $mic = $('#micBtn'), $list = $('#messagesList'), $welcome = $('#welcomeScreen');
    const historySidebar = $('#historySidebar');
    const openSidebarBtn = $('#openSidebarBtn');
    const closeSidebarBtn = $('#closeSidebarBtn');
    
    // Layout Logic (Responsive Sidebar/Drawer)
    function openSidebar() {
        historySidebar.classList.add('open');
        openSidebarBtn.style.display = 'none';
        closeSidebarBtn.style.display = 'block';
    }
    function closeSidebar() {
        historySidebar.classList.remove('open');
        openSidebarBtn.style.display = 'block';
        closeSidebarBtn.style.display = 'none';
    }
    openSidebarBtn.addEventListener('click', openSidebar);
    closeSidebarBtn.addEventListener('click', closeSidebar);
    
    // Auto-hide/show menu buttons based on screen size
    function handleResize() {
        const isDesktop = window.innerWidth >= 768;
        if (isDesktop) {
            closeSidebarBtn.style.display = 'none';
            openSidebarBtn.style.display = 'none';
        } else {
            const isOpen = historySidebar.classList.contains('open');
            openSidebarBtn.style.display = isOpen ? 'none' : 'block';
            closeSidebarBtn.style.display = isOpen ? 'block' : 'none';
        }
    }
    window.addEventListener('resize', handleResize);
    handleResize();

    // Markdown Parser
    function parseMarkdown(text) {
      return text
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\s*-\s+(.*)/gm, 'â€¢ $1<br>')
        .replace(/\n/g, '<br>');
    }
    
    // UI Message Adder
    function addMessage(text, type) {
      $welcome.style.display = 'none';
      const div = document.createElement('div');
      div.className = `message-row ${type}`;
      const avatarHTML = type === 'ai' ? `<div class="avatar ai"><span class="material-symbols-rounded">language</span></div>` : '';
      let html = `<div class="message-bubble-container">${avatarHTML}<div class="message-content">${parseMarkdown(text)}</div></div>`;
      
      if (type === 'ai') {
        const id = 'copy-' + Date.now();
        html += `<div class="copy-actions"><button class="copy-btn" id="${id}"><span class="material-symbols-rounded">content_copy</span> Copy</button></div>`;
        div.innerHTML = html; $list.appendChild(div);
        $(`#${id}`).addEventListener('click', () => {
           navigator.clipboard.writeText(text);
           $(`#${id} span`).innerText = 'check';
           setTimeout(()=> $(`#${id} span`).innerText = 'content_copy', 2000);
        });
      } else { div.innerHTML = html; $list.appendChild(div); }
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function addImage(url, prompt) {
      $welcome.style.display = 'none';
      const div = document.createElement('div'); div.className = 'message-row ai';
      div.innerHTML = `<div class="message-bubble-container"><div class="avatar ai"><span class="material-symbols-rounded">brush</span></div>
        <div class="message-content"><p style="margin:0"><strong>Image Generated!</strong></p><p style="font-size:14px;color:var(--text-muted)">Prompt: ${prompt}</p>
        <img src="${url}" style="max-width:100%;border-radius:12px;margin-top:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1)" onload="this.scrollIntoView({behavior:'smooth'})"></div></div>`;
      $list.appendChild(div);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function addLoading() {
      const div = document.createElement('div'); div.id = 'loading'; div.className = 'message-row ai';
      div.innerHTML = `<div class="message-bubble-container"><div class="avatar ai"><span class="material-symbols-rounded">language</span></div><div class="message-content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>`;
      $list.appendChild(div); $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }
    function removeLoading() { if($('#loading')) $('#loading').remove(); }

    /* --- PWA LOGIC --- */
    const installContainer = $('#install-pill-container');
    const installBtn = $('#install-pill-btn');
    const iosModal = $('#iosModal');
    let deferredPrompt = null;
    const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e; installContainer.style.display = 'block'; 
    });
    if (isIos && !isStandalone) {
      installContainer.style.display = 'block'; 
    }
    installBtn.addEventListener('click', async () => {
      if (isIos) { iosModal.classList.add('open');
      } else if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') { installContainer.style.display = 'none'; }
        deferredPrompt = null;
      }
    });
    window.closeIosModal = () => iosModal.classList.remove('open');

    /* --- MAIN SEND MESSAGE FUNCTION --- */
    window.sendMessage = async () => {
      if (!currentUser) { addMessage("Please wait, connecting to the database...", 'ai'); return; }
      const msg = $i.value.trim(); if (!msg) return;
      
      $i.value = ''; $send.classList.remove('active');
      addMessage(msg, 'user');
      
      const lower = msg.toLowerCase();
      // Handle Image Generation (No API key needed for this simple call)
      if (lower.includes('generate image') || lower.includes('create an image') || lower.includes('draw')) {
        addLoading();
        const seed = Math.floor(Math.random()*10000);
        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(msg)}?seed=${seed}&nologo=true&width=768&height=768`;
        const reply = "[Image Generated]"; 
        setTimeout(async () => { 
            removeLoading(); addImage(url, msg); 
            // Save to DB
            await saveConversation(msg, reply); 
        }, 1800);
        return;
      }

      addLoading();
      try {
        // --- External API Call (Requires XAI_KEY from Remote Config) ---
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST", headers: { "Authorization": `Bearer ${window.XAI_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-4-1-fast-non-reasoning", messages: [...historyStack, { role: "user", content: msg }], temperature: 0.7, max_tokens: 1000 })
        });
        
        removeLoading();
        if (!res.ok) throw new Error("API Error: " + res.status);
        
        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || "No response received.";
        
        // Update UI and DB
        addMessage(reply, 'ai');
        await saveConversation(msg, reply);
        historyStack.push({ role: "user", content: msg }, { role: "assistant", content: reply });
        
      } catch (e) { 
        removeLoading(); 
        const errorMsg = `Connection error. Please check your API key and connection. (${e.message})`;
        addMessage(errorMsg, 'ai'); 
        // Save the failed attempt to the chat history
        await saveConversation(msg, errorMsg); 
      }
    };

    /* --- Input Handlers --- */
    $i.addEventListener('input', () => $send.classList.toggle('active', $i.value.trim().length > 0));
    $i.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    $send.addEventListener('click', sendMessage);

    /* --- Speech --- */
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const r = new SR(); r.lang = 'en-ZA'; r.interimResults = false;
      r.onstart = () => { $mic.classList.add('listening'); $i.placeholder = "Listening..."; };
      r.onresult = e => { $i.value = e.results[0][0].transcript; sendMessage(); };
      r.onend = () => { $mic.classList.remove('listening'); $i.placeholder = "Message Vynix Lingua..."; };
      $mic.onclick = () => r.start();
    } else { $mic.style.display = 'none'; }
  </script>
</body>
</html>
