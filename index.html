<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#ff2a6d">
  <meta name="description" content="Vynix - Connect with friends">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP25hbWU9VnluaXgmYmFja2dyb3VuZD1mZjJhNmQmY29sb3I9ZmZmJnNpemU9MTkyIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP25hbWU9VnluaXgmYmFja2dyb3VuZD1mZjJhNmQmY29sb3I9ZmZmJnNpemU9NTEyIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --bg: #ffffff;
      --card: #f7f9fa;
      --text: #0f1419;
      --text2: #536471;
      --border: #e1e8ed;
      --accent: #ff2a6d;
      --glow: 0 0 10px rgba(255, 42, 109, .35);
      --online-dot: #22c55e;
      --offline-dot: #9ca3af;
    }
    [data-theme="dark"] {
      --bg: #0f1419;
      --card: #1a1f25;
      --text: #ffffff;
      --text2: #8b98a5;
      --border: #2f3336;
      --accent: #ff2a6d;
      --glow: 0 0 10px rgba(255, 42, 109, .35);
      --online-dot: #22c55e;
      --offline-dot: #4b5563;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
      transition: background-color 0.3s ease;
    }
    #header h1 {
      font-weight: 800;
      font-size: 22px;
      letter-spacing: -1px;
      background: linear-gradient(90deg, var(--accent), #05d9e8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .main {
      padding: 64px 16px 80px;
    }
    .tab {
      display: none;
    }
    .tab.active {
      display: block;
    }
    .search {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card);
      color: var(--text);
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    .search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--glow);
    }
    .card, .trivia-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .trivia-card {
      border-color: var(--accent);
      box-shadow: var(--glow);
      cursor: pointer;
    }
    .avatar-wrapper {
      position: relative;
      flex-shrink: 0;
    }
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      background: #05d9e8;
      transition: transform 0.2s ease;
    }
    .avatar:hover {
      transform: scale(1.05);
    }
    .status-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: var(--online-dot);
      border-radius: 50%;
      border: 2px solid var(--bg);
      display: none;
      animation: pulse 2s infinite;
    }
    .status-dot.offline {
      background: var(--offline-dot);
      animation: none;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    .name {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .verified-badge {
      color: var(--accent);
      font-size: 18px !important;
      vertical-align: middle;
      margin-left: 4px;
    }
    .preview {
      font-size: 14px;
      color: var(--text2);
      margin-top: 2px;
    }
    .preview-time {
      font-size: 12px;
      color: var(--text2);
      margin-top: 2px;
    }
    .unread {
      background: var(--accent);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: auto;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--card);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      transition: background-color 0.3s ease;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      color: var(--text2);
      transition: .2s;
      position: relative;
      cursor: pointer;
    }
    .nav-item.active {
      color: var(--accent);
      text-shadow: var(--glow);
    }
    .nav-item .material-icons {
      font-size: 24px;
      margin-bottom: 2px;
      transition: transform 0.2s ease;
    }
    .nav-item:hover .material-icons {
      transform: scale(1.1);
    }
    .nav-badge {
      position: absolute;
      top: 2px;
      right: 8px;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
      display: none;
    }
    .nav-badge.show {
      display: block;
    }
    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      box-shadow: var(--glow);
      display: grid;
      place-items: center;
      z-index: 20;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 42, 109, 0.4);
    }

    /* Permanent Posts Feed */
    .post-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    .post-header {
      padding: 12px 16px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .post-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }
    .post-name {
      font-weight: 600;
      font-size: 15px;
    }
    .post-time {
      font-size: 13px;
      color: var(--text2);
    }
    .post-text {
      padding: 0 16px 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .post-media {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      background: #000;
    }
    .post-actions {
      display: flex;
      justify-content: space-around;
      padding: 8px 16px 12px;
      border-top: 1px solid var(--border);
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text2);
      transition: background 0.2s;
    }
    .action-btn:hover { background: var(--border); }
    .action-btn.liked { color: #ff2a6d; }
    .action-btn.reposted { color: #10b981; }

    .alert {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 1000;
    }
    .alert.show {
      display: block;
      animation: fade .3s;
    }
    @keyframes fade {
      from { opacity: 0; transform: translate(-50%, -10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0;
      background: var(--card);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      overflow: hidden;
      transition: height .3s;
      z-index: 100;
    }
    .bottom-sheet.open {
      height: 75vh;
    }
    .sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .sheet-content {
      padding: 16px 20px;
      height: calc(75vh - 60px);
      overflow-y: auto;
    }
    .pill-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      transition: .2s;
      cursor: pointer;
    }
    .pill-btn.primary {
      background: var(--accent);
      color: #fff;
      box-shadow: var(--glow);
    }
    .pill-btn.secondary {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
    }
    .pill-btn:hover {
      transform: scale(1.02);
    }
  </style>
</head>
<body data-theme="light">

  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-accent text-white p-4 text-center z-50 hidden">
    <div>Install Vynix for a better experience</div>
    <div class="flex justify-center gap-4 mt-2">
      <button id="pwa-install-btn" class="bg-white text-accent px-4 py-1 rounded-full">Install</button>
      <button id="pwa-install-close" class="material-icons">close</button>
    </div>
  </div>

  <div id="offline-indicator" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full hidden items-center gap-2">
    <span class="material-icons text-lg">wifi_off</span> Offline
  </div>

  <header id="header">
    <h1>Vynix</h1>
    <img id="me-avatar" class="w-10 h-10 rounded-full object-cover">
  </header>

  <main class="main">
    <!-- Chats -->
    <div id="chats" class="tab active">
      <input class="search" id="search" placeholder="Search chatsâ€¦">
      <div id="trivia-card" class="trivia-card">
        <span class="material-icons" style="color:#ff2a6d;font-size:32px;">favorite</span>
        <div>
          <div class="name">Smart Mental Health Assistant</div>
          <div class="preview">get the best professional help you need</div>
        </div>
        <span class="material-icons text-accent ml-auto">arrow_forward</span>
      </div>
      <div id="chat-list"></div>
    </div>

    <!-- Posts (was Status) -->
    <div id="posts" class="tab">
      <div id="posts-feed"></div>
      <div style="height:100px;"></div>
    </div>

    <!-- Settings -->
    <div id="settings" class="tab">
      <div class="p-6 space-y-6">
        <div class="bg-[var(--card)] rounded-2xl p-5 border border-[var(--border)]">
          <h2 class="text-xl font-bold mb-4">Appearance</h2>
          <div class="flex justify-between items-center">
            <div>
              <div class="font-semibold">Dark Mode</div>
              <div class="text-sm opacity-70">Switch to dark theme</div>
            </div>
            <div class="toggle-switch" id="dark-mode-toggle">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>
        <button id="logout-btn" class="w-full py-4 bg-red-600 text-white rounded-full font-bold">Log Out</button>
      </div>
    </div>
  </main>

  <button id="add-fab" class="fab material-icons">person_add</button>
  <button id="post-fab" class="fab material-icons">post_add</button>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats">
      <span class="material-icons">chat</span>
      Chats
      <span id="chat-badge" class="nav-badge">0</span>
    </div>
    <a href="ai.html" class="nav-item">
      <span class="material-icons">auto_awesome</span>
      Buddy
    </a>
    <div class="nav-item" data-tab="posts">
      <span class="material-icons">article</span>
      Posts
    </div>
    <div class="nav-item" data-tab="settings">
      <span class="material-icons">settings</span>
      Settings
    </div>
  </nav>

  <!-- Create Post Sheet -->
  <div id="create-post-sheet" class="bottom-sheet">
    <div class="sheet-header">
      <span class="font-semibold">Create Post</span>
      <button id="close-create-post" class="material-icons text-2xl">close</button>
    </div>
    <div class="sheet-content">
      <textarea id="post-text" class="w-full p-3 rounded-xl border border-[var(--border)] bg-[var(--card)] text-[var(--text)]" rows="4" placeholder="What's on your mind?"></textarea>
      <img id="post-media-preview" class="w-full rounded-xl mt-3" style="display:none;">
      <input id="post-media-input" type="file" accept="image/*,video/*" style="display:none;">
      <button id="add-media-btn" class="pill-btn secondary mt-3">
        <span class="material-icons">photo_camera</span>Add Photo/Video
      </button>
      <button>
      <button id="submit-post" class="pill-btn primary mt-3">
        <span class="material-icons">send</span>Post
      </button>
    </div>
  </div>

  <!-- Comment Sheet -->
  <div id="comment-sheet" class="bottom-sheet">
    <div class="sheet-header">
      <span class="font-semibold">Comments</span>
      <button id="close-comment-sheet" class="material-icons text-2xl">close</button>
    </div>
    <div class="sheet-content">
      <div id="comments-list"></div>
      <div class="flex items-center gap-3 mt-4 border-t pt-4">
        <input id="comment-input" class="flex-1 px-4 py-2 border border-[var(--border)] rounded-full bg-[var(--card)]" placeholder="Write a comment...">
        <button id="send-comment" class="text-[var(--accent)] font-bold">Send</button>
      </div>
    </div>
  </div>

  <div id="alert" class="alert"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, onValue, push, set, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const CLOUD_NAME = 'dqkujefxj';
    const UPLOAD_PRESET = 'banter_box';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid = null;
    let currentPostId = null;
    let chatListeners = new Map();

    const toast = (msg) => {
      const alert = document.getElementById('alert');
      alert.textContent = msg;
      alert.classList.add('show');
      setTimeout(() => alert.classList.remove('show'), 3000);
    };

    // Tab Navigation
    document.querySelectorAll('.nav-item[data-tab]').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(el.dataset.tab).classList.add('active');

        document.getElementById('add-fab').style.display = el.dataset.tab === 'chats' ? 'grid' : 'none';
        document.getElementById('post-fab').style.display = el.dataset.tab === 'posts' ? 'grid' : 'none';
      });
    });

    // Load Chats (your original code)
    const loadChats = async () => {
      const list = document.getElementById('chat-list');
      list.innerHTML = '';

      const followingSnap = await get(ref(db, `users/${uid}/following`));
      const following = followingSnap.val() || {};
      const ids = Object.keys(following);

      if (ids.length === 0) {
        list.innerHTML = '<p class="text-center text-[var(--text2)] mt-10">Follow friends to start chatting</p>';
        return;
      }

      chatListeners.forEach(fn => fn());
      chatListeners.clear();

      for (const id of ids) {
        const [userSnap, chatSnap] = await Promise.all([
          get(ref(db, `users/${id}`)),
          get(ref(db, `users/\( {uid}/chats/ \){id}`))
        ]);

        const user = userSnap.val();
        const chat = chatSnap.val() || {};

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="avatar-wrapper">
            <img class="avatar" src="\( {user.photoURL || `https://ui-avatars.com/api/?name= \){user.displayName || 'U'}&background=05d9e8&color=fff`}">
            <span id="dot-${id}" class="status-dot"></span>
          </div>
          <div class="flex-1">
            <div class="name">${user.displayName || user.email}</div>
            <div id="prev-${id}" class="preview">Tap to chat</div>
            <div id="time-${id}" class="preview-time"></div>
          </div>
          <span id="unread-${id}" class="unread" style="display:none;">0</span>
        `;

        card.onclick = () => location.href = `chat.html?chatId=\( {[uid,id].sort().join('_')}&userId= \){id}`;
        list.appendChild(card);

        onValue(ref(db, `users/${id}/status`), (snap) => {
          const dot = document.getElementById(`dot-${id}`);
          if (dot) {
            dot.style.display = 'block';
            dot.classList.toggle('offline', snap.val() !== 'online');
          }
        });
      }
    };

    // Permanent Posts Feed
    const loadPosts = () => {
      const feed = document.getElementById('posts-feed');
      onValue(ref(db, 'posts'), async (snap) => {
        const posts = [];
        snap.forEach(child => posts.push({id: child.key, ...child.val()}));
        posts.sort((a,b) => b.timestamp - a.timestamp);

        feed.innerHTML = posts.length === 0 
          ? '<div class="text-center py-16 text-[var(--text2)]">No posts yet. Be the first!</div>' 
          : '';

        for (const post of posts) {
          const userSnap = await get(ref(db, `users/${post.uid}`));
          const user = userSnap.val() || {displayName: 'User', photoURL: ''};

          const el = document.createElement('div');
          el.className = 'post-card';
          el.innerHTML = `
            <div class="post-header">
              <img class="post-avatar" src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'U')}">
              <div>
                <div class="post-name">${user.displayName || 'User'}</div>
                <div class="post-time">${formatTime(post.timestamp)}</div>
              </div>
            </div>
            <div class="post-text">${post.text || ''}</div>
            \( {post.media ? `<img class="post-media" src=" \){post.media}">` : ''}
            <div class="post-actions">
              <button class="action-btn \( {post.likes?.[uid] ? 'liked' : ''}" data-id=" \){post.id}">
                <span class="material-icons">${post.likes?.[uid] ? 'favorite' : 'favorite_border'}</span>
                ${Object.keys(post.likes || {}).length || ''}
              </button>
              <button class="action-btn" data-id="${post.id}">
                <span class="material-icons">comment</span>
                ${Object.keys(post.comments || {}).length || ''}
              </button>
              <button class="action-btn \( {post.reposts?.[uid] ? 'reposted' : ''}" data-id=" \){post.id}">
                <span class="material-icons">repeat</span>Repost
              </button>
            </div>
          `;

          // Like
          el.querySelector('[data-id]:nth-child(1)').onclick = () => {
            const r = ref(db, `posts/\( {post.id}/likes/ \){uid}`);
            get(r).then(s => s.exists() ? remove(r) : set(r, true));
          };

          // Comment
          el.querySelector('[data-id]:nth-child(2)').onclick = () => {
            currentPostId = post.id;
            document.getElementById('comment-sheet').classList.add('open');
            loadComments(post.id);
          };

          // Repost
          el.querySelector('[data-id]:nth-child(3)').onclick = async () => {
            if (post.reposts?.[uid]) return toast('Already reposted');
            const newRef = push(ref(db, 'posts'));
            await set(newRef, {
              text: post.text,
              media: post.media,
              uid,
              timestamp: serverTimestamp()
            });
            await set(ref(db, `posts/\( {post.id}/reposts/ \){uid}`), true);
            toast('Reposted!');
          };

          feed.appendChild(el);
        }
      });
    };

    const formatTime = (ts) => {
      const diff = Date.now() - ts;
      const minutes = Math.floor(diff / 60000);
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(diff / 3600000);
      if (hours < 24) return `${hours}h ago`;
      return 'Today';
    };

    // Comments
    const loadComments = (postId) => {
      const list = document.getElementById('comments-list');
      onValue(ref(db, `posts/${postId}/comments`), async (snap) => {
        list.innerHTML = '';
        const comments = [];
        snap.forEach(c => comments.push({id: c.key, ...c.val()}));
        comments.sort((a,b) => a.timestamp - b.timestamp);
        for (const c of comments) {
          const u = (await get(ref(db, `users/${c.uid}`))).val() || {};
          list.innerHTML += `
            <div class="flex gap-3 py-3 border-b border-[var(--border)]">
              <img class="w-10 h-10 rounded-full" src="${u.photoURL || ''}">
              <div>
                <div class="font-bold text-sm">${u.displayName || 'User'}</div>
                <div>${c.text}</div>
              </div>
            </div>
          `;
        }
      });
    };

    document.getElementById('send-comment').onclick = () => {
      const text = document.getElementById('comment-input').value.trim();
      if (!text || !currentPostId) return;
      push(ref(db, `posts/${currentPostId}/comments`), {
        text,
        uid,
        timestamp: serverTimestamp()
      });
      document.getElementById('comment-input').value = '';
    };

    document.getElementById('close-comment-sheet').onclick = () => {
      document.getElementById('comment-sheet').classList.remove('open');
    };

    // Create Post with Cloudinary
    document.getElementById('post-fab').onclick = () => document.getElementById('create-post-sheet').classList.add('open');
    document.getElementById('close-create-post').onclick = () => document.getElementById('create-post-sheet').classList.remove('open');
    document.getElementById('add-media-btn').onclick = () => document.getElementById('post-media-input').click();

    document.getElementById('post-media-input').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('post-media-preview').src = URL.createObjectURL(file);
        document.getElementById('post-media-preview').style.display = 'block';
      }
    };

    document.getElementById('submit-post').onclick = async () => {
      const text = document.getElementById('post-text').value.trim();
      if (!text) return toast('Write something');

      let mediaUrl = null;
      const file = document.getElementById('post-media-input').files[0];
      if (file) {
        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', UPLOAD_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        mediaUrl = data.secure_url;
      }

      await push(ref(db, 'posts'), {
        text,
        media: mediaUrl,
        uid,
        timestamp: serverTimestamp(),
        likes: {},
        comments: {},
        reposts: {}
      });

      toast('Posted!');
      document.getElementById('create-post-sheet').classList.remove('open');
      document.getElementById('post-text').value = '';
      document.getElementById('post-media-preview').style.display = 'none';
      document.getElementById('post-media-input').value = '';
    };

    // Dark Mode
    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
      const isDark = document.body.dataset.theme === 'dark';
      document.body.dataset.theme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', document.body.dataset.theme);
    });
    if (localStorage.getItem('theme') === 'dark') {
      document.body.dataset.theme = 'dark';
    }

    // Auth
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = 'login.html';
        return;
      }
      uid = user.uid;

      document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'U')}&background=ff2a6d&color=fff`;

      loadChats();
      loadPosts();
    });
  </script>
</body>
</html>
