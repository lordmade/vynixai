<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="theme-color" content="#d40000">
  <title>BBM 2025 - Reels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-primary: #1a1a1a;
      --text-secondary: #6b7280;
      --border: rgba(0, 0, 0, 0.08);
      --accent: #d40000;
      --bbm-red: #d40000;
      --header-bg: rgba(255, 255, 255, 0.98);
      --chat-bubble-sent: #e6f3ff;
      --chat-bubble-received: #ffffff;
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --glow: 0 0 20px rgba(212, 0, 0, 0.3);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-accent: linear-gradient(135deg, #d40000 0%, #ff6b6b 100%);
    }
    body.dark {
      --bg: radial-gradient(ellipse at bottom, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
      --card-bg: rgba(26, 26, 42, 0.95);
      --text-primary: #f8f9fa;
      --text-secondary: #a0a0a0;
      --border: rgba(255, 255, 255, 0.1);
      --header-bg: rgba(26, 26, 42, 0.98);
      --chat-bubble-sent: rgba(102, 126, 234, 0.2);
      --chat-bubble-received: rgba(26, 26, 42, 0.8);
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
      --glow: 0 0 20px rgba(212, 0, 0, 0.5);
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      line-height: 1.6;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      scroll-snap-type: y mandatory;
      overflow-y: scroll;
      height: 100vh;
      font-size: 16px;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.05"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.05"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
      pointer-events: none;
      z-index: -1;
      opacity: 0.5;
    }
    body.dark::before {
      opacity: 0.2;
    }
    * {
      -webkit-touch-callout: none !important;
      box-sizing: border-box;
    }
    .main-content {
      padding: 0;
      min-height: calc(100vh);
      transition: padding 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .reels-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--header-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px 16px;
      z-index: 50;
      gap: 16px;
      height: 56px;
      box-shadow: var(--shadow-sm);
    }
    .tab-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      min-height: 40px;
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }
    .tab-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .tab-btn:hover::before {
      left: 100%;
    }
    .tab-btn.active {
      background: var(--gradient-accent);
      color: white;
      border-color: transparent;
      box-shadow: var(--glow);
      transform: translateY(-1px);
    }
    .tab-btn.active::before {
      left: 100%;
    }
    .reels-container {
      width: 100%;
      height: 100vh;
      margin-top: 0;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      perspective: 1000px;
    }
    .reels-container::-webkit-scrollbar {
      display: none;
    }
    .reel-item {
      height: 100vh;
      position: relative;
      scroll-snap-align: start;
      background: black;
      overflow: hidden;
      transform-style: preserve-3d;
      transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .reel-item.entered {
      transform: scale(1.02) rotateY(2deg);
    }
    .text-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      z-index: 5;
      max-width: 80%;
      font-size: 28px;
      font-weight: 800;
      text-shadow: 0 4px 8px rgba(0,0,0,0.7);
      line-height: 1.3;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .reel-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
      preload: metadata;
      transition: transform 0.3s ease;
    }
    .reel-video:hover {
      transform: scale(1.02);
    }
    .reel-play-pause {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      color: rgba(255, 255, 255, 0.9);
      z-index: 5;
      pointer-events: none;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(10px);
      border-radius: 50%;
      padding: 20px;
    }
    .reel-play-pause.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1);
    }
    .reel-carousel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .carousel-track {
      display: flex;
      height: 100%;
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      will-change: transform;
    }
    .carousel-track .reel-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }
    .carousel-track .reel-image:hover {
      transform: scale(1.05);
    }
    .carousel-dots {
      position: absolute;
      bottom: 80px;
      left: 20px;
      display: flex;
      gap: 10px;
      z-index: 10;
      pointer-events: auto;
    }
    .carousel-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .carousel-dot::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: var(--bbm-red);
      transition: width 0.3s ease, height 0.3s ease;
    }
    .carousel-dot.active::after {
      width: 20px;
      height: 20px;
    }
    .carousel-dot.active {
      background: transparent;
      transform: scale(1.2);
    }
    .reel-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .reel-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.3) 100%);
    }
    .video-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
      pointer-events: none;
    }
    .video-spinner.active {
      display: flex;
    }
    .reel-header {
      position: absolute;
      bottom: 120px;
      left: 20px;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 16px;
      pointer-events: auto;
      z-index: 10;
      max-width: calc(100% - 100px);
      animation: slideInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s both;
    }
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .reel-user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--gradient-primary);
      color: white;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }
    .reel-user-avatar:hover {
      border-color: var(--bbm-red);
      transform: scale(1.1) rotate(5deg);
    }
    .reel-user-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 70%;
    }
    .reel-username {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
      background: rgba(0,0,0,0.4);
      padding: 8px 12px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    .reel-description {
      font-size: 14px;
      color: white;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 25px;
      padding: 8px 16px;
      backdrop-filter: blur(15px);
      margin-top: 8px;
      max-width: 100%;
      overflow: hidden;
      animation: fadeIn 0.5s ease 0.4s both;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .caption-text {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      display: block;
      word-break: break-word;
    }
    .reel-description.expanded .caption-text {
      -webkit-line-clamp: unset;
    }
    .see-more-btn {
      background: none;
      border: none;
      color: var(--bbm-red);
      cursor: pointer;
      font-size: 12px;
      margin-top: 4px;
      padding: 0;
      display: block;
      opacity: 0.9;
      transition: all 0.2s ease;
      font-weight: 600;
      min-height: 32px;
      display: flex;
      align-items: center;
    }
    .see-more-btn:hover {
      opacity: 1;
      transform: scale(1.05);
    }
    .reel-actions {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 24px;
      pointer-events: auto;
      z-index: 10;
      animation: slideInRight 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s both;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateY(-50%) translateX(30px); }
      to { opacity: 1; transform: translateY(-50%) translateX(0); }
    }
    .action-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 30px;
      width: auto;
      min-width: 48px;
      height: 48px;
      color: white;
      cursor: pointer;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      padding: 0 12px;
      touch-action: manipulation;
      box-shadow: var(--shadow-sm);
    }
    .action-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }
    .action-btn:active::before {
      width: 300px;
      height: 300px;
    }
    .action-btn:hover {
      border-color: var(--bbm-red);
      color: var(--bbm-red);
      transform: scale(1.1) translateY(-3px);
      box-shadow: 0 8px 25px rgba(212, 0, 0, 0.3);
    }
    .action-btn:active {
      transform: scale(0.95) translateY(0);
      transition: transform 0.1s ease;
    }
    .action-btn.liked {
      background: var(--gradient-accent);
      color: white;
      border-color: transparent;
      animation: likePulse 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: var(--glow);
    }
    @keyframes likePulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 0, 0, 0.7); }
      70% { transform: scale(1.2); box-shadow: 0 0 0 20px rgba(212, 0, 0, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 0, 0, 0); }
    }
    .action-icon {
      font-size: 20px;
      font-weight: 400;
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .action-btn:hover .action-icon {
      transform: rotate(15deg) scale(1.1);
    }
    .action-count {
      font-size: 13px;
      font-weight: 700;
      line-height: 1;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }
    .action-btn:hover .action-count {
      opacity: 1;
    }
    .progress-bar {
      position: absolute;
      bottom: 110px;
      left: 20px;
      right: 20px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      overflow: hidden;
      will-change: transform;
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .progress-bar.video-only {
      display: block;
    }
    .progress-fill {
      height: 100%;
      background: var(--gradient-accent);
      width: 0%;
      transition: width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      border-radius: 2px;
      transform-origin: left;
      box-shadow: 0 0 10px var(--bbm-red);
    }
    .fab {
      position: fixed;
      bottom: 30px;
      right: 20px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--gradient-accent);
      border: none;
      color: white;
      font-size: 28px;
      font-weight: 800;
      box-shadow: var(--shadow-md), var(--glow);
      cursor: pointer;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      touch-action: manipulation;
      animation: fabFloat 3s ease-in-out infinite;
    }
    @keyframes fabFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }
    .fab:hover {
      box-shadow: var(--shadow-md), 0 0 50px rgba(212, 0, 0, 0.8);
      transform: scale(1.15) rotate(90deg);
    }
    .fab:active {
      transform: scale(0.95);
    }
    .upload-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top-left-radius: 32px;
      border-top-right-radius: 32px;
      border: 1px solid var(--border);
      max-height: 90vh;
      transform: translateY(100%);
      z-index: 1000;
      overflow-y: auto;
      padding: 24px;
      box-shadow: var(--shadow-md);
      transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(20px);
    }
    .upload-sheet.active {
      transform: translateY(0);
    }
    .upload-sheet-header {
      padding: 0 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .upload-input {
      width: 100%;
      padding: 16px 20px;
      border: 1px solid var(--border);
      border-radius: 25px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .upload-input:focus {
      outline: none;
      border-color: var(--bbm-red);
      box-shadow: 0 0 0 3px rgba(212, 0, 0, 0.1);
      transform: scale(1.02);
    }
    .upload-btn {
      width: 100%;
      background: var(--gradient-accent);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 25px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      min-height: 48px;
      font-size: 16px;
      box-shadow: var(--shadow-md);
    }
    .upload-btn:hover {
      box-shadow: var(--glow);
      transform: translateY(-2px) scale(1.02);
    }
    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top-left-radius: 32px;
      border-top-right-radius: 32px;
      border: 1px solid var(--border);
      max-height: 90vh;
      transform: translateY(100%);
      z-index: 1000;
      overflow-y: auto;
      padding-bottom: 120px;
      box-shadow: var(--shadow-md);
      transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(20px);
    }
    .bottom-sheet.active {
      transform: translateY(0);
    }
    .bottom-sheet-header {
      padding: 20px 24px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      transition: all 0.3s ease;
    }
    .comments-sheet {
      padding: 24px;
      flex: 1;
      overflow-y: auto;
    }
    .comment-input-container {
      padding: 20px 24px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      position: sticky;
      bottom: 0;
    }
    .comment-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      animation: fadeInUp 0.4s ease both;
      transition: background 0.2s ease;
    }
    .comment-item:hover {
      background: rgba(212, 0, 0, 0.05);
      border-radius: 12px;
      padding: 16px;
      margin: 0 -16px;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .reply-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      margin-left: 56px;
      border-left: 3px solid var(--bbm-red);
      padding-left: 16px;
      background: rgba(212, 0, 0, 0.03);
      border-radius: 8px;
      margin: 8px 0;
    }
    .reply-item .comment-avatar {
      width: 36px;
      height: 36px;
      font-size: 14px;
    }
    .reply-item .comment-author {
      font-size: 14px;
    }
    .reply-item .comment-time {
      font-size: 12px;
    }
    .reply-item .comment-text {
      font-size: 14px;
      margin: 0;
      color: var(--text-primary);
    }
    .replies-container {
      margin-left: 56px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .comment-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--gradient-primary);
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      transition: transform 0.2s ease;
      box-shadow: var(--shadow-sm);
    }
    .comment-avatar:hover {
      transform: scale(1.1);
    }
    .comment-avatar img {
      object-fit: cover;
      border-radius: 50%;
    }
    .comment-content {
      flex: 1;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .comment-author {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .reply-btn {
      background: rgba(212, 0, 0, 0.1);
      border: 1px solid var(--bbm-red);
      color: var(--bbm-red);
      font-size: 12px;
      cursor: pointer;
      padding: 6px 12px;
      opacity: 0.8;
      transition: all 0.2s ease;
      border-radius: 15px;
      min-height: 32px;
      display: flex;
      align-items: center;
    }
    .reply-btn:hover {
      opacity: 1;
      background: var(--bbm-red);
      color: white;
      transform: scale(1.05);
    }
    .comment-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .comment-text {
      margin: 0;
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 15px;
    }
    .new-comment-input {
      flex: 1;
      padding: 16px 20px;
      border: 1px solid var(--border);
      border-radius: 25px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.3s ease;
      min-height: 48px;
    }
    .new-comment-input:focus {
      outline: none;
      border-color: var(--bbm-red);
      box-shadow: 0 0 0 3px rgba(212, 0, 0, 0.1);
      transform: scale(1.02);
    }
    .post-comment-btn {
      background: var(--gradient-accent);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      min-width: 70px;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
      min-height: 48px;
      box-shadow: var(--shadow-sm);
    }
    .post-comment-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }
    .post-comment-btn:active::before {
      width: 300px;
      height: 300px;
    }
    .post-comment-btn:hover {
      box-shadow: var(--glow);
      transform: translateY(-2px) scale(1.05);
    }
    .post-comment-btn:active {
      transform: scale(0.98);
      transition: transform 0.1s ease;
    }
    .post-comment-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .no-comments {
      text-align: center;
      color: var(--text-secondary);
      padding: 60px 0;
      font-size: 18px;
      font-style: italic;
      animation: fadeIn 0.5s ease;
    }
    .sheet-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(8px);
    }
    .sheet-backdrop.active {
      opacity: 1;
      visibility: visible;
    }
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(10px);
    }
    .spinner-overlay.active {
      display: flex;
    }
    .spinner {
      display: flex;
      gap: 12px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gradient-accent);
      animation: bounce 1.4s ease-in-out infinite both;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .alert {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gradient-accent);
      color: white;
      padding: 16px 28px;
      border-radius: 30px;
      display: none;
      z-index: 1000;
      box-shadow: var(--shadow-md), var(--glow);
      font-weight: 700;
      font-size: 15px;
      animation: slideDown 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      max-width: 90vw;
      text-align: center;
    }
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .alert.active {
      display: block;
    }
    .verified-icon {
      width: 18px;
      height: 18px;
      margin-left: 6px;
      vertical-align: middle;
      filter: drop-shadow(0 0 2px #1d9bf0);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .upload-progress {
      width: 100%;
      height: 5px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin: 16px 0;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .upload-progress-fill {
      height: 100%;
      background: var(--gradient-accent);
      width: 0%;
      transition: width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 0 10px var(--bbm-red);
    }
    .upload-global-progress {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      z-index: 100;
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .upload-global-progress-fill {
      height: 100%;
      background: var(--gradient-accent);
      width: 0%;
      transition: width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 0 10px var(--bbm-red);
    }
    .edit-controls {
      margin-top: 20px;
      padding: 20px;
      background: rgba(0,0,0,0.05);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }
    .edit-controls label {
      display: block;
      margin-bottom: 12px;
      font-size: 15px;
      font-weight: 600;
    }
    .edit-controls input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      outline: none;
      -webkit-appearance: none;
    }
    .edit-controls input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bbm-red);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }
    .effect-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
    }
    .effect-btn {
      padding: 10px 16px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      border-radius: 25px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s ease;
      min-height: 40px;
      font-weight: 600;
    }
    .effect-btn.active {
      background: var(--gradient-accent);
      color: white;
      border-color: transparent;
      box-shadow: var(--glow);
      transform: scale(1.05);
    }
    .effect-btn:hover {
      background: rgba(212, 0, 0, 0.1);
      border-color: var(--bbm-red);
      transform: translateY(-1px);
    }
    .video-preview-container, .image-preview-container {
      position: relative;
      width: 100%;
      max-height: 300px;
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 20px;
      background: black;
      box-shadow: var(--shadow-md);
    }
    .video-preview-container video, .image-preview-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-carousel {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .image-carousel .carousel-track {
      display: flex;
      height: 100%;
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .image-carousel .carousel-track img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .image-carousel .carousel-dots {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .image-carousel .carousel-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-carousel .carousel-dot.active {
      background: var(--bbm-red);
      transform: scale(1.3);
    }
    #text-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #overlay-span {
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 40px;
      font-family: 'Orbitron', monospace;
      white-space: nowrap;
      font-weight: 700;
      text-shadow: 0 4px 8px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
    }
    .position-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .video-only {
      display: none;
    }
    .image-only {
      display: none;
    }
    .video-upload .video-only {
      display: block;
    }
    .image-upload .image-only {
      display: block;
    }
    .video-upload .image-preview-container {
      display: none;
    }
    .image-upload .video-preview-container {
      display: none;
    }
    @media (min-width: 768px) {
      .reels-header {
        padding: 12px 24px;
        gap: 24px;
      }
      .tab-btn {
        padding: 10px 20px;
        font-size: 16px;
      }
      .reel-header {
        left: 24px;
        bottom: 140px;
      }
      .reel-actions {
        right: 24px;
      }
      .progress-bar {
        left: 24px;
        right: 24px;
      }
      .carousel-dots {
        left: 24px;
      }
      .fab {
        bottom: 30px;
        right: 24px;
        width: 72px;
        height: 72px;
        font-size: 32px;
      }
      .upload-sheet {
        padding: 32px;
      }
      .upload-sheet-header {
        padding: 0 0 24px;
        margin-bottom: 24px;
      }
      .upload-input {
        margin-bottom: 24px;
      }
      .comments-sheet {
        padding: 32px;
      }
      .comment-input-container {
        padding: 32px;
      }
      .comment-item {
        padding: 20px 0;
      }
      .reply-item {
        padding: 16px 0;
      }
      .alert {
        padding: 20px 32px;
        font-size: 16px;
      }
      .edit-controls {
        padding: 24px;
        margin-top: 24px;
      }
      .effect-btn {
        padding: 12px 20px;
        font-size: 14px;
      }
      .video-preview-container, .image-preview-container {
        max-height: 400px;
        margin-bottom: 24px;
      }
      #overlay-span {
        font-size: 50px;
      }
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: radial-gradient(ellipse at bottom, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
        --card-bg: rgba(26, 26, 42, 0.95);
        --text-primary: #f8f9fa;
        --text-secondary: #a0a0a0;
        --border: rgba(255, 255, 255, 0.1);
        --header-bg: rgba(26, 26, 42, 0.98);
      }
      body {
        background: var(--bg);
      }
    }
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    body.dark .skeleton {
      background: linear-gradient(90deg, #2a2a2a 25%, #1a1a1a 50%, #2a2a2a 75%);
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-video {
      width: 100%;
      height: 100vh;
      background: #000;
    }
    .skeleton-header {
      height: 60px;
      width: 80%;
      border-radius: 30px;
      margin: 20px;
    }
    .selected-media-info {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 20px;
      font-size: 15px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <main class="main-content">
    <div class="reels-header">
      <button class="tab-btn active" data-type="video" onclick="switchTab('video')">
        <span class="material-icons" style="font-size: 20px;">videocam</span>Videos
      </button>
      <button class="tab-btn" data-type="image" onclick="switchTab('image')">
        <span class="material-icons" style="font-size: 20px;">image</span>Images
      </button>
      <button class="tab-btn" data-type="text" onclick="switchTab('text')">
        <span class="material-icons" style="font-size: 20px;">text_fields</span>Texts
      </button>
    </div>
    <div id="global-upload-progress" class="upload-global-progress">
      <div id="global-upload-progress-fill" class="upload-global-progress-fill"></div>
    </div>
    <div class="reels-container" id="reels-container">
      <!-- Reels loaded here; initial skeleton -->
      <div class="reel-item skeleton">
        <div class="skeleton-video"></div>
      </div>
      <div class="reel-item skeleton">
        <div class="skeleton-video"></div>
      </div>
    </div>
    <!-- FAB for Upload Media -->
    <button class="fab" id="upload-fab" title="Upload Media" onclick="openUploadSheet()">
      <span class="material-icons">add</span>
    </button>
  </main>
  <!-- Backdrop for sheets -->
  <div id="sheet-backdrop" class="sheet-backdrop" onclick="closeActiveSheet()"></div>
  <!-- Upload Media Sheet -->
  <div id="upload-sheet" class="upload-sheet">
    <div class="upload-sheet-header">
      <h2 style="margin: 0; font-size: 28px; font-weight: 800; color: var(--text-primary); font-family: 'Orbitron', monospace;">Create Reel</h2>
      <button onclick="closeUploadSheet()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 12px; min-height: 44px; display: flex; align-items: center; border-radius: 50%; transition: background 0.2s ease;">
        <span class="material-icons" style="font-size: 24px;">close</span>
      </button>
    </div>
    <input type="file" id="media-input" accept="image/*,video/*" multiple style="display: none;" onchange="handleMediaUpload(event)">
    <p id="upload-info-p" style="text-align: center; color: var(--text-secondary); margin-bottom: 20px; font-size: 15px; font-style: italic;">Select media to upload (video max 60s, image max 10MB recommended)</p>
    <div id="selected-media-info" class="selected-media-info" style="display: none;"></div>
    <button id="choose-media-btn" class="upload-btn" onclick="document.getElementById('media-input').click()">Choose Media</button>
    <div id="upload-progress" class="upload-progress" style="display: none;">
      <div class="upload-progress-fill" id="upload-progress-fill"></div>
    </div>
    <div id="video-preview" class="video-preview-container" style="display: none;">
      <video id="preview-video" controls style="filter: brightness(1) contrast(1) saturate(1) hue-rotate(0deg) blur(0px);"></video>
      <div id="text-overlay">
        <span id="overlay-span"></span>
      </div>
    </div>
    <div id="image-preview" class="image-preview-container" style="display: none;">
      <div id="image-carousel"></div>
      <div id="text-overlay">
        <span id="overlay-span"></span>
      </div>
    </div>
    <div class="video-only" id="video-trim" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; font-size: 15px; color: var(--text-secondary); gap: 12px;">
        <span>Start:</span>
        <input type="range" id="start-trim" min="0" max="60" value="0" step="0.1" style="flex: 1;">
        <span>End:</span>
        <input type="range" id="end-trim" min="0" max="60" value="60" step="0.1" style="flex: 1;">
      </div>
      <p id="duration-display" style="text-align: center; margin-top: 12px; font-weight: 600; font-size: 16px;"></p>
    </div>
    <div id="edit-controls" style="display: none;" class="edit-controls">
      <h3 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 700; font-family: 'Orbitron', monospace;">Enhance Your Reel</h3>
      <div class="video-only" id="speed-section" style="margin-bottom: 20px; display: none;">
        <label style="display: block; margin-bottom: 12px; font-weight: 600;">Playback Speed:</label>
        <select id="speed-select" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card-bg); color: var(--text-primary); font-size: 16px;">
          <option value="0.5">0.5x Slow Mo</option>
          <option value="1" selected>1x Normal</option>
          <option value="1.5">1.5x Fast</option>
          <option value="2">2x Hyper</option>
        </select>
      </div>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <label>Brightness: <input type="range" id="brightness" min="0" max="3" step="0.1" value="1" oninput="updateFilter()"></label>
        <label>Contrast: <input type="range" id="contrast" min="0" max="3" step="0.1" value="1" oninput="updateFilter()"></label>
        <label>Saturation: <input type="range" id="saturation" min="0" max="3" step="0.1" value="1" oninput="updateFilter()"></label>
        <label>Hue Rotate: <input type="range" id="hue-rotate" min="-180" max="180" step="1" value="0" oninput="updateFilter()"></label>
        <label>Blur: <input type="range" id="blur" min="0" max="10" step="0.1" value="0" oninput="updateFilter()"></label>
      </div>
      <h3 style="margin: 24px 0 16px 0; font-size: 20px; font-weight: 700; font-family: 'Orbitron', monospace;">Filter Vibes</h3>
      <div class="effect-buttons">
        <button class="effect-btn active" onclick="applyEffect('normal')">Natural</button>
        <button class="effect-btn" onclick="applyEffect('vintage')">Vintage Glow</button>
        <button class="effect-btn" onclick="applyEffect('sepia')">Warm Sepia</button>
        <button class="effect-btn" onclick="applyEffect('grayscale')">Monochrome</button>
        <button class="effect-btn" onclick="applyEffect('dreamy')">Dreamscape</button>
        <button class="effect-btn" onclick="applyEffect('cool')">Cool Blue</button>
        <button class="effect-btn" onclick="applyEffect('warm')">Sunset Warm</button>
        <button class="effect-btn" onclick="applyEffect('high-contrast')">Bold Contrast</button>
      </div>
      <div style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 20px;">
        <h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 700; font-family: 'Orbitron', monospace;">Text Magic</h3>
        <input type="text" id="overlay-text" placeholder="Type your vibe..." style="width: 100%; padding: 12px 16px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px;" onchange="updateOverlay()">
        <label style="display: block; margin-bottom: 12px;">Size: <input type="range" id="text-size" min="20" max="80" value="40" step="5" style="width: 100%;" oninput="updateOverlay()"></label>
        <label style="display: block; margin-bottom: 12px;">Color: <input type="color" id="text-color" value="#ffffff" style="width: 100%; height: 44px; border-radius: 8px; border: 1px solid var(--border);" oninput="updateOverlay()"></label>
        <div class="position-buttons">
          <button class="effect-btn" onclick="setPosition('top')">Top</button>
          <button class="effect-btn active" onclick="setPosition('center')">Center</button>
          <button class="effect-btn" onclick="setPosition('bottom')">Bottom</button>
        </div>
      </div>
    </div>
    <input type="text" id="caption-input" class="upload-input" placeholder="What's the story? (optional)" style="display: none;">
    <button id="post-upload-btn" class="upload-btn" style="display: none;" onclick="uploadReel()" disabled>Launch Reel</button>
  </div>
  <!-- Comments Bottom Sheet -->
  <div id="comments-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2 style="margin: 0; font-size: 28px; font-weight: 800; color: var(--text-primary); font-family: 'Orbitron', monospace;">Vibes & Chats</h2>
      <button onclick="closeCommentsSheet()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 12px; min-height: 44px; display: flex; align-items: center; border-radius: 50%; transition: background 0.2s ease;">
        <span class="material-icons" style="font-size: 24px;">close</span>
      </button>
    </div>
    <div class="comments-sheet" id="comments-list">
      <!-- Comments loaded here -->
    </div>
    <div class="comment-input-container">
      <div id="replying-indicator" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; color: var(--text-secondary);">
          <span>Replying to <span id="reply-user" style="font-weight: 600; color: var(--text-primary);"></span></span>
          <button onclick="cancelReply()" style="background: none; border: none; color: var(--bbm-red); cursor: pointer; padding: 0; min-height: 32px; display: flex; align-items: center; font-weight: 600;">Cancel</button>
        </div>
      </div>
      <div style="display: flex; gap: 16px; align-items: center;">
        <input type="text" id="new-comment-input" class="new-comment-input" placeholder="Drop your thoughts...">
        <button class="post-comment-btn" onclick="postComment()">Send</button>
      </div>
    </div>
  </div>
  <div id="spinner-overlay" class="spinner-overlay" aria-label="Loading spinner">
    <div class="spinner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>
  <div id="alert-message" class="alert" role="alert" aria-live="polite"></div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, set, push, update } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };
    const cloudinaryConfig = {
      cloudName: 'dqkujefxj',
      uploadPreset: 'banter_box'
    };
    let app, auth, db, currentUser, currentUserData;
    let currentStatusId = null;
    let currentReplyTo = null;
    let currentReplyUser = null;
    let selectedMediaFiles = [];
    let previewUrls = [];
    let isVideoUpload = false;
    let currentPosition = 'center';
    let currentTab = 'video';
    const verifiedIcon = `<span class="material-icons verified-icon">verified</span>`;
    const showSpinner = () => {
      const spinnerOverlay = document.getElementById('spinner-overlay');
      if (spinnerOverlay) spinnerOverlay.classList.add('active');
    };
    const hideSpinner = () => {
      const spinnerOverlay = document.getElementById('spinner-overlay');
      if (spinnerOverlay) spinnerOverlay.classList.remove('active');
    };
    const showAlert = (message) => {
      const alert = document.getElementById('alert-message');
      if (alert) {
        alert.textContent = message;
        alert.classList.add('active');
        setTimeout(() => alert.classList.remove('active'), 4000);
      }
    };
    function buildCloudinaryUrl(baseUrl, transforms = []) {
      if (transforms.length === 0) return baseUrl;
      const transformStr = '/' + transforms.join(',');
      const parts = baseUrl.split('/upload/');
      if (parts.length !== 2) return baseUrl;
      const before = parts[0] + '/upload' + transformStr + '/';
      return before + parts[1];
    }
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHr = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHr / 24);
      if (diffSec < 60) return `${diffSec}s`;
      if (diffMin < 60) return `${diffMin}m`;
      if (diffHr < 24) return `${diffHr}h`;
      return `${diffDay}d`;
    }
    function updateInputUI() {
      const indicator = document.getElementById('replying-indicator');
      const input = document.getElementById('new-comment-input');
      if (currentReplyTo) {
        indicator.style.display = 'block';
        document.getElementById('reply-user').textContent = currentReplyUser;
        input.placeholder = 'Write a reply...';
      } else {
        indicator.style.display = 'none';
        input.placeholder = 'Add a comment...';
      }
    }
    window.setReplyTo = (id, name) => {
      currentReplyTo = id;
      currentReplyUser = name;
      updateInputUI();
      document.getElementById('new-comment-input').focus();
    };
    window.cancelReply = () => {
      currentReplyTo = null;
      currentReplyUser = null;
      updateInputUI();
    };
    function setupCaptionToggle(descriptionEl) {
      const captionText = descriptionEl.querySelector('.caption-text');
      const seeMoreBtn = descriptionEl.querySelector('.see-more-btn');
      if (!captionText || !seeMoreBtn) return;
      const checkOverflow = () => {
        if (captionText.scrollHeight > captionText.clientHeight) {
          seeMoreBtn.style.display = 'block';
        } else {
          seeMoreBtn.style.display = 'none';
        }
      };
      seeMoreBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isExpanded = descriptionEl.classList.contains('expanded');
        if (isExpanded) {
          descriptionEl.classList.remove('expanded');
          seeMoreBtn.textContent = 'see more';
        } else {
          descriptionEl.classList.add('expanded');
          seeMoreBtn.textContent = 'see less';
        }
        setTimeout(checkOverflow, 100);
      });
      checkOverflow();
    }
    function showVideoSpinner(video) {
      const reelItem = video.closest('.reel-item');
      const spinner = reelItem.querySelector('.video-spinner');
      if (spinner) {
        spinner.classList.add('active');
      }
    }
    function hideVideoSpinner(video) {
      const reelItem = video.closest('.reel-item');
      const spinner = reelItem.querySelector('.video-spinner');
      if (spinner) {
        spinner.classList.remove('active');
      }
    }
    function togglePlayPauseIcon(video) {
      const reelItem = video.closest('.reel-item');
      const playPauseIcon = reelItem.querySelector('.reel-play-pause');
      if (playPauseIcon) {
        const icon = video.paused ? 'play_arrow' : 'pause';
        playPauseIcon.innerHTML = `<span class="material-icons">${icon}</span>`;
        playPauseIcon.classList.add('show');
        if (!video.paused) {
          setTimeout(() => {
            if (!video.paused) {
              playPauseIcon.classList.remove('show');
            }
          }, 1500);
        }
      }
    }
    function initReelCarousel(reelItem) {
      const track = reelItem.querySelector('.carousel-track');
      const dots = reelItem.querySelectorAll('.carousel-dot');
      let currentIndex = 0;
      let startX = 0;
      let endX = 0;
      let isDragging = false;
      const total = dots.length;
      function goToSlide(index) {
        currentIndex = index;
        track.style.transform = `translateX(-${index * 100}%)`;
        dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
      }
      track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
        track.style.transition = 'none';
      }, { passive: true });
      track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const currentX = e.touches[0].clientX;
        const diff = startX - currentX;
        track.style.transform = `translateX(calc(-${currentIndex * 100}% + ${diff}px))`;
      }, { passive: true });
      track.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        if (Math.abs(diff) > 50) {
          if (diff > 0 && currentIndex < total - 1) {
            currentIndex++;
          } else if (diff < 0 && currentIndex > 0) {
            currentIndex--;
          }
        }
        goToSlide(currentIndex);
        track.style.transition = 'transform 0.3s ease';
        isDragging = false;
      }, { passive: true });
      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => goToSlide(index));
      });
    }
    function initPreviewCarousel(containerId, files) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const carousel = document.createElement('div');
      carousel.className = 'image-carousel';
      carousel.style.position = 'relative';
      carousel.style.width = '100%';
      carousel.style.height = '100%';
      carousel.style.overflow = 'hidden';
      const track = document.createElement('div');
      track.className = 'carousel-track';
      track.style.display = 'flex';
      track.style.height = '100%';
      track.style.transition = 'transform 0.3s ease';
      files.forEach((file) => {
        const imgDiv = document.createElement('div');
        imgDiv.style.width = '100%';
        imgDiv.style.height = '100%';
        const img = document.createElement('img');
        const url = URL.createObjectURL(file);
        previewUrls.push(url);
        img.src = url;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        imgDiv.appendChild(img);
        track.appendChild(imgDiv);
      });
      carousel.appendChild(track);
      const dotsContainer = document.createElement('div');
      dotsContainer.className = 'carousel-dots';
      dotsContainer.style.position = 'absolute';
      dotsContainer.style.bottom = '10px';
      dotsContainer.style.left = '50%';
      dotsContainer.style.transform = 'translateX(-50%)';
      dotsContainer.style.display = 'flex';
      dotsContainer.style.gap = '5px';
      files.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = 'carousel-dot';
        dot.style.width = '8px';
        dot.style.height = '8px';
        dot.style.borderRadius = '50%';
        dot.style.background = index === 0 ? 'var(--bbm-red)' : 'rgba(255,255,255,0.5)';
        dot.style.cursor = 'pointer';
        dot.style.transition = 'background 0.3s';
        dot.onclick = () => goToPreviewSlide(index, track, files.length);
        dotsContainer.appendChild(dot);
      });
      carousel.appendChild(dotsContainer);
      container.appendChild(carousel);
      let currentIndex = 0;
      function goToPreviewSlide(index, track, total) {
        currentIndex = index;
        track.style.transform = `translateX(-${index * 100}%)`;
        Array.from(dotsContainer.children).forEach((dot, i) => {
          dot.style.background = i === index ? 'var(--bbm-red)' : 'rgba(255,255,255,0.5)';
        });
      }
      let startX = 0;
      let endX = 0;
      let isDragging = false;
      track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
        track.style.transition = 'none';
      }, { passive: true });
      track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const currentX = e.touches[0].clientX;
        const diff = startX - currentX;
        track.style.transform = `translateX(calc(-${currentIndex * 100}% + ${diff}px))`;
      }, { passive: true });
      track.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        if (Math.abs(diff) > 50) {
          if (diff > 0 && currentIndex < files.length - 1) {
            currentIndex++;
          } else if (diff < 0 && currentIndex > 0) {
            currentIndex--;
          }
        }
        goToPreviewSlide(currentIndex, track, files.length);
        track.style.transition = 'transform 0.3s ease';
        isDragging = false;
      }, { passive: true });
    }
    window.switchTab = (type) => {
      if (type === currentTab) return;
      currentTab = type;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      loadReels(type);
    };
    window.navigate = (page) => {
      console.log('Navigate to:', page);
      // Implement navigation logic here
    };
    window.updateFilter = () => {
      const b = parseFloat(document.getElementById('brightness').value);
      const c = parseFloat(document.getElementById('contrast').value);
      const s = parseFloat(document.getElementById('saturation').value);
      const h = parseFloat(document.getElementById('hue-rotate').value);
      const bl = parseFloat(document.getElementById('blur').value);
      const filt = `brightness(${b}) contrast(${c}) saturate(${s}) hue-rotate(${h}deg) blur(${bl}px)`;
      if (isVideoUpload) {
        const previewVideo = document.getElementById('preview-video');
        if (previewVideo) previewVideo.style.filter = filt;
      } else {
        const imgs = document.querySelectorAll('#image-preview .carousel-track img');
        imgs.forEach(img => img.style.filter = filt);
      }
    };
    window.applyEffect = (effect) => {
      const effects = {
        normal: {brightness: 1, contrast: 1, saturation: 1, 'hue-rotate': 0, blur: 0},
        vintage: {brightness: 1.05, contrast: 1.1, saturation: 0.7, 'hue-rotate': 20, blur: 0},
        sepia: {brightness: 1, contrast: 1, saturation: 0, 'hue-rotate': 40, blur: 0},
        grayscale: {brightness: 1, contrast: 1, saturation: 0, 'hue-rotate': 0, blur: 0},
        dreamy: {brightness: 1.2, contrast: 0.9, saturation: 1.3, 'hue-rotate': 0, blur: 1},
        cool: {brightness: 1, contrast: 1.1, saturation: 1, 'hue-rotate': -20, blur: 0},
        warm: {brightness: 1, contrast: 1.1, saturation: 1, 'hue-rotate': 20, blur: 0},
        'high-contrast': {brightness: 1, contrast: 1.5, saturation: 1.2, 'hue-rotate': 0, blur: 0}
      };
      const vals = effects[effect];
      if (vals) {
        document.getElementById('brightness').value = vals.brightness;
        document.getElementById('contrast').value = vals.contrast;
        document.getElementById('saturation').value = vals.saturation;
        document.getElementById('hue-rotate').value = vals['hue-rotate'];
        document.getElementById('blur').value = vals.blur;
        updateFilter();
        document.querySelectorAll('.effect-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      }
    };
    window.updateOverlay = () => {
      const text = document.getElementById('overlay-text').value.trim();
      const size = document.getElementById('text-size').value;
      const color = document.getElementById('text-color').value;
      const overlay = document.getElementById('text-overlay');
      const span = document.getElementById('overlay-span');
      if (text) {
        span.textContent = text;
        span.style.fontSize = size + 'px';
        span.style.color = color;
        overlay.style.display = 'flex';
      } else {
        overlay.style.display = 'none';
      }
    };
    window.setPosition = (pos) => {
      currentPosition = pos;
      const overlay = document.getElementById('text-overlay');
      const align = pos === 'top' ? 'flex-start' : pos === 'bottom' ? 'flex-end' : 'center';
      overlay.style.alignItems = align;
      document.querySelectorAll('.position-buttons .effect-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      updateOverlay();
    };
    async function loadReels(type = 'video') {
      showSpinner();
      const container = document.getElementById('reels-container');
      container.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'reel-item skeleton';
        skeleton.innerHTML = '<div class="skeleton-video"></div>';
        container.appendChild(skeleton);
      }
      if (currentUser) {
        try {
          const statusesRef = ref(db, 'statuses');
          const snapshot = await get(statusesRef);
          let mediaStatuses = [];
          if (snapshot.exists()) {
            Object.entries(snapshot.val()).forEach(([id, s]) => {
              if (s.type === type && (type === 'text' ? !!s.content : true)) {
                if (type !== 'text' && (!s.mediaUrls && !s.mediaUrl)) return;
                mediaStatuses.push({ statusId: id, ...s });
              }
            });
            mediaStatuses = mediaStatuses.sort((a, b) => b.timestamp - a.timestamp).slice(0, 20);
            if (mediaStatuses.length > 0) {
              const mostRecent = mediaStatuses[0];
              const others = mediaStatuses.slice(1);
              others.sort(() => 0.5 - Math.random());
              mediaStatuses = [mostRecent, ...others];
            }
          }
          container.innerHTML = '';
          if (mediaStatuses.length === 0) {
            container.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 60px; font-size: 17px;">No ${type}s yet. Upload the first one!</p>`;
            hideSpinner();
            return;
          }
          const userIds = [...new Set(mediaStatuses.map(s => s.userId))];
          const userPromises = userIds.map(uid => get(ref(db, `users/${uid}`)).then(snap => ({ uid, snap: snap.val() })));
          const userResults = await Promise.all(userPromises);
          const userMap = Object.fromEntries(userResults.map(ur => [ur.uid, ur.snap]));
          mediaStatuses.forEach(status => {
            status.user = userMap[status.userId];
          });
          mediaStatuses.forEach((status, index) => {
            const reelDiv = document.createElement('div');
            reelDiv.className = 'reel-item';
            reelDiv.setAttribute('data-status-id', status.statusId);
            const initial = status.user?.displayName ? status.user.displayName[0].toUpperCase() : 'U';
            let avatarHtml = '';
            if (status.user?.photoURL) {
              avatarHtml = `<img src="${status.user.photoURL}" alt="${status.user?.displayName}" class="reel-user-avatar" loading="lazy">`;
            } else {
              avatarHtml = `<div class="reel-user-avatar" style="font-size: 20px;">${initial}</div>`;
            }
            let nameHtml = status.user?.displayName || 'User';
            if (status.user?.verified) {
              nameHtml += verifiedIcon;
            }
            let descHtml = '';
            if (status.content) {
              descHtml = `<div class="reel-description">
                <span class="caption-text">${status.content.replace(/\n/g, '<br>')}</span>
                <button class="see-more-btn">see more</button>
              </div>`;
            }
            const likesSnap = status.likes || {};
            const likes = Object.keys(likesSnap).length;
            const comments = Object.keys(status.comments || {}).length;
            const isLiked = likesSnap[currentUser.uid];
            const likeIcon = isLiked ? 'favorite' : 'favorite_border';
            const likeClass = isLiked ? 'liked' : '';
            let mediaHtml = '';
            let progressBarHtml = '';
            let mediaElements = [];
            const urls = status.mediaUrls || [status.mediaUrl].filter(Boolean);
            if (type === 'text') {
              mediaHtml = `<div class="text-content">${status.content.replace(/\n/g, '<br>')}</div>`;
            } else if (type === 'video') {
              let transforms = ['h_568,q_auto:eco,f_auto'];
              if (status.textOverlay) {
                transforms.push(status.textOverlay);
              }
              if (status.originalDuration && (status.startTime > 0 || status.endTime < status.originalDuration)) {
                if (status.startTime > 0) transforms.push(`so_${status.startTime}`);
                if (status.endTime < status.originalDuration) transforms.push(`eo_${status.endTime}`);
              }
              const optUrl = buildCloudinaryUrl(urls[0], transforms);
              mediaHtml = `<video src="${optUrl}" class="reel-video" loop playsinline webkit-playsinline preload="metadata" poster="${urls[0]}?q=10&w=320&h=568&f=auto&fl=progressive" muted></video>
              <div class="video-spinner">
                <div class="spinner">
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                </div>
              </div>
              <div class="reel-play-pause"></div>`;
              progressBarHtml = `<div class="progress-bar video-only">
                <div class="progress-fill"></div>
              </div>`;
            } else {
              let transforms = ['h_568,q_auto:eco,f_auto'];
              if (status.textOverlay) {
                transforms.push(status.textOverlay);
              }
              urls.forEach(url => {
                const optUrl = buildCloudinaryUrl(url, transforms);
                mediaElements.push(`<img src="${optUrl}" alt="Reel image" class="reel-image" loading="lazy">`);
              });
              if (mediaElements.length === 1) {
                mediaHtml = mediaElements[0];
              } else {
                mediaHtml = `
                  <div class="reel-carousel">
                    <div class="carousel-track">
                      ${mediaElements.join('')}
                    </div>
                    <div class="carousel-dots">
                      ${mediaElements.map((_, i) => `<span class="carousel-dot ${i === 0 ? 'active' : ''}"></span>`).join('')}
                    </div>
                  </div>`;
              }
            }
            reelDiv.innerHTML = `
              ${mediaHtml}
              <div class="reel-overlay">
                <div class="reel-header">
                  ${avatarHtml}
                  <div class="reel-user-info">
                    <div class="reel-username">${nameHtml}</div>
                    ${descHtml}
                  </div>
                </div>
                <div class="reel-actions">
                  <button class="action-btn ${likeClass}" onclick="likeReel('${status.statusId}', event)">
                    <span class="material-icons action-icon">${likeIcon}</span>
                    <span class="action-count">${likes}</span>
                  </button>
                  <button class="action-btn" onclick="openComments('${status.statusId}', event)">
                    <span class="material-icons action-icon">chat_bubble_outline</span>
                    <span class="action-count">${comments}</span>
                  </button>
                </div>
                ${progressBarHtml}
              </div>
            `;
            const mediaEl = reelDiv.querySelector(type === 'video' ? '.reel-video' : type === 'text' ? '.text-content' : '.reel-image');
            if (type === 'video') {
              if (status.speed) mediaEl.playbackRate = status.speed;
              if (status.filter) mediaEl.style.filter = status.filter;
              mediaEl.addEventListener('loadstart', () => showVideoSpinner(mediaEl));
              mediaEl.addEventListener('waiting', () => showVideoSpinner(mediaEl));
              mediaEl.addEventListener('stalled', () => showVideoSpinner(mediaEl));
              mediaEl.addEventListener('canplay', () => hideVideoSpinner(mediaEl));
              mediaEl.addEventListener('playing', () => hideVideoSpinner(mediaEl));
              mediaEl.addEventListener('pause', () => togglePlayPauseIcon(mediaEl));
              mediaEl.addEventListener('play', () => togglePlayPauseIcon(mediaEl));
              mediaEl.addEventListener('error', () => {
                console.warn('Video load error:', mediaEl.src);
                hideVideoSpinner(mediaEl);
                mediaEl.poster = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
              });
              mediaEl.addEventListener('click', () => {
                if (mediaEl.paused) {
                  mediaEl.play().catch(console.error);
                } else {
                  mediaEl.pause();
                }
              });
              togglePlayPauseIcon(mediaEl);
            } else if (type === 'image') {
              const imgs = reelDiv.querySelectorAll('.reel-image');
              if (status.filter) {
                imgs.forEach(img => img.style.filter = status.filter);
              }
              if (mediaElements.length > 1) {
                initReelCarousel(reelDiv);
              }
            }
            container.appendChild(reelDiv);
            const descriptionEl = reelDiv.querySelector('.reel-description');
            if (descriptionEl) {
              setupCaptionToggle(descriptionEl);
            }
          });
          container.scrollTop = 0;
          setupMediaObserver(type);
          if (mediaStatuses.length > 0) {
            const firstReel = container.querySelector('.reel-item');
            if (firstReel) {
              if (type === 'video') {
                const firstMedia = firstReel.querySelector('.reel-video');
                firstMedia.play().catch(console.error);
                const firstProgressFill = firstReel.querySelector('.progress-fill');
                if (firstProgressFill) firstProgressFill.style.width = '0%';
              }
            }
          }
        } catch (error) {
          console.error('Error loading reels:', error);
          container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 60px; font-size: 17px;">Failed to load reels. <button onclick="loadReels(currentTab)" style="background: none; border: none; color: var(--bbm-red); cursor: pointer;">Retry</button></p>';
        }
      }
      hideSpinner();
    }
    function setupMediaObserver(type) {
      const items = document.querySelectorAll('.reel-item');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          const mediaEl = entry.target.querySelector(type === 'video' ? '.reel-video' : '.reel-image');
          const progressFill = entry.target.querySelector('.progress-fill');
          const currentIndex = Array.from(items).indexOf(entry.target);
          if (entry.isIntersecting) {
            entry.target.classList.add('entered');
            if (type === 'video') {
              showVideoSpinner(mediaEl);
              mediaEl.play().catch(console.error);
              if (currentIndex < items.length - 1) {
                const nextItem = items[currentIndex + 1];
                const nextMedia = nextItem.querySelector('.reel-video');
                if (nextMedia) {
                  nextMedia.preload = 'metadata';
                }
              }
              const updateProgress = () => {
                if (mediaEl.duration && !mediaEl.paused && !mediaEl.ended) {
                  const progress = (mediaEl.currentTime / mediaEl.duration) * 100;
                  progressFill.style.width = progress + '%';
                  requestAnimationFrame(updateProgress);
                }
              };
              updateProgress();
            }
          } else {
            entry.target.classList.remove('entered');
            if (type === 'video') {
              mediaEl.pause();
              mediaEl.currentTime = 0;
              if (progressFill) progressFill.style.width = '0%';
              hideVideoSpinner(mediaEl);
            }
          }
        });
      }, { threshold: 0.6 });
      items.forEach(item => observer.observe(item));
    }
    window.likeReel = async (statusId, event) => {
      event.stopPropagation();
      if (!currentUser) return;
      const reelItem = document.querySelector(`[data-status-id="${statusId}"]`);
      if (!reelItem) return;
      const likeBtn = reelItem.querySelector('.action-btn:first-child');
      const currentLikes = parseInt(likeBtn.querySelector('.action-count').textContent);
      try {
        const likeRef = ref(db, `statuses/${statusId}/likes/${currentUser.uid}`);
        const snap = await get(likeRef);
        const liked = snap.exists();
        if (liked) {
          await set(likeRef, null);
          likeBtn.innerHTML = `<span class="material-icons action-icon">favorite_border</span><span class="action-count">${currentLikes - 1}</span>`;
          likeBtn.classList.remove('liked');
        } else {
          await set(likeRef, true);
          likeBtn.innerHTML = `<span class="material-icons action-icon">favorite</span><span class="action-count">${currentLikes + 1}</span>`;
          likeBtn.classList.add('liked');
        }
        showAlert(liked ? 'Like removed' : 'Post liked!');
      } catch (error) {
        console.error('Error toggling like:', error);
        showAlert('Failed to update like.');
      }
    };
    window.openComments = async (statusId, event) => {
      event.stopPropagation();
      currentStatusId = statusId;
      const sheet = document.getElementById('comments-sheet');
      const backdrop = document.getElementById('sheet-backdrop');
      sheet.classList.add('active');
      backdrop.classList.add('active');
      backdrop.onclick = closeCommentsSheet;
      await loadComments(statusId);
    };
    window.closeCommentsSheet = () => {
      const sheet = document.getElementById('comments-sheet');
      const backdrop = document.getElementById('sheet-backdrop');
      sheet.classList.remove('active');
      backdrop.classList.remove('active');
      backdrop.onclick = null;
      document.getElementById('new-comment-input').value = '';
      currentReplyTo = null;
      currentReplyUser = null;
      updateInputUI();
      currentStatusId = null;
    };
    async function loadComments(statusId) {
      if (!currentUser) return;
      const commentsList = document.getElementById('comments-list');
      commentsList.innerHTML = '<div class="no-comments">Loading comments...</div>';
      try {
        const commentsRef = ref(db, `statuses/${statusId}/comments`);
        const snapshot = await get(commentsRef);
        commentsList.innerHTML = '';
        if (snapshot.exists()) {
          let comments = Object.entries(snapshot.val()).map(([id, data]) => ({
            id,
            ...data,
            replies: data.replies ? Object.entries(data.replies).map(([rid, rdata]) => ({
              id: rid,
              ...rdata
            })).sort((a, b) => a.timestamp - b.timestamp) : []
          }));
          comments.sort((a, b) => a.timestamp - b.timestamp);
          const allUserIds = new Set([
            ...comments.map(c => c.userId),
            ...comments.flatMap(c => c.replies.map(r => r.userId))
          ]);
          const userIdsArray = [...allUserIds];
          const userPromises = userIdsArray.map(uid => get(ref(db, `users/${uid}`)).then(snap => ({ uid, snap: snap.val() })));
          const userResults = await Promise.all(userPromises);
          const userMap = Object.fromEntries(userResults.map(ur => [ur.uid, ur.snap]));
          comments.forEach(comment => {
            comment.user = userMap[comment.userId];
            comment.replies.forEach(reply => {
              reply.user = userMap[reply.userId];
            });
          });
          if (comments.length === 0) {
            commentsList.innerHTML = '<div class="no-comments">No comments yet. Be the first to comment!</div>';
          } else {
            comments.forEach(comment => {
              const commentDiv = document.createElement('div');
              commentDiv.className = 'comment-item';
              const displayName = comment.user?.displayName || comment.userName || 'User';
              const initial = displayName[0].toUpperCase();
              const time = formatTimestamp(comment.timestamp);
              let avatarHtml = '';
              if (comment.user?.photoURL) {
                avatarHtml = `<img src="${comment.user.photoURL}" alt="${displayName}" class="comment-avatar" loading="lazy">`;
              } else {
                avatarHtml = `<div class="comment-avatar" style="font-size: 16px;">${initial}</div>`;
              }
              let authorHtml = displayName;
              if (comment.user?.verified) {
                authorHtml += verifiedIcon;
              }
              let repliesHtml = '';
              if (comment.replies && comment.replies.length > 0) {
                repliesHtml = `<div class="replies-container">
                  ${comment.replies.map(reply => {
                    const replyDisplayName = reply.user?.displayName || reply.userName || 'User';
                    const replyInitial = replyDisplayName[0].toUpperCase();
                    const replyTime = formatTimestamp(reply.timestamp);
                    let replyAvatarHtml = '';
                    if (reply.user?.photoURL) {
                      replyAvatarHtml = `<img src="${reply.user.photoURL}" alt="${replyDisplayName}" class="comment-avatar" loading="lazy">`;
                    } else {
                      replyAvatarHtml = `<div class="comment-avatar" style="font-size: 14px;">${replyInitial}</div>`;
                    }
                    let replyAuthorHtml = replyDisplayName;
                    if (reply.user?.verified) {
                      replyAuthorHtml += verifiedIcon;
                    }
                    return `
                      <div class="reply-item">
                        ${replyAvatarHtml}
                        <div class="comment-content">
                          <div class="comment-header">
                            <span class="comment-author">${replyAuthorHtml}</span>
                            <span class="comment-time">${replyTime}</span>
                          </div>
                          <p class="comment-text">${reply.content}</p>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>`;
              }
              commentDiv.innerHTML = `
                ${avatarHtml}
                <div class="comment-content">
                  <div class="comment-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span class="comment-author">${authorHtml}</span>
                      <button class="reply-btn" onclick="setReplyTo('${comment.id}', '${displayName}')">Reply</button>
                    </div>
                    <span class="comment-time">${time}</span>
                  </div>
                  <p class="comment-text">${comment.content}</p>
                  ${repliesHtml}
                </div>
              `;
              commentsList.appendChild(commentDiv);
            });
          }
        } else {
          commentsList.innerHTML = '<div class="no-comments">No comments yet. Be the first to comment!</div>';
        }
      } catch (error) {
        console.error('Error loading comments:', error);
        commentsList.innerHTML = '<div class="no-comments">Failed to load comments. <button onclick="loadComments(currentStatusId)" style="background: none; border: none; color: var(--bbm-red); cursor: pointer;">Retry</button></div>';
        showAlert('Failed to load comments.');
      }
    }
    window.postComment = async () => {
      const input = document.getElementById('new-comment-input');
      const content = input.value.trim();
      if (!content || !currentStatusId || !currentUser) {
        showAlert('Please enter a comment.');
        return;
      }
      const isReply = !!currentReplyTo;
      try {
        let newRef;
        if (isReply) {
          const replyRef = ref(db, `statuses/${currentStatusId}/comments/${currentReplyTo}/replies`);
          newRef = push(replyRef);
        } else {
          const commentsRef = ref(db, `statuses/${currentStatusId}/comments`);
          newRef = push(commentsRef);
        }
        await set(newRef, {
          userId: currentUser.uid,
          userName: currentUserData.displayName,
          content,
          timestamp: Date.now()
        });
        input.value = '';
        await loadComments(currentStatusId);
        if (isReply) {
          cancelReply();
        }
        showAlert(isReply ? 'Reply posted!' : 'Comment posted!');
        await updateCommentsCount(currentStatusId);
      } catch (error) {
        console.error('Error posting comment:', error);
        showAlert('Failed to post comment.');
      }
    };
    async function updateCommentsCount(statusId) {
      try {
        const commentsRef = ref(db, `statuses/${statusId}/comments`);
        const snapshot = await get(commentsRef);
        const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        const reelItem = document.querySelector(`[data-status-id="${statusId}"]`);
        if (reelItem) {
          const commentBtn = reelItem.querySelector('.action-btn:nth-child(2)');
          const span = commentBtn.querySelector('.action-count');
          if (span) span.textContent = count;
        }
      } catch (error) {
        console.error('Error updating comments count:', error);
      }
    }
    function setupVideoPreview(file) {
      const previewVideo = document.getElementById('preview-video');
      const previewUrl = URL.createObjectURL(file);
      previewUrls.push(previewUrl);
      previewVideo.src = previewUrl;
      previewVideo.onloadedmetadata = () => {
        const dur = previewVideo.duration;
        window.originalDuration = dur;
        const startTrim = document.getElementById('start-trim');
        const endTrim = document.getElementById('end-trim');
        startTrim.max = dur;
        endTrim.max = dur;
        endTrim.value = dur;
        document.getElementById('duration-display').textContent = `Duration: ${Math.round(dur)}s`;
        window.startTime = 0;
        window.endTime = dur;
        startTrim.oninput = (e) => {
          window.startTime = parseFloat(e.target.value);
          if (window.startTime >= window.endTime) {
            window.endTime = window.startTime + 1;
            endTrim.value = window.endTime;
          }
          previewVideo.currentTime = window.startTime;
          document.getElementById('duration-display').textContent = `Trimmed: ${Math.round(window.endTime - window.startTime)}s`;
        };
        endTrim.oninput = (e) => {
          window.endTime = parseFloat(e.target.value);
          if (window.endTime <= window.startTime) {
            window.startTime = window.endTime - 1;
            startTrim.value = window.startTime;
          }
          document.getElementById('duration-display').textContent = `Trimmed: ${Math.round(window.endTime - window.startTime)}s`;
        };
        const loopPreview = () => {
          if (!previewVideo.paused && !previewVideo.ended && previewVideo.currentTime >= window.endTime) {
            previewVideo.currentTime = window.startTime;
          }
        };
        previewVideo.addEventListener('timeupdate', loopPreview);
        previewVideo.addEventListener('play', () => {
          previewVideo.currentTime = window.startTime;
        });
      };
      document.getElementById('video-preview').style.display = 'block';
      document.getElementById('video-trim').style.display = 'block';
      document.getElementById('speed-section').style.display = 'block';
      document.getElementById('edit-controls').style.display = 'block';
      document.getElementById('speed-select').onchange = (e) => {
        previewVideo.playbackRate = parseFloat(e.target.value);
      };
    }
    function setupImagePreview(files) {
      document.getElementById('image-preview').style.display = 'block';
      document.getElementById('edit-controls').style.display = 'block';
      initPreviewCarousel('image-carousel', files);
    }
    window.openUploadSheet = () => {
      const sheet = document.getElementById('upload-sheet');
      const backdrop = document.getElementById('sheet-backdrop');
      sheet.style.zIndex = '1000';
      backdrop.style.zIndex = '999';
      sheet.classList.add('active');
      backdrop.classList.add('active');
      backdrop.onclick = closeUploadSheet;
      selectedMediaFiles = [];
      previewUrls = [];
      isVideoUpload = false;
      document.getElementById('media-input').accept = currentTab === 'text' ? '' : currentTab === 'video' ? 'video/*' : 'image/*';
      document.getElementById('choose-media-btn').style.display = 'block';
      document.getElementById('upload-info-p').style.display = 'block';
      document.getElementById('selected-media-info').style.display = 'none';
      document.getElementById('caption-input').style.display = 'none';
      document.getElementById('post-upload-btn').style.display = 'none';
      document.getElementById('post-upload-btn').disabled = true;
      document.getElementById('upload-progress').style.display = 'none';
      document.getElementById('video-preview').style.display = 'none';
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('video-trim').style.display = 'none';
      document.getElementById('edit-controls').style.display = 'none';
      const previewVideo = document.getElementById('preview-video');
      if (previewVideo.src) {
        URL.revokeObjectURL(previewVideo.src);
        previewVideo.src = '';
      }
      const imageCarousel = document.getElementById('image-carousel');
      if (imageCarousel) imageCarousel.innerHTML = '';
      document.getElementById('overlay-text').value = '';
      updateOverlay();
      document.getElementById('caption-input').value = '';
      if (currentTab === 'text') {
        document.getElementById('choose-media-btn').style.display = 'none';
        document.getElementById('upload-info-p').style.display = 'none';
        document.getElementById('selected-media-info').style.display = 'none';
        document.getElementById('caption-input').style.display = 'block';
        document.getElementById('caption-input').placeholder = 'Enter your text...';
        document.getElementById('post-upload-btn').style.display = 'block';
        document.getElementById('post-upload-btn').disabled = false;
        document.getElementById('post-upload-btn').textContent = 'Post';
      } else {
        document.getElementById('post-upload-btn').textContent = 'Upload';
        document.getElementById('caption-input').placeholder = 'Add caption (optional)';
      }
    };
    window.closeUploadSheet = () => {
      const sheet = document.getElementById('upload-sheet');
      const backdrop = document.getElementById('sheet-backdrop');
      sheet.classList.remove('active');
      backdrop.classList.remove('active');
      backdrop.onclick = null;
      selectedMediaFiles = [];
      previewUrls.forEach(url => URL.revokeObjectURL(url));
      previewUrls = [];
      isVideoUpload = false;
      document.getElementById('upload-sheet').className = 'upload-sheet';
      const previewVideo = document.getElementById('preview-video');
      if (previewVideo.src) {
        URL.revokeObjectURL(previewVideo.src);
        previewVideo.src = '';
      }
      const imageCarousel = document.getElementById('image-carousel');
      if (imageCarousel) imageCarousel.innerHTML = '';
      document.getElementById('selected-media-info').style.display = 'none';
      document.getElementById('caption-input').value = '';
    };
    window.handleMediaUpload = (event) => {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      const videos = files.filter(f => f.type.startsWith('video/'));
      const images = files.filter(f => f.type.startsWith('image/'));
      if (videos.length > 1) {
        showAlert('Only one video can be uploaded at a time.');
        return;
      }
      let infoText = '';
      if (videos.length === 1) {
        const file = videos[0];
        if (file.size > 50 * 1024 * 1024) {
          showAlert('Video too large (max 50MB).');
          return;
        }
        const tempVideo = document.createElement('video');
        tempVideo.preload = 'metadata';
        tempVideo.onloadedmetadata = () => {
          if (tempVideo.duration > 60) {
            showAlert('Video too long (max 60s).');
            URL.revokeObjectURL(tempVideo.src);
            return;
          }
          selectedMediaFiles = [file];
          isVideoUpload = true;
          window.startTime = 0;
          window.endTime = tempVideo.duration;
          infoText = `Video selected: ${file.name}`;
          URL.revokeObjectURL(tempVideo.src);
          setupMediaSelected(infoText);
          setupVideoPreview(file);
        };
        tempVideo.src = URL.createObjectURL(file);
      } else if (images.length > 0) {
        let totalSize = images.reduce((sum, f) => sum + f.size, 0);
        let valid = true;
        images.forEach(f => {
          if (f.size > 10 * 1024 * 1024) valid = false;
        });
        if (totalSize > 50 * 1024 * 1024) valid = false;
        if (!valid) {
          showAlert('Images too large (max 10MB each, 50MB total).');
          return;
        }
        selectedMediaFiles = images;
        isVideoUpload = false;
        infoText = `Selected ${images.length} images`;
        setupMediaSelected(infoText);
        setupImagePreview(images);
      } else {
        showAlert('Please select valid image or video files.');
      }
    };
    function setupMediaSelected(infoText) {
      document.getElementById('selected-media-info').textContent = infoText;
      document.getElementById('selected-media-info').style.display = 'block';
      document.getElementById('upload-info-p').style.display = 'none';
      document.getElementById('choose-media-btn').style.display = 'none';
      document.getElementById('video-preview').style.display = 'none';
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('video-trim').style.display = 'none';
      document.getElementById('edit-controls').style.display = 'none';
      document.getElementById('upload-progress').style.display = 'none';
      document.getElementById('caption-input').style.display = 'block';
      document.getElementById('post-upload-btn').style.display = 'block';
      document.getElementById('post-upload-btn').disabled = false;
      showAlert(`${infoText}. Add optional caption and upload.`);
    }
    window.uploadReel = async () => {
      if (!currentUser) return;
      const caption = document.getElementById('caption-input').value.trim();
      const globalProgress = document.getElementById('global-upload-progress');
      const globalFill = document.getElementById('global-upload-progress-fill');
      const postBtn = document.getElementById('post-upload-btn');
      if (currentTab === 'text') {
        if (!caption) {
          showAlert('Please enter some text.');
          return;
        }
        try {
          showSpinner();
          postBtn.disabled = true;
          postBtn.textContent = 'Posting...';
          const statusRef = ref(db, 'statuses');
          const newStatusRef = push(statusRef);
          const statusData = {
            userId: currentUser.uid,
            userName: currentUserData.displayName,
            type: 'text',
            content: caption,
            timestamp: Date.now(),
            impressions: 0,
            likes: {},
            comments: {}
          };
          await set(newStatusRef, statusData);
          closeUploadSheet();
          if (currentTab === 'text') loadReels(currentTab);
          showAlert('Text posted!');
        } catch (error) {
          console.error('Post failed:', error);
          showAlert('Failed to post text. Try again.');
        } finally {
          hideSpinner();
          postBtn.disabled = false;
          postBtn.textContent = 'Post';
        }
        return;
      }
      if (selectedMediaFiles.length === 0) {
        showAlert('No media selected.');
        return;
      }
      if (isVideoUpload) {
        const trimmedDuration = window.endTime - window.startTime;
        if (trimmedDuration < 1) {
          showAlert('Trimmed video must be at least 1 second long.');
          return;
        }
      }
      try {
        closeUploadSheet();
        showSpinner();
        globalProgress.style.display = 'block';
        globalFill.style.width = '0%';
        postBtn.disabled = true;
        postBtn.textContent = 'Uploading...';
        const urls = [];
        let filter = null;
        let textOverlay = null;
        const b = parseFloat(document.getElementById('brightness').value);
        const c = parseFloat(document.getElementById('contrast').value);
        const s = parseFloat(document.getElementById('saturation').value);
        const h = parseFloat(document.getElementById('hue-rotate').value);
        const bl = parseFloat(document.getElementById('blur').value);
        filter = `brightness(${b}) contrast(${c}) saturate(${s}) hue-rotate(${h}deg) blur(${bl}px)`;
        const overlayText = document.getElementById('overlay-text').value.trim();
        if (overlayText) {
          const size = document.getElementById('text-size').value;
          const color = document.getElementById('text-color').value.slice(1).toUpperCase();
          const gravity = currentPosition === 'top' ? 'north' : currentPosition === 'bottom' ? 'south' : 'center';
          const textEncoded = encodeURIComponent(overlayText).replace(/'/g, "%27");
          textOverlay = `l_text:Arial_${size}:bold_${color}:${textEncoded}/fl_layer_apply,g_${gravity}`;
        }
        if (isVideoUpload) {
          const file = selectedMediaFiles[0];
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', cloudinaryConfig.uploadPreset);
          formData.append('resource_type', 'video');
          formData.append('folder', 'reels');
          const xhr = new XMLHttpRequest();
          xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`);
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              globalFill.style.width = percent + '%';
            }
          });
          const uploadedData = await new Promise((resolve, reject) => {
            xhr.onload = () => {
              if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                resolve(data);
              } else {
                reject(new Error(`Upload failed: ${xhr.statusText}`));
              }
            };
            xhr.onerror = reject;
            xhr.send(formData);
          });
          urls.push(uploadedData.secure_url);
        } else {
          for (let i = 0; i < selectedMediaFiles.length; i++) {
            const file = selectedMediaFiles[i];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryConfig.uploadPreset);
            formData.append('resource_type', 'image');
            formData.append('folder', 'reels');
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`);
            const uploadedData = await new Promise((resolve, reject) => {
              let progressPercent = (i / selectedMediaFiles.length) * 100;
              xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                  const percent = Math.round((e.loaded / e.total) * 100);
                  const currentProgress = progressPercent + ((percent / 100) * (100 / selectedMediaFiles.length));
                  globalFill.style.width = Math.min(currentProgress, 100) + '%';
                }
              });
              xhr.onload = () => {
                if (xhr.status === 200) {
                  const data = JSON.parse(xhr.responseText);
                  resolve(data);
                } else {
                  reject(new Error(`Upload failed: ${xhr.statusText}`));
                }
              };
              xhr.onerror = reject;
              xhr.send(formData);
            });
            urls.push(uploadedData.secure_url);
          }
        }
        const statusRef = ref(db, 'statuses');
        const newStatusRef = push(statusRef);
        const statusData = {
          userId: currentUser.uid,
          userName: currentUserData.displayName,
          type: currentTab,
          mediaUrls: urls,
          content: caption,
          timestamp: Date.now(),
          filter: filter,
          textOverlay: textOverlay,
          impressions: 0,
          likes: {},
          comments: {}
        };
        if (isVideoUpload) {
          statusData.originalDuration = window.originalDuration;
          statusData.startTime = window.startTime;
          statusData.endTime = window.endTime;
          statusData.speed = parseFloat(document.getElementById('speed-select').value);
        }
        await set(newStatusRef, statusData);
        // Small delay to ensure Firebase propagation
        setTimeout(() => {
          if (currentTab === (isVideoUpload ? 'video' : 'image')) loadReels(currentTab);
        }, 500);
        showAlert('Reel uploaded successfully!');
      } catch (error) {
        console.error('Upload failed:', error);
        showAlert('Failed to upload reel. Try again.');
      } finally {
        hideSpinner();
        globalProgress.style.display = 'none';
        globalFill.style.width = '0%';
        postBtn.disabled = false;
        postBtn.textContent = 'Upload';
      }
    };
    function closeActiveSheet() {
      if (document.getElementById('upload-sheet').classList.contains('active')) {
        closeUploadSheet();
      } else if (document.getElementById('comments-sheet').classList.contains('active')) {
        closeCommentsSheet();
      }
    }
    function initializeFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
          const userRef = ref(db, `users/${user.uid}`);
          const snapshot = await get(userRef);
          if (snapshot.exists()) {
            currentUserData = snapshot.val();
          }
          loadReels(currentTab);
        } else {
          window.location.href = 'signup.html';
        }
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      initializeFirebase();
      document.getElementById('new-comment-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          postComment();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeActiveSheet();
      });
    });
  </script>
</body>
</html>
