<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="description" content="Vynix - Connect with friends">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    :root {
      --bg: #ffffff; --card: #f7f9fa; --text: #0f1419; --text2: #536471;
      --border: #e1e8ed; --accent: #ff2a6d; --glow: 0 0 10px rgba(255,42,109,.35);
      --online-dot: #22c55e; --offline-dot: #9ca3af;
    }
    [data-theme="dark"] {
      --bg: #0f1419; --card: #1a1f25; --text: #ffffff; --text2: #8b98a5;
      --border: #2f3336; --offline-dot: #4b5563;
    }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text); transition: background-color .3s, color .3s; }
    #header { position: fixed; top: 0; left: 0; right: 0; height: 64px; background: var(--card);
      border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 10; }
    .main { padding: 64px 16px 80px; }
    .tab { display: none; }
    .tab.active { display: block; }
    .search { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 999px;
      background: var(--card); color: var(--text); margin-bottom: 12px; }
    .search:focus { outline: none; border-color: var(--accent); box-shadow: var(--glow); }
    .card, .trivia-card { display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--card);
      border: 1px solid var(--border); border-radius: 16px; margin-bottom: 12px; }
    .avatar { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; }
    .status-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: var(--online-dot);
      border-radius: 50%; border: 2px solid var(--bg); display: none; animation: pulse 2s infinite; }
    .status-dot.offline { background: var(--offline-dot); animation: none; }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .name { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 4px; }
    .verified-badge { color: var(--accent); font-size: 18px !important; margin-left: 4px; }
    .preview { font-size: 14px; color: var(--text2); margin-top: 2px; }
    .preview-time { font-size: 12px; color: var(--text2); margin-top: 2px; }
    .unread { background: var(--accent); color: #fff; font-size: 11px; font-weight: 700; padding: 2px 6px;
      border-radius: 10px; margin-left: auto; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--card);
      border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; font-size: 12px;
      color: var(--text2); position: relative; cursor: pointer; }
    .nav-item.active { color: var(--accent); text-shadow: var(--glow); }
    .nav-item .material-icons { font-size: 24px; margin-bottom: 2px; }
    .nav-badge { position: absolute; top: 2px; right: 8px; background: var(--accent); color: #fff;
      font-size: 10px; font-weight: 700; padding: 2px 5px; border-radius: 10px; display: none; }
    .nav-badge.show { display: block; }
    .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
      background: var(--accent); color: #fff; box-shadow: var(--glow); display: grid; place-items: center;
      z-index: 20; cursor: pointer; }
    .alert { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--accent);
      color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: 600; display: none; z-index: 1000; }
    .alert.show { display: block; animation: fade .3s; }
    @keyframes fade { from { opacity: 0; transform: translate(-50%, -10px); } to { opacity: 1; } }
    .custom-alert { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300;
      display: none; align-items: center; justify-content: center; }
    .custom-alert.active { display: flex; }
    .alert-box { background: var(--card); border-radius: 24px; padding: 24px; max-width: 320px;
      text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; height: 0; background: var(--card);
      border-top-left-radius: 24px; border-top-right-radius: 24px; overflow: hidden; transition: height .3s; z-index: 100; }
    .bottom-sheet.open { height: 75vh; }
    .sheet-header-relative { position: relative; padding-top: 16px; }
    .sheet-content { padding: 0 20px 20px; height: calc(75vh - 200px); overflow-y: auto; }
    .sheet-tab-modern { position: relative; display: flex; flex-direction: column; align-items: center;
      gap: 6px; padding: 12px 20px; background: transparent; border: none; color: var(--text2);
      font-weight: 600; font-size: 14px; border-radius: 16px; min-width: 100px; }
    .sheet-tab-modern.active { color: var(--accent); background: rgba(255,42,109,0.12);
      box-shadow: 0 4px 12px rgba(255,42,109,0.2); }
    .sheet-tab-modern.active::after { content: ''; position: absolute; bottom: -8px; left: 50%;
      transform: translateX(-50%); width: 30px; height: 3px; background: var(--accent); border-radius: 2px; }

    /* Posts Styles */
    .post-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px;
      overflow: hidden; margin-bottom: 16px; }
    .post-header { padding: 12px 16px; display: flex; align-items: center; gap: 12px; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .post-username { font-weight: 600; }
    .post-time { font-size: 12px; color: var(--text2); }
    .post-media { width: 100%; max-height: 600px; object-fit: contain; background: #000; }
    .post-actions { padding: 8px 16px; display: flex; gap: 20px; align-items: center; }
    .post-action-btn { display: flex; align-items: center; gap: 6px; font-size: 14px; color: var(--text2); }
    .post-action-btn.liked { color: #ef4444; }
    .post-action-btn .material-icons { font-size: 26px; }
    .post-caption { padding: 0 16px 8px; font-size: 14px; line-height: 1.5; }
    .post-likes { padding: 0 16px 8px; font-weight: 600; font-size: 14px; }
    .double-tap-heart { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 80px; color: white; opacity: 0; pointer-events: none; animation: heartBeat .6s; }
    @keyframes heartBeat { 0% { transform: translate(-50%, -50%) scale(0); opacity: .8; }
      50% { transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; } }

    /* Settings Styles */
    .settings-section { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border); }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
    .settings-item:last-child { border-bottom: none; }
    .settings-label { font-weight: 600; font-size: 16px; }
    .settings-description { font-size: 14px; color: var(--text2); margin-top: 2px; }
    .toggle-switch { position: relative; width: 50px; height: 28px; background: var(--border); border-radius: 999px; cursor: pointer; }
    .toggle-switch.active { background: var(--accent); }
    .toggle-slider { position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: transform .3s; }
    .toggle-switch.active .toggle-slider { transform: translateX(22px); }
    .theme-preview { display: flex; gap: 8px; margin-top: 8px; }
    .theme-option { width: 40px; height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all .3s; }
    .theme-option.selected { border-color: var(--accent); box-shadow: var(--glow); }
    .theme-light { background: linear-gradient(135deg, #ffffff 50%, #f7f9fa 50%); }
    .theme-dark { background: linear-gradient(135deg, #0f1419 50%, #1a1f25 50%); }
    .logout-btn { width: 100%; padding: 14px; border-radius: 999px; background: #ef4444; color: white; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px; }
    .version-info { text-align: center; color: var(--text2); font-size: 12px; margin-top: 24px; }
  </style>
</head>
<body>
  <div id="pwa-install-banner" class="pwa-install-banner">
    <div class="pwa-install-text">Install Vynix for a better experience</div>
    <div class="pwa-install-buttons">
      <button id="pwa-install-btn" class="pwa-install-btn">Install</button>
      <button id="pwa-install-close" class="pwa-install-close material-icons">close</button>
    </div>
  </div>
  <div id="offline-indicator" class="offline-indicator">
    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">wifi_off</span> Offline
  </div>

  <header id="header">
    <a href="#" onclick="document.querySelector('.nav-item[data-tab=\'posts\']').click(); event.preventDefault();"
       class="flex items-center h-full px-3 -ml-2">
      <img src="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png"
           alt="Vynix" class="h-10 w-auto object-contain">
    </a>
    <img id="me-avatar" class="avatar w-10 h-10">
  </header>

  <main class="main">
    <!-- Posts Tab (DEFAULT) -->
    <div id="posts" class="tab active">
      <div id="posts-feed" class="space-y-6 px-2"></div>
      <div id="posts-loading" class="text-center py-8 text-var(--text2)">Loading posts...</div>
    </div>

    <!-- Chats Tab -->
    <div id="chats" class="tab">
      <input class="search" id="search" placeholder="Search chats…">
      <div id="trivia-card" class="trivia-card">
        <div class="avatar-wrapper">
          <img class="avatar" src="https://ui-avatars.com/api/?name=AI&background=ff2a6d&color=fff" />
          <span class="status-dot" style="display: block;"></span>
        </div>
        <div class="flex-1">
          <div class="name">Smart Mental Health Assistant
            <span class="material-icons verified-badge-gold">verified</span>
          </div>
          <div class="preview">Get the best professional help you need</div>
          <div class="preview-time">Always available • Verified AI</div>
        </div>
      </div>
      <div id="chat-list"></div>
    </div>

    <div id="channels" class="tab">
      <div class="text-secondary text-sm p-4">Channels coming soon.</div>
    </div>

    <!-- FULL SETTINGS TAB (RESTORED) -->
    <div id="settings" class="tab">
      <div class="settings-section">
        <div class="settings-header">Appearance</div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Dark Mode</div>
            <div class="settings-description">Switch to dark theme</div>
          </div>
          <div class="toggle-switch" id="dark-mode-toggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Theme</div>
            <div class="settings-description">Choose your color theme</div>
          </div>
          <div class="theme-preview">
            <div class="theme-option theme-light selected" data-theme="light" title="Light"></div>
            <div class="theme-option theme-dark" data-theme="dark" title="Dark"></div>
            <div class="theme-option theme-auto" data-theme="auto" title="Auto"></div>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-header">Notifications</div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Push Notifications</div>
            <div class="settings-description">Receive push notifications</div>
          </div>
          <div class="toggle-switch active" id="notifications-toggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Sound</div>
            <div class="settings-description">Play notification sounds</div>
          </div>
          <div class="toggle-switch active" id="sound-toggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-header">Privacy</div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Online Status</div>
            <div class="settings-description">Show when you're online</div>
          </div>
          <div class="toggle-switch active" id="online-status-toggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="settings-item">
          <div>
            <div class="settings-label">Read Receipts</div>
            <div class="settings-description">Show when you've read messages</div>
          </div>
          <div class="toggle-switch active" id="read-receipts-toggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-header">Account</div>
        <div class="settings-item" id="profile-item">
          <div>
            <div class="settings-label">Profile</div>
            <div class="settings-description">Edit your profile information</div>
          </div>
          <span class="material-icons" style="color: var(--text2);">chevron_right</span>
        </div>
        <div class="settings-item" id="verify-item">
          <div>
            <div class="settings-label">Get Verified</div>
            <div class="settings-description">R69 / month – blue check-mark</div>
          </div>
          <span id="verify-badge" class="hidden ml-2 px-2 py-0.5 rounded-full bg-accent text-white text-xs">Active</span>
          <span class="material-icons" style="color: var(--text2);">chevron_right</span>
        </div>
        <div class="settings-item" id="privacy-policy-item">
          <div>
            <div class="settings-label">Privacy Policy</div>
            <div class="settings-description">Read our privacy policy</div>
          </div>
          <span class="material-icons" style="color: var(--text2);">chevron_right</span>
        </div>
        <div class="settings-item" id="terms-item">
          <div>
            <div class="settings-label">Terms of Service</div>
            <div class="settings-description">Read our terms of service</div>
          </div>
          <span class="material-icons" style="color: var(--text2);">chevron_right</span>
        </div>
      </div>
      <button id="logout-btn" class="logout-btn">
        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">logout</span>
        Log Out
      </button>
      <div class="version-info">
        Vynix v1.0.0 • Made with love
      </div>
    </div>
  </main>

  <!-- Unified FAB -->
  <button id="main-fab" class="fab material-icons">add</button>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="posts">
      <span class="material-icons">dashboard</span> Posts
    </div>
    <div class="nav-item" data-tab="chats">
      <span class="material-icons">chat</span> Chats
      <span id="chat-badge" class="nav-badge">0</span>
    </div>
    <a href="ai.html" class="nav-item">
      <span class="material-icons">auto_awesome</span> Buddy
    </a>
    <div class="nav-item" data-tab="settings">
      <span class="material-icons">settings</span> Settings
    </div>
  </nav>

  <!-- Unified Bottom Sheet -->
  <div id="main-sheet" class="bottom-sheet">
    <div class="sheet-header-relative">
      <div style="height: 5px; width: 40px; background: var(--border); border-radius: 3px; margin: 12px auto;"></div>
      <h3 id="sheet-title" style="text-align: center; font-weight: 700; font-size: 18px; margin: 8px 0 16px;">Add Friends</h3>
      <button id="close-main-sheet" class="absolute top-4 right-5 text-2xl text-gray-500">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="flex justify-center gap-8 mb-6 px-6">
      <button class="sheet-tab-modern active" data-mode="friends">
        <span class="material-icons">people</span> <span>Friends</span>
      </button>
      <button class="sheet-tab-modern" data-mode="post">
        <span class="material-icons">add_box</span> <span>New Post</span>
      </button>
    </div>

    <div class="px-5 mb-4" id="friends-search-container">
      <input type="text" class="sheet-search" id="user-search" placeholder="Search users..." />
    </div>

    <div class="sheet-content px-5" id="sheet-content-area">
      <div id="friends-content">
        <div id="suggestions-tab"><div id="sheet-list"></div></div>
        <div id="requests-tab" style="display: none;"><div id="requests-list"></div></div>
      </div>

      <div id="post-content" style="display: none;">
        <textarea id="post-caption" placeholder="What's on your mind?" class="w-full p-4 rounded-xl border border-gray-300 dark:border-gray-700 bg-var(--card) text-var(--text) resize-none h-32 mb-4"></textarea>
        <div id="post-image-preview" class="relative rounded-xl overflow-hidden hidden mb-4">
          <img id="preview-img" class="w-full max-h-96 object-cover">
          <button id="remove-image-btn" class="absolute top-2 right-2 bg-black/70 text-white rounded-full p-2">
            <span class="material-icons text-sm">close</span>
          </button>
        </div>
        <div class="flex justify-between items-center">
          <input type="file" id="post-media-input" accept="image/*,video/*" class="hidden">
          <button id="attach-media-btn" class="p-4 rounded-full bg-gray-200 dark:bg-gray-700">
            <span class="material-icons text-var(--accent)">add_photo_alternate</span>
          </button>
          <button id="submit-post-btn" class="px-6 py-3 bg-var(--accent) text-white rounded-full font-bold">Post</button>
        </div>
      </div>
    </div>
  </div>

  <div id="alert" class="alert"></div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-box">
      <h3 id="alert-title">Confirm</h3>
      <p id="alert-message">Are you sure?</p>
      <div class="alert-buttons">
        <button id="alert-cancel" class="alert-btn secondary">Cancel</button>
        <button id="alert-confirm" class="alert-btn primary">Confirm</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
  import { getDatabase, ref, get, onValue, push, set, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    storageBucket: "fire-b-a8878.firebasestorage.app",
    messagingSenderId: "658673187627",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let uid;
  let lastPostKey = null;
  let isLoadingPosts = false;
  const POSTS_PER_PAGE = 6;

  // Toast
  const toast = (msg) => {
    const al = document.getElementById('alert');
    al.textContent = msg;
    al.classList.add('show');
    setTimeout(() => al.classList.remove('show'), 2500);
  };

  // Alert
  const showCustomAlert = (title, message, onConfirm) => {
    document.getElementById('alert-title').textContent = title;
    document.getElementById('alert-message').textContent = message;
    document.getElementById('custom-alert').classList.add('active');
    document.getElementById('alert-confirm').onclick = () => {
      document.getElementById('custom-alert').classList.remove('active');
      onConfirm();
    };
    document.getElementById('alert-cancel').onclick = () => {
      document.getElementById('custom-alert').classList.remove('active');
    };
  };

  // Format time
  const formatTime = (ts) => {
    if (!ts) return '';
    const diff = Date.now() - ts;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return 'Today';
  };

  // === UNIFIED BOTTOM SHEET (Friends + Create Post) ===
  const mainSheet = document.getElementById('main-sheet');
  const sheetTitle = document.getElementById('sheet-title');
  const friendsContent = document.getElementById('friends-content');
  const postContent = document.getElementById('post-content');
  const friendsSearchContainer = document.getElementById('friends-search-container');

  document.getElementById('main-fab').onclick = () => mainSheet.classList.add('open');
  document.getElementById('close-main-sheet').onclick = () => mainSheet.classList.remove('open');

  document.querySelectorAll('.sheet-tab-modern').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.sheet-tab-modern').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const mode = tab.dataset.mode;
      if (mode === 'friends') {
        sheetTitle.textContent = 'Add Friends';
        friendsContent.style.display = 'block';
        postContent.style.display = 'none';
        friendsSearchContainer.style.display = 'block';
      } else {
        sheetTitle.textContent = 'Create Post';
        friendsContent.style.display = 'none';
        postContent.style.display = 'block';
        friendsSearchContainer.style.display = 'none';
      }
    };
  });

  // Media preview
  document.getElementById('attach-media-btn').onclick = () => document.getElementById('post-media-input').click();
  document.getElementById('post-media-input').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    document.getElementById('preview-img').src = url;
    document.getElementById('post-image-preview').classList.remove('hidden');
  };
  document.getElementById('remove-image-btn').onclick = () => {
    document.getElementById('post-image-preview').classList.add('hidden');
    document.getElementById('post-media-input').value = '';
  };

  // Submit post
  document.getElementById('submit-post-btn').onclick = async () => {
    const caption = document.getElementById('post-caption').value.trim();
    const file = document.getElementById('post-media-input').files[0];
    if (!caption && !file) return toast("Add text or media");

    let mediaUrl = null, mediaType = null;
    if (file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'vynix_posts');
      mediaType = file.type.startsWith('video') ? 'video' : 'image';
      const endpoint = mediaType === 'video' ? 'video/upload' : 'image/upload';

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/${endpoint}`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        mediaUrl = data.secure_url;
      } catch {
        return toast("Upload failed. Try again");
      }
    }

    const postRef = push(ref(db, 'posts'));
    await set(postRef, {
      uid,
      caption,
      mediaUrl,
      mediaType,
      timestamp: serverTimestamp(),
      likes: {}
    });

    document.getElementById('post-caption').value = '';
    document.getElementById('post-media-input').value = '';
    document.getElementById('post-image-preview').classList.add('hidden');
    mainSheet.classList.remove('open');
    toast("Posted!");
  };

  // === POSTS SYSTEM ===
  const loadMorePosts = async () => {
    if (isLoadingPosts) return;
    isLoadingPosts = true;
    document.getElementById('posts-loading').style.display = 'block';

    let query = ref(db, 'posts').orderByChild('timestamp');
    if (lastPostKey) query = query.endBefore(lastPostKey);
    query = query.limitToLast(POSTS_PER_PAGE + (lastPostKey ? 1 : 0));

    const snap = await get(query);
    const feed = document.getElementById('posts-feed');

    snap.forEach(child => {
      if (lastPostKey && child.val().timestamp >= lastPostKey) return;
      renderPost(child.key, child.val());
      lastPostKey = child.val().timestamp;
    });

    document.getElementById('posts-loading').style.display = 'none';
    isLoadingPosts = false;
  };

  const renderPost = async (postId, post) => {
    const userSnap = await get(ref(db, `users/${post.uid}`));
    const user = userSnap.val() || { displayName: 'User', photoURL: '' };
    const hasLiked = !!post.likes?.[uid];
    const likeCount = Object.keys(post.likes || {}).length;

    const el = document.createElement('div');
    el.className = 'post-card';
    el.innerHTML = `
      <div class="post-header">
        <img src="\( {user.photoURL || `https://ui-avatars.com/api/?name= \){user.displayName}&background=ff2a6d&color=fff`}" class="post-avatar">
        <div>
          <div class="post-username">\( {user.displayName} \){user.verified ? '<span class="material-icons verified-badge text-sm ml-1">verified</span>' : ''}</div>
          <div class="post-time">${formatTime(post.timestamp)}</div>
        </div>
        ${post.uid === uid ? '<button class="ml-auto text-red-500 delete-post" data-id="'+postId+'"><span class="material-icons">more_vert</span></button>' : ''}
      </div>
      \( {post.mediaUrl ? `<div class="relative"> \){post.mediaType === 'video' ? `<video src="\( {post.mediaUrl}" controls class="post-media"></video>` : `<img src=" \){post.mediaUrl}" class="post-media" loading="lazy">`}<div class="double-tap-heart material-icons">favorite</div></div>` : ''}
      <div class="post-actions">
        <button class="post-action-btn \( {hasLiked?'liked':''}" data-id=" \){postId}">
          <span class="material-icons">${hasLiked?'favorite':'favorite_border'}</span>
          <span>${likeCount}</span>
        </button>
        <button class="post-action-btn"><span class="material-icons">chat_bubble_outline</span></button>
      </div>
      \( {post.caption ? `<div class="post-caption"><strong> \){user.displayName}</strong> ${post.caption}</div>` : ''}
      <div class="post-likes">${likeCount} likes</div>
    `;

    const media = el.querySelector('.post-media');
    if (media) {
      media.addEventListener('dblclick', () => {
        if (!hasLiked) {
          set(ref(db, `posts/\( {postId}/likes/ \){uid}`), true);
          el.querySelector('.double-tap-heart').style.opacity = '1';
          setTimeout(() => el.querySelector('.double-tap-heart').style.opacity = '0', 600);
        }
      });
    }

    el.querySelector('.post-action-btn')?.addEventListener('click', () => {
      const path = ref(db, `posts/\( {postId}/likes/ \){uid}`);
      hasLiked ? remove(path) : set(path, true);
    });

    el.querySelector('.delete-post')?.addEventListener('click', () => {
      showCustomAlert("Delete Post", "This cannot be undone", () => {
        remove(ref(db, `posts/${postId}`));
        el.remove();
        toast("Post deleted");
      });
    });

    document.getElementById('posts-feed').appendChild(el);
  };

  // Tab navigation
  document.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      el.classList.add('active');
      const tab = el.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if (tab) {
        document.getElementById(tab).classList.add('active');
        document.getElementById('main-fab').style.display = (tab === 'posts' || tab === 'chats') ? 'grid' : 'none';
        if (tab === 'posts') {
          lastPostKey = null;
          document.getElementById('posts-feed').innerHTML = '';
          loadMorePosts();
        }
      }
    });
  });

  // Infinite scroll
  window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000 && !isLoadingPosts) {
      if (document.querySelector('.nav-item[data-tab="posts"]')?.classList.contains('active')) {
        loadMorePosts();
      }
    }
  });

  // Auth + start
  onAuthStateChanged(auth, user => {
    if (!user) return location.href = 'login.html';
    uid = user.uid;
    document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=ff2a6d&color=fff`;
    loadMorePosts(); // Load posts on app start
  });
</script>
</body>
</html>
