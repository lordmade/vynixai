<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#111111">
  <meta name="background-color" content="#FDFDFF">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <title>Vynix AI • Education</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5SLR2/eh2F2x8fMXmT+Tw6+5u/3vA8yHSjXe2K3S9e" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkKLxaEwKk8+ijmC6yS0pG6qK0lE2bS8v3G6p4D2r/4j3p0a8eN0pD8zL" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --bg-page: #FDFDFF;
      --bg-chat: #FFFFFF;
      --primary: #111111;
      --accent: #4F46E5;
      --text-main: #1A1C1E;
      --text-muted: #6C7278;
      --border: #F1F2F4;
      --ai-bubble: #F4F7FB;
      --user-bubble: #FFFFFF;
      --community-bubble: #E8F0FE;
      --community-bubble-self: #E0E0E0;
      --shadow: 0 4px 20px rgba(0,0,0,0.03);
      --sidebar-width: 260px;
      --sidebar-collapsed-width: 72px;
      --header-height: 64px;
      --safe-bottom: env(safe-area-inset-bottom, 12px);
      --input-height: 56px;
    }
    * {
      margin:0; padding:0; box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    html, body {
      height: 100dvh;                 /* ← key change: use dvh */
      overflow: hidden;
      width: 100%;
      background: var(--bg-page);
      color: var(--text-main);
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    body {
      position: relative;
    }
    .msg-content { -webkit-user-select:text; user-select:text; line-height:1.45; }
    .no-highlight, button, .send-btn, .community-send-btn, .nav-item, .channel-item, input, select {
      -webkit-tap-highlight-color:transparent !important;
      -webkit-touch-callout:none;
      user-select:none;
    }
    .header {
      height: var(--header-height);
      background: #FFFFFF;
      padding: 0 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }
    @media (max-width: 768px) {
      :root { --header-height: 52px; }
      .header { padding: 0 12px; }
      .page-title { font-size: 1.05rem; }
      .selector-group select { font-size: 0.7rem; padding: 6px 10px; max-width: 110px; }
    }
    .sidebar {
      background: #FFFFFF;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
      z-index: 50;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: var(--sidebar-width);
      transform: translateX(-100%);
    }
    .sidebar.open { transform: translateX(0); }
    @media (min-width: 769px) {
      .sidebar {
        position: relative;
        transform: translateX(0) !important;
        width: var(--sidebar-width);
      }
      .overlay { display: none !important; }
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    /* ── Fixed input bar ──────────────────────────────────────── */
    .fixed-input-bar {
      position: fixed;
      bottom: var(--safe-bottom);
      left: 12px;
      right: 12px;
      background: #FFFFFF;
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 6px 6px 6px 16px;
      display: flex;
      align-items: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      z-index: 100;
      max-width: 760px;
      margin: 0 auto;
      transition: bottom 0.28s ease-out, transform 0.2s;
      height: var(--input-height);
    }
    .fixed-input-bar.keyboard-open {
      bottom: calc(var(--safe-bottom) + 8px); /* less aggressive lift */
    }
    .fixed-input-bar input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 0.95rem;
      background: transparent;
      padding-right: 12px;
      height: 100%;
    }
    .fixed-input-bar button {
      width: 44px;
      height: 44px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.18s;
    }
    .fixed-input-bar button:active { transform: scale(0.92); }
    @media (max-width: 600px) {
      .fixed-input-bar {
        left: 8px; right: 8px;
        padding: 5px 5px 5px 14px;
        border-radius: 20px;
      }
      .fixed-input-bar input { font-size: 0.92rem; }
      .fixed-input-bar button { width: 40px; height: 40px; }
    }
    /* Chat view */
    #chatView .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 16px calc(var(--input-height) + var(--safe-bottom) + 16px);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    /* Community view */
    #communityView {
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }
    .channels-sidebar {
      background: #fafafa;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      padding: 10px 8px;
      flex-shrink: 0;
    }
    @media (min-width: 769px) {
      #communityView { flex-direction: row; }
      .channels-sidebar {
        width: 240px;
        height: 100%;
        border-bottom: none;
        border-right: 1px solid var(--border);
        overflow-y: auto;
        overflow-x: hidden;
        padding: 16px;
      }
    }
    .channel-item {
      display: inline-block;
      padding: 8px 14px;
      margin-right: 6px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.86rem;
    }
    .channel-item.active, .channel-item:hover {
      background: var(--ai-bubble);
      color: var(--primary);
    }
    .community-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .community-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 16px calc(var(--input-height) + var(--safe-bottom) + 16px);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    /* Message styles remain mostly the same */
    .message { max-width: 86%; margin-bottom: 8px; }
    .message.community { align-self: flex-start; }
    .message.community.self { align-self: flex-end; }
    .msg-bubble {
      padding: 10px 14px;
      font-size: 0.9rem;
      line-height: 1.4;
      border-radius: 18px;
    }
    /* ... rest of message styles unchanged ... */

    /* Shimmer etc. unchanged */
  </style>
</head>
<body>
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <!-- sidebar content unchanged -->
    <div class="sidebar-header">
      <div class="logo-container">
        <div class="brand-logo"><span class="material-symbols-rounded">bolt</span></div>
        <span class="brand-text">Vynix AI</span>
      </div>
    </div>
    <div class="nav-links">
      <div class="nav-item active" data-view="chat"><span class="material-symbols-rounded">chat_bubble</span><span class="nav-text">Chat</span></div>
      <div class="nav-item" data-view="community"><span class="material-symbols-rounded">group</span><span class="nav-text">Community</span></div>
      <div class="nav-item"><span class="material-symbols-rounded">school</span><span class="nav-text">Lessons</span></div>
      <div class="nav-item"><span class="material-symbols-rounded">quiz</span><span class="nav-text">Quizzes</span></div>
      <div class="nav-item"><span class="material-symbols-rounded">history</span><span class="nav-text">History</span></div>
      <div class="nav-item"><span class="material-symbols-rounded">settings</span><span class="nav-text">Settings</span></div>
    </div>
    <div class="sidebar-footer">
      <div class="user-profile" id="userProfile">
        <div class="user-avatar" id="userAvatar"></div>
        <div class="user-info">
          <div class="user-name" id="userDisplayName">Guest</div>
          <div class="user-email" id="userEmail">not signed in</div>
        </div>
      </div>
      <div class="nav-item" id="signOutBtn">
        <span class="material-symbols-rounded">logout</span>
        <span class="nav-text">Sign Out</span>
      </div>
    </div>
  </nav>

  <div class="main-wrapper">
    <header class="header">
      <div class="header-left">
        <button class="hamburger" onclick="toggleSidebar()">
          <span class="material-symbols-rounded">menu</span>
        </button>
        <h1 class="page-title" id="pageTitle">AI Tutor</h1>
      </div>
      <div class="selector-group" id="studySelectors">
        <select id="gradeSelect">
          <option>Gr 10</option>
          <option>Gr 11</option>
          <option selected>Gr 12</option>
        </select>
        <select id="subjectSelect">
          <option>Maths</option>
          <option>Physics</option>
          <option>Life Sci</option>
          <option>IT/CAT</option>
        </select>
      </div>
    </header>

    <div id="chatView" class="view active">
      <main class="chat-container" id="chatContainer">
        <div class="message ai" id="welcomeMessage">
          <div class="msg-bubble shimmer" style="width:80%; height:3.2em;"></div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
      </main>
      <div class="fixed-input-bar" id="chatInputBar">
        <input type="text" id="userInput" placeholder="Ask anything about CAPS..." autocomplete="off">
        <button id="sendBtn" class="send-btn no-highlight">
          <span class="material-symbols-rounded">arrow_upward</span>
        </button>
      </div>
    </div>

    <div id="communityView" class="view">
      <aside class="channels-sidebar">
        <h3 style="padding:0 12px 8px; color:var(--text-muted); font-size:0.85rem;">Channels</h3>
        <div class="channel-item active" data-channel="general">General</div>
        <div class="channel-item" data-channel="maths">Maths</div>
        <div class="channel-item" data-channel="physics">Physics</div>
        <div class="channel-item" data-channel="life-sci">Life Sciences</div>
        <div class="channel-item" data-channel="it-cat">IT/CAT</div>
      </aside>
      <div class="community-main">
        <div class="community-messages" id="communityMessages"></div>
      </div>
      <div class="fixed-input-bar" id="communityInputBar" style="display:none;">
        <input type="text" id="communityInput" placeholder="Type a message..." autocomplete="off">
        <button id="communitySendBtn" class="community-send-btn">
          <span class="material-symbols-rounded">arrow_upward</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ──────────────────────────────────────────────────────────────────────────────
    // FULL JAVASCRIPT CODE (updated)
    // ──────────────────────────────────────────────────────────────────────────────

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('active');
      if (sidebar.classList.contains('open')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    // View switching
    document.querySelectorAll('.nav-item[data-view]').forEach(item => {
      item.addEventListener('click', () => {
        const viewId = item.dataset.view + 'View';
        const titleMap = { chat: 'AI Tutor', community: 'Community' };
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.getElementById('pageTitle').textContent = titleMap[item.dataset.view] || 'Vynix AI';
        document.getElementById('studySelectors').style.display = (item.dataset.view === 'chat') ? 'flex' : 'none';

        const isCommunity = item.dataset.view === 'community';
        document.getElementById('chatInputBar').style.display = isCommunity ? 'none' : 'flex';
        document.getElementById('communityInputBar').style.display = isCommunity ? 'flex' : 'none';

        if (isCommunity) loadCommunity();
        toggleSidebar(); // auto-close on mobile
      });
    });

    // Firebase & other init code remains the same...
    const firebaseConfig = { /* unchanged */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const remoteConfig = firebase.remoteConfig();
    const db = firebase.firestore();
    let XAI_API_KEY = "";
    const MODEL_ID = "grok-4-1-fast-reasoning";

    // ... signInWithGoogle, initConfig, PWA install prompt, showCommunityShimmer, addCopyButtonsToFormulas unchanged ...

    function appendMessage(role, text) {
      // unchanged, but ensure scroll uses latest scroll container
      const container = document.querySelector('.view.active .chat-container, .view.active .community-messages');
      if (!container) return;
      const indicator = document.getElementById('typingIndicator');
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.innerHTML = `
        <div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>
        <div class="msg-time">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
      `;
      container.insertBefore(div, indicator || null);
      container.scrollTop = container.scrollHeight;
      if (typeof renderMathInElement === 'function') {
        renderMathInElement(div, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError: false
        });
      }
      addCopyButtonsToFormulas(div);
    }

    // sendMessage, loadCommunity, switchChannel, sendCommunityMessage unchanged...

    // ── Improved keyboard handling ──────────────────────────────────────────────
    function updateKeyboardState() {
      if (!('visualViewport' in window)) return;
      const vv = window.visualViewport;
      const isKeyboardLikelyOpen = vv.height < window.innerHeight * 0.75;
      const activeBar = document.querySelector('.fixed-input-bar[style*="flex"]') ||
                        document.querySelector('.fixed-input-bar:not([style*="none"])');
      if (activeBar) {
        if (isKeyboardLikelyOpen) {
          activeBar.classList.add('keyboard-open');
        } else {
          activeBar.classList.remove('keyboard-open');
        }
      }
      // Force scroll to bottom in active view
      const scroller = document.querySelector('.view.active .chat-container, .view.active .community-messages');
      if (scroller) scroller.scrollTop = scroller.scrollHeight;
    }

    if ('visualViewport' in window) {
      visualViewport.addEventListener('resize', updateKeyboardState);
      visualViewport.addEventListener('scroll', updateKeyboardState);
    }

    // Also listen on focus/blur
    const inputs = [document.getElementById('userInput'), document.getElementById('communityInput')];
    inputs.forEach(input => {
      if (input) {
        input.addEventListener('focus', updateKeyboardState);
        input.addEventListener('blur', updateKeyboardState);
      }
    });

    // Auth state listener (unchanged except welcome message math render)
    auth.onAuthStateChanged(user => {
      // ... existing code ...
      if (user) {
        // ...
        updateKeyboardState(); // initial correction
      }
    });

    // Event listeners
    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('userInput').onkeypress = e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    };
    document.getElementById('communitySendBtn').onclick = sendCommunityMessage;
    document.getElementById('communityInput').onkeypress = e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendCommunityMessage();
      }
    };
    document.getElementById('signOutBtn').onclick = () => auth.signOut();

    // Service Worker registration unchanged
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(r => console.log('SW registered', r.scope))
          .catch(e => console.error('SW failed', e));
      });
    }

    // Initial call
    updateKeyboardState();
  </script>
</body>
</html>
