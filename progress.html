<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Student Quiz Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['\\(', '\\)']], displayMath: [['$$', '$$']] },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #3a76f0; --primary-light: #e0eaff; --bg-body: #f3f4f6;
            --bg-card: #ffffff; --text-main: #111827; --text-muted: #6b7280;
            --border-light: #e5e7eb; --success: #10b981; --danger: #ef4444;
            --shimmer-bg: #e5e7eb; --shimmer-highlight: #f3f4f6;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #4f86f7; --primary-light: #1e293b; --bg-body: #000000;
                --bg-card: #1c1c1e; --text-main: #f9fafb; --text-muted: #9ca3af;
                --border-light: #27272a; --shimmer-bg: #27272a; --shimmer-highlight: #3f3f46;
            }
        }

        /* PREVENT HIGHLIGHT & LONG PRESS */
        * {
            box-sizing: border-box; margin: 0; padding: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none; /* Prevents callout menu on long press */
            -webkit-user-select: none;   /* Disable selection */
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body { background: var(--bg-body); color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* UI Components */
        #header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--bg-card); border-bottom: 1px solid var(--border-light); display: flex; align-items: center; padding: 0 16px; z-index: 100; padding-top: env(safe-area-inset-top); }
        #headerTitle { font-weight: 700; font-size: 18px; flex: 1; text-align: center; }
        #content { flex: 1; overflow-y: auto; padding: 20px; padding-top: calc(70px + env(safe-area-inset-top)); }

        #progressBarContainer { position: fixed; top: calc(60px + env(safe-area-inset-top)); left: 0; right: 0; height: 4px; background: var(--bg-body); z-index: 99; }
        #progressBarFill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }

        .stats-card { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 24px; display: flex; justify-content: space-around; border: 1px solid var(--border-light); }
        .stat-value { font-size: 24px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }

        .subject-card { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border-light); cursor: pointer; }
        .subject-card:active { transform: scale(0.98); }

        .question { background: var(--bg-card); padding: 20px; border-radius: 16px; margin-bottom: 16px; border: 1px solid var(--border-light); }
        .option { display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid var(--border-light); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        
        /* THE HIGHLIGHT STYLE */
        .option.selected { border-color: var(--primary) !important; background: var(--primary-light) !important; font-weight: 600; }
        .option.disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-primary { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; }
        .hidden { display: none !important; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.2s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 320px; padding: 24px; border-radius: 20px; text-align: center; }

        .skeleton { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; height: 80px; }
        .shimmer-effect::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, var(--shimmer-highlight), transparent); transform: translateX(-100%); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
    </style>
</head>
<body>

    <div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 20px; border-radius:20px; z-index:3000; display:none;"></div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-card">
            <h3 id="modalTitle">Unanswered Questions</h3>
            <p id="modalDesc" style="margin: 15px 0; color: var(--text-muted);">You haven't finished the quiz. Submit anyway?</p>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" style="background:var(--bg-body); color:var(--text-main);" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" id="modalConfirmBtn">Submit</button>
            </div>
        </div>
    </div>

    <div id="header">
        <span class="material-symbols-rounded" onclick="goHome()">home</span>
        <div id="headerTitle">Dashboard</div>
        <div style="width: 24px;"></div>
    </div>

    <div id="progressBarContainer" class="hidden">
        <div id="progressBarFill"></div>
    </div>

    <div id="content">
        <div id="skeletonView">
            <div class="skeleton shimmer-effect"></div>
            <div class="skeleton shimmer-effect"></div>
        </div>

        <div id="dashboardView" class="hidden">
            <div class="stats-card">
                <div><div class="stat-value" id="statTotal">0</div><div class="stat-label">Quizzes</div></div>
                <div><div class="stat-value" id="statAvg">0%</div><div class="stat-label">Avg Score</div></div>
            </div>
            <h3 style="margin-bottom:15px; font-size:14px; color:var(--text-muted);">SELECT SUBJECT</h3>
            <div class="subject-card" onclick="checkAndLoadQuiz('maths')">üìê Mathematics</div>
            <div class="subject-card" onclick="checkAndLoadQuiz('physical_sciences')">‚öõÔ∏è Physical Sciences</div>
            <div class="subject-card" onclick="checkAndLoadQuiz('life_sciences')">üß¨ Life Sciences</div>
        </div>

        <div id="quizView" class="hidden">
            <div id="questionsContainer"></div>
            <button class="btn-primary" id="submitBtn" onclick="trySubmitQuiz()">Submit Quiz</button>
        </div>

        <div id="lockedView" class="hidden" style="text-align:center; padding-top:50px;">
            <span class="material-symbols-rounded" style="font-size:80px; color:var(--primary);">lock</span>
            <h2>Already Completed</h2>
            <p style="color:var(--text-muted); margin:20px 0;">You have already submitted this quiz. You cannot attempt it again.</p>
            <button class="btn-primary" onclick="goHome()">Back to Dashboard</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let currentSubject = null;
        let questions = [];
        let userAnswers = {};
        let quizListener = null;
        let userAttempts = [];

        auth.onAuthStateChanged(user => {
            if (user) { 
                currentUser = user; 
                fetchAttempts(); 
            } else { 
                auth.signInAnonymously(); 
            }
        });

        // 1. Get all previous attempts to see what is "Locked"
        function fetchAttempts() {
            db.ref(`quiz/users/${currentUser.uid}/attempts`).on('value', snap => {
                const data = snap.val();
                userAttempts = data ? Object.values(data) : [];
                updateStats();
                document.getElementById('skeletonView').classList.add('hidden');
                document.getElementById('dashboardView').classList.remove('hidden');
            });
        }

        function updateStats() {
            if (userAttempts.length === 0) return;
            let totalPct = 0;
            userAttempts.forEach(a => totalPct += (a.score / a.total) * 100);
            document.getElementById('statTotal').innerText = userAttempts.length;
            document.getElementById('statAvg').innerText = Math.round(totalPct / userAttempts.length) + '%';
        }

        // 2. Check if already answered before loading
        function checkAndLoadQuiz(subject) {
            const alreadyDone = userAttempts.some(attempt => attempt.subject === subject);
            
            if (alreadyDone) {
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('lockedView').classList.remove('hidden');
                document.getElementById('headerTitle').innerText = "Locked";
            } else {
                loadQuiz(subject);
            }
        }

        function loadQuiz(subject) {
            currentSubject = subject;
            userAnswers = {};
            if (quizListener) db.ref(`quiz/subjects/${subject}/questions`).off('value', quizListener);

            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('skeletonView').classList.remove('hidden');
            document.getElementById('progressBarContainer').classList.remove('hidden');
            document.getElementById('headerTitle').innerText = subject.toUpperCase();

            quizListener = db.ref(`quiz/subjects/${subject}/questions`).on('value', snap => {
                const data = snap.val();
                questions = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
                
                renderQuestions();
                document.getElementById('skeletonView').classList.add('hidden');
                document.getElementById('quizView').classList.remove('hidden');
                updateProgressBar();
            });
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question';
                
                let html = `<div style="font-weight:700; margin-bottom:15px;">${index + 1}. ${q.text}</div>`;
                
                q.options.forEach(opt => {
                    // Check if this option was already selected (important for real-time updates)
                    const isSelected = userAnswers[q.id] === opt ? 'selected' : '';
                    const safeOpt = opt.replace(/"/g, '&quot;');
                    
                    html += `
                        <div class="option ${isSelected}" onclick="selectOption('${q.id}', '${safeOpt}', this)">
                            ${opt}
                        </div>`;
                });
                
                qDiv.innerHTML = html;
                container.appendChild(qDiv);
            });
            
            if (window.MathJax) MathJax.typesetPromise();
        }

        function selectOption(qId, answer, element) {
            // Update local storage of answers
            userAnswers[qId] = answer;
            
            // Visual Highlight Logic
            const siblings = element.parentElement.getElementsByClassName('option');
            for(let sib of siblings) sib.classList.remove('selected');
            element.classList.add('selected');
            
            updateProgressBar();
        }

        function updateProgressBar() {
            const total = questions.length;
            if (total === 0) return;
            const answered = Object.keys(userAnswers).length;
            const pct = (answered / total) * 100;
            document.getElementById('progressBarFill').style.width = pct + '%';
        }

        function trySubmitQuiz() {
            const answeredCount = Object.keys(userAnswers).length;
            if (answeredCount < questions.length) {
                showModal();
            } else {
                finalizeSubmit();
            }
        }

        async function finalizeSubmit() {
            let score = 0;
            questions.forEach(q => {
                if (userAnswers[q.id] === q.correct) score++;
            });

            // Double check lock one last time
            const alreadyDone = userAttempts.some(attempt => attempt.subject === currentSubject);
            if(alreadyDone) {
                alert("Quiz already submitted.");
                return goHome();
            }

            await db.ref(`quiz/users/${currentUser.uid}/attempts`).push({
                subject: currentSubject,
                score: score,
                total: questions.length,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            location.reload(); // Refresh to show stats and lock the subject
        }

        function goHome() { location.reload(); }
        function showModal() { 
            const m = document.getElementById('confirmModal'); 
            m.classList.add('active'); 
            document.getElementById('modalConfirmBtn').onclick = () => { closeModal(); finalizeSubmit(); };
        }
        function closeModal() { document.getElementById('confirmModal').classList.remove('active'); }
    </script>
</body>
</html>
