<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-touch-fullscreen" content="yes">
  <title>Chat - GrokChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Chirp:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000000;
      --card-bg: #16181c;
      --text-primary: #ffffff;
      --text-secondary: #71767b;
      --border: #2f3336;
      --accent: #1d9bf0;
      --x-blue: #1d9bf0;
      --header-bg: #000000;
      --chat-bubble-sent: #1d9bf0;
      --chat-bubble-received: #16181c;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --glow: 0 0 10px rgba(29, 155, 240, 0.5);
    }
    body.light {
      --bg: #ffffff;
      --card-bg: #f7f9fa;
      --text-primary: #0f1419;
      --text-secondary: #536471;
      --border: #e1e8ed;
      --header-bg: #ffffff;
      --chat-bubble-sent: #1d9bf0;
      --chat-bubble-received: #f7f9fa;
    }
    body {
      font-family: 'Chirp', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      line-height: 1.4;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    * {
      -webkit-touch-callout: none !important;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--header-bg);
      z-index: 100;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      box-shadow: var(--shadow-sm);
      transition: background-color 0.3s ease;
    }
    body.light .header {
      background: var(--header-bg);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .back-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s ease;
    }
    .back-btn:hover {
      background: rgba(29, 155, 240, 0.1);
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .profile-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
      justify-content: center;
    }
    .profile-pic-header {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--x-blue);
      color: #000000;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }
    .profile-pic-header img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .profile-name-header {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
    }
    .profile-timestamp-header {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .verified-icon {
      font-size: 20px;
      color: #1d9bf0;
    }
    .search-bar {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      background: var(--header-bg);
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      z-index: 99;
      display: none;
    }
    .search-bar.active {
      display: block;
    }
    .search-input {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 8px 16px;
      color: var(--text-primary);
      width: 100%;
    }
    .search-input::placeholder {
      color: var(--text-secondary);
    }
    .main-content {
      padding: 84px 20px 120px;
      max-width: 600px;
      margin: 0 auto;
      transition: padding 0.3s ease;
    }
    .main-content.with-search {
      padding-top: 124px;
    }
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
      max-height: calc(100vh - 200px);
    }
    .message-date {
      text-align: center;
      margin: 20px 0;
      color: var(--text-secondary);
      font-size: 13px;
    }
    .message-item {
      display: flex;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
      position: relative;
    }
    .message-received {
      flex-direction: row;
    }
    .message-sent {
      flex-direction: row-reverse;
    }
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--x-blue);
      color: #000000;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 12px;
      flex-shrink: 0;
    }
    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 20px;
      word-wrap: break-word;
      line-height: 1.4;
      position: relative;
      cursor: pointer;
      user-select: text;
    }
    .message-received .message-bubble {
      background: var(--chat-bubble-received);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
      margin-left: 12px;
    }
    .message-sent .message-bubble {
      background: var(--chat-bubble-sent);
      color: #000000;
      border-bottom-right-radius: 4px;
      margin-right: 12px;
    }
    .message-time {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }
    .message-sent .message-time {
      color: rgba(0,0,0,0.7);
    }
    .status-icon {
      font-size: 16px;
    }
    .status-sent {
      color: rgba(0,0,0,0.5);
    }
    .input-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
      box-shadow: var(--shadow-sm);
    }
    .input-group {
      flex: 1;
      display: flex;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .input-group input, .input-group textarea {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      padding: 12px 20px;
      color: var(--text-primary);
      font-size: 16px;
      resize: none;
      max-height: 120px;
    }
    .input-group input::placeholder, .input-group textarea::placeholder {
      color: var(--text-secondary);
    }
    .input-icon {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      padding: 12px;
      transition: color 0.2s ease;
    }
    .input-icon:hover {
      color: var(--x-blue);
    }
    .send-btn {
      background: var(--x-blue);
      color: #000000;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    .send-btn:hover {
      background: #0c84e4;
      transform: scale(1.05);
    }
    .typing-indicator {
      font-style: italic;
      color: var(--x-blue);
      font-size: 14px;
      padding: 8px 12px;
      background: var(--chat-bubble-received);
      border-radius: 20px;
      max-width: 70%;
      margin-left: 52px;
      border-bottom-left-radius: 4px;
    }
    .edit-indicator {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .message-sent .edit-indicator {
      color: rgba(0,0,0,0.5);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #horizontal-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
    #horizontal-spinner.active {
      display: block;
    }
    #spinner-segment {
      width: 40px;
      height: 4px;
      background: var(--x-blue);
      border-radius: 2px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #alert-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 300px;
    }
    #alert-message.active {
      transform: translateX(0);
    }
    body.light #alert-message {
      background: #f7f9fa;
      color: #0f1419;
      border-color: #e1e8ed;
    }
    #media-progress {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin: 8px 0;
    }
    #media-progress-bar {
      height: 100%;
      background: var(--x-blue);
      width: 0%;
      transition: width 0.3s ease;
    }
    /* Context Menu Styles */
    .context-menu {
      position: fixed;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 0;
      box-shadow: var(--shadow-md);
      z-index: 1001;
      min-width: 160px;
      display: none;
      transform: translateY(-10px);
      opacity: 0;
      transition: all 0.2s ease;
    }
    .context-menu.active {
      display: block;
      transform: translateY(0);
      opacity: 1;
    }
    body.light .context-menu {
      background: #ffffff;
      border-color: #e1e8ed;
    }
    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 14px;
    }
    .context-menu-item:hover {
      background: rgba(29, 155, 240, 0.1);
    }
    .context-menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .context-menu-item.disabled:hover {
      background: none;
    }
    .context-menu-icon {
      font-size: 18px;
      width: 20px;
    }
    /* Edit Mode */
    .edit-mode .message-bubble {
      border: 2px solid var(--x-blue);
    }
    .edit-input {
      background: var(--chat-bubble-sent);
      color: #000000;
      border: none;
      outline: none;
      width: 100%;
      resize: none;
      font-family: inherit;
      font-size: inherit;
    }
    @media (max-width: 768px) {
      .main-content {
        padding: 84px 16px 120px;
      }
      .main-content.with-search {
        padding-top: 116px;
      }
    }
  </style>
</head>
<body class="light">
  <header class="header">
    <div class="header-left">
      <button class="back-btn material-icons" onclick="history.back()">arrow_back</button>
      <div class="profile-header">
        <div class="profile-pic-header" id="chat-profile-pic">
          <!-- Profile pic loaded here -->
        </div>
        <div class="profile-details">
          <div class="profile-name-header" id="chat-profile-name">Loading...</div>
          <div class="profile-timestamp-header" id="chat-timestamp"></div>
        </div>
      </div>
    </div>
    <button class="input-icon material-icons" title="Search" onclick="toggleSearch()">search</button>
  </header>
  <div class="search-bar" id="search-bar">
    <input type="text" class="search-input" id="search-input" placeholder="Search messages" oninput="filterMessages()">
  </div>
  <main class="main-content" id="main-content">
    <div class="messages-container" id="messages-container">
      <!-- Messages loaded here -->
    </div>
  </main>
  <div class="input-bar">
    <button class="input-icon material-icons" title="Attach" onclick="attachFile()">attach_file</button>
    <button class="input-icon material-icons" title="GIF" onclick="openGif()">gif</button>
    <div class="input-group">
      <textarea id="message-input" placeholder="Start a message" onkeypress="handleKeyPress(event)"></textarea>
    </div>
    <button class="send-btn material-icons" id="send-btn" title="Voice">mic</button>
    <div id="media-progress" style="display: none;">
      <div id="media-progress-bar"></div>
    </div>
  </div>
  <div id="horizontal-spinner">
    <div id="spinner-segment"></div>
  </div>
  <div id="alert-message" class="alert" role="alert" aria-live="polite"></div>
  <!-- Context Menu -->
  <div id="context-menu" class="context-menu">
    <div class="context-menu-item" id="copy-item">
      <span class="material-icons context-menu-icon">content_copy</span>
      <span>Copy</span>
    </div>
    <div class="context-menu-item" id="edit-item" style="display: none;">
      <span class="material-icons context-menu-icon">edit</span>
      <span>Edit</span>
    </div>
    <div class="context-menu-item" id="delete-item" style="display: none;">
      <span class="material-icons context-menu-icon">delete</span>
      <span>Delete</span>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, get, set, push, update, off, query, orderByChild, limitToLast, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };
    const cloudinaryConfig = {
      cloudName: 'dqkujefxj',
      uploadPreset: 'banter_box'
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser;
    let currentUserInfo;
    let otherUserId;
    let otherUserInfo;
    let chatId;
    let messagesListener;
    let userListener;
    let currentMessageData = null;
    let longPressTimer;
    let allMessages = [];
    let filteredMessages = [];
    const LONG_PRESS_DELAY = 500;
    const verifiedIcon = `<span class="material-icons verified-icon">verified</span>`;
    const showSpinner = () => {
      const spinner = document.getElementById('horizontal-spinner');
      if (spinner) spinner.classList.add('active');
    };
    const hideSpinner = () => {
      const spinner = document.getElementById('horizontal-spinner');
      if (spinner) spinner.classList.remove('active');
    };
    const showAlert = (message) => {
      const alert = document.getElementById('alert-message');
      if (alert) {
        alert.textContent = message;
        alert.classList.add('active');
        setTimeout(() => alert.classList.remove('active'), 3000);
      }
    };
    function toggleSearch() {
      const searchBar = document.getElementById('search-bar');
      const mainContent = document.getElementById('main-content');
      searchBar.classList.toggle('active');
      mainContent.classList.toggle('with-search');
      if (searchBar.classList.contains('active')) {
        document.getElementById('search-input').focus();
      }
    }
    function filterMessages() {
      const query = document.getElementById('search-input').value.toLowerCase();
      filteredMessages = allMessages.filter(msg => 
        (msg.decrypted || '').toLowerCase().includes(query) ||
        formatTimestamp(msg.timestamp).toLowerCase().includes(query)
      );
      updateMessages(filteredMessages.length > 0 ? filteredMessages : allMessages, true);
    }
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHr = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHr / 24);
      if (diffDay > 0) return date.toLocaleDateString('en-US', { weekday: 'long' });
      if (diffHr > 0) return `${diffHr}h`;
      if (diffMin > 0) return `${diffMin}m`;
      return `${diffSec}s`;
    }
    async function decryptMessage(encryptedStr, chatId) {
      try {
        const { iv, ciphertext } = JSON.parse(encryptedStr);
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          encoder.encode("grochat-secret-key-2025"),
          { name: "PBKDF2" },
          false,
          ["deriveBits", "deriveKey"]
        );
        const salt = encoder.encode(chatId);
        const key = await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: 100000,
            hash: "SHA-256"
          },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["decrypt"]
        );
        const ivData = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
        const data = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: ivData },
          key,
          data
        );
        return new TextDecoder().decode(decrypted);
      } catch (error) {
        console.error('Decryption failed:', error);
        return 'Decryption failed';
      }
    }
    async function encryptMessage(message, chatId) {
      try {
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          encoder.encode("grochat-secret-key-2025"),
          { name: "PBKDF2" },
          false,
          ["deriveBits", "deriveKey"]
        );
        const salt = encoder.encode(chatId);
        const key = await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: 100000,
            hash: "SHA-256"
          },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt"]
        );
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = encoder.encode(message);
        const encrypted = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv: iv },
          key,
          data
        );
        const ivB64 = btoa(String.fromCharCode(...iv));
        const ciphertextB64 = btoa(String.fromCharCode(...new Uint8Array(encrypted)));
        return JSON.stringify({ iv: ivB64, ciphertext: ciphertextB64 });
      } catch (error) {
        console.error('Encryption failed:', error);
        throw error;
      }
    }
    async function loadOwnProfile() {
      try {
        const userRef = ref(db, `users/${currentUser.uid}`);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          currentUserInfo = snapshot.val();
        }
      } catch (error) {
        console.error('Failed to load own profile:', error);
      }
    }
    function loadProfileInfo() {
      if (!otherUserId) return;
      showSpinner();
      const userRef = ref(db, `users/${otherUserId}`);
      userListener = onValue(userRef, (snap) => {
        if (snap.exists()) {
          otherUserInfo = snap.val();
          const displayName = otherUserInfo.displayName || 'User';
          const nameEl = document.getElementById('chat-profile-name');
          if (otherUserInfo.verified) {
            nameEl.innerHTML = displayName + verifiedIcon;
          } else {
            nameEl.innerHTML = displayName;
          }
          const tsEl = document.getElementById('chat-timestamp');
          tsEl.textContent = otherUserInfo.lastSeen ? formatTimestamp(otherUserInfo.lastSeen) : 'Active now';
          const initial = displayName[0].toUpperCase();
          const picContent = otherUserInfo.photoURL ? `<img src="${otherUserInfo.photoURL}" alt="${displayName}" loading="lazy">` : initial;
          document.getElementById('chat-profile-pic').innerHTML = picContent;
        }
        hideSpinner();
      });
    }
    function renderMessage(message, isSent, isSearch = false) {
      let displayContent;
      if (message.type === 'text') {
        displayContent = message.decrypted;
        if (message.edited) {
          displayContent += `<div class="edit-indicator">edited</div>`;
        }
      } else if (message.type === 'image') {
        displayContent = `<img src="${message.message}" alt="Photo" style="max-width: 200px; border-radius: 10px; cursor: pointer;" onclick="window.open('${message.message}')">`;
      } else if (message.type === 'video') {
        displayContent = `<video src="${message.message}" controls style="max-width: 200px; border-radius: 10px;"></video>`;
      } else {
        displayContent = message.decrypted || 'Unknown message type';
      }
      const userInfo = isSent ? currentUserInfo : otherUserInfo;
      const initial = userInfo?.displayName?.[0]?.toUpperCase() || 'U';
      let avatarHtml;
      if (userInfo?.photoURL) {
        avatarHtml = `<div class="message-avatar"><img src="${userInfo.photoURL}" alt="Avatar" loading="lazy"></div>`;
      } else {
        avatarHtml = `<div class="message-avatar">${initial}</div>`;
      }
      const bubbleClass = isSent ? 'message-sent' : 'message-received';
      const time = formatTimestamp(message.timestamp);
      let statusHtml = '';
      if (isSent && message.type === 'text') {
        statusHtml = '<span class="material-icons status-icon status-sent">done_all</span>';
      }
      return `
        <div class="message-item ${bubbleClass}" data-message-id="${message.id}" data-is-sent="${isSent}" data-type="${message.type}" data-content="${message.type === 'text' ? message.decrypted : ''}" ${isSearch ? 'style="background: rgba(29,155,240,0.1);"' : ''}>
          ${!isSent ? avatarHtml : ''}
          <div class="message-bubble">
            ${displayContent}
            <div class="message-time">${time} ${statusHtml}</div>
          </div>
          ${isSent ? avatarHtml : ''}
        </div>
      `;
    }
    function updateMessages(messages, isSearch = false) {
      const container = document.getElementById('messages-container');
      container.innerHTML = '';
      let lastDate = null;
      messages.forEach(msg => {
        const msgDate = new Date(msg.timestamp).toLocaleDateString('en-US', { weekday: 'long' });
        if (msgDate !== lastDate) {
          container.innerHTML += `<div class="message-date">${msgDate}</div>`;
          lastDate = msgDate;
        }
        const isSent = msg.senderId === currentUser.uid;
        container.innerHTML += renderMessage(msg, isSent, isSearch);
      });
      if (messages.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No messages found.</p>';
      }
      attachLongPressListeners();
      container.scrollTop = container.scrollHeight;
    }
    function attachLongPressListeners() {
      const messageItems = document.querySelectorAll('.message-item');
      messageItems.forEach(item => {
        let pressTimer;
        let startX, startY;

        const handleStart = (e) => {
          if (e.type === 'mousedown') {
            e.preventDefault();
          }
          startX = e.touches ? e.touches[0].clientX : e.clientX;
          startY = e.touches ? e.touches[0].clientY : e.clientY;
          pressTimer = setTimeout(() => {
            e.preventDefault();
            showContextMenu(e, item);
          }, LONG_PRESS_DELAY);
        };

        const handleMove = (e) => {
          if (e.touches && (Math.abs(e.touches[0].clientX - startX) > 10 || Math.abs(e.touches[0].clientY - startY) > 10)) {
            clearTimeout(pressTimer);
          }
        };

        const handleEnd = () => {
          clearTimeout(pressTimer);
        };

        item.addEventListener('touchstart', handleStart, { passive: false });
        item.addEventListener('touchmove', handleMove, { passive: false });
        item.addEventListener('touchend', handleEnd, { passive: false });
        item.addEventListener('mousedown', handleStart);
        item.addEventListener('mousemove', handleMove);
        item.addEventListener('mouseup', handleEnd);
        item.addEventListener('contextmenu', (e) => e.preventDefault());
      });
    }
    function showContextMenu(e, item) {
      currentMessageData = {
        id: item.dataset.messageId,
        isSent: item.dataset.isSent === 'true',
        type: item.dataset.type,
        content: item.dataset.content
      };

      const menu = document.getElementById('context-menu');
      const copyItem = document.getElementById('copy-item');
      const editItem = document.getElementById('edit-item');
      const deleteItem = document.getElementById('delete-item');

      copyItem.style.display = currentMessageData.type === 'text' && currentMessageData.content ? 'flex' : 'none';
      editItem.style.display = currentMessageData.isSent && currentMessageData.type === 'text' ? 'flex' : 'none';
      deleteItem.style.display = currentMessageData.isSent ? 'flex' : 'none';

      if (copyItem.style.display === 'none' && editItem.style.display === 'none' && deleteItem.style.display === 'none') {
        return;
      }

      const rect = item.getBoundingClientRect();
      menu.style.left = `${e.clientX}px`;
      menu.style.top = `${e.clientY}px`;
      menu.classList.add('active');

      const closeMenu = (ev) => {
        if (!menu.contains(ev.target) && !item.contains(ev.target)) {
          menu.classList.remove('active');
          document.removeEventListener('click', closeMenu);
          document.removeEventListener('touchstart', closeMenu);
        }
      };
      setTimeout(() => {
        document.addEventListener('click', closeMenu);
        document.addEventListener('touchstart', closeMenu);
      }, 0);
    }
    // Context menu actions
    document.getElementById('copy-item').addEventListener('click', () => {
      if (currentMessageData && currentMessageData.content) {
        navigator.clipboard.writeText(currentMessageData.content).then(() => {
          showAlert('Copied to clipboard');
        });
      }
      document.getElementById('context-menu').classList.remove('active');
    });
    document.getElementById('edit-item').addEventListener('click', () => {
      if (currentMessageData && currentMessageData.isSent && currentMessageData.type === 'text') {
        const item = document.querySelector(`[data-message-id="${currentMessageData.id}"]`);
        const bubble = item.querySelector('.message-bubble');
        const originalContent = currentMessageData.content;
        const textarea = document.createElement('textarea');
        textarea.className = 'edit-input';
        textarea.value = originalContent;
        textarea.rows = 1;
        textarea.style.minHeight = 'auto';
        bubble.innerHTML = '';
        bubble.appendChild(textarea);
        item.classList.add('edit-mode');
        textarea.focus();
        textarea.addEventListener('input', () => {
          textarea.style.height = 'auto';
          textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        });
        textarea.style.height = textarea.scrollHeight + 'px';

        const saveEdit = async () => {
          const newContent = textarea.value.trim();
          if (newContent && newContent !== originalContent) {
            try {
              const encrypted = await encryptMessage(newContent, chatId);
              await update(ref(db, `chats/${chatId}/messages/${currentMessageData.id}`), {
                message: encrypted,
                edited: Date.now()
              });
              showAlert('Message edited');
            } catch (error) {
              console.error('Failed to edit message:', error);
              showAlert('Failed to edit message');
            }
          }
          cancelEdit(item, bubble, originalContent);
        };

        const cancelEdit = (itemEl, bubbleEl, orig) => {
          itemEl.classList.remove('edit-mode');
          updateMessages(allMessages, false);
        };

        textarea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && e.metaKey) {
            e.preventDefault();
            saveEdit();
          } else if (e.key === 'Escape') {
            cancelEdit(item, bubble, originalContent);
          }
        });

        const saveBtn = document.createElement('button');
        saveBtn.innerHTML = '<span class="material-icons">check</span>';
        saveBtn.style.position = 'absolute';
        saveBtn.style.top = '4px';
        saveBtn.style.right = '4px';
        saveBtn.style.background = 'none';
        saveBtn.style.border = 'none';
        saveBtn.style.color = '#000';
        saveBtn.style.cursor = 'pointer';
        saveBtn.onclick = saveEdit;
        bubble.appendChild(saveBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.innerHTML = '<span class="material-icons">close</span>';
        cancelBtn.style.position = 'absolute';
        cancelBtn.style.top = '4px';
        cancelBtn.style.left = '4px';
        cancelBtn.style.background = 'none';
        cancelBtn.style.border = 'none';
        cancelBtn.style.color = '#000';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.onclick = () => cancelEdit(item, bubble, originalContent);
        bubble.appendChild(cancelBtn);
      }
      document.getElementById('context-menu').classList.remove('active');
    });
    document.getElementById('delete-item').addEventListener('click', async () => {
      if (currentMessageData && currentMessageData.isSent && currentMessageData.id) {
        try {
          await remove(ref(db, `chats/${chatId}/messages/${currentMessageData.id}`));
          showAlert('Message deleted');
        } catch (error) {
          console.error('Failed to delete message:', error);
          showAlert('Failed to delete message');
        }
      }
      document.getElementById('context-menu').classList.remove('active');
    });
    function setupMessagesListener() {
      if (messagesListener) off(messagesListener);
      const messagesRef = ref(db, `chats/${chatId}/messages`);
      const orderedRef = query(messagesRef, orderByChild('timestamp'), limitToLast(100));
      messagesListener = onValue(orderedRef, async (snapshot) => {
        if (snapshot.exists()) {
          allMessages = Object.entries(snapshot.val()).map(([id, m]) => ({ id, ...m })).sort((a, b) => a.timestamp - b.timestamp);
          for (let i = 0; i < allMessages.length; i++) {
            const msg = allMessages[i];
            if (msg.type === 'text' && !msg.decrypted) {
              msg.decrypted = await decryptMessage(msg.message, chatId);
            } else if (!msg.decrypted) {
              msg.decrypted = msg.type === 'image' ? '[Photo]' : msg.type === 'video' ? '[Video]' : 'Media';
            }
          }
          filteredMessages = allMessages;
          updateMessages(filteredMessages);
        } else {
          allMessages = [];
          filteredMessages = [];
          document.getElementById('messages-container').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No messages yet. Start the conversation!</p>';
        }
      });
    }
    window.sendMessage = async () => {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text) return;
      try {
        showSpinner();
        const encrypted = await encryptMessage(text, chatId);
        const messagesRef = ref(db, `chats/${chatId}/messages`);
        const newMessageRef = push(messagesRef);
        await set(newMessageRef, {
          senderId: currentUser.uid,
          message: encrypted,
          type: 'text',
          timestamp: Date.now(),
          status: 'sent'
        });
        const chatUpdate = { lastMessage: encrypted, lastMessageType: 'text', lastMessageTime: Date.now() };
        await update(ref(db, `users/${currentUser.uid}/chats/${otherUserId}`), chatUpdate);
        await update(ref(db, `users/${otherUserId}/chats/${currentUser.uid}`), chatUpdate);
        input.value = '';
        input.style.height = 'auto';
      } catch (error) {
        console.error('Failed to send message:', error);
        showAlert('Failed to send message.');
      } finally {
        hideSpinner();
      }
    };
    window.attachFile = async () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,video/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        showSpinner();
        const progressDiv = document.getElementById('media-progress');
        const progressBar = document.getElementById('media-progress-bar');
        progressDiv.style.display = 'block';
        progressBar.style.width = '0%';
        try {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`);
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', cloudinaryConfig.uploadPreset);
          await new Promise((resolve, reject) => {
            xhr.upload.addEventListener('progress', (ev) => {
              if (ev.lengthComputable) {
                const percent = Math.round((ev.loaded / ev.total) * 100);
                progressBar.style.width = percent + '%';
              }
            });
            xhr.onload = () => {
              if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                const url = data.secure_url;
                const type = file.type.startsWith('image/') ? 'image' : 'video';
                sendMediaMessage(url, type);
                resolve();
              } else {
                reject(new Error(`Upload failed: ${xhr.statusText}`));
              }
            };
            xhr.onerror = reject;
            xhr.send(formData);
          });
        } catch (error) {
          console.error('Failed to send media:', error);
          showAlert('Failed to send media.');
        } finally {
          hideSpinner();
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
        }
      };
      input.click();
    };
    async function sendMediaMessage(url, type) {
      try {
        const messagesRef = ref(db, `chats/${chatId}/messages`);
        const newMessageRef = push(messagesRef);
        await set(newMessageRef, {
          senderId: currentUser.uid,
          message: url,
          type: type,
          timestamp: Date.now(),
          status: 'sent'
        });
        const chatUpdate = { lastMessage: url, lastMessageType: type, lastMessageTime: Date.now() };
        await update(ref(db, `users/${currentUser.uid}/chats/${otherUserId}`), chatUpdate);
        await update(ref(db, `users/${otherUserId}/chats/${currentUser.uid}`), chatUpdate);
      } catch (error) {
        console.error('Failed to send media message:', error);
        showAlert('Failed to send media message.');
      }
    }
    window.openGif = () => {
      showAlert('GIF search coming soon!');
    };
    window.recordVoice = () => {
      showAlert('Voice recording coming soon!');
    };
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }
    function setupSendButton() {
      const input = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      input.addEventListener('focus', () => {
        sendBtn.innerHTML = 'send';
        sendBtn.title = 'Send';
        sendBtn.onclick = sendMessage;
      });
      input.addEventListener('blur', () => {
        if (!input.value.trim()) {
          sendBtn.innerHTML = 'mic';
          sendBtn.title = 'Voice';
          sendBtn.onclick = recordVoice;
        }
      });
      input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      });
      sendBtn.onclick = recordVoice;
    }
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        await loadOwnProfile();
        const urlParams = new URLSearchParams(window.location.search);
        chatId = urlParams.get('chatId');
        otherUserId = urlParams.get('userId');
        if (chatId && otherUserId) {
          loadProfileInfo();
          setupMessagesListener();
          setupSendButton();
        } else {
          showAlert('Invalid chat ID.');
          history.back();
        }
      } else {
        window.location.href = 'login.html';
      }
    });
    window.addEventListener('beforeunload', () => {
      if (messagesListener) off(messagesListener);
      if (userListener) off(userListener);
    });
  </script>
</body>
</html>
