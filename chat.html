<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-touch-fullscreen" content="yes">
  <title>Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Chirp:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000000;
      --card-bg: #16181c;
      --text-primary: #ffffff;
      --text-secondary: #71767b;
      --border: #2f3336;
      --accent: #1d9bf0;
      --x-blue: #1d9bf0;
      --header-bg: #000000;
      --chat-bubble-sent: #1d9bf0;
      --chat-bubble-received: #16181c;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --glow: 0 0 10px rgba(29, 155, 240, 0.5);
    }
    body.light {
      --bg: #ffffff;
      --card-bg: #f7f9fa;
      --text-primary: #0f1419;
      --text-secondary: #536471;
      --border: #e1e8ed;
      --header-bg: #ffffff;
      --chat-bubble-sent: #1d9bf0;
      --chat-bubble-received: #f7f9fa;
    }
    body {
      font-family: 'Chirp', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      line-height: 1.4;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    * {
      -webkit-touch-callout: none !important;
    }
    .status-post {
      -webkit-touch-callout: none;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--header-bg);
      z-index: 100;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      box-shadow: var(--shadow-sm);
      transition: background-color 0.3s ease;
    }
    body.light .header {
      background: var(--header-bg);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      font-family: 'Chirp', monospace;
      font-weight: 900;
      font-size: 28px;
      color: var(--x-blue);
      letter-spacing: -0.5px;
      cursor: pointer;
      text-shadow: var(--glow);
    }
    .header-center {
      flex: 1;
      max-width: 420px;
      display: flex;
      justify-content: center;
    }
    .search-container {
      flex: 1;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 20px;
      gap: 10px;
      max-width: 100%;
      display: flex;
      align-items: center;
      position: relative;
      transition: all 0.3s ease;
    }
    .search-input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 15px;
    }
    .search-input::placeholder {
      color: var(--text-secondary);
    }
    .header-right, .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-actions button {
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 50%;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      min-width: 44px;
      box-shadow: var(--shadow-sm);
      position: relative;
      transition: all 0.3s ease;
    }
    .header-actions button:hover {
      border-color: var(--x-blue);
      box-shadow: var(--glow);
      transform: scale(1.05);
    }
    .profile-container {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .profile-container:hover {
      transform: scale(1.05);
    }
    .header-username {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    .verified-icon-container {
      display: inline-flex;
      align-items: center;
    }
    .verified-icon {
      font-size: 20px;
      color: #1d9bf0;
    }
    .main-content {
      padding: 84px 20px 20px;
      min-height: calc(100vh - 84px);
      transition: padding 0.3s ease;
    }
    .sub-tab-switcher {
      display: flex;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    .sub-tab-item {
      flex: 1;
      padding: 10px 20px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      border-radius: 16px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .sub-tab-item.active {
      background: var(--x-blue);
      color: #ffffff;
      box-shadow: var(--glow);
    }
    .sub-tab-item:hover {
      color: var(--x-blue);
      transform: translateY(-1px);
    }
    .sub-tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .sub-tab-content.active {
      display: block;
    }
    .status-section, .notifications-section {
      margin-bottom: 28px;
    }
    .section-title {
      font-family: 'Chirp', monospace;
      font-weight: 900;
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 20px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
      text-shadow: 0 0 10px rgba(29, 155, 240, 0.3);
    }
    #status-subtitle {
      padding: 0 20px 10px;
      color: var(--text-secondary);
      font-size: 15px;
      font-weight: 600;
      display: none;
    }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 20px;
    }
    .status-item {
      text-align: center;
      cursor: pointer;
      position: relative;
      padding: 8px;
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    .statuses-carousel .status-item {
      flex-shrink: 0;
      width: 80px;
    }
    .status-item::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: var(--x-blue);
      border-radius: 20px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .status-item:hover::before {
      opacity: 1;
      box-shadow: var(--glow);
    }
    .statuses-carousel .status-item:hover::before {
      opacity: 0;
    }
    .status-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--x-blue);
      margin: 0 auto 10px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease;
    }
    .status-avatar:hover {
      transform: scale(1.05);
    }
    .status-avatar::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(transparent, var(--x-blue));
      opacity: 0.9;
    }
    .status-name {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .status-business {
      font-size: 11px;
      color: var(--x-blue);
      text-align: center;
      margin-top: -4px;
      font-weight: 600;
    }
    .statuses-carousel {
      display: flex;
      overflow-x: auto;
      gap: 20px;
      padding: 20px 0;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .statuses-carousel::-webkit-scrollbar {
      display: none;
    }
    .status-carousel {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 12px 0;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .status-carousel::-webkit-scrollbar {
      display: none;
    }
    .status-carousel-inner {
      display: flex;
      flex-shrink: 0;
    }
    .status-post-media-container {
      margin: 0 -20px 16px -20px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .status-post-media {
      max-width: 100%;
      max-height: 550px;
      object-fit: contain;
      border-radius: 20px;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease;
    }
    .status-post-media:hover {
      transform: scale(1.02);
    }
    .chat-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-bottom: 120px;
    }
    .status-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding-bottom: 120px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .chat-item, .notification-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .chat-item::before, .notification-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--x-blue);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .chat-item:hover::before, .notification-item:hover::before {
      transform: scaleX(1);
    }
    .chat-item:hover, .notification-item:hover {
      border-color: var(--x-blue);
      transform: translateY(-2px);
      box-shadow: var(--glow);
    }
    .chat-avatar, .notification-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      position: relative;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--x-blue);
    }
    .chat-item:hover .chat-avatar {
      box-shadow: 0 0 20px rgba(29, 155, 240, 0.5);
    }
    .chat-info, .notification-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    .chat-name, .notification-title {
      font-weight: 800;
      font-size: 17px;
      margin-bottom: 6px;
      color: var(--text-primary);
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
    }
    .chat-preview, .notification-time {
      color: var(--text-secondary);
      font-size: 15px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .typing-indicator {
      color: var(--x-blue);
      font-style: italic;
      font-size: 14px;
      margin-top: 2px;
    }
    .chat-time, .notification-time {
      color: var(--text-secondary);
      font-size: 13px;
      flex-shrink: 0;
      white-space: nowrap;
      font-weight: 600;
    }
    .unread-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--x-blue);
      color: #ffffff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 13px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 8px 0;
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(20px);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .nav-item {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      border-radius: 12px;
      transition: all 0.3s ease;
      min-width: 56px;
      min-height: 56px;
    }
    .nav-item:hover {
      color: var(--x-blue);
      background: rgba(29, 155, 240, 0.08);
      transform: translateY(-1px);
    }
    .nav-item.active {
      color: var(--x-blue);
      background: rgba(29, 155, 240, 0.12);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(29, 155, 240, 0.15);
    }
    .nav-item.active .nav-icon {
      background: var(--x-blue);
      color: white;
      border-radius: 50%;
      padding: 4px;
    }
    .nav-icon {
      font-size: 24px;
      transition: all 0.3s ease;
    }
    @media (min-width: 1024px) {
      .bottom-nav {
        display: none;
      }
    }
    .nav-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: slideIn 0.4s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .fab {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--x-blue);
      border: none;
      color: #ffffff;
      font-size: 15px;
      font-weight: 800;
      box-shadow: var(--shadow-md), var(--glow);
      cursor: pointer;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .fab:hover {
      box-shadow: var(--shadow-md), 0 0 45px rgba(29, 155, 240, 0.7);
      transform: scale(1.05);
    }
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top-left-radius: 32px;
      border-top-right-radius: 32px;
      border: 1px solid var(--border);
      max-height: 90vh;
      transform: translateY(100%);
      z-index: 1000;
      overflow-y: auto;
      padding-bottom: 120px;
      box-shadow: var(--shadow-md);
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .bottom-sheet.active {
      transform: translateY(0);
    }
    .bottom-sheet-header {
      padding: 24px 28px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      transition: all 0.3s ease;
    }
    .sheet-actions {
      background: transparent;
      gap: 12px;
      padding: 20px 28px;
      display: flex;
      border-top: 1px solid var(--border);
      position: sticky;
      bottom: 0;
    }
    .user-card {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--border);
      cursor: pointer;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    .user-card:hover {
      border-color: var(--x-blue);
      box-shadow: var(--glow);
      transform: translateY(-1px);
    }
    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--x-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000000;
      font-weight: bold;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }
    .user-info {
      flex: 1;
      min-width: 0;
    }
    .user-name {
      font-weight: 800;
      font-size: 17px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
    }
    .user-bio {
      color: var(--text-secondary);
      font-size: 15px;
      margin-top: 4px;
    }
    .start-chat-btn {
      background: var(--x-blue);
      color: #000000;
      border: none;
      border-radius: 20px;
      padding: 12px 24px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: var(--shadow-md), var(--glow);
      transition: all 0.3s ease;
    }
    .start-chat-btn:hover {
      box-shadow: var(--shadow-md), 0 0 30px rgba(29, 155, 240, 0.7);
      transform: scale(1.05);
    }
    .profile-pic {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--x-blue);
      color: #000000;
      font-size: 22px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.3s ease;
    }
    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: background 0.3s ease;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 0;
      width: 95vw;
      max-width: 550px;
      max-height: 85vh;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 32px;
      cursor: pointer;
      z-index: 20;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    .modal-close:hover {
      color: var(--x-blue);
      background: var(--card-bg);
      transform: rotate(90deg);
    }
    #progress-bar-container {
      position: fixed;
      top: 84px;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      z-index: 10;
      cursor: pointer;
      transition: height 0.3s ease;
    }
    #progress-bar-container:hover {
      height: 5px;
      box-shadow: var(--glow);
    }
    .progress-item {
      flex: 1;
      background: rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .progress-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background: var(--x-blue);
      transition: width 0.3s ease;
    }
    .progress-item.active {
      background: var(--x-blue);
      box-shadow: var(--glow);
    }
    .progress-item.active::after {
      width: 100%;
    }
    .status-header {
      position: fixed;
      top: 84px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      color: white;
      z-index: 5;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
    }
    .status-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .status-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .status-header-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--x-blue);
      color: #000000;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .status-header-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .user-name, .status-time {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .business-label {
      font-size: 13px;
      color: var(--x-blue);
      margin-left: 4px;
      font-weight: 600;
    }
    #status-modal-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      overflow: hidden;
      position: relative;
      z-index: 1;
      touch-action: pan-y;
      height: 100vh;
      padding-top: 108px;
      padding-bottom: 90px;
      transition: all 0.3s ease;
    }
    .modal-content .status-text {
      color: white;
      background: rgba(0, 0, 0, 0.8);
      padding: 24px;
      border-radius: 16px;
      max-width: 85%;
      text-align: center;
      margin: 0 auto;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 20px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
    }
    .status-media {
      width: 100%;
      height: calc(100vh - 160px);
      object-fit: cover;
      border-radius: 20px;
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease;
    }
    .status-media.zoomed {
      transform: scale(1.6);
      cursor: zoom-out;
    }
    .status-nav-btn {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 32px;
      cursor: pointer;
      z-index: 10;
      display: block;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .status-nav-btn:hover {
      background: rgba(29, 155, 240, 0.8);
      box-shadow: var(--glow);
      transform: translateY(-50%) scale(1.1);
    }
    #prev-status-btn {
      left: 24px;
    }
    #next-status-btn {
      right: 24px;
    }
    @media (max-width: 768px) {
      .status-nav-btn {
        display: block !important;
      }
    }
    .status-text {
      font-size: 20px;
      color: var(--text-primary);
      white-space: pre-wrap;
      line-height: 1.6;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .status-media {
      width: 100%;
      max-height: 550px;
      object-fit: contain;
      border-radius: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
    }
    .upload-sheet {
      padding: 24px;
    }
    .upload-option {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 24px;
      cursor: pointer;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    .upload-option:hover {
      background: var(--x-blue);
      color: #ffffff;
      box-shadow: var(--glow);
      transform: translateY(-2px);
    }
    .upload-sheet input, .upload-sheet textarea {
      width: 100%;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--card-bg);
      color: var(--text-primary);
      margin-bottom: 20px;
      font-size: 17px;
      resize: vertical;
      transition: border-color 0.3s ease;
    }
    .upload-sheet input:focus, .upload-sheet textarea:focus {
      outline: none;
      border-color: var(--x-blue);
      box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1), var(--glow);
    }
    .upload-sheet textarea {
      min-height: 120px;
    }
    .settings-section {
      margin-bottom: 28px;
    }
    details {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    details:hover {
      box-shadow: var(--glow);
    }
    summary {
      padding: 20px 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 700;
      color: var(--text-primary);
      list-style: none;
      background: var(--card-bg);
      transition: all 0.3s ease;
    }
    summary::-webkit-details-marker {
      display: none;
    }
    summary:hover {
      background: rgba(29, 155, 240, 0.1);
      color: var(--x-blue);
    }
    details[open] summary {
      background: var(--x-blue);
      color: #ffffff;
      box-shadow: var(--glow);
    }
    .settings-content {
      padding: 20px 24px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      animation: expand 0.3s ease;
    }
    @keyframes expand {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 500px; }
    }
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    .setting-item:hover {
      background: rgba(29, 155, 240, 0.05);
      border-radius: 12px;
      padding-left: 8px;
      padding-right: 8px;
    }
    .profile-setting-item {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 12px !important;
      border-bottom: none !important;
      padding: 16px 0 !important;
    }
    .profile-setting-item .input-field,
    .profile-setting-item .file-input-wrapper,
    .profile-pic-preview {
      width: 100% !important;
    }
    .setting-item:last-child {
      border-bottom: none;
    }
    .setting-label {
      font-weight: 600;
      color: var(--text-primary);
    }
    .toggle-switch {
      position: relative;
      width: 56px;
      height: 32px;
      background: var(--border);
      border-radius: 16px;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: background-color 0.3s ease;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 28px;
      height: 28px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    .toggle-switch input:checked + .slider {
      transform: translateX(24px);
    }
    .toggle-switch input:checked {
      background: var(--x-blue);
    }
    .toggle-switch:hover .slider {
      box-shadow: 0 0 8px var(--x-blue);
    }
    .input-field {
      width: 100%;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 17px;
      transition: border-color 0.3s ease;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--x-blue);
      box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
    }
    .save-btn {
      background: var(--x-blue);
      color: #000000;
      border: none;
      padding: 16px 28px;
      border-radius: 16px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
      box-shadow: var(--shadow-md), var(--glow);
      transition: all 0.3s ease;
    }
    .save-btn:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-md), 0 0 30px rgba(29, 155, 240, 0.7);
    }
    .save-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .logout-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 20px;
      border-radius: 24px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }
    .logout-btn:hover {
      box-shadow: var(--glow);
      transform: scale(1.02);
    }
    .profile-pic-preview {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--border);
      margin: 0 auto 16px;
      display: block;
      box-shadow: var(--shadow-md);
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    .file-input-label {
      display: block;
      width: 100%;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      color: var(--text-primary);
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .file-input-label:hover {
      background: rgba(29, 155, 240, 0.1);
      border-color: var(--x-blue);
    }
    @media (min-width: 768px) {
      .main-content {
        padding: 84px 60px 20px;
      }
      .bottom-nav {
        margin: 0 60px 28px;
        max-width: 1000px;
        margin-left: auto;
        margin-right: auto;
      }
      .nav-item {
        padding: 10px 8px;
        font-size: 16px;
      }
      .nav-icon {
        font-size: 24px;
      }
      .nav-label {
        font-size: 12px;
      }
      .header-center {
        max-width: 550px;
      }
    }
    @media (min-width: 1024px) {
      .main-content {
        max-width: 600px;
        margin: 84px auto 0;
        padding: 0 20px 20px;
      }
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #ffffff;
        --card-bg: #f7f9fa;
        --text-primary: #0f1419;
        --text-secondary: #536471;
        --border: #e1e8ed;
        --header-bg: #ffffff;
      }
      body {
        background: var(--bg);
      }
      .bottom-nav {
        background: var(--card-bg);
      }
      .header {
        background: var(--header-bg);
      }
    }
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      transition: opacity 0.3s ease;
    }
    .spinner-overlay.active {
      display: flex;
    }
    .spinner {
      display: flex;
      gap: 12px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--x-blue);
      animation: bounce 1.4s ease-in-out infinite both;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .alert {
      position: fixed;
      top: 84px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--x-blue);
      color: #000000;
      padding: 16px 28px;
      border-radius: 20px;
      display: none;
      z-index: 1000;
      box-shadow: var(--shadow-md), var(--glow);
      font-weight: 700;
      font-size: 15px;
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .alert.active {
      display: block;
    }
    .hidden {
      display: none;
    }
    .status-input-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    .like-btn {
      background: var(--card-bg);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      color: var(--text-secondary);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    .like-btn.liked {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.15);
      animation: heartBeat 0.6s ease;
    }
    @keyframes heartBeat {
      0% { transform: scale(1); }
      14% { transform: scale(1.3); }
      28% { transform: scale(1); }
      42% { transform: scale(1.3); }
      70% { transform: scale(1); }
    }
    .input-pill {
      flex: 1;
      display: flex;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: border-color 0.3s ease;
    }
    .input-pill input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      padding: 14px 20px;
      color: var(--text-primary);
      font-size: 16px;
    }
    .send-btn {
      background: var(--x-blue);
      color: white;
      border: none;
      padding: 14px 20px;
      cursor: pointer;
      font-weight: 700;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    .send-btn:hover {
      background: #0c84e4;
      box-shadow: var(--glow);
      transform: scale(1.1);
    }
    .modal-content.fullscreen {
      width: 100vw;
      height: 100vh;
      max-width: none;
      max-height: none;
      border-radius: 0;
      border: none;
      background: black;
      position: relative;
      box-shadow: none;
    }
    #status-modal .status-header {
      background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
      padding: 18px 24px;
      border-bottom: none;
      backdrop-filter: blur(20px);
    }
    #status-modal-body {
      background: black;
      padding-top: 120px;
      padding-bottom: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .status-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .status-media {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .status-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.9));
      padding: 50px 24px 24px;
      color: white;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    .status-text-overlay {
      font-size: 20px;
      line-height: 1.5;
      max-width: 95%;
      margin: 0 auto;
      font-weight: 600;
    }
    .status-reactions {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 24px;
      z-index: 15;
    }
    .reaction-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      color: white;
      font-size: 26px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .reaction-btn:hover {
      background: rgba(29, 155, 240, 0.8);
      transform: scale(1.1);
    }
    .speaker-btn {
      position: fixed;
      top: 130px;
      right: 24px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 26px;
      cursor: pointer;
      z-index: 10;
      display: none;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .speaker-btn:hover {
      background: rgba(29, 155, 240, 0.8);
      transform: scale(1.1);
    }
    #comment-sheet .bottom-sheet-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #comment-sheet h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    #comments-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 24px 20px;
      position: relative;
    }
    #comments-list::before {
      content: '';
      position: absolute;
      left: 28px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
      z-index: 1;
    }
    .comment-item {
      position: relative;
      margin-bottom: 24px;
      padding-left: 0 !important;
      display: block;
    }
    .comment-item::before {
      content: '';
      position: absolute;
      left: 17px;
      top: 20px;
      width: 12px;
      height: 12px;
      background: var(--x-blue);
      border-radius: 50%;
      z-index: 2;
      border: 2px solid var(--card-bg);
    }
    .comment-avatar {
      position: absolute;
      left: 0;
      top: 0;
      z-index: 3;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--x-blue);
      color: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }
    .comment-content {
      background: var(--card-bg);
      padding: 12px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      position: relative;
      margin-left: 52px;
      margin-top: 0;
    }
    .comment-user {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 15px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .comment-text {
      margin-bottom: 8px;
      font-size: 15px;
      line-height: 1.4;
      color: var(--text-primary);
    }
    .comment-time {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .reply-option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(29, 155, 240, 0.1);
      border-radius: 16px;
      cursor: pointer;
      font-size: 14px;
      color: var(--x-blue);
      transition: all 0.3s ease;
      border: none;
    }
    .reply-option:hover {
      background: rgba(29, 155, 240, 0.2);
      transform: scale(1.02);
    }
    .reply-option .material-icons {
      font-size: 16px;
    }
    #comment-input::placeholder {
      color: var(--text-secondary);
    }
    .replying-placeholder::before {
      content: "Replying to @" attr(data-reply-user) ": ";
      font-weight: 600;
      color: var(--x-blue);
    }
    .replies-container {
      margin-top: 8px;
      margin-left: 48px;
      border-left: 2px solid var(--border);
      padding-left: 20px;
      position: relative;
    }
    .reply-toggle {
      cursor: pointer;
      color: var(--x-blue);
      font-size: 14px;
      padding: 8px 0;
      display: block;
      font-weight: 600;
      transition: color 0.3s ease;
      background: none;
      border: none;
      text-align: left;
      width: 100%;
    }
    .reply-toggle:hover {
      color: #4ab3f4;
    }
    .reply-toggle::-webkit-details-marker {
      display: none;
    }
    details[open] .reply-toggle {
      color: var(--text-primary);
    }
    .mention-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    .mention-suggestion {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .mention-suggestion:hover {
      background: rgba(29, 155, 240, 0.1);
    }
    .mention-suggestion:last-child {
      border-bottom: none;
    }
    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
      padding: 8px;
      gap: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    }
    .emoji-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s ease;
    }
    .emoji-btn:hover {
      background: rgba(29, 155, 240, 0.1);
    }
    .status-search-container {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 20px;
      gap: 10px;
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .status-search-input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 15px;
    }
    .status-search-input::placeholder {
      color: var(--text-secondary);
    }
    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      color: white;
      padding: 20px 20px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 2;
    }
    .video-controls.hidden {
      opacity: 0;
    }
    .play-pause-btn {
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      transition: background 0.2s ease;
    }
    .play-pause-btn:hover {
      background: rgba(0,0,0,0.7);
    }
    .progress-container {
      flex: 1;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: var(--x-blue);
      width: 0%;
      border-radius: 2px;
      transition: width 0.1s ease;
    }
    .volume-btn {
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      transition: background 0.2s ease;
    }
    .volume-btn:hover {
      background: rgba(0,0,0,0.7);
    }
    .floating-load-more {
      position: fixed;
      bottom: 120px;
      right: 24px;
      z-index: 150;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.3s ease;
      display: none;
    }
    .floating-load-more.show {
      opacity: 1;
      transform: scale(1);
    }
    .floating-load-more button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--x-blue);
      border: none;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md), var(--glow);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .floating-load-more button:hover {
      box-shadow: var(--shadow-md), 0 0 45px rgba(29, 155, 240, 0.7);
      transform: scale(1.05);
    }
    .floating-load-more button .material-icons {
      font-size: 24px;
    }
    .status-post-content {
      margin-bottom: 16px;
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 16px;
      overflow: hidden;
    }
    .edit-sheet {
      padding: 24px;
    }
    .edit-sheet .upload-sheet input, .edit-sheet .upload-sheet textarea {
      margin-bottom: 20px;
    }
    .edit-media-preview {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 20px;
      margin-bottom: 20px;
    }
    .edit-delete-media {
      background: #ff4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .edit-delete-media:hover {
      background: #cc0000;
    }
    .users-carousel {
      display: flex;
      overflow-x: auto;
      gap: 16px;
      padding: 16px 0;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .users-carousel::-webkit-scrollbar {
      display: none;
    }
    .suggested-user-card {
      flex-shrink: 0;
      width: 120px;
      text-align: center;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 16px 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .suggested-user-card:hover {
      border-color: var(--x-blue);
      box-shadow: var(--glow);
      transform: translateY(-2px);
    }
    .suggested-user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 8px;
      display: block;
      box-shadow: var(--shadow-sm);
    }
    .suggested-user-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .follow-btn-small {
      background: var(--x-blue);
      color: #000000;
      border: none;
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }
    .follow-btn-small:hover {
      background: #0c84e4;
      transform: scale(1.05);
    }
    .suggested-users-section {
      margin-bottom: 28px;
    }
    .slide-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }
    .slide-menu-overlay.open {
      opacity: 1;
      visibility: visible;
    }
    .slide-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100vh;
      background: var(--bg);
      border-right: 1px solid var(--border);
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      overflow-y: auto;
      padding-top: 64px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }
    .slide-menu.open {
      transform: translateX(0);
    }
    .slide-menu-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
    }
    .slide-menu-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .slide-menu-profile:hover {
      transform: scale(1.02);
    }
    .slide-menu-nav {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding-top: 8px;
    }
    .slide-menu-item {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      color: var(--text-primary);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .slide-menu-item:hover {
      background: rgba(29, 155, 240, 0.08);
      color: var(--x-blue);
      border-left: 3px solid var(--x-blue);
    }
    .slide-menu-item.active {
      background: rgba(29, 155, 240, 0.1);
      color: var(--x-blue);
      border-left: 3px solid var(--x-blue);
      font-weight: 600;
    }
    .slide-menu-item .material-icons {
      font-size: 24px;
      min-width: 24px;
      transition: color 0.2s ease;
    }
    .slide-menu-item:hover .material-icons,
    .slide-menu-item.active .material-icons {
      color: var(--x-blue);
    }
    .unread-badge {
      position: absolute;
      right: 24px;
      background: var(--x-blue);
      color: #ffffff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow);
      animation: pulse 2s infinite;
    }
    @media (min-width: 1024px) {
      .slide-menu {
        transform: translateX(0);
        width: 72px;
        padding-top: 64px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      .slide-menu-header {
        display: none;
      }
      .slide-menu-item span:not(.material-icons) {
        display: none;
      }
      .slide-menu-item.active {
        border-left: none;
        background: rgba(29, 155, 240, 0.1);
      }
      .slide-menu-item:hover {
        border-left: none;
      }
      .unread-badge {
        right: 16px;
      }
    }
    @media (max-width: 1023px) {
      .slide-menu-item {
        padding: 18px 24px;
      }
    }
    #search-modal .modal-content {
      max-height: 90vh;
    }
    #search-results {
      flex: 1;
      overflow-y: auto;
      padding: 0 24px 20px;
    }
    .search-result-item {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .search-result-item:hover {
      background: rgba(29, 155, 240, 0.1);
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .profile-pic {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .profile-pic:hover {
      transform: scale(1.05);
    }
    .status-post {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s ease, transform 0.2s ease;
      cursor: pointer;
      max-width: 100%;
    }
    .status-post:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    .status-post-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .status-post-user-header {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .status-post-user {
      flex: 1;
      min-width: 0;
    }
    .status-post-user-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }
    .status-post-business {
      font-size: 12px;
      color: var(--x-blue);
      font-weight: 500;
    }
    .status-post-time {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .status-post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .status-post-content {
      padding: 0 16px 12px;
      font-size: 15px;
      line-height: 1.4;
      color: var(--text-primary);
    }
    .status-post-media-container {
      margin: 0;
      padding: 0;
      width: 100%;
    }
    .status-post-media {
      width: 100%;
      height: auto;
      max-height: 512px;
      object-fit: cover;
      border-radius: 0 0 12px 12px;
    }
    .status-actions {
      padding: 8px 16px;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid var(--border);
      background: var(--card-bg);
    }
    .status-actions span {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: color 0.2s ease;
    }
    .status-actions span:hover {
      color: var(--x-blue);
    }
    .status-post-repost-badge {
      background: rgba(29, 155, 240, 0.1);
      color: var(--x-blue);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .follow-btn {
      background: var(--x-blue);
      color: #ffffff;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-left: auto;
      transition: background 0.2s ease;
    }
    .follow-btn:hover {
      background: #0c84e4;
    }
    .status-ai-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(29, 155, 240, 0.8);
      color: #ffffff;
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      z-index: 10;
    }
    .status-ai-btn:hover {
      background: var(--x-blue);
    }
    @media (min-width: 1024px) {
      .status-post {
        max-width: 500px;
        margin: 0 auto 16px;
      }
      .status-post-media {
        max-height: 600px;
      }
      .status-actions {
        justify-content: flex-start;
        gap: 24px;
      }
    }
    @media (max-width: 767px) {
      .status-list {
        padding-bottom: 140px;
      }
      .status-post {
        border-radius: 16px;
        margin-bottom: 8px;
      }
      .status-post-header {
        padding: 16px;
      }
      .status-post-content {
        padding: 0 16px 16px;
      }
      .status-actions {
        padding: 12px 16px;
      }
    }
    .video-container {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
      border-radius: 12px;
      background: #000;
    }
    .status-post-media[preload="none"] {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.4);
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 2;
    }
    .video-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .play-again-btn {
      background: rgba(0, 0, 0, 0.6);
      border: none;
      color: white;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 32px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .play-again-btn:hover {
      background: rgba(29, 155, 240, 0.8);
      transform: scale(1.1);
    }
    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 3;
    }
    .video-container:hover .video-controls,
    .video-playing .video-controls {
      opacity: 1;
    }
    /* Redesigned Profile Header Styles */
    .profile-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 0 20px 20px;
      position: relative;
      border-radius: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }
    .profile-cover-container {
      position: relative;
      height: 180px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: -60px;
    }
    .profile-cover {
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }
    .profile-cover::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(transparent, var(--card-bg));
    }
    .profile-avatar-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 10;
    }
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--card-bg);
      box-shadow: var(--shadow-md);
      transition: transform 0.3s ease;
    }
    .profile-avatar:hover {
      transform: scale(1.05);
    }
    .profile-info {
      padding-top: 60px;
      padding-bottom: 20px;
    }
    .profile-name {
      font-size: 24px;
      font-weight: 900;
      color: var(--text-primary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .profile-handle {
      color: var(--text-secondary);
      font-size: 15px;
      margin-bottom: 8px;
    }
    .profile-joined {
      color: var(--text-secondary);
      font-size: 15px;
      margin-bottom: 8px;
    }
    .profile-business {
      color: var(--x-blue);
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      padding: 4px 12px;
      background: rgba(29, 155, 240, 0.1);
      border-radius: 12px;
      display: inline-block;
    }
    .profile-bio {
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.5;
      margin-bottom: 20px;
      max-width: 80%;
    }
    .profile-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 20px;
      padding: 12px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: color 0.2s ease;
      padding: 8px 0;
    }
    .stat-item:hover {
      color: var(--x-blue);
    }
    .stat-number {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .follow-btn-large {
      flex: 1;
      background: var(--x-blue);
      color: #ffffff;
      border: none;
      border-radius: 24px;
      padding: 12px 24px;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      box-shadow: var(--shadow-md), var(--glow);
      transition: all 0.3s ease;
    }
    .follow-btn-large:hover {
      box-shadow: var(--shadow-md), 0 0 30px rgba(29, 155, 240, 0.7);
      transform: scale(1.02);
    }
    .edit-profile-btn {
      flex: 1;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 24px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    .edit-profile-btn:hover {
      border-color: var(--x-blue);
      color: var(--x-blue);
      box-shadow: var(--glow);
    }
    .profile-tab-switcher {
      display: flex;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 25px;
      padding: 4px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .profile-tab-item {
      flex: 1;
      padding: 12px 20px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      border-radius: 20px;
      font-size: 15px;
      transition: all 0.3s ease;
      position: relative;
    }
    .profile-tab-item.active {
      background: var(--x-blue);
      color: #ffffff;
      box-shadow: var(--glow);
    }
    .profile-tab-item:hover {
      color: var(--x-blue);
      background: rgba(29, 155, 240, 0.1);
    }
    .posts-section {
      display: none;
    }
    .posts-section.active {
      display: block;
    }
    .back-btn {
      position: absolute;
      top: 12px;
      left: 20px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }
    .back-btn:hover {
      background: var(--x-blue);
      color: #ffffff;
      box-shadow: var(--glow);
    }
    .more-toggle {
      color: var(--x-blue);
      cursor: pointer;
      font-weight: 600;
      text-decoration: underline;
    }
    .full-text {
      display: none;
    }
    @media (min-width: 768px) {
      .profile-header {
        padding: 0 60px 20px;
        border-radius: 24px;
      }
      .profile-cover-container {
        height: 220px;
        margin-bottom: -80px;
      }
      .profile-avatar {
        width: 120px;
        height: 120px;
      }
      .profile-avatar-container {
        bottom: 30px;
        left: 60px;
      }
      .profile-info {
        padding-top: 80px;
      }
      .profile-name {
        font-size: 28px;
      }
      .profile-bio {
        max-width: none;
      }
      .profile-stats {
        gap: 40px;
      }
      .stat-number {
        font-size: 22px;
      }
      .back-btn {
        left: 60px;
      }
    }
    @media (min-width: 1024px) {
      .main-content {
        max-width: 600px;
        margin: 0 auto;
        padding: 84px 20px 20px;
      }
    }
    #horizontal-spinner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: transparent;
      z-index: 101;
      display: none;
      overflow: hidden;
    }
    #horizontal-spinner.active {
      display: block;
    }
    #spinner-segment {
      display: block;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent, var(--x-blue), transparent);
      animation: shimmer 1.5s linear infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .back-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    .back-btn:hover {
      color: var(--x-blue);
      background: rgba(29, 155, 240, 0.1);
    }
    .chat-header-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--x-blue);
      color: #000000;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .chat-header-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .chat-header-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
    }
    .chat-header-status {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .status-online {
      color: #4CAF50;
    }
    .status-offline {
      color: #9E9E9E;
    }
    .status-last-seen {
      color: #9E9E9E;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .dark-mode-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    .dark-mode-btn:hover {
      color: var(--x-blue);
      background: rgba(29, 155, 240, 0.1);
    }
    .main-content {
      padding: 84px 20px 120px;
      min-height: calc(100vh - 140px);
      transition: padding 0.3s ease;
    }
    #chat-messages {
      padding-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      max-width: 70%;
      padding: 16px;
      border-radius: 28px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      word-wrap: break-word;
      animation: slideIn 0.3s ease-out;
    }
    .message::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--x-blue);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .message:hover::before {
      transform: scaleX(1);
    }
    .message.sent {
      background: var(--chat-bubble-sent);
      color: #000000;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .message.received {
      background: var(--chat-bubble-received);
      color: var(--text-primary);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .message img, .message video {
      max-width: 100%;
      border-radius: 20px;
      margin-top: 10px;
      box-shadow: var(--shadow-md);
    }
    .message audio {
      width: 100%;
      margin-top: 10px;
    }
    .audio-container {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }
    .play-btn {
      background: var(--x-blue);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 24px;
    }
    .play-btn:hover {
      transform: scale(1.05);
    }
    .play-btn.playing {
      background: #0c84e4;
    }
    .waveform {
      flex: 1;
      display: flex;
      align-items: end;
      gap: 2px;
      height: 30px;
      padding: 4px 0;
    }
    .wave-bar {
      background: var(--x-blue);
      width: 3px;
      border-radius: 2px;
      animation: wave 1.2s infinite ease-in-out;
      height: 10px;
    }
    .wave-bar:nth-child(1) { animation-delay: 0s; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 25px; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 20px; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 18px; }
    .wave-bar:nth-child(6) { animation-delay: 0.5s; height: 22px; }
    @keyframes wave {
      0%, 100% { height: 10px; opacity: 0.5; transform: scaleY(0.5); }
      50% { opacity: 1; transform: scaleY(1); }
    }
    .audio-timer {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 60px;
      text-align: right;
      font-family: monospace;
    }
    .message-reactions {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .reaction {
      background: rgba(0, 0, 0, 0.2);
      color: white;
      border-radius: 12px;
      padding: 2px 6px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .reaction:hover {
      background: var(--x-blue);
      transform: scale(1.05);
    }
    .message-status {
      position: absolute;
      bottom: 4px;
      right: 8px;
      font-size: 12px;
      color: #919191;
      display: flex;
      align-items: center;
      gap: 1px;
      pointer-events: none;
    }
    .status-sent {
      color: #919191;
    }
    .status-read {
      color: #34b7f1;
    }
    .message-timestamp {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .edited-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-left: 4px;
    }
    .sent .message-timestamp {
      text-align: right;
    }
    .received .message-timestamp {
      text-align: left;
    }
    .typing-indicator {
      color: var(--x-blue);
      font-style: italic;
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
      padding: 16px;
      background: var(--chat-bubble-received);
      border-radius: 28px;
      max-width: 70%;
      align-self: flex-start;
      box-shadow: var(--shadow-md);
    }
    .typing-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: var(--x-blue);
      border-radius: 50%;
      animation: typing 1.2s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 100% { opacity: 0.3; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-3px); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .welcome-container {
      padding-top: 40px;
      text-align: center;
      font-family: 'Chirp', monospace;
      color: var(--x-blue);
      font-weight: 900;
      font-size: 20px;
      letter-spacing: 0.5px;
      text-shadow: 0 0 10px rgba(29, 155, 240, 0.3);
    }
    .chat-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      z-index: 10;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      margin: 0 20px;
      border-radius: 28px 28px 0 0;
    }
    .input-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .input-pill {
      display: flex;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: border-color 0.3s ease;
    }
    .input-pill input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      padding: 14px 20px;
      color: var(--text-primary);
      font-size: 16px;
    }
    .bottom-icons {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .send-btn {
      background: var(--x-blue);
      color: white;
      border: none;
      padding: 14px 20px;
      cursor: pointer;
      font-weight: 700;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      margin-top: 8px;
    }
    .send-btn:hover {
      background: #0c84e4;
      box-shadow: var(--glow);
      transform: scale(1.1);
    }
    .send-btn .material-icons {
      font-size: 20px;
    }
    .media-btn, .voice-btn {
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .media-btn:hover, .voice-btn:hover {
      color: var(--x-blue);
      border-color: var(--x-blue);
      box-shadow: var(--glow);
    }
    .voice-btn.recording {
      background: var(--x-blue);
      color: white;
      border-color: var(--x-blue);
    }
    .recording-timer {
      color: var(--x-blue);
      font-weight: 600;
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 4px;
    }
    .recording-timer.show {
      display: flex;
    }
    .hidden { display: none; }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    body.light .loading-overlay {
      background: rgba(255, 255, 255, 0.9);
    }
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-text {
      font-family: 'Chirp', monospace;
      color: var(--x-blue);
      font-weight: 900;
      font-size: 18px;
      letter-spacing: 0.5px;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(29, 155, 240, 0.3);
    }
    #model-progress {
      width: 200px;
      height: 8px;
      border-radius: 4px;
      background: var(--border);
      overflow: hidden;
    }
    #model-progress::-webkit-progress-bar {
      background: var(--border);
      border-radius: 4px;
    }
    #model-progress::-webkit-progress-value {
      background: var(--x-blue);
      border-radius: 4px;
    }
    #model-progress::-moz-progress-bar {
      background: var(--x-blue);
      border-radius: 4px;
    }
    .reaction-picker {
      position: fixed;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 12px;
      display: none;
      z-index: 200;
      box-shadow: var(--shadow-md);
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 300px;
    }
    .reaction-emoji {
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 12px;
      transition: all 0.2s ease;
      background: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 48px;
      min-height: 48px;
    }
    .reaction-emoji:hover {
      background: rgba(29, 155, 240, 0.1);
      transform: scale(1.1);
    }
    .context-menu {
      display: none;
      position: fixed;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 0;
      z-index: 200;
      box-shadow: var(--shadow-md);
      min-width: 120px;
    }
    .context-menu button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
      transition: background-color 0.2s ease;
    }
    .context-menu button:hover {
      background: rgba(29, 155, 240, 0.1);
      color: var(--x-blue);
    }
    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
      padding: 8px;
      gap: 8px;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      display: grid;
    }
    .emoji-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s ease;
    }
    .emoji-btn:hover {
      background: rgba(29, 155, 240, 0.1);
    }
    @media (min-width: 1024px) {
      .chat-input-container {
        margin: 0;
        left: 0;
        right: 0;
        border-radius: 0;
      }
      .main-content {
        padding: 84px 20px 120px;
      }
    }
  </style>
</head>
<body class="dark">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="spinner-overlay hidden">
    <div class="spinner">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>
  <div id="alert-message" class="alert"></div>

  <header class="header">
    <div class="header-left">
      <button class="back-btn material-icons" onclick="window.history.back()">arrow_back</button>
      <div class="chat-header-avatar" id="chat-header-avatar">U</div>
      <div class="chat-header-info">
        <div class="chat-header-name" id="chat-header-name">Chat</div>
        <div class="chat-header-status" id="chat-header-status">Online</div>
      </div>
    </div>
    <div class="header-right">
      <div class="header-actions">
        <button class="dark-mode-btn material-icons" id="dark-mode-btn" title="Toggle Dark Mode">bedtime</button>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="welcome-container hidden" id="welcome-container">
      <span class="material-icons" style="font-size: 24px; color: var(--x-blue);">chat</span>
      Say hi to start chatting!
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input-container">
      <div class="input-section">
        <div class="input-pill">
          <input type="text" id="chat-input" placeholder="Type a message..." aria-label="Type your message">
          <div class="emoji-picker" id="emoji-picker"></div>
        </div>
        <div class="bottom-icons">
          <button class="media-btn material-icons" id="media-button" title="Send media">photo_camera</button>
          <button class="voice-btn material-icons" id="voice-button" title="Voice note">mic</button>
          <div class="recording-timer" id="recording-timer">
            <span id="timer-display">00:00.0</span>
          </div>
        </div>
      </div>
      <button class="media-btn material-icons" id="emoji-button" title="Emoji">emoji_emotions</button>
      <button id="send-button" class="send-btn material-icons">send</button>
    </div>
  </main>

  <!-- Reaction Picker -->
  <div id="reaction-picker" class="reaction-picker">
    <button class="reaction-emoji" data-emoji="" title="Thumbs Up"></button>
    <button class="reaction-emoji" data-emoji="" title="Heart"></button>
    <button class="reaction-emoji" data-emoji="" title="Laugh"></button>
    <button class="reaction-emoji" data-emoji="" title="Surprised"></button>
    <button class="reaction-emoji" data-emoji="" title="Sad"></button>
    <button class="reaction-emoji" data-emoji="" title="Angry"></button>
  </div>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu"></div>

  <input type="file" id="media-input" accept="image/*,video/*" style="display: none;" onchange="handleMediaUpload(event)">

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, set, push, onValue, get, update, serverTimestamp, onDisconnect, onChildAdded, onChildChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getAnalytics, setUserId } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const cloudinaryConfig = {
      cloudName: 'dqkujefxj',
      uploadPreset: 'banter_box'
    };

    const state = {
      messages: [],
      hasChatted: false,
      chatId: null,
      otherUserId: null,
      otherUserData: null,
      typing: false,
      isRecording: false,
      messagesListener: null,
      currentSelectedMessageId: null,
      currentSelectedMessageEl: null,
      statusListener: null,
      mediaRecorder: null,
      audioChunks: [],
      recordingStartTime: null,
      timerInterval: null,
      loadedMessages: new Set(),
      isDarkMode: true
    };

    const elements = {
      chatMessages: document.getElementById('chat-messages'),
      chatInput: document.getElementById('chat-input'),
      sendButton: document.getElementById('send-button'),
      welcomeContainer: document.getElementById('welcome-container'),
      mediaButton: document.getElementById('media-button'),
      voiceButton: document.getElementById('voice-button'),
      recordingTimer: document.getElementById('recording-timer'),
      timerDisplay: document.getElementById('timer-display'),
      mediaInput: document.getElementById('media-input'),
      loadingOverlay: document.getElementById('loading-overlay'),
      alertMessage: document.getElementById('alert-message'),
      chatHeaderAvatar: document.getElementById('chat-header-avatar'),
      chatHeaderName: document.getElementById('chat-header-name'),
      chatHeaderStatus: document.getElementById('chat-header-status'),
      reactionPicker: document.getElementById('reaction-picker'),
      contextMenu: document.getElementById('context-menu'),
      emojiButton: document.getElementById('emoji-button'),
      emojiPicker: document.getElementById('emoji-picker'),
      darkModeBtn: document.getElementById('dark-mode-btn')
    };

    let app, auth, db, analytics, currentUser;

    const emojis = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];

    function formatRelativeTime(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffMs = now - time;
      const diffSeconds = Math.floor(diffMs / 1000);
      const diffMinutes = Math.floor(diffSeconds / 60);
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffSeconds < 60) {
        return 'just now';
      } else if (diffMinutes < 60) {
        return `${diffMinutes}m ago`;
      } else if (diffHours < 24) {
        return `${diffHours}h ago`;
      } else if (diffDays < 7) {
        return `${diffDays}d ago`;
      } else if (diffDays < 30) {
        return `${Math.floor(diffDays / 7)}w ago`;
      } else if (diffDays < 365) {
        return `${Math.floor(diffDays / 30)}mo ago`;
      } else {
        return `${Math.floor(diffDays / 365)}y ago`;
      }
    }

    function formatDuration(ms) {
      if (!ms) return '0:00.0';
      const seconds = Math.floor(ms / 1000);
      const tenths = Math.floor((ms % 1000) / 100);
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = (seconds % 60).toString().padStart(2, '0');
      return `${mins}:${secs}.${tenths}`;
    }

    function formatTimer(ms) {
      return formatDuration(ms);
    }

    function startTimer() {
      state.recordingStartTime = Date.now();
      elements.recordingTimer.classList.add('show');
      state.timerInterval = setInterval(() => {
        if (state.recordingStartTime) {
          const elapsed = Date.now() - state.recordingStartTime;
          elements.timerDisplay.textContent = formatTimer(elapsed);
        }
      }, 100);
    }

    function stopTimer() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
      elements.recordingTimer.classList.remove('show');
      elements.timerDisplay.textContent = '00:00.0';
      state.recordingStartTime = null;
    }

    // Encryption/Decryption from home page
    async function encryptMessage(message, chatId) {
      try {
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          encoder.encode("grochat-secret-key-2025"),
          { name: "PBKDF2" },
          false,
          ["deriveBits", "deriveKey"]
        );
        const salt = encoder.encode(chatId);
        const key = await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: 100000,
            hash: "SHA-256"
          },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt"]
        );
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = encoder.encode(message);
        const encrypted = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv: iv },
          key,
          data
        );
        const ivB64 = btoa(String.fromCharCode(...iv));
        const ciphertextB64 = btoa(String.fromCharCode(...new Uint8Array(encrypted)));
        return JSON.stringify({ iv: ivB64, ciphertext: ciphertextB64 });
      } catch (error) {
        console.error('Encryption failed:', error);
        throw error;
      }
    }

    async function decryptMessage(encryptedStr, chatId) {
      try {
        const { iv, ciphertext } = JSON.parse(encryptedStr);
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          encoder.encode("grochat-secret-key-2025"),
          { name: "PBKDF2" },
          false,
          ["deriveBits", "deriveKey"]
        );
        const salt = encoder.encode(chatId);
        const key = await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: 100000,
            hash: "SHA-256"
          },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["decrypt"]
        );
        const ivData = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
        const data = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: ivData },
          key,
          data
        );
        return new TextDecoder().decode(decrypted);
      } catch (error) {
        console.error('Decryption failed:', error);
        return encryptedStr;
      }
    }

    async function markAsRead(messageId) {
      if (!state.chatId || !currentUser) return;
      const readRef = ref(db, `chats/${state.chatId}/messages/${messageId}/readReceipts/${currentUser.uid}`);
      await set(readRef, serverTimestamp());
    }

    function appendMessage(content, isSent, type = 'text', isTyping = false, reactions = {}, readStatus = false, timestamp = Date.now(), messageId = null, recordedDuration = null, edited = false) {
      const div = document.createElement('div');
      div.className = `message ${isSent ? 'sent' : 'received'}${isTyping ? ' processing' : ''}`;
      div.dataset.isSent = isSent.toString();
      div.dataset.type = type;
      if (messageId) {
        div.id = messageId;
        div.dataset.messageId = messageId;
      } else {
        div.dataset.messageId = Date.now().toString(); // Temporary ID for new messages
      }

      if (isTyping) {
        div.innerHTML = '<div class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
      } else {
        if (type === 'image') {
          const img = document.createElement('img');
          img.src = content;
          img.alt = 'Sent image';
          div.appendChild(img);
        } else if (type === 'video') {
          const video = document.createElement('video');
          video.src = content;
          video.controls = true;
          div.appendChild(video);
        } else if (type === 'audio') {
          const audioContainer = document.createElement('div');
          audioContainer.className = 'audio-container';

          const playBtn = document.createElement('button');
          playBtn.className = 'play-btn material-icons';
          playBtn.textContent = 'play_arrow';
          playBtn.title = 'Play';

          const waveform = document.createElement('div');
          waveform.className = 'waveform';
          for (let i = 0; i < 6; i++) {
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            if (i === 1) bar.style.height = '15px';
            if (i === 2) bar.style.height = '25px';
            if (i === 3) bar.style.height = '20px';
            if (i === 4) bar.style.height = '18px';
            if (i === 5) bar.style.height = '22px';
            waveform.appendChild(bar);
          }
          waveform.style.display = 'none';

          const timerSpan = document.createElement('span');
          timerSpan.className = 'audio-timer';
          timerSpan.textContent = '0:00 / 0:00';

          audioContainer.appendChild(playBtn);
          audioContainer.appendChild(waveform);
          audioContainer.appendChild(timerSpan);

          const audio = document.createElement('audio');
          audio.src = content;
          audio.preload = 'metadata';
          audio.style.display = 'none';
          div.appendChild(audio);

          let isPlaying = false;
          let totalDuration = recordedDuration || 0;

          audio.addEventListener('loadedmetadata', () => {
            totalDuration = audio.duration * 1000; // Convert to ms
            updateTimer(0, totalDuration);
          });

          function updateTimer(currentMs, totalMs) {
            const currentFormatted = formatDuration(currentMs);
            const totalFormatted = formatDuration(totalMs);
            timerSpan.textContent = `${currentFormatted} / ${totalFormatted}`;
          }

          audio.addEventListener('timeupdate', () => {
            if (isPlaying) {
              updateTimer(audio.currentTime * 1000, totalDuration);
            }
          });

          playBtn.addEventListener('click', () => {
            if (isPlaying) {
              audio.pause();
              playBtn.textContent = 'play_arrow';
              playBtn.title = 'Play';
              waveform.style.display = 'none';
              isPlaying = false;
              updateTimer(audio.currentTime * 1000, totalDuration);
            } else {
              audio.play().catch(e => console.error('Playback failed:', e));
              playBtn.textContent = 'pause';
              playBtn.title = 'Pause';
              waveform.style.display = 'flex';
              isPlaying = true;
            }
          });

          audio.addEventListener('ended', () => {
            playBtn.textContent = 'play_arrow';
            playBtn.title = 'Play';
            waveform.style.display = 'none';
            isPlaying = false;
            updateTimer(totalDuration, totalDuration);
          });

          audio.addEventListener('pause', () => {
            if (isPlaying) {
              playBtn.textContent = 'play_arrow';
              playBtn.title = 'Play';
              waveform.style.display = 'none';
              isPlaying = false;
              updateTimer(audio.currentTime * 1000, totalDuration);
            }
          });

          div.appendChild(audioContainer);
        } else {
          div.textContent = content;
        }

        // Add reactions container
        const reactionsDiv = document.createElement('div');
        reactionsDiv.className = 'message-reactions';
        renderReactions(reactionsDiv, reactions);
        div.appendChild(reactionsDiv);

        // Add timestamp
        const timestampDiv = document.createElement('div');
        timestampDiv.className = 'message-timestamp';
        timestampDiv.textContent = formatRelativeTime(timestamp);
        div.appendChild(timestampDiv);

        if (edited) {
          const editedSpan = document.createElement('span');
          editedSpan.className = 'edited-label';
          editedSpan.textContent = '  edited';
          timestampDiv.appendChild(editedSpan);
        }

        // Add read receipt status for sent messages
        if (isSent) {
          const statusDiv = document.createElement('div');
          statusDiv.className = 'message-status';
          const statusSpan = document.createElement('span');
          statusSpan.className = `status-${readStatus ? 'read' : 'sent'}`;
          statusSpan.textContent = readStatus ? '' : '';
          statusDiv.appendChild(statusSpan);
          div.appendChild(statusDiv);
        }
      }

      state.messages.push({ content, isSent, type, timestamp, reactions, id: messageId, recordedDuration, edited });
      elements.chatMessages.appendChild(div);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

      // Add long press/tap to show context menu
      let pressTimer;
      let startTime;
      div.addEventListener('touchstart', (e) => {
        startTime = Date.now();
        pressTimer = setTimeout(() => showContextMenu(div), 500);
      });
      div.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
        if (Date.now() - startTime < 500) {
          // Short tap - do nothing or select message if needed
        }
      });
      div.addEventListener('mousedown', (e) => {
        startTime = Date.now();
        pressTimer = setTimeout(() => showContextMenu(div), 500);
      });
      div.addEventListener('mouseup', () => clearTimeout(pressTimer));

      return div;
    }

    function renderReactions(container, reactions) {
      container.innerHTML = '';
      Object.entries(reactions).forEach(([emoji, users]) => {
        const reactionSpan = document.createElement('span');
        reactionSpan.className = 'reaction';
        reactionSpan.textContent = `${emoji} ${Object.keys(users).length}`;
        reactionSpan.onclick = (e) => {
          e.stopPropagation();
          toggleReaction(emoji);
        };
        container.appendChild(reactionSpan);
      });
    }

    function showContextMenu(messageEl) {
      state.currentSelectedMessageEl = messageEl;
      state.currentSelectedMessageId = messageEl.id || messageEl.dataset.messageId;
      elements.contextMenu.innerHTML = '';

      const reactBtn = document.createElement('button');
      reactBtn.textContent = 'React';
      reactBtn.onclick = (e) => {
        e.stopPropagation();
        hideContextMenu();
        showReactionPicker(messageEl);
      };
      elements.contextMenu.appendChild(reactBtn);

      const isSentMsg = messageEl.dataset.isSent === 'true';
      const msgType = messageEl.dataset.type;
      if (isSentMsg && msgType === 'text') {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          hideContextMenu();
          startEdit(messageEl);
        };
        elements.contextMenu.appendChild(editBtn);
      }

      const rect = messageEl.getBoundingClientRect();
      elements.contextMenu.style.top = `${rect.bottom + window.scrollY}px`;
      elements.contextMenu.style.left = `${rect.left + window.scrollX}px`;
      elements.contextMenu.style.display = 'block';
    }

    function hideContextMenu() {
      elements.contextMenu.style.display = 'none';
    }

    function showReactionPicker(messageEl) {
      state.currentSelectedMessageId = messageEl.dataset.messageId || messageEl.id; // Use real ID if available
      elements.reactionPicker.style.display = 'flex';
      const rect = messageEl.getBoundingClientRect();
      elements.reactionPicker.style.bottom = `${window.innerHeight - rect.top + 10}px`;
      elements.reactionPicker.style.left = `${rect.left}px`;
    }

    function hideReactionPicker() {
      elements.reactionPicker.style.display = 'none';
      state.currentSelectedMessageId = null;
    }

    async function addReaction(emoji) {
      if (!state.currentSelectedMessageId || !state.chatId) return;
      const reactionsRef = ref(db, `chats/${state.chatId}/messages/${state.currentSelectedMessageId}/reactions/${currentUser.uid}`);
      await set(reactionsRef, emoji);
      hideReactionPicker();
    }

    async function toggleReaction(emoji) {
      if (!state.currentSelectedMessageId || !state.chatId) return;
      const myReactionRef = ref(db, `chats/${state.chatId}/messages/${state.currentSelectedMessageId}/reactions/${currentUser.uid}`);
      const snapshot = await get(myReactionRef);
      if (snapshot.exists() && snapshot.val() === emoji) {
        // Remove reaction
        await set(myReactionRef, null);
      } else {
        // Add reaction
        await set(myReactionRef, emoji);
      }
    }

    async function startEdit(messageEl) {
      const messageId = messageEl.id || messageEl.dataset.messageId;
      const currentContentNode = messageEl.firstChild;
      if (currentContentNode.nodeType !== Node.TEXT_NODE) return;
      const currentContent = currentContentNode.textContent;

      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentContent;
      input.style.width = '100%';
      input.style.border = 'none';
      input.style.outline = 'none';
      input.style.background = 'transparent';
      input.style.fontSize = 'inherit';
      input.style.color = 'inherit';
      messageEl.replaceChild(input, currentContentNode);
      input.focus();
      input.select();

      const saveEdit = async () => {
        const newContent = input.value.trim();
        const textNode = document.createTextNode(newContent || currentContent);
        messageEl.replaceChild(textNode, input);

        if (newContent && newContent !== currentContent) {
          try {
            const encrypted = await encryptMessage(newContent, state.chatId);
            const msgRef = ref(db, `chats/${state.chatId}/messages/${messageId}`);
            await update(msgRef, {
              message: encrypted,
              edited: true,
              editedTimestamp: serverTimestamp()
            });

            // Optimistic update for edited label
            const timestampDiv = messageEl.querySelector('.message-timestamp');
            let editedSpan = messageEl.querySelector('.edited-label');
            if (!editedSpan) {
              editedSpan = document.createElement('span');
              editedSpan.className = 'edited-label';
              editedSpan.textContent = '  edited';
              timestampDiv.appendChild(editedSpan);
            }
          } catch (error) {
            console.error('Edit failed:', error);
            // Revert on error
            messageEl.replaceChild(document.createTextNode(currentContent), textNode);
          }
        }
      };

      input.onblur = saveEdit;
      input.onkeypress = (e) => {
        if (e.key === 'Enter') {
          saveEdit();
          e.preventDefault();
        }
      };
    }

    // Close pickers on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.reaction-picker') && !e.target.closest('.message') && !e.target.closest('.context-menu')) {
        hideReactionPicker();
        hideContextMenu();
      }
    });

    elements.reactionPicker.addEventListener('click', (e) => {
      if (e.target.dataset.emoji) {
        addReaction(e.target.dataset.emoji);
      }
    });

    async function sendMessage(message, type = 'text', recordedDuration = null) {
      if (!state.chatId || !currentUser) return;
      try {
        const encrypted = await encryptMessage(message, state.chatId);
        const messagesRef = ref(db, `chats/${state.chatId}/messages`);
        const newMessageRef = push(messagesRef);
        const newMessageId = newMessageRef.key;
        await set(newMessageRef, {
          senderId: currentUser.uid,
          message: encrypted,
          type: type,
          timestamp: serverTimestamp(),
          reactions: {},
          readReceipts: {},
          recordedDuration: type === 'audio' ? recordedDuration : null,
          edited: false
        });
        // Update last message for both users
        const currentUserChatsRef = ref(db, `users/${currentUser.uid}/chats/${state.otherUserId}`);
        await update(currentUserChatsRef, {
          lastMessage: encrypted,
          lastMessageType: type,
          lastMessageTime: Date.now(),
          unreadCount: 0
        });
        const otherUserChatsRef = ref(db, `users/${state.otherUserId}/chats/${currentUser.uid}`);
        await update(otherUserChatsRef, {
          lastMessage: encrypted,
          lastMessageType: type,
          lastMessageTime: Date.now()
        });
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }

    async function handleMediaUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      try {
        showSpinner();
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`);
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', cloudinaryConfig.uploadPreset);
        const url = await new Promise((resolve, reject) => {
          xhr.onload = () => {
            if (xhr.status === 200) {
              const data = JSON.parse(xhr.responseText);
              resolve(data.secure_url);
            } else {
              reject(new Error(`Upload failed: ${xhr.statusText}`));
            }
          };
          xhr.onerror = reject;
          xhr.send(formData);
        });
        const type = file.type.startsWith('image/') ? 'image' : 'video';
        appendMessage(url, true, type, false, {}, false, Date.now());
        await sendMessage(url, type);
        elements.mediaInput.value = '';
      } catch (error) {
        console.error('Media upload failed:', error);
        showAlert('Failed to upload media.');
      } finally {
        hideSpinner();
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        state.mediaRecorder = new MediaRecorder(stream);
        state.audioChunks = [];
        state.mediaRecorder.ondataavailable = (event) => {
          state.audioChunks.push(event.data);
        };
        state.mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
          const recordedDuration = Date.now() - state.recordingStartTime;
          await uploadAudio(audioBlob, recordedDuration);
          state.audioChunks = [];
          stream.getTracks().forEach(track => track.stop());
        };
        state.mediaRecorder.start();
        state.isRecording = true;
        elements.voiceButton.classList.add('recording');
        elements.voiceButton.innerHTML = 'stop';
        startTimer();
      } catch (err) {
        console.error('Error accessing microphone', err);
        showAlert('Could not access microphone.');
      }
    }

    function stopRecording() {
      if (state.mediaRecorder && state.isRecording) {
        state.mediaRecorder.stop();
        state.isRecording = false;
        elements.voiceButton.classList.remove('recording');
        elements.voiceButton.innerHTML = 'mic';
        stopTimer();
      }
    }

    async function uploadAudio(blob, recordedDuration) {
      try {
        showSpinner();
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`);
        const formData = new FormData();
        formData.append('file', blob, 'voice-note.wav');
        formData.append('upload_preset', cloudinaryConfig.uploadPreset);
        const url = await new Promise((resolve, reject) => {
          xhr.onload = () => {
            if (xhr.status === 200) {
              const data = JSON.parse(xhr.responseText);
              resolve(data.secure_url);
            } else {
              reject(new Error(`Upload failed: ${xhr.statusText}`));
            }
          };
          xhr.onerror = reject;
          xhr.send(formData);
        });
        appendMessage(url, true, 'audio', false, {}, false, Date.now(), null, recordedDuration);
        await sendMessage(url, 'audio', recordedDuration);
      } catch (error) {
        console.error('Audio upload failed:', error);
        showAlert('Failed to upload voice note.');
      } finally {
        hideSpinner();
      }
    }

    function showSpinner() {
      elements.loadingOverlay.classList.remove('hidden');
    }

    function hideSpinner() {
      elements.loadingOverlay.classList.add('hidden');
    }

    function showAlert(message) {
      const alert = elements.alertMessage;
      alert.textContent = message;
      alert.classList.add('active');
      setTimeout(() => alert.classList.remove('active'), 4000);
    }

    function setupTypingListener() {
      const typingRef = ref(db, `chats/${state.chatId}/typing`);
      onValue(typingRef, (snapshot) => {
        const typing = snapshot.val();
        if (typing && typing[state.otherUserId] && !typing[currentUser.uid]) {
          if (!state.typing) {
            appendMessage('', false, 'typing', true, {});
            state.typing = true;
          }
        } else {
          if (state.typing) {
            const typingEl = elements.chatMessages.lastElementChild;
            if (typingEl && typingEl.querySelector('.typing-indicator')) {
              typingEl.remove();
            }
            state.typing = false;
          }
        }
      });
    }

    function sendTypingEvent(isTyping) {
      if (!state.chatId) return;
      const typingRef = ref(db, `chats/${state.chatId}/typing`);
      set(typingRef, {
        [currentUser.uid]: isTyping,
        [state.otherUserId]: false
      });
    }

    function setupPresenceListener() {
      if (!state.otherUserId) return;

      const userPresenceRef = ref(db, `users/${state.otherUserId}/presence`);
      state.statusListener = onValue(userPresenceRef, (snapshot) => {
        const presence = snapshot.val();
        const statusEl = elements.chatHeaderStatus;
        statusEl.classList.remove('status-online', 'status-offline', 'status-last-seen');

        if (presence && presence.state === 'online') {
          statusEl.textContent = 'Online';
          statusEl.classList.add('status-online');
        } else if (presence && presence.lastSeen) {
          const lastSeenMs = presence.lastSeen ? (presence.lastSeen.toMillis ? presence.lastSeen.toMillis() : presence.lastSeen) : 0;
          const statusText = `Last seen ${formatRelativeTime(lastSeenMs)}`;
          statusEl.textContent = statusText;
          statusEl.classList.add('status-last-seen');
        } else {
          statusEl.textContent = 'Offline';
          statusEl.classList.add('status-offline');
        }
      });
    }

    function setUserPresence(presenceState) {
      if (!currentUser) return;
      const userPresenceRef = ref(db, `users/${currentUser.uid}/presence`);
      set(userPresenceRef, {
        state: presenceState,
        lastSeen: presenceState === 'offline' ? serverTimestamp() : null
      });
    }

    async function loadChatHistory() {
      if (!state.chatId) return;
      const messagesRef = ref(db, `chats/${state.chatId}/messages`);

      // Load initial messages
      const snapshot = await get(messagesRef);
      let messages = [];
      if (snapshot.exists()) {
        messages = Object.entries(snapshot.val())
          .map(([id, msg]) => ({ id, ...msg }))
          .sort((a, b) => {
            const tsA = a.timestamp ? (a.timestamp.toMillis ? a.timestamp.toMillis() : a.timestamp) : 0;
            const tsB = b.timestamp ? (b.timestamp.toMillis ? b.timestamp.toMillis() : b.timestamp) : 0;
            return tsA - tsB;
          });
        elements.chatMessages.innerHTML = '';
        state.loadedMessages.clear();
        for (let msg of messages) {
          let content = msg.type === 'text' ? await decryptMessage(msg.message, state.chatId) : msg.message;
          const reactions = msg.reactions || {};
          const isSent = msg.senderId === currentUser.uid;
          let readStatus = false;
          if (isSent && msg.readReceipts && msg.readReceipts[state.otherUserId]) {
            readStatus = true;
          }
          const timestamp = msg.timestamp ? (msg.timestamp.toMillis ? msg.timestamp.toMillis() : msg.timestamp) : Date.now();
          const recordedDuration = msg.recordedDuration || null;
          const edited = msg.edited || false;
          appendMessage(content, isSent, msg.type, false, reactions, readStatus, timestamp, msg.id, recordedDuration, edited);
          state.loadedMessages.add(msg.id);
        }
      }
      if (messages.length === 0) {
        elements.welcomeContainer.classList.remove('hidden');
      } else {
        elements.welcomeContainer.classList.add('hidden');
        state.hasChatted = true;
      }
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

      // Mark unread received messages as read
      const unreadMessageIds = messages
        .filter(msg => msg.senderId !== currentUser.uid && (!msg.readReceipts || !msg.readReceipts[currentUser.uid]))
        .map(msg => msg.id);
      for (const id of unreadMessageIds) {
        await markAsRead(id);
      }

      // Listen for new messages
      onChildAdded(messagesRef, async (snapshot) => {
        const msg = snapshot.val();
        const messageId = snapshot.key;
        if (state.loadedMessages.has(messageId)) return; // Already loaded

        let content = msg.type === 'text' ? await decryptMessage(msg.message, state.chatId) : msg.message;
        const reactions = msg.reactions || {};
        const isSent = msg.senderId === currentUser.uid;
        let readStatus = false;
        if (isSent && msg.readReceipts && msg.readReceipts[state.otherUserId]) {
          readStatus = true;
        }
        const timestamp = msg.timestamp ? (msg.timestamp.toMillis ? msg.timestamp.toMillis() : msg.timestamp) : Date.now();
        const recordedDuration = msg.recordedDuration || null;
        const edited = msg.edited || false;
        appendMessage(content, isSent, msg.type, false, reactions, readStatus, timestamp, messageId, recordedDuration, edited);
        state.loadedMessages.add(messageId);

        if (!isSent) {
          await markAsRead(messageId);
        }
      });

      // Listen for message changes (edits, reactions, etc.)
      onChildChanged(messagesRef, async (snapshot) => {
        const messageId = snapshot.key;
        const msg = snapshot.val();
        const el = document.getElementById(messageId);
        if (!el) return;

        let newContent = msg.type === 'text' ? await decryptMessage(msg.message, state.chatId) : msg.message;

        // Update content if text
        if (msg.type === 'text') {
          const textNode = el.firstChild;
          if (textNode && textNode.nodeType === Node.TEXT_NODE) {
            textNode.textContent = newContent;
          }
        }

        // Update reactions
        const reactionsDiv = el.querySelector('.message-reactions');
        if (reactionsDiv) {
          renderReactions(reactionsDiv, msg.reactions || {});
        }

        // Update edited label
        const timestampDiv = el.querySelector('.message-timestamp');
        let editedSpan = el.querySelector('.edited-label');
        if (msg.edited && !editedSpan) {
          editedSpan = document.createElement('span');
          editedSpan.className = 'edited-label';
          editedSpan.textContent = '  edited';
          timestampDiv.appendChild(editedSpan);
        } else if (!msg.edited && editedSpan) {
          editedSpan.remove();
        }

        // Update read status if sent
        if (msg.senderId === currentUser.uid) {
          const statusDiv = el.querySelector('.message-status');
          if (statusDiv) {
            const statusSpan = statusDiv.querySelector('span');
            if (statusSpan) {
              const isRead = msg.readReceipts && msg.readReceipts[state.otherUserId];
              statusSpan.className = `status-${isRead ? 'read' : 'sent'}`;
              statusSpan.textContent = isRead ? '' : '';
            }
          }
        }
      });

      setupTypingListener();
      setupPresenceListener();
    }

    async function initializeChat() {
      const urlParams = new URLSearchParams(window.location.search);
      state.chatId = urlParams.get('chatId');
      state.otherUserId = urlParams.get('userId');
      if (!state.chatId || !state.otherUserId) {
        showAlert('Invalid chat ID');
        window.history.back();
        return;
      }
      try {
        showSpinner();
        // Load other user data
        const otherUserRef = ref(db, `users/${state.otherUserId}`);
        const otherSnapshot = await get(otherUserRef);
        if (otherSnapshot.exists()) {
          state.otherUserData = otherSnapshot.val();
          const initial = state.otherUserData.displayName ? state.otherUserData.displayName[0].toUpperCase() : 'U';
          elements.chatHeaderAvatar.innerHTML = state.otherUserData.photoURL ? `<img src="${state.otherUserData.photoURL}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : initial;
          elements.chatHeaderName.textContent = state.otherUserData.displayName || 'User';
          // Initial status will be updated by listener
          elements.chatHeaderStatus.textContent = 'Loading...';
        }
        await loadChatHistory();
      } catch (error) {
        console.error('Error initializing chat:', error);
        showAlert('Failed to load chat');
      } finally {
        hideSpinner();
      }
    }

    async function toggleDarkMode() {
      const isDark = !document.body.classList.contains('dark');
      document.body.classList.toggle('dark', isDark);
      document.body.classList.toggle('light', !isDark);
      state.isDarkMode = isDark;
      localStorage.setItem('darkMode', isDark);
      showAlert(isDark ? 'Dark mode enabled' : 'Light mode enabled');
    }

    async function initializeFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      analytics = getAnalytics(app);
      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        setUserId(analytics, user.uid);
        // Set user presence to online on auth
        setUserPresence('online');
        // Set offline on disconnect
        const connectedRef = ref(db, `.info/connected`);
        onValue(connectedRef, (snap) => {
          if (snap.val() === true) {
            const userPresenceRef = ref(db, `users/${currentUser.uid}/presence`);
            onDisconnect(userPresenceRef).set({
              state: 'offline',
              lastSeen: serverTimestamp()
            });
          }
        });
        initializeChat();
      });
    }

    elements.sendButton.addEventListener('click', async () => {
      const message = elements.chatInput.value.trim();
      if (!message) return;
      sendTypingEvent(false);
      appendMessage(message, true, 'text', false, {}, false, Date.now());
      await sendMessage(message);
      elements.chatInput.value = '';
      elements.chatInput.focus();
    });

    elements.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        elements.sendButton.click();
        e.preventDefault();
      } else {
        sendTypingEvent(true);
        setTimeout(() => sendTypingEvent(false), 2000);
      }
    });

    elements.mediaButton.addEventListener('click', () => {
      elements.mediaInput.click();
    });

    elements.emojiButton.addEventListener('click', () => {
      elements.emojiPicker.style.display = elements.emojiPicker.style.display === 'grid' ? 'none' : 'grid';
      if (elements.emojiPicker.style.display === 'grid') {
        elements.emojiPicker.innerHTML = emojis.map(emoji => `<button class="emoji-btn" onclick="insertEmoji('${emoji}')">${emoji}</button>`).join('');
      }
    });

    window.insertEmoji = (emoji) => {
      elements.chatInput.value += emoji;
      elements.chatInput.focus();
      elements.emojiPicker.style.display = 'none';
    };

    // Voice recording events
    elements.voiceButton.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startRecording();
    }, { passive: false });

    elements.voiceButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      stopRecording();
    }, { passive: false });

    elements.voiceButton.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startRecording();
    });

    elements.voiceButton.addEventListener('mouseup', (e) => {
      e.preventDefault();
      stopRecording();
    });

    elements.darkModeBtn.addEventListener('click', toggleDarkMode);

    // Load dark mode preference
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) {
      state.isDarkMode = true;
      document.body.classList.add('dark');
      document.body.classList.remove('light');
    } else {
      state.isDarkMode = false;
      document.body.classList.add('light');
      document.body.classList.remove('dark');
    }

    window.addEventListener('beforeunload', () => {
      setUserPresence('offline');
      sendTypingEvent(false);
      if (state.messagesListener) {
        state.messagesListener();
      }
      if (state.statusListener) {
        state.statusListener();
      }
      if (state.isRecording) {
        stopRecording();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      showSpinner();
      initializeFirebase();
    });
  </script>
</body>
</html>
