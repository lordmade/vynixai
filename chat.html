<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ff2a6d">
  <title>Chats • Vynix</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#ff2a6d;--bg:#ffffff;--text:#0f1419;--text2:#536471;--border:#eff3f4}
    [data-theme="dark"]{--bg:#000000;--text:#e7e9ea;--text2:#71767b;--border:#2f3336}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);padding-bottom:80px;-webkit-user-select:none;user-select:none}
    .chat-item{display:flex;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;position:relative}
    .chat-item:hover{background:rgba(255,42,109,.06)}
    .chat-avatar{width:52px;height:52px;border-radius:50%;object-fit:cover}
    .chat-name{font-weight:700;font-size:16px}
    .chat-last{font-size:14px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .chat-time{font-size:13px;color:var(--text2);margin-left:auto}
    .unread-dot{position:absolute;top:14px;right:14px;width:10px;height:10px;background:var(--accent);border-radius:50%}
    .empty{text-align:center;padding:60px 20px;color:var(--text2)}
  </style>
</head>
<body>

<header class="sticky top-0 bg-[var(--bg)] px-4 py-3 border-b border-[var(--border)] z-10">
  <h1 class="text-xl font-bold">Chats</h1>
</header>

<main id="list" class="pb-20">
  <div class="empty">Loading chats…</div>
</main>

<!-- bottom nav – chat tab highlighted -->
<nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 z-40">
  <div class="h-full flex items-center justify-around text-gray-500">
    <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons text-24">home</span>
      <span class="text-xs mt-0.5">Home</span>
    </a>
    <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full text-[#ff2a6d]">
      <span class="material-icons text-24">chat_bubble_outline</span>
      <span class="text-xs mt-0.5 font-bold">Chat</span>
    </a>
    <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons text-24">search</span>
      <span class="text-xs mt-0.5">Search</span>
    </a>
    <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons text-24">auto_awesome</span>
      <span class="text-xs mt-0.5">AI</span>
    </a>
    <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons text-24">notifications</span>
      <span class="text-xs mt-0.5">Alerts</span>
    </a>
    <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons text-24">person</span>
      <span class="text-xs mt-0.5">Profile</span>
    </a>
  </div>
</nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db  = getDatabase(app);

let myUid, myName, myAvatar;
const listEl = document.getElementById('list');

onAuthStateChanged(auth, user => {
  if (!user) return;
  myUid   = user.uid;
  myName  = user.displayName || 'User';
  myAvatar= user.photoURL || `https://ui-avatars.com/api/?name=${myName}&background=ff2a6d&color=fff`;
  loadChatsList();
});

/* ----------  people you follow (same list as profile page)  ---------- */
async function loadChatsList() {
  const followingSnap = await get(ref(db, `social/${myUid}/following`));
  const followingUids = [];
  followingSnap.forEach(c => followingUids.push(c.key));

  if (!followingUids.length) {
    listEl.innerHTML = '<div class="empty">No chats yet<br><span class="text-sm">Follow someone to start</span></div>';
    return;
  }

  const rows = await Promise.all(
    followingUids.map(async uid => {
      const uSnap  = await get(ref(db, `users/${uid}/profile`));
      const u      = uSnap.val() || {};
      const roomId = [myUid, uid].sort().join('_');
      const last   = (await get(ref(db, `lastMessage/${roomId}`))).val() || { text: 'No messages yet', time: 0, unread: false };
      return {
        uid,
        name: u.displayName || 'User',
        avatar: u.avatar || u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName || 'User'}&background=ff2a6d&color=fff`,
        roomId,
        last
      };
    })
  );

  rows.sort((a, b) => (b.last.time || 0) - (a.last.time || 0));
  renderRows(rows);
}

function renderRows(rows) {
  listEl.innerHTML = rows.map(r => `
    <div class="chat-item" data-room="${r.roomId}" data-other="${r.uid}">
      <img src="${r.avatar}" class="chat-avatar">
      <div class="flex-1 min-w-0">
        <div class="chat-name">${esc(r.name)}</div>
        <div class="chat-last">${esc(r.last.text)}</div>
      </div>
      <div class="chat-time">${timeAgo(r.last.time)}</div>
      ${r.last.unread ? '<span class="unread-dot"></span>' : ''}
    </div>`).join('');
}

/* ----------  open room  ---------- */
listEl.addEventListener('click', e => {
  const card = e.target.closest('.chat-item');
  if (!card) return;
  const roomId = card.dataset.room;
  const otherUid = card.dataset.other;
  location.href = `room.html#${roomId}|${otherUid}`;
});

/* ----------  utils  ---------- */
function esc(str) {
  return str.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}
function timeAgo(t) {
  if (!t) return '';
  const s = Math.floor((Date.now() - t) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
}

/* theme */
if (matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
</script>

</body>
</html>
