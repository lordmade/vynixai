<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ff2a6d">
  <title>Chats • Vynix</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#ff2a6d;--bg:#ffffff;--text:#0f1419;--text2:#536471;--border:#eff3f4}
    [data-theme="dark"]{--bg:#000000;--text:#e7e9ea;--text2:#71767b;--border:#2f3336}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:80px;min-height:100vh;-webkit-user-select:none;user-select:none}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);padding:14px 16px;z-index:10;backdrop-filter:blur(12px);}
    .chat-item{display:flex;gap:14px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;position:relative;transition:bg .2s;}
    .chat-item:hover{background:rgba(255,42,109,.06);}
    .chat-item:active{background:rgba(255,42,109,.12);}
    .chat-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;flex-shrink:0;}
    .info{flex:1;min-width:0;}
    .chat-name{font-weight:700;font-size:16px;}
    .chat-last{font-size:14.5px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .chat-time{font-size:13px;color:var(--text2);}
    .unread-dot{position:absolute;top:18px;right:16px;width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 0 3px var(--bg);}
    .empty{text-align:center;padding:80px 20px;color:var(--text2);font-size:15px;}
    /* Shimmer */
    .shimmer{animation:shimmer 1.5s infinite linear;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;border-radius:8px;}
    [data-theme="dark"] .shimmer{background:linear-gradient(90deg,#1a1a1a 25%,#222 50%,#1a1a1a 75%);}
    @keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
    .skeleton-avatar{width:56px;height:56px;border-radius:50%;background:#e0e0e0;}
    .skeleton-line{height:16px;border-radius:4px;background:#e0e0e0;margin:6px 0;}
    .skeleton-line.short{width:60%;}
    .skeleton-line.long{width:85%;}
  </style>
</head>
<body>

<header>
  <h1 class="text-2xl font-extrabold" style="color:var(--accent);">Chats</h1>
</header>

<main id="list" class="pb-20">
  <!-- Shimmer Skeleton -->
  <div id="skeleton">
    ${Array(6).fill().map(() => `
      <div class="chat-item">
        <div class="skeleton-avatar shimmer"></div>
        <div class="info">
          <div class="skeleton-line short shimmer"></div>
          <div class="skeleton-line long shimmer"></div>
        </div>
      </div>
    `).join('')}
  </div>
</main>

<!-- Bottom Nav – identical to profile page -->
<nav class="fixed bottom-0 left-0 right-0 h-16 bg-[var(--bg)] border-t border-[var(--border)] z-40">
  <div class="h-full flex items-center justify-around text-[var(--text2)]">
    <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">home</span>
      <span class="text-xs mt-0.5">Home</span>
    </a>
    <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]">
      <span class="material-icons text-2xl">chat_bubble</span>
      <span class="text-xs mt-0.5 font-bold">Chat</span>
    </a>
    <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">search</span>
      <span class="text-xs mt-0.5">Search</span>
    </a>
    <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">auto_awesome</span>
      <span class="text-xs mt-0.5">AI</span>
    </a>
    <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">notifications</span>
      <span class="text-xs mt-0.5">Alerts</span>
    </a>
    <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">person</span>
      <span class="text-xs mt-0.5">Profile</span>
    </a>
  </div>
</nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

const listEl = document.getElementById('list');
let myUid    = null;

/* dark-mode */
if (window.matchMedia('(prefers-color-scheme: dark)').matches)
  document.documentElement.setAttribute('data-theme', 'dark');

onAuthStateChanged(auth, user => {
  if (!user) { location.href = 'login.html'; return; }
  myUid = user.uid;
  setupRealtimeChats();
});

function setupRealtimeChats() {
  const followingRef = ref(db, `social/${myUid}/following`);
  onValue(followingRef, snap => {
    const uids = snap.exists() ? Object.keys(snap.val() || {}) : [];
    if (!uids.length) {
      listEl.innerHTML = '<div class="empty">No chats yet<br><small>Follow someone to start messaging</small></div>';
      return;
    }
    if (listEl.querySelector('#skeleton')) listEl.innerHTML = '';

    uids.forEach(uid => {
      const roomId     = [myUid, uid].sort().join('_');
      const profileRef = ref(db, `users/${uid}/profile`);
      const lastMsgRef = ref(db, `lastMessage/${roomId}`);

      let profile = {};
      let lastMsg = { text: 'No messages yet', time: 0, unread: false };

      const updateRow = () => {
        let el = document.getElementById(`chat-${uid}`);
        if (!el) {
          el = document.createElement('div');
          el.className = 'chat-item';
          el.id        = `chat-${uid}`;
          el.dataset.room  = roomId;
          el.dataset.other = uid;
          listEl.appendChild(el);
        }

        el.innerHTML = `
          <img src="${profile.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.displayName || 'User')}&background=ff2a6d&color=fff&bold=true`}" class="chat-avatar">
          <div class="info">
            <div class="chat-name">${escapeHtml(profile.displayName || 'User')}</div>
            <div class="chat-last">${escapeHtml(lastMsg.text || 'No messages yet')}</div>
          </div>
          <div class="chat-time" data-time="${lastMsg.time}">${timeAgo(lastMsg.time)}</div>
          ${lastMsg.unread === myUid ? '<div class="unread-dot"></div>' : ''}`;

        sortChatList();
      };

      onValue(profileRef, s => { profile = s.val() || {}; updateRow(); });
      onValue(lastMsgRef, s => { lastMsg = s.val() || { text: 'No messages yet', time: 0, unread: false }; updateRow(); });
    });
  });
}

/* keep list ordered by most recent */
function sortChatList() {
  const items = [...listEl.querySelectorAll('.chat-item')];
  items.sort((a, b) => {
    const ta = Number(a.querySelector('.chat-time').dataset.time || 0);
    const tb = Number(b.querySelector('.chat-time').dataset.time || 0);
    return tb - ta;
  });
  items.forEach(item => listEl.appendChild(item));
}

/* open room */
listEl.addEventListener('click', e => {
  const card = e.target.closest('.chat-item');
  if (!card) return;
  location.href = `room.html#${card.dataset.room}|${card.dataset.other}`;
});

/* helpers */
function escapeHtml(str) {
  return str.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}
function timeAgo(ts) {
  if (!ts) return '';
  const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
}
</script>
</body>
</html>
