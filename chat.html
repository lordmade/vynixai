<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ff2a6d">
  <title>Chats • Vynix</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#ff2a6d;--bg:#ffffff;--text:#0f1419;--text2:#536471;--border:#eff3f4}
    [data-theme="dark"]{--bg:#000000;--text:#e7e9ea;--text2:#71767b;--border:#2f3336}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);padding-bottom:80px;margin:0;min-height:100vh;}
    *{-webkit-tap-highlight-color:transparent;}
    header{
      position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);padding:12px 16px;z-index:10;
      backdrop-filter:blur(12px);
    }
    .chat-item{
      display:flex;gap:14px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;position:relative;
      transition:background .15s;
    }
    .chat-item:hover{background:rgba(255,42,109,.05);}
    .chat-item:active{background:rgba(255,42,109,.1);}
    .chat-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;flex-shrink:0;}
    .info{flex:1;min-width:0;}
    .chat-name{font-weight:700;font-size:16px;line-height:1.3;}
    .chat-last{font-size:14.5px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .chat-time{font-size:13px;color:var(--text2);align-self:start;}
    .unread-dot{
      position:absolute;top:18px;right:16px;width:10px;height:10px;background:var(--accent);border-radius:50%;
      box-shadow:0 0 0 3px var(--bg);
    }
    .empty{text-align:center;padding:80px 20px;color:var(--text2);font-size:15px;}
  </style>
</head>
<body>

<header>
  <h1 class="text-2xl font-extrabold" style="color:var(--accent);">Chats</h1>
</header>

<main id="list" class="pb-20">
  <div class="empty">Loading your chats…</div>
</main>

<!-- Bottom Navigation -->
<nav class="fixed bottom-0 left-0 right-0 h-16 bg-[var(--bg)] border-t border-[var(--border)] z-40">
  <div class="h-full flex items-center justify-around text-[var(--text2)]">
    <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">home</span>
      <span class="text-xs mt-0.5">Home</span>
    </a>
    <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]">
      <span class="material-icons text-2xl">chat_bubble</span>
      <span class="text-xs mt-0.5 font-bold">Chat</span>
    </a>
    <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">search</span>
      <span class="text-xs mt-0.5">Search</span>
    </a>
    <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">auto_awesome</span>
      <span class="text-xs mt-0.5">AI</span>
    </a>
    <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">notifications</span>
      <span class="text-xs mt-0.5">Alerts</span>
    </a>
    <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
      <span class="material-icons-outlined text-2xl">person</span>
      <span class="text-xs mt-0.5">Profile</span>
    </a>
  </div>
</nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const listEl = document.getElementById('list');
let myUid = null;

// Dark mode
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.setAttribute('data-theme', 'dark');
}

onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = 'login.html';
    return;
  }
  myUid = user.uid;
  loadChatsList();
});

async function loadChatsList() {
  const followingRef = ref(db, `social/${myUid}/following`);
  onValue(followingRef, async (snap) => {
    const uids = snap.exists() ? Object.keys(snap.val()) : [];

    if (uids.length === 0) {
      listEl.innerHTML = `<div class="empty">No chats yet<br><span class="text-sm">Follow someone to start messaging</span></div>`;
      return;
    }

    const rows = await Promise.all(uids.map(async (uid) => {
      // User profile
      const profileSnap = await get(ref(db, `users/${uid}/profile`));
      const p = profileSnap.val() || {};
      const name = p.displayName || 'User';
      const avatar = p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ff2a6d&color=fff&bold=true`;

      // Room ID (sorted so both users have same room)
      const roomId = [myUid, uid].sort().join('_');

      // Last message preview
      const lastMsgSnap = await get(ref(db, `lastMessage/${roomId}`));
      const last = lastMsgSnap.val() || { text: 'No messages yet', time: 0 };

      return {
        uid,
        name,
        avatar,
        roomId,
        lastText: last.text || 'No messages yet',
        lastTime: last.time || 0,
        unread: last.unread === myUid // true if I haven't read the last message
      };
    }));

    // Sort by latest message
    rows.sort((a, b) => b.lastTime - a.lastTime);

    renderChats(rows);
  });
}

function renderChats(rows) {
  listEl.innerHTML = rows.map(r => `
    <div class="chat-item" data-room="${r.roomId}" data-uid="${r.uid}">
      <img src="${r.avatar}" class="chat-avatar" alt="${r.name}">
      <div class="info">
        <div class="chat-name">${escapeHtml(r.name)}</div>
        <div class="chat-last">${escapeHtml(r.lastText)}</div>
      </div>
      <div class="chat-time">${timeAgo(r.lastTime)}</div>
      ${r.unread ? '<div class="unread-dot"></div>' : ''}
    </div>
  `).join('');
}

listEl.addEventListener('click', e => {
  const item = e.target.closest('.chat-item');
  if (!item) return;
  const roomId = item.dataset.room;
  const otherUid = item.dataset.uid;
  location.href = `room.html#${roomId}|${otherUid}`;
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function timeAgo(ts) {
  if (!ts) return '';
  const sec = Math.floor((Date.now() - ts) / 1000);
  if (sec < 60) return `${sec}s`;
  if (sec < 3600) return `${Math.floor(sec/60)}m`;
  if (sec < 86400) return `${Math.floor(sec/3600)}h`;
  if (sec < 604800) return `${Math.floor(sec/86400)}d`;
  return new Date(ts).toLocaleDateString();
}
</script>
</body>
</html>
