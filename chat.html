<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ff2a6d">
  <title>Chats â€¢ Vynix</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#ff2a6d;--bg:#ffffff;--text:#0f1419;--text2:#536471;--border:#eff3f4}
    [data-theme="dark"]{--bg:#000000;--text:#e7e9ea;--text2:#71767b;--border:#2f3336}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:80px;min-height:100vh;}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);padding:14px 16px;z-index:10;backdrop-filter:blur(12px);}
    .chat-item{display:flex;gap:14px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;position:relative;transition:bg .2s;}
    .chat-item:hover{background:rgba(255,42,109,.06);}
    .chat-item:active{background:rgba(255,42,109,.12);}
    .chat-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;flex-shrink:0;}
    .info{flex:1;min-width:0;}
    .chat-name{font-weight:700 16px/1.3 system-ui;}
    .chat-last{font-size:14.5px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .chat-time{font-size:13px;color:var(--text2);}
    .unread-dot{position:absolute;top:18px;right:16px;width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 0 3px var(--bg);}
    .empty{text-align:center;padding:80px 20px;color:var(--text2);font-size:15px;}
    
    /* Shimmer Loading */
    .shimmer{animation:shimmer 1.5s infinite linear;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;border-radius:8px;}
    [data-theme="dark"] .shimmer{background:linear-gradient(90deg,#1a1a1a 25%,#222 50%,#1a1a1a 75%);}
    @keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
    .skeleton-avatar{width:56px;height:56px;border-radius:50%;background:#e0e0e0;}
    .skeleton-line{height:16px;border-radius:4px;background:#e0e0e0;margin:6px 0;}
    .skeleton-line.short{width:60%;}
    .skeleton-line.long{width:85%;}
  </style>
</head>
<body>

<header>
  <h1 class="text-2xl font-extrabold" style="color:var(--accent);">Chats</h1>
</header>

<main id="list" class="pb-20">
  <!-- Shimmer Skeleton -->
  <div id="skeleton">
    ${Array(6).fill().map(() => `
      <div class="chat-item">
        <div class="skeleton-avatar shimmer"></div>
        <div class="info">
          <div class="skeleton-line short shimmer"></div>
          <div class="skeleton-line long shimmer"></div>
        </div>
      </div>
    `).join('')}
  </div>
</main>

<!-- Bottom Nav -->
<nav class="fixed bottom-0 left-0 left-0 right-0 h-16 bg-[var(--bg)] border-t border-[var(--border)] z-40">
  <div class="h-full flex items-center justify-around text-[var(--text2)]">
    <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
    <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">chat_bubble</span><span class="text-xs mt-0.5 font-bold">Chat</span></a>
    <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
    <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
    <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
    <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
  </div>
</nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const listEl = document.getElementById('list');
let myUid = null;

// Dark mode
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.setAttribute('data-theme', 'dark');
}

onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = 'login.html';
    return;
  }
  myUid = user.uid;
  setupRealtimeChats();
});

function setupRealtimeChats() {
  const followingRef = ref(db, `social/${myUid}/following`);

  onValue(followingRef, async (snap) => {
    const uids = snap.exists() ? Object.keys(snap.val() || {}) : [];

    if (uids.length === 0) {
      listEl.innerHTML = `<div class="empty">No chats yet<br><small>Follow someone to start messaging</small></div>`;
      return;
    }

    // Clear list & show skeleton again only first time
    if (listEl.querySelector('#skeleton')) listEl.innerHTML = '';

    const rows = [];

    // Listen to each user + last message in real-time
    uids.forEach(uid => {
      const roomId = [myUid, uid].sort().join('_');
      const profileRef = ref(db, `users/${uid}/profile`);
      const lastMsgRef = ref(db, `lastMessage/${roomId}`);

      // Combine both listeners
      let profile = {};
      let lastMsg = { text: 'No messages yet', time: 0, unread: false };

      const updateRow = () => {
        const item = document.getElementById(`chat-${uid}`) || document.createElement('div');
        item.className = 'chat-item';
        item.id = `chat-${uid}`;
        item.dataset.room = roomId;
        item.dataset.other = uid;
        item.innerHTML = `
          <img src="${profile.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profile.displayName || 'User') + '&background=ff2a6d&color=fff&bold=true'}" class="chat-avatar" alt="">
          <div class="info">
            <div class="chat-name">${escapeHtml(profile.displayName || 'User')}</div>
            <div class="chat-last">${escapeHtml(lastMsg.text || 'No messages yet')}</div>
          </div>
          <div class="chat-time">${timeAgo(lastMsg.time)}</div>
          ${lastMsg.unread === myUid ? '<div class="unread-dot"></div>' : ''}
        `;
        // Insert or update in correct position
        const existing = document.getElementById(`chat-${uid}`);
        if (existing) existing.replaceWith(item);
        else listEl.appendChild(item);
        sortChatList();
      };

      // Profile listener
      onValue(profileRef, snap => {
        profile = snap.val() || {};
        if (!profile.avatar) profile.avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.displayName || 'User')}&background=ff2a6d&color=fff&bold=true`;
        updateRow();
      });

      // Last message listener
      onValue(lastMsgRef, snap => {
        lastMsg = snap.val() || { text: 'No messages yet', time: 0, unread: false };
        updateRow();
      });
    });
  }, { onlyOnce: false });
}

// Sort chats by latest message time
function sortChatList() {
  const items = Array.from(listEl.querySelectorAll('.chat-item'));
  items.sort((a, b) => {
    const timeA = parseInt(a.querySelector('.chat-time').dataset.time || 0);
    const timeB = parseInt(b.querySelector('.chat-time').dataset.time || 0);
    return timeB - timeA;
  });
  items.forEach(item => listEl.appendChild(item)); // re-append = re-sort
}

// Click to open chat
listEl.addEventListener('click', e => {
  const card = e.target.closest('.chat-item');
  if (!card) return;
  const roomId = card.dataset.room;
  const otherUid = card.dataset.other;
  location.href = `room.html#${roomId}|${otherUid}`;
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function timeAgo(ts) {
  if (!ts) return '';
  const sec = Math.floor((Date.now() - ts) / 1000);
  if (sec < 60) return sec + 's';
  if (sec < 3600) return Math.floor(sec/60) + 'm';
  if (sec < 86400) return Math.floor(sec/3600) + 'h';
  if (sec < 604800) return Math.floor(sec/86400) + 'd';
  return new Date(ts).toLocaleDateString();
}
</script>
</body>
</html>
