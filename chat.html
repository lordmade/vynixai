<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>QuickDispatch ‚Äì AI Order Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --card-bg: #f7f9fa;
      --text-primary: #0f1419;
      --text-secondary: #536471;
      --border: #e1e8ed;
      --accent: #2563eb;
      --chat-bubble-sent: #2563eb;
      --chat-bubble-received: #f7f9fa;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --glow: 0 0 10px rgba(37, 99, 235, .35);
    }
    body.dark { --bg: #000; --card-bg: #16181c; --text-primary: #fff; --text-secondary: #71767b; --border: #2f3336; --chat-bubble-received: #16181c; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text-primary); margin: 0; padding: 0; overflow-x: hidden; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; touch-action: manipulation; line-height: 1.4; transition: background-color 0.3s ease, color 0.3s ease; -webkit-tap-highlight-color: transparent; }
    .main-content { padding: 20px 20px 120px; max-width: 600px; margin: 0 auto; }
    .messages-container { flex: 1; overflow-y: auto; padding-bottom: 20px; max-height: calc(100vh - 140px); }
    .message-item { display: flex; margin-bottom: 16px; animation: fadeIn 0.3s ease; position: relative; -webkit-tap-highlight-color: transparent; }
    .message-received { flex-direction: row; }
    .message-sent { flex-direction: row-reverse; }
    .message-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: #fff; font-size: 18px; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-left: 12px; flex-shrink: 0; }
    .message-bubble { max-width: 70%; padding: 12px 16px; border-radius: 20px; word-wrap: break-word; line-height: 1.4; cursor: pointer; user-select: text; }
    .message-received .message-bubble { background: var(--chat-bubble-received); color: var(--text-primary); border-bottom-left-radius: 4px; margin-left: 12px; border: 1px solid var(--border); }
    .message-sent .message-bubble { background: var(--chat-bubble-sent); color: #fff; border-bottom-right-radius: 4px; margin-right: 12px; box-shadow: var(--glow); }
    .order-info { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-top: 8px; }
    .order-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 14px; }
    .order-total { border-top: 1px solid var(--border); margin-top: 8px; padding-top: 8px; font-weight: bold; }
    .message-time { font-size: 12px; color: var(--text-secondary); margin-top: 4px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
    .message-sent .message-time { color: rgba(255, 255, 255, 0.8); }
    .input-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); border-top: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; gap: 12px; z-index: 10; box-shadow: var(--shadow-sm); }
    .input-group { flex: 1; display: flex; background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; overflow: hidden; }
    .input-group textarea { flex: 1; background: none; border: none; outline: none; padding: 12px 20px; color: var(--text-primary); font-size: 16px; resize: none; max-height: 120px; font-family: inherit; }
    .input-group textarea::placeholder { color: var(--text-secondary); }
    .send-btn { background: var(--accent); color: #fff; border: none; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; font-weight: bold; transition: all 0.2s ease; box-shadow: var(--glow); }
    .send-btn:hover { transform: scale(1.05); }
    .send-btn:disabled { background: var(--text-secondary); cursor: not-allowed; box-shadow: none; }
    .typing-indicator { font-style: italic; color: var(--accent); font-size: 14px; padding: 8px 12px; background: var(--chat-bubble-received); border-radius: 20px; max-width: 70%; margin-left: 52px; border-bottom-left-radius: 4px; }
    .quick-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .quick-btn { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s ease; }
    .quick-btn.retry { background: #dc2626; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #horizontal-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; }
    #horizontal-spinner.active { display: block; }
    #spinner-segment { width: 40px; height: 4px; background: var(--accent); border-radius: 2px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #alert-message { position: fixed; top: 20px; right: 20px; background: var(--card-bg); color: var(--text-primary); padding: 12px 16px; border-radius: 20px; border: 1px solid var(--border); transform: translateX(100%); transition: transform 0.3s ease; z-index: 1000; max-width: 300px; }
    #alert-message.active { transform: translateX(0); }
    .thinking { display: inline-flex; gap: 4px; margin-left: 8px; }
    .dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
    .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
  </style>
</head>
<body class="light">
  <main class="main-content">
    <div class="messages-container" id="messages-container"></div>
  </main>
  <div class="input-bar">
    <button class="input-icon material-icons" title="Attach" onclick="attachFile()">attach_file</button>
    <div class="input-group">
      <textarea id="message-input" placeholder="What would you like to order?" rows="1"></textarea>
    </div>
    <button class="send-btn material-icons" id="send-btn" disabled>send</button>
  </div>
  <div id="horizontal-spinner"><div id="spinner-segment"></div></div>
  <div id="alert-message" role="alert" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);
    rc.settings.minimumFetchIntervalMillis = 3600000;
    await fetchAndActivate(rc);

    const xaiKey = getString(rc, 'xai_api_key');
    const shipdayApiKey = getString(rc, 'shipday_api_key');

    if (!xaiKey || !shipdayApiKey) {
      alert("App not configured: Missing API keys in Firebase Remote Config");
    }

    let currentUser = null;
    let userProfile = { name: '', phone: '' };

    // UI Elements
    const chatPane = document.getElementById('messages-container');
    const chatInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const spinner = document.getElementById('horizontal-spinner');
    const alertBox = document.getElementById('alert-message');

    // Order State
    let history = [];
    let currentOrder = {
      items: [],
      customer: { name: '', phone: '', address: { street: '', city: 'Cape Town', state: 'WC', zip: '8001', country: 'ZA' } },
      restaurant: { name: 'QuickDispatch Partner', address: { street: '123 Main St', city: 'Cape Town' }, phone: '+27215551234' },
      total: 0, tip: 0, note: '', paymentMethod: 'credit_card', deliveryType: 'delivery', status: 'collecting'
    };

    function showSpinner() { spinner.classList.add('active'); }
    function hideSpinner() { spinner.classList.remove('active'); }
    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.classList.add('active');
      setTimeout(() => alertBox.classList.remove('active'), 5000);
    }
    function formatTime() { return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); }

    function addMessage(content, sender, orderData = null) {
      const div = document.createElement('div');
      div.className = `message-item ${sender === 'user' ? 'message-sent' : 'message-received'}`;
      let messageContent = content;
      if (orderData && sender === 'ai') {
        const icon = orderData.deliveryType === 'collection' ? 'Collect' : 'Delivery';
        messageContent = `
          ${content}
          <div class="order-info">
            <div style="font-weight: bold; margin-bottom: 8px;">Order #${orderData.orderNumber || 'TEMP'} ${icon}</div>
            ${orderData.items.map(i => `<div class="order-item"><span>${i.quantity}x ${i.name}</span><span>R${(i.quantity * i.price).toFixed(2)}</span></div>`).join('')}
            <div class="order-total"><span>Total</span><span>R${orderData.total.toFixed(2)}</span></div>
            <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);">üìç ${orderData.customer.address.street || 'Pending'}</div>
          </div>
        `;
      }
      div.innerHTML = `<div class="message-avatar">${sender === 'user' ? 'U' : 'D'}</div>
        <div class="message-bubble">${messageContent.replace(/\n/g, '<br>')}<div class="message-time">${formatTime()}</div></div>`;
      chatPane.appendChild(div);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'typing-indicator';
      d.innerHTML = 'Dispatch AI is thinking<div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      chatPane.appendChild(d);
      chatPane.scrollTop = chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    // Fetch logged-in user profile (name + phone)
    async function loadUserProfile(uid) {
      try {
        const userRef = ref(db, `users/${uid}`);
        const snap = await get(userRef);
        if (snap.exists()) {
          const data = snap.val();
          userProfile.name = data.displayName || auth.currentUser.displayName || 'Customer';
          userProfile.phone = data.phoneNumber || auth.currentUser.phoneNumber || '';
          // Auto-fill order
          currentOrder.customer.name = userProfile.name;
          currentOrder.customer.phone = userProfile.phone.replace(/[^+\d]/g, '');
        }
      } catch (e) { console.error("Failed to load user profile:", e); }
    }

    // Shipday Order Creation
    async function createShipdayOrder() {
      showSpinner();
      try {
        currentOrder.total = currentOrder.items.reduce((s, i) => s + i.quantity * i.price, 0) + (currentOrder.tip || 0);
        const payload = {
          externalOrderId: `QD-${Date.now()}`,
          customerName: currentOrder.customer.name,
          customerPhoneNumber: currentOrder.customer.phone || '+27',
          customerAddress: `${currentOrder.customer.address.street || 'TBC'}, Cape Town`,
          restaurantName: currentOrder.restaurant.name,
          restaurantAddress: currentOrder.restaurant.address.street,
          items: currentOrder.items.map(i => ({ name: i.name, quantity: i.quantity, price: i.price })),
          totalAmount: currentOrder.total,
          currency: "ZAR",
          tip: currentOrder.tip || 0,
          note: currentOrder.note || "Via QuickDispatch AI",
          deliveryType: currentOrder.deliveryType
        };

        const res = await fetch("https://api.shipday.com/v1/orders", {
          method: "POST",
          headers: { "Authorization": `Bearer ${shipdayApiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.message || "Shipday error");

        return { success: true, orderNumber: result.orderNumber || payload.externalOrderId, trackingUrl: `https://track.shipday.com/${result.orderId}` };
      } catch (err) {
        console.error("Shipday error:", err);
        throw err;
      } finally { hideSpinner(); }
    }

    // AI Reply + Order Flow
    async function getReply(userMsg) {
      addThinking();
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [
              { role: "system", content: `You are QuickDispatch AI ‚Äì fast food ordering bot in Cape Town. Customer name: ${currentOrder.customer.name}. Phone: ${currentOrder.customer.phone}. Ask only for items and delivery address. When ready, say ORDER_READY` },
              ...history.slice(-15),
              { role: "user", content: userMsg }
            ],
            temperature: 0.7,
            max_tokens: 400
          })
        });
        const data = await res.json();
        removeThinking();
        const reply = data.choices?.[0]?.message?.content?.trim() || "Sorry, I didn't get that.";

        history.push({ role: "user", content: userMsg });
        history.push({ role: "assistant", content: reply });

        if (reply.includes("ORDER_READY") || (currentOrder.items.length > 0 && currentOrder.customer.address.street)) {
          currentOrder.status = 'confirming';
          const summary = `Order Summary:\n${currentOrder.items.map(i => `${i.quantity}x ${i.name} - R${(i.quantity * i.price).toFixed(2)}`).join('\n')}\nTotal: R${currentOrder.total.toFixed(2)}\nDeliver to: ${currentOrder.customer.address.street}\n\nReply YES to confirm`;
          addMessage(summary, 'ai');
          addQuickActions(['YES', 'NO']);
          return;
        }

        if (userMsg.toLowerCase().includes('yes') && currentOrder.status === 'confirming') {
          addMessage("Sending your order now...", 'ai');
          try {
            const result = await createShipdayOrder();
            addMessage(`Order placed! Order #${result.orderNumber}\nWe'll SMS you when the driver is on the way.`, 'ai', {
              orderNumber: result.orderNumber,
              items: currentOrder.items,
              total: currentOrder.total,
              customer: currentOrder.customer,
              deliveryType: currentOrder.deliveryType
            });
            const btn = document.createElement('div'); btn.className = 'quick-actions';
            btn.innerHTML = `<button class="quick-btn" onclick="window.open('${result.trackingUrl}', '_blank')">Track Order</button>`;
            chatPane.appendChild(btn);
            setTimeout(() => { currentOrder = { items: [], customer: { ...currentOrder.customer, address: { ...currentOrder.customer.address, street: '' } }, total: 0, status: 'collecting' }; addMessage("Anything else?", 'ai'); }, 3000);
          } catch (e) {
            addMessage(`Dispatch failed: ${e.message}`, 'ai');
            addQuickActions(['Retry Order']);
          }
          return;
        }

        addMessage(reply, 'ai');
        extractOrderInfo(userMsg);
      } catch (e) { removeThinking(); addMessage("Network error, try again.", 'ai'); }
    }

    function extractOrderInfo(msg) {
      const lower = msg.toLowerCase();
      if (lower.includes('collect')) currentOrder.deliveryType = 'collection';
      if (lower.includes('deliver')) currentOrder.deliveryType = 'delivery';

      const addrMatch = msg.match(/(\d+\s+[\w\s]+(?:st|rd|ave|drive|blvd|lane|close|way|crescent))/i);
      if (addrMatch) currentOrder.customer.address.street = addrMatch[1].trim();

      const itemRegex = /(\d+)\s*(x)?\s*([a-zA-Z\s]+)/gi;
      let match; const prices = { pizza: 120, burger: 85, chow: 95, salad: 70, default: 80 };
      while ((match = itemRegex.exec(msg))) {
        const name = match[3].trim().toLowerCase();
        const price = prices[name] || prices.default;
        if (!currentOrder.items.find(i => i.name.toLowerCase() === name)) {
          currentOrder.items.push({ name: match[3].trim(), quantity: parseInt(match[1]), price });
          currentOrder.total += parseInt(match[1]) * price;
        }
      }
    }

    function addQuickActions(actions) {
      const div = document.createElement('div');
      div.className = 'quick-actions';
      div.innerHTML = actions.map(a => `<button class="quick-btn ${a === 'Retry Order' ? 'retry' : ''}" onclick="quickAction('${a}')">${a}</button>`).join('');
      chatPane.appendChild(div);
      chatPane.scrollTop = chatPane.scrollHeight;
    }
    window.quickAction = (a) => { chatInput.value = a === 'Retry Order' ? 'yes' : a; send(); document.querySelectorAll('.quick-actions').forEach(el => el.remove()); };

    async function send() {
      const msg = chatInput.value.trim();
      if (!msg) return;
      addMessage(msg, 'user');
      chatInput.value = ''; chatInput.style.height = 'auto'; sendBtn.disabled = true;
      await getReply(msg);
      sendBtn.disabled = false;
    }

    window.attachFile = () => showAlert("File upload coming soon!");

    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
      sendBtn.disabled = !chatInput.value.trim();
    });
    sendBtn.onclick = send;
    chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });

    // Auth State Listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = 'login.html'; // Redirect to your login page
        return;
      }
      currentUser = user;
      await loadUserProfile(user.uid);

      addMessage(`Howzit ${currentOrder.customer.name.split(' ')[0]}! üëã\nWhat are you craving today? Delivery or collection?`, 'ai');
      setTimeout(() => addQuickActions(['2 Pizzas', 'Burger + Chips', 'Bunny Chow', 'Track Order']), 1500);
    });
  </script>
</body>
</html>
