<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ZULABEAT – Your SA Music Bestie</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{
    "name":"Zulabeat","short_name":"Zulabeat",
    "description":"Your South African music bestie – talk, vibe, play",
    "start_url":"/","display":"standalone",
    "background_color":"#FF6B35","theme_color":"#FF6B35",
    "icons":[
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=192","sizes":"192x192","type":"image/svg+xml"},
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=512","sizes":"512x512","type":"image/svg+xml"}
    ]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;background:#0f0a1a;color:#fff;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .header{background:linear-gradient(135deg,#FF6B35,#ec4899);padding:1.5rem 1rem 2rem;text-align:center;box-shadow:0 10px 30px rgba(255,107,53,0.4)}
    .header h1{font-size:3.2rem;font-weight:900;margin:0;letter-spacing:-2px}
    .header p{font-size:1.1rem;opacity:0.9}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 140px;-webkit-overflow-scrolling:touch}
    .message{margin:1rem 0;display:flex;flex-direction:column;animation:fadeIn .4s ease-out forwards}
    .message.user{align-items:flex-end}
    .message .bubble{max-width:88%;padding:14px 18px;border-radius:24px;line-height:1.55;font-size:1.02rem;word-wrap:break-word;box-shadow:0 4px 16px rgba(0,0,0,0.2)}
    .message.ai .bubble{background:linear-gradient(135deg,#1e1b4b,#2d1b69);border-bottom-left-radius:6px}
    .message.user .bubble{background:#FF6B35;color:#fff;border-bottom-right-radius:6px}
    .track-bubble{cursor:pointer;transition:transform .2s}
    .track-bubble:hover{transform:scale(1.03)}
    .track-info{display:flex;align-items:center;gap:12px;margin-top:8px}
    .track-info img{width:48px;height:48px;border-radius:12px}
    .track-text{flex:1}
    .track-text p{margin:0;font-weight:700}
    .track-text small{opacity:0.9;font-size:0.9rem}
    .timestamp{font-size:0.75rem;opacity:0.7;margin-top:4px}
    .message.ai .timestamp{margin-left:18px}
    .thinking{display:flex;gap:9px;padding:16px 20px}
    .dot{width:11px;height:11px;background:#a78bfa;border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);padding:1rem;padding-bottom:calc(1rem + env(safe-area-inset-bottom));z-index:100}
    .input-container{max-width:780px;margin:0 auto;background:rgba(255,255,255,0.15);border-radius:28px;padding:10px 16px;display:flex;align-items:center;gap:12px}
    #chatInput{flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:1.1rem}
    #chatInput::placeholder{color:rgba(255,255,255,0.6)}
    .send-btn{width:52px;height:52px;background:#FF6B35;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:.2s}
    .send-btn:disabled{opacity:0.5}
  </style>
</head>
<body>

  <header class="header">
    <h1>ZULABEAT</h1>
    <p>Your South African music bestie – talk to me</p>
  </header>

  <section id="chatPane"></section>

  <div class="input-bar">
    <div class="input-container">
      <input type="text" id="chatInput" placeholder="Say hi or ask for music..." autocomplete="off" />
      <button class="send-btn" id="sendBtn"><i data-lucide="send" class="w-6 h-6"></i></button>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const remoteConfig = getRemoteConfig(app);
    remoteConfig.settings.minimumFetchIntervalMillis = 3600000;

    let xaiKey = null;
    let spotifyClientId = null;
    let spotifyClientSecret = null;
    let spotifyToken = null;
    let tokenExpiry = 0;
    let history = [];

    // Load secrets
    await fetchAndActivate(remoteConfig);
    xaiKey = getString(remoteConfig, 'xai_api_key');
    spotifyClientId = getString(remoteConfig, 'spotify_client_id');
    spotifyClientSecret = getString(remoteConfig, 'spotify_client_secret');

    if (!xaiKey) {
      addMessage("App not ready – missing config", 'ai');
      throw new Error("No xAI key");
    }

    const chatPane = document.getElementById('chatPane');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const audio = document.getElementById('audioPlayer');

    function addMessage(content, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const time = new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });

      if (sender === 'ai') {
        div.innerHTML = `
          <div class="bubble">
            ${content}
            <div class="timestamp">${time}</div>
          </div>
        `;
      } else {
        div.innerHTML = `
          <div class="bubble">${content.replace(/\n/g, '<br>')}
            <div class="timestamp">${time}</div>
          </div>
        `;
      }
      chatPane.appendChild(div);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="bubble"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      chatPane.appendChild(d);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function removeThinking() {
      document.getElementById('thinking')?.remove();
    }

    async function getSpotifyToken() {
      if (Date.now() < tokenExpiry) return spotifyToken;
      const auth = btoa(`\( {spotifyClientId}: \){spotifyClientSecret}`);
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded", "Authorization": "Basic " + auth },
        body: "grant_type=client_credentials"
      });
      const data = await res.json();
      spotifyToken = data.access_token;
      tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000;
      return spotifyToken;
    }

    async function callGrok(userMessage) {
      addThinking();
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${xaiKey}`
          },
          body: JSON.stringify({
            model: "grok-beta",
            messages: [
              { role: "system", content: "You are Zulabeat – a super cool, fun, South African music bestie. Speak like a real person from Joburg. Use slang, be friendly, reply short and sweet. If they ask for music, return ONLY a clean Spotify search query in this format: SEARCH_QUERY: your reply here. Example: SEARCH_QUERY: amapiano 2025 Yo fam! Here's the latest Amapiano fire!" },
              ...history,
              { role: "user", content: userMessage }
            ],
            temperature: 0.8,
            max_tokens: 300
          })
        });

        const data = await res.json();
        removeThinking();
        const reply = data.choices?.[0]?.message?.content || "Hmm... not sure";

        // Check if Grok wants to play music
        const match = reply.match(/^SEARCH_QUERY:\s*(.+)$/m);
        if (match) {
          const query = match[1].trim().split('\n')[0];
          const cleanText = reply.replace(/^SEARCH_QUERY:.+$/m, '').trim();
          await playMusic(query, cleanText || "Here’s some fire for you");
        } else {
          addMessage(reply, 'ai');
        }
      } catch (err) {
        removeThinking();
        addMessage("Network error – check your data", 'ai');
      }
    }

    async function playMusic(query, textBefore) {
      try {
        const token = await getSpotifyToken();
        const res = await fetch(
          `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&market=ZA&limit=8`,
          { headers: { Authorization: `Bearer ${token}` } }
        );
        const data = await res.json();
        const tracks = data.tracks.items;

        if (tracks.length === 0) {
          addMessage("Couldn't find anything for that vibe", 'ai');
          return;
        }

        if (textBefore) addMessage(textBefore, 'ai');

        tracks.forEach(track => {
          const art = track.album.images[0]?.url || '';
          const bubble = document.createElement('div');
          bubble.className = 'message ai track-bubble';
          bubble.innerHTML = `
            <div class="bubble">
              <div class="track-info">
                <img src="${art}" alt="">
                <div class="track-text">
                  <p>${track.name}</p>
                  <small>${track.artists.map(a => a.name).join(', ')}</small>
                </div>
              </div>
              <div class="timestamp">${new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
          `;
          bubble.onclick = () => {
            if (track.preview_url) {
              audio.src = track.preview_url;
              audio.play();
              addMessage(`Now playing: \( {track.name} – \){track.artists[0].name}`, 'ai');
            } else {
              window.open(track.external_urls.spotify, '_blank');
              addMessage(`Opened in Spotify: ${track.name}`, 'ai');
            }
          };
          chatPane.appendChild(bubble);
        });
      } catch {
        addMessage("Music search failed – try again", 'ai');
      }
    }

    function send() {
      const msg = chatInput.value.trim();
      if (!msg) return;
      addMessage(msg, 'user');
      history.push({ role: "user", content: msg });
      chatInput.value = '';
      callGrok(msg);
    }

    chatInput.addEventListener('input', () => sendBtn.disabled = !chatInput.value.trim() === '');
    sendBtn.onclick = send;
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Welcome
    addMessage("Yo! I'm Zulabeat – your SA music bestie. What's the vibe today?", 'ai');
  </script>
</body>
</html>
