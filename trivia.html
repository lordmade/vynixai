<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix - Trivia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
      --status-bar: #D9D9D9;
    }
    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--background);
    }
    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
    }
    .icon-btn svg {
      width: 24px;
      height: 24px;
    }
    .tab-view {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--background);
    }
    .tab-item {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    .tab-item.active {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
    }
    .trivia-content, .leaderboard-content, .challenge-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .question-card {
      background: var(--chat-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      animation: slideIn 0.3s ease;
    }
    .answer-btn {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .answer-btn:hover {
      transform: scale(1.02);
    }
    .answer-btn.correct {
      background: var(--accent);
      color: #FFFFFF;
      animation: pulse 0.5s;
    }
    .answer-btn.incorrect {
      background: #FF4444;
      color: #FFFFFF;
      animation: shake 0.5s;
    }
    .timer-bar {
      height: 8px;
      background: var(--status-bar);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .timer-progress {
      height: 100%;
      background: var(--accent);
      width: 100%;
      transition: width linear;
    }
    .leaderboard-item, .challenge-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .coin-balance {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }
    .badge {
      width: 24px;
      height: 24px;
      margin-right: 0.5rem;
    }
    .custom-alert {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .custom-alert.active {
      display: flex;
    }
    .alert-content {
      background: var(--background);
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      max-width: 90%;
    }
    .alert-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }
    .alert-buttons button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #alert-confirm {
      background: var(--accent);
      color: #FFFFFF;
    }
    #alert-cancel {
      background: var(--border);
      color: var(--text-primary);
    }
    .spinner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      justify-content: center;
      align-items: center;
    }
    .spinner-overlay.active {
      display: flex;
    }
    .spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .shimmer {
      animation: shimmer 1.5s infinite;
    }
    .shimmer-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .shimmer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--border);
      margin-right: 0.75rem;
    }
    .shimmer-text {
      flex: 1;
    }
    .shimmer-line {
      height: 12px;
      background: var(--border);
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }
    .shimmer-line.long {
      width: 80%;
    }
    .shimmer-line.short {
      width: 50%;
    }
    @keyframes shimmer {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 640px) {
      .header { padding: 0.75rem; }
      .avatar { width: 32px; height: 32px; }
      .trivia-content, .leaderboard-content, .challenge-content { padding: 0.5rem; }
      .question-card { padding: 1rem; }
      .answer-btn { padding: 0.5rem; font-size: 0.9rem; }
      .badge { width: 20px; height: 20px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="user-profile">
      <button class="icon-btn" onclick="window.location.href='index.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6"></path>
        </svg>
      </button>
      <div id="user-avatar" class="avatar">U</div>
      <span id="user-name">Loading...</span>
      <div class="coin-balance ml-4">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="gold"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/></svg>
        <span id="coin-balance">0</span>
      </div>
    </div>
    <button id="mute-toggle" class="icon-btn" title="Toggle Music">
      <svg id="mute-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>
    </button>
  </div>
  <div class="tab-view">
    <div class="tab-item active" data-tab="play">Play Trivia</div>
    <div class="tab-item" data-tab="leaderboard">Leaderboard</div>
    <div class="tab-item" data-tab="challenge">Challenges</div>
  </div>
  <div id="trivia-content" class="trivia-content"></div>
  <div id="leaderboard-content" class="leaderboard-content" style="display: none;"></div>
  <div id="challenge-content" class="challenge-content" style="display: none;"></div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-content">
      <p id="alert-message"></p>
      <div id="alert-buttons" class="alert-buttons">
        <button id="alert-confirm">OK</button>
        <button id="alert-cancel">Cancel</button>
      </div>
    </div>
  </div>
  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <audio id="background-music" loop src="https://cdn.pixabay.com/audio/2022/03/10/audio_4b3f7b2b3e.mp3"></audio>
  <audio id="correct-sound" src="https://cdn.pixabay.com/audio/2022/03/10/audio_4b3f7b2b3e.mp3"></audio>
  <audio id="incorrect-sound" src="https://cdn.pixabay.com/audio/2022/03/10/audio_4b3f7b2b3e.mp3"></audio>
  <script type="module">
    // Firebase Client-Side Script
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, set, get, update, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e",
  measurementId: "G-V4W97VMSKL"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    const alertConfirm = document.getElementById("alert-confirm");
    const alertCancel = document.getElementById("alert-cancel");
    const triviaContent = document.getElementById("trivia-content");
    const leaderboardContent = document.getElementById("leaderboard-content");
    const challengeContent = document.getElementById("challenge-content");
    const userAvatar = document.getElementById("user-avatar");
    const userName = document.getElementById("user-name");
    const coinBalance = document.getElementById("coin-balance");
    const backgroundMusic = document.getElementById("background-music");
    const correctSound = document.getElementById("correct-sound");
    const incorrectSound = document.getElementById("incorrect-sound");
    const muteToggle = document.getElementById("mute-toggle");
    const muteIcon = document.getElementById("mute-icon");
    const spinnerOverlay = document.getElementById("spinner-overlay");
    let currentTab = "play";
    let questions = [];
    let currentQuestionIndex = 0;
    let userScore = 0;
    let timerInterval;
    let userId;
    let userCoins = 0;
    let alertResolve = null;
    let answeredQuestions = new Set();
    let isMuted = localStorage.getItem('musicMuted') === 'true';

    // SVG Badges
    const badges = {
      gold: `<svg class="badge" viewBox="0 0 24 24" fill="gold"><path d="M12 2L1 9l3 9h16l3-9L12 2zm0 2.36L21.64 9 18 18H6L2.36 9 12 4.36zM12 8l-3 6h2v4h2v-4h2l-3-6z"/></svg>`,
      silver: `<svg class="badge" viewBox="0 0 24 24" fill="silver"><path d="M12 2L1 9l3 9h16l3-9L12 2zm0 2.36L21.64 9 18 18H6L2.36 9 12 4.36zM12 8l-3 6h2v4h2v-4h2l-3-6z"/></svg>`,
      bronze: `<svg class="badge" viewBox="0 0 24 24" fill="#cd7f32"><path d="M12 2L1 9l3 9h16l3-9L12 2zm0 2.36L21.64 9 18 18H6L2.36 9 12 4.36zM12 8l-3 6h2v4h2v-4h2l-3-6z"/></svg>`
    };

    // Helper functions
    function showShimmer(count = 5) {
      triviaContent.innerHTML = '';
      leaderboardContent.innerHTML = '';
      challengeContent.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const shimmerItem = document.createElement('div');
        shimmerItem.className = 'shimmer-item shimmer';
        shimmerItem.innerHTML = `
          <div class="shimmer-avatar"></div>
          <div class="shimmer-text">
            <div class="shimmer-line long"></div>
            <div class="shimmer-line short"></div>
          </div>
        `;
        triviaContent.appendChild(shimmerItem);
        leaderboardContent.appendChild(shimmerItem.cloneNode(true));
        challengeContent.appendChild(shimmerItem.cloneNode(true));
      }
    }

    window.showAlert = function (message, autoHide = true, confirmCallback = null, cancelCallback = null) {
      return new Promise((resolve) => {
        alertMessage.textContent = message;
        alertConfirm.style.display = confirmCallback ? "block" : "none";
        alertCancel.style.display = cancelCallback ? "block" : "none";
        customAlert.classList.add("active");
        alertResolve = resolve;

        if (autoHide && !confirmCallback && !cancelCallback) {
          setTimeout(window.hideAlert, 5000);
        }

        alertConfirm.onclick = () => {
          if (confirmCallback) confirmCallback();
          resolve(true);
          window.hideAlert();
        };

        alertCancel.onclick = () => {
          if (cancelCallback) cancelCallback();
          resolve(false);
          window.hideAlert();
        };
      });
    };

    window.hideAlert = function () {
      customAlert.classList.remove("active");
      alertResolve = null;
    };

    function updateMuteIcon() {
      muteIcon.innerHTML = isMuted
        ? `<path d="M11 5L6 9H2v6h4l5 4V5zM18 7l-6 6M18 13l-6-6"/>`
        : `<path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 0 1 0 7.07"/>`;
      backgroundMusic.muted = isMuted;
      correctSound.muted = isMuted;
      incorrectSound.muted = isMuted;
      localStorage.setItem('musicMuted', isMuted);
    }

    muteToggle.addEventListener('click', () => {
      isMuted = !isMuted;
      updateMuteIcon();
      if (!isMuted && currentTab === 'play') {
        backgroundMusic.play().catch(error => console.error("Error playing background music:", error));
      } else {
        backgroundMusic.pause();
      }
    });

    async function loadUserProfile(userId) {
      showShimmer(1);
      const userRef = ref(db, `users/${userId}`);
      onValue(userRef, (snapshot) => {
        userAvatar.innerHTML = '';
        userName.textContent = 'Loading...';
        if (snapshot.exists()) {
          const user = snapshot.val();
          const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
          const avatarContent = user.avatar ? `<img src="${user.avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
          userAvatar.innerHTML = avatarContent;
          userName.textContent = user.name || 'Unknown';
          userCoins = user.coins || 0;
          coinBalance.textContent = userCoins;
        } else {
          userAvatar.innerHTML = 'U';
          userName.textContent = 'Unknown';
          coinBalance.textContent = '0';
        }
        updateMuteIcon();
      }, { onlyOnce: true }, (error) => {
        console.error("Error fetching user profile:", error);
        window.showAlert("Failed to load profile.", false);
      });
    }

    async function fetchTriviaQuestions() {
      if (userCoins < 5) {
        window.showAlert("You need 5 coins to play! Earn more by answering questions.", false);
        return false;
      }
      try {
        spinnerOverlay.classList.add("active");
        const weekNumber = getWeekNumber(new Date());
        const answeredRef = ref(db, `users/${userId}/trivia/answeredQuestions/${weekNumber}`);
        const answeredSnapshot = await get(answeredRef);
        answeredQuestions = new Set(answeredSnapshot.val() || []);
        const response = await fetch('https://opentdb.com/api.php?amount=50&type=multiple');
        const data = await response.json();
        questions = data.results
          .filter(q => !answeredQuestions.has(q.question))
          .map(q => ({
            question: q.question,
            correct_answer: q.correct_answer,
            incorrect_answers: q.incorrect_answers,
            answers: [...q.incorrect_answers, q.correct_answer].sort(() => Math.random() - 0.5)
          }))
          .sort(() => Math.random() - 0.5)
          .slice(0, 10);
        if (questions.length < 10) {
          await set(answeredRef, {});
          return fetchTriviaQuestions();
        }
        localStorage.setItem('triviaQuestions', JSON.stringify(questions));
        userCoins -= 5;
        await update(ref(db, `users/${userId}`), { coins: userCoins });
        coinBalance.textContent = userCoins;
        currentQuestionIndex = 0;
        userScore = 0;
        renderQuestion();
        if (!isMuted) {
          backgroundMusic.play().catch(error => console.error("Error playing background music:", error));
        }
        return true;
      } catch (error) {
        console.error("Error fetching trivia questions:", error);
        window.showAlert("Failed to load trivia questions.", false);
        return false;
      } finally {
        spinnerOverlay.classList.remove("active");
      }
    }

    function decodeHTML(html) {
      const txt = document.createElement('textarea');
      txt.innerHTML = html;
      return txt.value;
    }

    function renderQuestion(isChallenge = false, challengeId = null, opponentId = null) {
      triviaContent.innerHTML = '';
      clearInterval(timerInterval);
      if (currentQuestionIndex >= questions.length) {
        saveScore(isChallenge, challengeId, opponentId);
        backgroundMusic.pause();
        triviaContent.innerHTML = `
          <div class="question-card">
            <h3 class="text-lg font-bold mb-4">Quiz Complete!</h3>
            <p class="mb-4">Your score: ${userScore} / ${questions.length * 10}</p>
            <button class="btn primary mr-2" onclick="fetchTriviaQuestions()">Play Again</button>
            <button class="btn primary" onclick="shareScore(${userScore})">Share Score</button>
          </div>
        `;
        return;
      }
      const question = questions[currentQuestionIndex];
      const questionCard = document.createElement('div');
      questionCard.className = 'question-card';
      questionCard.innerHTML = `
        <div class="flex justify-between mb-4">
          <span>Question ${currentQuestionIndex + 1}/${questions.length}</span>
          <span class="coin-balance"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="gold"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/></svg> ${userCoins}</span>
        </div>
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        <h3 class="text-lg font-bold mb-4">${decodeHTML(question.question)}</h3>
        ${question.answers.map((answer, index) => `
          <button class="answer-btn" data-index="${index}">${decodeHTML(answer)}</button>
        `).join('')}
        <button class="btn primary mt-4" onclick="buyHint()">Buy Hint (10 Coins)</button>
      `;
      triviaContent.appendChild(questionCard);

      const timerProgress = document.getElementById('timer-progress');
      let timeLeft = 15;
      timerProgress.style.transition = `width ${timeLeft}s linear`;
      timerProgress.style.width = '0%';
      timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          currentQuestionIndex++;
          renderQuestion(isChallenge, challengeId, opponentId);
        }
      }, 1000);

      document.querySelectorAll('.answer-btn').forEach(btn => {
        btn.addEventListener('click', () => handleAnswer(btn, question, isChallenge, challengeId, opponentId));
      });
    }

    async function handleAnswer(btn, question, isChallenge, challengeId, opponentId) {
      clearInterval(timerInterval);
      const selectedAnswer = question.answers[btn.dataset.index];
      const isCorrect = selectedAnswer === question.correct_answer;
      btn.classList.add(isCorrect ? 'correct' : 'incorrect');
      document.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
      if (isCorrect) {
        userScore += 10;
        userCoins += 5;
        if (!isMuted) correctSound.play();
        await update(ref(db, `users/${userId}/trivia`), { coins: userCoins });
        const correctAnswers = await get(ref(db, `users/${userId}/trivia/correctAnswers`)).then(s => s.val() || 0);
        await update(ref(db, `users/${userId}/trivia`), { correctAnswers: correctAnswers + 1 });
        const weekNumber = getWeekNumber(new Date());
        answeredQuestions.add(question.question);
        await update(ref(db, `users/${userId}/trivia/answeredQuestions/${weekNumber}`), Array.from(answeredQuestions));
        if (correctAnswers + 1 >= 100) {
          await set(ref(db, `users/${userId}/badges/TriviaMaster`), {
            awarded: new Date().toISOString(),
            name: 'Trivia Master'
          });
          window.showAlert('Congratulations! You earned the Trivia Master badge!', true);
        }
      } else {
        if (!isMuted) incorrectSound.play();
      }
      coinBalance.textContent = userCoins;
      setTimeout(() => {
        currentQuestionIndex++;
        renderQuestion(isChallenge, challengeId, opponentId);
      }, 1000);
    }

    async function buyHint() {
      if (userCoins < 10) {
        window.showAlert("Not enough coins for a hint!", false);
        return;
      }
      userCoins -= 10;
      await update(ref(db, `users/${userId}`), { coins: userCoins });
      coinBalance.textContent = userCoins;
      const question = questions[currentQuestionIndex];
      const incorrect = question.answers.filter(a => a !== question.correct_answer);
      const toDisable = incorrect[Math.floor(Math.random() * incorrect.length)];
      document.querySelectorAll('.answer-btn').forEach(btn => {
        if (btn.textContent === toDisable) btn.disabled = true;
      });
      window.showAlert("One incorrect answer has been disabled!", true);
    }

    async function saveScore(isChallenge, challengeId, opponentId) {
      if (!userId) return;
      const weekNumber = getWeekNumber(new Date());
      const scoreRef = ref(db, `trivia/leaderboard/${weekNumber}/${userId}`);
      const currentScore = await get(scoreRef).then(s => s.val()?.score || 0);
      await set(scoreRef, {
        score: currentScore + userScore,
        name: userName.textContent
      });
      if (isChallenge && challengeId && opponentId) {
        await update(ref(db, `challenges/${challengeId}`), {
          [`scores/${userId}`]: userScore
        });
        const challengeRef = ref(db, `challenges/${challengeId}`);
        const challenge = await get(challengeRef).then(s => s.val());
        if (challenge.scores && challenge.scores[userId] && challenge.scores[opponentId]) {
          const winner = challenge.scores[userId] > challenge.scores[opponentId] ? userId : opponentId;
          await update(ref(db, `challenges/${challengeId}`), { winner });
          window.showAlert(`Challenge complete! ${winner === userId ? 'You won!' : 'You lost!'}`);
        }
      }
      backgroundMusic.pause();
      if (!navigator.onLine) {
        localStorage.setItem('pendingScore', JSON.stringify({ score: userScore, isChallenge, challengeId, opponentId }));
      }
    }

    window.addEventListener('online', async () => {
      const pending = localStorage.getItem('pendingScore');
      if (pending) {
        const { score, isChallenge, challengeId, opponentId } = JSON.parse(pending);
        await saveScore(isChallenge, challengeId, opponentId);
        localStorage.removeItem('pendingScore');
      }
    });

    async function shareScore(score) {
      const chatId = await window.showAlert("Enter chat ID to share your score:", false, async () => {
        const input = prompt("Enter chat ID:");
        return input;
      });
      if (!chatId) return;
      try {
        await push(ref(db, `chats/${chatId}/messages`), {
          senderId: userId,
          content: `I scored ${score} points in Trivia!`,
          timestamp: Date.now(),
          type: 'text'
        });
        window.showAlert("Score shared successfully!", true);
      } catch (error) {
        console.error("Error sharing score:", error);
        window.showAlert("Failed to share score.", false);
      }
    }

    async function renderLeaderboard() {
      showShimmer();
      leaderboardContent.innerHTML = '';
      const weekNumber = getWeekNumber(new Date());
      const leaderboardRef = ref(db, `trivia/leaderboard/${weekNumber}`);
      try {
        const snapshot = await get(leaderboardRef);
        const leaderboard = snapshot.val() || {};
        const sortedLeaderboard = Object.entries(leaderboard)
          .map(([uid, data]) => ({ uid, ...data }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 10);
        if (sortedLeaderboard.length === 0) {
          leaderboardContent.innerHTML = '<p style="text-align: center; padding: 1rem;">No scores yet.</p>';
          return;
        }
        sortedLeaderboard.forEach((entry, index) => {
          const badge = index === 0 ? badges.gold : index === 1 ? badges.silver : index === 2 ? badges.bronze : '';
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          item.innerHTML = `
            <span>${badge} #${index + 1} ${entry.name}</span>
            <span>${entry.score} points</span>
          `;
          leaderboardContent.appendChild(item);
        });
        const userRank = sortedLeaderboard.findIndex(e => e.uid === userId) + 1;
        if (userRank > 0) {
          leaderboardContent.innerHTML += `
            <div class="leaderboard-item mt-4">
              <span>Your Rank: #${userRank}</span>
              <span>${leaderboard[userId]?.score || 0} points</span>
            </div>
          `;
        }
        const airtimeRef = ref(db, `trivia/airtime/${weekNumber}/${userId}`);
        const airtimeSnapshot = await get(airtimeRef);
        if (airtimeSnapshot.exists()) {
          const { code } = airtimeSnapshot.val();
          leaderboardContent.innerHTML += `
            <div class="leaderboard-item mt-4">
              <span>Congratulations! You won airtime: ${code}</span>
            </div>
          `;
        }
      } catch (error) {
        console.error("Error loading leaderboard:", error);
        window.showAlert("Failed to load leaderboard.", false);
      }
    }

    async function renderChallenges() {
      showShimmer();
      challengeContent.innerHTML = '';
      try {
        const friendsRef = ref(db, `friends/${userId}`);
        const friendSnapshot = await get(friendsRef);
        const friendIds = friendSnapshot.exists() ? Object.keys(friendSnapshot.val()) : [];
        const usersRef = ref(db, 'users');
        const userSnapshot = await get(usersRef);
        const users = userSnapshot.val() || {};
        if (friendIds.length === 0) {
          challengeContent.innerHTML = '<p style="text-align: center; padding: 1rem;">Add friends to challenge them!</p>';
          return;
        }
        friendIds.forEach(friendId => {
          const friend = users[friendId] || { name: 'Unknown', avatar: null };
          const item = document.createElement('div');
          item.className = 'challenge-item';
          const firstLetter = friend.name ? friend.name.charAt(0).toUpperCase() : 'U';
          const avatarContent = friend.avatar ? `<img src="${friend.avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
          item.innerHTML = `
            <div class="flex items-center gap-2">
              <div class="avatar">${avatarContent}</div>
              <span>${friend.name}</span>
            </div>
            <button class="btn primary" onclick="startChallenge('${friendId}')">Challenge</button>
          `;
          challengeContent.appendChild(item);
        });
        const challengesRef = ref(db, `challenges`);
        const challengesSnapshot = await get(challengesRef);
        const challenges = challengesSnapshot.val() || {};
        Object.entries(challenges).forEach(([challengeId, challenge]) => {
          if (challenge.players[userId] && !challenge.winner) {
            const opponentId = Object.keys(challenge.players).find(id => id !== userId);
            const opponent = users[opponentId] || { name: 'Unknown' };
            const item = document.createElement('div');
            item.className = 'challenge-item';
            item.innerHTML = `
              <span>Challenge vs ${opponent.name}</span>
              <button class="btn primary" onclick="playChallenge('${challengeId}', '${opponentId}')">Play</button>
            `;
            challengeContent.appendChild(item);
          }
        });
      } catch (error) {
        console.error("Error loading challenges:", error);
        window.showAlert("Failed to load challenges.", false);
      }
    }

    async function startChallenge(friendId) {
      if (userCoins < 5) {
        window.showAlert("You need 5 coins to start a challenge!", false);
        return;
      }
      try {
        userCoins -= 5;
        await update(ref(db, `users/${userId}`), { coins: userCoins });
        coinBalance.textContent = userCoins;
        const challengeRef = push(ref(db, 'challenges'));
        await set(challengeRef, {
          players: { [userId]: true, [friendId]: true },
          createdAt: Date.now(),
          scores: {}
        });
        window.showAlert(`Challenge sent to ${friendId}!`, true);
        renderChallenges();
      } catch (error) {
        console.error("Error starting challenge:", error);
        window.showAlert("Failed to start challenge.", false);
      }
    }

    async function playChallenge(challengeId, opponentId) {
      currentQuestionIndex = 0;
      userScore = 0;
      if (await fetchTriviaQuestions()) {
        renderQuestion(true, challengeId, opponentId);
      }
    }

    function getWeekNumber(date) {
      const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    function toggleLowDataMode(enabled) {
      document.querySelectorAll('.question-card, .answer-btn').forEach(el => {
        el.style.animation = enabled ? 'none' : '';
      });
      isMuted = enabled;
      updateMuteIcon();
      localStorage.setItem('lowDataMode', enabled);
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tab);
      });
      triviaContent.style.display = tab === 'play' ? 'block' : 'none';
      leaderboardContent.style.display = tab === 'leaderboard' ? 'block' : 'none';
      challengeContent.style.display = tab === 'challenge' ? 'block' : 'none';
      if (tab === 'play') {
        fetchTriviaQuestions();
      } else {
        backgroundMusic.pause();
        if (tab === 'leaderboard') renderLeaderboard();
        else if (tab === 'challenge') renderChallenges();
      }
    }

    // Initialize
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        loadUserProfile(userId);
        switchTab(currentTab);
      } else {
        window.showAlert("Please sign in to play trivia.", false);
        window.location.href = 'login.html';
      }
    });

    document.querySelectorAll('.tab-item').forEach(item => {
      item.addEventListener('click', () => switchTab(item.dataset.tab));
    });

    // Service Worker Script (Embedded)
    if ('serviceWorker' in navigator) {
      const serviceWorkerScript = `
        const CACHE_NAME = 'vynix-trivia-cache-v1';
        const urlsToCache = [
          '/trivia.html',
          'https://www.freepik.com/audio/tune/ballare' // Replace with actual audio URLs
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME).then(cache => {
              return cache.addAll(urlsToCache);
            })
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request).then(response => {
              return response || fetch(event.request);
            })
          );
        });
      `;
      const blob = new Blob([serviceWorkerScript], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).then(reg => {
        console.log('Service Worker registered');
        URL.revokeObjectURL(url);
      }).catch(error => {
        console.error('Service Worker registration failed:', error);
      });
    }
  </script>
  <script>
    // Firebase Cloud Function Script (Reference Only, Must Be Deployed Separately)
    // Note: This cannot run in the browser and is included for completeness.
    // Deploy this using Firebase CLI: `firebase deploy --only functions`
    /*
    const functions = require('firebase-functions');
    const { getDatabase, ref, get, set } = require('firebase/database');

    exports.resetLeaderboardAndAwardAirtime = functions.pubsub.schedule('0 0 * * 0')
      .timeZone('Africa/Johannesburg')
      .onRun(async (context) => {
        const db = getDatabase();
        const weekNumber = Math.ceil(((new Date() - new Date(new Date().getFullYear(), 0, 1)) / 86400000 + new Date(new Date().getFullYear(), 0, 1).getDay() + 1) / 7);
        const prevWeekNumber = weekNumber - 1;

        // Award airtime to top 3
        const leaderboardRef = ref(db, \`trivia/leaderboard/\${prevWeekNumber}\`);
        const snapshot = await get(leaderboardRef);
        if (snapshot.exists()) {
          const leaderboard = snapshot.val();
          const sortedLeaderboard = Object.entries(leaderboard)
            .map(([uid, data]) => ({ uid, ...data }))
            .sort((a, b) => b.score - a.score)
            .slice(0, 3);
          for (let i = 0; i < sortedLeaderboard.length; i++) {
            const userId = sortedLeaderboard[i].uid;
            const airtimeValue = i === 0 ? 'ZAR50' : i === 1 ? 'ZAR30' : 'ZAR20';
            const code = \`AIR-\${Math.random().toString(36).substr(2, 8).toUpperCase()}\`;
            await set(ref(db, \`trivia/airtime/\${prevWeekNumber}/\${userId}\`), {
              code,
              value: airtimeValue,
              awardedAt: new Date().toISOString()
            });
          }
        }

        // Reset leaderboard and answered questions
        await set(ref(db, \`trivia/leaderboard/\${weekNumber}\`), {});
        const usersRef = ref(db, 'users');
        const usersSnapshot = await get(usersRef);
        if (usersSnapshot.exists()) {
          const users = usersSnapshot.val();
          for (const userId in users) {
            await set(ref(db, \`users/\${userId}/trivia/answeredQuestions/\${weekNumber}\`), {});
          }
        }

        return null;
      });
    */
  </script>
</body>
</html>
