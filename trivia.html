<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Trivia Arena</title>

  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Vynix Trivia&quot;,
    &quot;short_name&quot;:&quot;Trivia&quot;,
    &quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#faf8ff&quot;,
    &quot;theme_color&quot;:&quot;#8b5cf6&quot;
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root{--bg:#faf8ff;--card:#ffffff;--accent:#8b5cf6;--correct:#10b981;--wrong:#ef4444;}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:var(--bg);height:100dvh;display:flex;flex-direction:column;overflow:hidden;}
    #header{height:64px;background:var(--card);border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex-shrink:0;}
    #online{ display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;color:#4b5563; }
    #online .avatar{ width:28px;height:28px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.15); }
    #chat{flex:1;overflow-y:auto;padding:12px 16px 80px;display:flex;flex-direction:column;gap:12px;}
    .bubble{max-width:82%;padding:10px 14px;border-radius:20px;position:relative;animation:fadeIn .35s ease-out;}
    .bubble.ai  {align-self:flex-start;background:linear-gradient(135deg,#f8f6ff 0%,#f0e8ff 100%);border:1px solid #e0d6ff;color:#312e69;}
    .bubble.user{align-self:flex-end;background:#fff;border:1.8px solid #c4b5fd;color:#1f1f1f;font-weight:500;}
    .bubble.bot {align-self:flex-start;background:var(--accent);color:#fff;}
    .bubble .meta{ display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:12px;font-weight:600;color:#6b7280; }
    .bubble.user .meta{ justify-content:flex-end; }
    .bubble .meta img{ width:20px;height:20px;border-radius:50%;object-fit:cover; }
    .options{margin-top:10px;display:flex;flex-direction:column;gap:8px;}
    .option{background:#fff;border:2px solid #e2e8f0;border-radius:999px;padding:10px 14px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:10px;}
    .option.selected{border-color:var(--accent);background:#f5f3ff;}
    .option.correct{border-color:var(--correct);background:#ecfdf5;}
    .option.wrong  {border-color:var(--wrong);background:#fef2f2;}
    .countdown{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;font-size:13px;font-weight:600;padding:6px 14px;border-radius:999px;z-index:10;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    #inputBar{height:72px;background:var(--card);border-top:1px solid #e2e8f0;display:flex;align-items:center;padding:0 16px;flex-shrink:0;}
    #input{width:100%;background:#f1f5f9;border:2px solid transparent;border-radius:24px;padding:10px 16px;outline:none;resize:none;transition:.2s;}
    #input:focus{border-color:var(--accent);background:#fff;}
  </style>
</head>
<body class="bg-bg">

  <!-- HEADER -->
  <header id="header">
    <div id="online"></div>
    <button id="backBtn" class="text-2xl">âœ•</button>
  </header>

  <!-- COUNTDOWN -->
  <div id="countdown" class="countdown">Next question in <span id="timeLeft">â€”</span></div>

  <!-- CHAT -->
  <section id="chat"></section>

  <!-- INPUT -->
  <div id="inputBar">
    <textarea id="input" rows="1" placeholder="Type a messageâ€¦"></textarea>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, onDisconnect, set, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, set as dbSet, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const db    = getDatabase(app);

    const ROOM = 'trivia/global';
    const QUESTION_EVERY_MS = 5 * 60 * 1000;
    const SHOW_ANSWER_AFTER_MS = 4 * 60 * 1000;

    let uid, uname, uavatar, xaiKey;
    let currentQ = null, answered = false, nextAt = Date.now() + QUESTION_EVERY_MS;

    const chat      = document.getElementById('chat');
    const input     = document.getElementById('input');
    const timeLeft  = document.getElementById('timeLeft');
    const onlineEl  = document.getElementById('online');
    const backBtn   = document.getElementById('backBtn');

    backBtn.onclick = () => location.href = '/';

    /* ---------- helpers ---------- */
    function $(q){return document.querySelector(q)}
    function addBubble(html, sender, name, avatar){
      const div = document.createElement('div');
      div.className = `bubble ${sender}`;
      div.innerHTML = sender==='user' || sender==='ai'
        ? `<div class="meta"><img src="${avatar}" alt=""/> <span>${name}</span></div>${html}`
        : html;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    /* ---------- xAI ---------- */
    async function askAI(prompt){
      if(!xaiKey) return null;
      try{
        const res = await fetch('https://api.x.ai/v1/chat/completions',{
          method:'POST',
          headers:{Authorization:`Bearer ${xaiKey}`, 'Content-Type':'application/json'},
          body:JSON.stringify({model:'grok-4-1-fast-non-reasoning', messages:[{role:'user', content:prompt}], temperature:0.8, max_tokens:700})
        });
        const j = await res.json();
        return j.choices?.[0]?.message?.content || null;
      }catch{return null}
    }

    /* ---------- question generator ---------- */
    async function generateQuestion(){
      const prompt = `Create a multiple-choice trivia question (general knowledge) with exactly 5 options (A-E).
Return ONLY this format:
Question|CorrectOption|OptionA|OptionB|OptionC|OptionD|OptionE`;
      const raw = await askAI(prompt);
      if(!raw) return null;
      const [q, correct, ...opts] = raw.split('|');
      if(!q || !correct || opts.length!==5) return null;
      return {question:q.trim(), correct:correct.trim(), options:opts.map(o=>o.trim())};
    }

    /* ---------- post / reveal ---------- */
    async function postQuestion(q){
      const key = push(ref(db, `${ROOM}/messages`)).key;
      await dbSet(ref(db, `${ROOM}/messages/${key}`), {type:'question', text:q.question, options:q.options, correct:q.correct, ts:serverTimestamp()});
      setTimeout(()=>postAnswer(q.correct, key), SHOW_ANSWER_AFTER_MS);
    }
    async function postAnswer(correct, qKey){
      const winners = await getWinners(qKey, correct);
      const text = winners.length
        ? `ðŸŽ‰ Answer: <b>${correct}</b> â€“ winners: ${winners.map(w=>w.name).join(', ')}`
        : `Answer: <b>${correct}</b> (no one got it)`;
      const key = push(ref(db, `${ROOM}/messages`)).key;
      await dbSet(ref(db, `${ROOM}/messages/${key}`), {type:'answer', text, ts:serverTimestamp()});
    }
    async function getWinners(qKey, correct){
      const snap = await get(ref(db, `${ROOM}/answers/${qKey}`));
      const list=[];
      snap.forEach(c=>{ const v=c.val(); if(v.choice===correct) list.push(v); });
      return list;
    }

    /* ---------- countdown ---------- */
    function tick(){
      const left = Math.max(0, nextAt - Date.now());
      const mm = Math.floor(left/60000).toString().padStart(2,'0');
      const ss = Math.floor((left%60000)/1000).toString().padStart(2,'0');
      timeLeft.textContent = `${mm}:${ss}`;
      if(left===0){ nextAt = Date.now()+QUESTION_EVERY_MS; generateQuestion().then(q=>{if(q)postQuestion(q);}); }
    }
    setInterval(tick,1000); tick();

    /* ---------- online users ---------- */
    function joinOnline(){
      const refOnline = ref(db, `${ROOM}/online/${uid}`);
      set(refOnline, {name:uname, avatar:uavatar, ts:serverTimestamp()});
      onDisconnect(refOnline).remove();
    }
    onValue(ref(db, `${ROOM}/online`), snap=>{
      const users=[]; let html='';
      snap.forEach(c=>users.push(c.val()));
      html += `<span>${users.length} online</span>`;
      users.slice(0,5).forEach(u=> html+=`<img class="avatar" src="${u.avatar}" title="${u.name}"/>`);
      if(users.length>5) html+=`<span>+${users.length-5}</span>`;
      onlineEl.innerHTML = html;
    });

    /* ---------- render chat ---------- */
    onValue(ref(db, `${ROOM}/messages`), snap=>{
      chat.innerHTML=''; answered=false; currentQ=null;
      snap.forEach(c=>{
        const m=c.val();
        if(m.type==='question'){
          currentQ={key:c.key, ...m};
          renderQuestion(m);
        }else if(m.type==='answer'){
          renderAnswer(m);
        }else{
          addBubble(m.text, m.sender===uid?'user':'ai', m.name, m.avatar);
        }
      });
      chat.scrollTop = chat.scrollHeight;
    });
    function renderQuestion(q){
      const bubble = addBubble('', 'ai', 'Trivia Bot', 'https://api.dicebear.com/7.x/bottts/svg?seed=trivia');
      bubble.innerHTML = `
        <div class="font-semibold mb-2">${q.text}</div>
        <div class="options">
          ${q.options.map((opt,i)=>`
            <label class="option" data-opt="${String.fromCharCode(65+i)}">
              <input type="radio" name="opt" value="${String.fromCharCode(65+i)}">
              <span>${opt}</span>
            </label>`).join('')}
        </div>`;
      bubble.querySelectorAll('.option').forEach(lbl=>{
        lbl.onclick = ()=> selectAnswer(currentQ.key, lbl.dataset.opt, lbl);
      });
    }
    function renderAnswer(ans){
      addBubble(ans.text, 'bot');
      document.querySelectorAll('.option').forEach(lbl=>{
        const opt = lbl.dataset.opt;
        lbl.classList.add(opt===currentQ.correct?'correct':'wrong');
        lbl.querySelector('input').disabled = true;
      });
    }
    async function selectAnswer(qKey, choice, lbl){
      if(answered) return;
      answered = true;
      document.querySelectorAll('.option').forEach(l=>l.classList.remove('selected'));
      lbl.classList.add('selected');
      await dbSet(ref(db, `${ROOM}/answers/${qKey}/${uid}`), {name:uname, choice, ts:serverTimestamp()});
      addBubble(`You chose <b>${choice}</b>`, 'user', uname, uavatar);
    }

    /* ---------- free chat ---------- */
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        const txt = input.value.trim();
        if(!txt) return;
        const key = push(ref(db, `${ROOM}/messages`)).key;
        dbSet(ref(db, `${ROOM}/messages/${key}`), {sender:uid, name:uname, avatar:uavatar, text:txt, ts:serverTimestamp()});
        input.value='';
      }
    });

    /* ---------- auth ---------- */
    onAuthStateChanged(auth, async user=>{
      if(!user){ location.href='login.html'; return; }
      uid   = user.uid;
      uname = user.displayName || user.email.split('@')[0];
      uavatar= user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(uname)}&background=8b5cf6&color=fff`;

      const rc = (await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js')).getRemoteConfig(app);
      await rc.fetchAndActivate();
      xaiKey = rc.getString(rc, 'xai_api_key')?.trim();

      joinOnline();
      addBubble(`${uname} joined the arena ðŸŽ‰`, 'ai', 'Trivia Bot', 'https://api.dicebear.com/7.x/bottts/svg?seed=trivia');
    });
  </script>
</body>
</html>
