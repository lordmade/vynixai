<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ZULABEAT â€“ Your SA Music Bestie</title>

  <!-- PWA & Libs -->
  <link rel="manifest" href="data:application/manifest+json,{
    "name":"Zulabeat","short_name":"Zulabeat","start_url":"/","display":"standalone",
    "background_color":"#FF6B35","theme_color":"#FF6B35",
    "icons":[
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=192","sizes":"192x192"},
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=512","sizes":"512x512"}
    ]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;background:#0f0a1a;color:#fff;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .header{background:linear-gradient(135deg,#FF6B35,#ec4899);padding:1.5rem 1rem 2rem;text-align:center}
    .header h1{font-size:3.2rem;font-weight:900;margin:0;letter-spacing:-2px}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 140px;-webkit-overflow-scrolling:touch}
    .message{margin:1rem 0;display:flex;flex-direction:column;animation:fadeIn .4s}
    .message.user{align-items:flex-end}
    .message .bubble{max-width:88%;padding:14px 18px;border-radius:24px;line-height:1.55;font-size:1.02rem;box-shadow:0 4px 16px rgba(0,0,0,0.2)}
    .message.ai .bubble{background:linear-gradient(135deg,#1e1b4b,#2d1b69);border-bottom-left-radius:6px}
    .message.user .bubble{background:#FF6B35;color:#fff;border-bottom-right-radius:6px}
    .track-info{display:flex;align-items:center;gap:12px;margin-top:8px;cursor:pointer}
    .track-info img{width:48px;height:48px;border-radius:12px}
    .track-text p{margin:0;font-weight:700}
    .timestamp{font-size:0.75rem;opacity:0.7;margin-top:4px}
    .thinking{display:flex;gap:9px;padding:16px 20px}
    .dot{width:11px;height:11px;background:#a78bfa;border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);padding:1rem;padding-bottom:calc(1rem + env(safe-area-inset-bottom))}
    .input-container{max-width:780px;margin:0 auto;background:rgba(255,255,255,0.15);border-radius:28px;padding:10px 16px;display:flex;align-items:center;gap:12px}
    #chatInput{flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:1.1rem}
    .send-btn{width:52px;height:52px;background:#FF6B35;border-radius:50%;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>

  <header class="header">
    <h1>ZULABEAT</h1>
    <p>Your South African music bestie</p>
  </header>

  <section id="chatPane"></section>

  <div class="input-bar">
    <div class="input-container">
      <input type="text" id="chatInput" placeholder="Say hi or ask for music..." autocomplete="off" />
      <button class="send-btn" id="sendBtn"><i data-lucide="send" class="w-6 h-6"></i></button>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const rc = getRemoteConfig(app);
    rc.settings.minimumFetchIntervalMillis = 3600000;
    await fetchAndActivate(rc);

    const xaiKey = getString(rc, 'xai_api_key');
    const spotifyClientId = getString(rc, 'spotify_client_id');
    const spotifyClientSecret = getString(rc, 'spotify_client_secret');

    if (!xaiKey) throw alert("App not configured");

    const chatPane = document.getElementById('chatPane');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const audio = document.getElementById('audioPlayer');

    let history = [];
    let messagesSinceMusic = 0;
    let spotifyToken = null;
    let tokenExpiry = 0;

    const musicReminders = [
      "Anyway... what music you feeling right now? ðŸ”¥",
      "Yo, wanna hear some fire tracks?",
      "Eish, enough talk â€“ what vibe should I play?",
      "Tell me a song or artist, bru!",
      "Music time? Drop a vibe!"
    ];

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const time = new Date().toLocaleTimeString('en-ZA', {hour:'2-digit',minute:'2-digit'});
      div.innerHTML = `<div class="bubble">\( {text.replace(/\n/g,'<br>')}<div class="timestamp"> \){time}</div></div>`;
      chatPane.appendChild(div);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="bubble"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      chatPane.appendChild(d);
      chatPane.scrollTop = chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    async function getSpotifyToken() {
      if (Date.now() < tokenExpiry) return spotifyToken;
      const auth = btoa(`\( {spotifyClientId}: \){spotifyClientSecret}`);
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded", "Authorization":"Basic "+auth },
        body:"grant_type=client_credentials"
      });
      const d = await res.json();
      spotifyToken = d.access_token;
      tokenExpiry = Date.now() + (d.expires_in * 1000) - 60000;
      return spotifyToken;
    }

    async function callGrok(userMsg) {
      addThinking();
      messagesSinceMusic++;

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${xaiKey}` },
          body: JSON.stringify({
            model: "grok-beta",
            messages: [
              { role: "system", content: `You are Zulabeat â€“ a super cool, funny South African music bestie from Joburg. 
Use SA slang, be friendly, keep replies short (1â€“3 sentences).
If the user wants music, reply with:
MUSIC: exact-search-query
Then say something cool.
Every few messages, gently bring it back to music.
Current messages without music: ${messagesSinceMusic}` },
              ...history,
              { role: "user", content: userMsg }
            ],
            temperature: 0.9,
            max_tokens: 400
          })
        });
        const data = await res.json();
        removeThinking();

        const reply = data.choices?.[0]?.message?.content?.trim() || "Eish, I didn't get that";

        const musicMatch = reply.match(/^MUSIC:\s*(.+)$/m);
        if (musicMatch) {
          const query = musicMatch[1].split('\n')[0].trim();
          const text = reply.replace(/^MUSIC:.+$/m, '').trim() || "Hereâ€™s some fire!";
          addMessage(text, 'ai');
          messagesSinceMusic = 0;
          await searchAndPlay(query);
        } else {
          addMessage(reply, 'ai');
          // Remind about music every 2â€“3 messages
          if (messagesSinceMusic >= 3) {
            setTimeout(() => {
              const reminder = musicReminders[Math.floor(Math.random() * musicReminders.length)];
              addMessage(reminder, 'ai');
              messagesSinceMusic = 0;
            }, 1200);
          }
        }

        history.push({ role: "user", content: userMsg });
        history.push({ role: "assistant", content: reply });
        if (history.length > 20) history = history.slice(-20);

      } catch (e) {
        removeThinking();
        addMessage("Network trouble â€“ try again", 'ai');
      }
    }

    async function searchAndPlay(query) {
      try {
        const token = await getSpotifyToken();
        const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&market=ZA&limit=10`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        const tracks = data.tracks.items;

        if (!tracks.length) {
          addMessage("Couldn't find that one â€“ try another?", 'ai');
          return;
        }

        tracks.forEach(t => {
          const art = t.album.images[0]?.url || '';
          const bubble = document.createElement('div');
          bubble.className = 'message ai';
          bubble.innerHTML = `
            <div class="bubble track-info" style="cursor:pointer">
              <img src="${art}" alt="">
              <div class="track-text">
                <p>${t.name}</p>
                <small>${t.artists.map(a=>a.name).join(', ')}</small>
              </div>
            </div>
          `;
          bubble.onclick = () => {
            if (t.preview_url) {
              audio.src = t.preview_url;
              audio.play();
              addMessage(`Now playing: \( {t.name} â€“ \){t.artists[0].name} ðŸŽ¶`, 'ai');
            } else {
              window.open(t.external_urls.spotify, '_blank');
              addMessage(`Opened in Spotify: ${t.name}`, 'ai');
            }
          };
          chatPane.appendChild(bubble);
        });
      } catch { addMessage("Music search failed", 'ai'); }
    }

    function send() {
      const msg = chatInput.value.trim();
      if (!msg) return;
      addMessage(msg, 'user');
      chatInput.value = '';
      callGrok(msg);
    }

    chatInput.addEventListener('input', () => sendBtn.disabled = !chatInput.value.trim());
    sendBtn.onclick = send;
    chatInput.addEventListener('keydown', e => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); } });

    addMessage("Yo bru! I'm Zulabeat â€“ your SA music bestie. What's good today? ðŸ˜Ž", 'ai');
  </script>
</body>
</html>
