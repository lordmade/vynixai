<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>ZULABEAT – SA's AI Music App</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{
    "name":"Zulabeat","short_name":"Zulabeat",
    "description":"Just say the vibe – Amapiano, Gqom, Kwaito, Maskandi",
    "start_url":"/","display":"standalone",
    "background_color":"#FF6B35","theme_color":"#FF6B35",
    "icons":[
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=192","sizes":"192x192","type":"image/svg+xml"},
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=512","sizes":"512x512","type":"image/svg+xml"}
    ]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Zulabeat">

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#FF6B35,#ec4899);color:#fff;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .header {padding:1.5rem 1rem;text-align:center}
    .header h1 {font-size:3.5rem;font-weight:900;margin:0;letter-spacing:-2px}
    .header p {font-size:1.2rem;opacity:0.9}
    .tracks {flex:1;overflow-y:auto;padding:1rem;display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
    .track-card {background:rgba(255,255,255,0.15);backdrop-filter:blur(12px);border-radius:24px;overflow:hidden;cursor:pointer;transition:transform .2s}
    .track-card:hover {transform:scale(1.05)}
    .track-card img {width:100%;aspect-ratio:1;object-fit:cover}
    .track-info {padding:0.75rem}
    .track-info p {margin:0;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .track-info small {opacity:0.8;font-size:0.85rem}
    .input-bar {position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);padding:1rem;display:flex;align-items:center;gap:1rem;z-index:100}
    .input-container {flex:1;background:rgba(255,255,255,0.2);border-radius:999px;padding:0.75rem 1.25rem;display:flex;align-items:center;gap:0.75rem}
    #queryInput {flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:1.1rem}
    #queryInput::placeholder {color:rgba(255,255,255,0.7)}
    .send-btn {width:48px;height:48px;background:#fff;color:#FF6B35;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .now-playing {display:flex;align-items:center;gap:1rem;flex:1;overflow:hidden}
    .now-playing img {width:56px;height:56px;border-radius:12px}
    .now-playing-info {flex:1;overflow:hidden}
    .now-playing-info p {margin:0;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .now-playing-info small {opacity:0.9}
    .install-banner {position:fixed;bottom:100px;left:8px;right:8px;background:#fff;color:#000;padding:1rem;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.3);display:none;align-items:center;justify-content:space-between;z-index:50}
    .loading {text-align:center;padding:3rem;color:#fff;opacity:0.8}
  </style>
</head>
<body>

  <header class="header">
    <h1>ZULABEAT</h1>
    <p>Just say the vibe</p>
  </header>

  <section class="tracks" id="tracksGrid">
    <div class="loading">Loading your music engine...</div>
  </section>

  <div class="input-bar">
    <div class="now-playing" id="nowPlaying" style="display:none">
      <img id="nowCover" src="" alt="">
      <div class="now-playing-info">
        <p id="nowTitle">No track playing</p>
        <small id="nowArtist"></small>
      </div>
      <button id="playPauseBtn" class="text-3xl">Play</button>
    </div>

    <div class="input-container">
      <input type="text" id="queryInput" placeholder="e.g. Amapiano for the braai..." autocomplete="off" />
      <button class="send-btn" id="sendBtn"><i data-lucide="send" class="w-6 h-6"></i></button>
    </div>
  </div>

  <div class="install-banner" id="installBanner">
    <span>Install Zulabeat – tap “Add to Home Screen”</span>
    <button id="installBtn" class="bg-orange-600 text-white px-4 py-2 rounded-full font-bold">Install</button>
  </div>

  <audio id="audioPlayer" preload="auto"></audio>

  <!-- Firebase + Remote Config -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const remoteConfig = getRemoteConfig(app);
    remoteConfig.settings.minimumFetchIntervalMillis = 3600000;

    let spotifyClientId = null;
    let spotifyClientSecret = null;
    let xaiKey = null;

    // Load keys from Remote Config
    await fetchAndActivate(remoteConfig);
    spotifyClientId = getString(remoteConfig, 'spotify_client_id');
    spotifyClientSecret = getString(remoteConfig, 'spotify_client_secret');
    xaiKey = getString(remoteConfig, 'xai_api_key');

    if (!spotifyClientId || !xaiKey) {
      document.getElementById('tracksGrid').innerHTML = `<div class="loading">App not configured yet – contact admin</div>`;
      throw new Error("Missing config");
    }

    const audio = document.getElementById('audioPlayer');
    const queryInput = document.getElementById('queryInput');
    const sendBtn = document.getElementById('sendBtn');
    const tracksGrid = document.getElementById('tracksGrid');
    const nowPlaying = document.getElementById('nowPlaying');
    const nowCover = document.getElementById('nowCover');
    const nowTitle = document.getElementById('nowTitle');
    const nowArtist = document.getElementById('nowArtist');
    const playPauseBtn = document.getElementById('playPauseBtn');

    let currentTrack = null;
    let spotifyToken = null;
    let tokenExpiry = 0;

    // PWA Install
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBanner').style.display = 'flex';
    });
    document.getElementById('installBtn').onclick = () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          document.getElementById('installBanner').style.display = 'none';
          deferredPrompt = null;
        });
      }
    };

    // Get fresh Spotify token
    async function getSpotifyToken() {
      if (Date.now() < tokenExpiry) return spotifyToken;
      const auth = btoa(`\( {spotifyClientId}: \){spotifyClientSecret}`);
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Authorization": "Basic " + auth
        },
        body: "grant_type=client_credentials"
      });
      const data = await res.json();
      spotifyToken = data.access_token;
      tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000;
      return spotifyToken;
    }

    // Grok cleans the query
    async function getCleanQuery(userInput) {
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${xaiKey}`
        },
        body: JSON.stringify({
          model: "grok-beta",
          messages: [{
            role: "user",
            content: `Turn this into the BEST Spotify search query for South African music: "${userInput}"\nOnly return the query. No quotes. No explanation.`
          }],
          temperature: 0.7,
          max_tokens: 30
        })
      });
      const data = await res.json();
      return (data.choices?.[0]?.message?.content || userInput).trim();
    }

    // Search & display tracks
    async function searchTracks() {
      const userText = queryInput.value.trim();
      if (!userText) return;

      tracksGrid.innerHTML = `<div class="loading">Finding your vibe...</div>`;

      try {
        const cleanQuery = await getCleanQuery(userText);
        const token = await getSpotifyToken();

        const res = await fetch(
          `https://api.spotify.com/v1/search?q=${encodeURIComponent(cleanQuery)}&type=track&market=ZA&limit=12`,
          { headers: { Authorization: `Bearer ${token}` } }
        );
        const data = await res.json();
        const tracks = data.tracks.items;

        tracksGrid.innerHTML = "";
        if (tracks.length === 0) {
          tracksGrid.innerHTML = `<div class="col-span-2 text-center py-20 opacity-80">No tracks found – try another vibe</div>`;
          return;
        }

        tracks.forEach(track => {
          const card = document.createElement('div');
          card.className = 'track-card';
          const art = track.album.images[0]?.url || 'https://via.placeholder.com/300';
          card.innerHTML = `
            <img src="\( {art}" alt=" \){track.name}">
            <div class="track-info">
              <p>${track.name}</p>
              <small>${track.artists.map(a => a.name).join(', ')}</small>
            </div>
          `;
          card.onclick = () => playTrack(track);
          tracksGrid.appendChild(card);
        });
      } catch (err) {
        tracksGrid.innerHTML = `<div class="col-span-2 text-center py-20 opacity-80">Error – check connection</div>`;
      }

      queryInput.value = '';
    }

    function playTrack(track) {
      currentTrack = track;
      nowCover.src = track.album.images[0]?.url || '';
      nowTitle.textContent = track.name;
      nowArtist.textContent = track.artists.map(a => a.name).join(', ');
      nowPlaying.style.display = 'flex';

      if (track.preview_url) {
        audio.src = track.preview_url;
        audio.play();
        playPauseBtn.innerHTML = 'Pause';
      } else {
        window.open(track.external_urls.spotify, '_blank');
        playPauseBtn.innerHTML = 'Play';
      }
    }

    playPauseBtn.onclick = () => {
      if (audio.paused) {
        audio.play();
        playPauseBtn.innerHTML = 'Pause';
      } else {
        audio.pause();
        playPauseBtn.innerHTML = 'Play';
      }
    };

    audio.onended = () => playPauseBtn.innerHTML = 'Play';

    sendBtn.onclick = searchTracks;
    queryInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') searchTracks();
    });

    // Welcome
    tracksGrid.innerHTML = `
      <div class="col-span-2 text-center py-20 text-xl opacity-80">
        Welcome to Zulabeat<br><br>
        Try saying:<br><br>
        • Amapiano for load-shedding<br>
        • Gqom that slaps in Durban<br>
        • Kwaito classics<br>
        • Maskandi for the soul
      </div>`;
  </script>
</body>
</html>
