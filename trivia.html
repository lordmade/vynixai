<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#8b5cf6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />

  <title>Vynix Trivia Arena</title>

  <!-- Icons -->
  <link rel="icon" href="https://api.dicebear.com/7.x/bottts/svg?seed=vynix" sizes="192x192" />
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/bottts/svg?seed=vynix" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    "name": "Vynix Trivia Arena",
    "short_name": "Vynix Trivia",
    "description": "Live global trivia with real-time chat!",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#faf8ff",
    "theme_color": "#8b5cf6",
    "orientation": "portrait-primary",
    "icons": [
      {
        "src": "https://api.dicebear.com/7.x/bottts/svg?seed=vynix&size=192",
        "sizes": "192x192",
        "type": "image/png"
      },
      {
        "src": "https://api.dicebear.com/7.x/bottts/svg?seed=vynix&size=512",
        "sizes": "512x512",
        "type": "image/png"
      }
    ]
  }">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root {
      --bg: #faf8ff;
      --card: #ffffff;
      --accent: #8b5cf6;
      --correct: #10b981;
      --wrong: #ef4444;
      --shadow: 0 4px 20px rgba(139,92,246,0.15);
    }
    * { touch-action: manipulation; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      margin: 0;
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #header {
      height: 64px;
      background: var(--card);
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
      box-shadow: var(--shadow);
      z-index: 10;
    }
    #online {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #4b5563;
      font-size: 14px;
    }
    #online .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px 16px 100px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      -webkit-overflow-scrolling: touch;
    }
    .bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 22px;
      animation: pop 0.3s ease-out;
      word-break: break-word;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .bubble.ai   { align-self: flex-start; background: #f1f0ff; border: 1px solid #e0d6ff; color: #333; }
    .bubble.user { align-self: flex-end; background: #e0d4ff; color: #000; font-weight: 500; }
    .bubble.bot  { align-self: flex-start; background: var(--accent); color: white; font-weight: 600; }
    .bubble .meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 12px;
      opacity: 0.8;
    }
    .bubble.user .meta { justify-content: flex-end; }
    .bubble .meta img { width: 20px; height: 20px; border-radius: 50%; }

    .options { margin-top: 14px; display: grid; gap: 10px; }
    .option {
      background: white;
      border: 2.5px solid #e2e8f0;
      border-radius: 20px;
      padding: 16px 18px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .option:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(139,92,246,0.2); }
    .option.selected { border-color: var(--accent); background: #f3e8ff; transform: scale(1.02); }
    .option.correct { border-color: var(--correct); background: #f0fdf4; }
    .option.wrong   { border-color: var(--wrong);   background: #fef2f2; }

    .countdown {
      position: fixed;
      top: 74px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      padding: 8px 18px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: var(--shadow);
      z-index: 999;
    }

    #inputBar {
      background: var(--card);
      border-top: 1px solid #e2e8f0;
      padding: 12px 16px;
      display: flex;
      flex;
      align-items: flex-end;
      gap: 12px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
    }
    #input {
      flex: 1;
      background: #f1f5f9;
      border: none;
      border-radius: 24px;
      padding: 14px 18px;
      font-size: 16px;
      outline: none;
      min-height: 48px;
      max-height: 120px;
      resize: none;
      border: 2px solid transparent;
    }
    #input:focus { background: white; border-color: var(--accent); }
    #sendBtn {
      width: 50px;
      height: 50px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
      transition: all 0.2s;
    }
    #sendBtn:active { transform: scale(0.92); }
    #sendBtn:disabled { background: #ccc; }

    @keyframes pop {
      from { opacity: 0; transform: scale(0.9) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    /* Install Prompt */
    #installBtn {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #8b5cf6;
      color: white;
      padding: 14px 32px;
      border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 8px 25px rgba(139,92,246,0.4);
      z-index: 1000;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
  </style>
</head>
<body>

  <header id="header">
    <div id="online"><span>0 online</span></div>
    <h1 class="text-xl font-bold text-purple-700">Vynix Trivia</h1>
  </header>

  <div id="countdown" class="countdown">Next in <span id="timeLeft">05:00</span></div>

  <section id="chat"></section>

  <div id="inputBar">
    <textarea id="input" placeholder="Say something..." rows="1"></textarea>
    <button id="sendBtn" disabled>
      <i data-lucide="send"></i>
    </button>
  </div>

  <!-- Install Button (shown once) -->
  <button id="installBtn" style="display:none">Install App</button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, set, onDisconnect, serverTimestamp, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    const ROOM = 'trivia/global';
    const QUESTION_EVERY = 5 * 60 * 1000;
    const REVEAL_AFTER = 4 * 60 * 1000;

    let uid, name, avatar, grokKey;
    let currentQKey = null;
    let hasAnswered = false;
    let nextQAt = Date.now() + QUESTION_EVERY;
    let deferredPrompt;

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const timeEl = document.getElementById('timeLeft');
    const onlineEl = document.getElementById('online');
    const installBtn = document.getElementById('installBtn');

    lucide.createIcons();

    // PWA Install Prompt
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
      installBtn.onclick = () => {
        installBtn.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choice => {
          if (choice.outcome === 'accepted') console.log('Installed!');
          deferredPrompt = null;
        });
      };
    });

    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = input.scrollHeight + 'px';
      sendBtn.disabled = !input.value.trim();
    });

    function sendMsg() {
      const text = input.value.trim();
      if (!text) return;
      const key = push(ref(db, `${ROOM}/messages`)).key;
      set(ref(db, `\( {ROOM}/messages/ \){key}`), {
        sender: uid,
        name, avatar, text,
        ts: serverTimestamp()
      });
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;
    }

    sendBtn.onclick = sendMsg;
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });

    function addBubble(html, type = 'ai', n = '', a = '') {
      const b = document.createElement('div');
      b.className = `bubble ${type}`;
      b.innerHTML = type === 'bot'
        ? html
        : `<div class="meta"><img src="\( {a}"><span> \){n}</span></div>${html}`;
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
    }

    async function genQuestion() {
      if (!grokKey) return null;
      const res = await fetch('https://api.x.ai/v1/chat/completions', {
        method: 'POST',
        headers: { Authorization: `Bearer ${grokKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: "grok-beta",
          messages: [{role: "user", content: "Make a fun trivia question with 5 options A-E. Return ONLY: Question|Correct|A|B|C|D|E"}],
          temperature: 0.8
        })
      });
      const txt = await res.json().then(j => j.choices?.[0]?.message?.content || '');
      const p = txt.split('|');
      if (p.length < 7) return null;
      return {q: p[0].trim(), c: p[1].trim().toUpperCase(), o: p.slice(2).map(t=>t.trim())};
    }

    async function postQ(q) {
      const k = push(ref(db, `${ROOM}/messages`)).key;
      await set(ref(db, `\( {ROOM}/messages/ \){k}`), {type:'question', text:q.q, options:q.o, correct:q.c, ts:serverTimestamp()});
      setTimeout(() => revealAns(q.c, k), REVEAL_AFTER);
    }

    async function revealAns(correct, qk) {
      const snap = await get(ref(db, `\( {ROOM}/answers/ \){qk}`));
      const wins = [];
      snap.forEach(c => { const v=c.val(); if(v.choice===correct) wins.push(v.name); });
      const msg = wins.length ? `Correct answer: <b>\( {correct}</b> — Winners: \){wins.join(', ')}` : `Correct answer: <b>${correct}</b> — No winners`;
      const k = push(ref(db, `${ROOM}/messages`)).key;
      set(ref(db, `\( {ROOM}/messages/ \){k}`), {type:'answer', text:msg, ts:serverTimestamp()});
    }

    setInterval(() => {
      const left = Math.max(0, nextQAt - Date.now());
      const m = String(Math.floor(left/60000)).padStart(2,'0');
      const s = String(Math.floor((left%60000)/1000)).padStart(2,'0');
      timeEl.textContent = `\( {m}: \){s}`;
      if (left <= 0) { nextQAt = Date.now() + QUESTION_EVERY; genQuestion().then(q=>q&&postQ(q)); }
    }, 1000);

    onValue(ref(db, `${ROOM}/online`), s => {
      const u = [];
      s.forEach(c=>u.push(c.val()));
      onlineEl.innerHTML = `<span>\( {u.length} playing</span>` + u.slice(0,5).map(x=>`<img class="avatar" src=" \){x.avatar}" title="${x.name}">`).join('');
    });

    onValue(ref(db, `${ROOM}/messages`), snap => {
      chat.innerHTML = '';
      hasAnswered = false;
      currentQKey = null;
      snap.forEach(c => {
        const m = c.val();
        if (m.type === 'question') {
          currentQKey = c.key;
          renderQ(m, c.key);
        } else if (m.type === 'answer') {
          addBubble(m.text, 'bot');
          document.querySelectorAll('.option').forEach(o=>o.style.pointerEvents='none');
        } else {
          addBubble(m.text, m.sender===uid?'user':'ai', m.name, m.avatar);
        }
      });
      chat.scrollTop = chat.scrollHeight;
    });

    function renderQ(q, key) {
      const b = addBubble('', 'ai', 'Trivia Bot', 'https://api.dicebear.com/7.x/bottts/svg?seed=trivia');
      b.innerHTML = `<div class="font-bold text-lg mb-3">\( {q.text}</div><div class="options"> \){q.options.map((t,i)=>`
        <div class="option" data-l="${String.fromCharCode(65+i)}">
          <b>\( {String.fromCharCode(65+i)}.</b> \){t}
        </div>`).join('')}</div>`;

      b.querySelectorAll('.option').forEach(el => {
        el.onclick = () => {
          if (hasAnswered) return;
          hasAnswered = true;
          b.querySelectorAll('.option').forEach(x=>x.classList.remove('selected'));
          el.classList.add('selected');
          set(ref(db, `\( {ROOM}/answers/ \){key}/${uid}`), {name, choice:el.dataset.l, ts:serverTimestamp()});
          addBubble(`I chose <b>${el.dataset.l}</b>`, 'user', name, avatar);
        };
      });
    }

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = 'login.html';
      uid = user.uid;
      name = user.displayName || user.email.split('@')[0];
      avatar = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=8b5cf6&color=fff`;

      try {
        await fetchAndActivate(rc);
        grokKey = getString(rc, 'xai_api_key')?.trim();
      } catch(e) {}

      set(ref(db, `\( {ROOM}/online/ \){uid}`), {name, avatar, ts:serverTimestamp()});
      onDisconnect(ref(db, `\( {ROOM}/online/ \){uid}`)).remove();

      addBubble(`<b>${name}</b> joined!`, 'ai', 'System', 'https://api.dicebear.com/7.x/bottts/svg?seed=system');
    });
  </script>
</body>
</html>
