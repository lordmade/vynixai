<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>QuickDispatch ‚Äì AI Order Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --card-bg: #f7f9fa;
      --text-primary: #0f1419;
      --text-secondary: #536471;
      --border: #e1e8ed;
      --accent: #2563eb; /* BLUE */
      --chat-bubble-sent: #2563eb; /* BLUE */
      --chat-bubble-received: #f7f9fa;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --glow: 0 0 10px rgba(37, 99, 235, .35); /* BLUE GLOW */
    }
    body.dark {
      --bg: #000000;
      --card-bg: #16181c;
      --text-primary: #ffffff;
      --text-secondary: #71767b;
      --border: #2f3336;
      --chat-bubble-received: #16181c;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      touch-action: manipulation;
      line-height: 1.4;
      transition: background-color 0.3s ease, color 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .main-content {
      padding: 20px 20px 120px;
      max-width: 600px;
      margin: 0 auto;
    }
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
      max-height: calc(100vh - 140px);
    }
    .message-date {
      text-align: center;
      margin: 20px 0;
      color: var(--text-secondary);
      font-size: 13px;
    }
    .message-item {
      display: flex;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }
    .message-received {
      flex-direction: row;
    }
    .message-sent {
      flex-direction: row-reverse;
    }
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--accent);
      color: #ffffff;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 12px;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 20px;
      word-wrap: break-word;
      line-height: 1.4;
      position: relative;
      cursor: pointer;
      user-select: text;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    .message-received .message-bubble {
      background: var(--chat-bubble-received);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
      margin-left: 12px;
      border: 1px solid var(--border);
    }
    .message-sent .message-bubble {
      background: var(--chat-bubble-sent);
      color: #ffffff;
      border-bottom-right-radius: 4px;
      margin-right: 12px;
      box-shadow: var(--glow);
    }
    .order-info {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .order-info:hover {
      border-color: var(--accent);
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 14px;
    }
    .order-total {
      border-top: 1px solid var(--border);
      margin-top: 8px;
      padding-top: 8px;
      font-weight: bold;
    }
    .message-time {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }
    .message-sent .message-time {
      color: rgba(255, 255, 255, 0.8);
    }
    .status-icon {
      font-size: 16px;
    }
    .status-sent {
      color: rgba(255, 255, 255, 0.7);
    }
    .input-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
      box-shadow: var(--shadow-sm);
    }
    .input-group {
      flex: 1;
      display: flex;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
    }
    .input-group textarea {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      padding: 12px 20px;
      color: var(--text-primary);
      font-size: 16px;
      resize: none;
      max-height: 120px;
      font-family: inherit;
      -webkit-tap-highlight-color: transparent;
    }
    .input-group textarea::placeholder {
      color: var(--text-secondary);
    }
    .input-icon {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      padding: 12px;
      transition: color 0.2s ease;
      min-width: 44px;
      -webkit-tap-highlight-color: transparent;
    }
    .input-icon:hover {
      color: var(--accent);
    }
    .send-btn {
      background: var(--accent);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      transition: all 0.2s ease;
      box-shadow: var(--glow);
      -webkit-tap-highlight-color: transparent;
    }
    .send-btn:hover {
      transform: scale(1.05);
    }
    .send-btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
      box-shadow: none;
    }
    .typing-indicator {
      font-style: italic;
      color: var(--accent);
      font-size: 14px;
      padding: 8px 12px;
      background: var(--chat-bubble-received);
      border-radius: 20px;
      max-width: 70%;
      margin-left: 52px;
      border-bottom-left-radius: 4px;
    }
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .quick-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #horizontal-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
    #horizontal-spinner.active {
      display: block;
    }
    #spinner-segment {
      width: 40px;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #alert-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 300px;
      -webkit-tap-highlight-color: transparent;
    }
    #alert-message.active {
      transform: translateX(0);
    }
    .thinking {
      display: inline-flex;
      gap: 4px;
      margin-left: 8px;
    }
    .dot {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    @media (max-width: 768px) {
      .main-content {
        padding: 20px 16px 120px;
      }
      .input-bar {
        padding: 12px 16px;
        gap: 8px;
      }
    }
  </style>
</head>
<body class="light">
  <main class="main-content">
    <div class="messages-container" id="messages-container"></div>
  </main>

  <div class="input-bar">
    <button class="input-icon material-icons" title="Attach" onclick="attachFile()">attach_file</button>
    <div class="input-group">
      <textarea id="message-input" placeholder="What would you like to order?" rows="1"></textarea>
    </div>
    <button class="send-btn material-icons" id="send-btn" disabled>send</button>
  </div>

  <div id="horizontal-spinner">
    <div id="spinner-segment"></div>
  </div>
  <div id="alert-message" role="alert" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const rc = getRemoteConfig(app);
    rc.settings.minimumFetchIntervalMillis = 3600000;
    await fetchAndActivate(rc);

    const xaiKey = getString(rc, 'xai_api_key');
    const shipdayApiKey = getString(rc, 'shipday_api_key');

    if (!xaiKey || !shipdayApiKey) {
      alert("App not configured: Missing API keys");
    }

    // UI Elements
    const chatPane = document.getElementById('messages-container');
    const chatInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const spinner = document.getElementById('horizontal-spinner');
    const alertBox = document.getElementById('alert-message');

    // Order State Management
    let history = [];
    let currentOrder = {
      items: [],
      customer: {},
      pickup: {},
      total: 0,
      status: 'collecting' // collecting, confirming, confirmed
    };

    function showSpinner() { spinner.classList.add('active'); }
    function hideSpinner() { spinner.classList.remove('active'); }
    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.classList.add('active');
      setTimeout(() => alertBox.classList.remove('active'), 4000);
    }

    function formatTime() {
      return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function addMessage(content, sender, orderData = null) {
      const div = document.createElement('div');
      div.className = `message-item ${sender === 'user' ? 'message-sent' : 'message-received'}`;
      const time = formatTime();
      
      let messageContent = content;
      if (orderData && sender === 'ai') {
        messageContent = `
          ${content}
          <div class="order-info" onclick="viewOrderDetails()">
            <div style="font-weight: bold; margin-bottom: 8px;">Order #${orderData.orderNumber}</div>
            ${orderData.items.map(item => `
              <div class="order-item">
                <span>${item.quantity}x ${item.name}</span>
                <span>$${(item.quantity * item.unitPrice).toFixed(2)}</span>
              </div>
            `).join('')}
            <div class="order-total">
              <span>Total</span>
              <span>$${orderData.total.toFixed(2)}</span>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
              üìç ${orderData.customer.address.street}
            </div>
          </div>
        `;
      }

      div.innerHTML = `
        <div class="message-avatar">${sender === 'user' ? 'U' : 'D'}</div>
        <div class="message-bubble">
          ${messageContent.replace(/\n/g, '<br>')}
          <div class="message-time">${time}</div>
        </div>
      `;
      
      chatPane.appendChild(div);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'typing-indicator';
      d.innerHTML = 'Dispatch AI is thinking<div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      chatPane.appendChild(d);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function removeThinking() {
      document.getElementById('thinking')?.remove();
    }

    async function createShipdayOrder() {
      try {
        showSpinner();
        
        const orderPayload = {
          orderNumber: `ORD-${Date.now().toString().slice(-6)}`,
          customer: {
            name: currentOrder.customer.name,
            phoneNumber: currentOrder.customer.phone,
            email: currentOrder.customer.email || '',
            address: currentOrder.customer.address
          },
          pickup: {
            name: "Restaurant Pickup",
            phoneNumber: "+1234567890",
            address: {
              street: "123 Main St",
              city: "New York",
              state: "NY",
              zip: "10001",
              country: "USA"
            }
          },
          orderItems: currentOrder.items,
          paymentMethod: currentOrder.paymentMethod || "credit_card",
          tip: currentOrder.tip || 0,
          note: currentOrder.note || ""
        };

        const response = await fetch("https://api.shipday.com/orders", {
          method: "POST",
          headers: {
            "Authorization": `Basic ${btoa(shipdayApiKey + ':')}`,
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(orderPayload)
        });

        const result = await response.json();
        
        if (result.success) {
          return {
            success: true,
            orderId: result.orderId,
            orderNumber: orderPayload.orderNumber,
            trackingUrl: `https://track.shipday.com/${result.orderId}`
          };
        } else {
          throw new Error(result.response || "Failed to create order");
        }
      } catch (error) {
        console.error("Shipday API error:", error);
        throw error;
      } finally {
        hideSpinner();
      }
    }

    async function getReply(userMsg) {
      addThinking();

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { 
            "Authorization": `Bearer ${xaiKey}`, 
            "Content-Type": "application/json" 
          },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [
              { 
                role: "system", 
                content: `You are QuickDispatch ‚Äì a friendly, efficient order-taking AI assistant. Your job is to:
                1. Help customers place delivery orders
                2. Collect: items with quantities, customer name, phone, delivery address, payment method
                3. Calculate totals and confirm orders
                4. Be concise, helpful, and professional
                5. Use casual, friendly tone but stay efficient
                6. When you have all required info, respond with: ORDER_CONFIRM: <brief summary>
                7. If info is missing, ask for it specifically`
              },
              ...history.slice(-20),
              { role: "user", content: userMsg }
            ],
            temperature: 0.7,
            max_tokens: 300
          })
        });
        
        const data = await res.json();
        removeThinking();

        const reply = data.choices?.[0]?.message?.content?.trim() || "Sorry, I didn't understand that.";
        
        // Check if we should confirm the order
        const confirmMatch = reply.match(/^ORDER_CONFIRM:\s*(.+)$/m);
        if (confirmMatch && currentOrder.status === 'collecting') {
          currentOrder.status = 'confirming';
          
          // Show order summary
          const orderSummary = `
            üìã Order Summary:
            ${currentOrder.items.map(item => `${item.quantity}x ${item.name} - $${(item.quantity * item.unitPrice).toFixed(2)}`).join('\n')}
            Total: $${currentOrder.total.toFixed(2)}
            Delivery: ${currentOrder.customer.address?.street || 'Not provided'}
            Payment: ${currentOrder.paymentMethod || 'Not selected'}
            
            Type "yes" to confirm or "cancel" to start over.
          `;
          
          addMessage(orderSummary, 'ai');
          
          // Add quick action buttons
          setTimeout(() => addQuickActions(['Confirm', 'Cancel']), 100);
        } else if (userMsg.toLowerCase() === 'yes' && currentOrder.status === 'confirming') {
          // Final order confirmation
          addMessage("üöÄ Placing your order now...", 'ai');
          
          try {
            const result = await createShipdayOrder();
            currentOrder.status = 'confirmed';
            
            addMessage(
              `‚úÖ Order confirmed! \n\nYour order #${result.orderNumber} is being prepared.`, 
              'ai',
              {
                orderNumber: result.orderNumber,
                items: currentOrder.items,
                total: currentOrder.total,
                customer: currentOrder.customer
              }
            );
            
            // Add tracking button
            const trackingBtn = document.createElement('div');
            trackingBtn.className = 'quick-actions';
            trackingBtn.innerHTML = `<button class="quick-btn" onclick="window.open('${result.trackingUrl}', '_blank')">Track Order</button>`;
            chatPane.appendChild(trackingBtn);
            
            // Reset order state
            setTimeout(() => {
              currentOrder = { items: [], customer: {}, pickup: {}, total: 0, status: 'collecting' };
              addMessage("Need anything else? Just ask!", 'ai');
            }, 2000);
            
          } catch (error) {
            addMessage("‚ùå Sorry, there was an issue placing your order. Please try again.", 'ai');
          }
        } else if (userMsg.toLowerCase() === 'cancel') {
          currentOrder = { items: [], customer: {}, pickup: {}, total: 0, status: 'collecting' };
          addMessage("Order cancelled. Let's start fresh! What would you like?", 'ai');
        } else {
          addMessage(reply, 'ai');
          
          // Update current order state based on conversation
          updateOrderState(userMsg, reply);
        }

        history.push({ role: "user", content: userMsg });
        history.push({ role: "assistant", content: reply });
        if (history.length > 40) history = history.slice(-40);

      } catch (e) {
        removeThinking();
        addMessage("Network issue ‚Äì please try again", 'ai');
      }
    }

    function updateOrderState(userMsg, aiReply) {
      // Simple parsing to extract order details from conversation
      // In production, you'd use more sophisticated NLP
      
      // Extract items (format: "2x pizza $12.99" or "burger $8.99")
      const itemMatches = userMsg.match(/(\d+)x?\s*([\w\s]+?)(?:\s+\$([\d.]+))?/i);
      if (itemMatches && !currentOrder.items.length) {
        const quantity = parseInt(itemMatches[1]) || 1;
        const name = itemMatches[2].trim();
        const price = parseFloat(itemMatches[3]) || 9.99; // Default price
        
        currentOrder.items.push({
          name,
          quantity,
          unitPrice: price
        });
        
        currentOrder.total += quantity * price;
      }

      // Extract customer info
      const nameMatch = userMsg.match(/name[:\\s]*([a-z\\s]+)/i);
      if (nameMatch) currentOrder.customer.name = nameMatch[1].trim();

      const phoneMatch = userMsg.match(/\\b(\\d{3}[-.]?\\d{3}[-.]?\\d{4})\\b/);
      if (phoneMatch) currentOrder.customer.phone = phoneMatch[0];

      const addressMatch = userMsg.match(/(\\d+\\s+[\\w\\s]+(?:st|ave|drive|dr|road|rd|blvd|lane|ln)\\b)/i);
      if (addressMatch) {
        currentOrder.customer.address = {
          street: addressMatch[0],
          city: "New York", // Default, could be extracted
          state: "NY",
          zip: "10001",
          country: "USA"
        };
      }

      // Extract payment method
      if (userMsg.match(/cash/i)) currentOrder.paymentMethod = "cash";
      if (userMsg.match(/card|credit/i)) currentOrder.paymentMethod = "credit_card";
    }

    function addQuickActions(actions) {
      const actionDiv = document.createElement('div');
      actionDiv.className = 'quick-actions';
      actionDiv.innerHTML = actions.map(action => 
        `<button class="quick-btn" onclick="quickAction('${action}')">${action}</button>`
      ).join('');
      chatPane.appendChild(actionDiv);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    window.quickAction = function(action) {
      chatInput.value = action.toLowerCase();
      send();
      // Remove the action buttons
      document.querySelectorAll('.quick-actions').forEach(el => el.remove());
    };

    async function send() {
      const msg = chatInput.value.trim();
      if (!msg) return;
      
      addMessage(msg, 'user');
      chatInput.value = ''; 
      chatInput.style.height = 'auto';
      
      await getReply(msg);
    }

    window.attachFile = () => {
      showAlert('File upload not supported for order chat');
    };

    window.viewOrderDetails = function() {
      showAlert('Order details view coming soon!');
    };

    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
      sendBtn.disabled = !chatInput.value.trim();
    });

    sendBtn.onclick = send;
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); send();
      }
    });

    // Initial greeting
    addMessage("üëã Hi! I'm QuickDispatch. I can help you place a delivery order. \n\nWhat would you like to order today?", 'ai');
    
    // Add example quick actions
    setTimeout(() => {
      addQuickActions(['Pizza', 'Burger', 'Salad', 'Track Order']);
    }, 1000);
  </script>
</body>
</html>
