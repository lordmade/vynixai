<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Vynix Care • Mood Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff; --card-bg: #f7f9fa; --text-primary: #0f1419; --text-secondary: #536471;
      --border: #e1e8ed; --accent: #ff2a6d; --chat-bubble-sent: #ff2a6d; --chat-bubble-received: #f7f9fa;
      --glow: 0 0 10px rgba(255,42,109,.35);
    }
    body.dark { --bg:#000; --card-bg:#16181c; --text-primary:#fff; --text-secondary:#71767b; --border:#2f3336; --chat-bubble-received:#16181c; }
    body { font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text-primary); margin:0; overflow:hidden; }
    .main-content { padding:20px 20px 140px; max-width:600px; margin:0 auto; }
    .messages-container { overflow-y:auto; max-height:calc(100vh - 160px); padding-bottom:20px; }
    .message-item { display:flex; margin-bottom:16px; animation:fadeIn 0.3s; }
    .message-received { flex-direction:row; } .message-sent { flex-direction:row-reverse; }
    .message-bubble { max-width:70%; padding:12px 16px; border-radius:20px; word-wrap:break-word; }
    .message-received .message-bubble { background:var(--chat-bubble-received); color:var(--text-primary); border-bottom-left-radius:4px; border:1px solid var(--border); margin-left:12px; }
    .message-sent .message-bubble { background:var(--chat-bubble-sent); color:#fff; border-bottom-right-radius:4px; margin-right:12px; box-shadow:var(--glow); }
    .message-time { font-size:12px; color:var(--text-secondary); margin-top:4px; text-align:right; }
    .message-sent .message-time { color:rgba(255,255,255,0.8); }
    .input-bar { position:fixed; bottom:0; left:0; right:0; background:var(--card-bg); border-top:1px solid var(--border); padding:12px 20px; display:flex; align-items:center; gap:12px; z-index:10; }
    .input-group { flex:1; background:var(--card-bg); border:1px solid var(--border); border-radius:24px; overflow:hidden; }
    .input-group textarea { flex:1; background:none; border:none; outline:none; padding:12px 20px; color:var(--text-primary); font-size:16px; resize:none; max-height:120px; }
    .send-btn { background:var(--accent); color:#fff; border:none; border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--glow); }
    .send-btn:disabled { background:#94a3b8; cursor:not-allowed; box-shadow:none; }
    .mood-picker { display:flex; gap:12px; justify-content:center; padding:12px; background:var(--card-bg); border-top:1px solid var(--border); }
    .mood-btn { font-size:36px; cursor:pointer; transition:transform 0.2s; }
    .mood-btn:hover { transform:scale(1.2); }
    .mood-btn.selected { transform:scale(1.4); filter:drop-shadow(0 0 10px var(--accent)); }
    .crisis-banner { position:fixed; top:0; left:0; right:0; background:#d32f2f; color:#fff; padding:16px; text-align:center; z-index:999; font-weight:bold; animation:pulse 2s infinite; }
    .mood-chart { background:var(--card-bg); border-radius:16px; padding:16px; margin:16px 0; border:1px solid var(--border); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1;} }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.8;} }
  </style>
</head>
<body class="light">

  <div id="crisisBanner" class="hidden crisis-banner">
    <p>You are not alone ♡<br>
       Call SADAG 24/7: <a href="tel:0800212223" style="color:#fff;text-decoration:underline">0800 21 22 23</a> • 
       Suicide Crisis: <a href="tel:0800567567" style="color:#fff;text-decoration:underline">0800 567 567</a>
    </p>
  </div>

  <main class="main-content">
    <div class="messages-container" id="messages-container"></div>
  </main>

  <div class="mood-picker" id="moodPicker" style="display:none;">
    <div class="mood-btn" data-mood="5">Very Happy</div>
    <div class="mood-btn" data-mood="4">Happy</div>
    <div class="mood-btn" data-mood="3">Neutral</div>
    <div class="mood-btn" data-mood="2">Sad</div>
    <div class="mood-btn" data-mood="1">Very Sad</div>
  </div>

  <div class="input-bar">
    <div class="input-group">
      <textarea id="message-input" placeholder="How are you feeling today?"></textarea>
    </div>
    <button class="send-btn material-icons" id="send-btn" disabled>send</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
  import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

  const firebaseConfig = { apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc", authDomain: "fire-b-a8878.firebaseapp.com", databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com", projectId: "fire-b-a8878", appId: "1:658673187627:web:6e4c29af661785f0afa36e" };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const rc = getRemoteConfig(app);
  await fetchAndActivate(rc);
  const xaiKey = getString(rc, 'xai_api_key');

  let userId = null;
  let history = [];
  let lastMood = null;
  let moodStreak = 0;
  let chart = null;

  signInAnonymously(auth);
  onAuthStateChanged(auth, user => { if (user) userId = user.uid; });

  const chatPane = document.getElementById('messages-container');
  const moodPicker = document.getElementById('moodPicker');
  const sendBtn = document.getElementById('send-btn');
  const chatInput = document.getElementById('message-input');

  const crisisKeywords = ["suicide","kill myself","end it","don't want to live","want to die","cutting","overdose","no point living","better off dead","hurt myself"];

  function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }

  function addMessage(content, sender) {
    const div = document.createElement('div');
    div.className = `message-item ${sender === 'user' ? 'message-sent' : 'message-received'}`;
    div.innerHTML = `<div class="message-avatar">${sender === 'user' ? 'You' : 'Heart'}</div>
      <div class="message-bubble">${content.replace(/\n/g,'<br>')}<div class="message-time">${formatTime()}</div></div>`;
    chatPane.appendChild(div);
    chatPane.scrollTop = chatPane.scrollHeight;
  }

  function showMoodPicker() {
    moodPicker.style.display = 'flex';
    setTimeout(() => moodPicker.scrollIntoView({ behavior: 'smooth' }), 300);
  }

  function hideMoodPicker() { moodPicker.style.display = 'none'; }

  function saveMood(mood) {
    if (!userId) return;
    const today = new Date().toISOString().split('T')[0];
    set(ref(db, `moods/${userId}/${today}`), { mood: parseInt(mood), timestamp: Date.now() });
    lastMood = parseInt(mood);
    updateMoodChart();
    checkMoodStreak();
  }

  function checkMoodStreak() {
    if (lastMood <= 2 && moodStreak < 3) {
      moodStreak++;
      if (moodStreak >= 3) {
        setTimeout(() => addMessage("I've noticed you've been feeling low for a few days now.\nI'm really here for you, my love. You're not alone ♡", 'ai'), 2000);
      }
    } else if (lastMood >= 4) {
      moodStreak = 0;
    }
  }

  function updateMoodChart() {
    const moodRef = ref(db, `moods/${userId}`);
    onValue(moodRef, snapshot => {
      const data = snapshot.val() || {};
      const labels = [];
      const values = [];
      Object.entries(data).sort(([a],[b]) => a.localeCompare(b)).slice(-7).forEach(([date, entry]) => {
        labels.push(new Date(date).toLocaleDateString('en-ZA', { weekday: 'short' }));
        values.push(entry.mood);
      });
      if (!chart) {
        const ctx = document.createElement('canvas');
        const chartDiv = document.createElement('div');
        chartDiv.className = 'mood-chart';
        chartDiv.innerHTML = '<p style="text-align:center; font-weight:bold; margin-bottom:8px;">Your Mood This Week</p>';
        chartDiv.appendChild(ctx);
        chatPane.appendChild(chartDiv);
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ data: values, borderColor: '#ff2a6d', tension: 0.4, fill: false }] },
          options: { scales: { y: { min: 1, max: 5, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.update('quiet');
      }
      chatPane.scrollTop = chatPane.scrollHeight;
    }, { onlyOnce: false });
  }

  moodPicker.addEventListener('click', e => {
    if (e.target.dataset.mood) {
      const mood = e.target.dataset.mood;
      e.target.classList.add('selected');
      saveMood(mood);
      setTimeout(hideMoodPicker, 800);
    }
  });

  async function getGrokReply(userMsg) {
    if (crisisKeywords.some(k => userMsg.toLowerCase().includes(k))) {
      document.getElementById('crisisBanner').classList.remove('hidden');
      addMessage("Please don’t go through this alone right now.\nYou matter so much.\nCall SADAG immediately — they’re waiting for you 24/7 ♡", 'ai');
      return;
    }

    addMessage("Vynix Care is listening…", 'ai');
    try {
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "grok-4-1-fast-non-reasoning",
          messages: [
            { role: "system", content: `You are Vynix Care — deeply empathetic South African mental health companion.
            Current mood (1-5): ${lastMood || "unknown"}. Use this to be extra gentle if low.
            Speak with warmth, love, SA slang when natural. Never diagnose. Always validate feelings.
            Use Heart often. Keep replies short and human.` },
            ...history.slice(-15),
            { role: "user", content: userMsg }
          ],
          temperature: 0.85,
          max_tokens: 500
        })
      });
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content?.trim() || "I'm here with you, love ♡";
      history.push({ role: "user", content: userMsg });
      history.push({ role: "assistant", content: reply });
      if (history.length > 40) history = history.slice(-40);

      // Replace thinking message
      chatPane.lastElementChild.remove();
      addMessage(reply, 'ai');
      showMoodPicker();
    } catch (e) {
      chatPane.lastElementChild.remove();
      addMessage("Eish, connection dropped. Still here for you ♡ Try again?", 'ai');
    }
  }

  async function send() {
    const msg = chatInput.value.trim();
    if (!msg) return;
    addMessage(msg, 'user');
    chatInput.value = ''; chatInput.style.height = 'auto'; sendBtn.disabled = true;
    hideMoodPicker();
    await getGrokReply(msg);
    sendBtn.disabled = false;
  }

  chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    sendBtn.disabled = !chatInput.value.trim();
  });

  sendBtn.onclick = send;
  chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });

  // Welcome
  addMessage("Howzit my love ♡\nI'm Vynix Care — your safe space with mood tracking.\nYou can tell me anything, no judgment ever.\nHow are you feeling right now?", 'ai');
  showMoodPicker();
</script>

<div style="position:fixed; bottom:8px; left:0; right:0; text-align:center; font-size:10px; color:var(--text-secondary); opacity:0.7;">
  Vynix Care • Private & Anonymous • Not a substitute for professional help
</div>
</body>
</html>
