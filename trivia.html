<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Global Trivia Arena</title>
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Vynix Trivia Arena&quot;,
    &quot;short_name&quot;:&quot;Trivia&quot;,
    &quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#faf8ff&quot;,
    &quot;theme_color&quot;:&quot;#8b5cf6&quot;
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    :root {
      --accent: #8b5cf6;
      --accent-light: #e0d4ff;
      --bg: #faf8ff;
      --card: #ffffff;
      --text: #1f1f1f;
      --text-light: #666;
      --success: #10b981;
      --danger: #ef4444;
      --border: #e2e8f0;
    }
    body.dark {
      --bg: #0f0f1a;
      --card: #1a1a2e;
      --text: #e0e0ff;
      --text-light: #aaa;
      --border: #33334d;
      --accent-light: #4c1d95;
    }
    body {
      margin: 0;
      height: 100dvh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      touch-action: manipulation;
    }
    #header {
      height: 64px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      z-index: 10;
    }
    #online {
      font-weight: 600;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .avatars {
      display: flex;
      margin-left: 8px;
    }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid var(--card);
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
      margin-left: -8px;
    }
    .avatar:first-child { margin-left: 0; }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px 16px 100px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .bubble {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 22px;
      animation: fadeIn 0.4s ease-out;
      box-shadow: 0 2px 10px rgba(0,0,0,.1);
      word-wrap: break-word;
      line-height: 1.5;
    }
    .bubble.ai {
      align-self: flex-start;
      background: var(--card);
      border: 1px solid var(--border);
    }
    .bubble.user {
      align-self: flex-end;
      background: var(--accent-light);
      color: #000;
      font-weight: 500;
    }
    .bubble.bot {
      align-self: flex-start;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(139,92,246,.3);
    }
    .meta {
      font-size: 12px;
      opacity: .8;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .bubble.user .meta { justify-content: flex-end; }
    .meta img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    .question-text {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }
    .options {
      margin-top: 12px;
      display: grid;
      gap: 12px;
    }
    .option {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 16px 18px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .option:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(139,92,246,.15);
    }
    .option.selected {
      border-color: var(--accent);
      background: #f3e8ff;
      font-weight: 600;
    }
    .option.correct {
      border-color: var(--success) !important;
      background: #f0fdf4 !important;
      color: var(--success);
    }
    .option.wrong {
      border-color: var(--danger) !important;
      background: #fef2f2 !important;
      color: var(--danger);
    }
    .letter {
      font-weight: bold;
      font-size: 18px;
      min-width: 32px;
    }
    .countdown {
      position: fixed;
      top: 74px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      padding: 10px 24px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 16px;
      z-index: 99;
      box-shadow: 0 6px 20px rgba(139,92,246,.4);
      backdrop-filter: blur(10px);
    }
    #inputBar {
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: flex-end;
      gap: 12px;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
    }
    #input {
      flex: 1;
      background: #f1f5f9;
      border: none;
      border-radius: 24px;
      padding: 14px 18px;
      font-size: 16px;
      outline: none;
      min-height: 48px;
      max-height: 120px;
      resize: none;
      font-family: inherit;
    }
    #input:focus {
      background: #fff;
      box-shadow: 0 0 0 3px rgba(139,92,246,.3);
    }
    #sendBtn {
      width: 50px;
      height: 50px;
      background: var(--accent);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    #sendBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #sendBtn:not(:disabled):hover {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(139,92,246,.5);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: none; }
    }
    .winner-text {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #10b981, #34d399);
      color: white;
      border-radius: 20px;
      margin: 20px 0;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</head>
<body class="bg-bg">
  <header id="header">
    <div id="online">0 online</div>
    <h1 class="text-xl font-bold" style="background: linear-gradient(135deg, #8b5cf6, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
      Vynix Global Trivia
    </h1>
    <div></div>
  </header>

  <div class="countdown">Next Question in <span id="timeLeft">05:00</span></div>

  <section id="chat"></section>

  <div id="inputBar">
    <textarea id="input" placeholder="Say something in the arena..." rows="1"></textarea>
    <button id="sendBtn" disabled><i data-lucide="send"></i></button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, set, onDisconnect, serverTimestamp, get, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    const GLOBAL_ROOM = 'trivia/global'; // True global room
    const QUESTION_INTERVAL = 5 * 60 * 1000; // Every 5 minutes
    const REVEAL_AFTER = 60 * 1000; // Reveal after 60 seconds

    let uid = null;
    let userName = '';
    let userAvatar = '';
    let grokKey = null;
    let currentQuestionKey = null;
    let hasAnswered = false;
    let nextQuestionAt = Date.now() + QUESTION_INTERVAL;

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const timeEl = document.getElementById('timeLeft');
    const onlineEl = document.getElementById('online');

    lucide.createIcons();

    // Auto-resize input
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      sendBtn.disabled = !input.value.trim();
    });

    // Send message
    function sendMessage() {
      const text = input.value.trim();
      if (!text || !uid) return;

      const msgRef = push(ref(db, `${GLOBAL_ROOM}/messages`));
      set(msgRef, {
        sender: uid,
        name: userName,
        avatar: userAvatar,
        text: text,
        ts: serverTimestamp()
      });

      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;
    }

    sendBtn.onclick = sendMessage;
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Add message bubble
    function addBubble(content, type = 'ai', name = '', avatar = '') {
      const div = document.createElement('div');
      div.className = `bubble ${type}`;
      
      if (type === 'bot') {
        div.innerHTML = content;
      } else {
        const meta = `<div class="meta"><img src="${avatar}" alt=""><span>${name}</span></div>`;
        div.innerHTML = type === 'user' ? content + meta : meta + content;
      }
      
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    // Generate question via Grok
    async function generateQuestion() {
      if (!grokKey) return null;
      try {
        const res = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${grokKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'grok-beta',
            messages: [{
              role: 'user',
              content: 'Generate a fun, global trivia question with exactly 5 options (A-E). Return ONLY this exact format:\nQuestion|CorrectLetter|A) Option A|B) Option B|C) Option C|D) Option D|E) Option E'
            }],
            temperature: 0.9,
            max_tokens: 400
          })
        });

        const data = await res.json();
        const text = data.choices?.[0]?.message?.content?.trim();
        if (!text) return null;

        const parts = text.split('|');
        if (parts.length < 7) return null;

        return {
          question: parts[0].trim(),
          correct: parts[1].trim().toUpperCase(),
          options: parts.slice(2).map(o => o.trim().replace(/^[A-E]\)\s*/, ''))
        };
      } catch (e) {
        console.error('Grok API error:', e);
        return null;
      }
    }

    // Post new question
    async function postQuestion(q) {
      const key = push(ref(db, `${GLOBAL_ROOM}/messages`)).key;
      currentQuestionKey = key;
      hasAnswered = false;

      await set(ref(db, `${GLOBAL_ROOM}/messages/${key}`), {
        type: 'question',
        question: q.question,
        options: q.options,
        correct: q.correct,
        ts: serverTimestamp()
      });

      setTimeout(() => revealAnswer(q.correct, key), REVEAL_AFTER);
    }

    // Reveal correct answer
    async function revealAnswer(correctLetter, qKey) {
      const answersSnap = await get(ref(db, `${GLOBAL_ROOM}/answers/${qKey}`));
      const winners = [];
      
      answersSnap.forEach(child => {
        const ans = child.val();
        if (ans.choice === correctLetter) {
          winners.push(`<b>${ans.name}</b>`);
        }
      });

      const resultText = winners.length > 0
        ? `Correct answer: <b>${correctLetter}</b>! Winners: ${winners.slice(0, 10).join(', ')}${winners.length > 10 ? ' and more!' : ''}`
        : `Time's up! Correct answer was <b>${correctLetter}</b>. No winners this round.`;

      addBubble(`<div class="winner-text">Trophy ${resultText}</div>`, 'bot');
    }

    // Countdown timer
    setInterval(() => {
      const left = Math.max(0, nextQuestionAt - Date.now());
      const m = String(Math.floor(left / 60000)).padStart(2, '0');
      const s = String(Math.floor((left % 60000) / 1000)).padStart(2, '0');
      timeEl.textContent = `${m}:${s}`;

      if (left <= 0) {
        nextQuestionAt = Date.now() + QUESTION_INTERVAL;
        generateQuestion().then(q => q && postQuestion(q));
      }
    }, 1000);

    // Listen to online users
    onValue(ref(db, `${GLOBAL_ROOM}/online`), snap => {
      const users = [];
      snap.forEach(child => users.push(child.val()));
      
      onlineEl.innerHTML = `
        <span>${users.length} online</span>
        <div class="avatars">
          ${users.slice(0, 8).map(u => `<img class="avatar" src="${u.avatar}" title="${u.name}">`).join('')}
          ${users.length > 8 ? `<span style="margin-left:8px; color:var(--text-light)">+${users.length - 8}</span>` : ''}
        </div>
      `;
    });

    // Listen to messages
    onValue(ref(db, `${GLOBAL_ROOM}/messages`), snap => {
      chat.innerHTML = '';
      hasAnswered = false;
      currentQuestionKey = null;

      snap.forEach(child => {
        const msg = child.val();
        const key = child.key;

        if (msg.type === 'question') {
          currentQuestionKey = key;
          renderQuestion(msg, key);
        } else if (msg.type === 'answer') {
          // Handled in revealAnswer
        } else {
          addBubble(msg.text, msg.sender === uid ? 'user' : 'ai', msg.name || 'User', msg.avatar || '');
        }
      });

      chat.scrollTop = chat.scrollHeight;
    });

    // Render active question
    function renderQuestion(q, key) {
      const bubble = addBubble(`
        <div class="question-text">Question: ${q.question}</div>
        <div class="options">
          ${q.options.map((opt, i) => {
            const letter = String.fromCharCode(65 + i);
            return `
              <div class="option" data-choice="${letter}">
                <span class="letter">${letter}</span>
                <span>${opt}</span>
              </div>
            `;
          }).join('')}
        </div>
      `, 'bot');

      bubble.querySelectorAll('.option').forEach(option => {
        option.onclick = () => {
          if (hasAnswered || !currentQuestionKey) return;
          hasAnswered = true;

          bubble.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');

          set(ref(db, `${GLOBAL_ROOM}/answers/${key}/${uid}`), {
            name: userName,
            choice: option.dataset.choice,
            ts: serverTimestamp()
          });

          addBubble(`I chose <b>${option.dataset.choice}</b>!`, 'user');
        };
      });
    }

    // Auth & Online Status
    onAuthStateChanged(auth, async user => {
      if (!user) {
        location.href = 'login.html';
        return;
      }

      uid = user.uid;
      userName = user.displayName || user.email.split('@')[0];
      userAvatar = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=8b5cf6&color=fff&bold=true`;

      // Fetch Grok API key from Remote Config
      try {
        await fetchAndActivate(rc);
        grokKey = getString(rc, 'xai_api_key')?.trim();
      } catch (e) {
        console.log("Remote Config failed, trivia generation disabled");
      }

      // Set online status
      const onlineRef = ref(db, `${GLOBAL_ROOM}/online/${uid}`);
      set(onlineRef, { name: userName, avatar: userAvatar, ts: serverTimestamp() });
      onDisconnect(onlineRef).remove();

      // Welcome message
      addBubble(`<b>${userName}</b> has entered the Global Arena!`, 'ai', 'System', 'https://api.dicebear.com/7.x/bottts/svg?seed=system');
    });
  </script>
</body>
</html>
