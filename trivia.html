<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ZULABEAT ‚Äì SA's AI Music App</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{
    "name":"Zulabeat","short_name":"Zulabeat",
    "description":"Just say the vibe ‚Äì Amapiano, Gqom, Kwaito, Maskandi",
    "start_url":"/","display":"standalone",
    "background_color":"#FF6B35","theme_color":"#FF6B35",
    "icons":[
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=192","sizes":"192x192","type":"image/svg+xml"},
      {"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&backgroundColor=FF6B35&size=512","sizes":"512x512","type":"image/svg+xml"}
    ]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;background:#0f0a1a;color:#fff;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .header{background:linear-gradient(135deg,#FF6B35,#ec4899);padding:1.5rem 1rem 2rem;text-align:center;box-shadow:0 10px 30px rgba(255,107,53,0.4)}
    .header h1{font-size:3.2rem;font-weight:900;margin:0;letter-spacing:-2px}
    .header p{font-size:1.1rem;opacity:0.9}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 140px;-webkit-overflow-scrolling:touch}
    .message{margin:1rem 0;display:flex;flex-direction:column;animation:fadeIn .4s ease-out forwards}
    .message.user{align-items:flex-end}
    .message .bubble{max-width:88%;padding:14px 18px;border-radius:24px;line-height:1.55;font-size:1.02rem;word-wrap:break-word;box-shadow:0 4px 16px rgba(0,0,0,0.2)}
    .message.ai .bubble{background:linear-gradient(135deg,#1e1b4b,#2d1b69);border-bottom-left-radius:6px}
    .message.user .bubble{background:#FF6B35;color:#fff;border-bottom-right-radius:6px}
    .track-bubble{cursor:pointer;transition:transform .2s}
    .track-bubble:hover{transform:scale(1.03)}
    .track-info{display:flex;align-items:center;gap:12px;margin-top:8px}
    .track-info img{width:48px;height:48px;border-radius:12px}
    .track-text{flex:1}
    .track-text p{margin:0;font-weight:700}
    .track-text small{opacity:0.9;font-size:0.9rem}
    .timestamp{font-size:0.75rem;opacity:0.7;margin-top:4px;text-align:right}
    .message.ai .timestamp{margin-left:18px}
    .thinking{display:flex;gap:9px;padding:16px 20px}
    .dot{width:11px;height:11px;background:#a78bfa;border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);padding:1rem;padding-bottom:calc(1rem + env(safe-area-inset-bottom));z-index:100}
    .input-container{max-width:780px;margin:0 auto;background:rgba(255,255,255,0.15);border-radius:28px;padding:10px 16px;display:flex;align-items:center;gap:12px}
    #chatInput{flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:1.1rem}
    #chatInput::placeholder{color:rgba(255,255,255,0.6)}
    .send-btn{width:52px;height:52px;background:#FF6B35;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:.2s}
    .send-btn:disabled{opacity:0.5}
    .install-banner{position:fixed;bottom:90px;left:8px;right:8px;background:#fff;color:#000;padding:1rem;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.3);display:none;align-items:center;justify-content:space-between;z-index:50}
  </style>
</head>
<body>

  <header class="header">
    <h1>ZULABEAT</h1>
    <p>Just say the vibe ‚Äì Grok finds the music</p>
  </header>

  <section id="chatPane">
    <div class="text-center mt-20 opacity-80">
      <p class="text-xl">Examples:</p>
      <p class="mt-4">‚Ä¢ Amapiano for the braai</p>
      <p>‚Ä¢ Gqom that slaps</p>
      <p>‚Ä¢ Kwaito classics</p>
      <p>‚Ä¢ Maskandi vibes</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-container">
      <input type="text" id="chatInput" placeholder="What vibe you feeling today?..." autocomplete="off" />
      <button class="send-btn" id="sendBtn" disabled><i data-lucide="send" class="w-6 h-6"></i></button>
    </div>
  </div>

  <div class="install-banner" id="installBanner">
    <span>Install Zulabeat ‚Äì tap ‚ÄúAdd to Home Screen‚Äù</span>
    <button id="installBtn" class="bg-orange-600 text-white px-4 py-2 rounded-full font-bold">Install</button>
  </div>

  <audio id="audioPlayer"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const remoteConfig = getRemoteConfig(app);
    remoteConfig.settings.minimumFetchIntervalMillis = 3600000;

    let xaiKey = null;
    let spotifyClientId = null;
    let spotifyClientSecret = null;
    let spotifyToken = null;
    let tokenExpiry = 0;

    // Load keys from Remote Config
    await fetchAndActivate(remoteConfig);
    xaiKey = getString(remoteConfig, 'xai_api_key');
    spotifyClientId = getString(remoteConfig, 'spotify_client_id');
    spotifyClientSecret = getString(remoteConfig, 'spotify_client_secret');

    if (!xaiKey || !spotifyClientId) {
      addMessage("App not ready yet ‚Äì contact support", 'ai');
      throw new Error("Missing config");
    }

    const chatPane = document.getElementById('chatPane');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const audio = document.getElementById('audioPlayer');

    let currentTrack = null;
    let deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBanner').style.display = 'flex';
    });
    document.getElementById('installBtn').onclick = () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => document.getElementById('installBanner').style.display = 'none');
      }
    };

    function addMessage(content, sender, plain = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const time = new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });

      if (sender === 'ai') {
        div.innerHTML = `
          <div class="bubble">
            ${content}
            <div class="timestamp">${time}</div>
          </div>
        `;
        chatPane.appendChild(div);
      } else {
        div.innerHTML = `
          <div class="bubble">${content.replace(/\n/g, '<br>')}
            <div class="timestamp">${time}</div>
          </div>
        `;
        chatPane.appendChild(div);
      }
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="bubble"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      chatPane.appendChild(d);
      chatPane.scrollTop = chatPane.scrollHeight;
    }

    function removeThinking() {
      document.getElementById('thinking')?.remove();
    }

    async function getSpotifyToken() {
      if (Date.now() < tokenExpiry) return spotifyToken;
      const auth = btoa(`\( {spotifyClientId}: \){spotifyClientSecret}`);
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded", "Authorization": "Basic " + auth },
        body: "grant_type=client_credentials"
      });
      const data = await res.json();
      spotifyToken = data.access_token;
      tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000;
      return spotifyToken;
    }

    async function searchAndShow(userText) {
      addThinking();
      try {
        // Step 1: Let Grok clean the vibe
        const grokRes = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${xaiKey}` },
          body: JSON.stringify({
            model: "grok-beta",
            messages: [{ role: "user", content: `Turn this into the best Spotify search query for South African music (only return the query): "${userText}"` }],
            temperature: 0.7,
            max_tokens: 30
          })
        });
        const grokData = await grokRes.json();
        const cleanQuery = (grokData.choices?.[0]?.message?.content || userText).trim();

        // Step 2: Search Spotify
        const token = await getSpotifyToken();
        const searchRes = await fetch(
          `https://api.spotify.com/v1/search?q=${encodeURIComponent(cleanQuery)}&type=track&market=ZA&limit=10`,
          { headers: { Authorization: `Bearer ${token}` } }
        );
        const searchData = await searchRes.json();
        const tracks = searchData.tracks.items;

        removeThinking();

        if (tracks.length === 0) {
          addMessage("No tracks found ‚Äì try another vibe", 'ai');
          return;
        }

        addMessage(`Found \( {tracks.length} bangers for " \){userText}" üî•`, 'ai');

        tracks.forEach(track => {
          const art = track.album.images[0]?.url || 'https://via.placeholder.com/300';
          const bubble = document.createElement('div');
          bubble.className = 'message ai track-bubble';
          bubble.innerHTML = `
            <div class="bubble">
              <div class="track-info">
                <img src="\( {art}" alt=" \){track.name}">
                <div class="track-text">
                  <p>${track.name}</p>
                  <small>${track.artists.map(a => a.name).join(', ')}</small>
                </div>
              </div>
              <div class="timestamp">${new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
          `;
          bubble.onclick = () => {
            if (track.preview_url) {
              audio.src = track.preview_url;
              audio.play();
              addMessage(`Now playing: \( {track.name} ‚Äì \){track.artists[0].name} üé∂`, 'ai');
            } else {
              window.open(track.external_urls.spotify, '_blank');
              addMessage(`Opened full track in Spotify: ${track.name}`, 'ai');
            }
          };
          chatPane.appendChild(bubble);
        });

      } catch (err) {
        removeThinking();
        addMessage("Something went wrong ‚Äì check your connection", 'ai');
      }
    }

    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      chatInput.value = '';
      sendBtn.disabled = true;
      searchAndShow(text).finally(() => sendBtn.disabled = false);
    }

    chatInput.addEventListener('input', () => {
      sendBtn.disabled = !chatInput.value.trim();
    });

    sendBtn.onclick = sendMessage;
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Welcome message
    addMessage("Yo! What vibe you feeling today? Amapiano? Gqom? Kwaito? Just say it üî•", 'ai');
  </script>
</body>
</html>
