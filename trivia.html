<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ZULABEAT â€“ Your SA Music Bestie</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Zulabeat&quot;,&quot;short_name&quot;:&quot;Zulabeat&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#FF6B35&quot;,&quot;theme_color&quot;:&quot;#FF6B35&quot;,
    &quot;icons&quot;:[
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&amp;backgroundColor=FF6B35&amp;size=192&quot;,&quot;sizes&quot;:&quot;192x192&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Zulabeat&amp;backgroundColor=FF6B35&amp;size=512&quot;,&quot;sizes&quot;:&quot;512x512&quot;}
    ]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    body{font-family:'Inter',sans-serif;background:#0f0a1a;color:#fff;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 160px;-webkit-overflow-scrolling:touch}
    .message{margin:1.2rem 0;display:flex;flex-direction:column;align-items:flex-start;animation:fadeIn .4s ease-out forwards;width:100%}
    .message.user{align-items:flex-end}
    .message .content{max-width:100%;width:auto;padding:14px 18px;border-radius:24px;line-height:1.55;font-size:1.02rem;word-wrap:break-word;box-shadow:0 3px 10px rgba(0,0,0,.09)}
    .message.ai .content{background:linear-gradient(135deg,#1e1b4b 0%,#2d1b69 100%);border:1px solid #2d1b69;border-bottom-left-radius:6px;color:#fff}
    .message.user .content{background:#FF6B35;border:1.8px solid #FF6B35;border-bottom-right-radius:6px;color:#fff;font-weight:500}
    .timestamp{font-size:.75rem;color:#ffffffaa;margin-top:4px;opacity:.85}
    .message.ai .timestamp{margin-left:18px}.message.user .timestamp{margin-right:18px;text-align:right}
    .thinking{display:flex;gap:9px;padding:16px 20px}
    .dot{width:11px;height:11px;background:#a78bfa;border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;padding:.75rem;padding-bottom:calc(.75rem + env(safe-area-inset-bottom));background:#000000cc;backdrop-filter:blur(20px);z-index:100;display:flex;justify-content:center;align-items:center}
    .input-container{background:#ffffff1a;border:2px solid #ffffff20;border-radius:28px;padding:10px 16px;display:flex;align-items:center;gap:12px;transition:all .2s;width:100%;max-width:780px}
    .input-container:focus-within{border-color:#FF6B35}
    #chatInput{flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:1.05rem;resize:none;max-height:140px;line-height:1.5}
    .send-btn{width:48px;height:48px;background:#FF6B35;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s;cursor:pointer}
    .send-btn:disabled{background:#ffffff30;cursor:not-allowed}
  </style>
</head>
<body>

  <section id="chatPane">
    <div class="text-center mt-28 text-gray-400 px-4">
      <h1 class="text-4xl font-black mb-2 text-orange-500">ZULABEAT</h1>
      <p class="text-lg">Your South-African music bestie</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-container">
      <textarea id="chatInput" placeholder="Ask for music, artists, vibesâ€¦" rows="1"></textarea>
      <button id="sendBtn" disabled><i data-lucide="send" class="w-5 h-5"></i></button>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const rc = getRemoteConfig(app);
    rc.settings.minimumFetchIntervalMillis = 3600000;
    await fetchAndActivate(rc);

    const xaiKey = getString(rc, 'xai_api_key');
    const spotifyClientId = getString(rc, 'spotify_client_id');
    const spotifyClientSecret = getString(rc, 'spotify_client_secret');

    if (!xaiKey) throw alert("App not configured");

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      audio: document.getElementById('audioPlayer')
    };

    let history = [];
    let messagesSinceMusic = 0;
    let spotifyToken = null;
    let tokenExpiry = 0;

    const musicReminders = [
      "Anyway... what music you feeling right now? ðŸ”¥",
      "Yo, wanna hear some fire tracks?",
      "Eish, enough talk â€“ what vibe should I play?",
      "Tell me a song or artist, bru!",
      "Music time? Drop a vibe!"
    ];

    function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }

    function addMessage(content, sender) {
      const div = document.createElement('div'); div.className = `message ${sender}`;
      const time = formatTime();
      div.innerHTML = `
        <div class="content">${marked.parse(content)}</div>
        <div class="timestamp">${time}</div>
      `;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();
    }

    function addThinking() {
      const d = document.createElement('div'); d.id = 'thinking'; d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d); els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    async function getSpotifyToken() {
      if (Date.now() < tokenExpiry) return spotifyToken;
      const auth = btoa(`${spotifyClientId}:${spotifyClientSecret}`);
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded", "Authorization": "Basic " + auth },
        body: "grant_type=client_credentials"
      });
      const d = await res.json();
      spotifyToken = d.access_token;
      tokenExpiry = Date.now() + (d.expires_in * 1000) - 60000;
      return spotifyToken;
    }

    async function searchAndPlay(query) {
      try {
        const token = await getSpotifyToken();
        const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&market=ZA&limit=8`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        const tracks = data.tracks.items;
        if (!tracks.length) { addMessage("Couldn't find that one â€“ try another?", 'ai'); return; }

        tracks.forEach(t => {
          const art = t.album.images[0]?.url || '';
          const bubble = document.createElement('div'); bubble.className = 'message ai';
          bubble.innerHTML = `
            <div class="content track-info" style="cursor:pointer">
              <img src="${art}" alt="" class="rounded-lg w-14 h-14">
              <div>
                <p class="font-bold">${t.name}</p>
                <small class="text-white/70">${t.artists.map(a => a.name).join(', ')}</small>
              </div>
            </div>
          `;
          bubble.onclick = () => {
            if (t.preview_url) {
              els.audio.src = t.preview_url; els.audio.play();
              addMessage(`Now playing: ${t.name} â€“ ${t.artists[0].name} ðŸŽ¶`, 'ai');
            } else {
              window.open(t.external_urls.spotify, '_blank');
              addMessage(`Opened in Spotify: ${t.name}`, 'ai');
            }
          };
          els.chatPane.appendChild(bubble);
        });
        els.chatPane.scrollTop = els.chatPane.scrollHeight;
      } catch { addMessage("Music search failed", 'ai'); }
    }

    async function getReply(userMsg) {
      addThinking();
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-beta",
            messages: [
              { role: "system", content: `You are Zulabeat â€“ a super-chilled, funny South-African music bestie. Use local slang, keep replies short (1-3 sentences). If the user wants music, start your reply with: MUSIC: <search query>` },
              ...history.slice(-15),
              { role: "user", content: userMsg }
            ],
            temperature: 0.9,
            max_tokens: 400
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "Eish, I didn't catch that.";
      } catch { return "Network trouble â€“ try again"; } finally { removeThinking(); }
    }

    async function send() {
      const msg = els.chatInput.value.trim();
      if (!msg) return;
      addMessage(msg, 'user');
      history.push({ role: "user", content: msg });
      els.chatInput.value = ''; els.chatInput.style.height = 'auto';

      const reply = await getReply(msg);
      addMessage(reply, 'ai');
      history.push({ role: "assistant", content: reply });

      const musicMatch = reply.match(/^MUSIC:\s*(.+)$/m);
      if (musicMatch) {
        const query = musicMatch[1].split('\n')[0].trim();
        const text = reply.replace(/^MUSIC:.+$/m, '').trim() || "Hereâ€™s some fire!";
        addMessage(text, 'ai');
        messagesSinceMusic = 0;
        await searchAndPlay(query);
      } else {
        messagesSinceMusic++;
        if (messagesSinceMusic >= 3) {
          setTimeout(() => {
            const reminder = musicReminders[Math.floor(Math.random() * musicReminders.length)];
            addMessage(reminder, 'ai');
            messagesSinceMusic = 0;
          }, 1200);
        }
      }
      if (history.length > 30) history = history.slice(-30);
    }

    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      els.sendBtn.disabled = !els.chatInput.value.trim();
    });
    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    addMessage("Yo bru! I'm Zulabeat â€“ your SA music bestie. What vibe you feeling? ðŸ˜Ž", 'ai');
  </script>
</body>
</html>
