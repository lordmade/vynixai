<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix</title>

  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- tailwind light-mode override -->
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <style>
    :root {
      --bg: #ffffff;
      --card: #f7f9fa;
      --text: #0f1419;
      --text2: #536471;
      --border: #e1e8ed;
      --accent: #ff2a6d; /* vynix neon pink */
      --glow: 0 0 10px rgba(255, 42, 109, .35);
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
    }
    #header h1 {
      font-weight: 800;
      font-size: 22px;
      letter-spacing: -1px;
      background: linear-gradient(90deg, #ff2a6d, #05d9e8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .main {
      padding: 64px 16px 80px;
    }
    .tab {
      display: none;
    }
    .tab.active {
      display: block;
    }
    .search {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card);
      color: var(--text);
      margin-bottom: 16px;
    }
    .card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-bottom: 12px;
    }
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      background: #05d9e8;
    }
    .name {
      font-weight: 700;
      font-size: 16px;
    }
    .preview {
      font-size: 14px;
      color: var(--text2);
      margin-top: 2px;
    }
    .unread {
      background: var(--accent);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: auto;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--card);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      color: var(--text2);
      transition: .2s;
    }
    .nav-item.active {
      color: var(--accent);
      text-shadow: var(--glow);
    }
    .nav-item .material-icons {
      font-size: 24px;
      margin-bottom: 2px;
    }
    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      box-shadow: var(--glow);
      display: grid;
      place-items: center;
    }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }
    .status-thumb {
      aspect-ratio: 9 / 16;
      object-fit: cover;
      border-radius: 12px;
      border: 2px solid transparent;
      background: var(--card);
    }
    .status-thumb.new {
      border-color: var(--accent);
      box-shadow: var(--glow);
    }
    #media-upload {
      display: none;
    }
    .alert {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 1000;
    }
    .alert.show {
      display: block;
      animation: fade .3s;
    }
    @keyframes fade {
      from { opacity: 0; transform: translate(-50%, -10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
</head>
<body class="light">

  <!-- header -->
  <header id="header">
    <h1>Vynix</h1>
    <img id="me-avatar" class="avatar w-10 h-10">
  </header>

  <!-- content -->
  <main class="main">
    <!-- Chats -->
    <div id="chats" class="tab active">
      <input class="search" id="search" placeholder="Search chats…">
      <div id="chat-list"></div>
    </div>

    <!-- Channels -->
    <div id="channels" class="tab">
      <div class="text-secondary text-sm p-4">Channels coming soon.</div>
    </div>

    <!-- Status -->
    <div id="status" class="tab">
      <div class="flex items-center justify-between mb-4">
        <span class="text-sm text-secondary">Recent updates</span>
        <button id="add-status" class="material-icons text-accent">add_box</button>
        <input id="media-upload" type="file" accept="image/*,video/*">
      </div>
      <div id="status-grid" class="status-grid"></div>
    </div>

    <!-- Settings -->
    <div id="settings" class="tab">
      <div class="text-secondary text-sm p-4">Settings coming soon.</div>
    </div>
  </main>

  <!-- floating btn -->
  <button id="add-fab" class="fab material-icons">person_add</button>

  <!-- bottom nav -->
  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats"><span class="material-icons">chat</span>Chats</div>
    <div class="nav-item" data-tab="channels"><span class="material-icons">dvr</span>Channels</div>
    <div class="nav-item" data-tab="status"><span class="material-icons">circle</span>Status</div>
    <div class="nav-item" data-tab="settings"><span class="material-icons">settings</span>Settings</div>
  </nav>

  <!-- toast -->
  <div id="alert" class="alert"></div>

  <!-- firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, onValue, push, set, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    // ===== CONFIGURE HERE =====
    const CLOUD_NAME = 'YOUR_CLOUD';
    const UPLOAD_PRESET = 'YOUR_PRESET';
    // ==========================

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid;

    /* ---------- helpers ---------- */
    const toast = (msg) => {
      const al = document.getElementById('alert');
      al.textContent = msg;
      al.classList.add('show');
      setTimeout(() => al.classList.remove('show'), 2500);
    };

    const fmtTime = (ts) => {
      const d = Date.now() - ts;
      if (d < 6e4) return 'now';
      if (d < 36e5) return `${Math.floor(d / 6e4)}m`;
      if (d < 864e5) return `${Math.floor(d / 36e5)}h`;
      return new Date(ts).toLocaleDateString();
    };

    const decrypt = async (enc, chatId) => {
      try {
        const { iv, ciphertext } = JSON.parse(enc);
        const ivBuf = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
        const cipherBuf = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
        const encoder = new TextEncoder();
        const keyMat = await crypto.subtle.importKey('raw', encoder.encode('vynix-2025'), { name: 'PBKDF2' }, false, ['deriveKey']);
        const key = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: encoder.encode(chatId), iterations: 100000, hash: 'SHA-256' },
          keyMat, { name: 'AES-GCM', length: 256 }, true, ['decrypt']
        );
        const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: ivBuf }, key, cipherBuf);
        return new TextDecoder().decode(dec);
      } catch { return '…'; }
    };

    /* ---------- chats ---------- */
    const loadChats = async () => {
      const list = document.getElementById('chat-list');
      list.innerHTML = '';
      const folSnap = await get(ref(db, `users/${uid}/following`));
      if (!folSnap.exists()) return list.innerHTML = '<p class="text-secondary text-center mt-10">Follow friends to chat</p>';
      const uids = Object.keys(folSnap.val());
      for (const id of uids) {
        const uSnap = await get(ref(db, `users/${id}`));
        const user = uSnap.val();
        if (!user) continue;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img class="avatar" src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=05d9e8&color=fff`}" />
          <div class="flex-1">
            <div class="name">${user.displayName || user.email}</div>
            <div id="prev-${id}" class="preview">Tap to chat</div>
          </div>
          <span id="unread-${id}" class="unread" style="display:none;"></span>
        `;
        card.onclick = () => startChat(id, user);
        list.appendChild(card);

        onValue(ref(db, `users/${uid}/chats/${id}/lastMessage`), async (s) => {
          if (s.exists()) {
            const msg = await decrypt(s.val(), [uid, id].sort().join('_'));
            document.getElementById(`prev-${id}`).textContent = msg;
          }
        });
        onValue(ref(db, `users/${uid}/chats/${id}/unreadCount`), (s) => {
          const cnt = s.val() || 0;
          const badge = document.getElementById(`unread-${id}`);
          badge.style.display = cnt ? 'inline' : 'none';
          badge.textContent = cnt > 99 ? '99+' : cnt;
        });
      }
    };

    const startChat = (tid, user) => {
      const params = new URLSearchParams({
        chatId: [uid, tid].sort().join('_'),
        userId: tid,
        username: user.displayName || '',
        avatar: user.photoURL || '',
        verified: !!user.verified,
        isGroup: false
      });
      location.href = `chat.html?${params.toString()}`;
    };

    /* ---------- status ---------- */
    const loadStatus = () => {
      const grid = document.getElementById('status-grid');
      onValue(ref(db, 'status'), (snap) => {
        grid.innerHTML = '';
        snap.forEach((child) => {
          const { media, uid: author, timestamp } = child.val();
          if (Date.now() - timestamp > 24 * 3600 * 1000) return; // expire
          const div = document.createElement('div');
          div.className = 'relative';
          div.innerHTML = `<img class="status-thumb new" src="${media}" />`;
          div.onclick = () => openViewer(child.key);
          grid.appendChild(div);
        });
      });
    };

    const openViewer = (key) => { toast('Status viewer not built yet'); };

    document.getElementById('add-status').onclick = () => document.getElementById('media-upload').click();

    document.getElementById('media-upload').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      toast('Uploading…');
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: fd });
      const { secure_url } = await res.json();
      const key = push(ref(db, 'status')).key;
      await set(ref(db, `status/${key}`), { media: secure_url, uid, timestamp: serverTimestamp() });
      toast('Status added!');
    };

    /* ---------- nav ---------- */
    document.querySelectorAll('.nav-item').forEach((el) => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach((i) => i.classList.remove('active'));
        el.classList.add('active');
        const tab = el.dataset.tab;
        document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
      });
    });

    document.getElementById('add-fab').onclick = () => location.href = 'follow-users.html';

    /* ---------- auth ---------- */
    onAuthStateChanged(auth, async (user) => {
      if (!user) return (location.href = 'login.html');
      uid = user.uid;
      document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=ff2a6d&color=fff`;
      document.getElementById('me-avatar').onclick = () => (location.href = 'profile.html');
      await loadChats();
      loadStatus();
    });
  </script>
</body>
</html>
