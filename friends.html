<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Mxit Revival â€“ Vynix</title>

  <!-- External libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #000000;
      --card-bg: #16181c;
      --text-primary: #ffffff;
      --text-secondary: #71767b;
      --border: #2f3336;
      --accent: #1d9bf0;
      --mx-cyan: #00b5ff;
      --mx-pink: #ff2a6d;
      --mx-purple: #7b2ff7;
      --mx-green: #05d9e8;
      --header-bg: #000000;
      --chat-bubble-sent: #00b5ff;
      --chat-bubble-received: #16181c;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --glow: 0 0 10px rgba(0, 181, 255, 0.5);
    }
    body.light {
      --bg: #ffffff;
      --card-bg: #f7f9fa;
      --text-primary: #0f1419;
      --text-secondary: #536471;
      --border: #e1e8ed;
      --header-bg: #ffffff;
      --chat-bubble-received: #f7f9fa;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      line-height: 1.4;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--header-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
      border-bottom: 1px solid var(--border);
    }
    #app-header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      background: linear-gradient(90deg, var(--mx-cyan), var(--mx-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .main-content {
      padding: 84px 20px 80px;
      min-height: calc(100vh - 80px);
    }
    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 20px;
    }
    .user-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .user-card:hover {
      border-color: var(--mx-cyan);
      box-shadow: var(--glow);
    }
    .user-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--mx-purple);
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
    }
    .user-name {
      font-weight: 700;
      font-size: 16px;
    }
    .last-preview {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }
    .unread-badge {
      background: var(--mx-pink);
      color: #fff;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 6px;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .nav-item.active {
      color: var(--mx-cyan);
    }
    .nav-item .material-icons {
      font-size: 24px;
      margin-bottom: 2px;
    }
    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--mx-pink);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      z-index: 20;
    }
    .alert {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--mx-cyan);
      color: #000;
      padding: 12px 24px;
      border-radius: 20px;
      display: none;
      z-index: 1000;
      font-weight: 700;
      font-size: 14px;
    }
    .alert.active {
      display: block;
      animation: fade 0.3s ease;
    }
    @keyframes fade {
      from { opacity: 0; transform: translate(-50%, -10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
</head>
<body class="dark">

  <!-- Header -->
  <header id="app-header">
    <h1>Mxit Revival</h1>
    <div id="user-profile-pic" class="user-avatar" style="width:40px;height:40px;font-size:18px;"></div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Chats -->
    <div id="chats-section" class="tab-section active">
      <input type="text" id="search-input" placeholder="Search friends..." class="search-input">
      <div id="users-list"></div>
    </div>

    <!-- Channels -->
    <div id="channels-section" class="tab-section">
      <div class="p-4 text-center text-secondary">Channels coming soon...</div>
    </div>

    <!-- Status -->
    <div id="status-section" class="tab-section">
      <div class="p-4 text-center text-secondary">Status updates coming soon...</div>
    </div>

    <!-- Settings -->
    <div id="settings-section" class="tab-section">
      <div class="p-4 text-center text-secondary">Settings coming soon...</div>
    </div>
  </main>

  <!-- FAB -->
  <button id="add-friend-fab" class="fab"><span class="material-icons">person_add</span></button>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats">
      <span class="material-icons">chat</span>
      <span class="nav-label">Chats</span>
    </div>
    <div class="nav-item" data-tab="channels">
      <span class="material-icons">dvr</span>
      <span class="nav-label">Channels</span>
    </div>
    <div class="nav-item" data-tab="status">
      <span class="material-icons">circle</span>
      <span class="nav-label">Status</span>
    </div>
    <div class="nav-item" data-tab="settings">
      <span class="material-icons">settings</span>
      <span class="nav-label">Settings</span>
    </div>
  </nav>

  <!-- Alert -->
  <div id="alert-message" class="alert"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser;

    const showAlert = (msg) => {
      const al = document.getElementById('alert-message');
      al.textContent = msg;
      al.classList.add('active');
      setTimeout(() => al.classList.remove('active'), 3000);
    };

    const formatTime = (ts) => {
      const diff = Date.now() - ts;
      if (diff < 60000) return 'now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
      return new Date(ts).toLocaleDateString();
    };

    const loadFollowedUsers = async () => {
      const list = document.getElementById('users-list');
      list.innerHTML = '';
      const snap = await get(ref(db, `users/${currentUser.uid}/following`));
      if (!snap.exists()) {
        list.innerHTML = '<p class="text-secondary text-center mt-10">Follow friends to start chatting!</p>';
        return;
      }
      const uids = Object.keys(snap.val());
      for (const uid of uids) {
        const userSnap = await get(ref(db, `users/${uid}`));
        const user = userSnap.val();
        if (!user) continue;
        const initial = user.displayName?.[0]?.toUpperCase() || 'U';
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
          <div class="user-avatar">${initial}</div>
          <div>
            <div class="user-name">${user.displayName || user.email}</div>
            <div class="last-preview" id="preview-${uid}">Tap to chat</div>
          </div>
          <span class="unread-badge" id="unread-${uid}" style="display:none;"></span>
        `;
        card.onclick = () => startChat(uid, user);
        list.appendChild(card);

        // live last message
        onValue(ref(db, `users/${currentUser.uid}/chats/${uid}/lastMessage`), async (s) => {
          if (s.exists()) {
            const msg = await decryptMessage(s.val(), [currentUser.uid, uid].sort().join('_'));
            document.getElementById(`preview-${uid}`).textContent = msg;
          }
        });
        // unread
        onValue(ref(db, `users/${currentUser.uid}/chats/${uid}/unreadCount`), (s) => {
          const cnt = s.val() || 0;
          const badge = document.getElementById(`unread-${uid}`);
          badge.style.display = cnt > 0 ? 'inline' : 'none';
          badge.textContent = cnt > 99 ? '99+' : cnt;
        });
      }
    };

    const decryptMessage = async (enc, chatId) => {
      try {
        const { iv, ciphertext } = JSON.parse(enc);
        const ivBytes = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
        const cipherBytes = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          "raw", encoder.encode("grochat-secret-key-2025"), { name: "PBKDF2" }, false, ["deriveKey"]
        );
        const key = await crypto.subtle.deriveKey(
          { name: "PBKDF2", salt: encoder.encode(chatId), iterations: 100000, hash: "SHA-256" },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["decrypt"]
        );
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: ivBytes },
          key,
          cipherBytes
        );
        return new TextDecoder().decode(decrypted);
      } catch {
        return '[Unable to display]';
      }
    };

    const startChat = (uid, user) => {
      const params = new URLSearchParams({
        chatId: [currentUser.uid, uid].sort().join('_'),
        userId: uid,
        username: user.displayName || '',
        avatar: user.photoURL || '',
        verified: !!user.verified,
        isGroup: false
      });
      window.location.href = `chat.html?${params.toString()}`;
    };

    // nav
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const tab = item.dataset.tab;
        document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`${tab}-section`).classList.add('active');
      });
    });

    document.getElementById('add-friend-fab').onclick = () => {
      window.location.href = 'follow-users.html';
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'login.html';
      currentUser = user;
      const pic = document.getElementById('user-profile-pic');
      const initial = user.displayName?.[0]?.toUpperCase() || 'U';
      pic.textContent = initial;
      pic.onclick = () => window.location.href = 'profile.html';
      await loadFollowedUsers();
    });
  </script>
</body>
</html>
