<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Lingua WhatsApp</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --whatsapp-green: #128c7e;
      --whatsapp-green-dark: #075e54;
      --whatsapp-green-light: #25d366;
      --whatsapp-blue: #34b7f1;
      --whatsapp-gray: #f0f2f5;
      --whatsapp-gray-dark: #131c21;
      --whatsapp-chat-bg: #e5ddd5;
      --whatsapp-white: #ffffff;
      --whatsapp-text: #3b4a54;
      --whatsapp-text-secondary: #667781;
      --bubble-own: linear-gradient(135deg, #dcf8c6 0%, #c5e1a5 100%);
      --bubble-other: #ffffff;
      --header-height: 60px;
      --tabbar-height: 70px;
      --input-height: 60px;
      --pill-radius: 25px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--whatsapp-white);
      color: var(--whatsapp-text);
      height: 100vh;
      overflow: hidden;
      touch-action: pan-y;
    }

    .app-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--whatsapp-white);
    }

    @media (min-width: 768px) {
      .app-container {
        max-width: 450px;
        margin: 0 auto;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
      }
    }

    /* WhatsApp-style Header */
    .whatsapp-header {
      height: var(--header-height);
      background: var(--whatsapp-green-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      position: relative;
      z-index: 100;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .whatsapp-header.hidden {
      transform: translateY(-100%);
    }

    .header-title {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 18px;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-actions {
      display: flex;
      gap: 16px;
    }

    .header-icon {
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .header-icon:hover {
      opacity: 0.8;
    }

    /* Bottom Pill-shaped Tab Bar */
    .whatsapp-tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--tabbar-height);
      background: transparent;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 10px;
      z-index: 1000;
      pointer-events: none;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .whatsapp-tabbar.hidden {
      transform: translateY(100%);
    }

    @media (min-width: 768px) {
      .whatsapp-tabbar {
        left: 50%;
        transform: translateX(-50%);
        max-width: 450px;
      }
      
      .whatsapp-tabbar.hidden {
        transform: translateX(-50%) translateY(100%);
      }
    }

    .pill-tabs {
      background: var(--whatsapp-white);
      border-radius: var(--pill-radius);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      padding: 6px;
      gap: 4px;
      pointer-events: all;
      backdrop-filter: blur(10px);
    }

    .pill-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 20px;
      color: var(--whatsapp-text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      min-width: 80px;
      justify-content: center;
    }

    .pill-tab.active {
      background: var(--whatsapp-green);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(18, 140, 126, 0.3);
    }

    .pill-tab-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }

    .pill-tab.active .pill-tab-icon {
      transform: scale(1.1);
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      padding-bottom: var(--tabbar-height);
    }

    /* Swipe Container for Tab Views */
    .swipe-container {
      display: flex;
      width: 200%;
      height: 100%;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .swipe-container.status-active {
      transform: translateX(-50%);
    }

    /* Chats List View with Friends */
    .chats-list-view {
      width: 50%;
      height: 100%;
      background: var(--whatsapp-white);
      overflow-y: auto;
      padding-top: 8px;
      position: relative;
    }

    /* Friend/Chat Items - WhatsApp Style */
    .chat-item-whatsapp {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    .chat-item-whatsapp:hover {
      background: var(--whatsapp-gray);
    }

    .chat-item-whatsapp::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 80px;
      right: 0;
      height: 1px;
      background: rgba(0,0,0,0.05);
    }

    .whatsapp-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--whatsapp-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 500;
      color: var(--whatsapp-text-secondary);
      margin-right: 12px;
      position: relative;
      flex-shrink: 0;
    }

    .whatsapp-avatar.online::before {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: var(--whatsapp-green-light);
      border: 3px solid white;
      border-radius: 50%;
      z-index: 2;
    }

    .chat-info-whatsapp {
      flex: 1;
      min-width: 0;
    }

    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .chat-name-whatsapp {
      font-weight: 500;
      font-size: 16px;
      color: var(--whatsapp-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time-whatsapp {
      font-size: 12px;
      color: var(--whatsapp-text-secondary);
      flex-shrink: 0;
      margin-left: 8px;
    }

    .chat-preview-whatsapp {
      font-size: 14px;
      color: var(--whatsapp-text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Chat View */
    .chat-view {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--whatsapp-chat-bg);
      display: none;
      flex-direction: column;
      z-index: 200;
    }

    .chat-view.active {
      display: flex;
    }

    .chat-view.fullscreen {
      z-index: 300;
      top: 0;
    }

    .chat-header-whatsapp {
      height: var(--header-height);
      background: var(--whatsapp-green-dark);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
    }

    .chat-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 500;
    }

    .chat-header-info {
      flex: 1;
    }

    .chat-header-name {
      color: white;
      font-weight: 500;
      font-size: 16px;
    }

    .chat-header-status {
      color: rgba(255,255,255,0.8);
      font-size: 13px;
    }

    .messages-wrapper-whatsapp {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px;
      background: var(--whatsapp-chat-bg);
    }

    .whatsapp-bubble {
      max-width: 70%;
      padding: 8px 12px;
      margin-bottom: 4px;
      position: relative;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.3;
    }

    .whatsapp-bubble.own {
      background: var(--bubble-own);
      color: #000;
      border-radius: 8px 8px 0 8px;
      margin-left: auto;
    }

    .whatsapp-bubble.other {
      background: var(--bubble-other);
      color: var(--whatsapp-text);
      border-radius: 8px 8px 8px 0;
      margin-right: auto;
    }

    .bubble-time {
      font-size: 11px;
      color: rgba(0,0,0,0.5);
      margin-top: 4px;
      text-align: right;
      opacity: 0.7;
    }

    /* Input Area */
    .input-area-whatsapp {
      background: var(--whatsapp-white);
      padding: 8px 16px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      border-top: 1px solid rgba(0,0,0,0.05);
    }

    .input-wrapper-whatsapp {
      flex: 1;
      background: var(--whatsapp-gray);
      border-radius: 24px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 44px;
    }

    .whatsapp-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 15px;
      outline: none;
      resize: none;
      max-height: 100px;
      -webkit-user-select: text;
      user-select: text;
    }

    .send-btn-whatsapp {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--whatsapp-green);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s;
      flex-shrink: 0;
    }

    .send-btn-whatsapp:hover {
      transform: scale(1.05);
      background: var(--whatsapp-green-dark);
    }

    .send-btn-whatsapp:active {
      transform: scale(0.95);
    }

    /* Add Friend Floating Button */
    .add-friend-fab {
      position: fixed;
      bottom: calc(var(--tabbar-height) + 20px);
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--whatsapp-green);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(18, 140, 126, 0.3);
      z-index: 100;
      transition: transform 0.2s, background-color 0.2s;
    }

    .add-friend-fab:hover {
      transform: scale(1.1);
      background: var(--whatsapp-green-dark);
    }

    .add-friend-fab:active {
      transform: scale(0.95);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    /* Auth Overlay */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 300;
      display: none;
      align-items: flex-end;
    }

    .auth-overlay.open {
      display: flex;
    }

    .auth-box-whatsapp {
      background: var(--whatsapp-white);
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 32px 24px;
      animation: slideUp 0.3s;
    }

    @media (min-width: 768px) {
      .auth-overlay {
        align-items: center;
        justify-content: center;
      }
      .auth-box-whatsapp {
        width: 380px;
        border-radius: 20px;
      }
    }

    .auth-title {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 8px;
    }

    .auth-subtitle {
      text-align: center;
      color: var(--whatsapp-text-secondary);
      margin-bottom: 24px;
      font-size: 14px;
    }

    .auth-input-whatsapp {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 16px;
      background: var(--whatsapp-gray);
    }

    .auth-btn-whatsapp {
      width: 100%;
      padding: 14px;
      background: var(--whatsapp-green);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .auth-switch {
      text-align: center;
      font-size: 14px;
      color: var(--whatsapp-text-secondary);
    }

    .auth-switch-btn {
      background: none;
      border: none;
      color: var(--whatsapp-green);
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- WhatsApp Header -->
  <header class="whatsapp-header" id="mainHeader">
    <div class="header-title">
      <span>Vynix Lingua</span>
    </div>
    <div class="header-actions">
      <span class="material-symbols-rounded header-icon">search</span>
      <span class="material-symbols-rounded header-icon">more_vert</span>
    </div>
  </header>
  <!-- Main Content -->
  <div class="main-content">
    <div class="swipe-container" id="swipeContainer">
      <!-- Chats List View with Friends -->
      <div class="chats-list-view">
        <div id="chatsList" class="chats-list">
          <!-- Skeleton will be injected here -->
        </div>
      </div>
      <!-- Status View -->
      <div class="status-view">
        <div class="status-header">
          <h2 class="status-title">Status</h2>
          <button class="add-status-btn" id="addStatusBtn">
            <span class="material-symbols-rounded">add</span>
          </button>
        </div>

        <!-- Status Composer -->
        <div class="status-composer" id="statusComposer">
          <textarea class="status-input" id="statusInput" placeholder="What's on your mind?"></textarea>
          <button class="status-post-btn" id="statusPostBtn">Post Status</button>
        </div>

        <!-- Status Cards Container -->
        <div id="statusCards" class="status-cards">
          <!-- Status cards will be generated here -->
        </div>
      </div>
    </div>
    <!-- Chat View (Hidden by default) -->
    <div class="chat-view" id="chatView">
      <div class="chat-header-whatsapp">
        <span class="material-symbols-rounded header-icon" id="backBtn" style="cursor: pointer;">arrow_back</span>
        <div class="chat-header-avatar" id="chatHeaderAvatar"></div>
        <div class="chat-header-info">
          <div class="chat-header-name" id="chatHeaderName"></div>
          <div class="chat-header-status" id="chatHeaderStatus">Online</div>
        </div>
        <span class="material-symbols-rounded header-icon">more_vert</span>
      </div>

      <div class="messages-wrapper-whatsapp" id="messagesContainer">
        <!-- Messages will appear here -->
      </div>

      <div class="input-area-whatsapp">
        <div class="input-wrapper-whatsapp">
          <span class="material-symbols-rounded" style="color: var(--whatsapp-text-secondary); cursor: pointer;">emoji_emotions</span>
          <textarea class="whatsapp-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
          <span class="material-symbols-rounded" style="color: var(--whatsapp-text-secondary); cursor: pointer;">attach_file</span>
        </div>
        <button class="send-btn-whatsapp" id="sendButton">
          <span class="material-symbols-rounded">send</span>
        </button>
      </div>
    </div>
  </div>
  <!-- Add Friend Floating Button -->
  <div class="add-friend-fab" id="addFriendFab">
    <span class="material-symbols-rounded">person_add</span>
  </div>
  <!-- Bottom Pill-shaped Tab Bar -->
  <div class="whatsapp-tabbar" id="tabbar">
    <div class="pill-tabs">
      <div class="pill-tab active" data-tab="chats">
        <span class="material-symbols-rounded pill-tab-icon">chat_bubble</span>
        <span>Chats</span>
      </div>
      <div class="pill-tab" data-tab="status">
        <span class="material-symbols-rounded pill-tab-icon">circle</span>
        <span>Status</span>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, ... } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ... } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    
    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    
    // ðŸ” E2EE KEY MANAGEMENT SYSTEM
    class E2EEManager {
      constructor() {
        this.keyPairs = new Map();
        this.sessionKeys = new Map();
        this.ratchetKeys = new Map();
      }
      async generateKeyPair(userId) {
        const keyPair = {
          publicKey: this.generateRSAKeyPair(),
          privateKey: this.generateRSAKeyPair()
        };
        this.keyPairs.set(userId, keyPair);
        return keyPair;
      }
      generateSessionKey(userId, partnerId, userPrivateKey, partnerPublicKey) {
        const sessionId = [userId, partnerId].sort().join('_');
        const sharedSecret = this.computeSharedSecret(userPrivateKey, partnerPublicKey);
        const sessionKey = CryptoJS.SHA256(sharedSecret + sessionId).toString();
        this.sessionKeys.set(sessionId, sessionKey);
        return sessionKey;
      }
      encryptMessage(message, sessionKey) {
        const aesKey = CryptoJS.lib.WordArray.random(256/8).toString();
        const iv = CryptoJS.lib.WordArray.random(128/8);
        const encrypted = CryptoJS.AES.encrypt(message, aesKey, { iv: iv }).toString();
        const encryptedAesKey = CryptoJS.AES.encrypt(aesKey, sessionKey).toString();
        return {
          encrypted: encrypted,
          key: encryptedAesKey,
          iv: iv.toString()
        };
      }
      decryptMessage(encryptedData, sessionKey) {
        try {
          const aesKey = CryptoJS.AES.decrypt(encryptedData.key, sessionKey).toString(CryptoJS.enc.Utf8);
          if (!aesKey) throw new Error('Failed to decrypt AES key');
          const decrypted = CryptoJS.AES.decrypt(encryptedData.encrypted, aesKey, {
            iv: CryptoJS.enc.Hex.parse(encryptedData.iv)
          }).toString(CryptoJS.enc.Utf8);
          return decrypted || 'âš ï¸ Decryption failed';
        } catch (e) {
          return 'âš ï¸ Encrypted message';
        }
      }
      generateRSAKeyPair() {
        return CryptoJS.lib.WordArray.random(256/8).toString();
      }
      computeSharedSecret(privateKey, publicKey) {
        return CryptoJS.SHA256(privateKey + publicKey).toString();
      }
    }
    
    // Initialize E2EE Manager
    const e2eeManager = new E2EEManager();
    
    // State management
    let currentUser = null;
    let activeChatId = null;
    let activeChatPartner = null;
    let isInitialLoad = true;
    let userStatusMap = new Map();
    let isPrivateChatMode = false;
    
    // DOM Elements
    const els = {
      chatsList: document.getElementById('chatsList'),
      statusCards: document.getElementById('statusCards'),
      statusComposer: document.getElementById('statusComposer'),
      statusInput: document.getElementById('statusInput'),
      statusPostBtn: document.getElementById('statusPostBtn'),
      addStatusBtn: document.getElementById('addStatusBtn'),
      chatView: document.getElementById('chatView'),
      messagesContainer: document.getElementById('messagesContainer'),
      messageInput: document.getElementById('messageInput'),
      sendButton: document.getElementById('sendButton'),
      backBtn: document.getElementById('backBtn'),
      chatHeaderAvatar: document.getElementById('chatHeaderAvatar'),
      chatHeaderName: document.getElementById('chatHeaderName'),
      chatHeaderStatus: document.getElementById('chatHeaderStatus'),
      tabbar: document.getElementById('tabbar'),
      addFriendFab: document.getElementById('addFriendFab'),
      swipeContainer: document.getElementById('swipeContainer'),
      mainHeader: document.getElementById('mainHeader')
    };
    
    // Tab Switching
    function switchTab(tabName) {
      document.querySelectorAll('.pill-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });
      if (tabName === 'chats') {
        els.swipeContainer.classList.remove('status-active');
        showChatsList();
      } else {
        els.swipeContainer.classList.add('status-active');
        showStatusList();
      }
    }
    
    // Pill Tab Click Handlers
    document.querySelectorAll('.pill-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        switchTab(tab.dataset.tab);
      });
    });
    
    // Floating Add Friend Button
    els.addFriendFab.addEventListener('click', openUsersSheet);
    
    // Show Chats List
    function showChatsList() {
      els.chatView.classList.remove('active');
      els.tabbar.classList.remove('hidden');
      els.mainHeader.classList.remove('hidden');
      isPrivateChatMode = false;
      activeChatId = null;
      loadFriendsChatsRealTime();
    }
    
    function showStatusList() {
      els.chatView.classList.remove('active');
      els.tabbar.classList.remove('hidden');
      els.mainHeader.classList.remove('hidden');
      isPrivateChatMode = false;
      activeChatId = null;
      loadStatusPostsRealTime();
    }
    
    // Real-time friends list loader
    function loadFriendsChatsRealTime() {
      els.chatsList.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="skeleton-item"><div class="skeleton-avatar shimmer"></div><div class="skeleton-lines"><div class="skeleton-line short shimmer"></div><div class="skeleton-line long shimmer"></div></div></div></div>';
      
      const userRef = ref(db, `users/${currentUser.uid}`);
      onValue(userRef, async (snapshot) => {
        if (!snapshot.exists()) return;
        
        const data = snapshot.val();
        const friends = data.friends || [];
        
        if (friends.length === 0) {
          els.chatsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--whatsapp-text-secondary);">
              <span class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px;">group_add</span>
              <p>No friends yet</p>
              <p style="font-size: 14px; margin-top: 8px;">Tap the + button to add friends and start chatting</p>
            </div>
          `;
          return;
        }
        
        els.chatsList.innerHTML = '';
        
        for (const friendUid of friends) {
          const friendRef = ref(db, `users/${friendUid}`);
          const friendSnap = await get(friendRef);
          
          if (!friendSnap.exists()) continue;
          
          const friend = friendSnap.val();
          const chatId = [currentUser.uid, friendUid].sort().join('_');
          const isOnline = userStatusMap.get(friendUid) || false;
          
          const chatItem = document.createElement('div');
          chatItem.className = 'chat-item-whatsapp';
          chatItem.innerHTML = `
            <div class="whatsapp-avatar ${isOnline ? 'online' : ''}">
              ${friend.displayName.charAt(0).toUpperCase()}
            </div>
            <div class="chat-info-whatsapp">
              <div class="chat-header-row">
                <div class="chat-name-whatsapp">${friend.displayName}</div>
                <div class="chat-time-whatsapp" id="time-${chatId}"></div>
              </div>
              <div class="chat-preview-whatsapp" id="preview-${chatId}">Tap to start chatting</div>
            </div>
          `;
          
          chatItem.addEventListener('click', () => openPrivateChat(chatId, {
            uid: friendUid,
            displayName: friend.displayName,
            publicKey: friend.publicKey
          }));
          
          els.chatsList.appendChild(chatItem);
          
          // Last message listener
          const messagesRef = ref(db, `privateChats/${chatId}/messages`);
          const messagesQuery = query(messagesRef, orderByChild('createdAt'), limitToLast(1));
          
          onValue(messagesQuery, (snapshot) => {
            const previewEl = document.getElementById(`preview-${chatId}`);
            const timeEl = document.getElementById(`time-${chatId}`);
            
            if (snapshot.size === 0) {
              previewEl.textContent = 'Tap to start chatting';
              timeEl.textContent = '';
              return;
            }
            
            let lastMsg;
            snapshot.forEach(child => {
              lastMsg = child.val();
            });
            
            const isOwn = lastMsg.userId === currentUser.uid;
            const sessionKey = e2eeManager.sessionKeys.get(chatId) || 'fallback-key';
            const decrypted = e2eeManager.decryptMessage({
              encrypted: lastMsg.text.encrypted,
              key: lastMsg.text.key,
              iv: lastMsg.text.iv
            }, sessionKey);
            
            const shortText = decrypted.length > 30 ? decrypted.slice(0, 27) + '...' : decrypted;
            previewEl.textContent = isOwn ? `You: ${shortText}` : shortText;
            
            if (lastMsg.createdAt) {
              const time = new Date(lastMsg.createdAt);
              const now = new Date();
              const diffMs = now - time;
              const diffMins = Math.floor(diffMs / 60000);
              const diffHours = Math.floor(diffMs / 3600000);
              const diffDays = Math.floor(diffMs / 86400000);
              
              let timeStr;
              if (diffMins < 1) timeStr = 'now';
              else if (diffMins < 60) timeStr = `${diffMins}m`;
              else if (diffHours < 24) timeStr = `${diffHours}h`;
              else if (diffDays < 7) timeStr = `${diffDays}d`;
              else timeStr = time.toLocaleDateString();
              
              timeEl.textContent = timeStr;
            }
          });
        }
      });
    }
    
    // Real-time status posts
    function loadStatusPostsRealTime() {
      const statusRef = ref(db, 'statusPosts');
      const statusQuery = query(statusRef, orderByChild('createdAt'), limitToLast(20));
      
      onValue(statusQuery, (snapshot) => {
        els.statusCards.innerHTML = '';
        
        if (snapshot.size === 0) {
          els.statusCards.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--whatsapp-text-secondary);">
              <span class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px;">post_add</span>
              <p>No status updates yet</p>
              <p style="font-size: 14px; margin-top: 8px;">Be the first to share your thoughts!</p>
            </div>
          `;
          return;
        }
        
        const posts = [];
        snapshot.forEach(child => {
          posts.unshift({ id: child.key, ...child.val() });
        });
        
        posts.forEach(post => {
          const card = document.createElement('div');
          card.className = 'status-card';
          card.dataset.postId = post.id;
          
          const time = new Date(post.createdAt);
          const timeAgo = getTimeAgo(time);
          const likeCount = post.likes?.length || 0;
          
          card.innerHTML = `
            <div class="status-card-header">
              <div class="status-avatar">
                ${post.userName.charAt(0).toUpperCase()}
              </div>
              <div class="status-meta">
                <div class="status-author">${post.userName}</div>
                <div class="status-time">${timeAgo}</div>
              </div>
            </div>
            <div class="status-content">${escapeHtml(post.content)}</div>
            <div class="status-actions">
              <div class="status-action" onclick="likeStatus('${post.id}')">
                <span class="material-symbols-rounded" style="font-size: 18px;">favorite</span>
                <span class="like-count">${likeCount}</span>
              </div>
              <div class="status-action" onclick="commentStatus('${post.id}')">
                <span class="material-symbols-rounded" style="font-size: 18px;">comment</span>
                <span>Comment</span>
              </div>
              <div class="status-action" onclick="shareStatus('${post.id}')">
                <span class="material-symbols-rounded" style="font-size: 18px;">share</span>
                <span>Share</span>
              </div>
            </div>
          `;
          els.statusCards.appendChild(card);
        });
      });
    }
    
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }
    
    // Status actions
    window.likeStatus = async (statusId) => {
      const statusRef = ref(db, `statusPosts/${statusId}`);
      const statusSnap = await get(statusRef);
      const likes = statusSnap.val()?.likes || [];
      
      if (!likes.includes(currentUser.uid)) {
        likes.push(currentUser.uid);
        await update(statusRef, { likes });
        showToast('Status liked!');
      }
    };
    
    window.commentStatus = (statusId) => {
      showToast('Comment feature coming soon!');
    };
    
    window.shareStatus = (statusId) => {
      showToast('Share feature coming soon!');
    };
    
    // Open a chat with E2EE - FULLSCREEN EXPERIENCE
    async function openPrivateChat(chatId, partner) {
      // Hide header and tabbar for full-screen chat
      els.mainHeader.classList.add('hidden');
      els.tabbar.classList.add('hidden');
      els.chatView.classList.add('active', 'fullscreen');
      
      isPrivateChatMode = true;
      activeChatId = chatId;
      activeChatPartner = partner;
      
      els.messagesContainer.innerHTML = '';
      els.chatHeaderAvatar.textContent = partner.displayName.charAt(0).toUpperCase();
      els.chatHeaderName.textContent = partner.displayName;
      
      const userRef = ref(db, `users/${currentUser.uid}`);
      const userSnap = await get(userRef);
      const userPrivateKey = userSnap.val()?.privateKey || 'fallback-private';
      const partnerPublicKey = partner.publicKey || 'fallback-public';
      
      const sessionKey = e2eeManager.generateSessionKey(
        currentUser.uid,
        partner.uid,
        userPrivateKey,
        partnerPublicKey
      );
      
      isInitialLoad = true;
      
      const messagesRef = ref(db, `privateChats/${chatId}/messages`);
      const messagesQuery = query(messagesRef, orderByChild('createdAt'), limitToLast(50));
      
      onValue(messagesQuery, (snapshot) => {
        els.messagesContainer.innerHTML = ''; // Clear existing messages
        
        snapshot.forEach(child => {
          appendWhatsAppMessage(child, sessionKey);
        });
        
        if (isInitialLoad) {
          scrollToBottom();
          isInitialLoad = false;
        }
      });
    }
    
    // Back button
    els.backBtn.addEventListener('click', () => {
      els.mainHeader.classList.remove('hidden');
      els.tabbar.classList.remove('hidden');
      els.chatView.classList.remove('active', 'fullscreen');
      
      isPrivateChatMode = false;
      switchTab('chats');
    });
    
    function appendWhatsAppMessage(snapshot, sessionKey) {
      const data = snapshot.val();
      const isOwn = data.userId === currentUser.uid;
      
      const decryptedText = e2eeManager.decryptMessage({
        encrypted: data.text.encrypted,
        key: data.text.key,
        iv: data.text.iv
      }, sessionKey);
      
      const time = new Date(data.createdAt);
      const timeStr = time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      
      const bubble = document.createElement('div');
      bubble.className = `whatsapp-bubble ${isOwn ? 'own' : 'other'}`;
      bubble.innerHTML = `
        ${escapeHtml(decryptedText)}
        <div class="bubble-time">${timeStr}</div>
      `;
      
      els.messagesContainer.appendChild(bubble);
    }
    
    // Send Message
    async function sendMessage() {
      const text = els.messageInput.value.trim();
      if (!text || !currentUser || !activeChatId) return;
      
      els.messageInput.value = '';
      els.messageInput.style.height = 'auto';
      
      const sessionKey = e2eeManager.sessionKeys.get(activeChatId) || 'fallback-key';
      const encrypted = e2eeManager.encryptMessage(text, sessionKey);
      
      const messagesRef = ref(db, `privateChats/${activeChatId}/messages`);
      await push(messagesRef, {
        text: encrypted,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anon',
        createdAt: Date.now()
      });
    }
    
    // Auto-resize textarea
    els.messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    
    els.messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    els.sendButton.addEventListener('click', sendMessage);
    
    function scrollToBottom() {
      els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast-notification show';
      toast.innerHTML = `<span>${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Status functionality
    els.statusPostBtn.addEventListener('click', async () => {
      const content = els.statusInput.value.trim();
      if (!content || !currentUser) return;
      
      try {
        const statusRef = ref(db, 'statusPosts');
        await push(statusRef, {
          content: content,
          userId: currentUser.uid,
          userName: currentUser.displayName || 'Anonymous',
          createdAt: Date.now(),
          likes: [],
          comments: []
        });
        
        els.statusInput.value = '';
        showToast('Status posted!');
      } catch (error) {
        console.error('Post status error:', error);
        showToast('Failed to post status');
      }
    });
    
    // Users Sheet Functions
    async function openUsersSheet() {
      const usersSheet = document.createElement('div');
      usersSheet.className = 'users-sheet open';
      usersSheet.innerHTML = `
        <div class="users-box">
          <div class="users-header">
            <h2 class="users-title">Add Friends</h2>
            <button class="close-sheet-btn" onclick="this.closest('.users-sheet').remove()">
              <span class="material-symbols-rounded">close</span>
            </button>
          </div>
          <div class="users-list">
            <div style="text-align: center; padding: 40px;">
              <span class="material-symbols-rounded" style="font-size: 48px; color: var(--whatsapp-text-secondary);">hourglass_empty</span>
              <p>Loading users...</p>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(usersSheet);
      
      try {
        const myRef = ref(db, `users/${currentUser.uid}`);
        const mySnap = await get(myRef);
        const myFriends = mySnap.val()?.friends || [];
        
        const usersRef = ref(db, 'users');
        const usersSnap = await get(usersRef);
        
        const usersList = usersSheet.querySelector('.users-list');
        usersList.innerHTML = '';
        
        usersSnap.forEach(child => {
          if (child.key === currentUser.uid) return;
          const user = child.val();
          const isFriend = myFriends.includes(child.key);
          const isOnline = userStatusMap.get(child.key) || false;
          
          const item = document.createElement('div');
          item.className = 'user-item-whatsapp';
          item.innerHTML = `
            <div class="user-avatar-whatsapp ${isOnline ? 'online' : ''}">
              ${user.displayName?.charAt(0).toUpperCase() || '?'}
            </div>
            <div class="user-info-whatsapp">
              <div class="user-name-whatsapp">${user.displayName || 'Anonymous'}</div>
              <div class="user-email-whatsapp">${user.email || 'No email'}</div>
            </div>
            <button class="add-friend-btn ${isFriend ? 'added' : ''}" ${isFriend ? 'disabled' : ''} data-userid="${child.key}">
              ${isFriend ? 'Added' : 'Add Friend'}
            </button>
          `;
          
          if (!isFriend) {
            item.querySelector('.add-friend-btn').addEventListener('click', async (e) => {
              await addFriend(child.key, e.target);
            });
          }
          
          usersList.appendChild(item);
        });
        
        if (usersList.children.length === 0) {
          usersList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--whatsapp-text-secondary);">
              <span class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px;">group</span>
              <p>No other users found</p>
              <p style="font-size: 14px; margin-top: 8px;">Invite friends to join Vynix Lingua!</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }
    
    async function addFriend(friendUid, btn) {
      try {
        const myRef = ref(db, `users/${currentUser.uid}`);
        const friendRef = ref(db, `users/${friendUid}`);
        
        const mySnap = await get(myRef);
        const friendSnap = await get(friendRef);
        
        const myFriends = mySnap.val()?.friends || [];
        const friendFriends = friendSnap.val()?.friends || [];
        
        if (!myFriends.includes(friendUid)) {
          myFriends.push(friendUid);
          await update(myRef, { friends: myFriends });
        }
        
        if (!friendFriends.includes(currentUser.uid)) {
          friendFriends.push(currentUser.uid);
          await update(friendRef, { friends: friendFriends });
        }
        
        btn.textContent = 'Added';
        btn.classList.add('added');
        btn.disabled = true;
        showToast('Friend added successfully!');
      } catch (error) {
        console.error('Add friend error:', error);
        showToast('Failed to add friend');
      }
    }
    
    // Auth
    let isSignUp = false;
    
    // Create auth overlay if it doesn't exist
    if (!document.getElementById('authOverlay')) {
      const authOverlay = document.createElement('div');
      authOverlay.id = 'authOverlay';
      authOverlay.className = 'auth-overlay';
      authOverlay.innerHTML = `
        <div class="auth-box-whatsapp">
          <h2 class="auth-title">Welcome to Vynix Lingua</h2>
          <p class="auth-subtitle">Sign in to start chatting securely</p>
          <input type="email" id="authEmail" class="auth-input-whatsapp" placeholder="Email">
          <input type="password" id="authPass" class="auth-input-whatsapp" placeholder="Password">
          <button class="auth-btn-whatsapp" id="authBtn">Sign In</button>
          <div class="auth-switch">
            <span>Don't have an account? </span>
            <button class="auth-switch-btn" id="authSwitchBtn">Sign Up</button>
          </div>
        </div>
      `;
      document.body.appendChild(authOverlay);
    }
    
    document.getElementById('authSwitchBtn').addEventListener('click', () => {
      isSignUp = !isSignUp;
      document.getElementById('authBtn').textContent = isSignUp ? 'Sign Up' : 'Sign In';
      document.getElementById('authSwitchBtn').textContent = isSignUp ? 'Sign In' : 'Sign Up';
      document.querySelector('.auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
    });
    
    document.getElementById('authBtn').addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if (!email || !pass) return showToast('Please fill in all fields');
      
      try {
        let cred;
        if (isSignUp) {
          cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: email.split('@')[0] });
        } else {
          cred = await signInWithEmailAndPassword(auth, email, pass);
        }
        
        const keyPair = await e2eeManager.generateKeyPair(cred.user.uid);
        const userRef = ref(db, `users/${cred.user.uid}`);
        await set(userRef, {
          displayName: cred.user.displayName,
          email: email,
          lastSeen: Date.now(),
          friends: [],
          publicKey: keyPair.publicKey
        });
        
        document.getElementById('authOverlay').classList.remove('open');
        showToast(isSignUp ? 'Account created successfully!' : 'Welcome back!');
      } catch (e) {
        showToast(e.message);
      }
    });
    
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        document.getElementById('authOverlay').classList.add('open');
      } else {
        switchTab('chats');
        startHeartbeat();
      }
    });
    
    // Heartbeat for online status
    function startHeartbeat() {
      const update = async () => {
        if (currentUser) {
          const userRef = ref(db, `users/${currentUser.uid}`);
          await update(userRef, { lastSeen: Date.now() });
        }
      };
      
      update();
      setInterval(update, 60000);
    }
    
    // Initialize
    switchTab('chats');
  </script>
</body>
</html>
