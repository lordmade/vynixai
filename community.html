<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Vynix Lingua WhatsApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet" />
  <style>
    :root {
      --primary-black: #000;
      --primary-white: #fff;
      --gray-light: #f5f5f5;
      --gray-mid: #9e9e9e;
      --bubble-own: #e0e0e0;
      --bubble-other: #fff;
      --header-height: 60px;
      --tabbar-height: 70px;
      --pill-radius: 25px;
      --fb-blue: #1877F2;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--primary-white);
      color: #000;
      height: 100vh;
      overflow: hidden;
      touch-action: pan-y;
    }
    .app-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--primary-white);
    }
    @media (min-width: 768px) {
      .app-container {
        max-width: 450px;
        margin: 0 auto;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
    }
    .whatsapp-header {
      height: var(--header-height);
      background: var(--primary-black);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 100;
      transition: transform 0.3s;
    }
    .whatsapp-header.hidden {
      transform: translateY(-100%);
    }
    .header-title {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 18px;
      color: var(--primary-white);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-actions {
      display: flex;
      gap: 16px;
    }
    .header-icon {
      color: var(--primary-white);
      font-size: 24px;
      cursor: pointer;
    }
    .whatsapp-tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--tabbar-height);
      display: flex;
      justify-content: center;
      padding-top: 10px;
      z-index: 1000;
      pointer-events: none;
      transition: transform 0.3s ease;
    }
    .whatsapp-tabbar.hidden {
      transform: translateY(100%);
    }
    @media (min-width: 768px) {
      .whatsapp-tabbar {
        left: 50%;
        transform: translateX(-50%);
        max-width: 450px;
      }
    }
    .pill-tabs {
      background: var(--primary-white);
      border-radius: var(--pill-radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      padding: 6px;
      gap: 4px;
      pointer-events: all;
    }
    .pill-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 20px;
      color: var(--gray-mid);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      min-width: 80px;
      justify-content: center;
    }
    .pill-tab.active {
      background: var(--primary-black);
      color: var(--primary-white);
      transform: scale(1.05);
    }
    .main-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      padding-bottom: var(--tabbar-height);
    }
    .swipe-container {
      display: flex;
      width: 200%;
      height: 100%;
      transition: transform 0.3s;
    }
    .swipe-container.status-active {
      transform: translateX(-50%);
    }
    .chats-list-view,
    .status-view {
      width: 50%;
      height: 100%;
      background: var(--primary-white);
      overflow-y: auto;
      padding-top: 8px;
    }
    .chat-item-whatsapp {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      position: relative;
    }
    .chat-item-whatsapp:hover {
      background: var(--gray-light);
    }
    .chat-item-whatsapp::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 80px;
      right: 0;
      height: 1px;
      background: rgba(0, 0, 0, 0.05);
    }
    .whatsapp-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--gray-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 500;
      color: #000;
      margin-right: 12px;
      position: relative;
      flex-shrink: 0;
    }
    .whatsapp-avatar.online::before {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: #4caf50;
      border: 3px solid white;
      border-radius: 50%;
      z-index: 2;
    }
    .chat-info-whatsapp {
      flex: 1;
      min-width: 0;
    }
    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .chat-name-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chat-name-whatsapp {
      font-weight: 500;
      font-size: 16px;
      color: #000;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .verified-badge {
      width: 18px;
      height: 18px;
      background: var(--fb-blue);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      flex-shrink: 0;
    }
    .chat-time-whatsapp {
      font-size: 12px;
      color: var(--gray-mid);
      margin-left: 8px;
      flex-shrink: 0;
    }
    .chat-preview-whatsapp {
      font-size: 14px;
      color: var(--gray-mid);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .typing-indicator {
      font-size: 14px;
      color: #4caf50;
      font-style: italic;
    }
    .chat-view {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gray-light);
      display: none;
      flex-direction: column;
      z-index: 200;
    }
    .chat-view.active {
      display: flex;
    }
    .chat-header-whatsapp {
      display: none !important;
    }
    .messages-wrapper-whatsapp {
      flex: 1;
      overflow-y: auto;
      padding: 16px 16px 80px 16px;
      background: var(--gray-light);
      contain: strict; /* Performance boost */
    }
    .whatsapp-bubble {
      max-width: 70%;
      padding: 8px 12px;
      margin-bottom: 4px;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.3;
      contain: layout style paint; /* Major performance improvement */
    }
    .whatsapp-bubble.own {
      background: var(--bubble-own);
      color: #000;
      border-radius: 8px 8px 0 8px;
      margin-left: auto;
    }
    .whatsapp-bubble.other {
      background: var(--bubble-other);
      color: #000;
      border-radius: 8px 8px 8px 0;
      margin-right: auto;
    }
    .bubble-time {
      font-size: 11px;
      color: rgba(0, 0, 0, 0.5);
      margin-top: 4px;
      text-align: right;
    }
    .input-area-whatsapp {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--primary-white);
      padding: 8px 16px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      z-index: 300;
    }
    @media (min-width: 768px) {
      .input-area-whatsapp {
        left: 50%;
        transform: translateX(-50%);
        max-width: 450px;
      }
    }
    .input-wrapper-whatsapp {
      flex: 1;
      background: var(--gray-light);
      border-radius: 24px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 44px;
    }
    .whatsapp-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 15px;
      outline: none;
      resize: none;
      max-height: 100px;
      -webkit-user-select: text;
      user-select: text;
    }
    .send-btn-whatsapp {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary-black);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }
    #floatingBackBtn {
      position: fixed;
      top: 16px;
      left: 16px;
      font-size: 32px;
      color: #fff;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      padding: 8px;
      z-index: 400;
      cursor: pointer;
      display: none;
    }
    /* Show floating back button only on desktop (≥768px) when chat is active */
    @media (min-width: 768px) {
      .chat-view.active #floatingBackBtn {
        display: block;
      }
    }
    .add-friend-fab {
      position: fixed;
      bottom: calc(var(--tabbar-height) + 20px);
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary-black);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 100;
      transition: transform 0.3s ease;
    }
    .add-friend-fab.hidden {
      transform: translateY(100px);
    }
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 300;
      display: none;
      align-items: flex-end;
    }
    .auth-overlay.open {
      display: flex;
    }
    .auth-box-whatsapp {
      background: var(--primary-white);
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 32px 24px;
      animation: slideUp 0.3s;
    }
    @media (min-width: 768px) {
      .auth-overlay {
        align-items: center;
        justify-content: center;
      }
      .auth-box-whatsapp {
        width: 380px;
        border-radius: 20px;
      }
    }
    .auth-title {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 8px;
    }
    .auth-subtitle {
      text-align: center;
      color: var(--gray-mid);
      margin-bottom: 24px;
      font-size: 14px;
    }
    .auth-input-whatsapp {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 16px;
      background: var(--gray-light);
    }
    .auth-btn-whatsapp {
      width: 100%;
      padding: 14px;
      background: var(--primary-black);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .auth-switch {
      text-align: center;
      font-size: 14px;
      color: var(--gray-mid);
    }
    .auth-switch-btn {
      background: none;
      border: none;
      color: var(--primary-black);
      font-weight: 600;
      cursor: pointer;
    }
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
    }
    .status-title {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 600;
    }
    .add-status-btn {
      background: var(--primary-black);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .status-composer {
      padding: 0 16px 16px;
      display: none;
    }
    .status-composer.open {
      display: block;
    }
    .status-input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      font-size: 15px;
    }
    .status-post-btn {
      margin-top: 12px;
      padding: 10px 20px;
      background: var(--primary-black);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    .status-cards {
      padding: 0 16px;
    }
    .status-card {
      background: var(--gray-light);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .status-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .status-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }
    .status-author {
      font-weight: 500;
    }
    .status-time {
      font-size: 12px;
      color: var(--gray-mid);
    }
    .status-content {
      margin-bottom: 12px;
      white-space: pre-wrap;
    }
    .status-actions {
      display: flex;
      gap: 16px;
    }
    .status-action {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: var(--gray-mid);
      cursor: pointer;
    }
    .users-sheet {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 400;
      display: none;
      align-items: flex-end;
    }
    .users-sheet.open {
      display: flex;
    }
    .users-box {
      background: var(--primary-white);
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 24px;
      animation: slideUp 0.3s;
    }
    @media (min-width: 768px) {
      .users-sheet {
        align-items: center;
        justify-content: center;
      }
      .users-box {
        width: 380px;
        border-radius: 20px;
      }
    }
    .users-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .users-title {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 600;
    }
    .close-sheet-btn {
      background: none;
      border: none;
      cursor: pointer;
    }
    .users-list {
      max-height: 50vh;
      overflow-y: auto;
    }
    .user-item-whatsapp {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }
    .user-avatar-whatsapp {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--gray-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      position: relative;
    }
    .user-avatar-whatsapp.online::before {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: #4caf50;
      border: 2px solid white;
      border-radius: 50%;
    }
    .user-info-whatsapp {
      flex: 1;
      min-width: 0;
    }
    .user-name-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .user-name-whatsapp {
      font-weight: 500;
    }
    .user-email-whatsapp {
      font-size: 14px;
      color: var(--gray-mid);
    }
    .add-friend-btn {
      padding: 8px 16px;
      background: var(--primary-black);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .add-friend-btn.added {
      background: var(--gray-mid);
      cursor: not-allowed;
    }
    .toast-notification {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-black);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .toast-notification.show {
      opacity: 1;
    }
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="whatsapp-header" id="mainHeader">
      <div class="header-title">Vynix Lingua</div>
      <div class="header-actions">
        <span class="material-symbols-rounded header-icon">search</span>
        <span class="material-symbols-rounded header-icon">more_vert</span>
      </div>
    </header>
    <div class="main-content">
      <div class="swipe-container" id="swipeContainer">
        <div class="chats-list-view">
          <div id="chatsList" class="chats-list"></div>
        </div>
        <div class="status-view">
          <div class="status-header">
            <h2 class="status-title">Status</h2>
            <button class="add-status-btn" id="addStatusBtn">
              <span class="material-symbols-rounded">add</span>
            </button>
          </div>
          <div class="status-composer" id="statusComposer">
            <textarea class="status-input" id="statusInput" placeholder="What's on your mind?"></textarea>
            <button class="status-post-btn" id="statusPostBtn">Post Status</button>
          </div>
          <div id="statusCards" class="status-cards"></div>
        </div>
      </div>
      <div class="chat-view" id="chatView">
        <span class="material-symbols-rounded" id="floatingBackBtn">arrow_back</span>
        <div class="messages-wrapper-whatsapp" id="messagesContainer"></div>
        <div class="input-area-whatsapp">
          <div class="input-wrapper-whatsapp">
            <span class="material-symbols-rounded" style="color: var(--gray-mid); cursor: pointer">emoji_emotions</span>
            <textarea class="whatsapp-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <span class="material-symbols-rounded" style="color: var(--gray-mid); cursor: pointer">attach_file</span>
          </div>
          <button class="send-btn-whatsapp" id="sendButton">
            <span class="material-symbols-rounded">send</span>
          </button>
        </div>
      </div>
    </div>
    <div class="add-friend-fab" id="addFriendFab">
      <span class="material-symbols-rounded">person_add</span>
    </div>
    <div class="whatsapp-tabbar" id="tabbar">
      <div class="pill-tabs">
        <div class="pill-tab active" data-tab="chats">
          <span class="material-symbols-rounded pill-tab-icon">chat_bubble</span>
          <span>Chats</span>
        </div>
        <div class="pill-tab" data-tab="status">
          <span class="material-symbols-rounded pill-tab-icon">circle</span>
          <span>Status</span>
        </div>
      </div>
    </div>
  </div>
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box-whatsapp">
      <h2 class="auth-title">Welcome to Vynix Lingua</h2>
      <p class="auth-subtitle">Sign in to start chatting</p>
      <input type="email" id="authEmail" class="auth-input-whatsapp" placeholder="Email" />
      <input type="password" id="authPass" class="auth-input-whatsapp" placeholder="Password" />
      <button class="auth-btn-whatsapp" id="authBtn">Sign In</button>
      <div class="auth-switch">
        <span>Don't have an account?</span>
        <button class="auth-switch-btn" id="authSwitchBtn">Sign Up</button>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, update, set, get, query, orderByChild, limitToLast, endBefore, onDisconnect, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
  
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:32699cbc33e85f4bafa36e",
      measurementId: "G-2505EVBRWX"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;
    let activeChatId = null;
    let isPrivateChatMode = false;
    const chatListeners = new Map();
    const typingTimeouts = new Map();
    // Pagination for large chats
    const MESSAGES_PER_LOAD = 50;
    let oldestMessageKey = null;
    let isLoadingMore = false;
    const els = {
      chatsList: document.getElementById('chatsList'),
      statusCards: document.getElementById('statusCards'),
      statusComposer: document.getElementById('statusComposer'),
      statusInput: document.getElementById('statusInput'),
      statusPostBtn: document.getElementById('statusPostBtn'),
      addStatusBtn: document.getElementById('addStatusBtn'),
      chatView: document.getElementById('chatView'),
      messagesContainer: document.getElementById('messagesContainer'),
      messageInput: document.getElementById('messageInput'),
      sendButton: document.getElementById('sendButton'),
      floatingBackBtn: document.getElementById('floatingBackBtn'),
      tabbar: document.getElementById('tabbar'),
      addFriendFab: document.getElementById('addFriendFab'),
      swipeContainer: document.getElementById('swipeContainer'),
      mainHeader: document.getElementById('mainHeader'),
      mainContent: document.querySelector('.main-content')
    };

    function closeChatView() {
      els.mainHeader.classList.remove('hidden');
      els.tabbar.classList.remove('hidden');
      els.addFriendFab.classList.remove('hidden');
      els.chatView.classList.remove('active');
      isPrivateChatMode = false;
      activeChatId = null;
      oldestMessageKey = null;
      isLoadingMore = false;
      els.messagesContainer.innerHTML = '';
      if (activeChatId) stopTypingIndicator();
      els.messagesContainer.removeEventListener('scroll', handleScroll);
    }

    function switchTab(tabName) {
      document.querySelectorAll('.pill-tab').forEach((tab) => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) tab.classList.add('active');
      });
      if (tabName === 'chats') {
        els.swipeContainer.classList.remove('status-active');
        loadFriendsChatsRealTime();
      } else {
        els.swipeContainer.classList.add('status-active');
        loadStatusPostsRealTime();
      }
    }
    document.querySelectorAll('.pill-tab').forEach((tab) => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
    els.addFriendFab.addEventListener('click', openUsersSheet);

    els.floatingBackBtn.addEventListener('click', (e) => {
      if (window.matchMedia('(min-width: 768px)').matches) {
        closeChatView();
      }
    });

    window.addEventListener('popstate', (e) => {
      if (isPrivateChatMode && !window.matchMedia('(min-width: 768px)').matches) {
        e.preventDefault();
        closeChatView();
        history.pushState({}, '', window.location.pathname);
      }
    });

    let touchStartX = 0;
    let touchEndX = 0;
    const swipeThreshold = 50;

    if (els.mainContent && window.matchMedia('(max-width: 767px)').matches) {
      els.mainContent.addEventListener('touchstart', (e) => {
        if (isPrivateChatMode) return;
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      els.mainContent.addEventListener('touchend', (e) => {
        if (isPrivateChatMode) return;
        touchEndX = e.changedTouches[0].screenX;
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > swipeThreshold) {
          if (deltaX > 0) {
            switchTab('chats');
          } else {
            switchTab('status');
          }
        }
      }, { passive: true });
    }

    function startTypingIndicator() {
      if (!activeChatId || !currentUser) return;
      const typingRef = ref(db, `privateChats/${activeChatId}/typing/${currentUser.uid}`);
      set(typingRef, serverTimestamp());
    }

    function stopTypingIndicator() {
      if (!activeChatId || !currentUser) return;
      const typingRef = ref(db, `privateChats/${activeChatId}/typing/${currentUser.uid}`);
      set(typingRef, null);
    }

    async function openPrivateChat(chatId) {
      els.mainHeader.classList.add('hidden');
      els.tabbar.classList.add('hidden');
      els.addFriendFab.classList.add('hidden');
      els.chatView.classList.add('active');
      isPrivateChatMode = true;
      activeChatId = chatId;
      oldestMessageKey = null;
      isLoadingMore = false;
      els.messagesContainer.innerHTML = '';

      if (!window.matchMedia('(min-width: 768px)').matches) {
        history.pushState({ chatOpen: true }, '', '#chat');
      }

      loadMoreMessages();

      const newMessagesQuery = query(ref(db, `privateChats/${chatId}/messages`), orderByChild('createdAt'), limitToLast(1));
      onValue(newMessagesQuery, (snap) => {
        if (snap.size > 0) {
          let hasNew = false;
          snap.forEach((child) => {
            if (!document.getElementById(child.key)) {
              hasNew = true;
              appendWhatsAppMessage(child.val(), child.key);
            }
          });
          if (hasNew) scrollToBottom();
        }
      });

      const typingRef = ref(db, `privateChats/${chatId}/typing`);
      onValue(typingRef, (snap) => {
        const previewEl = document.getElementById(`preview-${chatId}`);
        if (!previewEl) return;
        const typingUsers = [];
        snap.forEach((child) => {
          if (child.key !== currentUser.uid) {
            typingUsers.push(child.key);
          }
        });
        if (typingUsers.length > 0) {
          previewEl.textContent = 'typing...';
          previewEl.classList.add('typing-indicator');
        } else {
          previewEl.classList.remove('typing-indicator');
        }
      });

      const handleScroll = () => {
        if (els.messagesContainer.scrollTop < 100 && !isLoadingMore && oldestMessageKey) {
          loadMoreMessages();
        }
      };
      els.messagesContainer.addEventListener('scroll', handleScroll);

      els.messageInput.addEventListener('input', handleTypingInput);
    }

    function handleTypingInput() {
      startTypingIndicator();
      if (typingTimeouts.has(activeChatId)) {
        clearTimeout(typingTimeouts.get(activeChatId));
      }
      const timeout = setTimeout(stopTypingIndicator, 2000);
      typingTimeouts.set(activeChatId, timeout);
    }

    els.sendButton.addEventListener('click', () => {
      sendMessage();
      stopTypingIndicator();
    });

    async function sendMessage() {
      const text = els.messageInput.value.trim();
      if (!text || !currentUser || !activeChatId) return;
      els.messageInput.value = '';
      els.messageInput.style.height = 'auto';
      const messagesRef = ref(db, `privateChats/${activeChatId}/messages`);
      await push(messagesRef, {
        text: text,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anon',
        createdAt: Date.now(),
      });
      scrollToBottom();
      stopTypingIndicator();
    }

    async function loadFriendsChatsRealTime() {
      if (!currentUser) return;
      const userRef = ref(db, `users/${currentUser.uid}`);
      onValue(userRef, async (snapshot) => {
        if (!snapshot.exists()) return;
        els.chatsList.innerHTML = '';
        const data = snapshot.val();
        const friends = [...new Set(data.friends || [])];
        if (friends.length === 0) {
          els.chatsList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--gray-mid);"><span class="material-symbols-rounded" style="font-size:48px;">group_add</span><p>No friends yet</p><p style="font-size:14px;margin-top:8px;">Tap the + button to add friends</p></div>`;
          return;
        }
        for (const friendUid of friends) {
          const friendSnap = await get(ref(db, `users/${friendUid}`));
          if (!friendSnap.exists()) continue;
          const friend = friendSnap.val();
          const chatId = [currentUser.uid, friendUid].sort().join('_');
          if (document.getElementById(`friend-card-${friendUid}`)) continue;
          const item = document.createElement('div');
          item.className = 'chat-item-whatsapp';
          item.id = `friend-card-${friendUid}`;
          const verifiedBadge = friend.verified ? '<span class="verified-badge">✓</span>' : '';
          item.innerHTML = `
            <div class="whatsapp-avatar ${friend.online ? 'online' : ''}">${friend.displayName.charAt(0).toUpperCase()}</div>
            <div class="chat-info-whatsapp">
              <div class="chat-header-row">
                <div class="chat-name-wrapper">
                  <div class="chat-name-whatsapp">${friend.displayName}</div>
                  ${verifiedBadge}
                </div>
                <div class="chat-time-whatsapp" id="time-${chatId}"></div>
              </div>
              <div class="chat-preview-whatsapp" id="preview-${chatId}">Tap to start chatting</div>
            </div>
          `;
          item.addEventListener('click', () => openPrivateChat(chatId));
          els.chatsList.appendChild(item);

          if (chatListeners.has(chatId)) chatListeners.get(chatId)();
          const messagesRef = ref(db, `privateChats/${chatId}/messages`);
          const messagesQuery = query(messagesRef, orderByChild('createdAt'), limitToLast(1));
          const unsubscribeMsg = onValue(messagesQuery, (snap) => {
            const previewEl = document.getElementById(`preview-${chatId}`);
            const timeEl = document.getElementById(`time-${chatId}`);
            if (!previewEl || !timeEl) return;
            if (snap.size === 0) {
              previewEl.textContent = 'Tap to start chatting';
              previewEl.classList.remove('typing-indicator');
              timeEl.textContent = '';
              return;
            }
            let lastMsg;
            snap.forEach((child) => lastMsg = child.val());
            const isOwn = lastMsg.userId === currentUser.uid;
            const shortText = lastMsg.text.length > 30 ? lastMsg.text.slice(0, 27) + '...' : lastMsg.text;
            previewEl.textContent = isOwn ? `You: ${shortText}` : shortText;
            previewEl.classList.remove('typing-indicator');
            const time = new Date(lastMsg.createdAt);
            const now = new Date();
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            let timeStr = diffMins < 1 ? 'now' : diffMins < 60 ? `${diffMins}m` : diffHours < 24 ? `${diffHours}h` : diffDays < 7 ? `${diffDays}d` : time.toLocaleDateString();
            timeEl.textContent = timeStr;
          });

          const onlineRef = ref(db, `users/${friendUid}/online`);
          onValue(onlineRef, (snap) => {
            const avatar = item.querySelector('.whatsapp-avatar');
            if (snap.val() === true) {
              avatar.classList.add('online');
            } else {
              avatar.classList.remove('online');
            }
          });

          chatListeners.set(chatId, unsubscribeMsg);
        }
      });
    }

    function loadStatusPostsRealTime() {
      const statusRef = ref(db, 'statusPosts');
      const statusQuery = query(statusRef, orderByChild('createdAt'), limitToLast(20));
      onValue(statusQuery, (snapshot) => {
        els.statusCards.innerHTML = '';
        if (snapshot.size === 0) {
          els.statusCards.innerHTML = `<div style="text-align:center;padding:40px;color:var(--gray-mid);"><span class="material-symbols-rounded" style="font-size:48px;">post_add</span><p>No status updates yet</p><p style="font-size:14px;margin-top:8px;">Be the first to share your thoughts!</p></div>`;
          return;
        }
        const posts = [];
        snapshot.forEach((child) => posts.push({ id: child.key, ...child.val() }));
        posts.forEach((post) => {
          const card = document.createElement('div');
          card.className = 'status-card';
          const timeAgo = (() => {
            const diffMs = Date.now() - post.createdAt;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            return diffMins < 1 ? 'just now' : diffMins < 60 ? `${diffMins}m ago` : diffHours < 24 ? `${diffHours}h ago` : diffDays < 7 ? `${diffDays}d ago` : new Date(post.createdAt).toLocaleDateString();
          })();
          const likeCount = post.likes?.length || 0;
          card.innerHTML = `
            <div class="status-card-header">
              <div class="status-avatar">${post.userName.charAt(0).toUpperCase()}</div>
              <div class="status-meta">
                <div class="status-author">${post.userName}</div>
                <div class="status-time">${timeAgo}</div>
              </div>
            </div>
            <div class="status-content">${escapeHtml(post.content)}</div>
            <div class="status-actions">
              <div class="status-action" onclick="likeStatus('${post.id}')">
                <span class="material-symbols-rounded" style="font-size:18px;">favorite</span>
                <span class="like-count">${likeCount}</span>
              </div>
              <div class="status-action" onclick="commentStatus('${post.id}')">
                <span class="material-symbols-rounded" style="font-size:18px;">comment</span>
                <span>Comment</span>
              </div>
              <div class="status-action" onclick="shareStatus('${post.id}')">
                <span class="material-symbols-rounded" style="font-size:18px;">share</span>
                <span>Share</span>
              </div>
            </div>
          `;
          els.statusCards.appendChild(card);
        });
      });
    }
    window.likeStatus = async (statusId) => {
      const statusRef = ref(db, `statusPosts/${statusId}`);
      const statusSnap = await get(statusRef);
      const likes = statusSnap.val()?.likes || [];
      if (!likes.includes(currentUser.uid)) {
        likes.push(currentUser.uid);
        await update(statusRef, { likes });
        showToast('Status liked!');
      }
    };
    window.commentStatus = () => showToast('Comment feature coming soon!');
    window.shareStatus = () => showToast('Share feature coming soon!');

    async function loadMoreMessages() {
      if (isLoadingMore) return;
      isLoadingMore = true;
      let messagesQuery;
      if (oldestMessageKey) {
        messagesQuery = query(
          ref(db, `privateChats/${activeChatId}/messages`),
          orderByChild('createdAt'),
          endBefore(oldestMessageKey),
          limitToLast(MESSAGES_PER_LOAD)
        );
      } else {
        messagesQuery = query(
          ref(db, `privateChats/${activeChatId}/messages`),
          orderByChild('createdAt'),
          limitToLast(MESSAGES_PER_LOAD)
        );
      }
      const snapshot = await get(messagesQuery);
      if (snapshot.size === 0) {
        isLoadingMore = false;
        return;
      }
      const messages = [];
      snapshot.forEach((child) => {
        messages.unshift({ key: child.key, data: child.val() });
        oldestMessageKey = child.val().createdAt;
      });
      const fragment = document.createDocumentFragment();
      messages.forEach(({ key, data }) => {
        const bubble = createMessageBubble(data, key);
        fragment.appendChild(bubble);
      });
      const scrollHeightBefore = els.messagesContainer.scrollHeight;
      els.messagesContainer.prepend(fragment);
      const scrollHeightAfter = els.messagesContainer.scrollHeight;
      els.messagesContainer.scrollTop = scrollHeightAfter - scrollHeightBefore;
      isLoadingMore = false;
    }
    function createMessageBubble(data, key) {
      const isOwn = data.userId === currentUser.uid;
      const time = new Date(data.createdAt);
      const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const bubble = document.createElement('div');
      bubble.className = `whatsapp-bubble ${isOwn ? 'own' : 'other'}`;
      bubble.id = key;
      bubble.innerHTML = `${escapeHtml(data.text)}<div class="bubble-time">${timeStr}</div>`;
      return bubble;
    }
    function appendWhatsAppMessage(data, key) {
      const bubble = createMessageBubble(data, key);
      els.messagesContainer.appendChild(bubble);
    }

    els.messageInput.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    els.messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function scrollToBottom() {
      els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight;
    }
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast-notification show';
      toast.innerHTML = `<span>${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    els.addStatusBtn.addEventListener('click', () => els.statusComposer.classList.toggle('open'));
    els.statusPostBtn.addEventListener('click', async () => {
      const content = els.statusInput.value.trim();
      if (!content || !currentUser) return;
      await push(ref(db, 'statusPosts'), {
        content,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anonymous',
        createdAt: Date.now(),
        likes: [],
        comments: [],
      });
      els.statusInput.value = '';
      els.statusComposer.classList.remove('open');
      showToast('Status posted!');
    });
    async function openUsersSheet() {
      const sheet = document.createElement('div');
      sheet.className = 'users-sheet open';
      sheet.innerHTML = `
        <div class="users-box">
          <div class="users-header">
            <h2 class="users-title">Add Friends</h2>
            <button class="close-sheet-btn" onclick="this.closest('.users-sheet').remove()">
              <span class="material-symbols-rounded">close</span>
            </button>
          </div>
          <div class="users-list">
            <div style="text-align:center;padding:40px;">
              <span class="material-symbols-rounded" style="font-size:48px;color:var(--gray-mid);">hourglass_empty</span>
              <p>Loading users...</p>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(sheet);
      const mySnap = await get(ref(db, `users/${currentUser.uid}`));
      const myFriends = mySnap.val()?.friends || [];
      const usersSnap = await get(ref(db, 'users'));
      const usersList = sheet.querySelector('.users-list');
      usersList.innerHTML = '';
      usersSnap.forEach((child) => {
        if (child.key === currentUser.uid) return;
        const user = child.val();
        const isFriend = myFriends.includes(child.key);
        const verifiedBadge = user.verified ? '<span class="verified-badge">✓</span>' : '';
        const item = document.createElement('div');
        item.className = 'user-item-whatsapp';
        item.innerHTML = `
          <div class="user-avatar-whatsapp ${user.online ? 'online' : ''}">${user.displayName?.charAt(0).toUpperCase() || '?'}</div>
          <div class="user-info-whatsapp">
            <div class="user-name-wrapper">
              <div class="user-name-whatsapp">${user.displayName || 'Anonymous'}</div>
              ${verifiedBadge}
            </div>
            <div class="user-email-whatsapp">${user.email || 'No email'}</div>
          </div>
          <button class="add-friend-btn ${isFriend ? 'added' : ''}" ${isFriend ? 'disabled' : ''}>
            ${isFriend ? 'Added' : 'Add Friend'}
          </button>
        `;
        if (!isFriend) {
          item.querySelector('.add-friend-btn').addEventListener('click', async (e) => await addFriend(child.key, e.target));
        }
        usersList.appendChild(item);
      });
      if (usersList.children.length === 0) {
        usersList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--gray-mid);"><span class="material-symbols-rounded" style="font-size:48px;">group</span><p>No other users found</p><p style="font-size:14px;margin-top:8px;">Invite friends to join!</p></div>`;
      }
    }
    async function addFriend(friendUid, btn) {
      if (friendUid === currentUser.uid) return;
      const myRef = ref(db, `users/${currentUser.uid}/friends`);
      const frRef = ref(db, `users/${friendUid}/friends`);
      const myFriends = (await get(myRef)).val() || [];
      if (!myFriends.includes(friendUid)) await set(myRef, [...myFriends, friendUid]);
      const frFriends = (await get(frRef)).val() || [];
      if (!frFriends.includes(currentUser.uid)) await set(frRef, [...frFriends, currentUser.uid]);
      btn.textContent = 'Added';
      btn.classList.add('added');
      btn.disabled = true;
      showToast('Friend added successfully!');
    }
    let isSignUp = false;
    document.getElementById('authSwitchBtn').addEventListener('click', () => {
      isSignUp = !isSignUp;
      document.getElementById('authBtn').textContent = isSignUp ? 'Sign Up' : 'Sign In';
      document.getElementById('authSwitchBtn').textContent = isSignUp ? 'Sign In' : 'Sign Up';
      document.querySelector('.auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome to Vynix Lingua';
    });
    document.getElementById('authBtn').addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if (!email || !pass) return showToast('Please fill in all fields');
      try {
        let cred;
        if (isSignUp) {
          cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: email.split('@')[0] });
        } else {
          cred = await signInWithEmailAndPassword(auth, email, pass);
        }
        await set(ref(db, `users/${cred.user.uid}`), {
          displayName: cred.user.displayName || email.split('@')[0],
          email: email,
          lastSeen: Date.now(),
          online: true,
          verified: false,
          friends: [],
        });
        document.getElementById('authOverlay').classList.remove('open');
        showToast(isSignUp ? 'Account created successfully!' : 'Welcome back!');
      } catch (e) {
        showToast(e.message || 'Authentication failed');
      }
    });
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        document.getElementById('authOverlay').classList.add('open');
      } else {
        await update(ref(db, `users/${user.uid}`), { online: true });
        const onlineRef = ref(db, `users/${user.uid}/online`);
        onDisconnect(onlineRef).set(false);
        switchTab('chats');
        startHeartbeat();
      }
    });
    function startHeartbeat() {
      const update = async () => {
        if (currentUser) await update(ref(db, `users/${currentUser.uid}`), { lastSeen: Date.now() });
      };
      update();
      setInterval(update, 60000);
    }
    switchTab('chats');
  </script>
</body>
</html>
