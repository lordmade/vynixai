<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix â€“ Social Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNkOTQ2ZWYiLCJ0aGVtZV9jb2xvciI6IiNkOTQ2ZWYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#d946ef">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ---------- ROOT TOKENS ---------- */
    :root{
      --bg:#f0f2f5;
      --card:#ffffff;
      --text:#1c1e21;
      --text2:#65676b;
      --border:#ced0d4;
      --accent:#d946ef;
      --accent-blue:#1877f2;
      --accent-green:#42b72a;
      --hover-accent:#f0f2f5;
      --card-shadow:0 4px 12px rgba(0,0,0,0.1);
      --radius:20px;
      --avatar:40px;
      --trans:.3s ease;
    }
    [data-theme="dark"]{
      --bg:#18191a;
      --card:#242526;
      --text:#e4e6eb;
      --text2:#b0b3b8;
      --border:#3e4042;
      --card-shadow:0 4px 12px rgba(0,0,0,0.3);
      --hover-accent:#3a3b3c;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding-bottom:80px;
    }
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    input,textarea{-webkit-user-select:auto;user-select:auto}
    /* ---------- GENERAL SHEET STYLES ---------- */
    .sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:90;opacity:0;pointer-events:none;transition:opacity var(--trans)}
    .sheet-overlay.show{opacity:1;pointer-events:auto}
    .sheet{position:absolute;bottom:0;left:0;right:0;background:var(--card);border-top-left-radius:28px;border-top-right-radius:28px;max-height:95vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .4s cubic-bezier(0.22,1,0.36,1);box-shadow:0 -12px 40px rgba(0,0,0,.2)}
    .sheet-overlay.show .sheet{transform:translateY(0)}
    .sheet-header{position:relative;padding:20px 24px 16px;text-align:center;font-size:22px;font-weight:700;border-bottom:1px solid var(--border)}
    .sheet-close{background:none;border:none;color:var(--text2);font-size:28px;cursor:pointer;position:absolute;left:16px;top:16px}
    .sheet-body{flex:1;overflow-y:auto;padding:24px}
    .pill-btn{display:block;width:100%;padding:16px;background:var(--accent-blue);color:#fff;border:none;border-radius:9999px;font-weight:600;font-size:17px;cursor:pointer;margin-bottom:16px;transition:var(--trans);box-shadow:0 4px 12px rgba(24,119,242,.3)}
    .pill-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(24,119,242,.4)}
    .pill-btn:disabled{opacity:.6}
    .pill-btn.secondary{background:var(--text2);color:var(--card)}
    .pill-btn.danger{background:#f4212e}
    /* ---------- AUTH SHEET (Modern) ---------- */
    .auth-tab{display:flex;margin-bottom:32px;background:var(--bg);border-radius:9999px;padding:4px}
    .auth-tab-btn{flex:1;padding:12px;font-weight:600;color:var(--text2);border-radius:9999px;transition:var(--trans)}
    .auth-tab-btn.active{background:var(--accent-blue);color:#fff}
    .auth-input{width:100%;padding:16px 20px;margin-bottom:20px;border:1px solid var(--border);border-radius:20px;background:var(--bg);color:var(--text);font-size:17px}
    .auth-btn{margin-top:24px}
    /* ---------- PROFILE SHEET (Modern) ---------- */
    .profile-sheet-header{position:relative;padding:32px 32px 80px;text-align:center}
    .profile-sheet-header-bg{position:absolute;inset:0;background:linear-gradient(135deg,var(--accent-blue),#a855f7);border-top-left-radius:28px;border-top-right-radius:28px;overflow:hidden}
    .profile-sheet-header-bg::after{content:'';position:absolute;inset:0;background:rgba(0,0,0,.2)}
    .profile-avatar-big{width:160px;height:160px;border-radius:50%;border:8px solid var(--card);object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.3);position:relative;z-index:10}
    .profile-sheet-body{padding:16px 32px 32px}
    .profile-name-display{font-size:32px;font-weight:700;margin-bottom:8px}
    .profile-handle{font-size:18px;color:var(--text2);margin-bottom:32px}
    #profile-edit-name{width:100%;padding:16px 20px;margin:24px 0;border:1px solid var(--border);border-radius:20px;background:var(--bg);color:var(--text);font-size:20px;text-align:center;font-weight:600}
    .profile-photo-preview{margin:24px 0}
    .profile-photo-preview img{width:140px;height:140px;border-radius:50%;object-fit:cover;border:5px solid var(--border);box-shadow:0 4px 16px rgba(0,0,0,.2)}
    /* ---------- SIGNUP FLOATING CARD ---------- */
    #signup-floating-card{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--card);border-radius:20px;padding:24px;max-width:340px;width:90%;box-shadow:0 12px 40px rgba(0,0,0,.25);z-index:80;text-align:center;opacity:0;pointer-events:none;transition:opacity .3s,var(--trans)}
    #signup-floating-card.show{opacity:1;pointer-events:auto}
    #signup-floating-card h3{font-size:20px;font-weight:700;margin-bottom:12px}
    #signup-floating-card p{font-size:15px;color:var(--text2);margin-bottom:24px}
    /* ---------- COMPOSER & POSTS ---------- */
    .composer{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      margin:16px auto;
      max-width:680px;
      padding:16px;
    }
    .composer .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover}
    textarea{flex:1;resize:none;background:var(--bg);color:var(--text);border:none;outline:none;font-size:17px;padding:12px;border-radius:20px;background:var(--bg);min-height:40px;width:100%}
    textarea::placeholder{color:var(--text2)}
    .media-preview{width:100%;border-radius:var(--radius);margin-top:12px;border:1px solid var(--border)}
    .composer-actions{display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
    .icon-btn{background:none;border:none;color:var(--text2);cursor:pointer;padding:8px;border-radius:8px;transition:var(--trans);display:flex;align-items:center;gap:8px;font-size:15px;font-weight:500}
    .icon-btn:hover{background:var(--hover-accent);color:var(--text)}
    .post-btn{background:var(--accent-blue);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:600;font-size:15px;cursor:pointer;transition:opacity var(--trans)}
    .post-btn:disabled{opacity:.5;cursor:default}
    .post-btn:hover:not(:disabled){background:#166fe5}
    .spinner{border:3px solid rgba(255,255,255,.3);border-top:3px solid #fff;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .post-card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      margin:0 auto 16px;
      max-width:680px;
      transition:var(--trans);
      position:relative;
    }
    .post-card:hover{box-shadow:0 8px 24px rgba(0,0,0,0.15)}
    .post-header{display:flex;align-items:center;gap:12px;padding:16px 16px 12px}
    .post-avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex-shrink:0;cursor:pointer}
    .user-info{flex:1}
    .user-name{font-size:15px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:4px}
    .user-handle{font-size:13px;color:var(--text2)}
    .post-time{font-size:13px;color:var(--text2)}
    .verified-badge{color:var(--accent-blue);font-size:16px!important}
    .post-content{padding:0 16px 12px;font-size:15px;line-height:1.5;color:var(--text);white-space:pre-wrap}
    .post-image,.post-video{width:100%;max-height:500px;object-fit:cover;margin:0;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    .post-video{max-height:400px}
    .post-actions{display:flex;align-items:center;justify-content:space-around;padding:8px 16px;border-top:1px solid var(--border)}
    .action-item{display:flex;align-items:center;gap:6px;font-size:15px;color:var(--text2);cursor:pointer;padding:8px;border-radius:6px;transition:var(--trans);font-weight:500}
    .action-item:hover{background:var(--hover-accent)}
    .action-item svg{width:20px;height:20px;stroke-width:1.8}
    .action-item.liked{color:var(--accent-blue)}
    .action-item.liked svg{fill:var(--accent-blue)}
    .action-item.disabled{opacity:0.5;cursor:not-allowed;pointer-events:none}
    nav{position:fixed;bottom:0;left:0;right:0;height:64px;background:var(--card);border-top:1px solid var(--border);z-index:40;transition:transform var(--trans);display:flex;align-items:center;justify-content:center}
    nav.hidden{transform:translateY(100%)}
    .pill-tabs{display:flex;background:var(--bg);border-radius:9999px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,0.1);gap:4px}
    .pill-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 16px;border-radius:9999px;transition:var(--trans);min-width:120px;font-size:14px;font-weight:500;color:var(--text2)}
    .pill-tab.active{background:var(--accent-blue);color:#fff}
    .pill-tab .material-icons{font-size:24px;margin-bottom:4px}
    .fab{position:fixed;bottom:72px;right:20px;width:48px;height:48px;background:var(--accent-blue);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(24,119,242,.4);cursor:pointer;transition:var(--trans);z-index:30}
    .fab:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(24,119,242,.6)}
    .fab.hidden{transform:scale(0)}
    .composer-top-row{display:flex;align-items:flex-start;gap:12px}
    .composer-input-col{flex:1}
  </style>
</head>
<body>
  <!-- Signup Floating Card (only visible when anonymous) -->
  <div id="signup-floating-card">
    <h3>Join Vynix Today</h3>
    <p>Create an account to post, like, comment and connect with friends.</p>
    <button class="pill-btn" id="open-auth-btn">Sign Up Now</button>
  </div>

  <!-- ---------- COMPOSER ---------- -->
  <div class="composer">
    <div class="composer-top-row">
      <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=1877f2&color=fff" alt="avatar"/>
      <div class="composer-input-col">
        <textarea id="post-text" placeholder="What's on your mind?"></textarea>
        <video id="media-preview-video" class="media-preview hidden" controls muted loop playsinline></video>
        <img id="media-preview-img" class="media-preview hidden" alt=""/>
      </div>
    </div>
    <div class="composer-actions">
      <div>
        <input type="file" id="file-input" accept="image/*,video/*" class="hidden"/>
        <label for="file-input" class="icon-btn" title="Add Photo/Video">
          <span class="material-icons-outlined">photo_library</span>
          <span>Photo/Video</span>
        </label>
      </div>
      <button id="post-btn" class="post-btn" disabled>
        <span id="btn-text">Post</span>
        <span id="btn-spinner" class="spinner hidden"></span>
      </button>
    </div>
  </div>

  <main id="feed" class="feed"></main>

  <div class="text-center p-4">
    <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
  </div>

  <!-- Floating Action Button -->
  <div id="fab" class="fab hidden">
    <span class="material-icons">add</span>
  </div>

  <!-- Alert Modal -->
  <div id="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
      <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
      <div class="custom-alert-buttons">
        <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
        <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
      </div>
    </div>
  </div>

  <!-- Comment Sheet -->
  <div id="comment-sheet-overlay" class="sheet-overlay">
    <div class="sheet comment-sheet">
      <div class="sheet-header">
        <button class="sheet-close" id="comment-sheet-close">
          <span class="material-icons-outlined">close</span>
        </button>
        <div>Comments</div>
      </div>
      <div class="sheet-body" id="comment-sheet-list"></div>
      <div class="comment-input-box">
        <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
        <button class="comment-send-btn" id="comment-send-btn">
          <span class="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Image/Video Modal -->
  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <video id="modal-video" loop>
      <source src="" type="video/mp4">
    </video>
    <div class="video-controls" id="video-controls" style="display: none;">
      <button id="play-pause-btn">
        <span class="material-icons-outlined">play_arrow</span>
      </button>
      <span class="video-time" id="video-time">0:00 / 0:00</span>
      <div class="video-progress" id="video-progress">
        <div class="video-progress-bar" id="video-progress-bar"></div>
      </div>
      <button id="mute-btn">
        <span class="material-icons-outlined">volume_up</span>
      </button>
    </div>
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>

  <!-- Mention autocomplete -->
  <div id="mention-dropdown" class="mention-dd hidden"></div>

  <!-- Navigation -->
  <nav id="navbar">
    <div class="pill-tabs">
      <a href="index.html" class="pill-tab" id="tab-feed">
        <span class="material-icons-outlined">home</span>
        <span>Feed</span>
      </a>
      <a href="chat.html" class="pill-tab" id="tab-chat">
        <span class="material-icons-outlined">chat_bubble_outline</span>
        <span>Chats</span>
      </a>
    </div>
  </nav>

  <!-- Auth Bottom Sheet (Modern Design) -->
  <div id="auth-sheet-overlay" class="sheet-overlay">
    <div class="sheet">
      <div class="sheet-header">
        <button class="sheet-close" id="auth-sheet-close">
          <span class="material-icons-outlined">close</span>
        </button>
        <div>Join Vynix</div>
      </div>
      <div class="sheet-body">
        <div class="auth-tab">
          <button class="auth-tab-btn active" data-tab="signup">Sign Up</button>
          <button class="auth-tab-btn" data-tab="signin">Sign In</button>
        </div>
        <form id="signup-form" class="auth-form active">
          <input type="email" class="auth-input" id="signup-email" placeholder="Email address" required>
          <input type="password" class="auth-input" id="signup-password" placeholder="Password (6+ characters)" required>
          <input type="text" class="auth-input" id="signup-name" placeholder="Display name" required>
          <button type="submit" class="pill-btn auth-btn" id="signup-btn">Create Account</button>
        </form>
        <form id="signin-form" class="auth-form">
          <input type="email" class="auth-input" id="signin-email" placeholder="Email address" required>
          <input type="password" class="auth-input" id="signin-password" placeholder="Password" required>
          <button type="submit" class="pill-btn auth-btn" id="signin-btn">Sign In</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Profile Bottom Sheet (Modern Design) -->
  <div id="profile-sheet-overlay" class="sheet-overlay">
    <div class="sheet profile-sheet">
      <div class="profile-sheet-header">
        <div class="profile-sheet-header-bg"></div>
        <button class="sheet-close" id="profile-sheet-close">
          <span class="material-icons-outlined">close</span>
        </button>
        <img id="profile-avatar-big" class="profile-avatar-big" src="">
      </div>
      <div class="profile-sheet-body">
        <div id="profile-view-section" class="profile-edit-section active">
          <div class="profile-name-display" id="profile-name"></div>
          <div class="profile-handle" id="profile-handle"></div>
        </div>
        <div id="profile-edit-section" class="profile-edit-section">
          <input type="text" id="profile-edit-name" placeholder="Display Name">
          <div class="profile-photo-preview">
            <img id="profile-photo-preview-img" src="">
          </div>
          <label class="pill-btn">
            <span>Change Photo</span>
            <input type="file" id="profile-photo-input" accept="image/*" class="hidden">
          </label>
          <button class="pill-btn secondary remove-photo-btn hidden" id="remove-photo-btn">Remove Photo</button>
          <button class="pill-btn" id="profile-save-btn">Save Changes</button>
          <button class="pill-btn danger" id="profile-logout-btn">Log Out</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword, EmailAuthProvider, linkWithCredential, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
let uid = null, uname = 'Guest', uavatar = '';
let isAnonymous = true;
const CLOUD_NAME = "dqkujefxj";
const UPLOAD_PRESET = "banter_box";
const $ = s => document.querySelector(s);
const postBtn = $('#post-btn'), textEl = $('#post-text'),
      previewImg = $('#media-preview-img'), previewVid = $('#media-preview-video'),
      fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
      loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 10;
let lastTimestamp = null, lastKey = null, initialLoadDone = false;
if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.body.setAttribute('data-theme', 'dark');

// Control floating card visibility
onAuthStateChanged(auth, user => {
  if (user) {
    uid = user.uid;
    uname = user.displayName || 'User';
    uavatar = user.photoURL || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(uname)}`;
    myAvatarEl.src = uavatar;
    isAnonymous = user.isAnonymous;
    document.querySelectorAll(`.post-avatar[data-uid="${uid}"]`).forEach(img => img.src = uavatar);
    document.getElementById('signup-floating-card').classList.remove('show');
    initFeed();
  } else {
    signInAnonymously(auth);
    document.getElementById('signup-floating-card').classList.add('show');
  }
});

// Open auth sheet from floating card
$('#open-auth-btn').onclick = () => openAuthSheet('signup');

function setupAnonymousUser() {
  uid = auth.currentUser?.uid || "anonymous_" + Math.random().toString(36).slice(2);
  uname = "Guest";
  uavatar = `https://ui-avatars.com/api/?background=1877f2&color=fff&name=Guest`;
  myAvatarEl.src = uavatar;
  isAnonymous = true;
  initFeed();
}

// Auth sheet elements
const authOverlay = $('#auth-sheet-overlay');
const authClose = $('#auth-sheet-close');
function openAuthSheet(mode = 'signup') {
  document.querySelectorAll('.auth-tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === mode);
  });
  document.querySelectorAll('.auth-form').forEach(f => {
    f.classList.toggle('active', f.id === mode + '-form');
  });
  authOverlay.classList.add('show');
}
function closeAuthSheet() {
  authOverlay.classList.remove('show');
}
authClose.onclick = closeAuthSheet;
authOverlay.onclick = e => { if (e.target === authOverlay) closeAuthSheet(); };
document.querySelectorAll('.auth-tab-btn').forEach(btn => {
  btn.onclick = () => openAuthSheet(btn.dataset.tab);
});

// Sign up handler (upgrade anonymous)
$('#signup-form').onsubmit = async e => {
  e.preventDefault();
  const email = $('#signup-email').value.trim();
  const password = $('#signup-password').value;
  const name = $('#signup-name').value.trim() || 'User';
  if (!email || !password || password.length < 6) {
    toast('Please fill valid email and password (min 6 chars)');
    return;
  }
  const btn = $('#signup-btn');
  btn.disabled = true;
  btn.textContent = 'Creating...';
  try {
    const credential = EmailAuthProvider.credential(email, password);
    const userCred = await auth.currentUser.linkWithCredential(credential);
    await updateProfile(userCred.user, {
      displayName: name,
      photoURL: `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(name)}`
    });
    await set(ref(db, `users/${uid}/profile`), {
      displayName: name,
      avatar: userCred.user.photoURL
    });
    toast('Account created and upgraded!');
    closeAuthSheet();
  } catch (err) {
    if (err.code === 'auth/email-already-in-use') {
      toast('Email already in use. Try signing in.');
    } else {
      toast('Error: ' + err.message);
    }
  } finally {
    btn.disabled = false;
    btn.textContent = 'Create Account';
  }
};

// Sign in handler
$('#signin-form').onsubmit = async e => {
  e.preventDefault();
  const email = $('#signin-email').value.trim();
  const password = $('#signin-password').value;
  if (!email || !password) return;
  const btn = $('#signin-btn');
  btn.disabled = true;
  btn.textContent = 'Signing in...';
  try {
    await signInWithEmailAndPassword(auth, email, password);
    toast('Signed in!');
    closeAuthSheet();
  } catch (err) {
    toast('Error: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sign In';
  }
};

// Function to require auth
function requireAuth() {
  if (isAnonymous) {
    openAuthSheet('signup');
    return true;
  }
  return false;
}

// Profile sheet elements
const profileOverlay = $('#profile-sheet-overlay');
const profileClose = $('#profile-sheet-close');
const profileAvatarBig = $('#profile-avatar-big');
const profilePhotoPreviewImg = $('#profile-photo-preview-img');
const profileNameEl = $('#profile-name');
const profileHandleEl = $('#profile-handle');
const profileViewSection = $('#profile-view-section');
const profileEditSection = $('#profile-edit-section');
const profileEditName = $('#profile-edit-name');
const profilePhotoInput = $('#profile-photo-input');
const removePhotoBtn = $('#remove-photo-btn');
const profileSaveBtn = $('#profile-save-btn');
const profileLogoutBtn = $('#profile-logout-btn');
let currentProfileUid = null;
let pendingAvatarUrl = null;
let pendingName = null;
function openProfileSheet(profileUid) {
  currentProfileUid = profileUid;
  const isOwn = profileUid === uid;
  profileViewSection.classList.toggle('active', !isOwn);
  profileEditSection.classList.toggle('active', isOwn);
  profileLogoutBtn.classList.toggle('hidden', isAnonymous);
  pendingAvatarUrl = null;
  pendingName = null;
  removePhotoBtn.classList.add('hidden');
  onValue(ref(db, `users/${profileUid}/profile`), snap => {
    const p = snap.val() || {};
    const name = p.displayName || uname;
    const avatar = p.avatar || uavatar;
    profileAvatarBig.src = avatar;
    profilePhotoPreviewImg.src = avatar;
    profileNameEl.textContent = name;
    profileHandleEl.textContent = `@${name.replace(/\s/g, '').toLowerCase()}`;
    if (isOwn) {
      profileEditName.value = name;
    }
  }, { onlyOnce: true });
  profileOverlay.classList.add('show');
}
function closeProfileSheet() {
  profileOverlay.classList.remove('show');
  currentProfileUid = null;
  pendingAvatarUrl = null;
  pendingName = null;
}
profileClose.onclick = closeProfileSheet;
profileOverlay.onclick = e => { if (e.target === profileOverlay) closeProfileSheet(); };

// Profile photo change
profilePhotoInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => {
    profilePhotoPreviewImg.src = ev.target.result;
    removePhotoBtn.classList.remove('hidden');
  };
  r.readAsDataURL(file);
  uploadProfilePhoto(file);
};
function uploadProfilePhoto(file) {
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(async res => {
      const newUrl = res.secure_url;
      pendingAvatarUrl = newUrl;
      myAvatarEl.src = newUrl;
      profileAvatarBig.src = newUrl;
      profilePhotoPreviewImg.src = newUrl;
      document.querySelectorAll(`.post-avatar[data-uid="${uid}"]`).forEach(img => img.src = newUrl);
      await updateProfile(auth.currentUser, { photoURL: newUrl });
      await set(ref(db, `users/${uid}/profile/avatar`), newUrl);
      toast('Profile picture updated!');
    })
    .catch(err => {
      toast('Upload failed');
      console.error(err);
    });
}
removePhotoBtn.onclick = async () => {
  const fallback = `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(profileEditName.value || uname)}`;
  pendingAvatarUrl = fallback;
  myAvatarEl.src = fallback;
  profileAvatarBig.src = fallback;
  profilePhotoPreviewImg.src = fallback;
  document.querySelectorAll(`.post-avatar[data-uid="${uid}"]`).forEach(img => img.src = fallback);
  await updateProfile(auth.currentUser, { photoURL: fallback });
  await set(ref(db, `users/${uid}/profile/avatar`), fallback);
  removePhotoBtn.classList.add('hidden');
  toast('Photo removed');
};
profileEditName.oninput = () => {
  pendingName = profileEditName.value.trim() || 'User';
};

// Save name
profileSaveBtn.onclick = async () => {
  const newName = pendingName || profileEditName.value.trim() || 'User';
  try {
    await updateProfile(auth.currentUser, { displayName: newName });
    await set(ref(db, `users/${uid}/profile/displayName`), newName);
    uname = newName;
    toast('Name updated!');
    closeProfileSheet();
  } catch (err) {
    toast('Error updating name: ' + err.message);
  }
};

// Log out
profileLogoutBtn.onclick = async () => {
  try {
    await signOut(auth);
    toast('Logged out');
    closeProfileSheet();
  } catch (err) {
    toast('Logout failed');
  }
};

/* All other code (feed loading, posting, likes, comments, etc.) remains exactly as in the previous version */
function showSkeletonLoaders(count = 5) {
  feedEl.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton-post';
    skeleton.innerHTML = `
      <div class="post-header">
        <div class="skeleton skeleton-avatar"></div>
        <div class="flex-1">
          <div class="skeleton skeleton-line" style="width: 40%; margin-bottom: 8px;"></div>
          <div class="skeleton skeleton-text" style="width: 85%;"></div>
          <div class="skeleton skeleton-text" style="width: 70%;"></div>
        </div>
      </div>
    `;
    feedEl.appendChild(skeleton);
  }
}
async function initFeed() {
  showSkeletonLoaders(5);
  try {
    const postsRef = ref(db, 'posts');
    const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
    const snap = await get(q);
   
    if (!snap.exists()) {
      feedEl.innerHTML = '<div class="text-center p-8 text-gray-500">No posts yet. Be the first to post!</div>';
      loadMoreBtn.classList.add('hidden');
      initialLoadDone = true;
      return;
    }
   
    feedEl.innerHTML = '';
    const rows = [];
    snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
    rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
   
    const last = rows[rows.length-1];
    if (last) {
      lastTimestamp = last.timestamp;
      lastKey = last.key;
    }
   
    loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
    initialLoadDone = true;
    listenNew();
   
  } catch (e) {
    console.error('Error loading posts:', e);
    feedEl.innerHTML = '<div class="text-center p-8 text-red-500">Error loading posts. Please check your connection and try again.</div>';
    toast('Error loading posts: ' + e.message);
  }
}
function listenNew() {
  const postsRef = ref(db, 'posts');
  onChildAdded(postsRef, snap => {
    if (!initialLoadDone) return;
    const data = snap.val();
    if (!data || !data.timestamp) return;
    if (!lastTimestamp || data.timestamp > lastTimestamp) {
      feedEl.prepend(renderPostCard({key: snap.key, ...data}));
      lastTimestamp = data.timestamp;
    }
  });
}
loadMoreBtn.onclick = async () => {
  loadMoreBtn.disabled = true;
  loadMoreBtn.textContent = 'Loading...';
 
  try {
    const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT+1));
    const snap = await get(q);
   
    const rows = [];
    snap.forEach(c => rows.push({key: c.key, ...c.val()}));
    const uniq = rows.filter(p => p.key !== lastKey);
   
    if (!uniq.length) {
      toast('No more posts');
      loadMoreBtn.classList.add('hidden');
      return;
    }
   
    uniq.reverse();
    uniq.forEach(p => feedEl.appendChild(renderPostCard(p)));
   
    const last = uniq[uniq.length-1];
    lastTimestamp = last.timestamp;
    lastKey = last.key;
   
    if (uniq.length < POST_LIMIT) loadMoreBtn.classList.add('hidden');
   
  } catch (e) {
    console.error('Error loading more posts:', e);
    toast('Error loading more posts');
  } finally {
    loadMoreBtn.disabled = false;
    loadMoreBtn.textContent = 'Load More Posts';
  }
};
let mediaUrl = '', uploading = false;
function toggleBtn() {
  postBtn.disabled = uploading || (!textEl.value.trim() && !mediaUrl);
}
fileInput.onchange = e => {
  if (requireAuth()) return;
  const file = e.target.files[0];
  if (!file) return;
 
  const isVideo = file.type.startsWith('video/');
  const isImage = file.type.startsWith('image/');
 
  if (!isVideo && !isImage) {
    toast('Only images or videos');
    return;
  }
 
  const r = new FileReader();
  r.onload = ev => {
    if (isVideo) {
      previewVid.src = ev.target.result;
      previewVid.classList.remove('hidden');
      previewImg.classList.add('hidden');
    } else {
      previewImg.src = ev.target.result;
      previewImg.classList.remove('hidden');
      previewVid.classList.add('hidden');
    }
  };
  r.readAsDataURL(file);
  uploadToCloudinary(file);
};
function uploadToCloudinary(file) {
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
 
  uploading = true;
  toggleBtn();
 
  $('#btn-spinner').classList.remove('hidden');
  $('#btn-text').classList.add('hidden');
 
  fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(async res => {
      mediaUrl = res.secure_url;
      toast('Media uploaded');
    })
    .catch(err => {
      toast('Upload failed');
      mediaUrl = '';
      previewImg.classList.add('hidden');
      previewVid.classList.add('hidden');
      console.error(err);
    })
    .finally(() => {
      uploading = false;
      $('#btn-spinner').classList.add('hidden');
      $('#btn-text').classList.remove('hidden');
      toggleBtn();
    });
}
postBtn.onclick = async () => {
  if (requireAuth()) return;
  const text = textEl.value.trim();
  if (!text && !mediaUrl) return;
 
  postBtn.disabled = true;
  $('#btn-spinner').classList.remove('hidden');
  $('#btn-text').classList.add('hidden');
 
  try {
    const newRef = push(ref(db, 'posts'));
    const postData = {
      authorId: uid,
      authorName: uname,
      authorAvatar: uavatar,
      text,
      image: mediaUrl,
      verified: false,
      likes: 0,
      replies: 0,
      reposts: 0,
      timestamp: serverTimestamp()
    };
   
    await set(newRef, postData);
   
    textEl.value = '';
    mediaUrl = '';
    previewImg.classList.add('hidden');
    previewVid.classList.add('hidden');
    toggleBtn();
    toast('Posted!');
   
  } catch (err) {
    console.error('Error posting:', err);
    toast('Error posting: ' + err.message);
  } finally {
    $('#btn-spinner').classList.add('hidden');
    $('#btn-text').classList.remove('hidden');
    postBtn.disabled = false;
  }
};
textEl.oninput = () => {
  textEl.style.height = 'auto';
  textEl.style.height = textEl.scrollHeight + 'px';
  toggleBtn();
};
/* real-time user-data helper */
const userMetaCache = new Map();
function listenUserMeta(uid, card) {
  if (userMetaCache.has(uid)) return applyUserMeta(card, userMetaCache.get(uid));
  const unsub = onValue(ref(db, `users/${uid}/profile`), snap => {
    const v = snap.val() || {};
    const meta = { name: v.displayName || 'User', avatar: v.avatar || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${v.displayName || 'User'}`, verified: v.verified === true };
    userMetaCache.set(uid, meta);
    applyUserMeta(card, meta);
  });
  card._unsubUser = unsub;
}
function applyUserMeta(card, meta) {
  card.querySelector('.user-name .name').textContent = esc(meta.name);
  card.querySelector('.user-handle').textContent = `@${meta.name.replace(/\s/g, '').toLowerCase()}`;
  card.querySelector('.post-avatar').src = meta.avatar;
  const badge = card.querySelector('.verified-badge');
  badge.style.display = meta.verified ? 'inline' : 'none';
}
function renderPostCard(p) {
  const isMine = p.authorId === uid;
  const div = document.createElement('div');
  div.id = `post-${p.key}`;
  div.className = 'post-card';
 
  div.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar}" class="post-avatar" data-uid="${p.authorId}">
      <div class="user-info">
        <div class="user-name">
          <span class="name">${esc(p.authorName)}</span>
          <span class="verified-badge material-icons text-sm" style="display:none">verified</span>
        </div>
        <div class="user-handle">@${p.authorName.replace(/\s/g,'').toLowerCase()}</div>
        <div class="post-time">${timeAgo(p.timestamp || Date.now())}</div>
      </div>
    </div>
    <div class="post-content">${linkify(esc(p.text))}</div>
    ${mediaMarkup(p.image)}
    <div class="post-actions">
      <div class="action-item reply ${isAnonymous ? 'disabled' : ''}" data-post="${p.key}" data-action="reply">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        <span id="replies-${p.key}">${p.replies||0}</span>
      </div>
      <div class="action-item repost ${isAnonymous ? 'disabled' : ''}" data-post="${p.key}" data-action="repost">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2l4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
        <span id="reposts-${p.key}">${p.reposts||0}</span>
      </div>
      <div class="action-item like ${isAnonymous ? 'disabled' : ''}" data-post="${p.key}" data-action="like">
        <svg class="outline-heart" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <svg class="filled-heart hidden" width="20" height="20" viewBox="0 0 24 24" fill="#1877f2" stroke="#1877f2" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <span id="likes-${p.key}">${p.likes||0}</span>
      </div>
      <div class="action-item share" data-post="${p.key}" data-action="share">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </div>
      ${isMine && !isAnonymous ? `<div class="action-item delete-btn" data-post="${p.key}" data-action="delete">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      </div>` : ''}
    </div>`;
 
  const stampEl = div.querySelector('.post-time');
  if (!p.timestamp) {
    onValue(ref(db, `posts/${p.key}/timestamp`), snap => {
      const v = snap.val();
      if (v) stampEl.textContent = timeAgo(v);
    }, { onlyOnce: true });
  }
 
  div.addEventListener('click', e => {
    if (e.target.classList.contains('post-avatar')) {
      const clickedUid = e.target.dataset.uid;
      openProfileSheet(clickedUid);
      return;
    }
    if (e.target.classList.contains('post-image')) { openImageModal(e.target.src); return; }
    if (e.target.classList.contains('post-video')) { openVideoModal(e.target.dataset.videoUrl); return; }
   
    const actionItem = e.target.closest('.action-item');
    if (!actionItem || actionItem.classList.contains('disabled')) return;
   
    const action = actionItem.dataset.action;
    const postId = actionItem.dataset.post;
    if (!action || !postId) return;
   
    e.stopPropagation();
    if (action === 'reply') { if (requireAuth()) return; openComments(postId); }
    if (action === 'repost') { if (requireAuth()) return; doRepost(postId); }
    if (action === 'like') { if (requireAuth()) return; toggleLike(postId); }
    if (action === 'share') navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
    if (action === 'delete') confirmDelete(postId);
  });
 
  listenCounters(p.key);
  listenUserMeta(p.authorId, div);
  return div;
}
function mediaMarkup(url) {
  if (!url) return '';
  const isVideo = url.includes('/video/upload') || url.endsWith('.mp4');
  if (isVideo) {
    return `
      <div class="post-video-wrapper">
        <video class="post-video" muted loop playsinline data-video-url="${url}">
          <source src="${url}" type="video/mp4">
        </video>
        <div class="video-play-overlay">
          <span class="material-icons">play_circle_filled</span>
        </div>
      </div>`;
  }
  return `<img class="post-image" src="${url}" loading="lazy">`;
}
function listenCounters(postId) {
  onValue(ref(db, `likes/${postId}`), s => {
    $('#likes-'+postId).textContent = s.size;
    const ic = document.querySelector(`[data-post="${postId}"].like`);
    if (ic) ic.classList.toggle('liked', s.hasChild(uid));
  });
  onValue(ref(db, `comments/${postId}`), s => $('#replies-'+postId).textContent = s.size);
  onValue(ref(db, `reposts/${postId}`), s => $('#reposts-'+postId).textContent = s.size);
}
async function toggleLike(postId) {
  if (requireAuth()) return;
 
  const likeRef = ref(db, `likes/${postId}/${uid}`);
  const snap = await get(likeRef);
  const alreadyLiked = snap.exists();
  if (alreadyLiked) {
    await remove(likeRef);
  } else {
    await set(likeRef, true);
    const postSnap = await get(ref(db, `posts/${postId}`));
    const post = postSnap.val();
    if (post && post.authorId && post.authorId !== uid) {
      sendNotification(post.authorId, 'like', { postId, text: post.text || '' });
    }
  }
}
async function doRepost(postId) {
  if (requireAuth()) return;
 
  const origSnap = await get(ref(db, `posts/${postId}`));
  const orig = origSnap.val();
  if (!orig) return;
  const newRef = push(ref(db, 'posts'));
  await set(newRef, {
    authorId: uid,
    authorName: uname,
    authorAvatar: uavatar,
    text: orig.text,
    image: orig.image,
    verified: false,
    repostOf: { authorName: orig.authorName, key: postId },
    likes: 0,
    replies: 0,
    reposts: 0,
    timestamp: Date.now()
  });
  if (orig.authorId && orig.authorId !== uid) {
    sendNotification(orig.authorId, 'repost', { postId, text: orig.text || '' });
  }
  toast('Re-posted');
}
let currentPostId = null, commentsListener = null;
const commentOverlay = $('#comment-sheet-overlay'),
      commentList = $('#comment-sheet-list'),
      commentInput = $('#comment-input'),
      commentSendBtn = $('#comment-send-btn');
function openComments(postId) {
  if (requireAuth()) return;
 
  currentPostId = postId;
  commentInput.value = '';
  delete commentInput.dataset.parent;
  commentInput.placeholder = 'Write a comment...';
  commentList.innerHTML = '<div class="text-center p-4 text-gray-500">Loading comments...</div>';
  commentOverlay.classList.add('show');
  if (commentsListener) commentsListener();
  commentsListener = onValue(ref(db, `comments/${postId}`), snap => {
    commentList.innerHTML = '';
    if (!snap.exists()) { commentList.innerHTML = '<div class="p-4 text-sm text-gray-500">No comments yet</div>'; return; }
    snap.forEach(c => {
      const v = c.val(), cid = c.key;
      const isMine = v.authorId === uid;
      const d = document.createElement('div'); d.className = 'comment-item';
      d.innerHTML = `
        <img src="${v.authorAvatar}" class="comment-avatar">
        <div class="comment-body flex-1">
          <div class="comment-name">${esc(v.authorName)}</div>
          <div class="comment-text">${esc(v.text)}</div>
        </div>`;
      commentList.appendChild(d);
    });
  });
}
$('#comment-sheet-close').onclick = closeComments;
commentOverlay.onclick = e => { if (e.target === commentOverlay) closeComments(); };
function closeComments() {
  commentOverlay.classList.remove('show');
  if (commentsListener) { commentsListener(); commentsListener = null; }
  currentPostId = null;
}
commentSendBtn.onclick = async () => {
  if (requireAuth()) return;
 
  const text = commentInput.value.trim();
  if (!text || !currentPostId) return;
  const commentRef = push(ref(db, `comments/${currentPostId}`));
  await set(commentRef, {
    authorId: uid,
    authorName: uname,
    authorAvatar: uavatar,
    text,
    timestamp: Date.now()
  });
  commentInput.value = '';
  toast('Comment posted');
};
function toast(msg) {
  const t = document.createElement('div'); t.className = 'custom-toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
}
const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
const timeAgo = ts => {
  if (!ts) return 'now';
  const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
};
</script>
</body>
</html>
