<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Lingua WhatsApp</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --whatsapp-green: #128c7e;
      --whatsapp-green-dark: #075e54;
      --whatsapp-green-light: #25d366;
      --whatsapp-blue: #34b7f1;
      --whatsapp-gray: #f0f2f5;
      --whatsapp-gray-dark: #131c21;
      --whatsapp-chat-bg: #e5ddd5;
      --whatsapp-white: #ffffff;
      --whatsapp-text: #3b4a54;
      --whatsapp-text-secondary: #667781;
      --bubble-own: linear-gradient(135deg, #dcf8c6 0%, #c5e1a5 100%);
      --bubble-other: #ffffff;
      --header-height: 60px;
      --tabbar-height: 70px;
      --input-height: 60px;
      --pill-radius: 25px;
      --shimmer-bg: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    }
    
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      -webkit-user-select: none; 
      user-select: none; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: var(--whatsapp-white);
      color: var(--whatsapp-text); 
      height: 100vh; 
      overflow: hidden;
      touch-action: pan-y;
    }
    
    .app-container {
      position: relative; 
      width: 100%; 
      height: 100%; 
      display: flex; 
      flex-direction: column;
      background: var(--whatsapp-white);
    }
    
    @media (min-width: 768px) {
      .app-container { 
        max-width: 450px; 
        margin: 0 auto; 
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
      }
    }
    
    /* WhatsApp-style Header */
    .whatsapp-header {
      height: var(--header-height);
      background: var(--whatsapp-green-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      position: relative;
      z-index: 100;
    }
    
    .header-title {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 18px;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header-actions {
      display: flex;
      gap: 16px;
    }
    
    .header-icon {
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .header-icon:hover {
      opacity: 0.8;
    }
    
    /* Bottom Pill-shaped Tab Bar */
    .whatsapp-tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--tabbar-height);
      background: transparent;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 10px;
      z-index: 1000;
      pointer-events: none;
    }
    
    @media (min-width: 768px) {
      .whatsapp-tabbar {
        left: 50%;
        transform: translateX(-50%);
        max-width: 450px;
      }
    }
    
    .pill-tabs {
      background: var(--whatsapp-white);
      border-radius: var(--pill-radius);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      padding: 6px;
      gap: 4px;
      pointer-events: all;
      backdrop-filter: blur(10px);
    }
    
    .pill-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 20px;
      color: var(--whatsapp-text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      min-width: 80px;
      justify-content: center;
    }
    
    .pill-tab.active {
      background: var(--whatsapp-green);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(18, 140, 126, 0.3);
    }
    
    .pill-tab-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }
    
    .pill-tab.active .pill-tab-icon {
      transform: scale(1.1);
    }
    
    /* Unread Badge for Pill Tabs */
    .pill-unread-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ff3b30;
      color: white;
      font-size: 10px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 1.5s infinite;
      z-index: 10;
    }
    
    /* Main Content Area */
    .main-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      padding-bottom: var(--tabbar-height);
    }
    
    /* Swipe Container for Tab Views */
    .swipe-container {
      display: flex;
      width: 200%;
      height: 100%;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .swipe-container.status-active {
      transform: translateX(-50%);
    }
    
    /* Chat List View (WhatsApp Style) */
    .chats-list-view {
      width: 50%;
      height: 100%;
      background: var(--whatsapp-white);
      overflow-y: auto;
      padding-top: 8px;
    }
    
    .chat-item-whatsapp {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }
    
    .chat-item-whatsapp:hover {
      background: var(--whatsapp-gray);
    }
    
    .chat-item-whatsapp::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 80px;
      right: 0;
      height: 1px;
      background: rgba(0,0,0,0.05);
    }
    
    .whatsapp-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--whatsapp-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 500;
      color: var(--whatsapp-text-secondary);
      margin-right: 12px;
      position: relative;
      flex-shrink: 0;
    }
    
    .whatsapp-avatar.online::before {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: var(--whatsapp-green-light);
      border: 3px solid white;
      border-radius: 50%;
      z-index: 2;
    }
    
    .chat-info-whatsapp {
      flex: 1;
      min-width: 0;
    }
    
    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    
    .chat-name-whatsapp {
      font-weight: 500;
      font-size: 16px;
      color: var(--whatsapp-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-time-whatsapp {
      font-size: 12px;
      color: var(--whatsapp-text-secondary);
      flex-shrink: 0;
      margin-left: 8px;
    }
    
    .chat-preview-whatsapp {
      font-size: 14px;
      color: var(--whatsapp-text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .unread-dot {
      width: 8px;
      height: 8px;
      background: var(--whatsapp-green-light);
      border-radius: 50%;
      margin-left: 8px;
      flex-shrink: 0;
      animation: pulse 1.5s infinite;
    }
    
    /* Status View (Facebook-like Vertical Cards) */
    .status-view {
      width: 50%;
      height: 100%;
      background: var(--whatsapp-gray);
      overflow-y: auto;
      padding: 16px;
    }
    
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .status-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--whatsapp-text);
    }
    
    .add-status-btn {
      background: var(--whatsapp-green);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(18, 140, 126, 0.3);
      transition: transform 0.2s;
    }
    
    .add-status-btn:hover {
      transform: scale(1.1);
    }
    
    .status-card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    
    .status-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .status-card-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .status-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--whatsapp-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .status-meta {
      flex: 1;
    }
    
    .status-author {
      font-weight: 500;
      font-size: 14px;
      color: var(--whatsapp-text);
      margin-bottom: 2px;
    }
    
    .status-time {
      font-size: 12px;
      color: var(--whatsapp-text-secondary);
    }
    
    .status-content {
      font-size: 15px;
      line-height: 1.4;
      color: var(--whatsapp-text);
      margin-bottom: 12px;
    }
    
    .status-actions {
      display: flex;
      gap: 16px;
      padding-top: 8px;
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    
    .status-action {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--whatsapp-text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .status-action:hover {
      color: var(--whatsapp-green);
    }
    
    /* Chat View */
    .chat-view {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--whatsapp-chat-bg);
      display: none;
      flex-direction: column;
    }
    
    .chat-view.active {
      display: flex;
    }
    
    .chat-header-whatsapp {
      height: var(--header-height);
      background: var(--whatsapp-green-dark);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
    }
    
    .chat-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 500;
    }
    
    .chat-header-info {
      flex: 1;
    }
    
    .chat-header-name {
      color: white;
      font-weight: 500;
      font-size: 16px;
    }
    
    .chat-header-status {
      color: rgba(255,255,255,0.8);
      font-size: 13px;
    }
    
    .messages-wrapper-whatsapp {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px;
      background: var(--whatsapp-chat-bg);
    }
    
    .whatsapp-bubble {
      max-width: 70%;
      padding: 8px 12px;
      margin-bottom: 4px;
      position: relative;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.3;
    }
    
    .whatsapp-bubble.own {
      background: var(--bubble-own);
      color: #000;
      border-radius: 8px 8px 0 8px;
      margin-left: auto;
    }
    
    .whatsapp-bubble.other {
      background: var(--bubble-other);
      color: var(--whatsapp-text);
      border-radius: 8px 8px 8px 0;
      margin-right: auto;
    }
    
    .bubble-time {
      font-size: 11px;
      color: rgba(0,0,0,0.5);
      margin-top: 4px;
      text-align: right;
      opacity: 0.7;
    }
    
    /* Input Area */
    .input-area-whatsapp {
      background: var(--whatsapp-white);
      padding: 8px 16px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    
    .input-wrapper-whatsapp {
      flex: 1;
      background: var(--whatsapp-gray);
      border-radius: 24px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 44px;
    }
    
    .whatsapp-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 15px;
      outline: none;
      resize: none;
      max-height: 100px;
      -webkit-user-select: text;
      user-select: text;
    }
    
    .send-btn-whatsapp {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--whatsapp-green);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s;
      flex-shrink: 0;
    }
    
    .send-btn-whatsapp:hover {
      transform: scale(1.05);
      background: var(--whatsapp-green-dark);
    }
    
    .send-btn-whatsapp:active {
      transform: scale(0.95);
    }
    
    /* Status Composer */
    .status-composer {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .status-input {
      width: 100%;
      border: none;
      background: var(--whatsapp-gray);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      resize: none;
      outline: none;
      margin-bottom: 12px;
      min-height: 80px;
    }
    
    .status-post-btn {
      background: var(--whatsapp-green);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .status-post-btn:hover {
      background: var(--whatsapp-green-dark);
    }
    
    /* E2EE Indicator */
    .e2ee-indicator-whatsapp {
      position: fixed;
      bottom: calc(var(--tabbar-height) + 20px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 200;
      backdrop-filter: blur(10px);
    }
    
    .e2ee-indicator-whatsapp.visible {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.3);
    }
    
    /* Toast Notification */
    .toast-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 24px;
      font-size: 14px;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
    }
    
    .toast-notification.show {
      display: flex;
      animation: toastSlide 0.3s ease;
    }
    
    @keyframes toastSlide {
      from { transform: translate(-50%, -100px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    /* Auth Overlay */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .auth-overlay.open {
      display: flex;
    }
    
    .auth-box-whatsapp {
      background: var(--whatsapp-white);
      border-radius: 20px;
      padding: 32px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .auth-title {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
      color: var(--whatsapp-text);
    }
    
    .auth-subtitle {
      text-align: center;
      color: var(--whatsapp-text-secondary);
      margin-bottom: 24px;
    }
    
    .auth-input-whatsapp {
      width: 100%;
      padding: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .auth-input-whatsapp:focus {
      border-color: var(--whatsapp-green);
    }
    
    .auth-btn-whatsapp {
      width: 100%;
      padding: 16px;
      background: var(--whatsapp-green);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 8px;
    }
    
    .auth-btn-whatsapp:hover {
      background: var(--whatsapp-green-dark);
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 16px;
      color: var(--whatsapp-text-secondary);
      font-size: 14px;
    }
    
    .auth-switch-btn {
      background: none;
      border: none;
      color: var(--whatsapp-green);
      font-weight: 500;
      cursor: pointer;
    }
    
    /* Hidden state for private chats */
    .whatsapp-tabbar.hidden {
      transform: translateY(100%);
    }
  </style>
</head>
<body>
  <!-- WhatsApp Header -->
  <header class="whatsapp-header">
    <div class="header-title">
      <span>Vynix Lingua</span>
    </div>
    <div class="header-actions">
      <span class="material-symbols-rounded header-icon">search</span>
      <span class="material-symbols-rounded header-icon">more_vert</span>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <div class="swipe-container" id="swipeContainer">
      <!-- Chats List View -->
      <div class="chats-list-view">
        <div id="chatsList" class="chats-list">
          <!-- Chat items will be generated here -->
        </div>
      </div>

      <!-- Status View (Facebook-like Vertical Cards) -->
      <div class="status-view">
        <div class="status-header">
          <h2 class="status-title">Status</h2>
          <button class="add-status-btn" id="addStatusBtn">
            <span class="material-symbols-rounded">add</span>
          </button>
        </div>
        
        <!-- Status Composer -->
        <div class="status-composer" id="statusComposer">
          <textarea class="status-input" id="statusInput" placeholder="What's on your mind?"></textarea>
          <button class="status-post-btn" id="statusPostBtn">Post Status</button>
        </div>
        
        <!-- Status Cards Container -->
        <div id="statusCards" class="status-cards">
          <!-- Status cards will be generated here -->
        </div>
      </div>
    </div>

    <!-- Chat View (Hidden by default) -->
    <div class="chat-view" id="chatView">
      <div class="chat-header-whatsapp">
        <span class="material-symbols-rounded header-icon" id="backBtn" style="cursor: pointer;">arrow_back</span>
        <div class="chat-header-avatar" id="chatHeaderAvatar"></div>
        <div class="chat-header-info">
          <div class="chat-header-name" id="chatHeaderName"></div>
          <div class="chat-header-status" id="chatHeaderStatus">Online</div>
        </div>
        <span class="material-symbols-rounded header-icon">more_vert</span>
      </div>
      
      <div class="messages-wrapper-whatsapp" id="messagesContainer">
        <!-- Messages will appear here -->
      </div>
      
      <div class="input-area-whatsapp">
        <div class="input-wrapper-whatsapp">
          <span class="material-symbols-rounded" style="color: var(--whatsapp-text-secondary); cursor: pointer;">emoji_emotions</span>
          <textarea class="whatsapp-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
          <span class="material-symbols-rounded" style="color: var(--whatsapp-text-secondary); cursor: pointer;">attach_file</span>
        </div>
        <button class="send-btn-whatsapp" id="sendButton">
          <span class="material-symbols-rounded">send</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Bottom Pill-shaped Tab Bar -->
  <div class="whatsapp-tabbar" id="tabbar">
    <div class="pill-tabs">
      <div class="pill-tab active" data-tab="chats">
        <span class="material-symbols-rounded pill-tab-icon">chat_bubble</span>
        <span>Chats</span>
      </div>
      <div class="pill-tab" data-tab="status">
        <span class="material-symbols-rounded pill-tab-icon">circle</span>
        <span>Status</span>
      </div>
    </div>
  </div>

  <!-- E2EE Indicator -->
  <div class="e2ee-indicator-whatsapp" id="e2eeIndicator">
    <span class="material-symbols-rounded" style="font-size: 16px;">lock</span>
    <span>End-to-end encrypted</span>
  </div>

  <!-- Toast Notification -->
  <div class="toast-notification" id="toast">
    <span id="toastMessage">New message</span>
  </div>

  <!-- Auth Overlay -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-box-whatsapp">
      <h2 class="auth-title">Welcome to Vynix Lingua</h2>
      <p class="auth-subtitle">Sign in to start chatting securely</p>
      <input type="email" id="authEmail" class="auth-input-whatsapp" placeholder="Email">
      <input type="password" id="authPass" class="auth-input-whatsapp" placeholder="Password">
      <button class="auth-btn-whatsapp" id="authBtn">Sign In</button>
      <div class="auth-switch">
        <span>Don't have an account? </span>
        <button class="auth-switch-btn" id="authSwitchBtn">Sign Up</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, setDoc, where, getDocs, arrayUnion, getDoc, arrayRemove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ðŸ” E2EE KEY MANAGEMENT SYSTEM
    class E2EEManager {
      constructor() {
        this.keyPairs = new Map();
        this.sessionKeys = new Map();
        this.ratchetKeys = new Map();
      }

      async generateKeyPair(userId) {
        const keyPair = {
          publicKey: this.generateRSAKeyPair(),
          privateKey: this.generateRSAKeyPair()
        };
        this.keyPairs.set(userId, keyPair);
        return keyPair;
      }

      generateSessionKey(userId, partnerId, userPrivateKey, partnerPublicKey) {
        const sessionId = [userId, partnerId].sort().join('_');
        const sharedSecret = this.computeSharedSecret(userPrivateKey, partnerPublicKey);
        const sessionKey = CryptoJS.SHA256(sharedSecret + sessionId).toString();
        this.sessionKeys.set(sessionId, sessionKey);
        return sessionKey;
      }

      encryptMessage(message, sessionKey) {
        const aesKey = CryptoJS.lib.WordArray.random(256/8).toString();
        const iv = CryptoJS.lib.WordArray.random(128/8);
        
        const encrypted = CryptoJS.AES.encrypt(message, aesKey, { iv: iv }).toString();
        const encryptedAesKey = CryptoJS.AES.encrypt(aesKey, sessionKey).toString();
        
        return {
          encrypted: encrypted,
          key: encryptedAesKey,
          iv: iv.toString()
        };
      }

      decryptMessage(encryptedData, sessionKey) {
        try {
          const aesKey = CryptoJS.AES.decrypt(encryptedData.key, sessionKey).toString(CryptoJS.enc.Utf8);
          if (!aesKey) throw new Error('Failed to decrypt AES key');
          
          const decrypted = CryptoJS.AES.decrypt(encryptedData.encrypted, aesKey, { 
            iv: CryptoJS.enc.Hex.parse(encryptedData.iv) 
          }).toString(CryptoJS.enc.Utf8);
          
          return decrypted || 'âš ï¸ Decryption failed';
        } catch (e) {
          return 'âš ï¸ Encrypted message';
        }
      }

      generateRSAKeyPair() {
        return CryptoJS.lib.WordArray.random(256/8).toString();
      }

      computeSharedSecret(privateKey, publicKey) {
        return CryptoJS.SHA256(privateKey + publicKey).toString();
      }
    }

    // Initialize E2EE Manager
    const e2eeManager = new E2EEManager();

    // State management
    let currentUser = null;
    let activeChatId = null;
    let activeChatPartner = null;
    let selectedMessageId = null;
    let typingTimeout;
    let isInitialLoad = true;
    let unsubscribes = [];
    let unreadCounts = { chats: 0, private: {} };
    let userStatusMap = new Map();
    let touchStartX = 0;
    let currentX = 0;
    let isDragging = false;
    let isPrivateChatMode = false;

    // DOM Elements
    const els = {
      chatsList: document.getElementById('chatsList'),
      statusCards: document.getElementById('statusCards'),
      statusComposer: document.getElementById('statusComposer'),
      statusInput: document.getElementById('statusInput'),
      statusPostBtn: document.getElementById('statusPostBtn'),
      addStatusBtn: document.getElementById('addStatusBtn'),
      chatView: document.getElementById('chatView'),
      messagesContainer: document.getElementById('messagesContainer'),
      messageInput: document.getElementById('messageInput'),
      sendButton: document.getElementById('sendButton'),
      backBtn: document.getElementById('backBtn'),
      chatHeaderAvatar: document.getElementById('chatHeaderAvatar'),
      chatHeaderName: document.getElementById('chatHeaderName'),
      chatHeaderStatus: document.getElementById('chatHeaderStatus'),
      tabbar: document.getElementById('tabbar'),
      e2eeIndicator: document.getElementById('e2eeIndicator'),
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toastMessage'),
      authOverlay: document.getElementById('authOverlay'),
      authBtn: document.getElementById('authBtn'),
      authSwitchBtn: document.getElementById('authSwitchBtn'),
      swipeContainer: document.getElementById('swipeContainer')
    };

    // Tab Switching
    function switchTab(tabName) {
      document.querySelectorAll('.pill-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });

      if (tabName === 'chats') {
        els.swipeContainer.classList.remove('status-active');
        showChatsList();
      } else {
        els.swipeContainer.classList.add('status-active');
        showStatusList();
      }
    }

    // Pill Tab Click Handlers
    document.querySelectorAll('.pill-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        switchTab(tab.dataset.tab);
      });
    });

    function showChatsList() {
      els.chatView.classList.remove('active');
      els.tabbar.classList.remove('hidden');
      els.e2eeIndicator.classList.remove('visible');
      isPrivateChatMode = false;
      activeChatId = null;
      stopAllListeners();
      loadFriendsChats();
    }

    function showStatusList() {
      els.chatView.classList.remove('active');
      els.tabbar.classList.remove('hidden');
      els.e2eeIndicator.classList.remove('visible');
      isPrivateChatMode = false;
      activeChatId = null;
      loadStatusPosts();
    }

    // Swipe Gesture Implementation
    document.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchmove', handleTouchMove, { passive: true });
    document.addEventListener('touchend', handleTouchEnd, { passive: true });

    function handleTouchStart(e) {
      if (isPrivateChatMode) return;
      touchStartX = e.touches[0].clientX;
      isDragging = true;
    }

    function handleTouchMove(e) {
      if (!isDragging || isPrivateChatMode) return;
      currentX = e.touches[0].clientX;
      const diffX = currentX - touchStartX;
      
      if (Math.abs(diffX) > 50) {
        e.preventDefault();
      }
    }

    function handleTouchEnd(e) {
      if (!isDragging || isPrivateChatMode) return;
      isDragging = false;
      
      const diffX = currentX - touchStartX;
      const threshold = 100;
      const activeTab = document.querySelector('.pill-tab.active').dataset.tab;
      
      if (Math.abs(diffX) > threshold) {
        if (diffX > 0 && activeTab === 'status') {
          switchTab('chats');
        } else if (diffX < 0 && activeTab === 'chats') {
          switchTab('status');
        }
      }
    }

    // Auth
    let isSignUp = false;

    els.authSwitchBtn.addEventListener('click', () => {
      isSignUp = !isSignUp;
      els.authBtn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
      els.authSwitchBtn.textContent = isSignUp ? 'Sign In' : 'Sign Up';
      document.querySelector('.auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
    });

    els.authBtn.addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if (!email || !pass) return showToast('Please fill in all fields');
      
      try {
        let cred;
        if (isSignUp) {
          cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: email.split('@')[0] });
        } else {
          cred = await signInWithEmailAndPassword(auth, email, pass);
        }
        
        // Generate E2EE key pair for user
        const keyPair = await e2eeManager.generateKeyPair(cred.user.uid);
        
        // Store public key in Firestore
        const userRef = doc(db, 'users', cred.user.uid);
        await setDoc(userRef, { 
          displayName: cred.user.displayName, 
          lastSeen: serverTimestamp(), 
          friends: [],
          publicKey: keyPair.publicKey
        }, { merge: true });
        
        els.authOverlay.classList.remove('open');
        showToast(isSignUp ? 'Account created successfully!' : 'Welcome back!');
      } catch (e) { 
        showToast(e.message); 
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        els.authOverlay.classList.add('open');
        stopAllListeners();
      } else {
        switchTab('chats');
        startHeartbeat();
      }
    });

    // Load Friends for Chats List
    async function loadFriendsChats() {
      els.chatsList.innerHTML = '';

      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      const friends = userSnap.data()?.friends || [];

      if (friends.length === 0) {
        els.chatsList.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--whatsapp-text-secondary);">
            <span class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px;">group_add</span>
            <p>No friends yet</p>
            <p style="font-size: 14px; margin-top: 8px;">Add friends to start chatting</p>
          </div>
        `;
        return;
      }

      setupOnlineStatusListener();

      for (const friendUid of friends) {
        const friendRef = doc(db, 'users', friendUid);
        const friendSnap = await getDoc(friendRef);
        if (!friendSnap.exists()) continue;
        const friend = friendSnap.data();

        const chatId = [currentUser.uid, friendUid].sort().join('_');
        const isOnline = userStatusMap.get(friendUid) || false;

        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item-whatsapp';
        chatItem.innerHTML = `
          <div class="whatsapp-avatar ${isOnline ? 'online' : ''}">
            ${friend.displayName.charAt(0).toUpperCase()}
          </div>
          <div class="chat-info-whatsapp">
            <div class="chat-header-row">
              <div class="chat-name-whatsapp">${friend.displayName}</div>
              <div class="chat-time-whatsapp" id="time-${chatId}"></div>
            </div>
            <div class="chat-preview-whatsapp" id="preview-${chatId}">Tap to start chatting</div>
          </div>
          <div class="unread-dot" id="unread-${chatId}" style="display: none;"></div>
        `;
        
        chatItem.addEventListener('click', () => openPrivateChat(chatId, {
          uid: friendUid, 
          displayName: friend.displayName,
          publicKey: friend.publicKey
        }));

        els.chatsList.appendChild(chatItem);

        // Real-time last message for preview
        const messagesQ = query(
          collection(db, 'privateChats', chatId, 'messages'),
          orderBy('createdAt', 'desc'),
          limit(1)
        );
        
        onSnapshot(messagesQ, (snapshot) => {
          const previewEl = document.getElementById(`preview-${chatId}`);
          const timeEl = document.getElementById(`time-${chatId}`);
          const unreadEl = document.getElementById(`unread-${chatId}`);
          
          if (snapshot.empty) {
            previewEl.textContent = 'Tap to start chatting';
            timeEl.textContent = '';
            unreadEl.style.display = 'none';
            return;
          }
          
          const lastMsg = snapshot.docs[0].data();
          const isOwn = lastMsg.userId === currentUser.uid;
          
          // Decrypt message for preview
          const sessionKey = e2eeManager.sessionKeys.get(chatId) || 'fallback-key';
          const decrypted = e2eeManager.decryptMessage({
            encrypted: lastMsg.text.encrypted,
            key: lastMsg.text.key,
            iv: lastMsg.text.iv
          }, sessionKey);
          
          const shortText = decrypted.length > 30 ? decrypted.slice(0, 27) + '...' : decrypted;
          previewEl.textContent = isOwn ? `You: ${shortText}` : shortText;
          
          if (lastMsg.createdAt) {
            const time = new Date(lastMsg.createdAt.toDate());
            const now = new Date();
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            let timeStr;
            if (diffMins < 1) timeStr = 'now';
            else if (diffMins < 60) timeStr = `${diffMins}m`;
            else if (diffHours < 24) timeStr = `${diffHours}h`;
            else if (diffDays < 7) timeStr = `${diffDays}d`;
            else timeStr = time.toLocaleDateString();
            
            timeEl.textContent = timeStr;
          }
          
          // Show unread indicator if message is not from current user
          if (!isOwn && lastMsg.userId !== currentUser.uid) {
            unreadEl.style.display = 'block';
          } else {
            unreadEl.style.display = 'none';
          }
        });
      }
    }

    function setupOnlineStatusListener() {
      const usersQ = query(collection(db, 'users'));
      const onlineUnsub = onSnapshot(usersQ, (snap) => {
        snap.forEach(doc => {
          const data = doc.data();
          const isOnline = data.lastSeen && (Date.now() - data.lastSeen.toMillis() < 120000);
          const wasOnline = userStatusMap.get(doc.id);
          
          // Show toast if user just came online
          if (isOnline && !wasOnline && doc.id !== currentUser.uid) {
            showOnlineToast(data.displayName);
          }
          
          userStatusMap.set(doc.id, isOnline);
          
          // Update online indicator
          const avatar = document.querySelector(`[onclick*="${doc.id}"]`)?.closest('.chat-item-whatsapp')?.querySelector('.whatsapp-avatar');
          if (avatar) {
            avatar.classList.toggle('online', isOnline);
          }
        });
      });
      unsubscribes.push(onlineUnsub);
    }

    function showOnlineToast(userName) {
      els.toastMessage.textContent = `${userName} is online`;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 3000);
    }

    // Open a chat with E2EE
    async function openPrivateChat(chatId, partner) {
      // Hide tabbar for private chats (WhatsApp style)
      els.tabbar.classList.add('hidden');
      els.chatView.classList.add('active');
      els.e2eeIndicator.classList.add('visible');
      isPrivateChatMode = true;
      
      stopAllListeners();
      activeChatId = chatId;
      activeChatPartner = partner;
      els.messagesContainer.innerHTML = '';
      
      // Set chat header
      els.chatHeaderAvatar.textContent = partner.displayName.charAt(0).toUpperCase();
      els.chatHeaderName.textContent = partner.displayName;
      
      // Generate session key for E2EE
      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      const userPrivateKey = userSnap.data()?.privateKey || 'fallback-private';
      const partnerPublicKey = partner.publicKey || 'fallback-public';
      
      const sessionKey = e2eeManager.generateSessionKey(
        currentUser.uid, 
        partner.uid, 
        userPrivateKey, 
        partnerPublicKey
      );
      
      isInitialLoad = true;

      const messagesQuery = query(
        collection(db, 'privateChats', chatId, 'messages'), 
        orderBy('createdAt', 'asc'), 
        limit(50)
      );
      
      const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            appendWhatsAppMessage(change.doc, sessionKey);
            if (!isInitialLoad && change.doc.data().userId !== currentUser.uid) {
              showToast(`New message from ${change.doc.data().userName}`);
            }
          }
        });
        if (isInitialLoad) {
          scrollToBottom();
          isInitialLoad = false;
        } else {
          scrollToBottom();
        }
      });
      unsubscribes.push(unsubscribe);
    }

    // Back button
    els.backBtn.addEventListener('click', () => {
      els.tabbar.classList.remove('hidden');
      els.chatView.classList.remove('active');
      els.e2eeIndicator.classList.remove('visible');
      isPrivateChatMode = false;
      stopAllListeners();
    });

    function appendWhatsAppMessage(doc, sessionKey) {
      const data = doc.data();
      const isOwn = data.userId === currentUser.uid;
      
      // Decrypt message
      const decryptedText = e2eeManager.decryptMessage({
        encrypted: data.text.encrypted,
        key: data.text.key,
        iv: data.text.iv
      }, sessionKey);
      
      const time = data.createdAt ? new Date(data.createdAt.toDate()) : new Date();
      const timeStr = time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      const bubble = document.createElement('div');
      bubble.className = `whatsapp-bubble ${isOwn ? 'own' : 'other'}`;
      bubble.innerHTML = `
        ${escapeHtml(decryptedText)}
        <div class="bubble-time">${timeStr}</div>
      `;

      els.messagesContainer.appendChild(bubble);
    }

    // Send Message
    async function sendMessage() {
      const text = els.messageInput.value.trim();
      if (!text || !currentUser || !activeChatId) return;

      els.messageInput.value = '';
      els.messageInput.style.height = 'auto'; // Reset height

      const sessionKey = e2eeManager.sessionKeys.get(activeChatId) || 'fallback-key';
      const encrypted = e2eeManager.encryptMessage(text, sessionKey);

      await addDoc(collection(db, 'privateChats', activeChatId, 'messages'), {
        text: encrypted,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anon',
        createdAt: serverTimestamp()
      });
    }

    // Auto-resize textarea
    els.messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      
      if (this.value.trim()) {
        // You can add typing indicator here if needed
      }
    });

    els.messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    els.sendButton.addEventListener('click', sendMessage);

    function scrollToBottom() {
      els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message) {
      els.toastMessage.textContent = message;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 3000);
    }

    // Status functionality
    els.statusPostBtn.addEventListener('click', async () => {
      const content = els.statusInput.value.trim();
      if (!content || !currentUser) return;

      try {
        await addDoc(collection(db, 'statusPosts'), {
          content: content,
          userId: currentUser.uid,
          userName: currentUser.displayName || 'Anonymous',
          createdAt: serverTimestamp(),
          likes: 0,
          comments: []
        });

        els.statusInput.value = '';
        showToast('Status posted!');
        loadStatusPosts();
      } catch (error) {
        showToast('Failed to post status');
      }
    });

    async function loadStatusPosts() {
      const statusQuery = query(
        collection(db, 'statusPosts'), 
        orderBy('createdAt', 'desc'), 
        limit(20)
      );

      onSnapshot(statusQuery, (snapshot) => {
        els.statusCards.innerHTML = '';
        
        if (snapshot.empty) {
          els.statusCards.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--whatsapp-text-secondary);">
              <span class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px;">post_add</span>
              <p>No status updates yet</p>
              <p style="font-size: 14px; margin-top: 8px;">Be the first to share your thoughts!</p>
            </div>
          `;
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const card = document.createElement('div');
          card.className = 'status-card';
          
          const time = data.createdAt ? new Date(data.createdAt.toDate()) : new Date();
          const timeAgo = getTimeAgo(time);
          
          card.innerHTML = `
            <div class="status-card-header">
              <div class="status-avatar">
                ${data.userName.charAt(0).toUpperCase()}
              </div>
              <div class="status-meta">
                <div class="status-author">${data.userName}</div>
                <div class="status-time">${timeAgo}</div>
              </div>
            </div>
            <div class="status-content">${escapeHtml(data.content)}</div>
            <div class="status-actions">
              <div class="status-action" onclick="likeStatus('${doc.id}')">
                <span class="material-symbols-rounded" style="font-size: 18px;">favorite</span>
                <span>${data.likes || 0}</span>
              </div>
              <div class="status-action" onclick="commentStatus('${doc.id}')">
                <span class="material-symbols-rounded" style="font-size: 18px;">comment</span>
                <span>Comment</span>
              </div>
              <div class="status-action" onclick="shareStatus('${doc.id}')">
                <span class="material-symbols-rounded" style="font-size: 18px;">share</span>
                <span>Share</span>
              </div>
            </div>
          `;
          
          els.statusCards.appendChild(card);
        });
      });
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    // Status actions
    window.likeStatus = async (statusId) => {
      const statusRef = doc(db, 'statusPosts', statusId);
      await updateDoc(statusRef, {
        likes: arrayUnion(currentUser.uid)
      });
      showToast('Status liked!');
    };

    window.commentStatus = (statusId) => {
      showToast('Comment feature coming soon!');
    };

    window.shareStatus = (statusId) => {
      showToast('Share feature coming soon!');
    };

    // Heartbeat for online status
    function startHeartbeat() {
      const update = async () => {
        if (currentUser) {
          const userRef = doc(db, 'users', currentUser.uid);
          await updateDoc(userRef, { lastSeen: serverTimestamp() });
        }
      };
      update();
      setInterval(update, 60000);
    }

    // Initialize
    switchTab('chats');
  </script>
</body>
  </html>
