<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --accent-purple: #d946ef;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-color: #f8f9fa;
            --glass-white: rgba(255, 255, 255, 0.95);
            --logo-gradient: linear-gradient(135deg, #000000 0%, var(--accent-purple) 50%, #10b981 100%);
            --delete-red: #ef4444;
        }

        /* Prevent Highlight & Long Press Native Menus */
        * { 
            -webkit-tap-highlight-color: transparent; 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            user-select: none;
            box-sizing: border-box; 
            outline: none;
        }

        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-primary); overflow-x: hidden; }

        /* --- Notification Alert --- */
        .notification-alert {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-purple);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 6000;
            transition: top 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            text-align: center;
        }

        .notification-alert.show {
            top: 20px;
        }

        /* --- Shimmer Animation --- */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmerEffect 1.5s infinite linear;
        }
        @keyframes shimmerEffect { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        /* --- Header --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--glass-white);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; backdrop-filter: blur(12px); border-bottom: 1px solid #eee;
        }
        .user-profile { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-purple); cursor: pointer; }
        .app-title { font-size: 24px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1.2px; }

        /* --- Pill Navigation --- */
        .pill-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: #000; width: 240px; height: 64px; border-radius: 40px;
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 10px; z-index: 2000; box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .nav-item { color: #666; display: flex; flex-direction: column; align-items: center; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: #fff; }
        .nav-item span { font-size: 26px; }

        /* --- Main Content Areas --- */
        main { padding: 90px 16px 120px 16px; min-height: 100vh; }
        #statusTab { display: none; }

        /* --- Chat List Styling --- */
        .chat-card {
            display: flex; align-items: center; padding: 15px; 
            background: #fff; margin-bottom: 12px; border-radius: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }
        .avatar-box { margin-right: 15px; flex-shrink: 0; }
        .avatar { width: 58px; height: 58px; border-radius: 18px; object-fit: cover; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: 700; font-size: 15px; display: block; color: #111; }
        .chat-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-top: 2px; }

        /* --- Status (Moments) Grid --- */
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .status-card {
            position: relative; height: 280px; border-radius: 30px; overflow: hidden;
            background: #eee; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .status-card:active { transform: scale(0.95); }
        .status-card img, .status-card video { width: 100%; height: 100%; object-fit: cover; }
        .status-info { position: absolute; bottom: 0; width: 100%; padding: 15px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: #fff; font-size: 13px; }

        /* --- Status Controls --- */
        .status-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .status-control-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            font-size: 12px;
            font-weight: 500;
        }

        .status-control-btn:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.05);
        }

        .status-control-btn:active {
            transform: scale(0.95);
        }

        .status-control-btn.liked {
            background: var(--accent-purple);
            color: white;
        }

        .status-control-btn.delete {
            background: var(--delete-red);
            color: white;
        }

        .status-control-btn.delete:hover {
            background: #dc2626;
        }

        .control-icon {
            font-size: 16px;
            transition: transform 0.2s;
        }

        .control-count {
            font-size: 11px;
            font-weight: 600;
            min-width: 15px;
            text-align: center;
        }

        /* --- View Count & Viewers --- */
        .view-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            font-size: 11px;
            font-weight: 500;
            z-index: 5;
        }

        .view-indicator:hover {
            background: rgba(0,0,0,0.9);
        }

        /* --- Story Viewer Like Button --- */
        .story-like-btn {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 30;
            backdrop-filter: blur(10px);
            font-size: 14px;
            font-weight: 500;
        }

        .story-like-btn:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.05);
        }

        .story-like-btn.liked {
            background: var(--accent-purple);
            color: white;
        }

        .story-like-btn.liked:hover {
            background: #c026d3;
        }

        /* --- Viewers Bottom Sheet --- */
        .viewers-sheet {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: #fff;
            border-radius: 25px 25px 0 0;
            padding: 25px;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2600;
            max-height: 70vh;
            overflow-y: auto;
        }

        .viewers-sheet.active {
            bottom: 0;
        }

        .viewers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .viewers-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .viewers-count {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .viewer-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f8f8f8;
        }

        .viewer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
        }

        .viewer-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .viewer-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        /* --- Animations --- */
        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }

        @keyframes floatUp {
            0% { 
                transform: translateY(0) scale(0);
                opacity: 1;
            }
            100% { 
                transform: translateY(-30px) scale(1.5);
                opacity: 0;
            }
        }

        .status-control-btn.animating .control-icon {
            animation: heartBeat 0.6s ease-in-out;
        }

        .like-float {
            position: absolute;
            color: var(--accent-purple);
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }

        /* --- Delete Confirmation --- */
        .delete-confirm-sheet {
            padding: 30px 25px;
        }

        .delete-warning {
            text-align: center;
            margin-bottom: 25px;
        }

        .delete-icon {
            font-size: 48px;
            color: var(--delete-red);
            margin-bottom: 15px;
        }

        .delete-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .delete-message {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .delete-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .delete-actions .btn-primary {
            flex: 1;
            margin: 0;
        }

        .delete-actions .btn-primary.cancel {
            background: var(--bg-color);
            color: var(--text-primary);
        }

        .delete-actions .btn-primary.confirm {
            background: var(--delete-red);
        }
    </style>
</head>
<body>

    <!-- Notification Alert -->
    <div id="notificationAlert" class="notification-alert">
        <span class="material-symbols-rounded">favorite</span>
        <span id="alertText">Someone liked your status!</span>
    </div>

    <div id="toast"></div>

    <header>
        <div onclick="openSheet('settingsSheet')">
            <img id="myAvatar" class="user-profile shimmer" src="">
        </div>
        <div class="app-title">Vynix</div>
        <span class="material-symbols-rounded" style="color:#000; font-size:28px;" onclick="openSheet('addFriendSheet')">add_circle</span>
    </header>

   <main id="chatsTab">
    <div class="search-container">
        <input type="text" class="search-input" id="friendSearch" placeholder="Search friends..." onkeyup="searchFriends()">
        <span class="material-symbols-rounded search-icon">search</span>
        <span class="material-symbols-rounded clear-search" id="clearSearch" onclick="clearSearch()">close</span>
    </div>
    <div id="chatList">
        <div class="chat-card shimmer" style="height: 90px; opacity: 0.5;"></div>
        <div class="chat-card shimmer" style="height: 90px; opacity: 0.5;"></div>
    </div>
</main>

    <main id="statusTab">
        <div class="btn-primary" onclick="document.getElementById('fileUpload').click()" style="margin-bottom:20px; background:var(--accent-purple);">
            <span class="material-symbols-rounded" style="vertical-align:middle; margin-right:8px;">add_photo_alternate</span> Post a Moment
        </div>
        <div class="status-grid" id="statusGrid"></div>
    </main>

    <input type="file" id="fileUpload" hidden accept="image/*,video/*" onchange="validateAndUpload(this.files[0])">

    <div id="storyViewer" onclick="handleStoryTap(event)">
        <div class="story-progress" id="storyProgressBars"></div>
        <div class="story-header" id="storyHeaderInfo"></div>
        <div id="storyMedia"></div>
    </div>

    <!-- Viewers Bottom Sheet -->
    <div class="viewers-sheet" id="viewersSheet">
        <div class="viewers-header">
            <div>
                <div class="viewers-title">Viewers</div>
                <div class="viewers-count" id="viewersCount">0 viewers</div>
            </div>
            <span class="material-symbols-rounded" style="cursor:pointer;" onclick="closeViewersSheet()">close</span>
        </div>
        <div id="viewersList"></div>
    </div>

    <!-- Delete Confirmation Sheet -->
    <div class="bottom-sheet delete-confirm-sheet" id="deleteConfirmSheet">
        <div class="delete-warning">
            <div class="delete-icon">
                <span class="material-symbols-rounded" style="font-size:48px;">delete_forever</span>
            </div>
            <div class="delete-title">Delete Status?</div>
            <div class="delete-message">This will permanently delete your status and all likes will be lost. This action cannot be undone.</div>
        </div>
        <div class="delete-actions">
            <button class="btn-primary cancel" onclick="closeDeleteConfirm()">Cancel</button>
            <button class="btn-primary confirm" onclick="confirmDeleteStatus()">Delete</button>
        </div>
    </div>

    <div class="pill-nav">
        <div class="nav-item active" id="navChats" onclick="switchTab('chats')">
            <span class="material-symbols-rounded">chat_bubble</span>
        </div>
        <div class="nav-item" id="navStatus" onclick="switchTab('status')">
            <span class="material-symbols-rounded">explore</span>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>
    
    <div class="bottom-sheet" id="addFriendSheet">
        <h2 style="margin-top:0">Add Friend</h2>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:20px;">Enter their unique Vynix ID to start chatting.</p>
        <input type="text" id="friendVynixId" class="v-input" placeholder="e.g. vnx_789">
        <button class="btn-primary" id="addSubmitBtn" onclick="addFriendLogic()">Search & Add</button>
    </div>

    <div class="bottom-sheet" id="settingsSheet">
        <h2>Settings</h2>
        <input type="text" id="editDisplayName" class="v-input" placeholder="Display Name">
        
        <!-- Notification Toggle -->
        <div class="notification-toggle">
            <span class="notification-label">Push Notifications</span>
            <div class="toggle-switch" id="notificationToggle" onclick="toggleNotifications()">
                <div class="toggle-slider"></div>
            </div>
        </div>
        
        <button class="btn-primary" onclick="updateProfile()">Save Changes</button>
        <button class="btn-primary" style="background:#f1f1f1; color:red; margin-top:12px;" onclick="auth.signOut()">Logout</button>
    </div>

    <div id="profileDetail" class="profile-modal" onclick="this.style.display='none'">
        <div class="profile-card" onclick="event.stopPropagation()">
            <img id="detailImg" src="" style="width:130px; height:130px; border-radius:30px; object-fit:cover; margin-bottom:15px; border:4px solid var(--accent-purple);">
            <h2 id="detailName" style="margin:0"></h2>
            <div id="detailId" style="color:var(--accent-purple); font-weight:700; margin-top:5px;"></div>
            <hr style="border:0; border-top:1px solid #f0f0f0; margin:25px 0;">
            <div style="font-size:13px; color:#999; font-weight:700; cursor:pointer;" onclick="document.getElementById('profileDetail').style.display='none'">CLOSE</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- Configuration ---
        const CLOUD_NAME = "dqkujefxj"; 
        const UPLOAD_PRESET = "banter_box";
        const secretBase = "Vynix_E2EE_Core_";
        const VAPID_PUBLIC_KEY = 'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuFGkrN1V6Bh5ay3mW3K3arMGo';

        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let myVId = "";
        let storyQueue = [];
        let storyIndex = 0;
        let storyTimer;
        let statusToDelete = null; // Track status being deleted
        let currentViewers = []; // Track current status viewers

        // --- Push Notification Manager ---
        class PushNotificationManager {
            constructor() {
                this.isSupported = 'Notification' in window && 'serviceWorker' in navigator;
                this.isSubscribed = false;
                this.subscription = null;
            }

            async init() {
                if (!this.isSupported) {
                    console.log('Push notifications not supported');
                    return;
                }

                await this.requestPermission();
                if (this.isSubscribed) {
                    await this.getExistingSubscription();
                }
            }

            async requestPermission() {
                if (Notification.permission === 'granted') {
                    this.isSubscribed = true;
                    return true;
                }

                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        this.isSubscribed = true;
                        return true;
                    }
                }

                return false;
            }

            async subscribeToPush() {
                if (!this.isSupported || !this.isSubscribed) return null;

                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });

                    this.subscription = subscription;
                    await this.saveSubscription(subscription);
                    return subscription;
                } catch (error) {
                    console.log('Failed to subscribe to push:', error);
                    return null;
                }
            }

            async getExistingSubscription() {
                if (!this.isSupported) return null;

                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.getSubscription();
                    
                    if (subscription) {
                        this.subscription = subscription;
                        return subscription;
                    }
                } catch (error) {
                    console.log('Failed to get existing subscription:', error);
                }
                
                return null;
            }

            async saveSubscription(subscription) {
                if (!currentUser) return;

                const subscriptionData = {
                    endpoint: subscription.endpoint,
                    keys: {
                        p256dh: subscription.toJSON().keys.p256dh,
                        auth: subscription.toJSON().keys.auth
                    },
                    timestamp: Date.now()
                };

                await db.ref(`users/${currentUser.uid}/pushSubscription`).set(subscriptionData);
            }

            urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding)
                    .replace(/\-/g, '+')
                    .replace(/_/g, '/');

                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);

                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            async sendNotification(title, body, icon = null, url = null) {
                if (!this.isSupported || !this.isSubscribed) return;

                const notificationData = {
                    title: title,
                    body: body,
                    icon: icon || 'https://via.placeholder.com/192x192/d946ef/ffffff?text=V',
                    tag: 'vynix-message',
                    url: url
                };

                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.ready;
                    registration.showNotification(notificationData.title, {
                        body: notificationData.body,
                        icon: notificationData.icon,
                        badge: 'https://via.placeholder.com/72x72/d946ef/ffffff?text=V',
                        vibrate: [200, 100, 200],
                        tag: notificationData.tag,
                        data: { url: notificationData.url }
                    });
                }
            }
        }

        // Initialize Push Notification Manager
        const pushManager = new PushNotificationManager();

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initApp();
            } else { window.location.href = "login.html"; }
        });

        async function initApp() {
            const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            const data = snap.val();
            if (data) {
                myVId = data.vynixId;
                document.getElementById('myAvatar').src = data.photo;
                document.getElementById('editDisplayName').value = data.name;
                document.getElementById('myAvatar').classList.remove('shimmer');
            }
            
            await pushManager.init();
            await checkNotificationStatus();
            loadChats();
            loadMoments();
        }

        // --- Notification Alert ---
        function showNotificationAlert(message) {
            const alert = document.getElementById('notificationAlert');
            document.getElementById('alertText').textContent = message;
            alert.classList.add('show');
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // --- Add Friend Logic ---
        async function addFriendLogic() {
            const btn = document.getElementById('addSubmitBtn');
            const rawId = document.getElementById('friendVynixId').value.trim().toLowerCase();
            const vid = rawId.startsWith('@') ? rawId.substring(1) : rawId;

            if(!vid || vid === myVId) {
                return toast(vid === myVId ? "That's you!" : "Invalid ID");
            }

            btn.disabled = true;
            btn.innerText = "Searching...";

            try {
                const idSnap = await db.ref(`vynix_ids/${vid}`).once('value');
                if(!idSnap.exists()) {
                    toast("User not found");
                } else {
                    const targetUid = idSnap.val();
                    const existing = await db.ref(`users/${currentUser.uid}/chats/${targetUid}`).once('value');
                    if(existing.exists()) {
                        toast("Friend already added!");
                    } else {
                        const targetProfile = (await db.ref(`users/${targetUid}/profile`).once('value')).val();
                        await db.ref(`users/${currentUser.uid}/chats/${targetUid}`).set({
                            name: targetProfile.name,
                            photo: targetProfile.photo,
                            lastMsg: "Connected via Vynix ID",
                            ts: Date.now()
                        });
                        toast("Success! Friend added.");
                        closeAll();
                        document.getElementById('friendVynixId').value = "";
                    }
                }
            } catch(e) {
                toast("Error connecting to server");
            } finally {
                btn.disabled = false;
                btn.innerText = "Search & Add";
            }
        }

        // --- Status Management with Delete & View Tracking ---
        async function validateAndUpload(file) {
            if(!file) return;
            
            if(file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(video.src);
                    if(video.duration > 61) {
                        toast("Video too long! (Max 1 min)");
                    } else {
                        performUpload(file);
                    }
                };
                video.src = URL.createObjectURL(file);
            } else {
                performUpload(file);
            }
        }

        async function performUpload(file) {
            toast("Posting Moment...");
            const form = new FormData();
            form.append('file', file);
            form.append('upload_preset', UPLOAD_PRESET);
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method:'POST', body:form });
                const data = await res.json();
                if(data.secure_url) {
                    const momentData = {
                        url: data.secure_url, 
                        type: data.resource_type, 
                        ts: Date.now(),
                        name: currentUser.displayName || "User", 
                        photo: currentUser.photoURL,
                        ownerId: currentUser.uid,
                        likes: {},
                        views: {}
                    };
                    
                    await db.ref(`moments/${currentUser.uid}`).push(momentData);
                    toast("Moment is live!");
                }
            } catch(e) { 
                toast("Upload failed"); 
            }
        }

        function loadMoments() {
            db.ref('moments').on('value', snap => {
                const grid = document.getElementById('statusGrid');
                grid.innerHTML = "";
                const now = Date.now();
                
                snap.forEach(userNode => {
                    let items = [];
                    let totalLikes = 0;
                    let totalViews = 0;
                    
                    userNode.forEach(m => { 
                        if(now - m.val().ts < 86400000) {
                            items.push({
                                key: m.key,
                                val: m.val()
                            });
                            if (m.val().likes) totalLikes += Object.keys(m.val().likes).length;
                            if (m.val().views) totalViews += Object.keys(m.val().views).length;
                        } 
                    });
                    
                    if(items.length) {
                        const last = items[items.length-1];
                        let userLiked = false;
                        items.forEach(item => {
                            if (item.val.likes && item.val.likes[currentUser.uid]) {
                                userLiked = true;
                            }
                        });
                        
                        const isOwner = last.val.ownerId === currentUser.uid;
                        
                        grid.innerHTML += `
                            <div class="status-card" data-owner="${last.val.ownerId}" data-moment="${last.key}" onclick="openStories('${userNode.key}')">
                                ${last.val.type === 'video' ? `<video src="${last.val.url}"></video>` : `<img src="${last.val.url}">`}
                                <div class="status-info"><b>${last.val.name}</b></div>
                                
                                <!-- View Indicator -->
                                <div class="view-indicator" onclick="showViewers(event, '${userNode.key}', '${last.key}')">
                                    <span class="material-symbols-rounded" style="font-size:14px;">visibility</span>
                                    <span>${totalViews}</span>
                                </div>
                                
                                <!-- Status Controls -->
                                <div class="status-controls">
                                    ${isOwner ? `
                                        <button class="status-control-btn delete" onclick="deleteStatus(event, '${userNode.key}', '${last.key}')" title="Delete Status">
                                            <span class="material-symbols-rounded control-icon">delete</span>
                                        </button>
                                    ` : ''}
                                    
                                    <button class="status-control-btn ${userLiked ? 'liked' : ''}" onclick="toggleLike(event, '${userNode.key}', '${last.key}')" title="Like Status">
                                        <span class="material-symbols-rounded control-icon">
                                            ${userLiked ? 'favorite' : 'favorite_border'}
                                        </span>
                                        <span class="control-count">${totalLikes > 0 ? totalLikes : ''}</span>
                                    </button>
                                </div>
                            </div>`;
                    }
                });
            });
        }

        function openStories(uid) {
            db.ref(`moments/${uid}`).once('value', snap => {
                storyQueue = [];
                snap.forEach(s => { 
                    if(Date.now() - s.val().ts < 86400000) {
                        storyQueue.push({
                            ...s.val(),
                            key: s.key,
                            uid: uid
                        }); 
                    }
                });
                
                if(storyQueue.length > 0) {
                    storyIndex = 0;
                    document.getElementById('storyViewer').style.display = 'block';
                    
                    // Track view for current user
                    trackStatusView(uid, storyQueue[0].key);
                    showStory();
                }
            });
        }

        function showStory() {
            clearTimeout(storyTimer);
            if(storyIndex >= storyQueue.length) return closeStoryViewer();
            if(storyIndex < 0) storyIndex = 0;

            const story = storyQueue[storyIndex];
            const media = document.getElementById('storyMedia');
            const progress = document.getElementById('storyProgressBars');
            const header = document.getElementById('storyHeaderInfo');

            // Get stats for current story
            const likeCount = story.likes ? Object.keys(story.likes).length : 0;
            const viewCount = story.views ? Object.keys(story.views).length : 0;
            const isLiked = story.likes && story.likes[currentUser.uid];
            const isOwner = story.ownerId === currentUser.uid;

            header.innerHTML = `
                <img src="${story.photo}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"> 
                <b>${story.name}</b>
                <span style="margin-left:auto; margin-right:10px; font-size:12px; opacity:0.8;">
                    ${likeCount > 0 ? `‚ù§Ô∏è ${likeCount}` : ''} ${viewCount > 0 ? `üëÅÔ∏è ${viewCount}` : ''}
                </span>
            `;

            createStoryControls(story, likeCount, viewCount, isLiked, isOwner);

            media.innerHTML = story.type === 'video' ? 
                `<video src="${story.url}" autoplay playsinline></video>` : 
                `<img src="${story.url}">`;

            progress.innerHTML = storyQueue.map((_, i) => `
                <div class="progress-segment">
                    <div class="progress-fill" style="width: ${i < storyIndex ? '100%' : '0%'}"></div>
                </div>`).join('');

            setTimeout(() => {
                const bar = progress.querySelectorAll('.progress-fill')[storyIndex];
                bar.style.transition = 'width 5s linear';
                bar.style.width = '100%';
            }, 50);

            storyTimer = setTimeout(() => { storyIndex++; showStory(); }, 5000);
        }

        function createStoryControls(story, likeCount, viewCount, isLiked, isOwner) {
            // Remove existing controls
            const existingControls = document.querySelectorAll('.story-control');
            existingControls.forEach(control => control.remove());

            // Like button
            const likeBtn = document.createElement('button');
            likeBtn.className = `story-control-btn story-like-btn ${isLiked ? 'liked' : ''}`;
            likeBtn.style.cssText = 'position: absolute; bottom: 100px; right: 20px; z-index: 30;';
            likeBtn.innerHTML = `
                <span class="material-symbols-rounded control-icon" style="font-size: 20px;">
                    ${isLiked ? 'favorite' : 'favorite_border'}
                </span>
                <span class="control-count">${likeCount > 0 ? likeCount : ''}</span>
            `;
            likeBtn.onclick = (e) => {
                e.stopPropagation();
                toggleStoryLike(e, story);
            };

            // View count button
            const viewBtn = document.createElement('button');
            viewBtn.className = 'story-control-btn';
            viewBtn.style.cssText = 'position: absolute; bottom: 100px; left: 20px; z-index: 30;';
            viewBtn.innerHTML = `
                <span class="material-symbols-rounded control-icon" style="font-size: 20px;">visibility</span>
                <span class="control-count">${viewCount > 0 ? viewCount : ''}</span>
            `;
            viewBtn.onclick = (e) => {
                e.stopPropagation();
                showStoryViewers(e, story);
            };

            // Delete button (if owner)
            if (isOwner) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'story-control-btn delete';
                deleteBtn.style.cssText = 'position: absolute; top: 80px; right: 20px; z-index: 30;';
                deleteBtn.innerHTML = `
                    <span class="material-symbols-rounded control-icon" style="font-size: 20px;">delete</span>
                `;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteStory(e, story.uid, story.key);
                };

                document.getElementById('storyViewer').appendChild(deleteBtn);
            }

            document.getElementById('storyViewer').appendChild(likeBtn);
            document.getElementById('storyViewer').appendChild(viewBtn);
        }

        async function trackStatusView(userId, momentId) {
            if (!currentUser || userId === currentUser.uid) return; // Don't track owner's own views
            
            const viewRef = db.ref(`moments/${userId}/${momentId}/views/${currentUser.uid}`);
            await viewRef.set({
                timestamp: Date.now(),
                userName: currentUser.displayName || "User",
                userPhoto: currentUser.photoURL || ""
            });
        }

        async function toggleLike(event, userId, momentId) {
            event.stopPropagation();
            
            const likeRef = db.ref(`moments/${userId}/${momentId}/likes/${currentUser.uid}`);
            const currentLike = await likeRef.once('value');
            
            // Create floating like animation
            const rect = event.currentTarget.getBoundingClientRect();
            createFloatingLike(rect.left + rect.width/2, rect.top + rect.height/2);
            
            if (currentLike.exists()) {
                // Unlike
                await likeRef.remove();
            } else {
                // Like
                await likeRef.set({
                    timestamp: Date.now(),
                    userName: currentUser.displayName || "User"
                });
                
                // Send notification to status owner (if not self-like)
                if (userId !== currentUser.uid) {
                    const ownerProfile = await db.ref(`users/${userId}/profile`).once('value');
                    const ownerData = ownerProfile.val();
                    
                    if (ownerData) {
                        showNotificationAlert(`${currentUser.displayName} liked your status!`);
                        
                        // Send push notification
                        const ownerSub = await db.ref(`users/${userId}/pushSubscription`).once('value');
                        if (ownerSub.exists()) {
                            pushManager.sendNotification(
                                `${currentUser.displayName} liked your status`,
                                '',
                                currentUser.photoURL
                            );
                        }
                    }
                }
            }
            
            // Add animation
            const button = event.currentTarget;
            button.classList.add('animating');
            setTimeout(() => button.classList.remove('animating'), 600);
        }

        async function toggleStoryLike(event, story) {
            event.stopPropagation();
            
            const userId = story.uid;
            const momentId = story.key;
            
            const likeRef = db.ref(`moments/${userId}/${momentId}/likes/${currentUser.uid}`);
            const currentLike = await likeRef.once('value');
            
            // Create floating like animation
            const rect = event.currentTarget.getBoundingClientRect();
            createFloatingLike(rect.left + rect.width/2, rect.top);
            
            if (currentLike.exists()) {
                // Unlike
                await likeRef.remove();
            } else {
                // Like
                await likeRef.set({
                    timestamp: Date.now(),
                    userName: currentUser.displayName || "User"
                });
                
                // Send notification to status owner
                if (userId !== currentUser.uid) {
                    showNotificationAlert(`${currentUser.displayName} liked your status!");
                    
                    const ownerSub = await db.ref(`users/${userId}/pushSubscription`).once('value');
                    if (ownerSub.exists()) {
                        pushManager.sendNotification(
                            `${currentUser.displayName} liked your status`,
                            '',
                            currentUser.photoURL
                        );
                    }
                }
            }
            
            // Add animation
            const button = event.currentTarget;
            button.classList.add('animating');
            setTimeout(() => button.classList.remove('animating'), 600);
            
            // Refresh current story
            refreshCurrentStory();
        }

        function createFloatingLike(x, y) {
            const floatingLike = document.createElement('div');
            floatingLike.className = 'like-float material-symbols-rounded';
            floatingLike.textContent = 'favorite';
            floatingLike.style.left = x + 'px';
            floatingLike.style.top = y + 'px';
            
            document.body.appendChild(floatingLike);
            
            setTimeout(() => {
                floatingLike.remove();
            }, 1000);
        }

        async function refreshCurrentStory() {
            const currentStory = storyQueue[storyIndex];
            const userId = currentStory.uid;
            const momentId = currentStory.key;
            
            const updatedStory = await db.ref(`moments/${userId}/${momentId}`).once('value');
            if (updatedStory.exists()) {
                storyQueue[storyIndex] = updatedStory.val();
                storyQueue[storyIndex].key = momentId;
                storyQueue[storyIndex].uid = userId;
                showStory();
            }
        }

        async function deleteStatus(event, userId, momentId) {
            event.stopPropagation();
            
            // Find the status data
            const statusSnap = await db.ref(`moments/${userId}/${momentId}`).once('value');
            if (!statusSnap.exists()) return;
            
            const statusData = statusSnap.val();
            
            // Confirm ownership
            if (statusData.ownerId !== currentUser.uid) {
                toast("You can only delete your own status");
                return;
            }
            
            // Store for confirmation
            statusToDelete = { userId, momentId, statusData };
            
            // Show confirmation sheet
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('deleteConfirmSheet').classList.add('active');
        }

        function closeDeleteConfirm() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('deleteConfirmSheet').classList.remove('active');
            statusToDelete = null;
        }

        async function confirmDeleteStatus() {
            if (!statusToDelete) return;
            
            try {
                await db.ref(`moments/${statusToDelete.userId}/${statusToDelete.momentId}`).remove();
                toast("Status deleted");
                closeDeleteConfirm();
                
                // If we're currently viewing this story, close the viewer
                if (document.getElementById('storyViewer').style.display === 'block') {
                    const currentStory = storyQueue[storyIndex];
                    if (currentStory && currentStory.key === statusToDelete.momentId) {
                        closeStoryViewer();
                    }
                }
            } catch (error) {
                toast("Failed to delete status");
                console.error("Delete error:", error);
            }
        }

        async function showViewers(event, userId, momentId) {
            event.stopPropagation();
            
            const viewersSnap = await db.ref(`moments/${userId}/${momentId}/views`).once('value');
            const viewers = [];
            
            viewersSnap.forEach(view => {
                viewers.push({
                    uid: view.key,
                    ...view.val()
                });
            });
            
            // Sort by timestamp (most recent first)
            viewers.sort((a, b) => b.timestamp - a.timestamp);
            
            currentViewers = viewers;
            displayViewers(viewers);
        }

        async function showStoryViewers(event, story) {
            event.stopPropagation();
            
            const viewersSnap = await db.ref(`moments/${story.uid}/${story.key}/views`).once('value');
            const viewers = [];
            
            viewersSnap.forEach(view => {
                viewers.push({
                    uid: view.key,
                    ...view.val()
                });
            });
            
            viewers.sort((a, b) => b.timestamp - a.timestamp);
            currentViewers = viewers;
            displayViewers(viewers);
        }

        function displayViewers(viewers) {
            const sheet = document.getElementById('viewersSheet');
            const list = document.getElementById('viewersList');
            const count = document.getElementById('viewersCount');
            
            count.textContent = `${viewers.length} viewer${viewers.length !== 1 ? 's' : ''}`;
            
            if (viewers.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No viewers yet</div>';
            } else {
                list.innerHTML = viewers.map(viewer => `
                    <div class="viewer-item" onclick="viewProfile('${viewer.uid}')">
                        <img class="viewer-avatar" src="${viewer.userPhoto || 'https://via.placeholder.com/40x40/cccccc/666666?text=?'}" 
                             onerror="this.src='https://via.placeholder.com/40x40/cccccc/666666?text=?'">
                        <div class="viewer-name">${viewer.userName || 'Unknown User'}</div>
                        <div class="viewer-time">${formatTimeAgo(viewer.timestamp)}</div>
                    </div>
                `).join('');
            }
            
            document.getElementById('overlay').style.display = 'block';
            sheet.classList.add('active');
        }

        function closeViewersSheet() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('viewersSheet').classList.remove('active');
            currentViewers = [];
        }

        function viewProfile(uid) {
            // Implement profile viewing functionality
            // For now, just close the sheet
            closeViewersSheet();
            // You could navigate to a profile page here
            // window.location.href = `profile.html?user=${uid}`;
        }

        // --- Story Viewer Functions ---
        function openStories(uid) {
            db.ref(`moments/${uid}`).once('value', snap => {
                storyQueue = [];
                snap.forEach(s => { 
                    if(Date.now() - s.val().ts < 86400000) {
                        storyQueue.push({
                            ...s.val(),
                            key: s.key,
                            uid: uid
                        }); 
                    }
                });
                
                if(storyQueue.length > 0) {
                    storyIndex = 0;
                    document.getElementById('storyViewer').style.display = 'block';
                    
                    // Track view for current story
                    trackStatusView(uid, storyQueue[0].key);
                    showStory();
                }
            });
        }

        function showStory() {
            clearTimeout(storyTimer);
            if(storyIndex >= storyQueue.length) return closeStoryViewer();
            if(storyIndex < 0) storyIndex = 0;

            const story = storyQueue[storyIndex];
            const media = document.getElementById('storyMedia');
            const progress = document.getElementById('storyProgressBars');
            const header = document.getElementById('storyHeaderInfo');

            // Get stats for current story
            const likeCount = story.likes ? Object.keys(story.likes).length : 0;
            const viewCount = story.views ? Object.keys(story.views).length : 0;
            const isLiked = story.likes && story.likes[currentUser.uid];
            const isOwner = story.ownerId === currentUser.uid;

            header.innerHTML = `
                <img src="${story.photo}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"> 
                <b>${story.name}</b>
                <span style="margin-left:auto; margin-right:10px; font-size:12px; opacity:0.8;">
                    ${likeCount > 0 ? `‚ù§Ô∏è ${likeCount}` : ''} ${viewCount > 0 ? `üëÅÔ∏è ${viewCount}` : ''}
                </span>
            `;

            createStoryViewerControls(story, likeCount, viewCount, isLiked, isOwner);

            media.innerHTML = story.type === 'video' ? 
                `<video src="${story.url}" autoplay playsinline></video>` : 
                `<img src="${story.url}">`;

            progress.innerHTML = storyQueue.map((_, i) => `
                <div class="progress-segment">
                    <div class="progress-fill" style="width: ${i < storyIndex ? '100%' : '0%'}"></div>
                </div>`).join('');

            setTimeout(() => {
                const bar = progress.querySelectorAll('.progress-fill')[storyIndex];
                bar.style.transition = 'width 5s linear';
                bar.style.width = '100%';
            }, 50);

            storyTimer = setTimeout(() => { storyIndex++; showStory(); }, 5000);
        }

        function createStoryViewerControls(story, likeCount, viewCount, isLiked, isOwner) {
            // Remove existing controls
            const existingControls = document.querySelectorAll('.story-control');
            existingControls.forEach(control => control.remove());

            // Like button
            const likeBtn = document.createElement('button');
            likeBtn.className = `story-control-btn story-like-btn ${isLiked ? 'liked' : ''}`;
            likeBtn.style.cssText = 'position: absolute; bottom: 100px; right: 20px; z-index: 30;';
            likeBtn.innerHTML = `
                <span class="material-symbols-rounded control-icon" style="font-size: 20px;">
                    ${isLiked ? 'favorite' : 'favorite_border'}
                </span>
                <span class="control-count">${likeCount > 0 ? likeCount : ''}</span>
            `;
            likeBtn.onclick = (e) => {
                e.stopPropagation();
                toggleStoryLike(e, story);
            };

            // View count button
            const viewBtn = document.createElement('button');
            viewBtn.className = 'story-control-btn';
            viewBtn.style.cssText = 'position: absolute; bottom: 100px; left: 20px; z-index: 30;';
            viewBtn.innerHTML = `
                <span class="material-symbols-rounded control-icon" style="font-size: 20px;">visibility</span>
                <span class="control-count">${viewCount > 0 ? viewCount : ''}</span>
            `;
            viewBtn.onclick = (e) => {
                e.stopPropagation();
                showStoryViewers(e, story);
            };

            // Delete button (if owner)
            if (isOwner) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'story-control-btn delete';
                deleteBtn.style.cssText = 'position: absolute; top: 80px; right: 20px; z-index: 30;';
                deleteBtn.innerHTML = `
                    <span class="material-symbols-rounded control-icon" style="font-size: 20px;">delete</span>
                `;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteStatus(e, story.uid, story.key);
                };

                document.getElementById('storyViewer').appendChild(deleteBtn);
            }

            document.getElementById('storyViewer').appendChild(likeBtn);
            document.getElementById('storyViewer').appendChild(viewBtn);
        }

        async function trackStatusView(userId, momentId) {
            if (!currentUser || userId === currentUser.uid) return;
            
            const viewRef = db.ref(`moments/${userId}/${momentId}/views/${currentUser.uid}`);
            await viewRef.set({
                timestamp: Date.now(),
                userName: currentUser.displayName || "User",
                userPhoto: currentUser.photoURL || ""
            });
        }

        async function toggleStoryLike(event, story) {
            event.stopPropagation();
            
            const userId = story.uid;
            const momentId = story.key;
            
            const likeRef = db.ref(`moments/${userId}/${momentId}/likes/${currentUser.uid}`);
            const currentLike = await likeRef.once('value');
            
            // Create floating like animation
            const rect = event.currentTarget.getBoundingClientRect();
            createFloatingLike(rect.left + rect.width/2, rect.top);
            
            if (currentLike.exists()) {
                // Unlike
                await likeRef.remove();
            } else {
                // Like
                await likeRef.set({
                    timestamp: Date.now(),
                    userName: currentUser.displayName || "User"
                });
                
                // Send notification to status owner
                if (userId !== currentUser.uid) {
                    showNotificationAlert(`${currentUser.displayName} liked your status!`);
                    
                    const ownerSub = await db.ref(`users/${userId}/pushSubscription`).once('value');
                    if (ownerSub.exists()) {
                        pushManager.sendNotification(
                            `${currentUser.displayName} liked your status`,
                            '',
                            currentUser.photoURL
                        );
                    }
                }
            }
            
            // Add animation
            const button = event.currentTarget;
            button.classList.add('animating');
            setTimeout(() => button.classList.remove('animating'), 600);
            
            // Refresh current story
            refreshCurrentStory();
        }

        function createFloatingLike(x, y) {
            const floatingLike = document.createElement('div');
            floatingLike.className = 'like-float material-symbols-rounded';
            floatingLike.textContent = 'favorite';
            floatingLike.style.left = x + 'px';
            floatingLike.style.top = y + 'px';
            
            document.body.appendChild(floatingLike);
            
            setTimeout(() => {
                floatingLike.remove();
            }, 1000);
        }

        async function refreshCurrentStory() {
            const currentStory = storyQueue[storyIndex];
            const userId = currentStory.uid;
            const momentId = currentStory.key;
            
            const updatedStory = await db.ref(`moments/${userId}/${momentId}`).once('value');
            if (updatedStory.exists()) {
                storyQueue[storyIndex] = updatedStory.val();
                storyQueue[storyIndex].key = momentId;
                storyQueue[storyIndex].uid = userId;
                showStory();
            }
        }

        async function deleteStatus(event, userId, momentId) {
            event.stopPropagation();
            
            const statusSnap = await db.ref(`moments/${userId}/${momentId}`).once('value');
            if (!statusSnap.exists()) return;
            
            const statusData = statusSnap.val();
            
            if (statusData.ownerId !== currentUser.uid) {
                toast("You can only delete your own status");
                return;
            }
            
            statusToDelete = { userId, momentId, statusData };
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('deleteConfirmSheet').classList.add('active');
        }

        function closeDeleteConfirm() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('deleteConfirmSheet').classList.remove('active');
            statusToDelete = null;
        }

        async function confirmDeleteStatus() {
            if (!statusToDelete) return;
            
            try {
                await db.ref(`moments/${statusToDelete.userId}/${statusToDelete.momentId}`).remove();
                toast("Status deleted");
                closeDeleteConfirm();
                
                if (document.getElementById('storyViewer').style.display === 'block') {
                    const currentStory = storyQueue[storyIndex];
                    if (currentStory && currentStory.key === statusToDelete.momentId) {
                        closeStoryViewer();
                    }
                }
            } catch (error) {
                toast("Failed to delete status");
                console.error("Delete error:", error);
            }
        }

        async function showViewers(event, userId, momentId) {
            event.stopPropagation();
            
            const viewersSnap = await db.ref(`moments/${userId}/${momentId}/views`).once('value');
            const viewers = [];
            
            viewersSnap.forEach(view => {
                viewers.push({
                    uid: view.key,
                    ...view.val()
                });
            });
            
            viewers.sort((a, b) => b.timestamp - a.timestamp);
            currentViewers = viewers;
            displayViewers(viewers);
        }

        async function showStoryViewers(event, story) {
            event.stopPropagation();
            
            const viewersSnap = await db.ref(`moments/${story.uid}/${story.key}/views`).once('value');
            const viewers = [];
            
            viewersSnap.forEach(view => {
                viewers.push({
                    uid: view.key,
                    ...view.val()
                });
            });
            
            viewers.sort((a, b) => b.timestamp - a.timestamp);
            currentViewers = viewers;
            displayViewers(viewers);
        }

        function displayViewers(viewers) {
            const sheet = document.getElementById('viewersSheet');
            const list = document.getElementById('viewersList');
            const count = document.getElementById('viewersCount');
            
            count.textContent = `${viewers.length} viewer${viewers.length !== 1 ? 's' : ''}`;
            
            if (viewers.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No viewers yet</div>';
            } else {
                list.innerHTML = viewers.map(viewer => `
                    <div class="viewer-item" onclick="viewProfile('${viewer.uid}')">
                        <img class="viewer-avatar" src="${viewer.userPhoto || 'https://via.placeholder.com/40x40/cccccc/666666?text=?'}" 
                             onerror="this.src='https://via.placeholder.com/40x40/cccccc/666666?text=?'">
                        <div class="viewer-name">${viewer.userName || 'Unknown User'}</div>
                        <div class="viewer-time">${formatTimeAgo(viewer.timestamp)}</div>
                    </div>
                `).join('');
            }
            
            document.getElementById('overlay').style.display = 'block';
            sheet.classList.add('active');
        }

        function closeViewersSheet() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('viewersSheet').classList.remove('active');
            currentViewers = [];
        }

        function viewProfile(uid) {
            closeViewersSheet();
            // Implement profile viewing functionality
            // window.location.href = `profile.html?user=${uid}`;
        }

        // --- Story Viewer Functions ---
        function openStories(uid) {
            db.ref(`moments/${uid}`).once('value', snap => {
                storyQueue = [];
                snap.forEach(s => { 
                    if(Date.now() - s.val().ts < 86400000) {
                        storyQueue.push({
                            ...s.val(),
                            key: s.key,
                            uid: uid
                        }); 
                    }
                });
                
                if(storyQueue.length > 0) {
                    storyIndex = 0;
                    document.getElementById('storyViewer').style.display = 'block';
                    
                    // Track view for current story
                    trackStatusView(uid, storyQueue[0].key);
                    showStory();
                }
            });
        }

        function showStory() {
            clearTimeout(storyTimer);
            if(storyIndex >= storyQueue.length) return closeStoryViewer();
            if(storyIndex < 0) storyIndex = 0;

            const story = storyQueue[storyIndex];
            const media = document.getElementById('storyMedia');
            const progress = document.getElementById('storyProgressBars');
            const header = document.getElementById('storyHeaderInfo');

            // Get stats for current story
            const likeCount = story.likes ? Object.keys(story.likes).length : 0;
            const viewCount = story.views ? Object.keys(story.views).length : 0;
            const isLiked = story.likes && story.likes[currentUser.uid];
            const isOwner = story.ownerId === currentUser.uid;

            header.innerHTML = `
                <img src="${story.photo}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"> 
                <b>${story.name}</b>
                <span style="margin-left:auto; margin-right:10px; font-size:12px; opacity:0.8;">
                    ${likeCount > 0 ? `‚ù§Ô∏è ${likeCount}` : ''} ${viewCount > 0 ? `üëÅÔ∏è ${viewCount}` : ''}
                </span>
            `;

            createStoryViewerControls(story, likeCount, viewCount, isLiked, isOwner);

            media.innerHTML = story.type === 'video' ? 
                `<video src="${story.url}" autoplay playsinline></video>` : 
                `<img src="${story.url}">`;

            progress.innerHTML = storyQueue.map((_, i) => `
                <div class="progress-segment">
                    <div class="progress-fill" style="width: ${i < storyIndex ? '100%' : '0%'}"></div>
                </div>`).join('');

            setTimeout(() => {
                const bar = progress.querySelectorAll('.progress-fill')[storyIndex];
                bar.style.transition = 'width 5s linear';
                bar.style.width = '100%';
            }, 50);

            storyTimer = setTimeout(() => { storyIndex++; showStory(); }, 5000);
        }

        function createStoryViewerControls(story, likeCount, viewCount, isLiked, isOwner) {
            // Remove existing controls
            const existingControls = document.querySelectorAll('.story-control');
            existingControls.forEach(control => control.remove());

            // Like button
            const likeBtn = document.createElement('button');
            likeBtn.className = `story-control-btn story-like-btn ${isLiked ? 'liked' : ''}`;
            likeBtn.style.cssText = 'position: absolute; bottom: 100px; right: 20px; z-index: 30;';
            likeBtn.innerHTML = `
                <span class="material-symbols-rounded control-icon" style="font-size: 20px;">
                    ${isLiked ? 'favorite' : 'favorite_border'}
                </span>
                <span class="control-count">${likeCount > 0 ? likeCount : ''}</span>
            `;
            likeBtn.onclick = (e) => {
                e.stopPropagation();
                toggleStoryLike(e, story);
            };

            // View count button
            const viewBtn = document.createElement('button');
            viewBtn.className = 'story-control-btn';
            viewBtn.style.cssText = 'position: absolute; bottom: 100px; left: 20px; z-index: 30;';
            viewBtn.innerHTML = `
                <span class="material-symbols-rounded control-icon" style="font-size: 20px;">visibility</span>
                <span class="control-count">${viewCount > 0 ? viewCount : ''}</span>
            `;
            viewBtn.onclick = (e) => {
                e.stopPropagation();
                showStoryViewers(e, story);
            };

            // Delete button (if owner)
            if (isOwner) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'story-control-btn delete';
                deleteBtn.style.cssText = 'position: absolute; top: 80px; right: 20px; z-index: 30;';
                deleteBtn.innerHTML = `
                    <span class="material-symbols-rounded control-icon" style="font-size: 20px;">delete</span>
                `;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteStatus(e, story.uid, story.key);
                };

                document.getElementById('storyViewer').appendChild(deleteBtn);
            }

            document.getElementById('storyViewer').appendChild(likeBtn);
            document.getElementById('storyViewer').appendChild(viewBtn);
        }

        async function trackStatusView(userId, momentId) {
            if (!currentUser || userId === currentUser.uid) return;
            
            const viewRef = db.ref(`moments/${userId}/${momentId}/views/${currentUser.uid}`);
            await viewRef.set({
                timestamp: Date.now(),
                userName: currentUser.displayName || "User",
                userPhoto: currentUser.photoURL || ""
            });
        }

        async function toggleStoryLike(event, story) {
            event.stopPropagation();
            
            const userId = story.uid;
            const momentId = story.key;
            
            const likeRef = db.ref(`moments/${userId}/${momentId}/likes/${currentUser.uid}`);
            const currentLike = await likeRef.once('value');
            
            // Create floating like animation
            const rect = event.currentTarget.getBoundingClientRect();
            createFloatingLike(rect.left + rect.width/2, rect.top);
            
            if (currentLike.exists()) {
                // Unlike
                await likeRef.remove();
            } else {
                // Like
                await likeRef.set({
                    timestamp: Date.now(),
                    userName: currentUser.displayName || "User"
                });
                
                // Send notification to status owner
                if (userId !== currentUser.uid) {
                    showNotificationAlert(`${currentUser.displayName} liked your status!`);
                    
                    const ownerSub = await db.ref(`users/${userId}/pushSubscription`).once('value');
                    if (ownerSub.exists()) {
                        pushManager.sendNotification(
                            `${currentUser.displayName} liked your status`,
                            '',
                            currentUser.photoURL
                        );
                    }
                }
            }
            
            // Add animation
            const button = event.currentTarget;
            button.classList.add('animating');
            setTimeout(() => button.classList.remove('animating'), 600);
            
            // Refresh current story
            refreshCurrentStory();
        }

        function createFloatingLike(x, y) {
            const floatingLike = document.createElement('div');
            floatingLike.className = 'like-float material-symbols-rounded';
            floatingLike.textContent = 'favorite';
            floatingLike.style.left = x + 'px';
            floatingLike.style.top = y + 'px';
            
            document.body.appendChild(floatingLike);
            
            setTimeout(() => {
                floatingLike.remove();
            }, 1000);
        }

        async function refreshCurrentStory() {
            const currentStory = storyQueue[storyIndex];
            const userId = currentStory.uid;
            const momentId = currentStory.key;
            
            const updatedStory = await db.ref(`moments/${userId}/${momentId}`).once('value');
            if (updatedStory.exists()) {
                storyQueue[storyIndex] = updatedStory.val();
                storyQueue[storyIndex].key = momentId;
                storyQueue[storyIndex].uid = userId;
                showStory();
            }
        }

        async function deleteStatus(event, userId, momentId) {
            event.stopPropagation();
            
            const statusSnap = await db.ref(`moments/${userId}/${momentId}`).once('value');
            if (!statusSnap.exists()) return;
            
            const statusData = statusSnap.val();
            
            if (statusData.ownerId !== currentUser.uid) {
                toast("You can only delete your own status");
                return;
            }
            
            statusToDelete = { userId, momentId, statusData };
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('deleteConfirmSheet').classList.add('active');
        }

        function closeDeleteConfirm() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('deleteConfirmSheet').classList.remove('active');
            statusToDelete = null;
        }

        async function confirmDeleteStatus() {
            if (!statusToDelete) return;
            
            try {
                await db.ref(`moments/${statusToDelete.userId}/${statusToDelete.momentId}`).remove();
                toast("Status deleted");
                closeDeleteConfirm();
                
                if (document.getElementById('storyViewer').style.display === 'block') {
                    const currentStory = storyQueue[storyIndex];
                    if (             document.getElementById('chatsTab').style.display = tab === 'chats' ? 'block' : 'none';
            document.getElementById('statusTab').style.display = tab === 'status' ? 'block' : 'none';
            document.getElementById('navChats').classList.toggle('active', tab === 'chats');
            document.getElementById('navStatus').classList.toggle('active', tab === 'status');
            
            if (tab === 'chats') {
                history.replaceState({tab: 'chats'}, 'Chats', '#chats');
            } else {
                history.replaceState({tab: 'status'}, 'Status', '#status');
            }
        }

        function loadChats() {
            db.ref(`users/${currentUser.uid}/chats`).on('value', snap => {
                const list = document.getElementById('chatList');
                list.innerHTML = "";
                
                const chatsArray = [];
                snap.forEach(child => {
                    chatsArray.push({
                        key: child.key,
                        data: child.val()
                    });
                });
                
                chatsArray.sort((a, b) => (b.data.ts || 0) - (a.data.ts || 0));
                
                chatsArray.forEach(chat => {
                    const c = chat.data;
                    const roomId = currentUser.uid < chat.key ? currentUser.uid+"_"+chat.key : chat.key+"_"+currentUser.uid;
                    const dMsg = decrypt(c.lastMsg, roomId);
                    
                    const timeAgo = formatTimeAgo(c.ts);
                    const unreadCount = c.unreadCount || 0;
                    
                    list.innerHTML += `
                        <div class="chat-card">
                            <div class="avatar-box" onclick="showProfileDetail('${chat.key}', event)">
                                <img class="avatar" src="${c.photo}">
                            </div>
                            <div class="chat-info" onclick="openChat('${chat.key}', '${c.name}', '${c.photo}')">
                                <span class="chat-name">${c.name}</span>
                                <span class="chat-msg">${dMsg}</span>
                            </div>
                            ${timeAgo ? `<span class="chat-time">${timeAgo}</span>` : ''}
                            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</span>` : ''}
                        </div>`;
                });
            });
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d`;
            
            const date = new Date(timestamp);
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function searchFriends() {
            const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
            const clearBtn = document.getElementById('clearSearch');
            const chatCards = document.querySelectorAll('#chatList .chat-card');
            
            clearBtn.style.display = searchTerm ? 'block' : 'none';
            
            chatCards.forEach(card => {
                const friendName = card.querySelector('.chat-name').textContent.toLowerCase();
                const lastMsg = card.querySelector('.chat-msg').textContent.toLowerCase();
                
                if (friendName.includes(searchTerm) || lastMsg.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function clearSearch() {
            document.getElementById('friendSearch').value = '';
            searchFriends();
        }

        async function showProfileDetail(uid, e) {
            e.stopPropagation();
            const snap = await db.ref(`users/${uid}/profile`).once('value');
            const data = snap.val();
            document.getElementById('detailName').innerText = data.name;
            document.getElementById('detailId').innerText = "@" + data.vynixId;
            document.getElementById('detailImg').src = data.photo.replace('s96-c','s400-c');
            document.getElementById('profileDetail').style.display = 'flex';
        }

        // Toggle notifications
        async function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            const enabled = toggle.classList.contains('active');
            
            if (!enabled) {
                const permission = await pushManager.requestPermission();
                if (permission) {
                    await pushManager.subscribeToPush();
                    toggle.classList.add('active');
                    toast('Notifications enabled!');
                } else {
                    toast('Notification permission denied');
                }
            } else {
                await pushManager.unsubscribeFromPush();
                toggle.classList.remove('active');
                toast('Notifications disabled');
            }
        }

        // Check notification status on load
        async function checkNotificationStatus() {
            if (pushManager.isSupported && Notification.permission === 'granted') {
                const subscription = await pushManager.getExistingSubscription();
                if (subscription) {
                    document.getElementById('notificationToggle').classList.add('active');
                }
            }
        }

        // Mark messages as read when opening chat
        async function markAsRead(friendUid) {
            try {
                if (currentUser && friendUid) {
                    await db.ref(`users/${currentUser.uid}/chats/${friendUid}`).update({
                        unreadCount: 0
                    });
                }
            } catch (error) {
                console.log("Error marking as read:", error);
            }
        }

        function decrypt(t, r) {
            if(!t || !t.includes("U2FsdGVk")) return t;
            try { return CryptoJS.AES.decrypt(t, secretBase + r).toString(CryptoJS.enc.Utf8) || "Encrypted"; }
            catch(e) { return "Encrypted"; }
        }

        // Combined openChat function that marks as read AND navigates
        function openChat(uid, name, photo) { 
            markAsRead(uid);
            window.location.href = `chat.html?friend=${uid}&name=${encodeURIComponent(name)}&photo=${encodeURIComponent(photo)}`; 
        }

        function openSheet(id) { document.getElementById('overlay').style.display='block'; document.getElementById(id).classList.add('active'); }
        function closeAll() { document.querySelectorAll('.bottom-sheet').forEach(s=>s.classList.remove('active')); document.getElementById('overlay').style.display='none'; }
        function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2800); }

        // Handle device back button navigation
        function handleBackButton() {
            const statusTab = document.getElementById('statusTab');
            
            if (statusTab.style.display === 'block') {
                switchTab('chats');
                return true;
            } else {
                if (confirm('Exit Vynix?')) {
                    if (window.navigator && window.navigator.app) {
                        navigator.app.exitApp();
                    } else {
                        window.close();
                        setTimeout(() => {
                            window.location.href = 'about:blank';
                        }, 100);
                    }
                }
                return true;
            }
        }

        // Set up back button listeners
        document.addEventListener('deviceready', function() {
            document.addEventListener('backbutton', function(e) {
                e.preventDefault();
                handleBackButton();
            }, false);
        }, false);

        if (!window.cordova) {
            window.addEventListener('popstate', function(e) {
                const statusTab = document.getElementById('statusTab');
                if (statusTab.style.display === 'block') {
                    e.preventDefault();
                    switchTab('chats');
                    history.pushState(null, null, window.location.href);
                } else {
                    handleBackButton();
                }
            });

            if ('onbeforeunload' in window) {
                window.onbeforeunload = function(e) {
                    const statusTab = document.getElementById('statusTab');
                    if (statusTab.style.display === 'block') {
                        switchTab('chats');
                        return null;
                    }
                };
            }
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('App minimized');
            }
        });
    </script>

    <script>
        // Register Service Worker for Push Notifications
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                // Service Worker for Push Notifications
                self.addEventListener('push', function(event) {
                    const data = event.data.json();
                    const options = {
                        body: data.body,
                        icon: data.icon || 'https://via.placeholder.com/192x192/d946ef/ffffff?text=V',
                        badge: 'https://via.placeholder.com/72x72/d946ef/ffffff?text=V',
                        vibrate: [200, 100, 200],
                        tag: data.tag || 'vynix-message',
                        requireInteraction: false,
                        actions: data.actions || []
                    };
                    
                    event.waitUntil(
                        self.registration.showNotification(data.title, options)
                    );
                });

                self.addEventListener('notificationclick', function(event) {
                    event.notification.close();
                    event.waitUntil(
                        clients.openWindow(event.notification.data?.url || '/')
                    );
                });
            `)).then(registration => {
                console.log('Service Worker registered for push notifications');
            }).catch(err => {
                console.log('Service Worker registration failed:', err);
            });
        }
    </script>
</body>
</html>
