<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --accent-purple: #d946ef;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-color: #f9fafb;
            --whatsapp-card: #ffffff;
            --logo-gradient: linear-gradient(135deg, #000000 0%, var(--accent-purple) 50%, #10b981 100%);
            --unread-count: #ef4444;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-primary); overflow-x: hidden; }

        /* --- Global Header & Search --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 80px; background: #fff;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; border-bottom: 1px solid #f0f0f0;
        }
        .user-profile-container { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .user-profile { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-purple); }
        .my-id-badge { font-size: 9px; background: #f3f4f6; padding: 1px 6px; border-radius: 10px; margin-top: 3px; font-weight: 700; }
        .app-title { font-size: 24px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }

        #searchWrapper { display: none; flex: 1; align-items: center; background: #f3f4f6; padding: 10px 15px; border-radius: 14px; margin: 0 15px; }
        #searchWrapper input { border: none; background: transparent; width: 100%; font-family: inherit; font-size: 14px; }
        .search-active .app-title, .search-active .user-profile-container { display: none; }
        .search-active #searchWrapper { display: flex; }

        /* --- Navigation Tabs --- */
        nav.tab-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px; background: #fff;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #f0f0f0; z-index: 1000; padding-bottom: 10px;
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 11px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .tab-item.active { color: var(--accent-purple); }
        .tab-item span { font-size: 28px; margin-bottom: 2px; }

        /* --- Main Content Areas --- */
        main { padding: 90px 0 100px 0; min-height: 100vh; }
        #statusView { display: none; padding: 15px; }

        /* --- Chat List Styling --- */
        .chat-item {
            display: flex; align-items: center; padding: 16px; 
            background: #fff; margin: 10px 16px; border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02); position: relative;
        }
        .avatar-container { margin-right: 15px; cursor: pointer; }
        .avatar { width: 55px; height: 55px; border-radius: 16px; object-fit: cover; }
        .chat-info { flex: 1; overflow: hidden; cursor: pointer; }
        .chat-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .name { font-weight: 600; font-size: 15px; }
        .time { font-size: 11px; color: var(--text-secondary); }
        .msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-count { background: var(--unread-count); color: #fff; font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; position: absolute; right: 16px; bottom: 16px; }

        /* --- Status (Moments) Grid --- */
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .status-card {
            position: relative; height: 260px; border-radius: 24px; overflow: hidden;
            background: #e5e7eb; cursor: pointer;
        }
        .status-card img, .status-card video { width: 100%; height: 100%; object-fit: cover; }
        .status-card-info {
            position: absolute; bottom: 0; width: 100%; padding: 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: #fff;
        }
        .post-moment-btn {
            grid-column: span 2; background: #000; color: #fff; padding: 18px;
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            font-weight: 600; margin-bottom: 10px; cursor: pointer;
        }

        /* --- Immersive Profile Detail Modal --- */
        .profile-viewer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 3000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(15px);
        }
        .profile-card-content {
            background: white; width: 85%; max-width: 340px; border-radius: 35px;
            padding: 40px 24px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        #modalImg { width: 130px; height: 130px; border-radius: 25px; object-fit: cover; margin-bottom: 15px; border: 4px solid var(--accent-purple); }
        #modalName { margin: 0; font-size: 22px; font-weight: 700; }
        #modalId { color: var(--accent-purple); font-weight: 600; font-size: 14px; margin-top: 5px; }

        /* --- Status Immersive Viewer --- */
        #statusViewer { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index: 4000; display:none; }
        .status-progress { display:flex; gap:4px; padding:10px; position:absolute; top:0; width:100%; z-index:10; }
        .sp-bg { height:3px; background:rgba(255,255,255,0.2); flex:1; border-radius:5px; overflow:hidden; }
        .sp-fill { height:100%; background:#fff; width:0%; transition: width linear; }

        /* --- FAB & Modals --- */
        .fab { position: fixed; bottom: 100px; right: 25px; width: 60px; height: 60px; border-radius: 20px; background: #000; color: #fff; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 900; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1500; backdrop-filter: blur(5px); }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 30px 30px 0 0; padding: 30px; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1600; }
        .bottom-sheet.active { bottom: 0; }
        .v-input { width: 100%; padding: 16px; border: 2px solid #f3f4f6; border-radius: 16px; margin-bottom: 15px; font-family: inherit; font-size: 15px; }
        .primary-btn { width: 100%; background: #000; color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer; }
        #v-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 12px 25px; border-radius: 50px; font-size: 13px; z-index: 5000; display: none; }
    </style>
</head>
<body>

    <div id="v-toast"></div>

    <div id="profileViewer" class="profile-viewer" onclick="closeProfile()">
        <div class="profile-card-content" onclick="event.stopPropagation()">
            <img id="modalImg" src="">
            <h2 id="modalName"></h2>
            <div id="modalId"></div>
            <div style="margin-top:25px; color:#9ca3af; font-size:12px; font-weight:600; cursor:pointer;" onclick="closeProfile()">CLOSE</div>
        </div>
    </div>

    <div id="statusViewer" onclick="closeStatusViewer()">
        <div class="status-progress" id="statusBars"></div>
        <div id="statusMedia" style="height:100%; display:flex; align-items:center; justify-content:center;"></div>
    </div>

    <header id="mainHeader">
        <div class="user-profile-container" onclick="openSettings()">
            <img id="myPhoto" class="user-profile" src="https://via.placeholder.com/40">
            <span id="myDisplayId" class="my-id-badge">@...</span>
        </div>
        <div class="app-title">Vynix</div>
        <div id="searchWrapper">
            <input type="text" id="chatSearchInput" placeholder="Search friends..." oninput="filterChats()">
            <span class="material-symbols-rounded" style="cursor:pointer;" onclick="toggleSearch(false)">close</span>
        </div>
        <span class="material-symbols-rounded" id="searchTrigger" onclick="toggleSearch(true)">search</span>
    </header>

    <main id="chatsTab">
        <div id="chatList"></div>
    </main>

    <main id="statusTab">
        <div class="post-moment-btn" onclick="document.getElementById('fileInput').click()">
            <span class="material-symbols-rounded" style="margin-right:10px;">add_circle</span>
            Post a Moment
        </div>
        <div class="status-grid" id="statusGrid"></div>
    </main>

    <input type="file" id="fileInput" hidden accept="image/*,video/*" onchange="uploadMoment(this.files[0])">

    <button class="fab" id="addFriendFab" onclick="toggleSheet('addFriendSheet', true)">
        <span class="material-symbols-rounded" style="font-size:32px;">add</span>
    </button>

    <nav class="tab-bar">
        <div class="tab-item active" id="btnChats" onclick="switchTab('chats')">
            <span class="material-symbols-rounded">chat_bubble</span>Chats
        </div>
        <div class="tab-item" id="btnStatus" onclick="switchTab('status')">
            <span class="material-symbols-rounded">explore</span>Moments
        </div>
    </nav>

    <div class="overlay" id="uiOverlay" onclick="closeAllSheets()"></div>

    <div class="bottom-sheet" id="addFriendSheet">
        <h3 style="margin-top:0">Add Friend</h3>
        <input type="text" id="targetId" class="v-input" placeholder="Vynix ID (e.g. vnx_123)">
        <button class="primary-btn" id="addBtn" onclick="addFriendLogic()">Add Contact</button>
    </div>

    <div class="bottom-sheet" id="settingsSheet">
        <h3>Settings</h3>
        <input type="text" id="editName" class="v-input" placeholder="Display Name">
        <button class="primary-btn" onclick="saveProfile()">Save Changes</button>
        <button class="primary-btn" style="background:#f3f4f6; color:#ef4444; margin-top:10px;" onclick="auth.signOut()">Logout</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- Cloudinary Configuration ---
        const CLOUD_NAME = "dqkujefxj"; 
        const UPLOAD_PRESET = "banter_box";

        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const secretBase = "Vynix_E2EE_Alpha_";

        let currentUser = null;
        let myVynixId = "";
        let allChats = [];
        let unreadCounts = {};

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                await initApp();
                loadChats();
                loadMoments();
            } else { window.location.href = "login.html"; }
        });

        async function initApp() {
            const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            const data = snap.val();
            if(data) {
                myVynixId = data.vynixId;
                document.getElementById('myPhoto').src = currentUser.photoURL;
                document.getElementById('myDisplayId').innerText = "@" + data.vynixId;
                document.getElementById('editName').value = data.name;
            }
        }

        // --- TAB LOGIC ---
        function switchTab(tab) {
            document.getElementById('chatsTab').style.display = tab === 'chats' ? 'block' : 'none';
            document.getElementById('statusTab').style.display = tab === 'status' ? 'block' : 'none';
            document.getElementById('addFriendFab').style.display = tab === 'chats' ? 'flex' : 'none';
            document.getElementById('btnChats').classList.toggle('active', tab === 'chats');
            document.getElementById('btnStatus').classList.toggle('active', tab === 'status');
        }

        // --- CHAT LOGIC ---
        function loadChats() {
            db.ref(`users/${currentUser.uid}/unreadCounts`).on('value', s => {
                unreadCounts = s.val() || {};
                db.ref(`users/${currentUser.uid}/chats`).on('value', snapshot => {
                    allChats = [];
                    snapshot.forEach(child => {
                        const chat = child.val();
                        chat.uid = child.key;
                        const roomId = currentUser.uid < child.key ? currentUser.uid+"_"+child.key : child.key+"_"+currentUser.uid;
                        chat.decryptedMsg = decryptMsg(chat.lastMsg, roomId);
                        chat.count = unreadCounts[child.key] || 0;
                        allChats.push(chat);
                    });
                    allChats.sort((a,b) => (b.ts || 0) - (a.ts || 0));
                    renderChats(allChats);
                });
            });
        }

        function renderChats(list) {
            const container = document.getElementById('chatList');
            container.innerHTML = list.length ? '' : '<div style="text-align:center; padding:50px; color:#9ca3af;">No chats yet.</div>';
            list.forEach(c => {
                container.innerHTML += `
                    <div class="chat-item">
                        <div class="avatar-container" onclick="showFullProfile('${c.uid}', event)">
                            <img class="avatar" src="${c.photo}">
                        </div>
                        <div class="chat-info" onclick="openChat('${c.uid}', '${c.name}', '${c.photo}')">
                            <div class="chat-header">
                                <span class="name">${c.name}</span>
                                <span class="time">${c.lastTime || ''}</span>
                            </div>
                            <div class="msg">${c.decryptedMsg}</div>
                        </div>
                        ${c.count > 0 ? `<div class="unread-count">${c.count}</div>` : ''}
                    </div>
                `;
            });
        }

        async function addFriendLogic() {
            const tid = document.getElementById('targetId').value.trim().toLowerCase().replace('@','');
            if(!tid || tid === myVynixId) return showToast("Invalid ID");
            
            const idSnap = await db.ref(`vynix_ids/${tid}`).once('value');
            if(!idSnap.exists()) return showToast("User not found");
            
            const fUid = idSnap.val();
            const exists = await db.ref(`users/${currentUser.uid}/chats/${fUid}`).once('value');
            if(exists.exists()) return showToast("Friend already added");

            const p = (await db.ref(`users/${fUid}/profile`).once('value')).val();
            await db.ref(`users/${currentUser.uid}/chats/${fUid}`).set({
                name: p.name, photo: p.photo, lastMsg: "Start chatting...", ts: Date.now()
            });
            showToast("Added!");
            closeAllSheets();
        }

        // --- MOMENTS (STATUS) LOGIC ---
        async function uploadMoment(file) {
            if(!file) return;
            showToast("Uploading Moment...");
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method:'POST', body:formData });
            const data = await res.json();
            
            if(data.secure_url) {
                await db.ref(`moments/${currentUser.uid}`).push({
                    url: data.secure_url, type: data.resource_type, ts: Date.now(),
                    name: currentUser.displayName || "User", photo: currentUser.photoURL
                });
                showToast("Moment Shared!");
            }
        }

        function loadMoments() {
            db.ref('moments').on('value', snapshot => {
                const grid = document.getElementById('statusGrid');
                grid.innerHTML = '';
                const now = Date.now();
                
                snapshot.forEach(uNode => {
                    const items = [];
                    uNode.forEach(mNode => {
                        const m = mNode.val();
                        if(now - m.ts < 86400000) items.push(m); // 24hr Filter
                    });

                    if(items.length) {
                        const last = items[items.length-1];
                        grid.innerHTML += `
                            <div class="status-card" onclick="viewMoment('${uNode.key}')">
                                ${last.type === 'video' ? `<video src="${last.url}"></video>` : `<img src="${last.url}">`}
                                <div class="status-card-info">
                                    <div style="display:flex; align-items:center; font-size:12px; font-weight:600;">
                                        <img src="${last.photo}" style="width:20px; height:20px; border-radius:50%; margin-right:8px; border:1px solid #fff;">
                                        ${last.name}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            });
        }

        let statusTimer;
        function viewMoment(uid) {
            const viewer = document.getElementById('statusViewer');
            const bars = document.getElementById('statusBars');
            const media = document.getElementById('statusMedia');
            
            db.ref(`moments/${uid}`).once('value', snapshot => {
                const items = [];
                snapshot.forEach(s => items.push(s.val()));
                viewer.style.display = 'block';
                let i = 0;

                function play() {
                    if(i >= items.length) return closeStatusViewer();
                    const m = items[i];
                    media.innerHTML = m.type === 'video' ? `<video src="${m.url}" autoplay style="max-width:100%; max-height:100%"></video>` : `<img src="${m.url}" style="max-width:100%; max-height:100%">`;
                    
                    bars.innerHTML = items.map((_,idx) => `<div class="sp-bg"><div class="sp-fill" style="width:${idx < i ? '100%' : (idx === i ? '0%' : '0%')}"></div></div>`).join('');
                    
                    setTimeout(() => { if(bars.querySelectorAll('.sp-fill')[i]) bars.querySelectorAll('.sp-fill')[i].style.width = '100%'; }, 50);
                    
                    statusTimer = setTimeout(() => { i++; play(); }, 5000);
                }
                play();
            });
        }

        function closeStatusViewer() { clearTimeout(statusTimer); document.getElementById('statusViewer').style.display = 'none'; }

        // --- HELPERS ---
        async function showFullProfile(uid, e) {
            e.stopPropagation();
            const modal = document.getElementById('profileViewer');
            modal.style.display = 'flex';
            const p = (await db.ref(`users/${uid}/profile`).once('value')).val();
            document.getElementById('modalName').innerText = p.name;
            document.getElementById('modalId').innerText = "@" + p.vynixId;
            document.getElementById('modalImg').src = p.photo.replace('s96-c','s400-c');
        }

        function decryptMsg(t, r) {
            if(!t || !t.includes("U2FsdGVk")) return t;
            try { return CryptoJS.AES.decrypt(t, secretBase + r).toString(CryptoJS.enc.Utf8) || "ðŸ”’ Encrypted"; }
            catch(e) { return "ðŸ”’ Encrypted"; }
        }

        function toggleSearch(show) {
            document.getElementById('mainHeader').classList.toggle('search-active', show);
            if(!show) renderChats(allChats);
        }

        function filterChats() {
            const q = document.getElementById('chatSearchInput').value.toLowerCase();
            renderChats(allChats.filter(c => c.name.toLowerCase().includes(q) || c.decryptedMsg.toLowerCase().includes(q)));
        }

        function openChat(uid, name, photo) { window.location.href = `chat.html?friend=${uid}&name=${encodeURIComponent(name)}&photo=${encodeURIComponent(photo)}`; }
        function closeProfile() { document.getElementById('profileViewer').style.display = 'none'; }
        function toggleSheet(id, show) { document.getElementById('uiOverlay').style.display = show ? 'block' : 'none'; document.getElementById(id).classList.toggle('active', show); }
        function closeAllSheets() { document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active')); document.getElementById('uiOverlay').style.display = 'none'; }
        function showToast(m) { const t = document.getElementById('v-toast'); t.innerText = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2500); }
        function openSettings() { toggleSheet('settingsSheet', true); }
    </script>
</body>
</html>
