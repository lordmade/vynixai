<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Lingua Community - African Language Learning Hub</title>
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <!-- Crypto Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/openpgp@5.11.1/dist/openpgp.min.js"></script>
  
  <style>
    /* Design Tokens - Same as AI page */
    :root{
      --bg-color:#ffffff;
      --surface-color:#f3f6fc;
      --text-primary:#1e1e1e;
      --text-secondary:#444746;
      --text-muted:#9aa0a6;
      --accent-blue:#2563eb;
      --accent-purple:#d946ef;
      --accent-green:#10b981;
      --error-red:#dc2626;
      --logo-gradient:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 50%,var(--accent-green) 100%);
      --radius-lg:32px;
      --radius-md:24px;
      --radius-sm:16px;
      --shadow-soft:0 8px 32px rgba(0,0,0,.06);
      --font-main: 'Noto Sans', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    
    /* Reset & Base Styles - Same as AI page with highlight prevention */
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:var(--font-main);background:var(--bg-color);color:var(--text-primary);
         height:100vh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased;
         -webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
    
    /* Error States */
    .error-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--error-red);
    }
    
    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }
    
    .error-title {
      font-family: var(--font-head);
      font-size: 20px;
      margin: 0 0 8px 0;
      color: var(--text-primary);
    }
    
    .error-message {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .retry-button {
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .retry-button:hover {
      transform: translateY(-1px);
    }
    
    .retry-button:active {
      transform: scale(0.98);
    }
    
    /* Debug Info */
    .debug-info {
      background: var(--surface-color);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-secondary);
      text-align: left;
      max-width: 100%;
      overflow-x: auto;
    }
    
    /* Loading States */
    .loading-state {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid var(--surface-color);
      border-top: 3px solid var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    /* WhatsApp-style Message Bubbles */
    .community-header {
      height:64px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;
      flex-shrink:0;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(0,0,0,.05);z-index:10;
    }
    
    .header-left {
      display:flex;align-items:center;gap:12px;
    }
    
    .back-btn {
      background:none;border:none;width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;cursor:pointer;
      color:var(--text-primary);transition:background .2s;
    }
    
    .back-btn:hover{background:var(--surface-color)}
    .back-btn:active{transform:scale(.96)}
    
    .community-logo {
      display:flex;align-items:center;gap:8px;
    }
    
    .logo-icon {
      font-size:26px;background:var(--logo-gradient);-webkit-background-clip:text;
      -webkit-text-fill-color:transparent;font-variation-settings:'FILL' 1,'wght' 600;
    }
    
    .logo-text {
      font-family:var(--font-head);font-size:22px;font-weight:700;letter-spacing:-.5px;
    }
    
    .online-indicator {
      display:flex;align-items:center;gap:8px;font-size:14px;
      color:var(--text-secondary);font-weight:500;
    }
    
    .online-dot {
      width:8px;height:8px;background:var(--accent-green);border-radius:50%;
      animation:pulse 2s infinite;
    }
    
    .community-messages {
      flex:1;overflow-y:auto;padding:8px 0 140px;display:flex;flex-direction:column;
      scroll-behavior:smooth;background:#f8f9fa;
    }
    
    .message-item {
      display:flex;margin-bottom:2px;max-width:80%;position:relative;
      animation:fadeIn .3s ease;padding:0 8px;
    }
    
    .message-item.own{margin-left:auto;text-align:right;flex-direction:column;align-items:flex-end}
    .message-item:not(.own){margin-right:auto;padding-left:44px;flex-direction:column;align-items:flex-start}
    
    /* WhatsApp-style bubble design */
    .message-content {
      padding:6px 12px;border-radius:7px;line-height:1.4;text-align:left;font-size:14.2px;
      white-space:pre-wrap;overflow-wrap:break-word;word-wrap:break-word;max-width:100%;
      display:inline-block;position:relative;min-height:20px;
      box-shadow:0 1px 0.5px rgba(0,0,0,.1);
    }
    
    /* Incoming message bubble - WhatsApp style */
    .message-item:not(.own) .message-content {
      background:#ffffff;border-top-left-radius:0;
      color:#303030;border:1px solid #e9edef;
    }
    
    /* Outgoing message bubble - WhatsApp style */
    .message-item.own .message-content {
      background:#d9fdd3;color:#111b21;border-bottom-right-radius:0;
    }
    
    /* Message grouping - consecutive messages from same user */
    .message-item:not(.own) + .message-item:not(.own) {
      margin-top:-6px;
    }
    
    .message-item.own + .message-item.own {
      margin-top:-6px;
    }
    
    .message-item:not(.own) + .message-item:not(.own) .message-content,
    .message-item.own + .message-item.own .message-content {
      border-radius:7px;
    }
    
    .message-item:not(.own):first-child .message-content,
    .message-item:not(.own):not(:has(+ .message-item:not(.own))) .message-content {
      border-top-left-radius:0;
    }
    
    .message-item.own:first-child .message-content,
    .message-item.own:not(:has(+ .message-item.own)) .message-content {
      border-bottom-right-radius:0;
    }
    
    .user-avatar {
      width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      flex-shrink:0;position:absolute;left:8px;top:0;background:var(--logo-gradient);color:#fff;font-size:18px;
      font-weight:500;box-shadow:0 1px 2px rgba(0,0,0,.1);
    }
    
    .message-item.own .user-avatar{display:none}
    
    .message-header {
      display:flex;align-items:center;gap:6px;margin-bottom:2px;
    }
    
    .message-author {
      font-weight:600;font-size:12px;color:#008069;
    }
    
    .message-item.own .message-author {
      color:#128c7e;
    }
    
    .message-time {
      font-size:11px;color:#667781;position:relative;
      margin-left:8px;font-weight:400;
    }
    
    .message-item.own .message-time {
      color:#128c7e;
    }
    
    .message-item.own .message-header {
      justify-content:flex-end;
    }
    
    .input-area {
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      background:var(--bg-color);padding:8px max(16px,env(safe-area-inset-left)) max(16px,env(safe-area-inset-bottom)) max(16px,env(safe-area-inset-right));
      box-shadow:0 -1px 3px rgba(0,0,0,.04);
    }
    
    .input-area .input-wrapper {
      width:100%;background:#ffffff;border-radius:21px;padding:5px 8px 5px 16px;
      display:flex;align-items:center;transition:background .2s,box-shadow .2s;
      border:1px solid #e9edef;min-height:42px;
    }
    
    .input-area .input-wrapper:focus-within{background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1);border-color:#008069}
    
    .message-input {
      flex:1;border:none;background:none;outline:none;font-size:15px;font-family:var(--font-main);
      color:var(--text-primary);padding:8px 0;user-select:text;
    }
    
    .send-button {
      width:36px;height:36px;border-radius:50%;border:none;background:transparent;
      color:#667781;cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:all .2s;flex-shrink:0;margin-left:4px;
    }
    
    .send-button.active{background:#008069;color:#fff}
    .send-button span{font-size:20px}
    
    /* Auth Sheet - Same as AI page */
    .auth-overlay {
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);
      z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;
    }
    
    .auth-overlay.open{opacity:1;pointer-events:all}
    
    .auth-sheet {
      position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.98);
      backdrop-filter:blur(20px);border-top:1px solid rgba(0,0,0,.05);
      border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;
      z-index:50;box-shadow:0 -5px 20px rgba(0,0,0,.1);transform:translateY(100%);
      transition:transform .3s ease-out;max-height:90vh;overflow-y:auto;
    }
    
    .auth-sheet.open{transform:translateY(0)}
    
    .sheet-header {
      font-size:20px;font-weight:700;margin-bottom:20px;text-align:center;position:relative;
    }
    
    .sheet-close-btn {
      position:absolute;right:0;top:0;background:none;border:none;cursor:pointer;
      color:var(--text-muted);padding:4px;
    }
    
    .sheet-tab-bar {
      display:flex;border-bottom:1px solid var(--surface-color);margin-bottom:20px;
    }
    
    .sheet-tab {
      flex:1;text-align:center;padding:10px 0;cursor:pointer;font-weight:500;
      color:var(--text-muted);border-bottom:2px solid transparent;
      transition:color .2s,border-color .2s;
    }
    
    .sheet-tab.active{color:var(--accent-blue);border-bottom-color:var(--accent-blue)}
    
    .sheet-tab-content{padding:10px 0}
    
    .sheet-input {
      width:100%;padding:12px;margin-bottom:15px;border:1px solid var(--surface-color);
      border-radius:10px;font-family:var(--font-main);font-size:16px;background:var(--input-bg);
    }
    
    .sheet-btn {
      width:100%;padding:14px;border:none;border-radius:50px;font-weight:700;font-size:16px;
      cursor:pointer;transition:opacity .2s,transform .2s;margin-top:10px;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    
    .sheet-btn:active{transform:scale(.98)}
    
    .sheet-btn-primary {
      background:var(--logo-gradient);color:#fff;box-shadow:0 4px 15px rgba(37,99,235,.3);
    }
    
    .sheet-btn-google {
      background:#fff;color:var(--text-primary);border:1px solid #ccc;margin-bottom:15px;
    }
    
    .sheet-btn-google img{width:20px;height:20px}
    
    /* Welcome State */
    .welcome-state {
      text-align:center;padding:60px 20px;color:var(--text-muted);flex:1;display:flex;
      flex-direction:column;justify-content:center;align-items:center;
    }
    
    .welcome-icon {
      font-size:64px;background:var(--logo-gradient);-webkit-background-clip:text;
      -webkit-text-fill-color:transparent;margin-bottom:24px;font-variation-settings:'wght' 200;
    }
    
    .welcome-title {
      font-family:var(--font-head);font-size:32px;font-weight:600;margin-bottom:12px;
    }
    
    .welcome-text {
      color:var(--text-muted);font-size:16px;max-width:400px;line-height:1.5;margin-bottom:20px;
    }
    
    /* Encryption Status Indicator */
    .encryption-status {
      position:fixed;top:70px;right:16px;background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);border-radius:16px;padding:8px 12px;
      font-size:12px;color:#667781;display:flex;align-items:center;gap:6px;
      z-index:20;border:1px solid rgba(0,0,0,.05);
    }
    
    .encryption-icon {
      font-size:16px;color:#008069;
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{to{opacity:.3;transform:translateY(-2px)}}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    /* Desktop Layout - Same as AI page */
    @media (min-width: 768px) {
      .input-area {
        left:50%;transform:translateX(-50%);width:90%;max-width:800px;border-radius:24px;
        margin-bottom:20px;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);
        box-shadow:0 -4px 20px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.08);
      }
      
      .input-area .input-wrapper {
        border-radius:20px;background:transparent;backdrop-filter:none;border:none;box-shadow:none;
      }
      
      .community-messages {
        padding:8px 0 160px;
      }
      
      .message-item {
        max-width:65%;
      }
      
      .message-item.user {
        margin-left:auto;margin-right:auto;
      }
      
      .message-item:not(.own) {
        margin-left:auto;margin-right:auto;
      }
      
      .welcome-state {
        max-width:800px;margin:0 auto;padding:40px 20px;
      }
    }
    
    @media (max-width: 767px) {
      .input-area {
        left:0;right:0;width:100%;transform:none;border-radius:0;margin-bottom:0;
      }
    }
  </style>
</head>
<body>
  <!-- Encryption Status -->
  <div class="encryption-status" id="encryptionStatus">
    <span class="material-symbols-rounded encryption-icon">lock</span>
    <span>End-to-end encrypted</span>
  </div>
  
  <!-- Auth Sheet Overlay -->
  <div class="auth-overlay" id="authOverlay"></div>
  
  <!-- Auth Sheet - Same as AI page -->
  <div class="auth-sheet" id="authSheet">
    <div class="sheet-header">
      Welcome to Vynix Community
      <button class="sheet-close-btn" onclick="closeAuthSheet()">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
    
    <div class="sheet-tab-bar">
      <div class="sheet-tab active" data-tab="signin">Sign In</div>
      <div class="sheet-tab" data-tab="signup">Sign Up</div>
    </div>
    
    <div id="signin-content" class="sheet-tab-content">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signInEmail">
      <input type="password" placeholder="Password" class="sheet-input" id="signInPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignIn()">Sign In</button>
      
      <button class="sheet-btn sheet-btn-google" onclick="signInWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 18c3.24 0 5.97-1.075 7.956-2.92l-2.908-2.26c-1.075.72-2.456 1.155-4.048 1.155-3.097 0-5.716-2.092-6.655-4.906H.89v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M2.345 10.064A5.367 5.367 0 0 1 2.345 7.94V5.608H.89a8.997 8.997 0 0 0 0 8.088l1.455-1.332z" fill="#FBBC05"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 3.58c1.592 0 3.022.546 4.14 1.61l3.067-3.067C14.97.84 12.24 0 9 0 5.49 0 2.276 1.917.89 4.876l2.455 1.884C3.748 4.67 6.167 3.58 9 3.58z" fill="#EA4335"/>
        </svg>
        <span style="font-family:'Roboto',sans-serif;font-weight:500;font-size:14px;color:#1F1F1F">Sign in with Google</span>
      </button>
    </div>
    
    <div id="signup-content" class="sheet-tab-content" style="display:none">
      <input type="text" placeholder="Display Name" class="sheet-input" id="signUpName">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signUpEmail">
      <input type="password" placeholder="Password (min 6 chars)" class="sheet-input" id="signUpPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignUp()">Sign Up</button>
    </div>
  </div>
  
  <!-- Header -->
  <header class="community-header">
    <div class="header-left">
      <button class="back-btn" onclick="goBack()">
        <span class="material-symbols-rounded">arrow_back</span>
      </button>
      <div class="community-logo">
        <span class="material-symbols-rounded logo-icon">groups</span>
        <span class="logo-text">Vynix Community</span>
      </div>
    </div>
    <div class="online-indicator">
      <span class="online-dot"></span>
      <span id="onlineCount">0 online</span>
    </div>
  </header>
  
  <!-- Messages Container -->
  <main class="community-messages" id="messagesContainer">
    <div class="loading-state" id="loadingState">
      <div class="loading-spinner"></div>
      <p>Loading community messages...</p>
    </div>
  </main>
  
  <!-- Input Area -->
  <div class="input-area">
    <div class="input-wrapper">
      <input 
        type="text" 
        id="messageInput" 
        class="message-input" 
        placeholder="Share with the community..."
        autocomplete="off"
      >
      <button class="send-button" id="sendButton">
        <span class="material-symbols-rounded">send</span>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { 
      getAuth, 
      onAuthStateChanged, 
      GoogleAuthProvider, 
      signInWithPopup,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      updateProfile
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      query, 
      orderBy, 
      limit, 
      addDoc, 
      onSnapshot, 
      serverTimestamp,
      where,
      getDocs,
      doc,
      setDoc
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // DOM Elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const loadingState = document.getElementById('loadingState');
    const authOverlay = document.getElementById('authOverlay');
    const authSheet = document.getElementById('authSheet');
    const onlineCount = document.getElementById('onlineCount');
    const encryptionStatus = document.getElementById('encryptionStatus');
    
    let currentUser = null;
    let messagesUnsubscribe = null;
    let onlineUsersUnsubscribe = null;
    let userKeyPair = null;
    let communityPublicKey = null;
    
    // End-to-End Encryption Implementation
    class CommunityEncryption {
      constructor() {
        this.userKeys = new Map();
        this.communityKeyPair = null;
      }
      
      async initializeUserKeys() {
        if (!currentUser) return null;
        
        try {
          // Generate user key pair if not exists
          const userId = currentUser.uid;
          const storedKeys = localStorage.getItem(`communityKeys_${userId}`);
          
          if (storedKeys) {
            userKeyPair = JSON.parse(storedKeys);
          } else {
            userKeyPair = await this.generateKeyPair();
            localStorage.setItem(`communityKeys_${userId}`, JSON.stringify(userKeyPair));
          }
          
          // Load or generate community public key
          await this.loadCommunityPublicKey();
          
          return userKeyPair;
        } catch (error) {
          console.error('Key initialization error:', error);
          return null;
        }
      }
      
      async generateKeyPair() {
        const keyPair = await window.crypto.subtle.generateKey(
          {
            name: "RSA-OAEP",
            modulusLength: 2048,
            publicExponent: new Uint8Array([1, 0, 1]),
            hash: "SHA-256",
          },
          true,
          ["encrypt", "decrypt"]
        );
        
        const publicKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.publicKey);
        const privateKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.privateKey);
        
        return {
          publicKey: publicKeyJwk,
          privateKey: privateKeyJwk,
          publicKeyCrypto: keyPair.publicKey,
          privateKeyCrypto: keyPair.privateKey
        };
      }
      
      async loadCommunityPublicKey() {
        try {
          // In a real implementation, you'd have a secure way to distribute the community public key
          // For now, we'll generate a shared community key or use a simple symmetric approach
          const communityKeyData = localStorage.getItem('communityPublicKey');
          
          if (communityKeyData) {
            communityPublicKey = JSON.parse(communityKeyData);
          } else {
            // Generate a simple community encryption key (in production, this should be properly distributed)
            const key = await window.crypto.subtle.generateKey(
              {
                name: "AES-GCM",
                length: 256,
              },
              true,
              ["encrypt", "decrypt"]
            );
            
            const exported = await window.crypto.subtle.exportKey("jwk", key);
            communityPublicKey = exported;
            localStorage.setItem('communityPublicKey', JSON.stringify(exported));
          }
        } catch (error) {
          console.error('Community key loading error:', error);
        }
      }
      
      async encryptMessage(text) {
        if (!communityPublicKey) {
          console.warn('No community public key available, sending unencrypted');
          return { encrypted: false, text };
        }
        
        try {
          const encoder = new TextEncoder();
          const data = encoder.encode(text);
          
          // Generate IV
          const iv = window.crypto.getRandomValues(new Uint8Array(12));
          
          // Import the community key
          const key = await window.crypto.subtle.importKey(
            "jwk",
            communityPublicKey,
            {
              name: "AES-GCM",
            },
            false,
            ["encrypt"]
          );
          
          // Encrypt the message
          const encrypted = await window.crypto.subtle.encrypt(
            {
              name: "AES-GCM",
              iv: iv,
            },
            key,
            data
          );
          
          return {
            encrypted: true,
            data: Array.from(new Uint8Array(encrypted)),
            iv: Array.from(iv)
          };
        } catch (error) {
          console.error('Encryption error:', error);
          return { encrypted: false, text };
        }
      }
      
      async decryptMessage(encryptedData) {
        if (!encryptedData.encrypted) {
          return encryptedData.text;
        }
        
        try {
          const key = await window.crypto.subtle.importKey(
            "jwk",
            communityPublicKey,
            {
              name: "AES-GCM",
            },
            false,
            ["decrypt"]
          );
          
          const decrypted = await window.crypto.subtle.decrypt(
            {
              name: "AES-GCM",
              iv: new Uint8Array(encryptedData.iv),
            },
            key,
            new Uint8Array(encryptedData.data)
          );
          
          const decoder = new TextDecoder();
          return decoder.decode(decrypted);
        } catch (error) {
          console.error('Decryption error:', error);
          return '[Encrypted Message]';
        }
      }
    }
    
    const encryptionService = new CommunityEncryption();
    
    // Enhanced error handling
    function showErrorState(error, retryCallback) {
      console.error('Community Error:', error);
      
      let errorTitle = 'Connection Error';
      let errorMessage = 'Unable to load community messages. Please check your connection and try again.';
      let debugInfo = '';
      
      // Handle specific Firebase errors
      if (error.code) {
        switch (error.code) {
          case 'permission-denied':
            errorTitle = 'Permission Denied';
            errorMessage = 'You don\'t have permission to access community messages. This might be due to security rules.';
            debugInfo = `Error Code: ${error.code}\nMessage: ${error.message}`;
            break;
          case 'unavailable':
            errorTitle = 'Service Unavailable';
            errorMessage = 'The community service is temporarily unavailable. Please try again in a few moments.';
            debugInfo = `Error Code: ${error.code}`;
            break;
          case 'not-found':
            errorTitle = 'Community Not Found';
            errorMessage = 'The community collection doesn\'t exist yet. It will be created when the first message is sent.';
            debugInfo = `Error Code: ${error.code}\nCollection: communityMessages`;
            break;
          case 'unauthenticated':
            errorTitle = 'Authentication Required';
            errorMessage = 'Please sign in to join the community conversation.';
            debugInfo = `Error Code: ${error.code}`;
            break;
          default:
            debugInfo = `Error Code: ${error.code}\nMessage: ${error.message}`;
        }
      } else if (error.message) {
        debugInfo = `Message: ${error.message}`;
      }
      
      messagesContainer.innerHTML = `
        <div class="error-state">
          <span class="material-symbols-rounded error-icon">error_outline</span>
          <h3 class="error-title">${errorTitle}</h3>
          <p class="error-message">${errorMessage}</p>
          ${debugInfo ? `<div class="debug-info">${debugInfo}</div>` : ''}
          ${retryCallback ? `<button class="retry-button" onclick="retryCallback()">Try Again</button>` : ''}
        </div>
      `;
    }
    
    // Auth functions - Same as AI page
    window.openAuthSheet = () => {
      authOverlay.classList.add('open');
      authSheet.classList.add('open');
    };
    
    window.closeAuthSheet = () => {
      authOverlay.classList.remove('open');
      authSheet.classList.remove('open');
    };
    
    authOverlay.addEventListener('click', closeAuthSheet);
    
    // Tab switching
    document.getElementById('authSheet').addEventListener('click', (e) => {
      const tab = e.target.closest('.sheet-tab');
      if (!tab) return;
      const target = tab.dataset.tab;
      document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sheet-tab-content').forEach(c => c.style.display = 'none');
      tab.classList.add('active');
      document.getElementById(`${target}-content`).style.display = 'block';
    });
    
    // Auth functions - Same as AI page
    window.signInWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
        closeAuthSheet();
      } catch (e) {
        alert('Google Sign-In failed: ' + e.message);
      }
    };
    
    window.handleSignIn = async () => {
      const email = document.getElementById('signInEmail').value.trim();
      const password = document.getElementById('signInPassword').value;
      if (!email || !password) return alert('Please enter both email and password.');
      try {
        await signInWithEmailAndPassword(auth, email, password);
        closeAuthSheet();
      } catch (e) {
        let msg = 'Sign-In failed.';
        if (e.code === 'auth/user-not-found') msg = 'No user found with this email.';
        else if (e.code === 'auth/wrong-password') msg = 'Incorrect password.';
        alert(msg);
      }
    };
    
    window.handleSignUp = async () => {
      const name = document.getElementById('signUpName').value.trim();
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value;
      if (!name || !email || password.length < 6) return alert('Please enter valid details (password min 6 chars).');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: name });
        closeAuthSheet();
      } catch (e) {
        let msg = 'Sign-Up failed.';
        if (e.code === 'auth/email-already-in-use') msg = 'Email already in use.';
        alert(msg);
      }
    };
    
    // Authentication State with encryption setup
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.placeholder = "Share with the community...";
        
        // Initialize encryption keys
        await encryptionService.initializeUserKeys();
        
        loadMessages();
        updateUserPresence();
      } else {
        messageInput.disabled = true;
        sendButton.disabled = true;
        messageInput.placeholder = "Sign in to join the conversation";
        loadingState.style.display = 'none';
        showWelcomeState();
      }
    }, (error) => {
      console.error('Auth state change error:', error);
      showErrorState(error, () => window.location.reload());
    });
    
    // Load Messages with decryption
    function loadMessages() {
      loadingState.style.display = 'block';
      
      try {
        const q = query(
          collection(db, 'communityMessages'),
          orderBy('createdAt', 'asc'),
          limit(100)
        );
        
        messagesUnsubscribe = onSnapshot(q, async (snapshot) => {
          loadingState.style.display = 'none';
          const messages = [];
          
          for (const doc of snapshot.docs) {
            const messageData = { id: doc.id, ...doc.data() };
            
            // Decrypt message if encrypted
            if (messageData.encrypted) {
              try {
                messageData.text = await encryptionService.decryptMessage(messageData.encryptedData);
              } catch (error) {
                console.error('Failed to decrypt message:', error);
                messageData.text = '[Encrypted Message]';
              }
            }
            
            messages.push(messageData);
          }
          
          renderMessages(messages);
          scrollToBottom();
        }, (error) => {
          console.error('Snapshot error:', error);
          loadingState.style.display = 'none';
          showErrorState(error, loadMessages);
        });
        
      } catch (error) {
        console.error('Query setup error:', error);
        loadingState.style.display = 'none';
        showErrorState(error, loadMessages);
      }
    }
    
    // Render Messages with WhatsApp-style grouping
    function renderMessages(messages) {
      messagesContainer.innerHTML = '';
      
      if (messages.length === 0) {
        showWelcomeState();
        return;
      }
      
      let lastAuthor = null;
      let lastTimestamp = null;
      
      messages.forEach((message, index) => {
        const isOwn = currentUser && message.userId === currentUser.uid;
        const isConsecutive = lastAuthor === message.userId && 
                             (message.createdAt?.toDate?.() || new Date()).getTime() - lastTimestamp < 60000; // 1 minute
        
        const messageElement = createMessageElement(message, isOwn, isConsecutive);
        messagesContainer.appendChild(messageElement);
        
        lastAuthor = message.userId;
        lastTimestamp = (message.createdAt?.toDate?.() || new Date()).getTime();
      });
    }
    
    // Create Message Element with WhatsApp styling
    function createMessageElement(message, isOwn, isConsecutive) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-item ${isOwn ? 'own' : ''}`;
      
      const avatar = message.userName?.charAt(0).toUpperCase() || '?';
      const time = formatTime(message.createdAt?.toDate?.() || new Date());
      
      if (isConsecutive && !isOwn) {
        messageDiv.classList.add('consecutive');
      }
      
      messageDiv.innerHTML = `
        ${!isOwn ? `<div class="user-avatar">${avatar}</div>` : ''}
        <div class="message-content">
          ${!isOwn && !isConsecutive ? `
            <div class="message-header">
              <span class="message-author">${message.userName || 'Anonymous'}</span>
              <span class="message-time">${time}</span>
            </div>
          ` : `
            <span class="message-time">${time}</span>
          `}
          <div class="message-text">${escapeHtml(message.text)}</div>
        </div>
      `;
      
      return messageDiv;
    }
    
    // Show Welcome State
    function showWelcomeState() {
      messagesContainer.innerHTML = `
        <div class="welcome-state">
          <span class="material-symbols-rounded welcome-icon">groups</span>
          <h2 class="welcome-title">Welcome to Vynix Community!</h2>
          <p class="welcome-text">
            This is your space to connect with fellow African language learners. 
            Share tips, ask questions, and celebrate language learning together!
          </p>
          <div style="margin-top: 16px; padding: 12px; background: rgba(0, 128, 105, 0.1); border-radius: 12px; border: 1px solid rgba(0, 128, 105, 0.2);">
            <div style="display: flex; align-items: center; gap: 8px; color: #008069; font-size: 14px;">
              <span class="material-symbols-rounded" style="font-size: 16px;">lock</span>
              <span>All messages are end-to-end encrypted</span>
            </div>
          </div>
        </div>
      `;
    }
    
    // Send Message with encryption
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      
      if (!currentUser) {
        openAuthSheet();
        return;
      }
      
      try {
        // Show loading state
        sendButton.disabled = true;
        sendButton.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span>';
        
        // Encrypt the message
        const encryptedResult = await encryptionService.encryptMessage(text);
        
        const messageData = {
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email.split('@')[0],
          userEmail: currentUser.email,
          createdAt: serverTimestamp(),
          text: encryptedResult.encrypted ? '[Encrypted]' : text,
          encrypted: encryptedResult.encrypted,
          encryptedData: encryptedResult.encrypted ? encryptedResult : null
        };
        
        await addDoc(collection(db, 'communityMessages'), messageData);
        
        messageInput.value = '';
        scrollToBottom();
        
        // Update user presence
        await setDoc(doc(db, 'communityUsers', currentUser.uid), {
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email.split('@')[0],
          lastSeen: serverTimestamp(),
          isOnline: true
        }, { merge: true });
        
      } catch (error) {
        console.error('Send message error:', error);
        showErrorState(error);
      } finally {
        sendButton.disabled = false;
        sendButton.innerHTML = '<span class="material-symbols-rounded">send</span>';
      }
    }
    
    // Update User Presence and Online Count
    async function updateUserPresence() {
      if (!currentUser) return;
      
      try {
        // Update user's online status
        await setDoc(doc(db, 'communityUsers', currentUser.uid), {
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email.split('@')[0],
          lastSeen: serverTimestamp(),
          isOnline: true
        }, { merge: true });
        
        // Subscribe to online users count
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        const q = query(
          collection(db, 'communityUsers'),
          where('lastSeen', '>', fiveMinutesAgo),
          where('isOnline', '==', true)
        );
        
        onlineUsersUnsubscribe = onSnapshot(q, (snapshot) => {
          onlineCount.textContent = `${snapshot.size} online`;
        }, (error) => {
          console.error('Online users error:', error);
        });
        
      } catch (error) {
        console.error('Update presence error:', error);
      }
    }
    
    // Utility Functions
    function formatTime(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      
      return date.toLocaleDateString();
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function goBack() {
      window.location.href = '/';
    }
    
    // Event Listeners
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    messageInput.addEventListener('input', () => {
      sendButton.classList.toggle('active', messageInput.value.trim().length > 0);
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', async () => {
      if (messagesUnsubscribe) messagesUnsubscribe();
      if (onlineUsersUnsubscribe) onlineUsersUnsubscribe();
      
      if (currentUser) {
        try {
          await setDoc(doc(db, 'communityUsers', currentUser.uid), {
            isOnline: false,
            lastSeen: serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.error('Error updating user status:', error);
        }
      }
    });
    
    // Simple rain animation (same as before but lighter)
    const canvas = document.createElement('canvas');
    canvas.id = 'rainCanvas';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let w, h, drops = [];
    const colors = ['#2563eb', '#d946ef', '#10b981'];
    
    function resize() {
      w = innerWidth;
      h = innerHeight;
      canvas.width = w;
      canvas.height = h;
      drops = [];
      const count = Math.floor(w / 25);
      for (let i = 0; i < count; i++) drops.push({ 
        x: Math.random() * w, 
        y: Math.random() * h, 
        len: Math.random() * 15 + 8, 
        speed: Math.random() * 2 + 1, 
        color: colors[Math.floor(Math.random() * colors.length)], 
        opacity: Math.random() * 0.3 + 0.1 
      });
    }
    
    addEventListener('resize', resize);
    resize();
    
    function draw() {
      ctx.clearRect(0, 0, w, h);
      for (const d of drops) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x, d.y + d.len);
        ctx.strokeStyle = d.color;
        ctx.lineWidth = 1;
        ctx.globalAlpha = d.opacity;
        ctx.stroke();
        d.y += d.speed;
        if (d.y > h) {
          d.y = -d.len;
          d.x = Math.random() * w;
        }
      }
      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>
