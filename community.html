<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Social Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNkOTQ2ZWYiLCJ0aGVtZV9jb2xvciI6IiNkOTQ2ZWYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#d946ef">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ---------- ROOT TOKENS (Facebook-like) ---------- */
    :root{
      --bg:#f0f2f5;
      --card:#ffffff;
      --text:#1c1e21;
      --text2:#65676b;
      --border:#ced0d4;
      --accent:#d946ef;
      --accent-blue:#1877f2;
      --accent-green:#42b72a;
      --hover-accent:#f0f2f5;
      --card-shadow:0 1px 2px rgba(0,0,0,0.1);
      --radius:8px;
      --avatar:40px;
      --gutter:0px;
      --trans:.2s ease;
    }
    [data-theme="dark"]{
      --bg:#18191a;
      --card:#242526;
      --text:#e4e6eb;
      --text2:#b0b3b8;
      --border:#3e4042;
      --card-shadow:0 1px 2px rgba(0,0,0,0.2);
      --hover-accent:#3a3b3c;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding-bottom:80px;
    }
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    input,textarea{-webkit-user-select:auto;user-select:auto}
    /* ---------- COMPOSER (Facebook Style) ---------- */
    .composer{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      margin:16px auto;
      max-width:680px;
      padding:16px;
    }
    .composer .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover}
    textarea{flex:1;resize:none;background:var(--bg);color:var(--text);border:none;outline:none;font-size:17px;padding:12px;border-radius:20px;background:var(--bg);min-height:40px;width:100%}
    textarea::placeholder{color:var(--text2)}
    .media-preview{width:100%;border-radius:var(--radius);margin-top:12px;border:1px solid var(--border)}
    .composer-actions{display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
    .icon-btn{background:none;border:none;color:var(--text2);cursor:pointer;padding:8px;border-radius:8px;transition:var(--trans);display:flex;align-items:center;gap:8px;font-size:15px;font-weight:500}
    .icon-btn:hover{background:var(--hover-accent);color:var(--text)}
    .post-btn{background:var(--accent-blue);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:600;font-size:15px;cursor:pointer;transition:opacity var(--trans)}
    .post-btn:disabled{opacity:.5;cursor:default}
    .post-btn:hover:not(:disabled){background:#166fe5}
    .spinner{border:3px solid rgba(255,255,255,.3);border-top:3px solid #fff;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* ---------- POST CARDS (Facebook Style) ---------- */
    .post-card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      margin:0 auto 16px;
      max-width:680px;
      transition:var(--trans);
      position:relative;
    }
    .post-card:hover{box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .post-header{display:flex;align-items:center;gap:12px;padding:16px 16px 12px}
    .post-avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex-shrink:0;cursor:pointer}
    .user-info{flex:1}
    .user-name{font-size:15px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:4px}
    .user-handle{font-size:13px;color:var(--text2)}
    .post-time{font-size:13px;color:var(--text2)}
    .verified-badge{color:var(--accent-blue);font-size:16px!important}
    .post-content{padding:0 16px 12px;font-size:15px;line-height:1.5;color:var(--text);white-space:pre-wrap}
    .post-image,.post-video{width:100%;max-height:500px;object-fit:cover;margin:0;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    .post-video{max-height:400px}
    .post-actions{display:flex;align-items:center;justify-content:space-around;padding:8px 16px;border-top:1px solid var(--border)}
    .action-item{display:flex;align-items:center;gap:6px;font-size:15px;color:var(--text2);cursor:pointer;padding:8px;border-radius:6px;transition:var(--trans);font-weight:500}
    .action-item:hover{background:var(--hover-accent)}
    .action-item svg{width:20px;height:20px;stroke-width:1.8}
    .action-item.liked{color:var(--accent-blue)}
    .action-item.liked svg{fill:var(--accent-blue)}
    .action-item.disabled{opacity:0.5;cursor:not-allowed;pointer-events:none}
    .action-item.reply:hover{color:var(--accent-blue)}
    .action-item.repost:hover{color:var(--accent-green)}
    .action-item.like:hover{color:var(--accent-blue)}
    .action-item.delete-btn:hover{color:#f4212e}
    /* ---------- SKELETON LOADER ---------- */
    .skeleton-post{background:var(--card);border-radius:var(--radius);box-shadow:var(--card-shadow);margin:0 auto 16px;max-width:680px;padding:16px;animation:shimmer 1.5s infinite}
    .skeleton-avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;background:var(--border);flex-shrink:0}
    .skeleton-line{height:16px;background:var(--border);border-radius:8px;margin-bottom:8px}
    .skeleton-text{height:12px;background:var(--border);border-radius:6px;margin-bottom:6px}
    .skeleton-image{height:200px;background:var(--border);border-radius:var(--radius);margin-top:12px}
    /* ---------- VIDEO PLAY OVERLAY ---------- */
    .video-play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .video-play-overlay .material-icons{font-size:48px;color:var(--accent-blue);text-shadow:0 2px 8px rgba(0,0,0,.45);background:rgba(0,0,0,.35);border-radius:50%;padding:10px}
    .post-video-wrapper{position:relative;display:block;width:100%}
    /* ---------- MODAL ---------- */
    #image-modal{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:150;display:none;align-items:center;justify-content:center;animation:fadeIn .2s ease-out}
    #image-modal.show{display:flex!important}
    #modal-image,#modal-video{max-width:95%;max-height:95%;object-fit:contain;border-radius:8px;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
    #modal-video{display:none}#modal-video.show{display:block}
    .video-controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);backdrop-filter:blur(10px);border-radius:50px;padding:12px 20px;display:flex;align-items:center;gap:15px;z-index:160}
    .video-controls button{background:none;border:none;color:#fff;cursor:pointer;display:flex;align-items:center;padding:5px;border-radius:50%;transition:var(--trans)}
    .video-controls button:hover{background:rgba(255,255,255,.2);transform:scale(1.1)}
    .video-progress{flex:1;height:4px;background:rgba(255,255,255,.3);border-radius:2px;cursor:pointer;position:relative;min-width:200px}
    .video-progress-bar{height:100%;background:var(--accent-blue);border-radius:2px;width:0%;transition:width .1s}
    .video-time{color:#fff;font-size:13px;font-weight:500;min-width:80px;text-align:center}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    /* ---------- COMMENT SHEET ---------- */
    #comment-sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:90;opacity:0;pointer-events:none;transition:opacity .3s ease}
    #comment-sheet-overlay.show{opacity:1;pointer-events:auto}
    .comment-sheet{position:absolute;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);border-top-left-radius:12px;border-top-right-radius:12px;max-height:75vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s ease}
    #comment-sheet-overlay.show .comment-sheet{transform:translateY(0)}
    .comment-sheet-header{padding:16px;font-size:18px;font-weight:600;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .comment-sheet-close{background:none;border:none;color:var(--text2);cursor:pointer}
    .comment-sheet-list{flex:1;overflow-y:auto;padding:0 16px}
    .comment-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
    .comment-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover}
    .comment-body{flex:1}
    .comment-name{font-size:14px;font-weight:600}
    .comment-text{font-size:15px;margin-top:2px;color:var(--text)}
    .comment-input-box{display:flex;gap:12px;padding:16px;border-top:1px solid var(--border)}
    .comment-input{flex:1;resize:none;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:20px;padding:10px 16px;font-size:15px;outline:none;background:var(--bg)}
    .comment-send-btn{background:var(--accent-blue);color:#fff;border:none;border-radius:50%;width:40px;height:40px;display:grid;place-items:center;cursor:pointer;transition:opacity var(--trans)}
    .comment-send-btn:disabled{opacity:.5;cursor:default}
    /* ---------- TOAST / ALERT ---------- */
    .custom-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--accent-blue);color:#fff;padding:12px 24px;border-radius:20px;box-shadow:0 10px 15px -3px rgba(0,0,0,.3);font-weight:600;opacity:0;transition:all .4s cubic-bezier(.175,.885,.32,1.275);z-index:50;display:flex;align-items:center;gap:8px}
    .custom-toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    #custom-alert-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .25s ease}
    #custom-alert-overlay.show{opacity:1;pointer-events:auto}
    .custom-alert-box{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:320px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,.25);transform:scale(.95);transition:transform .25s ease}
    #custom-alert-overlay.show .custom-alert-box{transform:scale(1)}
    .custom-alert-title{font-weight:600;font-size:16px;margin-bottom:8px}
    .custom-alert-message{font-size:14px;color:var(--text2);margin-bottom:20px}
    .custom-alert-buttons{display:flex;gap:12px;justify-content:flex-end}
    .custom-alert-btn{background:none;border:none;font-size:14px;font-weight:600;cursor:pointer;padding:8px 16px;border-radius:6px;transition:background var(--trans)}
    .custom-alert-btn.cancel{color:var(--text2)}.custom-alert-btn.cancel:hover{background:var(--hover-accent)}
    [data-theme="dark"] .custom-alert-btn.cancel:hover{background:rgba(255,255,255,.05)}
    .custom-alert-btn.confirm{background:var(--accent-blue);color:#fff}.custom-alert-btn.confirm:hover{opacity:.9}
    /* ---------- NAVBAR & FAB ---------- */
    nav{position:fixed;bottom:0;left:0;right:0;height:64px;background:var(--card);border-top:1px solid var(--border);z-index:40;transition:transform var(--trans);display:flex;align-items:center;justify-content:center}
    nav.hidden{transform:translateY(100%)}
    .pill-tabs{
      display:flex;
      background:var(--bg);
      border-radius:9999px;
      padding:4px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      gap:4px;
    }
    .pill-tab{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:8px 16px;
      border-radius:9999px;
      transition:var(--trans);
      min-width:120px;
      font-size:14px;
      font-weight:500;
      color:var(--text2);
    }
    .pill-tab.active{
      background:var(--accent-blue);
      color:#fff;
    }
    .pill-tab .material-icons{font-size:24px;margin-bottom:4px}
    .fab{position:fixed;bottom:72px;right:20px;width:48px;height:48px;background:var(--accent-blue);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(24,119,242,.4);cursor:pointer;transition:var(--trans);z-index:30}
    .fab:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(24,119,242,.6)}
    .fab.hidden{transform:scale(0)}
    /* ---------- MISC HELPERS ---------- */
    .skeleton{background:linear-gradient(90deg,var(--border) 25%,rgba(0,0,0,.05) 50%,var(--border) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
    [data-theme="dark"] .skeleton{background:linear-gradient(90deg,var(--border) 25%,rgba(255,255,255,.05) 50%,var(--border) 75%);background-size:200% 100%}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .hidden{display:none}
    .text-center{text-align:center}
    .p-4{padding:16px}
    .p-8{padding:32px}
    .text-gray-500{color:var(--text2)}
    .text-red-500{color:#f4212e}
    .composer-top-row{
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.composer-input-col{
  flex:1;
}
    .post-content .hash-link,
.post-content .url-link{
  color: var(--accent-blue); /* #1877f2 */
  font-weight: 500;
  text-decoration: none;
}
.post-content .hash-link:hover,
.post-content .url-link:hover{
  text-decoration: underline;
}
    .mention-dd{
  position:absolute;
  z-index:60;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--card-shadow);
  max-height:200px;
  overflow-y:auto;
  min-width:180px;
}
.mention-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 12px;
  cursor:pointer;
  transition:background var(--trans);
}
.mention-item:hover,
.mention-item.selected{
  background:var(--hover-accent);
}
.mention-item img{
  width:32px;height:32px;border-radius:50%;object-fit:cover;
}
.mention-name{font-size:14px;font-weight:600;color:var(--text);}
.mention-handle{font-size:13px;color:var(--text2);}
    .post-content .mention-link{color:var(--accent-blue);font-weight:500;text-decoration:none;}
.post-content .mention-link:hover{text-decoration:underline;}
    /* ---------- AUTH SHEET ---------- */
    #auth-sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:90;opacity:0;pointer-events:none;transition:opacity .3s ease}
    #auth-sheet-overlay.show{opacity:1;pointer-events:auto}
    .auth-sheet{position:absolute;bottom:0;left:0;right:0;background:var(--card);border-top-left-radius:20px;border-top-right-radius:20px;max-height:90vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s ease;overflow:hidden}
    #auth-sheet-overlay.show .auth-sheet{transform:translateY(0)}
    .auth-sheet-header{padding:16px;font-size:20px;font-weight:600;text-align:center;position:relative;border-bottom:1px solid var(--border)}
    .auth-sheet-close{background:none;border:none;color:var(--text2);cursor:pointer;position:absolute;left:16px;top:16px}
    .auth-sheet-body{flex:1;overflow-y:auto;padding:24px}
    .auth-tab-btn{display:inline-block;padding:12px 24px;font-weight:600;color:var(--text2);border-bottom:3px solid transparent;transition:var(--trans);margin:0 16px}
    .auth-tab-btn.active{color:var(--accent-blue);border-bottom:3px solid var(--accent-blue)}
    .auth-form{margin-top:32px;display:none}
    .auth-form.active{display:block}
    .auth-input{width:100%;padding:14px 16px;margin-bottom:16px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text);font-size:16px}
    .auth-btn{width:100%;background:var(--accent-blue);color:#fff;padding:14px;border:none;border-radius:12px;font-weight:600;font-size:16px;cursor:pointer;margin-top:12px}
    .auth-btn:disabled{opacity:0.5;cursor:default}
    .profile-preview{margin-top:16px;text-align:center}
    .profile-preview img{width:80px;height:80px;border-radius:50%;object-fit:cover}
    /* ---------- PROFILE SHEET (Avatar at top) ---------- */
    #profile-sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:90;opacity:0;pointer-events:none;transition:opacity .3s ease}
    #profile-sheet-overlay.show{opacity:1;pointer-events:auto}
    .profile-sheet{position:absolute;bottom:0;left:0;right:0;background:var(--card);border-top-left-radius:28px;border-top-right-radius:28px;max-height:90vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .35s cubic-bezier(0.22,1,0.36,1);overflow:hidden;box-shadow:0 -8px 32px rgba(0,0,0,.15)}
    #profile-sheet-overlay.show .profile-sheet{transform:translateY(0)}
    .profile-sheet-header{position:relative;padding:32px 32px 80px;text-align:center}
    .profile-sheet-header-bg{position:absolute;inset:0;background:linear-gradient(135deg,var(--accent-blue),#a855f7);border-top-left-radius:28px;border-top-right-radius:28px}
    .profile-sheet-header-bg::after{content:'';position:absolute;inset:0;background:rgba(0,0,0,.15)}
    .profile-avatar-big{width:140px;height:140px;border-radius:50%;border:6px solid var(--card);object-fit:cover;box-shadow:0 4px 16px rgba(0,0,0,.2);position:relative;z-index:10}
    .profile-sheet-close{background:none;border:none;color:#fff;font-size:28px;cursor:pointer;position:absolute;right:16px;top:16px;z-index:20}
    .profile-sheet-body{padding:16px 32px 32px;text-align:center}
    .profile-name-display{font-size:28px;font-weight:700;margin-bottom:8px;color:var(--text)}
    .profile-handle{font-size:18px;color:var(--text2);margin-bottom:32px}
    .profile-edit-section{display:none}
    .profile-edit-section.active{display:block}
    #profile-edit-name{width:100%;padding:16px 20px;margin:24px 0;border:1px solid var(--border);border-radius:20px;background:var(--bg);color:var(--text);font-size:18px;text-align:center;font-weight:600}
    .pill-btn{display:block;width:100%;padding:14px;background:var(--accent-blue);color:#fff;border:none;border-radius:9999px;font-weight:600;font-size:16px;cursor:pointer;margin-bottom:16px;transition:transform .2s,opacity .2s;box-shadow:0 4px 12px rgba(24,119,242,.3)}
    .pill-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(24,119,242,.4)}
    .pill-btn:disabled{opacity:.6}
    .pill-btn.secondary{background:var(--text2);color:var(--card)}
    .profile-photo-preview{margin:20px 0}
    .profile-photo-preview img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--border)}
    .remove-photo-btn{color:#f4212e;font-size:14px;margin-top:8px;cursor:pointer}


    /* ---------- FLOATING SIGN-IN CARD ---------- */
#signin-float-card {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 12px 16px;
  z-index: 45;
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 90%;
  width: 400px;
  transition: transform 0.3s ease, opacity 0.3s ease;
}
#signin-float-card.hidden {
  transform: translateX(-50%) translateY(-120%);
  opacity: 0;
  pointer-events: none;
}
#signin-float-card .avatar-small {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}
#signin-float-card .text-col {
  flex: 1;
  font-size: 14px;
  line-height: 1.3;
}
#signin-float-card .title {
  font-weight: 600;
  color: var(--text);
}
#signin-float-card .subtitle {
  color: var(--text2);
  font-size: 13px;
}
#signin-float-card .signin-btn {
  background: var(--accent-blue);
  color: #fff;
  border: none;
  border-radius: 20px;
  padding: 6px 14px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: opacity 0.2s;
}
#signin-float-card .signin-btn:hover {
  opacity: 0.9;
}
#signin-float-card .close-btn {
  background: none;
  border: none;
  color: var(--text2);
  cursor: pointer;
  padding: 4px;
  border-radius: 50%;
  display: grid;
  place-items: center;
}
#signin-float-card .close-btn:hover {
  background: var(--hover-accent);
}
  </style>
</head>
<body>
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#1877f2] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix for a better experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="bg-white text-[#1877f2] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-icons text-xl">close</span>
      </button>
    </div>
  </div>


  <!-- Floating sign-in prompt -->
<div id="signin-float-card" class="hidden">
  <img class="avatar-small" src="https://ui-avatars.com/api/?background=1877f2&color=fff&name=Guest" alt="avatar">
  <div class="text-col">
    <div class="title">Sign in to post & interact</div>
    <div class="subtitle">Join the conversation and connect with friends</div>
  </div>
  <button class="signin-btn" id="signin-float-btn">Sign In</button>
  <button class="close-btn material-icons-outlined" id="signin-float-close">close</button>
</div>
  
 <!-- ---------- COMPOSER (avatar now inside input row) ---------- -->
<div class="composer">
  <!-- NEW: single row for avatar + input -->
  <div class="composer-top-row">
    <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=1877f2&color=fff" alt="avatar"/>
    <div class="composer-input-col">
      <textarea id="post-text" placeholder="What's on your mind?"></textarea>
      <video id="media-preview-video" class="media-preview hidden" controls muted loop playsinline></video>
      <img id="media-preview-img" class="media-preview hidden" alt=""/>
    </div>
  </div>
  <!-- actions stay below -->
  <div class="composer-actions">
    <div>
      <input type="file" id="file-input" accept="image/*,video/*" class="hidden"/>
      <label for="file-input" class="icon-btn" title="Add Photo/Video">
        <span class="material-icons-outlined">photo_library</span>
        <span>Photo/Video</span>
      </label>
    </div>
    <button id="post-btn" class="post-btn" disabled>
      <span id="btn-text">Post</span>
      <span id="btn-spinner" class="spinner hidden"></span>
    </button>
  </div>
</div>
  <main id="feed" class="feed"></main>
 
  <div class="text-center p-4">
    <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
  </div>
  <!-- Floating Action Button -->
  <div id="fab" class="fab hidden">
    <span class="material-icons">add</span>
  </div>
  <!-- Alert Modal -->
  <div id="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
      <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
      <div class="custom-alert-buttons">
        <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
        <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
      </div>
    </div>
  </div>
  <!-- Comment Sheet -->
  <div id="comment-sheet-overlay">
    <div class="comment-sheet">
      <div class="comment-sheet-header">
        <span>Comments</span>
        <button class="comment-sheet-close material-icons-outlined" id="comment-sheet-close">close</button>
      </div>
      <div class="comment-sheet-list" id="comment-sheet-list"></div>
      <div class="comment-input-box">
        <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
        <button class="comment-send-btn" id="comment-send-btn">
          <span class="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  </div>
  <!-- Image/Video Modal -->
  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <video id="modal-video" loop>
      <source src="" type="video/mp4">
    </video>
    <div class="video-controls" id="video-controls" style="display: none;">
      <button id="play-pause-btn">
        <span class="material-icons-outlined">play_arrow</span>
      </button>
      <span class="video-time" id="video-time">0:00 / 0:00</span>
      <div class="video-progress" id="video-progress">
        <div class="video-progress-bar" id="video-progress-bar"></div>
      </div>
      <button id="mute-btn">
        <span class="material-icons-outlined">volume_up</span>
      </button>
    </div>
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>
  <!-- Mention autocomplete -->
<div id="mention-dropdown" class="mention-dd hidden"></div>
  <!-- New Pill-Shaped Navigation (replaces old navbar) -->
  <nav id="navbar">
    <div class="pill-tabs">
      <a href="index.html" class="pill-tab" id="tab-feed">
        <span class="material-icons-outlined">home</span>
        <span>Feed</span>
      </a>
      <a href="chat.html" class="pill-tab" id="tab-chat">
        <span class="material-icons-outlined">chat_bubble_outline</span>
        <span>Chats</span>
      </a>
    </div>
  </nav>
  <!-- Auth Bottom Sheet -->
  <div id="auth-sheet-overlay">
    <div class="auth-sheet">
      <div class="auth-sheet-header">
        <button class="auth-sheet-close material-icons-outlined" id="auth-sheet-close">close</button>
        <span id="auth-sheet-title">Sign Up</span>
      </div>
      <div class="auth-sheet-body">
        <div class="flex justify-center mb-4">
          <button class="auth-tab-btn active" data-tab="signup">Sign Up</button>
          <button class="auth-tab-btn" data-tab="signin">Sign In</button>
        </div>
        <form id="signup-form" class="auth-form active">
          <input type="email" class="auth-input" id="signup-email" placeholder="Email" required>
          <input type="password" class="auth-input" id="signup-password" placeholder="Password (min 6 chars)" required>
          <input type="text" class="auth-input" id="signup-name" placeholder="Display Name" required>
          <div class="profile-preview">
            <img id="signup-avatar-preview" src="https://ui-avatars.com/api/?background=1877f2&color=fff&name=User">
            <p class="text-sm text-gray-500 mt-2">Avatar generated from name</p>
          </div>
          <button type="submit" class="auth-btn" id="signup-btn">Create Account</button>
        </form>
        <form id="signin-form" class="auth-form">
          <input type="email" class="auth-input" id="signin-email" placeholder="Email" required>
          <input type="password" class="auth-input" id="signin-password" placeholder="Password" required>
          <button type="submit" class="auth-btn" id="signin-btn">Sign In</button>
        </form>
        <p class="text-center text-sm text-gray-500 mt-8">By continuing, you agree to our Terms</p>
      </div>
    </div>
  </div>
  <!-- Profile Bottom Sheet (Avatar at top) -->
  <div id="profile-sheet-overlay">
    <div class="profile-sheet">
      <div class="profile-sheet-header">
        <div class="profile-sheet-header-bg"></div>
        <button class="profile-sheet-close material-icons-outlined" id="profile-sheet-close">close</button>
        <img id="profile-avatar-big" class="profile-avatar-big" src="">
      </div>
      <div class="profile-sheet-body">
        <div id="profile-view-section" class="profile-edit-section active">
          <div class="profile-name-display" id="profile-name"></div>
          <div class="profile-handle" id="profile-handle"></div>
        </div>
        <div id="profile-edit-section" class="profile-edit-section">
          <input type="text" id="profile-edit-name" placeholder="Display Name">
          <div class="profile-photo-preview">
            <img id="profile-photo-preview-img" src="">
          </div>
          <label class="pill-btn">
            <span>Change Photo</span>
            <input type="file" id="profile-photo-input" accept="image/*" class="hidden">
          </label>
          <button class="pill-btn secondary remove-photo-btn hidden" id="remove-photo-btn">Remove Photo</button>
          <button class="pill-btn" id="profile-save-btn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword, EmailAuthProvider, linkWithCredential } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
let uid = null, uname = 'Guest', uavatar = '';
let isAnonymous = true;
const CLOUD_NAME = "dqkujefxj";
const UPLOAD_PRESET = "banter_box";
const $ = s => document.querySelector(s);
const postBtn = $('#post-btn'), textEl = $('#post-text'),
      previewImg = $('#media-preview-img'), previewVid = $('#media-preview-video'),
      fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
      loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 10;
let lastTimestamp = null, lastKey = null, initialLoadDone = false;
if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.body.setAttribute('data-theme', 'dark');
// Enhanced authentication with anonymous support
onAuthStateChanged(auth, user => {
  if (user) {
    uid = user.uid;
    uname = user.displayName || 'User';
    uavatar = user.photoURL || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${uname}`;
    myAvatarEl.src = uavatar;
    isAnonymous = user.isAnonymous;
    initFeed();
  } else {
    signInAnonymously(auth);
  }
});
function setupAnonymousUser() {
  uid = auth.currentUser?.uid || "anonymous_" + Math.random().toString(36).slice(2);
  uname = "Guest";
  uavatar = `https://ui-avatars.com/api/?background=1877f2&color=fff&name=Guest`;
  myAvatarEl.src = uavatar;
  isAnonymous = true;
  initFeed();
}
// Auth sheet elements
const authOverlay = $('#auth-sheet-overlay');
const authClose = $('#auth-sheet-close');
const authTitle = $('#auth-sheet-title');
const tabBtns = document.querySelectorAll('.auth-tab-btn');
const forms = document.querySelectorAll('.auth-form');
const signupForm = $('#signup-form');
const signinForm = $('#signin-form');
const signupName = $('#signup-name');
const signupAvatarPreview = $('#signup-avatar-preview');
function openAuthSheet(mode = 'signup') {
  tabBtns.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === mode);
  });
  forms.forEach(f => f.classList.toggle('active', f.id === mode + '-form'));
  authTitle.textContent = mode === 'signup' ? 'Sign Up' : 'Sign In';
  authOverlay.classList.add('show');
}
function closeAuthSheet() {
  authOverlay.classList.remove('show');
}
authClose.onclick = closeAuthSheet;
authOverlay.onclick = e => { if (e.target === authOverlay) closeAuthSheet(); };
tabBtns.forEach(btn => btn.onclick = () => openAuthSheet(btn.dataset.tab));
// Preview avatar on name input
signupName.oninput = () => {
  const name = signupName.value.trim() || 'User';
  signupAvatarPreview.src = `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(name)}`;
};
// Sign up handler (upgrade anonymous)
signupForm.onsubmit = async e => {
  e.preventDefault();
  const email = $('#signup-email').value.trim();
  const password = $('#signup-password').value;
  const name = signupName.value.trim() || 'User';
  if (!email || !password || password.length < 6) {
    toast('Please fill valid email and password (min 6 chars)');
    return;
  }
  const btn = $('#signup-btn');
  btn.disabled = true;
  btn.textContent = 'Creating...';
  try {
    const credential = EmailAuthProvider.credential(email, password);
    const userCred = await auth.currentUser.linkWithCredential(credential);
    await updateProfile(userCred.user, {
      displayName: name,
      photoURL: `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(name)}`
    });
    await set(ref(db, `users/${uid}/profile`), {
      displayName: name,
      avatar: userCred.user.photoURL,
      verified: false
    });
    toast('Account created and upgraded!');
    closeAuthSheet();
  } catch (err) {
    if (err.code === 'auth/email-already-in-use') {
      toast('Email already in use. Try signing in.');
    } else {
      toast('Error: ' + err.message);
    }
  } finally {
    btn.disabled = false;
    btn.textContent = 'Create Account';
  }
};
// Sign in handler
signinForm.onsubmit = async e => {
  e.preventDefault();
  const email = $('#signin-email').value.trim();
  const password = $('#signin-password').value;
  if (!email || !password) return;
  const btn = $('#signin-btn');
  btn.disabled = true;
  btn.textContent = 'Signing in...';
  try {
    await signInWithEmailAndPassword(auth, email, password);
    toast('Signed in!');
    closeAuthSheet();
  } catch (err) {
    toast('Error: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sign In';
  }
};
// Function to require auth
function requireAuth() {
  if (isAnonymous) {
    openAuthSheet('signup');
    return true;
  }
  return false;
}
// Profile sheet elements
const profileOverlay = $('#profile-sheet-overlay');
const profileClose = $('#profile-sheet-close');
const profileAvatarBig = $('#profile-avatar-big');
const profilePhotoPreviewImg = $('#profile-photo-preview-img');
const profileNameEl = $('#profile-name');
const profileHandleEl = $('#profile-handle');
const profileViewSection = $('#profile-view-section');
const profileEditSection = $('#profile-edit-section');
const profileEditName = $('#profile-edit-name');
const profilePhotoInput = $('#profile-photo-input');
const removePhotoBtn = $('#remove-photo-btn');
const profileSaveBtn = $('#profile-save-btn');
let currentProfileUid = null;
let pendingAvatarUrl = null; // for new photo before save
function openProfileSheet(profileUid) {
  currentProfileUid = profileUid;
  const isOwn = profileUid === uid;
  profileViewSection.classList.toggle('active', !isOwn);
  profileEditSection.classList.toggle('active', isOwn);
  pendingAvatarUrl = null;
  removePhotoBtn.classList.add('hidden');
  // Load profile data
  onValue(ref(db, `users/${profileUid}/profile`), snap => {
    const p = snap.val() || {};
    const name = p.displayName || 'User';
    const avatar = p.avatar || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(name)}`;
    profileAvatarBig.src = avatar;
    profilePhotoPreviewImg.src = avatar;
    profileNameEl.textContent = name;
    profileHandleEl.textContent = `@${name.replace(/\s/g, '').toLowerCase()}`;
    if (isOwn) {
      profileEditName.value = name;
    }
  }, { onlyOnce: true });
  profileOverlay.classList.add('show');
}
function closeProfileSheet() {
  profileOverlay.classList.remove('show');
  currentProfileUid = null;
  pendingAvatarUrl = null;
}
profileClose.onclick = closeProfileSheet;
profileOverlay.onclick = e => { if (e.target === profileOverlay) closeProfileSheet(); };
// Handle profile photo change (instant update on success)
profilePhotoInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => {
    profilePhotoPreviewImg.src = ev.target.result;
    removePhotoBtn.classList.remove('hidden');
  };
  r.readAsDataURL(file);
  uploadProfilePhoto(file);
};
function uploadProfilePhoto(file) {
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(res => {
      const newUrl = res.secure_url;
      pendingAvatarUrl = newUrl;
      // Instantly update all visible avatars (myAvatar, big avatar, preview, and all post avatars)
      myAvatarEl.src = newUrl;
      profileAvatarBig.src = newUrl;
      profilePhotoPreviewImg.src = newUrl;
      document.querySelectorAll(`.post-avatar[data-uid="${uid}"]`).forEach(img => img.src = newUrl);
      toast('Profile picture updated instantly!');
    })
    .catch(err => {
      toast('Upload failed');
      console.error(err);
    });
}
removePhotoBtn.onclick = () => {
  const fallback = `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(profileEditName.value || 'User')}`;
  pendingAvatarUrl = fallback;
  profilePhotoPreviewImg.src = fallback;
  myAvatarEl.src = fallback;
  profileAvatarBig.src = fallback;
  document.querySelectorAll(`.post-avatar[data-uid="${uid}"]`).forEach(img => img.src = fallback);
  removePhotoBtn.classList.add('hidden');
  toast('Photo removed instantly (saved on close)');
};
// Save profile changes (name only, photo already instant)
profileSaveBtn.onclick = async () => {
  const newName = profileEditName.value.trim() || 'User';
  const newAvatar = pendingAvatarUrl || profileAvatarBig.src;
  try {
    await updateProfile(auth.currentUser, {
      displayName: newName,
      photoURL: newAvatar
    });
    await set(ref(db, `users/${uid}/profile`), {
      displayName: newName,
      avatar: newAvatar,
      verified: false
    });
    uname = newName;
    uavatar = newAvatar;
    // Update name in all post cards (simple refresh of visible ones)
    document.querySelectorAll(`.post-card .user-name .name`).forEach(el => {
      if (el.closest('.post-card').querySelector(`.post-avatar`).dataset.uid === uid) {
        el.textContent = newName;
      }
    });
    toast('Profile name saved!');
    closeProfileSheet();
  } catch (err) {
    toast('Error updating name: ' + err.message);
  }
};
/* ---------- helper: write profile fields that feed cards listen to ---------- */
function updateUserProfile(updates) {
  return set(ref(db, `users/${uid}/profile`), updates);
}
function showSkeletonLoaders(count = 5) {
  feedEl.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton-post';
    skeleton.innerHTML = `
      <div class="post-header">
        <div class="skeleton skeleton-avatar"></div>
        <div class="flex-1">
          <div class="skeleton skeleton-line" style="width: 40%; margin-bottom: 8px;"></div>
          <div class="skeleton skeleton-text" style="width: 85%;"></div>
          <div class="skeleton skeleton-text" style="width: 70%;"></div>
        </div>
      </div>
    `;
    feedEl.appendChild(skeleton);
  }
}
async function initFeed() {
  showSkeletonLoaders(5);
  try {
    const postsRef = ref(db, 'posts');
    const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
    const snap = await get(q);
   
    if (!snap.exists()) {
      feedEl.innerHTML = '<div class="text-center p-8 text-gray-500">No posts yet. Be the first to post!</div>';
      loadMoreBtn.classList.add('hidden');
      initialLoadDone = true;
      return;
    }
   
    feedEl.innerHTML = '';
    const rows = [];
    snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
    rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
   
    const last = rows[rows.length-1];
    if (last) {
      lastTimestamp = last.timestamp;
      lastKey = last.key;
    }
   
    loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
    initialLoadDone = true;
    listenNew();
   
  } catch (e) {
    console.error('Error loading posts:', e);
    feedEl.innerHTML = '<div class="text-center p-8 text-red-500">Error loading posts. Please check your connection and try again.</div>';
    toast('Error loading posts: ' + e.message);
  }
}
function listenNew() {
  const postsRef = ref(db, 'posts');
  onChildAdded(postsRef, snap => {
    if (!initialLoadDone) return;
    const data = snap.val();
    if (!data || !data.timestamp) return;
    if (!lastTimestamp || data.timestamp > lastTimestamp) {
      feedEl.prepend(renderPostCard({key: snap.key, ...data}));
      lastTimestamp = data.timestamp;
    }
  });
}
loadMoreBtn.onclick = async () => {
  loadMoreBtn.disabled = true;
  loadMoreBtn.textContent = 'Loading...';
 
  try {
    const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT+1));
    const snap = await get(q);
   
    const rows = [];
    snap.forEach(c => rows.push({key: c.key, ...c.val()}));
    const uniq = rows.filter(p => p.key !== lastKey);
   
    if (!uniq.length) {
      toast('No more posts');
      loadMoreBtn.classList.add('hidden');
      return;
    }
   
    uniq.reverse();
    uniq.forEach(p => feedEl.appendChild(renderPostCard(p)));
   
    const last = uniq[uniq.length-1];
    lastTimestamp = last.timestamp;
    lastKey = last.key;
   
    if (uniq.length < POST_LIMIT) loadMoreBtn.classList.add('hidden');
   
  } catch (e) {
    console.error('Error loading more posts:', e);
    toast('Error loading more posts');
  } finally {
    loadMoreBtn.disabled = false;
    loadMoreBtn.textContent = 'Load More Posts';
  }
};
let mediaUrl = '', uploading = false;
function toggleBtn() {
  postBtn.disabled = uploading || (!textEl.value.trim() && !mediaUrl);
}
fileInput.onchange = e => {
  if (requireAuth()) return;
  const file = e.target.files[0];
  if (!file) return;
 
  const isVideo = file.type.startsWith('video/');
  const isImage = file.type.startsWith('image/');
 
  if (!isVideo && !isImage) {
    toast('Only images or videos');
    return;
  }
 
  const r = new FileReader();
  r.onload = ev => {
    if (isVideo) {
      previewVid.src = ev.target.result;
      previewVid.classList.remove('hidden');
      previewImg.classList.add('hidden');
    } else {
      previewImg.src = ev.target.result;
      previewImg.classList.remove('hidden');
      previewVid.classList.add('hidden');
    }
  };
  r.readAsDataURL(file);
  uploadToCloudinary(file);
};
function uploadToCloudinary(file) {
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
 
  uploading = true;
  toggleBtn();
 
  $('#btn-spinner').classList.remove('hidden');
  $('#btn-text').classList.add('hidden');
 
  fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(async res => {
      mediaUrl = res.secure_url;
      toast('Media uploaded');
    })
    .catch(err => {
      toast('Upload failed');
      mediaUrl = '';
      previewImg.classList.add('hidden');
      previewVid.classList.add('hidden');
      console.error(err);
    })
    .finally(() => {
      uploading = false;
      $('#btn-spinner').classList.add('hidden');
      $('#btn-text').classList.remove('hidden');
      toggleBtn();
    });
}
postBtn.onclick = async () => {
  if (requireAuth()) return;
  const text = textEl.value.trim();
  if (!text && !mediaUrl) return;
 
  postBtn.disabled = true;
  $('#btn-spinner').classList.remove('hidden');
  $('#btn-text').classList.add('hidden');
 
  try {
    const newRef = push(ref(db, 'posts'));
    const postData = {
      authorId: uid,
      authorName: uname,
      authorAvatar: uavatar,
      text,
      image: mediaUrl,
      verified: false,
      likes: 0,
      replies: 0,
      reposts: 0,
      timestamp: serverTimestamp()
    };
   
    await set(newRef, postData);
   
    textEl.value = '';
    mediaUrl = '';
    previewImg.classList.add('hidden');
    previewVid.classList.add('hidden');
    toggleBtn();
    toast('Posted!');
   
  } catch (err) {
    console.error('Error posting:', err);
    toast('Error posting: ' + err.message);
  } finally {
    $('#btn-spinner').classList.add('hidden');
    $('#btn-text').classList.remove('hidden');
    postBtn.disabled = false;
  }
};
textEl.oninput = () => {
  textEl.style.height = 'auto';
  textEl.style.height = textEl.scrollHeight + 'px';
  toggleBtn();
};
/* ---------- real-time user-data helper ---------- */
const userMetaCache = new Map(); // uid → {name, avatar, verified}
function listenUserMeta(uid, card) {
  if (userMetaCache.has(uid)) return applyUserMeta(card, userMetaCache.get(uid));
  const unsub = onValue(ref(db, `users/${uid}/profile`), snap => {
    const v = snap.val() || {};
    const meta = { name: v.displayName || 'User', avatar: v.avatar || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${v.displayName || 'User'}`, verified: !!v.verified };
    userMetaCache.set(uid, meta);
    applyUserMeta(card, meta);
  });
  card._unsubUser = unsub;
}
function applyUserMeta(card, meta) {
  card.querySelector('.user-name .name').textContent = esc(meta.name);
  card.querySelector('.user-handle').textContent = `@${meta.name.replace(/\s/g, '').toLowerCase()}`;
  card.querySelector('.post-avatar').src = meta.avatar;
  const badge = card.querySelector('.verified-badge');
  badge.style.display = meta.verified ? 'inline' : 'none';
}
function renderPostCard(p) {
  const isMine = p.authorId === uid;
  const div = document.createElement('div');
  div.id = `post-${p.key}`;
  div.className = 'post-card';
 
  /* build card - Facebook style */
  div.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar}" class="post-avatar" data-uid="${p.authorId}">
      <div class="user-info">
        <div class="user-name">
          <span class="name">${esc(p.authorName)}</span>
          <span class="verified-badge material-icons text-sm" style="display:none">verified</span>
        </div>
        <div class="user-handle">@${p.authorName.replace(/\s/g,'').toLowerCase()}</div>
        <div class="post-time">${timeAgo(p.timestamp || Date.now())}</div>
      </div>
    </div>
    <div class="post-content">${linkify(esc(p.text))}</div>
    ${mediaMarkup(p.image)}
    <div class="post-actions">
      <div class="action-item reply ${isAnonymous ? 'disabled' : ''}" data-post="${p.key}" data-action="reply">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        <span id="replies-${p.key}">${p.replies||0}</span>
      </div>
      <div class="action-item repost ${isAnonymous ? 'disabled' : ''}" data-post="${p.key}" data-action="repost">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2l4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
        <span id="reposts-${p.key}">${p.reposts||0}</span>
      </div>
      <div class="action-item like ${isAnonymous ? 'disabled' : ''}" data-post="${p.key}" data-action="like">
        <svg class="outline-heart" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <svg class="filled-heart hidden" width="20" height="20" viewBox="0 0 24 24" fill="#1877f2" stroke="#1877f2" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <span id="likes-${p.key}">${p.likes||0}</span>
      </div>
      <div class="action-item share" data-post="${p.key}" data-action="share">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </div>
      ${isMine && !isAnonymous ? `<div class="action-item delete-btn" data-post="${p.key}" data-action="delete">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      </div>` : ''}
    </div>`;
 
  /* ---------- timestamp correction ---------- */
  const stampEl = div.querySelector('.post-time');
  if (!p.timestamp) {
    onValue(ref(db, `posts/${p.key}/timestamp`), snap => {
      const v = snap.val();
      if (v) stampEl.textContent = timeAgo(v);
    }, { onlyOnce: true });
  }
 
  /* ---------- attach event listeners ---------- */
  div.addEventListener('click', e => {
    if (e.target.classList.contains('post-avatar')) {
      const clickedUid = e.target.dataset.uid;
      openProfileSheet(clickedUid);
      return;
    }
    if (e.target.classList.contains('post-image')) { openImageModal(e.target.src); return; }
    if (e.target.classList.contains('post-video')) { openVideoModal(e.target.dataset.videoUrl); return; }
   
    const actionItem = e.target.closest('.action-item');
    if (!actionItem || actionItem.classList.contains('disabled')) return;
   
    const action = actionItem.dataset.action;
    const postId = actionItem.dataset.post;
    if (!action || !postId) return;
   
    e.stopPropagation();
    if (action === 'reply') { if (requireAuth()) return; openComments(postId); }
    if (action === 'repost') { if (requireAuth()) return; doRepost(postId); }
    if (action === 'like') { if (requireAuth()) return; toggleLike(postId); }
    if (action === 'share') navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
    if (action === 'delete') confirmDelete(postId);
  });
 
  listenCounters(p.key);
  listenUserMeta(p.authorId, div);
  return div;
}
function mediaMarkup(url) {
  if (!url) return '';
  const isVideo = url.includes('/video/upload') || url.endsWith('.mp4');
  if (isVideo) {
    return `
      <div class="post-video-wrapper">
        <video class="post-video" muted loop playsinline data-video-url="${url}">
          <source src="${url}" type="video/mp4">
        </video>
        <div class="video-play-overlay">
          <span class="material-icons">play_circle_filled</span>
        </div>
      </div>`;
  }
  return `<img class="post-image" src="${url}" loading="lazy">`;
}
function listenCounters(postId) {
  onValue(ref(db, `likes/${postId}`), s => {
    $('#likes-'+postId).textContent = s.size;
    const ic = document.querySelector(`[data-post="${postId}"].like`);
    if (ic) ic.classList.toggle('liked', s.hasChild(uid));
  });
  onValue(ref(db, `comments/${postId}`), s => $('#replies-'+postId).textContent = s.size);
  onValue(ref(db, `reposts/${postId}`), s => $('#reposts-'+postId).textContent = s.size);
}
async function toggleLike(postId) {
  if (requireAuth()) return;
 
  const likeRef = ref(db, `likes/${postId}/${uid}`);
  const snap = await get(likeRef);
  const alreadyLiked = snap.exists();
  if (alreadyLiked) {
    await remove(likeRef);
  } else {
    await set(likeRef, true);
    // SEND NOTIFICATION
    const postSnap = await get(ref(db, `posts/${postId}`));
    const post = postSnap.val();
    if (post && post.authorId && post.authorId !== uid) {
      sendNotification(post.authorId, 'like', {
        postId,
        text: post.text || ''
      });
    }
  }
}
async function doRepost(postId) {
  if (requireAuth()) return;
 
  const origSnap = await get(ref(db, `posts/${postId}`));
  const orig = origSnap.val();
  if (!orig) return;
  const newRef = push(ref(db, 'posts'));
  await set(newRef, {
    authorId: uid,
    authorName: uname,
    authorAvatar: uavatar,
    text: orig.text,
    image: orig.image,
    verified: false,
    repostOf: { authorName: orig.authorName, key: postId },
    likes: 0,
    replies: 0,
    reposts: 0,
    timestamp: Date.now()
  });
  // SEND NOTIFICATION to original author
  if (orig.authorId && orig.authorId !== uid) {
    sendNotification(orig.authorId, 'repost', {
      postId,
      text: orig.text || ''
    });
  }
  toast('Re-posted');
}
let currentPostId = null, commentsListener = null;
const commentOverlay = $('#comment-sheet-overlay'),
      commentList = $('#comment-sheet-list'),
      commentInput = $('#comment-input'),
      commentSendBtn = $('#comment-send-btn');
function openComments(postId) {
  if (requireAuth()) return;
 
  currentPostId = postId;
  commentInput.value = '';
  delete commentInput.dataset.parent;
  commentInput.placeholder = 'Write a comment...';
  commentList.innerHTML = '<div class="skeleton-post"><div class="flex gap-3"><div class="skeleton skeleton-avatar"></div><div class="flex-1"><div class="skeleton skeleton-line" style="width:60%"></div><div class="skeleton skeleton-text" style="width:90%"></div></div></div></div>'.repeat(3);
  commentOverlay.classList.add('show');
  if (commentsListener) commentsListener();
  commentsListener = onValue(ref(db, `comments/${postId}`), snap => {
    commentList.innerHTML = '';
    if (!snap.exists()) { commentList.innerHTML = '<div class="p-4 text-sm text-gray-500">No comments yet</div>'; return; }
    snap.forEach(c => {
      const v = c.val(), cid = c.key;
      const isMine = v.authorId === uid;
      const d = document.createElement('div'); d.className = 'comment-item';
      d.innerHTML = `
        <img src="${v.authorAvatar}" class="comment-avatar">
        <div class="comment-body flex-1">
          <div class="comment-name">${esc(v.authorName)}</div>
          <div class="comment-text">${esc(v.text)}</div>
          <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
            <button class="comment-like-btn flex items-center gap-1 ${isAnonymous ? 'disabled' : ''}" data-post="${postId}" data-cid="${cid}">
              <svg class="outline-heart" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              <svg class="filled-heart hidden" width="16" height="16" fill="#1877f2" stroke="#1877f2" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              <span class="comment-like-count">0</span>
            </button>
            <button class="comment-reply-btn flex items-center gap-1 ${isAnonymous ? 'disabled' : ''}" data-post="${postId}" data-cid="${cid}">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
              <span>Reply</span>
            </button>
            ${isMine && !isAnonymous ? `
            <button class="comment-delete-btn text-red-500" data-post="${postId}" data-cid="${cid}">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </button>` : ''}
          </div>
        </div>`;
      commentList.appendChild(d);
      listenCommentLikes(postId, cid);
    });
  });
}
$('#comment-sheet-close').onclick = closeComments;
commentOverlay.onclick = e => { if (e.target === commentOverlay) closeComments(); };
function closeComments() {
  commentOverlay.classList.remove('show');
  if (commentsListener) { commentsListener(); commentsListener = null; }
  currentPostId = null;
}
commentSendBtn.onclick = async () => {
  if (requireAuth()) return;
 
  const text = commentInput.value.trim();
  if (!text || !currentPostId) return;
  const parentId = commentInput.dataset.parent || null;
  const commentRef = push(ref(db, `comments/${currentPostId}`));
  await set(commentRef, {
    authorId: uid,
    authorName: uname,
    authorAvatar: uavatar,
    text,
    parentId,
    timestamp: Date.now()
  });
  // SEND NOTIFICATION to the post owner
  const postSnap = await get(ref(db, `posts/${currentPostId}`));
  const post = postSnap.val();
  if (post && post.authorId && post.authorId !== uid) {
    sendNotification(post.authorId, 'comment', {
      postId: currentPostId,
      commentText: text
    });
  }
  commentInput.value = '';
  delete commentInput.dataset.parent;
  commentInput.placeholder = 'Write a comment...';
  toast('Comment posted');
};
commentInput.oninput = () => commentSendBtn.disabled = !commentInput.value.trim();
function listenCommentLikes(pid, cid) {
  const likeRef = ref(db, `comments/${pid}/${cid}/likes`);
  onValue(likeRef, snap => {
    const cnt = snap.size, liked = snap.hasChild(uid);
    const btn = document.querySelector(`.comment-like-btn[data-cid="${cid}"]`);
    if (!btn) return;
    btn.querySelector('.comment-like-count').textContent = cnt || '';
    btn.classList.toggle('liked', liked);
    btn.querySelector('.outline-heart').style.display = liked ? 'none' : 'inline';
    btn.querySelector('.filled-heart').style.display = liked ? 'inline' : 'none';
  });
}
async function toggleCommentLike(pid, cid) {
  if (requireAuth()) return;
 
  const likeRef = ref(db, `comments/${pid}/${cid}/likes/${uid}`);
  const snap = await get(likeRef);
  if (snap.exists()) await remove(likeRef);
  else await set(likeRef, true);
}
async function deleteComment(pid, cid) {
  await remove(ref(db, `comments/${pid}/${cid}`));
  toast('Comment deleted');
}
commentList.addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (!btn || btn.classList.contains('disabled')) return;
 
  const pid = btn.dataset.post, cid = btn.dataset.cid;
  if (btn.classList.contains('comment-like-btn')) toggleCommentLike(pid, cid);
  if (btn.classList.contains('comment-delete-btn')) deleteComment(pid, cid);
  if (btn.classList.contains('comment-reply-btn')) openCommentReply(pid, cid);
});
function openCommentReply(postId, commentId) {
  if (requireAuth()) return;
 
  openComments(postId);
  commentInput.dataset.parent = commentId;
  commentInput.placeholder = 'Replying to comment…';
}
let deleteKeyStore = null;
const alertOverlay = $('#custom-alert-overlay'), alertTitle = $('#custom-alert-title'),
      alertMessage = $('#custom-alert-message'), alertCancel = $('#custom-alert-cancel'), alertConfirm = $('#custom-alert-confirm');
function confirmDelete(key) {
  if (requireAuth()) return;
 
  deleteKeyStore = key;
  alertTitle.textContent = 'Delete Post';
  alertMessage.textContent = 'Are you sure you want to delete this post?';
  alertOverlay.classList.add('show');
}
alertCancel.onclick = () => { deleteKeyStore = null; alertOverlay.classList.remove('show'); };
alertConfirm.onclick = async () => {
  if (!deleteKeyStore) return;
  const key = deleteKeyStore; deleteKeyStore = null; alertOverlay.classList.remove('show');
  try {
    await remove(ref(db, `posts/${key}`));
    const postElement = document.getElementById(`post-${key}`);
    if (postElement) {
      postElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      postElement.style.opacity = '0'; postElement.style.transform = 'translateY(-10px)';
      setTimeout(() => postElement.remove(), 320);
    }
    toast('Deleted');
  } catch {
    toast('Error deleting');
  }
};
  // SEND NOTIFICATION HELPER (used by like/comment/repost)
async function sendNotification(toUid, type, data) {
  if (!toUid || toUid === uid) return; // don't notify yourself
  const notifRef = push(ref(db, `notifications/${toUid}`));
  await set(notifRef, {
    type, // 'like' | 'comment' | 'repost'
    from: uid,
    postId: data.postId || null,
    text: data.text || null,
    commentText: data.commentText || null,
    timestamp: serverTimestamp(),
    read: false
  });
}
function openImageModal(src) {
  const modal = $('#image-modal');
  const img = $('#modal-image');
  const video = $('#modal-video');
  const controls = $('#video-controls');
  img.src = src;
  img.style.display = 'block';
  video.style.display = 'none';
  video.classList.remove('show');
  controls.style.display = 'none';
  modal.classList.add('show');
}
function openVideoModal(src) {
  const modal = $('#image-modal');
  const img = $('#modal-image');
  const video = $('#modal-video');
  const controls = $('#video-controls');
  img.style.display = 'none';
  video.querySelector('source').src = src;
  video.load();
  video.style.display = 'block';
  video.classList.add('show');
  controls.style.display = 'flex';
  modal.classList.add('show');
  initVideoControls();
}
function initVideoControls() {
  const video = $('#modal-video');
  const playPauseBtn = $('#play-pause-btn');
  const muteBtn = $('#mute-btn');
  const videoTime = $('#video-time');
  const videoProgress = $('#video-progress');
  const videoProgressBar = $('#video-progress-bar');
  playPauseBtn.onclick = (e) => {
    e.stopPropagation();
    if (video.paused) {
      video.play();
      playPauseBtn.innerHTML = '<span class="material-icons-outlined">pause</span>';
    } else {
      video.pause();
      playPauseBtn.innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
    }
  };
  muteBtn.onclick = (e) => {
    e.stopPropagation();
    video.muted = !video.muted;
    muteBtn.innerHTML = video.muted ?
      '<span class="material-icons-outlined">volume_off</span>' :
      '<span class="material-icons-outlined">volume_up</span>';
  };
  video.ontimeupdate = () => {
    const progress = (video.currentTime / video.duration) * 100;
    videoProgressBar.style.width = progress + '%';
    videoTime.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
  };
  videoProgress.onclick = (e) => {
    e.stopPropagation();
    const rect = videoProgress.getBoundingClientRect();
    const pos = (e.clientX - rect.left) / rect.width;
    video.currentTime = pos * video.duration;
  };
  video.play();
  playPauseBtn.innerHTML = '<span class="material-icons-outlined">pause</span>';
}
function formatTime(seconds) {
  if (isNaN(seconds)) return '0:00';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}
window.closeImageModal = function() {
  const modal = $('#image-modal');
  const video = $('#modal-video');
  video.pause();
  video.currentTime = 0;
  modal.classList.remove('show');
};
$('#image-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeImageModal();
  }
});
function toast(msg) {
  const t = document.createElement('div'); t.className = 'custom-toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
}
const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
const timeAgo = ts => {
  if (!ts) return 'now';
  const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
};
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Highlight active pill tab
  const currentPage = location.pathname.split('/').pop() || 'index.html';
  if (currentPage === 'index.html' || currentPage === '' || currentPage.includes('feed')) {
    document.getElementById('tab-feed')?.classList.add('active');
    document.querySelector('#tab-feed .material-icons-outlined')?.classList.replace('material-icons-outlined', 'material-icons');
  } else if (currentPage === 'chat.html') {
    document.getElementById('tab-chat')?.classList.add('active');
    document.querySelector('#tab-chat .material-icons-outlined')?.classList.replace('material-icons-outlined', 'material-icons');
  }
});
// Navbar hide/show functionality
let lastScrollTop = 0;
let scrollTimeout;
const navbar = document.getElementById('navbar');
const fab = document.getElementById('fab');
window.addEventListener('scroll', () => {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  clearTimeout(scrollTimeout);
 
  if (scrollTop < lastScrollTop || scrollTop < 100) {
    navbar.classList.remove('hidden');
    fab.classList.remove('hidden');
  } else {
    navbar.classList.add('hidden');
    fab.classList.add('hidden');
  }
  lastScrollTop = scrollTop;
 
  scrollTimeout = setTimeout(() => {
    navbar.classList.remove('hidden');
    fab.classList.remove('hidden');
  }, 1000);
});
// FAB functionality
fab.addEventListener('click', () => {
  document.getElementById('post-text').focus();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('pwa-install-banner').classList.remove('-translate-y-full');
});
document.getElementById('pwa-install-btn')?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('pwa-install-banner').classList.add('-translate-y-full');
});
document.getElementById('pwa-install-close')?.addEventListener('click', () => {
  document.getElementById('pwa-install-banner').classList.add('-translate-y-full');
});
  /* ---------- linkify ---------- */
function linkify(str) {
  // 1. hashtags: #word (letters, numbers, underscore)
  str = str.replace(/#(\w+)/g,
    '<a href="search.html?q=%23$1" class="hash-link">#$1</a>');
  str = str.replace(/@(\w+)/g,
    '<a href="profile.html?handle=$1" class="mention-link">@$1</a>');
  // 2. bare URLs: http/https/www...
  const urlRegex = /(https?:\/\/|www\.)([^\s<]+)/gi;
  str = str.replace(urlRegex, match => {
    const href = match.startsWith('www.') ? 'https://' + match : match;
    return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="url-link">${match}</a>`;
  });
  return str;
}
  /* ===== MENTION AUTOCOMPLETE ===== */
const mentionDropdown = $('#mention-dropdown');
let mentionQuery = ''; // text after “@”
let mentionStart = -1; // cursor index where “@” was typed
let selectedIndex = 0; // keyboard selection
let allUsers = []; // cached user-list [{uid, name, handle, avatar}, …]
/* 1. fetch all users once (Realtime DB) */
onValue(ref(db, 'users'), snap=>{
  allUsers = [];
  snap.forEach(c=>{
    const p = c.val().profile;
    if(!p) return;
    allUsers.push({
      uid: c.key,
      name: p.displayName || 'User',
      handle:p.handle || c.key.slice(0,8),
      avatar:p.avatar || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${p.displayName||'User'}`
    });
  });
});
/* 2. wire both textareas */
enableMentions($('#post-text'));
enableMentions($('#comment-input'));
/* 3. main enable function */
function enableMentions(textarea){
  textarea.addEventListener('input', e=>onInput(e));
  textarea.addEventListener('keydown',e=>onKey(e));
  textarea.addEventListener('blur', e=>{ /* hide on blur, but allow click */ setTimeout(()=>hideDD(),150); });
}
/* ---------- event handlers ---------- */
function onInput(e){
  const ta = e.target;
  const pos = ta.selectionStart;
  const text = ta.value;
  const lastAt = text.lastIndexOf('@', pos-1);
  /* if “@” found and no space between @ and cursor */
  if(lastAt !== -1 && !text.slice(lastAt+1,pos).includes(' ')){
    mentionStart = lastAt;
    mentionQuery = text.slice(lastAt+1,pos).toLowerCase();
    selectedIndex= 0;
    renderDD(ta);
  }else{
    hideDD();
  }
}
function onKey(e){
  if(!mentionDropdown.classList.contains('hidden')){
    const max = filtered().length;
    if(e.key==='ArrowDown'){ selectedIndex=(selectedIndex+1)%max; renderDD(e.target); e.preventDefault();}
    if(e.key==='ArrowUp') { selectedIndex=(selectedIndex-1+max)%max; renderDD(e.target); e.preventDefault();}
    if(e.key==='Enter' || e.key==='Tab'){
      insertSelected(e.target); e.preventDefault();
    }
    if(e.key==='Escape') hideDD();
  }
}
/* ---------- dropdown ---------- */
function filtered(){
  return allUsers.filter(u=>
    u.handle.toLowerCase().startsWith(mentionQuery) ||
    u.name.toLowerCase().includes(mentionQuery)
  ).slice(0,5);
}
function renderDD(ta){
  const list = filtered();
  if(!list.length){ hideDD(); return; }
  selectedIndex = Math.min(selectedIndex, list.length-1);
  mentionDropdown.innerHTML = list.map((u,i)=>`
    <div class="mention-item ${i===selectedIndex?'selected':''}" data-index="${i}" data-handle="${u.handle}">
      <img src="${u.avatar}"/>
      <div>
        <div class="mention-name">${esc(u.name)}</div>
        <div class="mention-handle">@${u.handle}</div>
      </div>
    </div>`).join('');
  /* position under cursor */
  const coords = getCaretCoordinates(ta, mentionStart);
  const rect = ta.getBoundingClientRect();
  mentionDropdown.style.left = (rect.left + coords.left) + 'px';
  mentionDropdown.style.top = (rect.top + coords.top + 20) + 'px';
  mentionDropdown.classList.remove('hidden');
}
function hideDD(){ mentionDropdown.classList.add('hidden'); }
/* ---------- insert ---------- */
function insertSelected(ta){
  const u = filtered()[selectedIndex];
  if(!u) return;
  const before = ta.value.slice(0, mentionStart);
  const after = ta.value.slice(ta.selectionStart);
  ta.value = before + '@' + u.handle + ' ' + after;
  ta.selectionStart = ta.selectionEnd = mentionStart + u.handle.length + 2;
  hideDD();
  ta.focus();
}
/* ---------- lightweight caret coords (no deps) ---------- */
function getCaretCoordinates(el, pos){
  const div = document.createElement('div');
  const style = getComputedStyle(el);
  ['fontFamily','fontSize','fontWeight','letterSpacing','lineHeight','padding','border','width'].forEach(k=> div.style[k]=style[k]);
  div.style.position='absolute'; div.style.visibility='hidden'; div.style.whiteSpace='pre-wrap';
  div.textContent = el.value.substring(0,pos);
  document.body.appendChild(div);
  const span=document.createElement('span'); span.textContent='|'; div.appendChild(span);
  const coords={top:span.offsetTop, left:span.offsetLeft};
  document.body.removeChild(div);
  return coords;
}

  /* ---------- FLOATING SIGN-IN CARD ---------- */
const signinFloatCard = document.getElementById('signin-float-card');
const signinFloatBtn = document.getElementById('signin-float-btn');
const signinFloatClose = document.getElementById('signin-float-close');

// Show card only for anonymous users
onAuthStateChanged(auth, user => {
  if (user && user.isAnonymous) {
    // Delay appearance slightly for better UX
    setTimeout(() => signinFloatCard.classList.remove('hidden'), 1200);
  } else {
    signinFloatCard.classList.add('hidden');
  }
});

// Open auth sheet when clicked
signinFloatBtn.onclick = () => openAuthSheet('signin');

// Dismiss card (persist in session)
signinFloatClose.onclick = () => {
  signinFloatCard.classList.add('hidden');
  sessionStorage.setItem('signinFloatDismissed', '1');
};

// Re-show if user signs out and becomes anonymous again
auth.onAuthStateChanged(user => {
  if (user && user.isAnonymous && !sessionStorage.getItem('signinFloatDismissed')) {
    setTimeout(() => signinFloatCard.classList.remove('hidden'), 800);
  }
});
</script>
</body>
</html>
