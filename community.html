<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --accent-purple: #d946ef;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-color: #f8f9fa;
            --glass-white: rgba(255, 255, 255, 0.9);
            --logo-gradient: linear-gradient(135deg, #000000 0%, var(--accent-purple) 50%, #10b981 100%);
        }

        /* Prevent Highlight/Selection */
        * { 
            -webkit-tap-highlight-color: transparent; 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            user-select: none;
            box-sizing: border-box; 
            outline: none;
        }

        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-primary); overflow-x: hidden; }

        /* --- Shimmer Effect --- */
        .shimmer {
            background: linear-gradient(90deg, #eff1f3 25%, #e2e2e2 50%, #eff1f3 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        /* --- Header --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--glass-white);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; backdrop-filter: blur(10px);
        }
        .user-profile { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-purple); cursor: pointer; }
        .app-title { font-size: 22px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }

        /* --- Pill Navigation --- */
        .pill-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: #000; width: 220px; height: 60px; border-radius: 40px;
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 10px; z-index: 2000; box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .nav-item { color: #888; display: flex; flex-direction: column; align-items: center; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: #fff; }
        .nav-item span { font-size: 24px; }

        /* --- Content Layout --- */
        main { padding: 90px 16px 120px 16px; min-height: 100vh; }
        #statusTab { display: none; }

        /* --- Chat List --- */
        .chat-card {
            display: flex; align-items: center; padding: 15px; 
            background: #fff; margin-bottom: 12px; border-radius: 22px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.02);
        }
        .avatar-box { margin-right: 15px; cursor: pointer; flex-shrink: 0; }
        .avatar { width: 55px; height: 55px; border-radius: 18px; object-fit: cover; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: 700; font-size: 15px; display: block; }
        .chat-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        /* --- Status Grid (Moments) --- */
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .status-card {
            position: relative; height: 260px; border-radius: 28px; overflow: hidden;
            background: #ddd; cursor: pointer; transform: scale(1); transition: 0.2s;
        }
        .status-card:active { transform: scale(0.96); }
        .status-card img, .status-card video { width: 100%; height: 100%; object-fit: cover; }
        .status-info { position: absolute; bottom: 0; width: 100%; padding: 15px; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: #fff; font-size: 12px; }

        /* --- Immersive Story Viewer --- */
        #storyViewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none; }
        .story-progress { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; }
        .progress-segment { height: 3px; background: rgba(255,255,255,0.3); flex: 1; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #fff; width: 0%; transition: width linear; }
        #storyMedia { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #storyMedia img, #storyMedia video { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* --- Modals & Sheets --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; z-index:2500; backdrop-filter: blur(4px); }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 35px 35px 0 0; padding: 30px; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 2600; }
        .bottom-sheet.active { bottom: 0; }
        .v-input { width: 100%; padding: 18px; border: 2px solid #f1f1f1; border-radius: 18px; margin-bottom: 15px; font-family: inherit; font-size: 15px; }
        .btn-black { width: 100%; background: #000; color: #fff; border: none; padding: 18px; border-radius: 18px; font-weight: 700; cursor: pointer; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 12px 25px; border-radius: 50px; font-size: 13px; z-index: 6000; display: none; }

        /* --- Profile Detail Modal --- */
        .profile-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .profile-card { background: #fff; width: 85%; max-width: 320px; border-radius: 35px; padding: 40px 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <header>
        <div onclick="openSheet('settingsSheet')">
            <img id="myAvatar" class="user-profile shimmer" src="">
        </div>
        <div class="app-title">Vynix</div>
        <span class="material-symbols-rounded" onclick="openSheet('addFriendSheet')">person_add</span>
    </header>

    <main id="chatsTab">
        <div id="chatList">
            <div class="chat-card shimmer" style="height: 80px; opacity: 0.5;"></div>
            <div class="chat-card shimmer" style="height: 80px; opacity: 0.5;"></div>
        </div>
    </main>

    <main id="statusTab">
        <div class="btn-black" onclick="document.getElementById('fileUpload').click()" style="margin-bottom:20px;">
            <span class="material-symbols-rounded" style="vertical-align:middle; margin-right:10px;">add_circle</span> Post Moment
        </div>
        <div class="status-grid" id="statusGrid"></div>
    </main>

    <input type="file" id="fileUpload" hidden accept="image/*,video/*" onchange="handleUpload(this.files[0])">

    <div id="storyViewer" onclick="handleStoryTap(event)">
        <div class="story-progress" id="storyProgressBars"></div>
        <div id="storyMedia"></div>
    </div>

    <div class="pill-nav">
        <div class="nav-item active" id="navChats" onclick="switchTab('chats')">
            <span class="material-symbols-rounded">chat_bubble</span>
        </div>
        <div class="nav-item" id="navStatus" onclick="switchTab('status')">
            <span class="material-symbols-rounded">explore</span>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>
    
    <div class="bottom-sheet" id="addFriendSheet">
        <h3 style="margin-top:0">Add Friend</h3>
        <input type="text" id="friendVynixId" class="v-input" placeholder="Enter Vynix ID">
        <button class="btn-black" onclick="addFriendLogic()">Add to Contacts</button>
    </div>

    <div class="bottom-sheet" id="settingsSheet">
        <h3>My Profile</h3>
        <input type="text" id="editDisplayName" class="v-input" placeholder="Display Name">
        <button class="btn-black" onclick="updateProfile()">Save Changes</button>
        <button class="btn-black" style="background:#f1f1f1; color:red; margin-top:10px;" onclick="auth.signOut()">Logout</button>
    </div>

    <div id="profileDetail" class="profile-modal" onclick="this.style.display='none'">
        <div class="profile-card" onclick="event.stopPropagation()">
            <img id="detailImg" src="" style="width:120px; height:120px; border-radius:25px; object-fit:cover; margin-bottom:15px; border:3px solid var(--accent-purple);">
            <h2 id="detailName" style="margin:0"></h2>
            <div id="detailId" style="color:var(--accent-purple); font-weight:700;"></div>
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            <div style="font-size:12px; color:#999; font-weight:600; cursor:pointer;" onclick="document.getElementById('profileDetail').style.display='none'">CLOSE</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- Configuration ---
        const CLOUD_NAME = "dqkujefxj"; 
        const UPLOAD_PRESET = "banter_box";
        const secretBase = "Vynix_E2EE_Core_";

        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let myVId = "";
        let currentStories = [];
        let storyIndex = 0;
        let storyTimeout;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initApp();
            } else { window.location.href = "login.html"; }
        });

        async function initApp() {
            const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            const data = snap.val();
            if (data) {
                myVId = data.vynixId;
                document.getElementById('myAvatar').src = data.photo;
                document.getElementById('editDisplayName').value = data.name;
                document.getElementById('myAvatar').classList.remove('shimmer');
            }
            loadChats();
            loadMoments();
        }

        // --- Navigation ---
        function switchTab(tab) {
            document.getElementById('chatsTab').style.display = tab === 'chats' ? 'block' : 'none';
            document.getElementById('statusTab').style.display = tab === 'status' ? 'block' : 'none';
            document.getElementById('navChats').classList.toggle('active', tab === 'chats');
            document.getElementById('navStatus').classList.toggle('active', tab === 'status');
        }

        // --- Chat Logic ---
        function loadChats() {
            db.ref(`users/${currentUser.uid}/chats`).on('value', snap => {
                const list = document.getElementById('chatList');
                list.innerHTML = "";
                snap.forEach(child => {
                    const c = child.val();
                    const roomId = currentUser.uid < child.key ? currentUser.uid+"_"+child.key : child.key+"_"+currentUser.uid;
                    const dMsg = decrypt(c.lastMsg, roomId);
                    list.innerHTML += `
                        <div class="chat-card">
                            <div class="avatar-box" onclick="showDetail('${child.key}', event)">
                                <img class="avatar" src="${c.photo}">
                            </div>
                            <div class="chat-info" onclick="openChat('${child.key}', '${c.name}', '${c.photo}')">
                                <span class="chat-name">${c.name}</span>
                                <span class="chat-msg">${dMsg}</span>
                            </div>
                        </div>`;
                });
            });
        }

        async function showDetail(uid, e) {
            e.stopPropagation();
            const snap = await db.ref(`users/${uid}/profile`).once('value');
            const data = snap.val();
            document.getElementById('detailName').innerText = data.name;
            document.getElementById('detailId').innerText = "@" + data.vynixId;
            document.getElementById('detailImg').src = data.photo.replace('s96-c','s400-c');
            document.getElementById('profileDetail').style.display = 'flex';
        }

        async function addFriendLogic() {
            const vid = document.getElementById('friendVynixId').value.trim().toLowerCase();
            if(!vid || vid === myVId) return toast("Invalid ID");
            const idSnap = await db.ref(`vynix_ids/${vid}`).once('value');
            if(!idSnap.exists()) return toast("User not found");
            
            const fUid = idSnap.val();
            const check = await db.ref(`users/${currentUser.uid}/chats/${fUid}`).once('value');
            if(check.exists()) return toast("Already added");

            const fProfile = (await db.ref(`users/${fUid}/profile`).once('value')).val();
            await db.ref(`users/${currentUser.uid}/chats/${fUid}`).set({
                name: fProfile.name, photo: fProfile.photo, lastMsg: "New Connection", ts: Date.now()
            });
            toast("Friend Added!");
            closeAll();
        }

        // --- Moment (Status) Engine ---
        async function handleUpload(file) {
            if(!file) return;
            toast("Uploading Moment...");
            const form = new FormData();
            form.append('file', file);
            form.append('upload_preset', UPLOAD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method:'POST', body:form });
            const data = await res.json();
            if(data.secure_url) {
                await db.ref(`moments/${currentUser.uid}`).push({
                    url: data.secure_url, type: data.resource_type, ts: Date.now(),
                    name: currentUser.displayName || "Vynix User", photo: currentUser.photoURL
                });
                toast("Moment Live!");
            }
        }

        function loadMoments() {
            db.ref('moments').on('value', snap => {
                const grid = document.getElementById('statusGrid');
                grid.innerHTML = "";
                const now = Date.now();
                snap.forEach(userNode => {
                    const stories = [];
                    userNode.forEach(m => {
                        if(now - m.val().ts < 86400000) stories.push(m.val());
                    });
                    if(stories.length) {
                        const last = stories[stories.length-1];
                        grid.innerHTML += `
                            <div class="status-card" onclick="openStoryViewer('${userNode.key}')">
                                ${last.type === 'video' ? `<video src="${last.url}"></video>` : `<img src="${last.url}">`}
                                <div class="status-info"><b>${last.name}</b></div>
                            </div>`;
                    }
                });
            });
        }

        function openStoryViewer(uid) {
            db.ref(`moments/${uid}`).once('value', snap => {
                currentStories = [];
                snap.forEach(s => { if(Date.now() - s.val().ts < 86400000) currentStories.push(s.val()); });
                storyIndex = 0;
                document.getElementById('storyViewer').style.display = 'block';
                renderStory();
            });
        }

        function renderStory() {
            clearTimeout(storyTimeout);
            if(storyIndex >= currentStories.length) return closeStoryViewer();
            
            const story = currentStories[storyIndex];
            const mediaCont = document.getElementById('storyMedia');
            const progressCont = document.getElementById('storyProgressBars');

            mediaCont.innerHTML = story.type === 'video' ? `<video src="${story.url}" autoplay></video>` : `<img src="${story.url}">`;
            
            progressCont.innerHTML = currentStories.map((_, i) => `
                <div class="progress-segment">
                    <div class="progress-fill" style="width: ${i < storyIndex ? '100%' : '0%'}"></div>
                </div>`).join('');

            setTimeout(() => {
                const fill = progressCont.querySelectorAll('.progress-fill')[storyIndex];
                fill.style.transitionDuration = '5s';
                fill.style.width = '100%';
            }, 50);

            storyTimeout = setTimeout(() => { storyIndex++; renderStory(); }, 5000);
        }

        function handleStoryTap(e) {
            const width = window.innerWidth;
            if(e.clientX < width / 3) { // Tap Left
                storyIndex = Math.max(0, storyIndex - 1);
            } else { // Tap Right
                storyIndex++;
            }
            renderStory();
        }

        function closeStoryViewer() {
            clearTimeout(storyTimeout);
            document.getElementById('storyViewer').style.display = 'none';
        }

        // --- Helpers ---
        function decrypt(t, r) {
            if(!t || !t.includes("U2FsdGVk")) return t;
            try { return CryptoJS.AES.decrypt(t, secretBase + r).toString(CryptoJS.enc.Utf8) || "Encrypted"; }
            catch(e) { return "Encrypted"; }
        }

        function openChat(uid, name, photo) { window.location.href = `chat.html?friend=${uid}&name=${encodeURIComponent(name)}&photo=${encodeURIComponent(photo)}`; }
        function openSheet(id) { document.getElementById('overlay').style.display='block'; document.getElementById(id).classList.add('active'); }
        function closeAll() { document.querySelectorAll('.bottom-sheet').forEach(s=>s.classList.remove('active')); document.getElementById('overlay').style.display='none'; }
        function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2500); }
    </script>
</body>
</html>
