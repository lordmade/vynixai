<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix Chats</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --accent: #d946ef;
            --text-p: #111827;
            --text-s: #6b7280;
            --bg: #ffffff;
            --logo-gradient: linear-gradient(135deg, #000000 0%, var(--accent) 50%, #10b981 100%);
        }

        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        input { -webkit-user-select: text; user-select: text; }

        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); overflow-x: hidden; }

        /* --- Header & Search --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 85px; background: #fff;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100; border-bottom: 1px solid #eee;
        }
        .search-container {
            position: absolute; left: 15px; right: 15px; background: #f3f4f6;
            padding: 8px 15px; border-radius: 15px; display: none; align-items: center; z-index: 110;
        }
        .search-input { flex: 1; background: none; border: none; outline: none; padding-left: 10px; font-size: 16px; font-family: inherit; }

        /* --- Notification Alert (Top Slide) --- */
        #top-alert {
            position: fixed; top: -100px; left: 10px; right: 10px; background: #111;
            color: #fff; padding: 15px; border-radius: 20px; display: flex; align-items: center;
            gap: 12px; z-index: 2000; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #top-alert.show { top: 15px; }

        /* --- Chat List --- */
        main { padding-top: 95px; }
        .chat-item { display: flex; align-items: center; padding: 16px 20px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
        .avatar-wrap { position: relative; flex-shrink: 0; margin-right: 15px; }
        .avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; }
        .unread-badge {
            position: absolute; top: 0; right: 0; background: var(--accent);
            color: white; font-size: 10px; font-weight: 700; width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff;
        }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-row { display: flex; justify-content: space-between; align-items: center; }
        .name { font-weight: 600; font-size: 16px; }
        .time { font-size: 11px; color: var(--text-s); }
        .msg { font-size: 13px; color: var(--text-s); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Shared UI --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 1000; backdrop-filter: blur(4px); }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 30px 30px 0 0; padding: 30px 24px; transition: 0.4s; z-index: 1001; }
        .bottom-sheet.active { bottom: 0; }
        .v-input { width: 100%; padding: 16px; border: 2px solid #f3f4f6; border-radius: 16px; margin-bottom: 15px; outline: none; font-size: 15px; }
        .primary-btn { width: 100%; background: #000; color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: 600; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 22px; background: #000; color: #fff; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 90; }
    </style>
</head>
<body>

    <div id="top-alert">
        <img id="alert-img" src="" style="width:40px; height:40px; border-radius:50%;">
        <div style="flex:1">
            <b id="alert-name" style="display:block; font-size:14px;">New Message</b>
            <span id="alert-msg" style="font-size:12px; opacity:0.8;">Click to chat</span>
        </div>
    </div>

    <header id="main-header">
        <div onclick="openSettings()" style="display:flex; flex-direction:column; align-items:center; cursor:pointer;">
            <img id="myPhoto" src="" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--accent); object-fit:cover;">
            <span id="myDisplayId" style="font-size:9px; font-weight:700; background:#f3f4f6; padding:2px 6px; border-radius:10px; margin-top:4px;">...</span>
        </div>
        <div class="app-title" style="font-size:26px; font-weight:800; background:var(--logo-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">Vynix</div>
        <span class="material-symbols-rounded" onclick="toggleSearch(true)">search</span>

        <div class="search-container" id="search-bar">
            <span class="material-symbols-rounded" style="color:#666;" onclick="toggleSearch(false)">arrow_back</span>
            <input type="text" id="search-input" class="search-input" placeholder="Search friends..." oninput="filterFriends()">
        </div>
    </header>

    <main id="chatList"></main>

    <button class="fab" onclick="toggleSheet('addFriendSheet', true)"><span class="material-symbols-rounded" style="font-size:30px;">add</span></button>

    <div class="overlay" id="uiOverlay" onclick="closeAll()"></div>

    <div class="bottom-sheet" id="addFriendSheet">
        <h3>Add Friend</h3>
        <input type="text" id="targetId" class="v-input" placeholder="Vynix ID">
        <button class="primary-btn" onclick="addFriendLogic()">Add Friend</button>
    </div>

    <div class="bottom-sheet" id="settingsSheet">
        <h3>Edit Profile</h3>
        <input type="text" id="editName" class="v-input" placeholder="Name">
        <input type="text" id="editVynixId" class="v-input" placeholder="Vynix ID">
        <button class="primary-btn" onclick="saveProfile()">Save Changes</button>
        <button onclick="auth.signOut()" style="width:100%; border:none; background:none; color:red; margin-top:15px; font-weight:600;">Logout</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const secretBase = "Vynix_E2EE_Alpha_";

        let currentUser = null;
        let allChats = [];

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                document.getElementById('myPhoto').src = user.photoURL;
                await syncProfile(user);
                loadChats();
                listenForNotifications();
            } else { window.location.href="login.html"; }
        });

        // --- Search Logic ---
        function toggleSearch(s) {
            const bar = document.getElementById('search-bar');
            bar.style.display = s ? 'flex' : 'none';
            if(s) document.getElementById('search-input').focus();
            else { document.getElementById('search-input').value = ''; renderUI(allChats); }
        }

        function filterFriends() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allChats.filter(c => c.name.toLowerCase().includes(term));
            renderUI(filtered);
        }

        // --- Notification Logic ---
        function listenForNotifications() {
            // Check for new messages in all rooms the user is part of
            db.ref(`users/${currentUser.uid}/chats`).on('child_changed', snap => {
                const data = snap.val();
                if(data.lastSender !== currentUser.uid) {
                    showTopAlert(data.name, data.photo, data.lastMsg, snap.key);
                }
            });
        }

        function showTopAlert(name, img, msg, fUid) {
            const alert = document.getElementById('top-alert');
            document.getElementById('alert-img').src = img;
            document.getElementById('alert-name').innerText = name;
            document.getElementById('alert-msg').innerText = decryptPreview(msg, fUid);
            
            alert.classList.add('show');
            alert.onclick = () => window.location.href = `chat.html?friend=${fUid}&name=${name}`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // --- Chat Logic ---
        function decryptPreview(text, fUid) {
            if(!text || !text.includes("U2FsdGVk")) return text;
            const rid = currentUser.uid < fUid ? currentUser.uid+"_"+fUid : fUid+"_"+currentUser.uid;
            try { return CryptoJS.AES.decrypt(text, secretBase + rid).toString(CryptoJS.enc.Utf8) || "ðŸ”’ Message"; } 
            catch(e) { return "ðŸ”’ Message"; }
        }

        function loadChats() {
            db.ref(`users/${currentUser.uid}/chats`).on('value', snap => {
                allChats = [];
                snap.forEach(child => {
                    allChats.push({ id: child.key, ...child.val() });
                });
                // Sort by Timestamp (Most recent at top)
                allChats.sort((a, b) => (b.ts || 0) - (a.ts || 0));
                renderUI(allChats);
            });
        }

        function renderUI(chats) {
            const list = document.getElementById('chatList');
            list.innerHTML = '';
            chats.forEach(c => {
                const pText = decryptPreview(c.lastMsg, c.id);
                list.innerHTML += `
                    <div class="chat-item" onclick="window.location.href='chat.html?friend=${c.id}&name=${encodeURIComponent(c.name)}'">
                        <div class="avatar-wrap">
                            <img class="avatar" src="${c.photo}">
                            ${c.unread && c.unread > 0 ? `<div class="unread-badge">${c.unread}</div>` : ''}
                        </div>
                        <div class="chat-info">
                            <div class="chat-row">
                                <span class="name">${c.name}</span>
                                <span class="time">${c.lastTime || ''}</span>
                            </div>
                            <div class="msg"><span class="material-symbols-rounded" style="font-size:14px; color:var(--accent)">lock</span> ${pText}</div>
                        </div>
                    </div>
                `;
            });
        }

        // --- Profile & UI Helpers ---
        async function syncProfile(user) {
            const s = await db.ref(`users/${user.uid}/profile`).once('value');
            const d = s.val() || {};
            document.getElementById('myDisplayId').innerText = "@" + (d.vynixId || '...');
            document.getElementById('editName').value = d.name || user.displayName;
            document.getElementById('editVynixId').value = d.vynixId || '';
        }

        function openSettings() { toggleSheet('settingsSheet', true); }
        function closeAll() { document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active')); document.getElementById('uiOverlay').style.display='none'; }
        function toggleSheet(id, s) { document.getElementById('uiOverlay').style.display = s ? 'block' : 'none'; document.getElementById(id).classList.toggle('active', s); }
        
        async function addFriendLogic() {
            const tid = document.getElementById('targetId').value.trim();
            const idS = await db.ref(`vynix_ids/${tid}`).once('value');
            if(idS.exists()) {
                const fUid = idS.val();
                const fP = await db.ref(`users/${fUid}/profile`).once('value');
                const p = fP.val();
                await db.ref(`users/${currentUser.uid}/chats/${fUid}`).set({ name: p.name, photo: p.photo, lastMsg: "Tap to chat", ts: Date.now() });
                closeAll();
            }
        }
    </script>
</body>
</html>
