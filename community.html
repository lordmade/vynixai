<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Full Social Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNkOTQ2ZWYiLCJ0aGVtZV9jb2xvciI6IiNkOTQ2ZWYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#d946ef">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0f1419;
      --text2:#536471;
      --border:#cfd9de;
      --accent:#d946ef;
      --accent-green:#10b981;
      --hover-accent:rgba(217,70,239,.08);
      --card-shadow:0 1px 3px rgba(0,0,0,.04),0 3px 8px rgba(0,0,0,.04);
      --radius:16px;
      --avatar:48px;
      --gutter:64px;
      --trans:.18s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"]{
      --bg:#000000;
      --card:#000000;
      --text:#e7e9ea;
      --text2:#71767b;
      --border:#2f3336;
      --card-shadow:0 1px 3px rgba(255,255,255,.04),0 3px 8px rgba(255,255,255,.04);
      --hover-accent:rgba(217,70,239,.15);
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding-bottom:80px;
    }
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    input,textarea{-webkit-user-select:auto;user-select:auto}
    .composer{
      display:flex;
      gap:12px;
      padding:16px;
      border-bottom:1px solid var(--border);
    }
    .composer .avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover}
    textarea{flex:1;resize:none;background:transparent;color:var(--text);border:none;outline:none;font-size:20px;padding-top:10px;min-height:60px}
    .media-preview{width:100%;border-radius:var(--radius);margin-top:12px;border:1px solid var(--border)}
    .composer-actions{display:flex;align-items:center;justify-content:space-between;margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .icon-btn{background:none;border:none;color:var(--accent);cursor:pointer;padding:8px;border-radius:50%;transition:var(--trans);display:flex;align-items:center;justify-content:center}
    .icon-btn:hover{background:var(--hover-accent)}
    .post-btn{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:10px 24px;font-weight:700;font-size:15px;cursor:pointer;transition:opacity var(--trans)}
    .post-btn:disabled{opacity:.5;cursor:default}
    .spinner{border:3px solid rgba(255,255,255,.3);border-top:3px solid #fff;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .post-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      margin:0 auto 12px;
      max-width:600px;
      padding:12px 16px 8px;
      transition:transform var(--trans),box-shadow var(--trans);
      cursor:pointer;
      position:relative;
    }
    .post-card:active{transform:scale(.996);box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .post-header{display:flex;align-items:flex-start;gap:12px}
    .post-avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex-shrink:0}
    .user-meta{display:flex;align-items:center;gap:4px;font-size:15px;font-weight:700;color:var(--text)}
    .user-meta .handle,.user-meta .time{font-weight:400;color:var(--text2)}
    .verified-badge{color:var(--accent-green);font-size:17px!important;margin-left:2px}
    .post-content{margin:4px 0 0 var(--gutter);font-size:15px;line-height:1.5;white-space:pre-wrap;color:var(--text)}
    .post-image,.post-video{margin:12px 0 0 var(--gutter);max-width:100%;max-height:420px;border-radius:12px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:opacity var(--trans)}
    .post-image:hover,.post-video:hover{opacity:.92}
    .post-actions{display:flex;align-items:center;margin:8px 0 0 var(--gutter);max-width:425px;justify-content:space-between}
    .action-item{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text2);cursor:pointer;padding:4px 6px;border-radius:999px;transition:color var(--trans),background var(--trans)}
    .action-item svg{width:20px;height:20px;stroke-width:1.8;pointer-events:none}
    .action-item:hover.reply{color:#1d9bf0;background:rgba(29,155,240,.08)}
    .action-item:hover.repost{color:#00ba7c;background:rgba(0,186,124,.08)}
    .action-item:hover.like{color:var(--accent);background:var(--hover-accent)}
    .action-item.liked svg{fill:var(--accent);stroke:var(--accent)}
    .action-item.delete-btn:hover{color:#f4212e;background:rgba(244,33,46,.08)}
    .action-item.share:hover{color:#0095f6;background:rgba(0,149,246,.08)}
    .post-content,.post-image,.post-video,.post-actions{margin-left:0!important;width:100%;padding-left:0}
    .video-play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .video-play-overlay .material-icons{font-size:56px;color:var(--accent);text-shadow:0 2px 8px rgba(0,0,0,.45);background:rgba(0,0,0,.35);border-radius:50%;padding:12px}
    .post-video-wrapper{position:relative;display:inline-block;width:100%;margin-top:12px}
    #image-modal{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:150;display:none;align-items:center;justify-content:center;animation:fadeIn .2s ease-out}
    #image-modal.show{display:flex!important}
    #modal-image,#modal-video{max-width:95%;max-height:95%;object-fit:contain;border-radius:8px;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
    #modal-video{display:none}#modal-video.show{display:block}
    .video-controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);backdrop-filter:blur(10px);border-radius:50px;padding:12px 20px;display:flex;align-items:center;gap:15px;z-index:160}
    .video-controls button{background:none;border:none;color:#fff;cursor:pointer;display:flex;align-items:center;padding:5px;border-radius:50%;transition:var(--trans)}
    .video-controls button:hover{background:rgba(255,255,255,.2);transform:scale(1.1)}
    .video-progress{flex:1;height:4px;background:rgba(255,255,255,.3);border-radius:2px;cursor:pointer;position:relative;min-width:200px}
    .video-progress-bar{height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .1s}
    .video-time{color:#fff;font-size:13px;font-weight:500;min-width:80px;text-align:center}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    #comment-sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:90;opacity:0;pointer-events:none;transition:opacity .3s ease}
    #comment-sheet-overlay.show{opacity:1;pointer-events:auto}
    .comment-sheet{position:absolute;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);border-top-left-radius:20px;border-top-right-radius:20px;max-height:75vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s ease}
    #comment-sheet-overlay.show .comment-sheet{transform:translateY(0)}
    .comment-sheet-header{padding:16px;font-size:18px;font-weight:700;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .comment-sheet-close{background:none;border:none;color:var(--text2);cursor:pointer}
    .comment-sheet-list{flex:1;overflow-y:auto;padding:0 16px}
    .comment-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
    .comment-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover}
    .comment-body{flex:1}
    .comment-name{font-size:14px;font-weight:700}
    .comment-text{font-size:15px;margin-top:2px}
    .comment-input-box{display:flex;gap:12px;padding:16px;border-top:1px solid var(--border)}
    .comment-input{flex:1;resize:none;background:transparent;color:var(--text);border:1px solid var(--border);border-radius:999px;padding:10px 16px;font-size:15px;outline:none}
    .comment-send-btn{background:var(--accent);color:#fff;border:none;border-radius:50%;width:40px;height:40px;display:grid;place-items:center;cursor:pointer;transition:opacity var(--trans)}
    .comment-send-btn:disabled{opacity:.5;cursor:default}
    .custom-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--accent);color:#fff;padding:12px 24px;border-radius:99px;box-shadow:0 10px 15px -3px rgba(0,0,0,.3);font-weight:600;opacity:0;transition:all .4s cubic-bezier(.175,.885,.32,1.275);z-index:50;display:flex;align-items:center;gap:8px}
    .custom-toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    #custom-alert-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .25s ease}
    #custom-alert-overlay.show{opacity:1;pointer-events:auto}
    .custom-alert-box{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:320px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,.25);transform:scale(.95);transition:transform .25s ease}
    #custom-alert-overlay.show .custom-alert-box{transform:scale(1)}
    .custom-alert-title{font-weight:700;font-size:18px;margin-bottom:8px}
    .custom-alert-message{font-size:15px;color:var(--text2);margin-bottom:20px}
    .custom-alert-buttons{display:flex;gap:12px;justify-content:flex-end}
    .custom-alert-btn{background:none;border:none;font-size:15px;font-weight:600;cursor:pointer;padding:8px 16px;border-radius:999px;transition:background var(--trans)}
    .custom-alert-btn.cancel{color:var(--text2)}.custom-alert-btn.cancel:hover{background:rgba(0,0,0,.05)}
    [data-theme="dark"] .custom-alert-btn.cancel:hover{background:rgba(255,255,255,.05)}
    .custom-alert-btn.confirm{background:var(--accent);color:#fff}.custom-alert-btn.confirm:hover{opacity:.9}
    .fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(217,70,239,.4);cursor:pointer;transition:var(--trans);z-index:30}
    .fab:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(217,70,239,.6)}
    .fab.hidden{transform:scale(0)}
    .skeleton{background:linear-gradient(90deg,var(--border) 25%,rgba(255,255,255,.3) 50%,var(--border) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
    [data-theme="dark"] .skeleton{background:linear-gradient(90deg,var(--border) 25%,rgba(255,255,255,.05) 50%,var(--border) 75%);background-size:200% 100%}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#d946ef] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix for a better experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="bg-white text-[#d946ef] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-icons text-xl">close</span>
      </button>
    </div>
  </div>
  <div class="composer">
    <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=d946ef&color=fff" alt="avatar"/>
    <div class="flex-1">
      <textarea id="post-text" placeholder="What is happening?!"></textarea>
      <video id="media-preview-video" class="media-preview hidden" controls muted loop playsinline></video>
      <img id="media-preview-img" class="media-preview hidden" alt=""/>
      <div class="composer-actions">
        <div>
          <input type="file" id="file-input" accept="image/*,video/*" class="hidden"/>
          <label for="file-input" class="icon-btn" title="Add Photo / Video">
            <span class="material-icons-outlined">image</span>
          </label>
        </div>
        <button id="post-btn" class="post-btn" disabled>
          <span id="btn-text">Post</span>
          <span id="btn-spinner" class="spinner hidden"></span>
        </button>
      </div>
    </div>
  </div>
  <main id="feed" class="pt-4"></main>
  <div class="text-center p-4">
    <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
  </div>
  <div id="fab" class="fab">
    <span class="material-icons">add</span>
  </div>
  <div id="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
      <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
      <div class="custom-alert-buttons">
        <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
        <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
      </div>
    </div>
  </div>
  <div id="comment-sheet-overlay">
    <div class="comment-sheet">
      <div class="comment-sheet-header">
        <span>Comments</span>
        <button class="comment-sheet-close material-icons-outlined" id="comment-sheet-close">close</button>
      </div>
      <div class="comment-sheet-list" id="comment-sheet-list"></div>
      <div class="comment-input-box">
        <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
        <button class="comment-send-btn" id="comment-send-btn">
          <span class="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  </div>
  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <video id="modal-video" loop>
      <source src="" type="video/mp4">
    </video>
    <div class="video-controls" id="video-controls" style="display: none;">
      <button id="play-pause-btn">
        <span class="material-icons-outlined">play_arrow</span>
      </button>
      <span class="video-time" id="video-time">0:00 / 0:00</span>
      <div class="video-progress" id="video-progress">
        <div class="video-progress-bar" id="video-progress-bar"></div>
      </div>
      <button id="mute-btn">
        <span class="material-icons-outlined">volume_up</span>
      </button>
    </div>
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let uid, uname, uavatar;
const $ = s => document.querySelector(s);
const postBtn = $('#post-btn'), textEl = $('#post-text'),
      previewImg = $('#media-preview-img'), previewVid = $('#media-preview-video'),
      fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
      loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 20;

let lastTimestamp = null, lastKey = null, initialLoadDone = false;

if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.documentElement.setAttribute('data-theme', 'dark');

onAuthStateChanged(auth, user => {
  if (!user) {
    signInAnonymously(auth).catch(console.error);
  }
  uid = user ? user.uid : "guest_" + Math.random().toString(36).slice(2);
  uname = user?.displayName || user?.email?.split('@')[0] || 'Guest';
  uavatar = user?.photoURL || `https://ui-avatars.com/api/?background=d946ef&color=fff&name=${encodeURIComponent(uname)}`;
  myAvatarEl.src = uavatar;
  initFeed();
});

function showSkeleton(count = 6) {
  feedEl.innerHTML = '';
  for (let i = 0; i < count; i++) {
    feedEl.innerHTML += `
      <div class="post-card mx-auto">
        <div class="post-header">
          <div class="w-12 h-12 rounded-full skeleton"></div>
          <div class="flex-1 ml-3">
            <div class="h-4 w-32 skeleton rounded mb-2"></div>
            <div class="h-4 w-full skeleton rounded mb-1"></div>
            <div class="h-4 w-3/4 skeleton rounded"></div>
          </div>
        </div>
      </div>`;
  }
}

async function initFeed() {
  showSkeleton();
  try {
    const postsRef = ref(db, 'posts');
    const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
    const snap = await get(q);

    feedEl.innerHTML = '';
    if (snap.exists()) {
      const rows = [];
      snap.forEach(child => rows.unshift({key: child.key, ...child.val()}));
      rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
      const last = rows[rows.length - 1];
      lastTimestamp = last.timestamp;
      lastKey = last.key;
      loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
    } else {
      feedEl.innerHTML = '<div class="text-center p-8 text-gray-500">No posts yet. Be the first!</div>';
    }
    initialLoadDone = true;
    listenNewPosts();
  } catch (err) {
    console.error(err);
    feedEl.innerHTML = '<div class="text-center p-8 text-red-500">Failed to load posts. Check Firebase rules or network.</div>';
  }
}

function listenNewPosts() {
  const postsRef = ref(db, 'posts');
  onChildAdded(postsRef, snap => {
    if (!initialLoadDone) return;
    const data = snap.val();
    if (!data || data.timestamp === undefined) return;
    if (document.getElementById(`post-${snap.key}`)) return;
    if (!lastTimestamp || data.timestamp > lastTimestamp) {
      feedEl.prepend(renderPostCard({key: snap.key, ...data}));
      lastTimestamp = data.timestamp;
      lastKey = snap.key;
    }
  });
}

loadMoreBtn.onclick = async () => {
  loadMoreBtn.disabled = true;
  loadMoreBtn.textContent = 'Loading...';
  try {
    const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT + 1));
    const snap = await get(q);
    const rows = [];
    snap.forEach(c => rows.push({key: c.key, ...c.val()}));
    const newRows = rows.filter(p => p.key !== lastKey);
    if (newRows.length === 0) {
      toast('No more posts');
      loadMoreBtn.classList.add('hidden');
      return;
    }
    newRows.reverse();
    newRows.slice(1).forEach(p => feedEl.appendChild(renderPostCard(p)));
    const last = newRows[newRows.length - 1];
    lastTimestamp = last.timestamp;
    lastKey = last.key;
    if (newRows.length <= POST_LIMIT) loadMoreBtn.classList.add('hidden');
  } catch (err) {
    console.error(err);
    toast('Failed to load more');
  } finally {
    loadMoreBtn.disabled = false;
    loadMoreBtn.textContent = 'Load More Posts';
  }
};

let mediaUrl = '', uploading = false;
function togglePostBtn() {
  postBtn.disabled = uploading || (!textEl.value.trim() && !mediaUrl);
}

fileInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const isVideo = file.type.startsWith('video/');
  const isImage = file.type.startsWith('image/');
  if (!isVideo && !isImage) { toast('Only images or videos allowed'); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    if (isVideo) {
      previewVid.src = ev.target.result;
      previewVid.classList.remove('hidden');
      previewImg.classList.add('hidden');
    } else {
      previewImg.src = ev.target.result;
      previewImg.classList.remove('hidden');
      previewVid.classList.add('hidden');
    }
  };
  reader.readAsDataURL(file);
  uploadToCloudinary(file);
};

function uploadToCloudinary(file) {
  const CLOUD_NAME = "dqkujefxj";
  const UPLOAD_PRESET = "banter_box";
  uploading = true; togglePostBtn();
  $('#btn-spinner').classList.remove('hidden');
  $('#btn-text').classList.add('hidden');
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(res => {
      mediaUrl = res.secure_url;
      toast('Media uploaded');
    })
    .catch(err => {
      console.error(err);
      toast('Upload failed');
      mediaUrl = '';
      previewImg.classList.add('hidden');
      previewVid.classList.add('hidden');
    })
    .finally(() => {
      uploading = false;
      $('#btn-spinner').classList.add('hidden');
      $('#btn-text').classList.remove('hidden');
      togglePostBtn();
    });
}

postBtn.onclick = async () => {
  const text = textEl.value.trim();
  if (!text && !mediaUrl) return;
  postBtn.disabled = true;
  $('#btn-spinner').classList.remove('hidden');
  $('#btn-text').classList.add('hidden');

  const newRef = push(ref(db, 'posts'));
  const postData = {
    authorId: uid,
    authorName: uname,
    authorAvatar: uavatar,
    text,
    image: mediaUrl || null,
    likes: 0,
    replies: 0,
    reposts: 0,
    timestamp: serverTimestamp()
  };

  try {
    await set(newRef, postData);
    textEl.value = '';
    mediaUrl = '';
    previewImg.classList.add('hidden');
    previewVid.classList.add('hidden');
    togglePostBtn();
    toast('Posted!');
    const optimistic = {key: newRef.key, ...postData, timestamp: Date.now()};
    feedEl.prepend(renderPostCard(optimistic));
  } catch (err) {
    console.error(err);
    toast('Failed to post');
  } finally {
    $('#btn-spinner').classList.add('hidden');
    $('#btn-text').classList.remove('hidden');
    postBtn.disabled = false;
  }
};

textEl.oninput = () => {
  textEl.style.height = 'auto';
  textEl.style.height = textEl.scrollHeight + 'px';
  togglePostBtn();
};

function renderPostCard(p) {
  const isMine = p.authorId === uid;
  const div = document.createElement('div');
  div.id = `post-${p.key}`;
  div.className = 'post-card mx-auto';
  div.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar || uavatar}" class="post-avatar" alt="avatar">
      <div class="flex-1">
        <div class="user-meta">
          <span class="name">${esc(p.authorName || uname)}</span>
          <span class="handle">@${(p.authorName || uname).replace(/\s/g,'').toLowerCase()}</span>
          <span class="time-stamp"> · ${timeAgo(p.timestamp || Date.now())}</span>
        </div>
        <div class="post-content">${esc(p.text || '')}</div>
        ${mediaMarkup(p.image)}
        <div class="post-actions">
          <div class="action-item reply" data-post="${p.key}" data-action="reply">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            <span id="replies-\( {p.key}"> \){p.replies || 0}</span>
          </div>
          <div class="action-item like" data-post="${p.key}" data-action="like">
            <svg class="outline-heart" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <svg class="filled-heart hidden" width="24" height="24" viewBox="0 0 24 24" fill="#d946ef" stroke="#d946ef" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <span id="likes-\( {p.key}"> \){p.likes || 0}</span>
          </div>
          <div class="action-item share" data-post="${p.key}" data-action="share">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </div>
          \( {isMine ? `<div class="action-item delete-btn" data-post=" \){p.key}" data-action="delete">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
          </div>` : ''}
        </div>
      </div>
    </div>`;
  div.addEventListener('click', e => {
    if (e.target.closest('.post-image')) { openImageModal(e.target.src); return; }
    if (e.target.closest('.post-video')) { openVideoModal(e.target.dataset.videoUrl); return; }
    const actionEl = e.target.closest('[data-action]');
    if (!actionEl) return;
    const action = actionEl.dataset.action;
    const postId = actionEl.dataset.post;
    e.stopPropagation();
    if (action === 'reply') openComments(postId);
    if (action === 'like') toggleLike(postId);
    if (action === 'share') navigator.share?.({title:'Vynix Post', url:location.href}) || toast('Link copied to clipboard');
    if (action === 'delete') confirmDelete(postId);
  });
  listenCounters(p.key);
  return div;
}

function mediaMarkup(url) {
  if (!url) return '';
  const isVideo = url.includes('/video/upload') || url.endsWith('.mp4');
  if (isVideo) {
    return `
      <div class="post-video-wrapper">
        <video class="post-video" muted loop playsinline data-video-url="${url}">
          <source src="${url}" type="video/mp4">
        </video>
        <div class="video-play-overlay">
          <span class="material-icons">play_circle_filled</span>
        </div>
      </div>`;
  }
  return `<img class="post-image" src="${url}" loading="lazy">`;
}

function listenCounters(postId) {
  onValue(ref(db, `likes/${postId}`), s => {
    const count = s.size || 0;
    \( (`#likes- \){postId}`).textContent = count;
    const btn = document.querySelector(`[data-post="${postId}"].like`);
    if (btn) {
      btn.classList.toggle('liked', s.hasChild(uid));
      btn.querySelector('.outline-heart').classList.toggle('hidden', s.hasChild(uid));
      btn.querySelector('.filled-heart').classList.toggle('hidden', !s.hasChild(uid));
    }
  });
  onValue(ref(db, `comments/${postId}`), s => {
    \( (`#replies- \){postId}`).textContent = s.size || 0;
  });
}

async function toggleLike(postId) {
  const likeRef = ref(db, `likes/\( {postId}/ \){uid}`);
  const snap = await get(likeRef);
  if (snap.exists()) {
    await remove(likeRef);
  } else {
    await set(likeRef, true);
  }
}

let currentPostId = null, commentsListener = null;
const commentOverlay = $('#comment-sheet-overlay'),
      commentList = $('#comment-sheet-list'),
      commentInput = $('#comment-input'),
      commentSendBtn = $('#comment-send-btn');

function openComments(postId) {
  currentPostId = postId;
  commentInput.value = '';
  delete commentInput.dataset.parent;
  commentInput.placeholder = 'Write a comment...';
  commentList.innerHTML = '<div class="p-8 text-center text-gray-500">Loading comments...</div>';
  commentOverlay.classList.add('show');
  if (commentsListener) commentsListener();
  commentsListener = onValue(ref(db, `comments/${postId}`), snap => {
    commentList.innerHTML = '';
    if (!snap.exists()) {
      commentList.innerHTML = '<div class="p-4 text-sm text-gray-500 text-center">No comments yet</div>';
      return;
    }
    snap.forEach(c => {
      const v = c.val();
      const cid = c.key;
      const isMine = v.authorId === uid;
      const item = document.createElement('div');
      item.className = 'comment-item';
      item.innerHTML = `
        <img src="${v.authorAvatar}" class="comment-avatar">
        <div class="comment-body flex-1">
          <div class="comment-name">${esc(v.authorName)}</div>
          <div class="comment-text">${esc(v.text)}</div>
          <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
            <button class="comment-like-btn" data-cid="${cid}">
              <span class="comment-like-count">0</span> Like
            </button>
            \( {isMine ? `<button class="comment-delete-btn text-red-500" data-cid=" \){cid}">Delete</button>` : ''}
          </div>
        </div>`;
      commentList.appendChild(item);
      listenCommentLikes(postId, cid);
    });
  });
}

function closeComments() {
  commentOverlay.classList.remove('show');
  if (commentsListener) { commentsListener(); commentsListener = null; }
  currentPostId = null;
}

$('#comment-sheet-close').onclick = closeComments;
commentOverlay.onclick = e => { if (e.target === commentOverlay) closeComments(); };

commentSendBtn.onclick = async () => {
  const text = commentInput.value.trim();
  if (!text || !currentPostId) return;
  const commentRef = push(ref(db, `comments/${currentPostId}`));
  await set(commentRef, {
    authorId: uid,
    authorName: uname,
    authorAvatar: uavatar,
    text,
    timestamp: Date.now()
  });
  commentInput.value = '';
  toast('Comment posted');
};

commentInput.oninput = () => commentSendBtn.disabled = !commentInput.value.trim();

function listenCommentLikes(pid, cid) {
  onValue(ref(db, `comments/\( {pid}/ \){cid}/likes`), snap => {
    const count = snap.size || 0;
    const liked = snap.hasChild(uid);
    const btn = document.querySelector(`.comment-like-btn[data-cid="${cid}"]`);
    if (btn) btn.querySelector('.comment-like-count').textContent = count;
  });
}

let deleteKeyStore = null;
const alertOverlay = $('#custom-alert-overlay');
function confirmDelete(key) {
  deleteKeyStore = key;
  $('#custom-alert-title').textContent = 'Delete Post';
  $('#custom-alert-message').textContent = 'Are you sure you want to delete this post?';
  alertOverlay.classList.add('show');
}

$('#custom-alert-cancel').onclick = () => {
  deleteKeyStore = null;
  alertOverlay.classList.remove('show');
};

$('#custom-alert-confirm').onclick = async () => {
  if (!deleteKeyStore) return;
  const key = deleteKeyStore;
  deleteKeyStore = null;
  alertOverlay.classList.remove('show');
  try {
    await remove(ref(db, `posts/${key}`));
    const el = document.getElementById(`post-${key}`);
    if (el) el.remove();
    toast('Post deleted');
  } catch (err) {
    toast('Delete failed');
  }
};

function openImageModal(src) {
  $('#modal-image').src = src;
  $('#modal-image').style.display = 'block';
  $('#modal-video').style.display = 'none';
  $('#video-controls').style.display = 'none';
  $('#image-modal').classList.add('show');
}

function openVideoModal(src) {
  const video = $('#modal-video');
  video.querySelector('source').src = src;
  video.load();
  video.style.display = 'block';
  $('#modal-image').style.display = 'none';
  $('#video-controls').style.display = 'flex';
  $('#image-modal').classList.add('show');
  initVideoControls();
}

function initVideoControls() {
  const video = $('#modal-video');
  const playBtn = $('#play-pause-btn');
  const muteBtn = $('#mute-btn');
  const timeEl = $('#video-time');
  const progress = $('#video-progress');
  const bar = $('#video-progress-bar');

  playBtn.onclick = () => {
    if (video.paused) {
      video.play();
      playBtn.innerHTML = '<span class="material-icons-outlined">pause</span>';
    } else {
      video.pause();
      playBtn.innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
    }
  };

  muteBtn.onclick = () => {
    video.muted = !video.muted;
    muteBtn.innerHTML = video.muted ? '<span class="material-icons-outlined">volume_off</span>' : '<span class="material-icons-outlined">volume_up</span>';
  };

  video.ontimeupdate = () => {
    bar.style.width = (video.currentTime / video.duration * 100) + '%';
    timeEl.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
  };

  progress.onclick = e => {
    const rect = progress.getBoundingClientRect();
    const pos = (e.clientX - rect.left) / rect.width;
    video.currentTime = pos * video.duration;
  };

  video.play();
}

function formatTime(s) {
  if (isNaN(s)) return '0:00';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `\( {m}: \){sec.toString().padStart(2,'0')}`;
}

window.closeImageModal = () => {
  const modal = $('#image-modal');
  $('#modal-video').pause();
  modal.classList.remove('show');
};

$('#image-modal').onclick = e => { if (e.target === $('#image-modal')) closeImageModal(); };

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'custom-toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => {
    t.classList.remove('show');
    setTimeout(() => t.remove(), 400);
  }, 3000);
}

const esc = s => s ? String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : '';

const timeAgo = ts => {
  if (!ts) return 'now';
  const secs = Math.floor((Date.now() - ts) / 1000);
  if (secs < 60) return `${secs}s`;
  if (secs < 3600) return `${Math.floor(secs/60)}m`;
  if (secs < 86400) return `${Math.floor(secs/3600)}h`;
  return `${Math.floor(secs/86400)}d`;
};

let lastScroll = 0;
let scrollTimeout;
const fab = $('#fab');
window.addEventListener('scroll', () => {
  const st = window.pageYOffset;
  clearTimeout(scrollTimeout);
  if (st < lastScroll || st < 100) {
    fab.classList.remove('hidden');
  } else {
    fab.classList.add('hidden');
  }
  lastScroll = st;
  scrollTimeout = setTimeout(() => fab.classList.remove('hidden'), 1200);
});

fab.onclick = () => {
  textEl.focus();
  window.scrollTo({top: 0, behavior: 'smooth'});
};

let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  $('#pwa-install-banner').classList.remove('-translate-y-full');
});

$('#pwa-install-btn')?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  $('#pwa-install-banner').classList.add('-translate-y-full');
});

$('#pwa-install-close')?.addEventListener('click', () => {
  $('#pwa-install-banner').classList.add('-translate-y-full');
});
</script>
</body>
</html>
