<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix Chats</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --accent-purple: #d946ef;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-color: #f9fafb;
            --divider: #f3f4f6;
            --logo-gradient: linear-gradient(135deg, #000000 0%, var(--accent-purple) 50%, #10b981 100%);
            --whatsapp-card: #ffffff;
            --unread-count: #ef4444;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); overflow-x: hidden; color: var(--text-primary); }

        /* --- Header & Search Bar --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 85px; background: var(--whatsapp-card);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100; border-bottom: 1px solid var(--divider);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
        }

        .user-profile-container { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .user-profile { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-purple); }
        .my-id-badge { font-size: 10px; background: #f3f4f6; padding: 2px 8px; border-radius: 10px; margin-top: 4px; font-weight: 700; color: #333; }
        .app-title { font-size: 26px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }

        #searchWrapper {
            display: none; flex: 1; align-items: center; background: #f3f4f6;
            padding: 10px 15px; border-radius: 16px; margin: 0 15px;
        }
        #searchWrapper input { border: none; background: transparent; outline: none; width: 100%; font-family: inherit; font-size: 15px; }
        
        /* Search Active States */
        .search-active .app-title, .search-active .user-profile-container { display: none; }
        .search-active #searchWrapper { display: flex; }

        /* --- Chat List --- */
        main { padding-top: 100px; padding-bottom: 100px; }
        
        .chat-item {
            display: flex; align-items: center; padding: 16px; 
            background: var(--whatsapp-card); margin: 10px 16px; border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, background 0.2s ease;
            position: relative;
        }
        .chat-item:active { transform: scale(0.97); background: #f3f4f6; }

        .avatar-container { margin-right: 15px; position: relative; cursor: pointer; }
        .avatar { width: 55px; height: 55px; border-radius: 16px; object-fit: cover; }
        
        .chat-info { flex: 1; overflow: hidden; cursor: pointer; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .name { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .time { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
        .msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 220px; }
        
        .unread-count {
            background: var(--unread-count); color: white; font-size: 10px; font-weight: 700;
            min-width: 20px; height: 20px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; padding: 0 5px;
        }

        /* --- Profile Detail Modal --- */
        .profile-viewer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 2000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(12px);
        }
        .profile-card-content {
            background: white; width: 85%; max-width: 340px; border-radius: 32px;
            padding: 40px 24px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        #modalImg { width: 130px; height: 130px; border-radius: 24px; object-fit: cover; margin-bottom: 20px; border: 4px solid var(--accent-purple); }
        #modalName { color: #111; margin: 0; font-size: 24px; font-weight: 700; }
        #modalId { color: var(--accent-purple); font-weight: 600; margin-top: 6px; font-size: 14px; }
        .close-profile { margin-top: 30px; color: var(--text-secondary); font-size: 12px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* --- Utilities --- */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 20px; background: #000; color: #fff; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 90; }
        #v-toast { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 13px; z-index: 3000; display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; backdrop-filter: blur(4px); }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 30px 30px 0 0; padding: 30px 24px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1); z-index: 1001; }
        .bottom-sheet.active { bottom: 0; }
        .v-input { width: 100%; padding: 16px; border: 2px solid #f3f4f6; border-radius: 16px; margin-bottom: 15px; font-family: inherit; font-size: 15px; outline: none; }
        .primary-btn { width: 100%; background: #000; color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div id="v-toast"></div>

    <div id="profileViewer" class="profile-viewer" onclick="closeProfile()">
        <div class="profile-card-content" onclick="event.stopPropagation()">
            <img id="modalImg" src="">
            <h2 id="modalName">Name</h2>
            <div id="modalId">@id</div>
            <hr style="border: 0; border-top: 1px solid #f0f0f0; margin: 25px 0;">
            <p style="font-size: 13px; color: #666;">End-to-end encrypted contact.</p>
            <div class="close-profile" onclick="closeProfile()">Close</div>
        </div>
    </div>

    <header id="mainHeader">
        <div class="user-profile-container" onclick="openSettings()">
            <img id="myPhoto" class="user-profile" src="https://via.placeholder.com/45">
            <span id="myDisplayId" class="my-id-badge">...</span>
        </div>
        
        <div class="app-title">Vynix</div>

        <div id="searchWrapper">
            <span class="material-symbols-rounded" style="color: #999; margin-right: 10px;">search</span>
            <input type="text" id="chatSearchInput" placeholder="Search friends..." oninput="filterChats()">
            <span class="material-symbols-rounded" style="cursor: pointer; font-size: 20px;" onclick="toggleSearch(false)">close</span>
        </div>

        <span class="material-symbols-rounded" id="searchTrigger" onclick="toggleSearch(true)">search</span>
    </header>

    <main id="chatList">
        <div style="text-align: center; padding: 50px; color: #999;">Loading...</div>
    </main>

    <button class="fab" onclick="toggleSheet('addFriendSheet', true)">
        <span class="material-symbols-rounded" style="font-size: 30px;">add</span>
    </button>

    <div class="overlay" id="uiOverlay" onclick="closeAllSheets()"></div>
    <div class="bottom-sheet" id="addFriendSheet">
        <h3>Add Friend</h3>
        <input type="text" id="targetId" class="v-input" placeholder="Vynix ID (vnx_...)">
        <button class="primary-btn" onclick="addFriendLogic()">Add Friend</button>
    </div>

    <div class="bottom-sheet" id="settingsSheet">
        <h3>Settings</h3>
        <input type="text" id="editName" class="v-input" placeholder="Display Name">
        <button class="primary-btn" onclick="saveProfile()">Save</button>
        <button class="primary-btn" style="background: #f3f4f6; color: #ef4444; margin-top: 10px;" onclick="auth.signOut()">Logout</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const secretBase = "Vynix_E2EE_Alpha_";

        let currentUser = null;
        let allChats = [];
        let unreadCounts = {};

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initApp();
            } else { window.location.href = "login.html"; }
        });

        async function initApp() {
            const profileSnap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            const data = profileSnap.val();
            document.getElementById('myPhoto').src = currentUser.photoURL;
            document.getElementById('myDisplayId').innerText = "@" + data.vynixId;
            document.getElementById('editName').value = data.name;
            
            loadUnreadAndChats();
        }

        function toggleSearch(show) {
            const header = document.getElementById('mainHeader');
            const trigger = document.getElementById('searchTrigger');
            if (show) {
                header.classList.add('search-active');
                trigger.style.display = 'none';
                document.getElementById('chatSearchInput').focus();
            } else {
                header.classList.remove('search-active');
                trigger.style.display = 'block';
                document.getElementById('chatSearchInput').value = '';
                renderChatList(allChats);
            }
        }

        function filterChats() {
            const q = document.getElementById('chatSearchInput').value.toLowerCase();
            const filtered = allChats.filter(c => c.name.toLowerCase().includes(q) || c.decryptedMsg.toLowerCase().includes(q));
            renderChatList(filtered);
        }

        function loadUnreadAndChats() {
            db.ref(`users/${currentUser.uid}/unreadCounts`).on('value', snap => {
                unreadCounts = snap.val() || {};
                fetchChats();
            });
        }

        function fetchChats() {
            db.ref(`users/${currentUser.uid}/chats`).on('value', snapshot => {
                allChats = [];
                snapshot.forEach(child => {
                    const chat = child.val();
                    chat.friendUid = child.key;
                    const roomId = currentUser.uid < child.key ? currentUser.uid+"_"+child.key : child.key+"_"+currentUser.uid;
                    chat.decryptedMsg = decryptMessage(chat.lastMsg, roomId);
                    chat.unreadCount = unreadCounts[child.key] || 0;
                    chat.sortTs = chat.ts || 0;
                    allChats.push(chat);
                });
                allChats.sort((a, b) => b.sortTs - a.sortTs);
                renderChatList(allChats);
            });
        }

        function renderChatList(chats) {
            const list = document.getElementById('chatList');
            list.innerHTML = chats.length ? '' : `<div style="text-align:center; padding:50px; color:#999;">No conversations yet.</div>`;
            chats.forEach(chat => {
                list.innerHTML += `
                    <div class="chat-item" data-friend="${chat.friendUid}">
                        <div class="avatar-container" onclick="fetchAndShowProfile('${chat.friendUid}', event)">
                            <img class="avatar" src="${chat.photo}" onerror="this.src='https://via.placeholder.com/55?text=${chat.name.charAt(0)}'">
                        </div>
                        <div class="chat-info" onclick="openChat('${chat.friendUid}', '${chat.name}', '${chat.photo}')">
                            <div class="chat-header">
                                <span class="name">${chat.name}</span>
                                <span class="time">${formatWhatsAppTime(chat.lastTime)}</span>
                            </div>
                            <div class="msg">${chat.decryptedMsg}</div>
                        </div>
                        ${chat.unreadCount > 0 ? `<div class="unread-count">${chat.unreadCount}</div>` : ''}
                    </div>
                `;
            });
        }

        async function fetchAndShowProfile(uid, event) {
            event.stopPropagation();
            const modal = document.getElementById('profileViewer');
            modal.style.display = 'flex';
            document.getElementById('modalName').innerText = "Loading...";
            
            const snap = await db.ref(`users/${uid}/profile`).once('value');
            const data = snap.val();
            if (data) {
                document.getElementById('modalName').innerText = data.name;
                document.getElementById('modalId').innerText = "@" + data.vynixId;
                document.getElementById('modalImg').src = data.photo.replace('s96-c', 's300-c');
            }
        }

        function closeProfile() { document.getElementById('profileViewer').style.display = 'none'; }

        function decryptMessage(text, roomId) {
            if(!text || !text.includes("U2FsdGVk")) return text;
            try {
                const bytes = CryptoJS.AES.decrypt(text, secretBase + roomId);
                return bytes.toString(CryptoJS.enc.Utf8) || "ðŸ”’ Encrypted";
            } catch(e) { return "ðŸ”’ Encrypted"; }
        }

        function formatWhatsAppTime(t) {
            if (!t || t === "New") return "Now";
            return t; // Simple return for this version
        }

        async function openChat(uid, name, photo) {
            if (unreadCounts[uid]) {
                unreadCounts[uid] = 0;
                await db.ref(`users/${currentUser.uid}/unreadCounts`).set(unreadCounts);
            }
            window.location.href = `chat.html?friend=${uid}&name=${encodeURIComponent(name)}&photo=${encodeURIComponent(photo)}`;
        }

        // --- Standard UI Helpers ---
        function openSettings() { toggleSheet('settingsSheet', true); }
        function closeAllSheets() { 
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
            document.getElementById('uiOverlay').style.display = 'none';
        }
        function toggleSheet(id, show) {
            document.getElementById('uiOverlay').style.display = show ? 'block' : 'none';
            document.getElementById(id).classList.toggle('active', show);
        }
        function showToast(m) {
            const t = document.getElementById('v-toast');
            t.innerText = m; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2500);
        }
    </script>
</body>
</html>
