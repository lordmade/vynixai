<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Vynix Lingua WhatsApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  <style>
    :root {
      --primary-black: #000;
      --primary-white: #fff;
      --gray-light: #f5f5f5;
      --gray-mid: #9e9e9e;
      --bubble-own: #e0e0e0;
      --bubble-other: #fff;
      --header-height: 60px;
      --tabbar-height: 70px;
      --pill-radius: 25px;
      --verified-blue: #1DA1F2;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--primary-white);
      color: #000;
      height: 100vh;
      overflow: hidden;
      touch-action: pan-y;
    }
    .app-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--primary-white);
    }
    @media (min-width: 768px) {
      .app-container {
        max-width: 450px;
        margin: 0 auto;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
    }
    .whatsapp-header {
      height: var(--header-height);
      background: var(--primary-black);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 100;
      transition: transform .3s;
    }
    .whatsapp-header.hidden {
      transform: translateY(-100%);
    }
    .header-title {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 18px;
      color: var(--primary-white);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-actions {
      display: flex;
      gap: 16px;
    }
    .header-icon {
      color: var(--primary-white);
      font-size: 24px;
      cursor: pointer;
    }
    .whatsapp-tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--tabbar-height);
      display: flex;
      justify-content: center;
      padding-top: 10px;
      z-index: 1000;
      pointer-events: none;
      transition: transform .3s ease;
    }
    .whatsapp-tabbar.hidden {
      transform: translateY(100%);
    }
    @media (min-width: 768px) {
      .whatsapp-tabbar {
        left: 50%;
        transform: translateX(-50%);
        max-width: 450px;
      }
    }
    .pill-tabs {
      background: var(--primary-white);
      border-radius: var(--pill-radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      padding: 6px;
      gap: 4px;
      pointer-events: all;
    }
    .pill-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 20px;
      color: var(--gray-mid);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      min-width: 80px;
      justify-content: center;
    }
    .pill-tab.active {
      background: var(--primary-black);
      color: var(--primary-white);
      transform: scale(1.05);
    }
    .main-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      padding-bottom: var(--tabbar-height);
    }
    .swipe-container {
      display: flex;
      width: 300%;
      height: 100%;
      transition: transform .3s;
    }
    .swipe-container.chat-active   { transform: translateX(0); }
    .swipe-container.status-active { transform: translateX(-33.333%); }
    .swipe-container.comm-active   { transform: translateX(-66.666%); }

    .chats-list-view, .status-view, .community-view {
      width: 33.333%;
      height: 100%;
      background: var(--primary-white);
      overflow-y: auto;
      padding-top: 8px;
      padding-bottom: calc(var(--tabbar-height) + 20px);
    }
    .chat-item-whatsapp, .community-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      position: relative;
    }
    .chat-item-whatsapp:hover, .community-item:hover { background: var(--gray-light); }
    .chat-item-whatsapp::after, .community-item::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 80px;
      right: 0;
      height: 1px;
      background: rgba(0, 0, 0, 0.05);
    }
    .whatsapp-avatar {
      width: 56px; height: 56px; border-radius: 50%; background: var(--gray-light);
      display: flex; align-items: center; justify-content: center; font-size: 20px;
      font-weight: 500; color: #000; margin-right: 12px; position: relative; flex-shrink: 0;
    }
    .whatsapp-avatar.online::before {
      content: ''; position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px;
      background: #4caf50; border: 3px solid white; border-radius: 50%; z-index: 2;
    }
    .chat-info-whatsapp, .community-info { flex: 1; min-width: 0; position: relative; }
    .chat-header-row, .community-header-row {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;
    }
    .chat-name-wrapper, .community-name-wrapper { display: flex; align-items: center; gap: 6px; }
    .chat-name-whatsapp, .community-name {
      font-weight: 500; font-size: 16px; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .verified-badge {
      width: 18px; height: 18px; background: var(--verified-blue); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; flex-shrink: 0;
    }
    .chat-time-whatsapp, .community-time {
      font-size: 12px; color: var(--gray-mid); margin-left: 8px; flex-shrink: 0;
    }
    .chat-preview-whatsapp, .community-preview {
      font-size: 14px; color: var(--gray-mid); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .typing-indicator { font-size: 14px; color: #4caf50; font-style: italic; }
    .unread-count {
      position: absolute; top: 12px; right: 16px; background: #4caf50; color: white;
      font-size: 12px; font-weight: 600; min-width: 20px; height: 20px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; padding: 0 6px; z-index: 3;
    }
    .delete-chat-btn {
      position: absolute; top: 50%; right: 8px; transform: translateY(-50%);
      background: rgba(255, 0, 0, 0.1); color: red; border: none; border-radius: 50%;
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: opacity .2s; cursor: pointer;
    }
    .chat-item-whatsapp:hover .delete-chat-btn { opacity: 1; }
    .chat-view, .community-chat-view {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--gray-light);
      display: none; flex-direction: column; z-index: 200;
    }
    .chat-view.active, .community-chat-view.active { display: flex; }
    .messages-wrapper-whatsapp, .messages-wrapper-community {
      flex: 1; overflow-y: auto; padding: 16px 16px 100px 16px; background: var(--gray-light); contain: strict;
    }
    .whatsapp-bubble {
      max-width: 70%; padding: 8px 12px; margin-bottom: 4px; word-wrap: break-word;
      font-size: 14px; line-height: 1.3; contain: layout style paint;
    }
    .whatsapp-bubble.own {
      background: var(--bubble-own); color: #000; border-radius: 8px 8px 0 8px; margin-left: auto;
    }
    .whatsapp-bubble.other {
      background: var(--bubble-other); color: #000; border-radius: 8px 8px 8px 0; margin-right: auto;
    }
    .bubble-time {
      font-size: 11px; color: rgba(0, 0, 0, 0.5); margin-top: 4px; text-align: right;
    }
    .input-area-whatsapp, .input-area-community {
      position: fixed; bottom: 0; left: 0; right: 0; background: var(--primary-white);
      padding: 8px 16px; display: flex; align-items: flex-end; gap: 8px;
      border-top: 1px solid rgba(0, 0, 0, 0.05); z-index: 300;
    }
    @media (min-width: 768px) {
      .input-area-whatsapp, .input-area-community {
        left: 50%; transform: translateX(-50%); max-width: 450px;
      }
    }
    .input-wrapper-whatsapp, .input-wrapper-community {
      flex: 1; background: var(--gray-light); border-radius: 24px; padding: 8px 16px;
      display: flex; align-items: center; gap: 8px; min-height: 44px;
    }
    .whatsapp-input, .community-input {
      flex: 1; border: none; background: transparent; font-size: 15px; outline: none;
      resize: none; max-height: 100px; -webkit-user-select: text; user-select: text;
    }
    .send-btn-whatsapp, .send-btn-community {
      width: 44px; height: 44px; border-radius: 50%; background: var(--primary-black);
      border: none; color: white; display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0;
    }
    #floatingBackBtn {
      position: fixed; top: 16px; left: 16px; font-size: 32px; color: #fff;
      background: rgba(0, 0, 0, 0.6); border-radius: 50%; padding: 8px; z-index: 400;
      cursor: pointer; display: none;
    }
    @media (min-width: 768px) {
      .chat-view.active #floatingBackBtn, .community-chat-view.active #floatingBackBtn { display: block; }
    }
    .add-friend-fab {
      position: fixed; bottom: calc(var(--tabbar-height) + 20px); right: 20px;
      width: 56px; height: 56px; border-radius: 50%; background: var(--primary-black);
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 100; transition: transform .3s ease; color: white; font-size: 32px;
    }
    .add-friend-fab.hidden { transform: translateY(100px); }
    .auth-overlay, .users-sheet, .confirm-overlay {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 300;
      display: none; align-items: flex-end;
    }
    .auth-overlay.open, .users-sheet.open, .confirm-overlay.open { display: flex; }
    .auth-box-whatsapp, .users-box, .confirm-box {
      background: var(--primary-white); width: 100%; border-radius: 24px 24px 0 0; padding: 32px 24px;
      animation: slideUp .3s;
    }
    @media (min-width: 768px) {
      .auth-overlay, .users-sheet, .confirm-overlay { align-items: center; justify-content: center; }
      .auth-box-whatsapp, .users-box { width: 380px; border-radius: 20px; }
    }
    .auth-title, .users-title, .confirm-title {
      font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 8px;
    }
    .auth-subtitle, .confirm-message {
      text-align: center; color: var(--gray-mid); margin-bottom: 24px; font-size: 14px;
    }
    .auth-input-whatsapp {
      width: 100%; padding: 14px 16px; border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px; margin-bottom: 16px; font-size: 16px; background: var(--gray-light);
    }
    .auth-btn-whatsapp, .confirm-btn {
      width: 100%; padding: 14px; background: var(--primary-black); color: white; border: none;
      border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 16px;
    }
    .auth-switch { text-align: center; font-size: 14px; color: var(--gray-mid); }
    .auth-switch-btn { background: none; border: none; color: var(--primary-black); font-weight: 600; cursor: pointer; }
    .confirm-buttons { display: flex; gap: 12px; }
    .confirm-btn.cancel { background: var(--gray-light); color: #000; }
    .confirm-btn.danger { background: #ff3b30; color: white; }
    .status-header {
      display: flex; justify-content: space-between; align-items: center; padding: 16px;
    }
    .status-title { font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 600; }
    .add-status-btn {
      background: var(--primary-black); color: white; border: none; border-radius: 50%;
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .status-composer {
      padding: 0 16px 16px; display: none;
    }
    .status-composer.open { display: block; }
    .status-input {
      width: 100%; padding: 12px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px;
      resize: vertical; min-height: 80px; font-family: inherit; font-size: 15px;
    }
    .status-post-btn {
      margin-top: 12px; padding: 10px 20px; background: var(--primary-black); color: white;
      border: none; border-radius: 12px; font-weight: 500; cursor: pointer;
    }
    .status-cards { padding: 0 16px; }
    .status-card {
      background: var(--gray-light); border-radius: 16px; padding: 16px; margin-bottom: 12px;
    }
    .status-card-header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
    }
    .status-avatar {
      width: 40px; height: 40px; border-radius: 50%; background: white;
      display: flex; align-items: center; justify-content: center; font-weight: 500;
    }
    .status-author { font-weight: 500; }
    .status-time { font-size: 12px; color: var(--gray-mid); }
    .status-content { margin-bottom: 12px; white-space: pre-wrap; }
    .status-actions { display: flex; gap: 16px; }
    .status-action {
      display: flex; align-items: center; gap: 4px; font-size: 14px; color: var(--gray-mid); cursor: pointer;
    }
    .users-list { max-height: 50vh; overflow-y: auto; }
    .user-item-whatsapp {
      display: flex; align-items: center; gap: 12px; padding: 12px 0;
    }
    .user-avatar-whatsapp {
      width: 48px; height: 48px; border-radius: 50%; background: var(--gray-light);
      display: flex; align-items: center; justify-content: center; font-weight: 500; position: relative;
    }
    .user-avatar-whatsapp.online::before {
      content: ''; position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px;
      background: #4caf50; border: 2px solid white; border-radius: 50%;
    }
    .user-info-whatsapp { flex: 1; min-width: 0; }
    .user-name-wrapper { display: flex; align-items: center; gap: 6px; }
    .user-name-whatsapp { font-weight: 500; }
    .user-email-whatsapp { font-size: 14px; color: var(--gray-mid); }
    .add-friend-btn {
      padding: 8px 16px; background: var(--primary-black); color: white; border: none;
      border-radius: 12px; font-size: 14px; cursor: pointer;
    }
    .add-friend-btn.added { background: var(--gray-mid); cursor: not-allowed; }
    .toast-notification {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: var(--primary-black); color: white; padding: 12px 24px; border-radius: 24px;
      font-size: 14px; z-index: 2000; opacity: 0; transition: opacity .3s;
    }
    .toast-notification.show { opacity: 1; }
    .new-message-popup {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      background: var(--primary-black); color: white; padding: 12px 32px; border-radius: 30px;
      font-size: 14px; z-index: 2000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: top .4s ease; max-width: 90%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .new-message-popup.show { top: 20px; }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .search-bar {
      padding: 12px 16px; background: var(--primary-white);
    }
    .search-input {
      width: 100%; padding: 12px 16px; background: var(--gray-light); border-radius: 24px;
      border: none; font-size: 15px; outline: none;
    }
    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .loading-placeholder {
      display: flex; align-items: center; padding: 12px 16px;
    }
    .loading-avatar {
      width: 56px; height: 56px; border-radius: 50%; background: #e0e0e0;
      margin-right: 12px; flex-shrink: 0;
    }
    .loading-lines { flex: 1; }
    .loading-line {
      height: 16px; background: #e0e0e0; border-radius: 8px; margin-bottom: 8px;
    }
    .loading-line.short { width: 60%; }
    body.sheet-open .whatsapp-header { transform: translateY(-100%); }
    body.sheet-open .whatsapp-tabbar { transform: translateY(100%); }
    .delete-status-btn {
      background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .delete-status-btn:hover { background: rgba(255, 59, 48, 0.1); }
    .incoming-message-pill {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      background: var(--primary-white); border-radius: 28px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      max-width: 320px; width: calc(100% - 40px); z-index: 2000;
      transition: top .4s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }
    .incoming-message-pill.show { top: 20px; }
    .incoming-pill-avatar {
      width: 48px; height: 48px; border-radius: 50%; background: var(--gray-light);
      display: flex; align-items: center; justify-content: center; font-size: 20px;
      font-weight: 600; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .incoming-pill-content { flex: 1; min-width: 0; }
    .incoming-pill-name {
      font-weight: 600; font-size: 15px; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .incoming-pill-text {
      font-size: 14px; color: var(--gray-mid); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px;
    }
    @media (min-width: 768px) {
      .incoming-message-pill { max-width: 380px; }
      .incoming-message-pill.show { top: 100px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="whatsapp-header" id="mainHeader">
      <div class="header-title">Vynix Lingua</div>
      <div class="header-actions">
        <span class="material-symbols-rounded header-icon" id="openProfileBtn">more_vert</span>
      </div>
    </header>

    <div class="main-content">
      <div class="swipe-container" id="swipeContainer">
        <!-- CHATS LIST -->
        <div class="chats-list-view">
          <div class="search-bar">
            <input type="text" class="search-input" id="chatSearchInput" placeholder="Search chats..." autocomplete="off" spellcheck="false"/>
          </div>
          <div id="chatsList" class="chats-list"></div>
        </div>

        <!-- STATUS -->
        <div class="status-view">
          <div class="status-header">
            <h2 class="status-title">Status</h2>
            <button class="add-status-btn" id="addStatusBtn"><span class="material-symbols-rounded">add</span></button>
          </div>
          <div class="status-composer" id="statusComposer">
            <textarea class="status-input" id="statusInput" placeholder="What's on your mind?"></textarea>
            <input type="file" id="statusImageFile" accept="image/*" style="display:none"/>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;">
              <div style="display:flex;gap:12px;">
                <button type="button" class="status-action" id="attachImageBtn" title="Attach image">
                  <span class="material-symbols-rounded" style="font-size:20px;">attach_file</span>
                </button>
                <span id="imageName" style="font-size:13px;color:var(--gray-mid);max-width:140px;overflow:hidden;text-overflow:ellipsis;"></span>
              </div>
              <button class="status-post-btn" id="statusPostBtn">Post Status</button>
            </div>
          </div>
          <div id="statusCards" class="status-cards"></div>
        </div>

        <!-- COMMUNITY -->
        <div class="community-view">
          <div class="community-item">
            <div class="whatsapp-avatar">üåç</div>
            <div class="community-info">
              <div class="community-header-row">
                <div class="community-name-wrapper">
                  <div class="community-name">Community Room</div>
                </div>
                <div class="community-time" id="communityTime"></div>
              </div>
              <div class="community-preview" id="communityPreview">Tap to join the conversation</div>
            </div>
            <div class="unread-count" id="communityUnread" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- PRIVATE CHAT VIEW -->
      <div class="chat-view" id="chatView">
        <span class="material-symbols-rounded" id="floatingBackBtn">arrow_back</span>
        <div class="messages-wrapper-whatsapp" id="messagesContainer"></div>
        <div class="input-area-whatsapp">
          <div class="input-wrapper-whatsapp">
            <span class="material-symbols-rounded" style="color:var(--gray-mid);cursor:pointer">emoji_emotions</span>
            <textarea class="whatsapp-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <span class="material-symbols-rounded" style="color:var(--gray-mid);cursor:pointer">attach_file</span>
          </div>
          <button class="send-btn-whatsapp" id="sendButton"><span class="material-symbols-rounded">send</span></button>
        </div>
      </div>

      <!-- COMMUNITY CHAT VIEW -->
      <div class="community-chat-view" id="communityChatView">
        <span class="material-symbols-rounded" id="floatingBackBtnCommunity">arrow_back</span>
        <div class="messages-wrapper-community" id="communityMessagesContainer"></div>
        <div class="input-area-community">
          <div class="input-wrapper-community">
            <span class="material-symbols-rounded" style="color:var(--gray-mid);cursor:pointer">emoji_emotions</span>
            <textarea class="community-input" id="communityMessageInput" placeholder="Type a community message..." rows="1"></textarea>
            <span class="material-symbols-rounded" style="color:var(--gray-mid);cursor:pointer" id="communityAttachBtn">attach_file</span>
          </div>
          <button class="send-btn-community" id="communitySendButton"><span class="material-symbols-rounded">send</span></button>
        </div>
      </div>
    </div>

    <!-- FLOATING ADD-FRIEND BUTTON -->
    <div class="add-friend-fab" id="addFriendFab"><span class="material-symbols-rounded">person_add</span></div>

    <!-- PILLS TAB-BAR -->
    <div class="whatsapp-tabbar" id="tabbar">
      <div class="pill-tabs">
        <div class="pill-tab active" data-tab="chats"><span class="material-symbols-rounded">chat_bubble</span><span>Chats</span></div>
        <div class="pill-tab" data-tab="status"><span class="material-symbols-rounded">circle</span><span>Status</span></div>
        <div class="pill-tab" data-tab="comm"><span class="material-symbols-rounded">group</span><span>Community</span></div>
      </div>
    </div>

    <!-- INCOMING MESSAGE PILL -->
    <div class="incoming-message-pill" id="incomingMessagePill">
      <div class="incoming-pill-avatar" id="pillAvatar">?</div>
      <div class="incoming-pill-content">
        <div class="incoming-pill-name" id="pillName">Someone</div>
        <div class="incoming-pill-text" id="pillText">New message</div>
      </div>
    </div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box-whatsapp">
      <h2 class="auth-title">Welcome to Vynix Lingua</h2>
      <p class="auth-subtitle">Sign in to start chatting</p>
      <input type="email" id="authEmail" class="auth-input-whatsapp" placeholder="Email"/>
      <input type="password" id="authPass" class="auth-input-whatsapp" placeholder="Password"/>
      <button class="auth-btn-whatsapp" id="authBtn">Sign In</button>
      <div class="auth-switch">
        <span>Don't have an account?</span>
        <button class="auth-switch-btn" id="authSwitchBtn">Sign Up</button>
      </div>
    </div>
  </div>

  <!-- CONFIRM OVERLAY -->
  <div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-box">
      <div class="confirm-title" id="confirmTitle">Confirm Action</div>
      <div class="confirm-message" id="confirmMessage">Are you sure?</div>
      <div class="confirm-buttons">
        <button class="confirm-btn cancel" id="confirmCancel">Cancel</button>
        <button class="confirm-btn danger" id="confirmOk">Delete</button>
      </div>
    </div>
  </div>

  <!-- PROFILE SHEET -->
  <div class="users-sheet" id="profileSheet">
    <div class="users-box">
      <div class="users-header">
        <h2 class="users-title">Profile</h2>
        <button class="close-sheet-btn"><span class="material-symbols-rounded">close</span></button>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:12px;margin:24px 0;">
        <div class="whatsapp-avatar" id="profileAvatar" style="width:80px;height:80px;font-size:32px;">?</div>
        <span id="profileVerified" class="verified-badge" style="display:none;">‚úì</span>
      </div>
      <div class="user-item-whatsapp" style="padding:8px 0;">
        <span class="material-symbols-rounded" style="color:var(--gray-mid);">badge</span>
        <div class="user-info-whatsapp">
          <div class="user-name-whatsapp">Display name</div>
          <div id="profileName" style="color:#000;">Loading...</div>
        </div>
        <button class="add-friend-btn" id="editDisplayNameBtn">Edit</button>
      </div>
      <div class="user-item-whatsapp" style="padding:8px 0;">
        <span class="material-symbols-rounded" style="color:var(--gray-mid);">alternate_email</span>
        <div class="user-info-whatsapp">
          <div class="user-name-whatsapp">Username</div>
          <div id="profileUsername" style="color:#000;">Loading...</div>
        </div>
        <button class="add-friend-btn" id="editUsernameBtn">Edit</button>
      </div>
      <div class="user-item-whatsapp" style="padding:8px 0;">
        <span class="material-symbols-rounded" style="color:var(--gray-mid);">mail</span>
        <div class="user-info-whatsapp">
          <div class="user-name-whatsapp">Email</div>
          <div id="profileEmail" style="color:#000;">Loading...</div>
        </div>
      </div>
      <div id="inlineEditor" style="display:none;flex-direction:column;gap:8px;margin:16px 0;">
        <input id="fieldInput" class="auth-input-whatsapp" placeholder="Enter new value"/>
        <div style="display:flex;gap:8px;">
          <button class="auth-btn-whatsapp" id="saveFieldBtn">Save</button>
          <button class="confirm-btn cancel" id="cancelEditBtn">Cancel</button>
        </div>
      </div>
      <button class="auth-btn-whatsapp" id="signOutBtn" style="margin-top:24px;">Sign out</button>
    </div>
  </div>

  <!-- FIREBASE & APP LOGIC -->
  <script type="module">
    // ===== CLOUDINARY CONFIG =====
    const CLOUD_NAME    = 'YOUR_CLOUD_NAME';       // ‚Üê change me
    const UPLOAD_PRESET = 'YOUR_UNSIGNED_PRESET';  // ‚Üê change me

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, update, set, get, query, orderByChild, limitToLast, endBefore, onDisconnect, serverTimestamp, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:32699cbc33e85f4bafa36e",
      measurementId: "G-2505EVBRWX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let activeChatId = null;
    let isPrivateChatMode = false;
    const chatListeners = new Map();
    const typingTimeouts = new Map();
    const MESSAGES_PER_LOAD = 50;
    let oldestMessageKey = null;
    let isLoadingMore = false;
    let allChatItems = [];
    let lastReadTimestamps = {};
    let lastReadListeners = new Map();
    let currentMessagesListener = null;
    let currentTypingListener = null;
    let incomingPillTimeout = null;

    // ---------- DOM SHORTCUTS ----------
    const els = {
      chatsList: document.getElementById('chatsList'),
      statusCards: document.getElementById('statusCards'),
      statusComposer: document.getElementById('statusComposer'),
      statusInput: document.getElementById('statusInput'),
      statusPostBtn: document.getElementById('statusPostBtn'),
      addStatusBtn: document.getElementById('addStatusBtn'),
      chatView: document.getElementById('chatView'),
      messagesContainer: document.getElementById('messagesContainer'),
      messageInput: document.getElementById('messageInput'),
      sendButton: document.getElementById('sendButton'),
      floatingBackBtn: document.getElementById('floatingBackBtn'),
      tabbar: document.getElementById('tabbar'),
      addFriendFab: document.getElementById('addFriendFab'),
      swipeContainer: document.getElementById('swipeContainer'),
      mainHeader: document.getElementById('mainHeader'),
      mainContent: document.querySelector('.main-content'),
      chatSearchInput: document.getElementById('chatSearchInput'),
      confirmOverlay: document.getElementById('confirmOverlay'),
      confirmTitle: document.getElementById('confirmTitle'),
      confirmMessage: document.getElementById('confirmMessage'),
      confirmCancel: document.getElementById('confirmCancel'),
      confirmOk: document.getElementById('confirmOk'),
      incomingPill: document.getElementById('incomingMessagePill'),
      pillAvatar: document.getElementById('pillAvatar'),
      pillName: document.getElementById('pillName'),
      pillText: document.getElementById('pillText'),
      communityChatView: document.getElementById('communityChatView'),
      communityMessagesContainer: document.getElementById('communityMessagesContainer'),
      communityMessageInput: document.getElementById('communityMessageInput'),
      communitySendButton: document.getElementById('communitySendButton'),
      floatingBackBtnCommunity: document.getElementById('floatingBackBtnCommunity'),
      communityUnread: document.getElementById('communityUnread'),
      communityTime: document.getElementById('communityTime'),
      communityPreview: document.getElementById('communityPreview')
    };

    // ---------- UTILS ----------
    function customConfirm(title, message) {
      return new Promise(resolve => {
        els.confirmTitle.textContent = title;
        els.confirmMessage.textContent = message;
        els.confirmOverlay.classList.add('open');
        const onCancel = () => {
          els.confirmOverlay.classList.remove('open');
          els.confirmCancel.removeEventListener('click', onCancel);
          els.confirmOk.removeEventListener('click', onConfirm);
          resolve(false);
        };
        const onConfirm = () => {
          els.confirmOverlay.classList.remove('open');
          els.confirmCancel.removeEventListener('click', onCancel);
          els.confirmOk.removeEventListener('click', onConfirm);
          resolve(true);
        };
        els.confirmCancel.addEventListener('click', onCancel);
        els.confirmOk.addEventListener('click', onConfirm);
      });
    }
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast-notification show';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    function showIncomingMessagePill(senderName, senderInitial, messageText, chatId) {
      if (isPrivateChatMode && activeChatId === chatId) return;
      els.pillName.textContent = senderName || 'Someone';
      els.pillAvatar.textContent = senderInitial || '?';
      const shortText = messageText.length > 50 ? messageText.slice(0, 47) + '‚Ä¶' : messageText;
      els.pillText.textContent = shortText;
      els.incomingPill.classList.add('show');
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      if (incomingPillTimeout) clearTimeout(incomingPillTimeout);
      incomingPillTimeout = setTimeout(() => els.incomingPill.classList.remove('show'), 4000);
      els.incomingPill.onclick = () => {
        els.incomingPill.classList.remove('show');
        if (incomingPillTimeout) clearTimeout(incomingPillTimeout);
        openPrivateChat(chatId);
      };
    }

    // ---------- TAB SWITCH ----------
    function switchTab(tabName) {
      document.querySelectorAll('.pill-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.pill-tab[data-tab="${tabName}"]`).classList.add('active');
      if (tabName === 'chats') {
        els.swipeContainer.className = 'swipe-container chat-active';
        els.addFriendFab.style.display = 'flex';
        loadFriendsChatsRealTime();
      } else if (tabName === 'status') {
        els.swipeContainer.className = 'swipe-container status-active';
        els.addFriendFab.style.display = 'none';
        loadStatusPostsRealTime();
      } else {
        els.swipeContainer.className = 'swipe-container comm-active';
        els.addFriendFab.style.display = 'none';
        loadCommunityPreview();
      }
    }
    document.querySelectorAll('.pill-tab').forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
    els.addFriendFab.addEventListener('click', openUsersSheet);
    els.floatingBackBtn.addEventListener('click', () => {
      if (window.matchMedia('(min-width: 768px)').matches) closeChatView();
    });
    els.floatingBackBtnCommunity.addEventListener('click', () => {
      if (window.matchMedia('(min-width: 768px)').matches) closeCommunityChatView();
    });

    // ---------- SWIPE ----------
    let touchStartX = 0, touchEndX = 0;
    const swipeThreshold = 50;
    if (window.matchMedia('(max-width: 767px)').matches) {
      els.mainContent.addEventListener('touchstart', e => {
        if (isPrivateChatMode || isCommunityChatMode) return;
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });
      els.mainContent.addEventListener('touchend', e => {
        if (isPrivateChatMode || isCommunityChatMode) return;
        touchEndX = e.changedTouches[0].screenX;
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > swipeThreshold) {
          const tabs = ['chats', 'status', 'comm'];
          const active = document.querySelector('.pill-tab.active').dataset.tab;
          const idx = tabs.indexOf(active);
          const next = deltaX > 0 ? (idx - 1 + 3) % 3 : (idx + 1) % 3;
          switchTab(tabs[next]);
        }
      }, { passive: true });
    }

    // ---------- COMMUNITY CHAT ----------
    let isCommunityChatMode = false;
    let communityMessagesListener = null;
    let communityTypingListener = null;
    let communityLastRead = 0;

    async function loadCommunityPreview() {
      if (!currentUser) return;
      const lastReadRef = ref(db, `users/${currentUser.uid}/lastRead/community`);
      const lastReadSnap = await get(lastReadRef);
      communityLastRead = lastReadSnap.val() || 0;

      const msgRef = ref(db, 'communityMessages');
      const latestSnap = await get(query(msgRef, orderByChild('createdAt'), limitToLast(1)));
      let text = 'Tap to join the conversation';
      let time = '';
      let unread = 0;
      latestSnap.forEach(child => {
        const msg = child.val();
        if (msg.createdAt > communityLastRead && msg.userId !== currentUser.uid) unread++;
        text = msg.text ? (msg.text.length > 30 ? msg.text.slice(0, 27) + '‚Ä¶' : msg.text) : 'üì∑ Image';
        const t = new Date(msg.createdAt);
        const now = Date.now();
        const mins = Math.floor((now - t) / 60000);
        const hrs  = Math.floor((now - t) / 3600000);
        const days = Math.floor((now - t) / 86400000);
        time = mins < 1 ? 'now' : mins < 60 ? `${mins}m` : hrs < 24 ? `${hrs}h` : days < 7 ? `${days}d` : t.toLocaleDateString();
      });
      els.communityPreview.textContent = text;
      els.communityTime.textContent = time;
      els.communityUnread.style.display = unread ? 'flex' : 'none';
      els.communityUnread.textContent = unread > 99 ? '99+' : unread;
    }

    document.querySelector('.community-item').addEventListener('click', openCommunityChat);

    function openCommunityChat() {
      els.mainHeader.classList.add('hidden');
      els.tabbar.classList.add('hidden');
      els.addFriendFab.classList.add('hidden');
      els.communityChatView.classList.add('active');
      isCommunityChatMode = true;
      if (!window.matchMedia('(min-width: 768px)').matches) history.pushState({ communityOpen: true }, '', '#community');

      // mark all as read
      const lastMsgRef = query(ref(db, 'communityMessages'), orderByChild('createdAt'), limitToLast(1));
      get(lastMsgRef).then(snap => {
        snap.forEach(child => {
          const ts = child.val().createdAt;
          if (ts > communityLastRead) {
            communityLastRead = ts;
            set(ref(db, `users/${currentUser.uid}/lastRead/community`), ts);
          }
        });
      });
      els.communityUnread.style.display = 'none';

      // real-time messages
      if (communityMessagesListener) communityMessagesListener();
      const q = query(ref(db, 'communityMessages'), orderByChild('createdAt'));
      communityMessagesListener = onValue(q, snap => {
        els.communityMessagesContainer.innerHTML = '';
        snap.forEach(child => {
          const msg = child.val();
          const bubble = createMessageBubble(msg, child.key, true);
          els.communityMessagesContainer.appendChild(bubble);
        });
        scrollToBottomCommunity();
      });

      // typing indicator
      if (communityTypingListener) communityTypingListener();
      communityTypingListener = onValue(ref(db, 'communityTyping'), snap => {
        let typing = false;
        snap.forEach(child => { if (child.key !== currentUser.uid) typing = true; });
        els.communityPreview.textContent = typing ? 'Someone is typing...' : 'Tap to join the conversation';
      });

      els.communityMessageInput.addEventListener('input', handleCommunityTyping);
      els.communitySendButton.addEventListener('click', sendCommunityMessage);
      els.communityMessageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendCommunityMessage();
        }
      });
      document.getElementById('communityAttachBtn').addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async e => {
          const file = e.target.files[0];
          if (!file) return;
          const url = await uploadImage(file);
          if (url) sendCommunityMessage(url);
        };
        input.click();
      });
    }

    function closeCommunityChatView() {
      els.mainHeader.classList.remove('hidden');
      els.tabbar.classList.remove('hidden');
      els.addFriendFab.classList.remove('hidden');
      els.communityChatView.classList.remove('active');
      isCommunityChatMode = false;
      if (communityMessagesListener) { communityMessagesListener(); communityMessagesListener = null; }
      if (communityTypingListener) { communityTypingListener(); communityTypingListener = null; }
      stopCommunityTypingIndicator();
      els.communityMessageInput.removeEventListener('input', handleCommunityTyping);
      els.communitySendButton.removeEventListener('click', sendCommunityMessage);
    }

    async function uploadImage(file) {
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', UPLOAD_PRESET);
      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error.message);
        return data.secure_url;
      } catch (e) {
        showToast('Image upload failed: ' + e.message);
        return null;
      }
    }

    async function sendCommunityMessage(imageUrl = null) {
      const text = els.communityMessageInput.value.trim();
      if (!text && !imageUrl) return;
      if (imageUrl) els.communityMessageInput.value = '';
      els.communityMessageInput.value = '';
      els.communityMessageInput.style.height = 'auto';
      await push(ref(db, 'communityMessages'), {
        text: text || '',
        imageUrl: imageUrl || null,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anonymous',
        createdAt: Date.now()
      });
      scrollToBottomCommunity();
      stopCommunityTypingIndicator();
    }

    function scrollToBottomCommunity() {
      els.communityMessagesContainer.scrollTop = els.communityMessagesContainer.scrollHeight;
    }

    function handleCommunityTyping() {
      const refTyping = ref(db, `communityTyping/${currentUser.uid}`);
      set(refTyping, serverTimestamp());
      if (typingTimeouts.has('community')) clearTimeout(typingTimeouts.get('community'));
      typingTimeouts.set('community', setTimeout(stopCommunityTypingIndicator, 2000));
    }
    function stopCommunityTypingIndicator() {
      set(ref(db, `communityTyping/${currentUser.uid}`), null);
    }

    // ---------- CHAT VIEW ----------
    function closeChatView() {
      els.mainHeader.classList.remove('hidden');
      els.tabbar.classList.remove('hidden');
      els.addFriendFab.classList.remove('hidden');
      els.chatView.classList.remove('active');
      isPrivateChatMode = false;
      activeChatId = null;
      oldestMessageKey = null;
      isLoadingMore = false;
      els.messagesContainer.innerHTML = '';
      els.messagesContainer.removeEventListener('scroll', handleScroll);
      if (currentMessagesListener) { currentMessagesListener(); currentMessagesListener = null; }
      if (currentTypingListener) { currentTypingListener(); currentTypingListener = null; }
      if (incomingPillTimeout) { clearTimeout(incomingPillTimeout); incomingPillTimeout = null; }
      els.incomingPill.classList.remove('show');
      stopTypingIndicator();
      lastReadListeners.forEach(unsub => unsub());
      lastReadListeners.clear();
    }

    // ---------- TYPING ----------
    function startTypingIndicator() {
      if (!activeChatId || !currentUser) return;
      set(ref(db, `privateChats/${activeChatId}/typing/${currentUser.uid}`), serverTimestamp());
    }
    function stopTypingIndicator() {
      if (!activeChatId || !currentUser) return;
      set(ref(db, `privateChats/${activeChatId}/typing/${currentUser.uid}`), null);
    }

    // ---------- OPEN PRIVATE CHAT ----------
    async function openPrivateChat(chatId) {
      els.mainHeader.classList.add('hidden');
      els.tabbar.classList.add('hidden');
      els.addFriendFab.classList.add('hidden');
      els.chatView.classList.add('active');
      isPrivateChatMode = true;
      activeChatId = chatId;
      oldestMessageKey = null;
      isLoadingMore = false;
      els.messagesContainer.innerHTML = '';
      if (!window.matchMedia('(min-width: 768px)').matches) history.pushState({ chatOpen: true }, '', '#chat');

      const lastReadRef = ref(db, `users/${currentUser.uid}/lastRead/${chatId}`);
      const lastReadSnap = await get(lastReadRef);
      let lastRead = lastReadSnap.val() || 0;
      const latestSnap = await get(query(ref(db, `privateChats/${chatId}/messages`), orderByChild('createdAt'), limitToLast(1)));
      latestSnap.forEach(child => {
        const ts = child.val().createdAt;
        if (ts > lastRead) lastRead = ts;
      });
      lastReadTimestamps[chatId] = lastRead;
      await set(lastReadRef, lastRead);
      updateUnreadCount(chatId, 0);
      loadMoreMessages();

      if (currentMessagesListener) currentMessagesListener();
      currentMessagesListener = onValue(query(ref(db, `privateChats/${activeChatId}/messages`), orderByChild('createdAt')), snap => {
        let hasNew = false;
        snap.forEach(child => {
          const msg = child.val();
          if (!document.getElementById(child.key)) {
            appendWhatsAppMessage(msg, child.key);
            hasNew = true;
            if (msg.createdAt > (lastReadTimestamps[chatId] || 0)) {
              lastReadTimestamps[chatId] = msg.createdAt;
              set(ref(db, `users/${currentUser.uid}/lastRead/${chatId}`), msg.createdAt);
            }
            if (msg.userId !== currentUser.uid) {
              const card = document.querySelector(`[data-chat-id="${chatId}"]`);
              const name = msg.userName || card?.querySelector('.chat-name-whatsapp')?.textContent || 'Someone';
              const initial = card?.querySelector('.whatsapp-avatar')?.textContent || name.charAt(0).toUpperCase();
              showIncomingMessagePill(name, initial, msg.text, chatId);
            }
          }
        });
        if (hasNew) scrollToBottom();
        updateUnreadCount(chatId, 0);
      });

      if (currentTypingListener) currentTypingListener();
      currentTypingListener = onValue(ref(db, `privateChats/${activeChatId}/typing`), snap => {
        const previewEl = document.getElementById(`preview-${chatId}`);
        if (!previewEl) return;
        let typing = false;
        snap.forEach(child => { if (child.key !== currentUser.uid) typing = true; });
        previewEl.textContent = typing ? 'typing...' : (previewEl.dataset.lastText || 'Tap to start chatting');
        previewEl.classList.toggle('typing-indicator', typing);
      });

      els.messagesContainer.addEventListener('scroll', handleScroll);
      els.messageInput.addEventListener('input', handleTypingInput);
    }

    function handleScroll() {
      if (els.messagesContainer.scrollTop < 100 && !isLoadingMore && oldestMessageKey) loadMoreMessages();
    }
    function handleTypingInput() {
      startTypingIndicator();
      if (typingTimeouts.has(activeChatId)) clearTimeout(typingTimeouts.get(activeChatId));
      typingTimeouts.set(activeChatId, setTimeout(stopTypingIndicator, 2000));
    }

    // ---------- SEND MESSAGE ----------
    els.sendButton.addEventListener('click', () => { sendMessage(); stopTypingIndicator(); });
    async function sendMessage() {
      const text = els.messageInput.value.trim();
      if (!text || !currentUser || !activeChatId) return;
      els.messageInput.value = '';
      els.messageInput.style.height = 'auto';
      await push(ref(db, `privateChats/${activeChatId}/messages`), {
        text, userId: currentUser.uid, userName: currentUser.displayName || 'Anon', createdAt: Date.now()
      });
      scrollToBottom();
      stopTypingIndicator();
    }

    // ---------- DELETE CHAT ----------
    async function deleteChat(chatId, friendUid) {
      const ok = await customConfirm('Clear Chat', 'This will clear the chat history but keep the contact. Continue?');
      if (!ok) return;
      await remove(ref(db, `privateChats/${chatId}/messages`));
      const previewEl = document.getElementById(`preview-${chatId}`);
      const timeEl = document.getElementById(`time-${chatId}`);
      if (previewEl) { previewEl.textContent = 'Tap to start chatting'; previewEl.classList.remove('typing-indicator'); }
      if (timeEl) timeEl.textContent = '';
      updateUnreadCount(chatId, 0);
      lastReadTimestamps[chatId] = Date.now();
      showToast('Chat cleared');
    }

    // ---------- UNREAD ----------
    function updateUnreadCount(chatId, count) {
      let unreadEl = document.getElementById(`unread-${chatId}`);
      if (count > 0) {
        if (!unreadEl) {
          unreadEl = document.createElement('div');
          unreadEl.id = `unread-${chatId}`;
          unreadEl.className = 'unread-count';
          document.querySelector(`[data-chat-id="${chatId}"]`)?.appendChild(unreadEl);
        }
        unreadEl.textContent = count > 99 ? '99+' : count;
        unreadEl.style.display = 'flex';
      } else if (unreadEl) unreadEl.style.display = 'none';
    }

    // ---------- LOADING ----------
    function showLoadingShimmer() {
      els.chatsList.innerHTML = '';
      for (let i = 0; i < 8; i++) {
        const p = document.createElement('div');
        p.className = 'loading-placeholder shimmer';
        p.innerHTML = `<div class="loading-avatar shimmer"></div><div class="loading-lines"><div class="loading-line shimmer"></div><div class="loading-line short shimmer"></div></div>`;
        els.chatsList.appendChild(p);
      }
    }

    // ---------- LOAD FRIENDS / CHATS ----------
    async function loadFriendsChatsRealTime() {
      if (!currentUser) return;
      showLoadingShimmer();
      onValue(ref(db, `users/${currentUser.uid}`), async snap => {
        if (!snap.exists()) return;
        els.chatsList.innerHTML = '';
        allChatItems = [];
        const friends = [...new Set(snap.val().friends || [])];
        if (friends.length === 0) {
          els.chatsList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--gray-mid);"><span class="material-symbols-rounded" style="font-size:48px;">group_add</span><p>No friends yet</p><p style="font-size:14px;margin-top:8px;">Tap the + button to add friends</p></div>`;
          return;
        }
        for (const friendUid of friends) {
          const friendSnap = await get(ref(db, `users/${friendUid}`));
          if (!friendSnap.exists()) continue;
          const friend = friendSnap.val();
          const chatId = [currentUser.uid, friendUid].sort().join('_');
          if (document.getElementById(`friend-card-${friendUid}`)) continue;
          const item = document.createElement('div');
          item.className = 'chat-item-whatsapp';
          item.id = `friend-card-${friendUid}`;
          item.dataset.name = (friend.displayName || '').toLowerCase();
          item.dataset.chatId = chatId;
          const verifiedBadge = friend.verified ? '<span class="verified-badge">‚úì</span>' : '';
          const initial = friend.displayName ? friend.displayName.charAt(0).toUpperCase() : '?';
          const onlineClass = friend.online ? 'online' : '';
          item.innerHTML = `
            <div class="whatsapp-avatar ${onlineClass}">${initial}</div>
            <div class="chat-info-whatsapp">
              <div class="chat-header-row">
                <div class="chat-name-wrapper">
                  <div class="chat-name-whatsapp">${friend.displayName || 'Anonymous'}</div>
                  ${verifiedBadge}
                </div>
                <div class="chat-time-whatsapp" id="time-${chatId}"></div>
              </div>
              <div class="chat-preview-whatsapp" id="preview-${chatId}">Tap to start chatting</div>
            </div>
            <button class="delete-chat-btn" title="Clear chat"><span class="material-symbols-rounded" style="font-size:20px;">delete</span></button>
          `;
          item.addEventListener('click', e => {
            if (e.target.closest('.delete-chat-btn')) return;
            openPrivateChat(chatId);
          });
          item.querySelector('.delete-chat-btn').addEventListener('click', e => {
            e.stopPropagation();
            deleteChat(chatId, friendUid);
          });
          els.chatsList.appendChild(item);
          allChatItems.push(item);

          // messages listener
          const unsubscribe = onValue(query(ref(db, `privateChats/${chatId}/messages`), orderByChild('createdAt')), async snap => {
            const previewEl = document.getElementById(`preview-${chatId}`);
            const timeEl = document.getElementById(`time-${chatId}`);
            if (!previewEl || !timeEl) return;
            let unread = 0, lastTs = 0, lastText = 'Tap to start chatting';
            if (!lastReadListeners.has(chatId)) {
              const unsub = onValue(ref(db, `users/${currentUser.uid}/lastRead/${chatId}`), s => { if (s.val()) lastReadTimestamps[chatId] = s.val(); });
              lastReadListeners.set(chatId, unsub);
            }
            const currentLastRead = lastReadTimestamps[chatId] || 0;
            snap.forEach(child => {
              const msg = child.val();
              if (msg.createdAt > currentLastRead && msg.userId !== currentUser.uid) unread++;
              if (msg.createdAt > lastTs) {
                lastTs = msg.createdAt;
                const isOwn = msg.userId === currentUser.uid;
                const short = msg.text.length > 30 ? msg.text.slice(0, 27) + '‚Ä¶' : msg.text;
                lastText = isOwn ? `You: ${short}` : short;
              }
              if (msg.userId !== currentUser.uid && msg.createdAt > currentLastRead && !(isPrivateChatMode && activeChatId === chatId)) {
                const name = friend.displayName || 'Someone';
                const initial = friend.displayName ? friend.displayName.charAt(0).toUpperCase() : '?';
                showIncomingMessagePill(name, initial, msg.text, chatId);
              }
            });
            previewEl.textContent = lastText;
            previewEl.classList.remove('typing-indicator');
            if (lastTs > 0) {
              const t = new Date(lastTs);
              const now = Date.now();
              const mins = Math.floor((now - t) / 60000);
              const hrs  = Math.floor((now - t) / 3600000);
              const days = Math.floor((now - t) / 86400000);
              timeEl.textContent = mins < 1 ? 'now' : mins < 60 ? `${mins}m` : hrs < 24 ? `${hrs}h` : days < 7 ? `${days}d` : t.toLocaleDateString();
            } else timeEl.textContent = '';
            updateUnreadCount(chatId, unread);
            if (lastTs > (item.dataset.lastTs || 0)) {
              item.dataset.lastTs = lastTs;
              if (item.parentElement) els.chatsList.prepend(item);
            }
          });
          onValue(ref(db, `users/${friendUid}/online`), snap => {
            const avatar = item.querySelector('.whatsapp-avatar');
            if (snap.val() === true) avatar.classList.add('online'); else avatar.classList.remove('online');
          });
          chatListeners.set(chatId, unsubscribe);
        }
      });
    }
    els.chatSearchInput.addEventListener('input', () => {
      const q = els.chatSearchInput.value.toLowerCase().trim();
      allChatItems.forEach(item => {
        const name = item.dataset.name || '';
        item.style.display = name.includes(q) ? 'flex' : 'none';
      });
    });

    // ---------- STATUS ----------
    function loadStatusPostsRealTime() {
      const q = query(ref(db, 'statusPosts'), orderByChild('createdAt'));
      onValue(q, snap => {
        els.statusCards.innerHTML = '';
        if (snap.size === 0) {
          els.statusCards.innerHTML = `<div style="text-align:center;padding:40px;color:var(--gray-mid);"><span class="material-symbols-rounded" style="font-size:48px;">post_add</span><p>No status updates yet</p><p style="font-size:14px;margin-top:8px;">Be the first to share your thoughts!</p></div>`;
          return;
        }
        const posts = [];
        snap.forEach(child => posts.unshift({ id: child.key, ...child.val() }));
        posts.forEach(post => {
          const isOwn = post.userId === currentUser?.uid;
          const isLiked = post.likes?.includes(currentUser?.uid);
          const likeCount = post.likes?.length || 0;
          const initial = (post.userName || 'Anonymous').charAt(0).toUpperCase();
          const t = new Date(post.createdAt);
          const now = Date.now();
          const mins = Math.floor((now - t) / 60000);
          const hrs  = Math.floor((now - t) / 3600000);
          const days = Math.floor((now - t) / 86400000);
          const timeAgo = mins < 1 ? 'just now' : mins < 60 ? `${mins}m ago` : hrs < 24 ? `${hrs}h ago` : days < 7 ? `${days}d ago` : t.toLocaleDateString();
          const imageTag = post.imageUrl ? `<img src="${post.imageUrl}" style="width:100%;border-radius:12px;margin-top:8px;" alt="Status image"/>` : '';
          const card = document.createElement('div');
          card.className = 'status-card';
          card.innerHTML = `
            <div class="status-card-header">
              <div class="status-avatar">${initial}</div>
              <div style="flex:1;">
                <div class="status-author">${escapeHtml(post.userName || 'Anonymous')}</div>
                <div class="status-time">${timeAgo}</div>
              </div>
              ${isOwn ? `<button class="status-action delete-status-btn" data-id="${post.id}" title="Delete status"><span class="material-symbols-rounded" style="font-size:18px;color:#ff3b30;">delete</span></button>` : ''}
            </div>
            <div class="status-content">${escapeHtml(post.content)}</div>
            ${imageTag}
            <div class="status-actions">
              <div class="status-action" onclick="likeStatus('${post.id}')">
                <span class="material-symbols-rounded" style="font-size:18px;">${isLiked ? 'favorite' : 'favorite_border'}</span>
                <span class="like-count">${likeCount}</span>
              </div>
              <div class="status-action" onclick="commentStatus('${post.id}')"><span class="material-symbols-rounded" style="font-size:18px;">comment</span><span>Comment</span></div>
              <div class="status-action" onclick="shareStatus('${post.id}')"><span class="material-symbols-rounded" style="font-size:18px;">share</span><span>Share</span></div>
            </div>
          `;
          els.statusCards.appendChild(card);
        });
        document.querySelectorAll('.delete-status-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            e.stopPropagation();
            const id = btn.dataset.id;
            const ok = await customConfirm('Delete Status', 'This status will be permanently deleted.');
            if (ok) { await remove(ref(db, `statusPosts/${id}`)); showToast('Status deleted'); }
          });
        });
      });
    }
    window.likeStatus = async id => {
      const s = await get(ref(db, `statusPosts/${id}`));
      const likes = s.val()?.likes || [];
      if (!likes.includes(currentUser.uid)) {
        likes.push(currentUser.uid);
        await set(ref(db, `statusPosts/${id}/likes`), likes);
        showToast('Status liked!');
      }
    };
    window.commentStatus = () => showToast('Comment feature coming soon!');
    window.shareStatus   = () => showToast('Share feature coming soon!');

    // ---------- STATUS COMPOSER ----------
    els.addStatusBtn.addEventListener('click', () => els.statusComposer.classList.toggle('open'));
    els.attachImageBtn.addEventListener('click', () => els.statusImageFile.click());
    els.statusImageFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { showToast('Please select an image'); e.target.value = ''; return; }
      document.getElementById('imageName').textContent = file.name;
    });
    els.statusPostBtn.addEventListener('click', async () => {
      const text = els.statusInput.value.trim();
      const fileInput = els.statusImageFile;
      if (!text && !fileInput.files.length) return showToast('Write something or attach an image');
      let imageUrl = null;
      if (fileInput.files.length) {
        imageUrl = await uploadImage(fileInput.files[0]);
        if (!imageUrl) return;
      }
      await push(ref(db, 'statusPosts'), {
        content: text || '', imageUrl, userId: currentUser.uid,
        userName: currentUser.displayName || 'Anonymous', createdAt: Date.now(), likes: [], comments: []
      });
      els.statusInput.value = '';
      fileInput.value = '';
      document.getElementById('imageName').textContent = '';
      els.statusComposer.classList.remove('open');
      showToast('Status posted!');
    });

    // ---------- MESSAGES ----------
    async function loadMoreMessages() {
      if (isLoadingMore) return;
      isLoadingMore = true;
      const q = oldestMessageKey
        ? query(ref(db, `privateChats/${activeChatId}/messages`), orderByChild('createdAt'), endBefore(oldestMessageKey), limitToLast(MESSAGES_PER_LOAD))
        : query(ref(db, `privateChats/${activeChatId}/messages`), orderByChild('createdAt'), limitToLast(MESSAGES_PER_LOAD));
      const snap = await get(q);
      if (snap.size === 0) { isLoadingMore = false; return; }
      const msgs = [];
      snap.forEach(child => { msgs.unshift({ key: child.key, data: child.val() }); oldestMessageKey = child.val().createdAt; });
      const fragment = document.createDocumentFragment();
      msgs.forEach(({ key, data }) => fragment.appendChild(createMessageBubble(data, key)));
      const hBefore = els.messagesContainer.scrollHeight;
      els.messagesContainer.prepend(fragment);
      els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight - hBefore;
      isLoadingMore = false;
    }
    function createMessageBubble(data, key, isCommunity = false) {
      const isOwn = data.userId === currentUser.uid;
      const time = new Date(data.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const bubble = document.createElement('div');
      bubble.className = `whatsapp-bubble ${isOwn ? 'own' : 'other'}`;
      bubble.id = key;
      let content = escapeHtml(data.text || '');
      if (data.imageUrl) content += `<br><img src="${data.imageUrl}" style="width:100%;border-radius:8px;margin-top:4px;" alt="Image"/>`;
      bubble.innerHTML = `${content}<div class="bubble-time">${time}</div>`;
      return bubble;
    }
    function appendWhatsAppMessage(data, key) {
      els.messagesContainer.appendChild(createMessageBubble(data, key));
    }
    function scrollToBottom() {
      els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight;
    }
    els.messageInput.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    els.messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ---------- ADD FRIEND ----------
    async function openUsersSheet() {
      const sheet = document.createElement('div');
      sheet.className = 'users-sheet open';
      sheet.innerHTML = `
        <div class="users-box">
          <div class="users-header">
            <h2 class="users-title">Add Friends</h2>
            <button class="close-sheet-btn" onclick="this.closest('.users-sheet').remove()"><span class="material-symbols-rounded">close</span></button>
          </div>
          <div class="users-list"><div style="text-align:center;padding:40px;"><span class="material-symbols-rounded" style="font-size:48px;color:var(--gray-mid);">hourglass_empty</span><p>Loading users...</p></div></div>
        </div>
      `;
      document.body.appendChild(sheet);
      const usersList = sheet.querySelector('.users-list');
      const mySnap = await get(ref(db, `users/${currentUser.uid}`));
      const myFriends = mySnap.val()?.friends || [];
      const usersSnap = await get(ref(db, 'users'));
      usersList.innerHTML = '';
      usersSnap.forEach(child => {
        if (child.key === currentUser.uid) return;
        const user = child.val();
        const isFriend = myFriends.includes(child.key);
        const verifiedBadge = user.verified ? '<span class="verified-badge">‚úì</span>' : '';
        const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : '?';
        const onlineClass = user.online ? 'online' : '';
        const item = document.createElement('div');
        item.className = 'user-item-whatsapp';
        item.innerHTML = `
          <div class="user-avatar-whatsapp ${onlineClass}">${initial}</div>
          <div class="user-info-whatsapp">
            <div class="user-name-wrapper">
              <div class="user-name-whatsapp">${user.displayName || 'Anonymous'}</div>
              ${verifiedBadge}
            </div>
            <div class="user-email-whatsapp">${user.email || 'No email'}</div>
          </div>
          <button class="add-friend-btn ${isFriend ? 'added' : ''}" ${isFriend ? 'disabled' : ''}>${isFriend ? 'Added' : 'Add Friend'}</button>
        `;
        if (!isFriend) item.querySelector('.add-friend-btn').addEventListener('click', async e => await addFriend(child.key, e.target));
        usersList.appendChild(item);
      });
      if (usersList.children.length === 0) usersList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--gray-mid);"><span class="material-symbols-rounded" style="font-size:48px;">group</span><p>No other users found</p><p style="font-size:14px;margin-top:8px;">Invite friends to join!</p></div>`;
    }
    async function addFriend(friendUid, btn) {
      if (friendUid === currentUser.uid) return;
      const myRef = ref(db, `users/${currentUser.uid}/friends`);
      const frRef = ref(db, `users/${friendUid}/friends`);
      const myFriends = (await get(myRef)).val() || [];
      if (!myFriends.includes(friendUid)) await set(myRef, [...myFriends, friendUid]);
      const frFriends = (await get(frRef)).val() || [];
      if (!frFriends.includes(currentUser.uid)) await set(frRef, [...frFriends, currentUser.uid]);
      btn.textContent = 'Added';
      btn.classList.add('added');
      btn.disabled = true;
      showToast('Friend added successfully!');
      loadFriendsChatsRealTime();
    }

    // ---------- AUTH ----------
    let isSignUp = false;
    document.getElementById('authSwitchBtn').addEventListener('click', () => {
      isSignUp = !isSignUp;
      document.getElementById('authBtn').textContent = isSignUp ? 'Sign Up' : 'Sign In';
      document.getElementById('authSwitchBtn').textContent = isSignUp ? 'Sign In' : 'Sign Up';
      document.querySelector('.auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome to Vynix Lingua';
    });
    document.getElementById('authBtn').addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if (!email || !pass) return showToast('Please fill in all fields');
      try {
        let cred;
        if (isSignUp) {
          cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: email.split('@')[0] });
          await set(ref(db, `users/${cred.user.uid}`), {
            displayName: cred.user.displayName || email.split('@')[0], email, username: email.split('@')[0],
            lastSeen: Date.now(), online: true, verified: false, friends: []
          });
          showToast('Account created successfully!');
        } else {
          cred = await signInWithEmailAndPassword(auth, email, pass);
          await update(ref(db, `users/${cred.user.uid}`), { online: true, lastSeen: Date.now() });
          showToast('Welcome back!');
        }
        document.getElementById('authOverlay').classList.remove('open');
      } catch (e) {
        showToast(e.message || 'Authentication failed');
      }
    });
    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (!user) {
        document.getElementById('authOverlay').classList.add('open');
      } else {
        await update(ref(db, `users/${user.uid}`), { online: true });
        onDisconnect(ref(db, `users/${user.uid}/online`)).set(false);
        switchTab('chats');
        startHeartbeat();
      }
    });
    function startHeartbeat() {
      const update = () => currentUser && set(ref(db, `users/${currentUser.uid}/lastSeen`), Date.now());
      update();
      setInterval(update, 60000);
    }

    // ---------- PROFILE ----------
    let editingField = null;
    document.getElementById('openProfileBtn').addEventListener('click', async () => {
      if (!currentUser) return;
      document.getElementById('profileName').textContent = currentUser.displayName || 'Anonymous';
      document.getElementById('profileEmail').textContent = currentUser.email || 'No email';
      document.getElementById('profileAvatar').textContent = (currentUser.displayName || '?').charAt(0).toUpperCase();
      const userSnap = await get(ref(db, `users/${currentUser.uid}`));
      const userData = userSnap.val() || {};
      document.getElementById('profileUsername').textContent = userData.username || 'Not set';
      document.getElementById('profileVerified').style.display = userData.verified ? 'inline-flex' : 'none';
      document.getElementById('profileSheet').classList.add('open');
      document.body.classList.add('sheet-open');
    });
    document.querySelector('#profileSheet .close-sheet-btn').addEventListener('click', () => {
      document.getElementById('profileSheet').classList.remove('open');
      document.body.classList.remove('sheet-open');
    });
    document.getElementById('editDisplayNameBtn').addEventListener('click', () => startEdit('displayName'));
    document.getElementById('editUsernameBtn').addEventListener('click', () => startEdit('username'));
    function startEdit(field) {
      editingField = field;
      const current = field === 'displayName'
        ? currentUser.displayName || ''
        : document.getElementById('profileUsername').textContent === 'Not set' ? '' : document.getElementById('profileUsername').textContent;
      document.getElementById('fieldInput').value = current;
      document.getElementById('fieldInput').placeholder = field === 'displayName' ? 'New display name' : 'New username';
      document.getElementById('inlineEditor').style.display = 'flex';
      document.getElementById('fieldInput').focus();
    }
    document.getElementById('cancelEditBtn').addEventListener('click', () => {
      editingField = null;
      document.getElementById('inlineEditor').style.display = 'none';
    });
    document.getElementById('saveFieldBtn').addEventListener('click', saveEdit);
    async function saveEdit() {
      const val = document.getElementById('fieldInput').value.trim();
      if (!val) return showToast('Cannot be empty');
      try {
        if (editingField === 'displayName') {
          await updateProfile(currentUser, { displayName: val });
          await set(ref(db, `users/${currentUser.uid}/displayName`), val);
          document.getElementById('profileName').textContent = val;
          document.getElementById('profileAvatar').textContent = val.charAt(0).toUpperCase();
        } else {
          await set(ref(db, `users/${currentUser.uid}/username`), val);
          document.getElementById('profileUsername').textContent = val;
        }
        showToast('Profile updated!');
      } catch (err) {
        showToast('Update failed: ' + err.message);
      }
      editingField = null;
      document.getElementById('inlineEditor').style.display = 'none';
    }
    document.getElementById('signOutBtn').addEventListener('click', async () => {
      document.getElementById('profileSheet').classList.remove('open');
      document.body.classList.remove('sheet-open');
      await auth.signOut();
      showToast('Signed out');
    });

    // ---------- SHEET NAV HIDE ----------
    function syncNavVisibility() {
      const anyOpen = [...document.querySelectorAll('.users-sheet, .auth-overlay, .confirm-overlay')].some(s => s.classList.contains('open'));
      document.body.classList.toggle('sheet-open', anyOpen);
    }
    const sheetObserver = new MutationObserver(syncNavVisibility);
    sheetObserver.observe(document.body, { childList: true, subtree: true, attributeFilter: ['class'] });
    syncNavVisibility();

    // ---------- INITIAL ----------
    switchTab('chats');
  </script>
</body>
</html>
