<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Lingua Messenger</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXggTGluZ3VhIiwic2hvcnRfbmFtZSI6IlZ5bml4Iiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmMGY0ZjgiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9mb250cy5nb29nbGVhcGlzLmNvbS9pY29uP2ZhbWlseT1NYXRlcmlhbCtTeW1ib2xzK1JvdW5kIiwic2l6ZXMiOiI3MiJ9XX0=">
  <meta name="theme-color" content="#2563eb">

  <style>
    :root {
      --primary: #2563eb;
      --secondary: #d946ef;
      --accent: #10b981;
      --gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 100%);
      --bg-body: #f0f4f8;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --bubble-own: var(--gradient);
      --bubble-other: #ffffff;
      --header-height: 65px;
      --tabbar-height: 60px;
      --input-height: 80px;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    /* shimmer background */
    #shimmerBg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background: linear-gradient(110deg, #e0e8f0 8%, #f0f4f8 18%, #e0e8f0 33%);
      background-size: 200% 100%;
      animation: shimmer 2.5s linear infinite;
    }
    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
    .app-container {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--glass-bg);
    }
    @media (min-width: 768px) {
      .app-container {
        max-width: 900px;
        margin: 0 auto;
        border-left: 1px solid rgba(255, 255, 255, 0.4);
        border-right: 1px solid rgba(255, 255, 255, 0.4);
      }
    }
    /* top nav */
    .top-navbar {
      height: var(--tabbar-height);
      background: rgba(255, 255, 255, 0.98);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-around;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      max-width: 900px;
      margin: 0 auto;
    }
    .tab-btn {
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      position: relative;
    }
    .tab-btn.active {
      color: var(--primary);
    }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
      border-radius: 3px 3px 0 0;
    }
    .tab-icon {
      font-size: 24px;
    }
    /* views */
    .main-view {
      flex: 1;
      overflow: hidden;
      display: none;
      padding-top: var(--tabbar-height);
      padding-bottom: calc(var(--input-height) + 20px);
    }
    .main-view.active {
      display: flex;
      flex-direction: column;
    }
    /* chat header */
    .chat-header {
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: rgba(255, 255, 255, 0.98);
      height: var(--header-height);
      z-index: 40;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .back-btn {
      cursor: pointer;
      font-size: 24px;
      color: var(--primary);
    }
    .brand-title {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 16px;
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 500;
    }
    .online-count {
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .dot {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
    }
    .typing-indicator {
      color: var(--primary);
      height: 14px;
      overflow: hidden;
      display: none;
      align-items: center;
      gap: 4px;
    }
    .typing-indicator.active {
      display: flex;
    }
    .typing-dots span {
      width: 3px;
      height: 3px;
      background: currentColor;
      border-radius: 50%;
      display: inline-block;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }
    .typing-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }
    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
      }
      40% {
        transform: scale(1);
      }
    }
    /* messages */
    .messages-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      scroll-behavior: smooth;
    }
    .msg-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 24px;
      position: relative;
    }
    .msg-row {
      display: flex;
      gap: 8px;
      max-width: 85%;
      align-items: flex-end;
    }
    .msg-row.own {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      flex-shrink: 0;
      margin-bottom: 4px;
    }
    .bubble-container {
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .sender-name {
      font-size: 10px;
      color: var(--text-muted);
      margin: 0 0 4px 4px;
      font-weight: 600;
      opacity: 0.8;
    }
    .msg-row.own .sender-name {
      display: none;
    }
    .bubble {
      padding: 10px 14px;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }
    .msg-row:not(.own) .bubble {
      background: var(--bubble-other);
      color: var(--text-main);
      border-radius: 4px 16px 16px 16px;
    }
    .msg-row.own .bubble {
      background: var(--bubble-own);
      color: white;
      border-radius: 16px 16px 4px 16px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    .meta-row {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }
    .timestamp {
      font-size: 9px;
      opacity: 0.7;
    }
    .reaction-pill {
      position: absolute;
      bottom: -14px;
      right: 0;
      background: #fff;
      border-radius: 12px;
      padding: 2px 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      border: 1px solid #f1f5f9;
      font-size: 11px;
      display: none;
      gap: 2px;
      align-items: center;
      z-index: 5;
      color: #333;
    }
    .msg-row.own .reaction-pill {
      right: auto;
      left: 0;
    }
    .reaction-pill.has-reactions {
      display: flex;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    /* chats list */
    .chats-list {
      flex: 1;
      overflow-y: auto;
      padding-top: 20px;
    }
    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      position: relative;
    }
    .chat-item:hover {
      background: rgba(0, 0, 0, 0.03);
    }
    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .chat-info {
      flex: 1;
      margin-left: 12px;
    }
    .chat-name {
      font-weight: 600;
    }
    .chat-preview {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    .chat-time {
      font-size: 11px;
      color: var(--text-muted);
      position: absolute;
      top: 12px;
      right: 20px;
    }
    .unread-count {
      background: var(--primary);
      color: white;
      font-size: 11px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      bottom: 12px;
      right: 20px;
    }
    /* input zone */
    .input-zone {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--input-height);
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      z-index: 60;
      display: flex;
      align-items: center;
      max-width: 900px;
      margin: 0 auto;
    }
    .input-wrapper {
      width: 100%;
      background: #f1f5f9;
      border-radius: 24px;
      padding: 6px 6px 6px 16px;
      display: flex;
      align-items: center;
      border: 1px solid transparent;
    }
    .input-wrapper:focus-within {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .chat-input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 10px 0;
      font-size: 15px;
      outline: none;
    }
    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .send-btn.active {
      background: var(--gradient);
      color: white;
      transform: rotate(-45deg);
      transition: 0.2s;
    }
    /* floating action buttons */
    .fab {
      position: fixed;
      bottom: calc(var(--input-height) + 20px);
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      z-index: 70;
      font-size: 24px;
    }
    /* bottom sheets */
    .users-sheet, .status-sheet, .guest-bottom-sheet {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 300;
      display: none;
      align-items: flex-end;
    }
    .users-sheet.open, .status-sheet.open, .guest-bottom-sheet.open {
      display: flex;
    }
    .users-box, .status-box, .guest-box {
      background: #fff;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 24px;
      animation: slideUp 0.3s;
      max-height: 80vh;
      overflow-y: auto;
    }
    @media (min-width: 768px) {
      .users-sheet, .status-sheet, .guest-bottom-sheet {
        align-items: center;
        justify-content: center;
      }
      .users-box, .status-box, .guest-box {
        width: 380px;
        border-radius: 20px;
      }
    }
    .user-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .user-name {
      flex: 1;
      margin-left: 12px;
      font-weight: 500;
    }
    .add-btn {
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
    .add-btn.added {
      background: #ccc;
      cursor: default;
    }
    /* status cards */
    .status-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .status-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    .status-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .status-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }
    .status-meta {
      flex: 1;
    }
    .status-name {
      font-weight: 600;
      font-size: 15px;
    }
    .status-time {
      font-size: 12px;
      color: var(--text-muted);
    }
    .status-text {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 12px;
    }
    .status-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .like-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      background: transparent;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .like-btn.liked {
      background: #fee2e2;
      border-color: #f87171;
      color: #ef4444;
    }
    /* toast / reaction / auth */
    .toast-notification {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.95);
      color: white;
      padding: 12px 20px;
      border-radius: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 500;
      transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      backdrop-filter: blur(10px);
      min-width: 280px;
    }
    .toast-notification.show {
      top: 20px;
    }
    .toast-avatar {
      width: 24px;
      height: 24px;
      background: var(--secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .reaction-menu {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(2px);
    }
    .reaction-menu.open {
      display: flex;
      animation: fadeIn 0.2s;
    }
    .reaction-bar {
      background: #fff;
      padding: 8px;
      border-radius: 50px;
      display: flex;
      gap: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .reaction-emoji {
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
      padding: 4px;
    }
    .reaction-emoji:hover {
      transform: scale(1.3) translateY(-5px);
    }
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 300;
      display: none;
      align-items: flex-end;
    }
    .auth-overlay.open {
      display: flex;
    }
    .auth-box {
      background: #fff;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 24px;
      animation: slideUp 0.3s;
    }
    @media (min-width: 768px) {
      .auth-overlay {
        align-items: center;
        justify-content: center;
      }
      .auth-box {
        width: 380px;
        border-radius: 20px;
      }
    }
    .auth-btn {
      width: 100%;
      padding: 12px;
      background: var(--gradient);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      margin-top: 10px;
    }
    .auth-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-bottom: 10px;
      outline: none;
    }
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    @keyframes popUp {
      from {
        transform: scale(0.8) translateY(20px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    @keyframes popIn {
      from {
        transform: scale(0);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- shimmer background -->
  <div id="shimmerBg"></div>

  <!-- toast -->
  <div class="toast-notification" id="toast">
    <div class="toast-avatar" id="toastAvatar">A</div>
    <div id="toastMessage">New Message</div>
  </div>

  <!-- app shell -->
  <div class="app-container">
    <!-- top tab bar -->
    <nav class="top-navbar">
      <div class="tab-btn active" data-tab="chats">
        <span class="material-symbols-rounded tab-icon">chat_bubble</span>
        <span>Chats</span>
      </div>
      <div class="tab-btn" data-tab="community">
        <span class="material-symbols-rounded tab-icon">group</span>
        <span>Community</span>
      </div>
      <div class="tab-btn" data-tab="status">
        <span class="material-symbols-rounded tab-icon">circle</span>
        <span>Status</span>
      </div>
    </nav>

    <!-- chats list view -->
    <div id="chatsView" class="main-view active">
      <div class="chats-list" id="chatsList">
        <p id="noChatsMsg" style="text-align:center; color:var(--text-muted); margin-top:50px; display:none;">No private chats yet. Add friends to start.</p>
      </div>
    </div>

    <!-- chat room view (community + private) -->
    <div id="chatView" class="main-view">
      <header class="chat-header">
        <div class="header-left">
          <span class="material-symbols-rounded back-btn" id="backBtn" style="display:none;">arrow_back</span>
          <div>
            <div class="brand-title" id="chatTitle">Vynix Secure Community</div>
            <div class="status-row" id="communityStatus">
              <div class="online-count">
                <div class="dot"></div> <span id="onlineCount">1</span> Online
              </div>
              <div class="typing-indicator" id="typingIndicator">
                <span id="typingText"></span>
                <div class="typing-dots"><span></span><span></span><span></span></div>
              </div>
            </div>
            <div id="privateStatus" style="display:none; font-size: 11px; color: var(--text-muted);"></div>
          </div>
        </div>
        <div style="font-size: 18px;" class="material-symbols-rounded" id="shieldIcon">shield</div>
      </header>
      <main class="messages-wrapper no-select" id="messagesContainer"></main>
    </div>

    <!-- status tab -->
    <div id="statusView" class="main-view">
      <div class="status-list" id="statusList"></div>
    </div>

    <!-- input zone -->
    <form autocomplete="off" onsubmit="return false">
      <div class="input-zone" id="inputZone" style="display:none;">
        <div class="input-wrapper">
          <input type="text" id="messageInput" class="chat-input" placeholder="Type a message...">
          <button id="sendButton" class="send-btn" type="button">
            <span class="material-symbols-rounded">send</span>
          </button>
        </div>
      </div>
    </form>

    <!-- FAB for friends -->
    <div class="fab" id="addFriendFab" style="display:none;">
      <span class="material-symbols-rounded">person_add</span>
    </div>

    <!-- FAB for status -->
    <div class="fab" id="addStatusFab" style="display:none;">
      <span class="material-symbols-rounded">add</span>
    </div>
  </div>

  <!-- reaction menu -->
  <div class="reaction-menu" id="reactionMenu">
    <div class="reaction-bar">
      <span class="reaction-emoji" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
      <span class="reaction-emoji" data-emoji="üòÇ">üòÇ</span>
      <span class="reaction-emoji" data-emoji="üòÆ">üòÆ</span>
      <span class="reaction-emoji" data-emoji="üò¢">üò¢</span>
      <span class="reaction-emoji" data-emoji="üò°">üò°</span>
      <span class="reaction-emoji" data-emoji="üëç">üëç</span>
    </div>
  </div>

  <!-- auth sheet -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-box">
      <h2 style="margin:0 0 20px 0; font-family:'Poppins', sans-serif;">Sign In</h2>
      <input type="email" id="authEmail" class="auth-input" placeholder="Email" autocomplete="new-email">
      <input type="password" id="authPass" class="auth-input" placeholder="Password" autocomplete="new-password">
      <button class="auth-btn" onclick="handleAuth()">Start Chatting</button>
      <button onclick="toggleAuthMode()" style="background:none; border:none; color:#666; width:100%; margin-top:10px; font-size:13px;">Create Account instead</button>
    </div>
  </div>

  <!-- email search sheet -->
  <div class="users-sheet" id="usersSheet">
    <div class="users-box">
      <h2 style="margin:0 0 20px 0; font-family:'Poppins', sans-serif;">Add Friend by Email</h2>
      <div class="search-container">
        <input type="email" id="friendEmailInput" class="search-input" placeholder="Enter friend's email address">
        <button class="search-btn" onclick="searchByEmail()">Search</button>
      </div>
      <div id="searchResult" class="search-result"></div>
    </div>
  </div>

  <!-- status create sheet -->
  <div class="status-sheet" id="statusSheet">
    <div class="status-box">
      <h2 style="margin:0 0 20px 0; font-family:'Poppins', sans-serif;">Create Status</h2>
      <textarea id="statusText" class="auth-input" rows="3" placeholder="What are you thinking?"></textarea>
      <button class="auth-btn" onclick="postStatus()">Post Status</button>
      <button onclick="closeStatusSheet()" style="background:none; border:none; color:#666; width:100%; margin-top:10px; font-size:13px;">Cancel</button>
    </div>
  </div>

  <!-- guest prompt sheet -->
  <div class="guest-bottom-sheet" id="guestBottomSheet">
    <div class="guest-box">
      <h2 class="guest-title">Join Vynix Lingua</h2>
      <p class="guest-subtitle">Sign up to add friends and start chatting</p>
      <input type="email" id="guestEmail" class="auth-input" placeholder="Your email address">
      <input type="password" id="guestPassword" class="auth-input" placeholder="Create password">
      <input type="text" id="guestName" class="auth-input" placeholder="Your name">
      <button class="auth-btn" onclick="handleGuestSignUp()">Create Account</button>
      <button onclick="closeGuestSheet()" style="background:none; border:none; color:#666; width:100%; margin-top:10px; font-size:13px;">Maybe later</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, setDoc, where, getDocs, arrayUnion, getDoc, arrayRemove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ------  E2E KEY  ------
    const COMMUNITY_KEY = "66G+aI1?Z&LxYnrFb^xv;Fg=RA%PqJb0d&C3C2Sd7K=ZF=0K5Ers5%1wBBz80RPW";

    const encrypt = (text, key) => CryptoJS.AES.encrypt(text, key).toString();
    const decrypt = (cipher, key) => {
      try {
        return CryptoJS.AES.decrypt(cipher, key).toString(CryptoJS.enc.Utf8) || '‚ö†Ô∏è Decryption failed';
      } catch (e) {
        return '‚ö†Ô∏è Encrypted';
      }
    };

    let currentUser = null;
    let activeChatId = null;
    let activeChatPartner = null;
    let selectedMessageId = null;
    let typingTimeout;
    let isInitialLoad = true;
    const unsubscribes = new Set();
    const messageStatusTimeouts = new Map();

    const notifSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");
    const els = {
      chatsList: document.getElementById('chatsList'),
      noChatsMsg: document.getElementById('noChatsMsg'),
      messagesContainer: document.getElementById('messagesContainer'),
      messageInput: document.getElementById('messageInput'),
      sendButton: document.getElementById('sendButton'),
      inputZone: document.getElementById('inputZone'),
      reactionMenu: document.getElementById('reactionMenu'),
      typingIndicator: document.getElementById('typingIndicator'),
      typingText: document.getElementById('typingText'),
      authOverlay: document.getElementById('authOverlay'),
      onlineCount: document.getElementById('onlineCount'),
      toast: document.getElementById('toast'),
      toastMsg: document.getElementById('toastMessage'),
      toastAvatar: document.getElementById('toastAvatar'),
      chatsView: document.getElementById('chatsView'),
      chatView: document.getElementById('chatView'),
      statusView: document.getElementById('statusView'),
      statusList: document.getElementById('statusList'),
      backBtn: document.getElementById('backBtn'),
      chatTitle: document.getElementById('chatTitle'),
      communityStatus: document.getElementById('communityStatus'),
      privateStatus: document.getElementById('privateStatus'),
      shieldIcon: document.getElementById('shieldIcon'),
      addFriendFab: document.getElementById('addFriendFab'),
      addStatusFab: document.getElementById('addStatusFab'),
      usersSheet: document.getElementById('usersSheet'),
      statusSheet: document.getElementById('statusSheet'),
      guestBottomSheet: document.getElementById('guestBottomSheet'),
      friendEmailInput: document.getElementById('friendEmailInput'),
      searchResult: document.getElementById('searchResult'),
      statusText: document.getElementById('statusText')
    };

    /* ----------  TAB SWITCHING  ---------- */
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        if (tab === 'chats') showChatsList();
        else if (tab === 'community') openChat('community');
        else if (tab === 'status') showStatusView();
      });
    });

    function showChatsList() {
      els.chatsView.classList.add('active');
      els.chatView.classList.remove('active');
      els.statusView.classList.remove('active');
      els.inputZone.style.display = 'none';
      els.addFriendFab.style.display = 'flex';
      els.addStatusFab.style.display = 'none';
      activeChatId = null;
      stopAllListeners();
    }

    function showStatusView() {
      els.chatsView.classList.remove('active');
      els.chatView.classList.remove('active');
      els.statusView.classList.add('active');
      els.inputZone.style.display = 'none';
      els.addFriendFab.style.display = 'none';
      els.addStatusFab.style.display = 'flex';
      activeChatId = null;
      stopAllListeners();
      loadStatuses();
    }

    /* ----------  AUTH  ---------- */
    window.isSignUp = false;
    window.toggleAuthMode = () => {
      window.isSignUp = !window.isSignUp;
      document.querySelector('.auth-box h2').textContent = window.isSignUp ? "Create Account" : "Sign In";
      document.querySelector('.auth-btn').textContent = window.isSignUp ? "Sign Up" : "Start Chatting";
    };
    window.handleAuth = async () => {
      const email = document.getElementById('authEmail').value.trim().toLowerCase();
      const pass = document.getElementById('authPass').value;
      if (!email || !pass) return alert("Please fill fields");
      try {
        let cred;
        if (window.isSignUp) {
          cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: email.split('@')[0] });
        } else {
          cred = await signInWithEmailAndPassword(auth, email, pass);
        }
        const userRef = doc(db, 'users', cred.user.uid);
        await setDoc(userRef, {
          email: email,
          displayName: cred.user.displayName,
          lastSeen: serverTimestamp(),
          friends: [],
          online: true,
          lastMessageRead: {}
        }, { merge: true });
        els.authOverlay.classList.remove('open');
      } catch (e) { alert(e.message); }
    };

    window.handleGuestSignUp = async () => {
      const email = document.getElementById('guestEmail').value.trim().toLowerCase();
      const password = document.getElementById('guestPassword').value;
      const displayName = document.getElementById('guestName').value.trim();
      if (!email || !password || !displayName) return alert('Please fill in all fields');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName });
        const userRef = doc(db, 'users', cred.user.uid);
        await setDoc(userRef, {
          email: email,
          displayName: displayName,
          lastSeen: serverTimestamp(),
          friends: [],
          online: true,
          lastMessageRead: {}
        }, { merge: true });
        els.guestBottomSheet.classList.remove('open');
        showToast('Account created!', '‚úì');
      } catch (e) { alert(e.message); }
    };
    window.closeGuestSheet = () => els.guestBottomSheet.classList.remove('open');

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        els.authOverlay.classList.add('open');
        stopAllListeners();
      } else {
        await loadFriendsChats();
        startHeartbeat();
        startGlobalNotificationListener(); // <-- shows toasts in ALL tabs
        if (els.chatsList.querySelectorAll('.chat-item').length === 0) {
          document.querySelector('.tab-btn[data-tab="community"]').click();
        } else {
          document.querySelector('.tab-btn[data-tab="chats"]').click();
        }
      }
    });

    /* ----------  FRIENDS / CHATS  ---------- */
    async function loadFriendsChats() {
      els.chatsList.innerHTML = '';
      els.noChatsMsg.style.display = 'none';
      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      const friends = userSnap.data()?.friends || [];
      if (friends.length === 0) {
        els.noChatsMsg.style.display = 'block';
        return;
      }
      for (const friendUid of friends) {
        const friendRef = doc(db, 'users', friendUid);
        const friendSnap = await getDoc(friendRef);
        if (!friendSnap.exists()) continue;
        const friend = friendSnap.data();
        const chatId = [currentUser.uid, friendUid].sort().join('_');
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.dataset.chatId = chatId;
        chatItem.dataset.partnerUid = friendUid;
        chatItem.innerHTML = `
          <div class="chat-avatar">
            ${friend.displayName.charAt(0).toUpperCase()}
            <div class="${friend.online ? 'online-indicator' : 'offline-indicator'}"></div>
          </div>
          <div class="chat-info">
            <div class="chat-name">${friend.displayName}</div>
            <div class="chat-preview" id="preview-${chatId}">Tap to start chatting</div>
          </div>
          <div class="chat-time" id="time-${chatId}"></div>
          <div class="unread-dot" id="unread-${chatId}" style="display:none;"></div>
        `;
        chatItem.addEventListener('click', () => openPrivateChat(chatId, { uid: friendUid, displayName: friend.displayName }));
        els.chatsList.appendChild(chatItem);
        const messagesQ = query(collection(db, 'privateChats', chatId, 'messages'), orderBy('createdAt', 'desc'), limit(1));
        const unsubscribe = onSnapshot(messagesQ, (snapshot) => {
          const previewEl = document.getElementById(`preview-${chatId}`);
          const timeEl = document.getElementById(`time-${chatId}`);
          const unreadEl = document.getElementById(`unread-${chatId}`);
          if (snapshot.empty) {
            previewEl.textContent = 'Tap to start chatting';
            timeEl.textContent = '';
            unreadEl.style.display = 'none';
            return;
          }
          const lastMsg = snapshot.docs[0].data();
          const isOwn = lastMsg.userId === currentUser.uid;
          const decrypted = decrypt(lastMsg.text, 'PRIVATE_DEMO_KEY');
          const shortText = decrypted.length > 30 ? decrypted.slice(0, 27) + '...' : decrypted;
          previewEl.textContent = isOwn ? `You: ${shortText}` : shortText;
          if (lastMsg.createdAt) {
            const msgTime = lastMsg.createdAt.toDate();
            const now = new Date();
            const diffMins = Math.floor((now - msgTime) / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            let timeStr = diffMins < 1 ? 'now' : diffMins < 60 ? `${diffMins}m` : diffHours < 24 ? `${diffHours}h` : `${diffDays}d`;
            timeEl.textContent = timeStr;
          }
          if (!isOwn) {
            const lastReadTime = userSnap.data()?.lastMessageRead?.[chatId];
            if (!lastReadTime || lastMsg.createdAt.toDate() > lastReadTime.toDate()) unreadEl.style.display = 'block';
            else unreadEl.style.display = 'none';
          }
        });
        unsubscribes.add(unsubscribe);
      }
    }

    /* ----------  CHAT ROOM  ---------- */
    function openChat(chatId, partner = null) {
      stopAllListeners();
      activeChatId = chatId;
      activeChatPartner = partner;
      els.messagesContainer.innerHTML = '';
      els.inputZone.style.display = 'flex';
      els.addFriendFab.style.display = 'none';
      els.addStatusFab.style.display = 'none';
      els.chatsView.classList.remove('active');
      els.statusView.classList.remove('active');
      els.chatView.classList.add('active');
      isInitialLoad = true;
      if (chatId === 'community') {
        els.backBtn.style.display = 'none';
        els.chatTitle.textContent = 'Vynix Secure Community';
        els.communityStatus.style.display = 'flex';
        els.privateStatus.style.display = 'none';
        els.shieldIcon.style.display = 'block';
        setupCommunityExtras();
      } else {
        els.backBtn.style.display = 'block';
        els.chatTitle.textContent = partner.displayName;
        els.communityStatus.style.display = 'none';
        els.privateStatus.style.display = 'block';
        updatePrivateChatStatus(partner.uid);
        els.shieldIcon.style.display = 'none';
        markMessagesAsRead(chatId);
      }
      const key = chatId === 'community' ? COMMUNITY_KEY : 'PRIVATE_DEMO_KEY';
      const messagesQuery = query(collection(db, chatId === 'community' ? 'communityMessages' : `privateChats/${chatId}/messages'), orderBy('createdAt', 'asc'), limit(50));
      const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            appendMessage(change.doc, key, chatId === 'community');
            if (!isInitialLoad && change.doc.data().userId !== currentUser.uid) {
              if (chatId === 'community') triggerNotification(change.doc.data().userName);
            }
          }
          if (change.type === 'modified') updateMessageInDOM(change.doc);
        });
        if (isInitialLoad) {
          scrollToBottom();
          isInitialLoad = false;
        } else scrollToBottom();
      });
      unsubscribes.add(unsubscribe);
    }
    function openPrivateChat(chatId, partner) { openChat(chatId, partner); }
    els.backBtn.addEventListener('click', () => document.querySelector('.tab-btn[data-tab="chats"]').click());

    async function updatePrivateChatStatus(partnerUid) {
      const partnerRef = doc(db, 'users', partnerUid);
      const unsubscribe = onSnapshot(partnerRef, (snap) => {
        if (snap.exists()) {
          const partner = snap.data();
          const isOnline = partner.online && (Date.now() - partner.lastSeen?.toMillis() < 120000);
          els.privateStatus.textContent = isOnline ? 'Online' : `Last seen ${timeAgo(partner.lastSeen?.toDate())}`;
        }
      });
      unsubscribes.add(unsubscribe);
    }
    function markMessagesAsRead(chatId) {
      const userRef = doc(db, 'users', currentUser.uid);
      updateDoc(userRef, { [`lastMessageRead.${chatId}`]: serverTimestamp() });
      const unreadEl = document.getElementById(`unread-${chatId}`);
      if (unreadEl) unreadEl.style.display = 'none';
    }
    function setupCommunityExtras() {
      const typingQ = query(collection(db, 'typingStatus'), where('isTyping', '==', true));
      const typingUnsub = onSnapshot(typingQ, (snap) => {
        const typers = [];
        snap.forEach(doc => {
          if (doc.id !== currentUser.uid) {
            const data = doc.data();
            if (Date.now() - data.timestamp?.toMillis() < 3000) typers.push(data.userName);
          }
        });
        if (typers.length > 0) {
          els.typingText.textContent = `${typers.join(', ')} is typing...`;
          els.typingIndicator.classList.add('active');
        } else els.typingIndicator.classList.remove('active');
      });
      unsubscribes.add(typingUnsub);
      const usersQ = query(collection(db, 'users'));
      const onlineUnsub = onSnapshot(usersQ, (snap) => {
        let count = 0;
        const now = Date.now();
        snap.forEach(doc => {
          const data = doc.data();
          if (data.lastSeen && (now - data.lastSeen.toMillis() < 120000)) count++;
        });
        els.onlineCount.textContent = count;
      });
      unsubscribes.add(onlineUnsub);
    }

    /* ----------  NOTIFICATIONS (GLOBAL)  ---------- */
    function startGlobalNotificationListener() {
      const communityMsgQ = query(collection(db, 'communityMessages'), orderBy('createdAt', 'desc'), limit(1));
      const unsubscribe = onSnapshot(communityMsgQ, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            const msg = change.doc.data();
            if (msg.userId !== currentUser.uid) triggerNotification(msg.userName);
          }
        });
      });
      unsubscribes.add(unsubscribe);
    }
    function triggerNotification(senderName) {
      try { notifSound.play().catch(() => {}); } catch (e) {}
      if (navigator.vibrate) navigator.vibrate(200);
      els.toastAvatar.textContent = senderName.charAt(0).toUpperCase();
      els.toastMsg.textContent = `New message from ${senderName}`;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 5000);
    }
    function showToast(msg, icon = '‚úì') {
      els.toastAvatar.textContent = icon;
      els.toastMsg.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 3000);
    }

    /* ----------  MESSAGE HELPERS  ---------- */
    function appendMessage(doc, key, isCommunity) {
      const data = doc.data();
      const id = doc.id;
      const isOwn = data.userId === currentUser.uid;
      const decryptedText = decrypt(data.text, key);
      const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
      const initials = (data.userName || 'U').charAt(0).toUpperCase();
      const div = document.createElement('div');
      div.className = 'msg-group';
      div.id = `msg-${id}`;
      div.innerHTML = `
        <div class="msg-row ${isOwn ? 'own' : ''}">
          ${!isOwn ? `<div class="avatar">${initials}</div>` : ''}
          <div class="bubble-container">
            ${!isOwn ? `<span class="sender-name">${data.userName}</span>` : ''}
            <div class="bubble" data-id="${id}">
              ${decryptedText}
              <div class="meta-row">
                <span class="timestamp" style="color:${isOwn?'rgba(255,255,255,0.7)':'rgba(0,0,0,0.4)'}">${time}</span>
                <span class="message-status" id="status-${id}">‚úì</span>
              </div>
            </div>
            <div class="reaction-pill" id="react-${id}"></div>
          </div>
        </div>
      `;
      const bubble = div.querySelector('.bubble');
      const collectionPath = isCommunity ? 'communityMessages' : `privateChats/${activeChatId}/messages`;
      bindLongPress(bubble, id, collectionPath);
      els.messagesContainer.appendChild(div);
      renderReactions(id, data.reactions || {});
      if (isOwn && !isCommunity) {
        updateMessageStatus(id, 'sent');
        const timeout = setTimeout(() => updateMessageStatus(id, 'delivered'), 1000);
        messageStatusTimeouts.set(id, timeout);
      }
    }
    function updateMessageInDOM(doc) { renderReactions(doc.id, doc.data().reactions || {}); }
    function renderReactions(msgId, reactions) {
      const pill = document.getElementById(`react-${msgId}`);
      if (!pill) return;
      if (!reactions || Object.keys(reactions).length === 0) {
        pill.classList.remove('has-reactions');
        pill.innerHTML = '';
        return;
      }
      const counts = {};
      Object.values(reactions).forEach(emoji => counts[emoji] = (counts[emoji] || 0) + 1);
      const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
      pill.innerHTML = entries.map(([e, c]) => `<span>${e}${c > 1 ? c : ''}</span>`).join('');
      pill.classList.add('has-reactions');
    }
    let longPressTimer;
    function bindLongPress(element, msgId, collectionPath) {
      element.addEventListener('contextmenu', e => e.preventDefault());
      const start = () => {
        longPressTimer = setTimeout(() => {
          if (navigator.vibrate) navigator.vibrate(50);
          openReactionMenu(msgId, collectionPath);
        }, 500);
      };
      const cancel = () => clearTimeout(longPressTimer);
      element.addEventListener('touchstart', start);
      element.addEventListener('touchend', cancel);
      element.addEventListener('touchmove', cancel);
      element.addEventListener('mousedown', start);
      element.addEventListener('mouseup', cancel);
    }
    function openReactionMenu(msgId, collectionPath) {
      selectedMessageId = { id: msgId, path: collectionPath };
      els.reactionMenu.classList.add('open');
    }
    document.querySelectorAll('.reaction-emoji').forEach(emojiBtn => {
      emojiBtn.addEventListener('click', async () => {
        const emoji = emojiBtn.dataset.emoji;
        els.reactionMenu.classList.remove('open');
        if (selectedMessageId && currentUser) {
          const msgRef = doc(db, selectedMessageId.path, selectedMessageId.id);
          await updateDoc(msgRef, { [`reactions.${currentUser.uid}`]: emoji });
        }
      });
    });
    els.reactionMenu.addEventListener('click', e => {
      if (e.target === els.reactionMenu) els.reactionMenu.classList.remove('open');
    });
    function updateMessageStatus(messageId, status) {
      const statusEl = document.getElementById(`status-${messageId}`);
      if (!statusEl) return;
      switch (status) {
        case 'sent': statusEl.textContent = '‚úì'; break;
        case 'delivered': statusEl.textContent = '‚úì‚úì'; break;
        case 'read': statusEl.textContent = '‚úì‚úì'; statusEl.style.color = '#10b981'; break;
      }
    }

    /* ----------  SEND MESSAGE  ---------- */
    async function sendMessage() {
      const text = els.messageInput.value.trim();
      if (!text || !currentUser || !activeChatId) return;
      const key = activeChatId === 'community' ? COMMUNITY_KEY : 'PRIVATE_DEMO_KEY';
      const encryptedText = encrypt(text, key);
      els.messageInput.value = '';
      els.sendButton.classList.remove('active');
      let col;
      if (activeChatId === 'community') col = collection(db, 'communityMessages');
      else col = collection(db, 'privateChats', activeChatId, 'messages');
      await addDoc(col, {
        text: encryptedText,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anon',
        createdAt: serverTimestamp(),
        reactions: {}
      });
      if (activeChatId !== 'community') {
        const chatRef = doc(db, 'privateChats', activeChatId);
        await setDoc(chatRef, { lastMessageAt: serverTimestamp(), participants: activeChatId.split('_') }, { merge: true });
      }
    }
    els.messageInput.addEventListener('input', () => {
      const hasText = els.messageInput.value.trim().length > 0;
      els.sendButton.classList.toggle('active', hasText);
      if (activeChatId === 'community' && currentUser) {
        const userStatusRef = doc(db, 'typingStatus', currentUser.uid);
        setDoc(userStatusRef, { userName: currentUser.displayName || 'Someone', isTyping: hasText, timestamp: serverTimestamp() });
        clearTimeout(typingTimeout);
        if (hasText) typingTimeout = setTimeout(() => setDoc(userStatusRef, { isTyping: false }, { merge: true }), 2000);
      }
    });
    els.messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
    els.sendButton.addEventListener('click', sendMessage);
    function scrollToBottom() { els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight; }

    /* ----------  FRIEND ADD (EMAIL)  ---------- */
    els.addFriendFab.addEventListener('click', () => {
      if (!currentUser) return els.guestBottomSheet.classList.add('open');
      els.usersSheet.classList.add('open');
      els.friendEmailInput.value = '';
      els.searchResult.innerHTML = '';
    });
    window.searchByEmail = async () => {
      const email = els.friendEmailInput.value.trim().toLowerCase();
      const box = els.searchResult;
      if (!email) return box.innerHTML = '<div class="no-results">Enter an email</div>';
      if (email === currentUser.email) return box.innerHTML = '<div class="no-results">You can‚Äôt add yourself</div>';
      try {
        const q = query(collection(db, 'users'), where('email', '==', email));
        const snap = await getDocs(q);
        box.innerHTML = '';
        if (snap.empty) return box.innerHTML = '<div class="no-results">No user with that email</div>';
        const target = snap.docs[0];
        const targetData = target.data();
        const myFriends = (await getDoc(doc(db, 'users', currentUser.uid))).data().friends || [];
        const alreadyAdded = myFriends.includes(target.id);
        box.innerHTML = `
          <div class="user-item">
            <div class="user-avatar">${targetData.displayName?.[0] || '?'}</div>
            <div class="user-details">
              <div class="user-name">${targetData.displayName || 'Anonymous'}</div>
              <div class="user-email">${targetData.email}</div>
            </div>
            <button class="add-btn ${alreadyAdded ? 'added' : ''}" ${alreadyAdded ? 'disabled' : ''}>
              ${alreadyAdded ? 'Added' : 'Add Friend'}
            </button>
          </div>`;
        if (!alreadyAdded) {
          box.querySelector('.add-btn').addEventListener('click', async () => {
            await addFriend(target.id);
            box.querySelector('.add-btn').disabled = true;
            box.querySelector('.add-btn').textContent = 'Added';
            showToast(`Added ${targetData.displayName || targetData.email}`, '‚úì');
          });
        }
      } catch (err) {
        console.error(err);
        box.innerHTML = '<div class="no-results">Error ‚Äì check console</div>';
      }
    };
    async function addFriend(friendUid) {
      const myRef = doc(db, 'users', currentUser.uid);
      const friendRef = doc(db, 'users', friendUid);
      await updateDoc(myRef, { friends: arrayUnion(friendUid) });
      await updateDoc(friendRef, { friends: arrayUnion(currentUser.uid) });
      await loadFriendsChats();
    }

    /* ----------  STATUS TAB  ---------- */
    els.addStatusFab.addEventListener('click', () => {
      if (!currentUser) return els.guestBottomSheet.classList.add('open');
      els.statusText.value = '';
      els.statusSheet.classList.add('open');
    });
    window.postStatus = async () => {
      const text = els.statusText.value.trim();
      if (!text) return;
      await addDoc(collection(db, 'statuses'), {
        text: text,
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anonymous',
        createdAt: serverTimestamp(),
        likes: []
      });
      els.statusSheet.classList.remove('open');
      showToast('Status posted!', '‚úì');
    };
    window.closeStatusSheet = () => els.statusSheet.classList.remove('open');

    function loadStatuses() {
      els.statusList.innerHTML = '<p style="text-align:center; color:var(--text-muted); margin-top:50px;">Loading statuses...</p>';
      const q = query(collection(db, 'statuses'), orderBy('createdAt', 'desc'), limit(50));
      const unsubscribe = onSnapshot(q, (snapshot) => {
        els.statusList.innerHTML = '';
        snapshot.forEach(doc => renderStatusCard(doc));
        if (snapshot.empty) els.statusList.innerHTML = '<p style="text-align:center; color:var(--text-muted); margin-top:50px;">No statuses yet. Be the first!</p>';
      });
      unsubscribes.add(unsubscribe);
    }
    function renderStatusCard(doc) {
      const data = doc.data();
      const isLiked = data.likes.includes(currentUser.uid);
      const card = document.createElement('div');
      card.className = 'status-card';
      card.innerHTML = `
        <div class="status-header">
          <div class="status-avatar">${data.userName.charAt(0).toUpperCase()}</div>
          <div class="status-meta">
            <div class="status-name">${data.userName}</div>
            <div class="status-time">${timeAgo(data.createdAt?.toDate())}</div>
          </div>
        </div>
        <div class="status-text">${data.text}</div>
        <div class="status-footer">
          <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${doc.id}')">
            <span class="material-symbols-rounded" style="font-size:16px;">${isLiked ? 'favorite' : 'favorite_border'}</span>
            <span>${data.likes.length}</span>
          </button>
        </div>
      `;
      els.statusList.appendChild(card);
    }
    window.toggleLike = async (statusId) => {
      const ref = doc(db, 'statuses', statusId);
      const snap = await getDoc(ref);
      const likes = snap.data().likes || [];
      const already = likes.includes(currentUser.uid);
      await updateDoc(ref, { likes: already ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
    };

    /* ----------  MISC UTILS  ---------- */
    function stopAllListeners() { unsubscribes.forEach(unsub => unsub()); unsubscribes.clear(); }
    function startHeartbeat() {
      const update = () => {
        if (!currentUser) return;
        const userRef = doc(db, 'users', currentUser.uid);
        updateDoc(userRef, { lastSeen: serverTimestamp(), online: true });
      };
      update();
      setInterval(update, 30000);
    }
    function timeAgo(date) {
      if (!date) return 'a while ago';
      const diff = Date.now() - date.getTime();
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(mins / 60);
      const days = Math.floor(hrs / 24);
      if (mins < 1) return 'now';
      if (mins < 60) return `${mins}m`;
      if (hrs < 24) return `${hrs}h`;
      return `${days}d`;
    }

    /* ----------  CLOSE SHEETS ON BACKDROP  ---------- */
    els.usersSheet.addEventListener('click', e => { if (e.target === els.usersSheet) els.usersSheet.classList.remove('open'); });
    els.statusSheet.addEventListener('click', e => { if (e.target === els.statusSheet) els.statusSheet.classList.remove('open'); });
    els.guestBottomSheet.addEventListener('click', e => { if (e.target === els.guestBottomSheet) els.guestBottomSheet.classList.remove('open'); });

    /* ----------  RAIN CANVAS  ---------- */
    const canvas = document.createElement('canvas');
    canvas.id = 'rainCanvas';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let w, h, drops = [];
    function resizeRain() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      drops = Array(Math.floor(w / 20)).fill(0).map(() => ({
        x: Math.random() * w,
        y: Math.random() * h,
        s: Math.random() * 2 + 2,
        l: Math.random() * 15 + 5
      }));
    }
    window.addEventListener('resize', resizeRain);
    resizeRain();
    function drawRain() {
      ctx.clearRect(0, 0, w, h);
      ctx.strokeStyle = '#2563eb';
      ctx.lineWidth = 1;
      drops.forEach(d => {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x, d.y + d.l);
        ctx.stroke();
        d.y += d.s;
        if (d.y > h) {
          d.y = -d.l;
          d.x = Math.random() * w;
        }
      });
      requestAnimationFrame(drawRain);
    }
    drawRain();

    /* ----------  BEFORE UNLOAD  ---------- */
    window.addEventListener('beforeunload', async () => {
      if (!currentUser) return;
      const userRef = doc(db, 'users', currentUser.uid);
      await updateDoc(userRef, { online: false, lastSeen: serverTimestamp() });
    });
  </script>
</body>
  </html>
