<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --accent-blue: #3a76f0;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-color: #f8f9fa;
            --glass-white: rgba(255, 255, 255, 0.85);
            --online-green: #10b981;
            --received-bg: #e5e5ea;
            --border-color: rgba(0,0,0,0.05);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --text-primary: #f9f9f9;
                --text-secondary: #a0a0a0;
                --bg-color: #000000;
                --glass-white: rgba(20, 20, 20, 0.85);
                --received-bg: #2c2c2e;
                --border-color: rgba(255,255,255,0.05);
            }
            body { background: var(--bg-color); color: var(--text-primary); }
        }
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
            outline: none;
        }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-primary); overflow-x: hidden; }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmerEffect 1.5s infinite linear;
        }
        @keyframes shimmerEffect { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--glass-white);
            display: flex; align-items: center; justify-content: center;
            padding: 0 20px; z-index: 1000; backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-color);
        }
        .user-profile {
            position: absolute; left: 20px;
            width: 42px; height: 42px; border-radius: 50%; object-fit: cover;
            cursor: pointer;
        }
        .app-title { font-size: 24px; font-weight: 700; color: var(--accent-blue); letter-spacing: -0.8px; }
        .pill-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: var(--glass-white); width: 200px; height: 64px; border-radius: 40px;
            display: flex; align-items: center; justify-content: space-around; padding: 0 10px;
            z-index: 2000; backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 8px 32px rgba(0,0,0,.15);
        }
        .nav-item {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 10px 12px; border-radius: 24px; font-size: 14px; font-weight: 600;
            color: var(--text-secondary); transition: all .3s ease; cursor: pointer;
        }
        .nav-item span { font-size: 26px; }
        .nav-item.active { background: var(--accent-blue); color: #fff; }
        main { padding: 90px 16px 120px 16px; min-height: 100vh; }
        #statusTab, #settingsTab { display: none; }
        .chat-card {
            display: flex; align-items: center; padding: 12px 0; margin-bottom: 8px;
            position: relative; transition: transform 0.2s; cursor: pointer;
        }
        .avatar-box {
            margin-right: 15px; flex-shrink: 0; position: relative;
        }
        .avatar { width: 58px; height: 58px; border-radius: 50%; object-fit: cover; }
        .online-indicator {
            position: absolute; bottom: 2px; right: 2px; width: 16px; height: 16px;
            background: var(--online-green); border: 3px solid var(--bg-color); border-radius: 50%; z-index: 1;
        }
        .chat-info { flex: 1; overflow: hidden; padding-right: 50px; }
        .chat-name { font-weight: 600; font-size: 17px; color: var(--text-primary); }
        .chat-msg { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }
        .chat-time { position: absolute; top: 12px; right: 0; font-size: 13px; color: var(--text-secondary); font-weight: 500; }
        .unread-badge {
            position: absolute; bottom: 12px; right: 0; background: var(--accent-blue); color: white;
            font-size: 12px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; padding: 0 6px;
        }
        .favorite-indicator {
            position: absolute; top: 8px; left: 50px; color: #ffd700; font-size: 20px; pointer-events: none;
        }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .status-card {
            position: relative; height: 280px; border-radius: 30px; overflow: hidden;
            background: #eee; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .status-card:active { transform: scale(0.95); }
        .status-card img, .status-card video { width: 100%; height: 100%; object-fit: cover; }
        .status-info {
            position: absolute; bottom: 0; width: 100%; padding: 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: #fff; font-size: 13px;
        }
        .status-views {
            position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6);
            color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 12px; cursor: pointer;
        }
        .status-online-indicator {
            position: absolute; top: 10px; right: 10px; width: 12px; height: 12px;
            background: var(--online-green); border: 2px solid #fff; border-radius: 50%;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }
        #storyViewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none; }
        .story-header { position: absolute; top: 30px; left: 15px; display: flex; align-items: center; z-index: 20; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .story-progress { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; }
        .progress-segment { height: 3px; background: rgba(255,255,255,0.3); flex: 1; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #fff; width: 0%; transition: width linear; }
        #storyMedia { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
        #storyMedia img, #storyMedia video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .story-sound-btn, .story-delete {
            position: absolute; background: rgba(0,0,0,0.6); color: #fff;
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 28px; z-index: 30; cursor: pointer;
        }
        .story-sound-btn { bottom: 80px; right: 20px; }
        .story-delete { top: 80px; right: 20px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 2500; backdrop-filter: blur(8px); }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 35px 35px 0 0; padding: 35px 25px; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2600; max-height: 80vh; overflow-y: auto; }
        .bottom-sheet.active { bottom: 0; }
        .v-input { width: 100%; padding: 18px; border: 2px solid #f3f4f6; border-radius: 20px; margin-bottom: 15px; font-family: inherit; font-size: 15px; }
        .btn-primary { width: 100%; background: #000; color: #fff; border: none; padding: 18px; border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 15px; }
        .btn-danger { background: #ff3b30 !important; }
        .btn-secondary { background: #f1f1f1 !important; color: #000 !important; }
        #toast { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 12px 25px; border-radius: 50px; font-size: 13px; z-index: 6000; display: none; }
        .profile-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(15px); }
        .profile-card { background: #fff; width: 100%; max-width: 420px; border-radius: 35px 35px 0 0; padding: 20px 30px 40px; text-align: center; position: relative; animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .profile-card::before {
            content: ''; position: absolute; top: -60px; left: 50%; transform: translateX(-50%);
            width: 80px; height: 6px; background: #ddd; border-radius: 3px;
        }
        .profile-avatar-large { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 6px solid var(--accent-blue); margin: 20px auto 25px; box-shadow: 0 12px 30px rgba(0,0,0,0.2); transition: transform 0.3s ease; cursor: pointer; }
        .profile-avatar-large:active { transform: scale(0.95); }
        .profile-name { font-size: 26px; font-weight: 700; margin: 0 0 8px 0; }
        .profile-id { color: var(--accent-blue); font-weight: 700; font-size: 17px; margin-bottom: 15px; }
        .profile-status { font-size: 15px; color: var(--text-secondary); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: var(--bg-color); border-radius: 20px; }
        .profile-stats { display: flex; justify-content: space-around; margin: 25px 0; padding: 20px 0; background: var(--bg-color); border-radius: 20px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--text-primary); }
        .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
        .profile-actions { display: flex; gap: 15px; margin-top: 20px; }
        .profile-actions button { flex: 1; padding: 18px; border-radius: 20px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s; }
        .profile-actions button:active { transform: scale(0.95); }
        .profile-actions .btn-message { background: #000; color: #fff; }
        .profile-actions .btn-call { background: var(--online-green); color: #fff; }
        .profile-actions .btn-unfriend { background: #ff3b30; color: #fff; }
        .profile-close { margin-top: 35px; font-size: 15px; color: #999; font-weight: 600; cursor: pointer; }
        .search-container { position: relative; margin-bottom: 15px; padding: 0 16px; }
        .search-input { width: 100%; padding: 14px 45px 14px 20px; border: 2px solid #f3f4f6; border-radius: 25px; font-family: inherit; font-size: 14px; background: #fff; transition: border-color 0.3s; }
        .search-input:focus { border-color: var(--accent-blue); outline: none; }
        .search-icon { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
        .clear-search { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); cursor: pointer; display: none; }
        .notification-toggle { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; padding: 15px; background: var(--bg-color); border-radius: 15px; }
        .notification-label { font-size: 14px; color: var(--text-primary); font-weight: 500; }
        .toggle-switch { position: relative; width: 50px; height: 24px; background: #ccc; border-radius: 24px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch.active { background: var(--accent-blue); }
        .toggle-slider { position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch.active .toggle-slider { transform: translateX(26px); }
        .profile-pic-upload { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px; display: block; border: 3px solid var(--accent-blue); cursor: pointer; }
        #offlineIndicator { position: fixed; top: 85px; left: 50%; transform: translateX(-50%); background: #ff3b30; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 999; display: none; box-shadow: 0 4px 12px rgba(255,59,48,0.3); }
        #fullChatView { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 3000; display: none; flex-direction: column; }
        #chatHeader { position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--glass-white); display: flex; align-items: center; padding: 0 20px; z-index: 3100; backdrop-filter: blur(20px) saturate(180%); border-bottom: 1px solid var(--border-color); }
        #chatBackBtn { font-size: 28px; cursor: pointer; margin-right: 15px; color: var(--accent-blue); }
        #chatFriendAvatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; margin-right: 12px; position: relative; }
        .chat-header-avatar-wrapper { position: relative; margin-right: 12px; }
        .chat-header-online { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: var(--online-green); border: 2px solid var(--glass-white); border-radius: 50%; }
        #chatFriendName { font-weight: 600; font-size: 18px; }
        #chatStatusInfo { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
        .chat-header-right { margin-left: auto; display: flex; align-items: center; gap: 15px; }
        .chat-header-icon { font-size: 24px; cursor: pointer; color: var(--text-primary); }
        #messageList { flex: 1; padding: 90px 16px 100px 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .message { max-width: 80%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; position: relative; cursor: pointer; }
        .message.sent { align-self: flex-end; background: var(--accent-blue); color: #fff; border-bottom-right-radius: 4px; }
        .message.received { align-self: flex-start; background: var(--received-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .message-time { font-size: 12px; opacity: 0.7; margin-top: 4px; text-align: right; }
        .message.sent .message-time { color: rgba(255,255,255,0.8); }
        .reactions { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
        .reaction { background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; min-width: 24px; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .message.sent .reaction { background: rgba(0,0,0,0.3); color: #fff; }
        .reaction.mine { border: 1px solid var(--accent-blue); }
        .message-delete-icon {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #ff3b30; width: 36px; height: 36px; border-radius: 50%;
            display: none; align-items: center; justify-content: center; font-size: 20px; z-index: 10;
        }
        .message.sent:hover .message-delete-icon, .message.sent:active .message-delete-icon { display: flex; }
        #chatInputArea { position: fixed; bottom: 0; left: 0; right: 0; background: var(--glass-white); padding: 10px 16px; display: flex; align-items: center; backdrop-filter: blur(20px) saturate(180%); gap: 10px; border-top: 1px solid var(--border-color); }
        #messageInput { flex: 1; padding: 12px 16px; border-radius: 22px; font-family: inherit; font-size: 16px; background: rgba(128,128,128,0.15); border: none; }
        #actionBtn { width: 44px; height: 44px; font-size: 24px; color: #fff; background: var(--accent-blue); cursor: pointer; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        #actionBtn.recording { background: #ff3b30; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .voice-message { background: #f3f4f6; border-radius: 20px; padding: 10px 14px; display: flex; align-items: center; gap: 12px; max-width: 300px; position: relative; }
        .voice-message.sent { background: #000; }
        .voice-play-btn { width: 40px; height: 40px; background: var(--accent-blue); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; flex-shrink: 0; }
        .voice-waveform { flex: 1; height: 36px; background: #ddd; border-radius: 18px; overflow: hidden; position: relative; }
        .voice-waveform::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent 50%, rgba(255,255,255,0.4) 50%); background-size: 20px 100%; animation: waveform 1.5s linear infinite;
        }
        .voice-waveform.playing::after { animation-play-state: running; }
        .voice-waveform.paused::after { animation-play-state: paused; }
        @keyframes waveform { 0% { background-position: 0 0; } 100% { background-position: 20px 0; } }
        .voice-duration { font-size: 12px; color: var(--text-secondary); min-width: 45px; text-align: right; }
        .message.sent .voice-duration { color: #aaa; }
        .deleted-message { font-style: italic; color: var(--text-secondary); font-size: 13px; }
        .recording-overlay {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff;
            padding: 14px 28px; border-radius: 40px; display: none; align-items: center; gap: 16px; z-index: 5000; box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .recording-timer { font-size: 18px; font-weight: 600; }
        .recording-label { font-size: 14px; }
        .typing-indicator { align-self: flex-start; background: var(--received-bg); padding: 10px 16px; border-radius: 20px; border-bottom-left-radius: 4px; display: none; align-items: center; gap: 6px; font-size: 14px; color: var(--text-secondary); }
        .typing-dot { width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: typingDot 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingDot { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }
        .custom-alert { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 7000; backdrop-filter: blur(8px); }
        .custom-alert.active { display: flex; }
        .custom-alert-box { background: #fff; width: 85%; max-width: 320px; border-radius: 20px; padding: 25px; text-align: center; }
        .custom-alert-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; }
        .custom-alert-message { font-size: 14px; color: var(--text-secondary); margin-bottom: 25px; }
        #recordingWaveform { flex: 1; height: 24px; display: flex; align-items: center; gap: 2px; margin-left: 12px; }
        .wave-bar { width: 3px; background: #ff3b30; border-radius: 2px; transition: height 0.1s ease; }
        #callControls { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 14px 28px; border-radius: 40px; display: none; align-items: center; gap: 16px; z-index: 5000; }
        .viewer-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .viewer-item:last-child { border-bottom: none; }
        .viewer-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
        .viewer-info { flex: 1; }
        .viewer-name { font-weight: 500; }
        .viewer-time { font-size: 12px; color: var(--text-secondary); }
        img, .avatar, .user-profile, .profile-avatar-large, .profile-pic-upload, #chatFriendAvatar, #detailImg, #settingsAvatar, #myAvatar { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; pointer-events: auto; }
        .avatar-box, .chat-header-avatar-wrapper { -webkit-touch-callout: none; }
        #pageLoader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; opacity: 1; transition: opacity 0.4s ease; }
        #pageLoader.fade-out { opacity: 0; }
        #pageLoader .loader-header { height: 75px; width: 100%; background: var(--glass-white); display: flex; align-items: center; justify-content: center; padding: 0 20px; position: relative; backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); }
        #pageLoader .loader-avatar { width: 42px; height: 42px; border-radius: 50%; position: absolute; left: 20px; }
        #pageLoader .loader-title { width: 120px; height: 28px; border-radius: 8px; }
        #pageLoader .loader-main { flex: 1; padding: 90px 16px 120px 16px; overflow: hidden; }
        #pageLoader .loader-chat-card { display: flex; align-items: center; padding: 12px 0; margin-bottom: 20px; }
        #pageLoader .loader-chat-card .loader-avatar { width: 58px; height: 58px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
        #pageLoader .loader-info { flex: 1; }
        #pageLoader .loader-name { width: 60%; height: 18px; border-radius: 8px; margin-bottom: 8px; }
        #pageLoader .loader-msg { width: 80%; height: 14px; border-radius: 6px; }
        .reaction-picker { position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; bottom: auto !important; z-index: 10000; background: #fff; padding: 16px; border-radius: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); display: flex; gap: 12px; backdrop-filter: blur(10px); }
        .reaction-picker-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; backdrop-filter: blur(5px); }
        .signal-profile-header { text-align: center; padding: 24px 24px 20px; position: relative; }
        .signal-profile-handle { width: 32px; height: 4px; background: #e0e0e0; border-radius: 2px; margin: 0 auto 20px; }
        .signal-profile-avatar-section { position: relative; display: inline-block; margin-bottom: 16px; cursor: pointer; transition: transform 0.2s ease; }
        .signal-profile-avatar-section:hover { transform: scale(1.05); }
        .signal-profile-avatar-section:active { transform: scale(0.95); }
        .signal-profile-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #f5f5f5; }
        .signal-profile-status-badge { position: absolute; bottom: 6px; right: 6px; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; display: none; }
        .signal-profile-status-badge.online { display: block; background: var(--accent-blue); }
        .signal-profile-name { font-size: 20px; font-weight: 500; color: #1a1a1a; margin: 0 0 4px 0; line-height: 1.3; }
        .signal-profile-id { font-size: 14px; color: var(--accent-blue); font-weight: 500; margin-bottom: 8px; }
        .signal-profile-status { font-size: 14px; color: #757575; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .signal-profile-actions { display: flex; gap: 12px; padding: 0 24px 24px; border-bottom: 1px solid #f0f0f0; }
        .signal-action-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; border: none; border-radius: 12px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; background: #f5f5f5; color: #424242; }
        .signal-action-btn:hover { background: #eeeeee; }
        .signal-action-btn:active { transform: scale(0.98); }
        .signal-action-primary { background: var(--accent-blue); color: white; }
        .signal-action-primary:hover { background: #2d5bb9; }
        .signal-action-btn span:first-child { font-size: 24px; }
        .signal-profile-info { display: flex; padding: 20px 24px; border-bottom: 1px solid #f0f0f0; }
        .signal-info-item { flex: 1; text-align: center; }
        .signal-info-label { display: block; font-size: 13px; color: #9e9e9e; margin-bottom: 4px; }
        .signal-info-value { display: block; font-size: 18px; font-weight: 500; color: #1a1a1a; }
        .signal-divider { width: 1px; background: #f0f0f0; margin: 0 24px; }
        .signal-danger-btn { width: calc(100% - 48px); margin: 24px; padding: 14px; background: #ffebee; color: #d32f2f; border: none; border-radius: 8px; font-size: 15px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.2s ease; }
        .signal-danger-btn:hover { background: #ffcdd2; }
        .signal-danger-btn:active { transform: scale(0.98); }
        @media (prefers-color-scheme: dark) {
            .signal-profile-handle { background: #424242; }
            .signal-profile-avatar { border-color: #2c2c2e; }
            .signal-profile-name { color: #ffffff; }
            .signal-profile-id { color: var(--accent-blue); }
            .signal-profile-status { color: #9e9e9e; }
            .signal-action-btn { background: #2c2c2e; color: #e0e0e0; }
            .signal-action-btn:hover { background: #3c3c3e; }
            .signal-action-primary { background: var(--accent-blue); }
            .signal-action-primary:hover { background: #2d5bb9; }
            .signal-info-label { color: #9e9e9e; }
            .signal-info-value { color: #ffffff; }
            .signal-danger-btn { background: #3e2723; color: #ff8a80; }
            .signal-danger-btn:hover { background: #4e2723; }
        }
        /* Chat subtabs: pill shape with icons */
        .chat-subtabs { display: flex; background: var(--glass-white); margin: 0 16px 20px 16px; border-radius: 30px; padding: 6px; backdrop-filter: blur(20px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        .chat-subtab { flex: 1; display: flex; flex-direction: row; align-items: center; justify-content: center; padding: 10px 12px; border-radius: 24px; font-size: 14px; font-weight: 600; color: var(--text-secondary); transition: all 0.3s ease; cursor: pointer; gap: 6px; }
        .chat-subtab span { font-size: 20px; }
        .chat-subtab.active { background: var(--accent-blue); color: #fff; }
        /* Floating Action Button - visible only on Groups subtab */
        #fabCreateGroup { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--accent-blue); color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 6px 20px rgba(58,118,240,0.4); z-index: 1500; cursor: pointer; transition: transform 0.2s; }
        #fabCreateGroup.active { display: flex; }
        #fabCreateGroup:active { transform: scale(0.9); }
        .msg-notification {
            position: fixed; top: -80px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px;
            background: var(--glass-white); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,.15);
            display: flex; align-items: center; padding: 12px 16px; gap: 12px; z-index: 6000;
            transition: top .35s cubic-bezier(.4,0,.2,1); backdrop-filter: blur(20px); border: 1px solid var(--border-color);
        }
        .msg-notification.show { top: 12px; }
        .notif-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .notif-text { flex: 1; overflow: hidden; }
        .notif-name { font-weight: 600; font-size: 15px; color: var(--text-primary); }
        .notif-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .notif-close { font-size: 20px; color: var(--text-secondary); cursor: pointer; user-select: none; }
        .story-delete span { font-size: 28px; }
        /* Settings sections */
        .settings-section { background: var(--glass-white); border-radius: 20px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .settings-section h2, .settings-section h3, .settings-section h4 { margin: 0 0 15px 0; font-weight: 600; color: var(--text-primary); }
        .settings-section h2 { font-size: 24px; }
        .settings-section h3 { font-size: 18px; }
        .settings-section h4 { font-size: 14px; color: var(--text-secondary); }
        .profile-upload-section { text-align: center; margin-bottom: 20px; }
        .profile-upload-hint { font-size: 12px; color: var(--text-secondary); margin-top: 8px; }
        .id-hint { font-size: 13px; color: var(--text-secondary); text-align: center; margin: 10px 0 20px; }
        .theme-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .theme-option { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border-radius: 12px; transition: all 0.3s ease; border: 2px solid transparent; }
        .theme-option:hover { background: rgba(0,0,0,0.05); }
        .theme-option.active { border-color: var(--accent-blue); background: rgba(58, 118, 240, 0.1); }
        .theme-preview { width: 40px; height: 40px; border-radius: 50%; position: relative; overflow: hidden; }
        .theme-preview::before, .theme-preview::after { content: ''; position: absolute; width: 50%; height: 100%; }
        .auto-theme { background: linear-gradient(45deg, #ffffff 50%, #000000 50%); }
        .light-theme { background: #ffffff; border: 1px solid #e0e0e0; }
        .dark-theme { background: #1a1a1a; }
        .amoled-theme { background: #000000; }
        .accent-colors { margin-top: 20px; }
        .color-options { display: flex; gap: 12px; flex-wrap: wrap; }
        .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; border: 3px solid transparent; position: relative; }
        .color-option:hover { transform: scale(1.1); }
        .color-option.active { border-color: var(--text-primary); box-shadow: 0 0 0 2px var(--accent-blue); }
        .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s ease; }
        .setting-item:hover { background: rgba(0,0,0,0.02); margin: 0 -20px; padding: 12px 20px; }
        .setting-item:last-child { border-bottom: none; }
        .setting-item span:first-child { font-size: 15px; color: var(--text-primary); }
        .setting-value { font-size: 13px; color: var(--text-secondary); }
        .setting-icon { font-size: 20px; color: var(--text-secondary); }
        .notification-settings, .privacy-settings, .chat-settings, .data-settings, .support-settings { margin-top: 10px; }
        .action-buttons { display: flex; flex-direction: column; gap: 12px; }
        .action-buttons .btn-primary { margin: 0; }
        /* AMOLED Theme */
        [data-theme="amoled"] { --bg-color: #000000; --glass-white: rgba(0, 0, 0, 0.9); --received-bg: #1a1a1a; --border-color: rgba(255,255,255,0.1); }
        /* Responsive */
        @media (max-width: 480px) { .theme-selector { grid-template-columns: repeat(2, 1fr); } .settings-section { padding: 16px; margin-bottom: 16px; } }
        /* Letter Avatar Styles */
        .avatar[src^="data:image"] { object-fit: cover; background: transparent; }
        .user-profile[src^="data:image"], .profile-avatar-large[src^="data:image"], .profile-pic-upload[src^="data:image"], #chatFriendAvatar[src^="data:image"], #detailImg[src^="data:image"], #settingsAvatar[src^="data:image"], #myAvatar[src^="data:image"] { border: 2px solid var(--accent-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        @media (prefers-color-scheme: dark) { .avatar[src^="data:image"] { filter: brightness(0.9) contrast(1.1); } }
        /* Status card letter avatar */
        .status-info img[src^="data:image"] { border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        @media (prefers-color-scheme: dark) { .status-info img[src^="data:image"] { border: 1px solid rgba(255,255,255,0.2); filter: brightness(0.9) contrast(1.1); } }
        /* Story viewer letter avatar */
        #storyHeaderInfo img[src^="data:image"] { border: 2px solid rgba(255,255,255,0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        @media (prefers-color-scheme: dark) { #storyHeaderInfo img[src^="data:image"] { border: 2px solid rgba(255,255,255,0.6); filter: brightness(0.9) contrast(1.1); } }
        /* Profile detail sheet letter avatar */
        .signal-profile-avatar[src^="data:image"] { border: 3px solid var(--accent-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @media (prefers-color-scheme: dark) { .signal-profile-avatar { border-color: #2c2c2e; } .signal-profile-avatar[src^="data:image"] { border-color: var(--accent-blue); filter: brightness(0.9) contrast(1.1); } }
        /* Friend checkbox for group creation */
        .friend-checkbox { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .friend-checkbox:last-child { border-bottom: none; }
        .friend-checkbox input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; }
        .friend-checkbox img { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
        .friend-checkbox span { font-size: 14px; color: var(--text-primary); }
    </style>
</head>
<body>
    <!-- Notification Sound -->
    <audio id="notificationSound" preload="auto">
        <source src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_4e1d8f0b0a.mp3?filename=notification-chime-79921.mp3" type="audio/mpeg">
    </audio>

    <!-- Page Loader -->
    <div id="pageLoader">
        <div class="loader-header shimmer">
            <div class="loader-avatar shimmer"></div>
            <div class="loader-title shimmer"></div>
        </div>
        <div class="loader-main">
            <div class="loader-chat-list">
                <div class="loader-chat-card shimmer">
                    <div class="loader-avatar shimmer"></div>
                    <div class="loader-info">
                        <div class="loader-name shimmer"></div>
                        <div class="loader-msg shimmer"></div>
                    </div>
                </div>
                <div class="loader-chat-card shimmer">
                    <div class="loader-avatar shimmer"></div>
                    <div class="loader-info">
                        <div class="loader-name shimmer"></div>
                        <div class="loader-msg shimmer"></div>
                    </div>
                </div>
                <div class="loader-chat-card shimmer">
                    <div class="loader-avatar shimmer"></div>
                    <div class="loader-info">
                        <div class="loader-name shimmer"></div>
                        <div class="loader-msg shimmer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- Message Notification -->
    <div id="msgNotification" class="msg-notification">
        <img id="notifAvatar" class="notif-avatar" src="" alt="">
        <div class="notif-text">
            <div id="notifName" class="notif-name"></div>
            <div id="notifMsg" class="notif-msg"></div>
        </div>
        <span class="material-symbols-rounded notif-close" onclick="dismissMsgNotif()">close</span>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator">Offline â€¢ Using cached data</div>

    <!-- Header -->
    <header>
        <div onclick="openSheet('settingsSheet')">
            <img id="myAvatar" class="user-profile shimmer" src="">
        </div>
        <div class="app-title">Vynix</div>
        <span class="material-symbols-rounded" style="color:var(--accent-blue); font-size:28px;" onclick="openSheet('addFriendSheet')">add_circle</span>
    </header>

    <!-- Chats Tab -->
    <main id="chatsTab">
        <div class="search-container">
            <input type="text" class="search-input" id="friendSearch" placeholder="Search friends..." onkeyup="searchFriends()">
            <span class="material-symbols-rounded search-icon">search</span>
            <span class="material-symbols-rounded clear-search" id="clearSearch" onclick="clearSearch()">close</span>
        </div>
        <div class="chat-subtabs">
            <div class="chat-subtab active" id="subtabAll" onclick="switchChatSubtab('all')">
                <span class="material-symbols-rounded">chat_bubble</span>All
            </div>
            <div class="chat-subtab" id="subtabFavorites" onclick="switchChatSubtab('favorites')">
                <span class="material-symbols-rounded">star</span>Favorites
            </div>
            <div class="chat-subtab" id="subtabGroups" onclick="switchChatSubtab('groups')">
                <span class="material-symbols-rounded">group</span>Groups
            </div>
        </div>
        <div id="chatList"></div>
    </main>

    <!-- Status Tab -->
    <main id="statusTab">
        <div class="btn-primary" onclick="document.getElementById('fileUpload').click()" style="margin-bottom:20px; background:var(--accent-blue);">
            <span class="material-symbols-rounded" style="vertical-align:middle; margin-right:8px;">add_photo_alternate</span>Post a Moment
        </div>
        <div class="status-grid" id="statusGrid"></div>
    </main>

    <!-- Settings Tab -->
    <main id="settingsTab">
        <!-- Profile Section -->
        <div class="settings-section">
            <h2>Profile</h2>
            <div class="profile-upload-section">
                <img id="settingsAvatar" class="profile-pic-upload shimmer" src="" onclick="document.getElementById('profilePicUpload').click()">
                <div class="profile-upload-hint">Tap to change photo</div>
            </div>
            <input type="text" id="editDisplayName" class="v-input" placeholder="Display Name">
            <div class="my-id-display" id="myVynixIdDisplay">Loading your Vynix ID...</div>
            <p class="id-hint">Share your Vynix ID with friends so they can add you.</p>
        </div>
        <!-- Theme Settings -->
        <div class="settings-section">
            <h3>Appearance</h3>
            <div class="theme-selector">
                <div class="theme-option active" data-theme="auto" onclick="setTheme('auto')">
                    <div class="theme-preview auto-theme"></div>
                    <span>Auto</span>
                </div>
                <div class="theme-option" data-theme="light" onclick="setTheme('light')">
                    <div class="theme-preview light-theme"></div>
                    <span>Light</span>
                </div>
                <div class="theme-option" data-theme="dark" onclick="setTheme('dark')">
                    <div class="theme-preview dark-theme"></div>
                    <span>Dark</span>
                </div>
                <div class="theme-option" data-theme="amoled" onclick="setTheme('amoled')">
                    <div class="theme-preview amoled-theme"></div>
                    <span>AMOLED</span>
                </div>
            </div>
            <div class="accent-colors">
                <h4>Accent Color</h4>
                <div class="color-options">
                    <div class="color-option active" data-color="#3a76f0" style="background: #3a76f0;" onclick="setAccentColor('#3a76f0')"></div>
                    <div class="color-option" data-color="#10b981" style="background: #10b981;" onclick="setAccentColor('#10b981')"></div>
                    <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;" onclick="setAccentColor('#f59e0b')"></div>
                    <div class="color-option" data-color="#ef4444" style="background: #ef4444;" onclick="setAccentColor('#ef4444')"></div>
                    <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;" onclick="setAccentColor('#8b5cf6')"></div>
                    <div class="color-option" data-color="#ec4899" style="background: #ec4899;" onclick="setAccentColor('#ec4899')"></div>
                </div>
            </div>
        </div>
        <!-- Notifications -->
        <div class="settings-section">
            <h3>Notifications</h3>
            <div class="notification-toggle">
                <span class="notification-label">Push Notifications</span>
                <div class="toggle-switch" id="notificationToggle" onclick="toggleNotifications()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="notification-settings">
                <div class="setting-item">
                    <span>Message notifications</span>
                    <div class="toggle-switch active" id="messageNotifs" onclick="toggleSetting('messageNotifs')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Call notifications</span>
                    <div class="toggle-switch active" id="callNotifs" onclick="toggleSetting('callNotifs')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Moment notifications</span>
                    <div class="toggle-switch active" id="momentNotifs" onclick="toggleSetting('momentNotifs')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Sound notifications</span>
                    <div class="toggle-switch" id="soundNotifs" onclick="toggleSetting('soundNotifs')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Vibrate notifications</span>
                    <div class="toggle-switch active" id="vibrateNotifs" onclick="toggleSetting('vibrateNotifs')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Privacy & Security -->
        <div class="settings-section">
            <h3>Privacy & Security</h3>
            <div class="privacy-settings">
                <div class="setting-item" onclick="toggleOnlineStatus()">
                    <span>Show online status</span>
                    <div class="toggle-switch active" id="onlineStatusToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item" onclick="toggleReadReceipts()">
                    <span>Read receipts</span>
                    <div class="toggle-switch active" id="readReceiptsToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item" onclick="toggleLastSeen()">
                    <span>Show last seen</span>
                    <div class="toggle-switch active" id="lastSeenToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item" onclick="toggleProfilePhoto()">
                    <span>Profile photo visibility</span>
                    <div class="toggle-switch active" id="profilePhotoToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chat Settings -->
        <div class="settings-section">
            <h3>Chat Settings</h3>
            <div class="chat-settings">
                <div class="setting-item" onclick="toggleAutoDownload()">
                    <span>Auto-download media</span>
                    <div class="toggle-switch active" id="autoDownloadToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item" onclick="toggleMessagePreview()">
                    <span>Show message preview</span>
                    <div class="toggle-switch active" id="messagePreviewToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item" onclick="toggleEnterSend()">
                    <span>Enter to send</span>
                    <div class="toggle-switch active" id="enterSendToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item" onclick="openFontSizeSettings()">
                    <span>Font size</span>
                    <span class="setting-value" id="fontSizeValue">Medium</span>
                </div>
            </div>
        </div>
        <!-- Data & Storage -->
        <div class="settings-section">
            <h3>Data & Storage</h3>
            <div class="data-settings">
                <div class="setting-item" onclick="clearCache()">
                    <span>Clear cache</span>
                    <span class="setting-value" id="cacheSize">0 MB</span>
                </div>
                <div class="setting-item" onclick="clearMediaCache()">
                    <span>Clear media cache</span>
                    <span class="setting-value" id="mediaCacheSize">0 MB</span>
                </div>
                <div class="setting-item" onclick="exportChatHistory()">
                    <span>Export chat history</span>
                    <span class="material-symbols-rounded setting-icon">download</span>
                </div>
                <div class="setting-item" onclick="manageStorage()">
                    <span>Storage usage</span>
                    <span class="material-symbols-rounded setting-icon">storage</span>
                </div>
            </div>
        </div>
        <!-- Help & Support -->
        <div class="settings-section">
            <h3>Help & Support</h3>
            <div class="support-settings">
                <div class="setting-item" onclick="openHelpCenter()">
                    <span>Help center</span>
                    <span class="material-symbols-rounded setting-icon">help_outline</span>
                </div>
                <div class="setting-item" onclick="sendFeedback()">
                    <span>Send feedback</span>
                    <span class="material-symbols-rounded setting-icon">feedback</span>
                </div>
                <div class="setting-item" onclick="reportBug()">
                    <span>Report a bug</span>
                    <span class="material-symbols-rounded setting-icon">bug_report</span>
                </div>
                <div class="setting-item" onclick="showAppInfo()">
                    <span>About</span>
                    <span class="material-symbols-rounded setting-icon">info</span>
                </div>
            </div>
        </div>
        <!-- Account Actions -->
        <div class="settings-section">
            <div class="action-buttons">
                <button class="btn-primary" onclick="updateProfile()" style="background:var(--accent-blue);">Save Changes</button>
                <button class="btn-primary btn-secondary" onclick="showDeleteAccountDialog()">Delete Account</button>
                <button class="btn-primary btn-secondary" onclick="auth.signOut()">Logout</button>
            </div>
        </div>
    </main>

    <!-- File Inputs -->
    <input type="file" id="fileUpload" hidden accept="image/*,video/*" onchange="validateAndUpload(this.files[0])">
    <input type="file" id="profilePicUpload" hidden accept="image/*" onchange="uploadProfilePicture(this.files[0])">

    <!-- Story Viewer -->
    <div id="storyViewer" onclick="handleStoryTap(event)">
        <div class="story-progress" id="storyProgressBars"></div>
        <div class="story-header" id="storyHeaderInfo"></div>
        <div id="storyMedia"></div>
        <div id="storySoundBtn" class="story-sound-btn" onclick="toggleStorySound(event)">
            <span class="material-symbols-rounded" id="soundIcon">volume_off</span>
        </div>
        <div id="storyDeleteBtn" class="story-delete" style="display:none;" onclick="deleteCurrentStory()">
            <span class="material-symbols-rounded">delete</span>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="pill-nav">
        <div class="nav-item active" id="navChats" onclick="switchTab('chats')">
            <span class="material-symbols-rounded">chat_bubble</span>
        </div>
        <div class="nav-item" id="navStatus" onclick="switchTab('status')">
            <span class="material-symbols-rounded material-symbols--outlined">movie_filter</span>
        </div>
        <div class="nav-item" id="navSettings" onclick="switchTab('settings')">
            <span class="material-symbols-rounded">settings</span>
        </div>
    </div>

    <!-- Floating Action Button for Groups -->
    <div id="fabCreateGroup" onclick="createNewGroup()">
        <span class="material-symbols-rounded">group_add</span>
    </div>

    <!-- Overlays & Sheets -->
    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <!-- Add Friend Sheet -->
    <div class="bottom-sheet" id="addFriendSheet">
        <h2 style="margin-top:0">Add Friend</h2>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:20px;">Enter their unique Vynix ID to start chatting.</p>
        <input type="text" id="friendVynixId" class="v-input" placeholder="e.g. vnx_789">
        <button class="btn-primary" id="addSubmitBtn" onclick="addFriendLogic()" style="background:var(--accent-blue);">Search & Add</button>
    </div>

    <!-- Create Group Sheet -->
    <div class="bottom-sheet" id="createGroupSheet">
        <h2 style="margin-top:0">Create New Group</h2>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:20px;">Create a group to chat with multiple friends.</p>
        
        <div class="profile-upload-section" style="margin-bottom: 20px;">
            <img id="groupPhotoPreview" class="profile-pic-upload" src="" onclick="document.getElementById('groupPhotoUpload').click()" style="width: 80px; height: 80px;">
            <div class="profile-upload-hint">Tap to add group photo</div>
        </div>
        <input type="file" id="groupPhotoUpload" hidden accept="image/*" onchange="previewGroupPhoto(this.files[0])">
        
        <input type="text" id="groupNameInput" class="v-input" placeholder="Group name" maxlength="25">
        
        <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-secondary);">Select Members</h4>
            <div id="friendsList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; padding: 10px;">
                <!-- Friends will be populated here -->
            </div>
        </div>
        
        <button class="btn-primary" id="createGroupBtn" onclick="createGroupLogic()" style="background:var(--accent-blue);">Create Group</button>
        <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCreateGroupSheet()">Cancel</button>
    </div>

    <!-- Profile Detail Sheet -->
    <div class="bottom-sheet" id="profileDetailSheet">
        <div class="signal-profile-header">
            <div class="signal-profile-handle"></div>
            <div class="signal-profile-avatar-section">
                <img id="detailImg" class="signal-profile-avatar" src="" alt="Profile" onerror="this.src=generateLetterAvatar('User')">
                <div class="signal-profile-status-badge" id="detailStatusBadge"></div>
            </div>
            <h2 class="signal-profile-name" id="detailName"></h2>
            <div class="signal-profile-id" id="detailId"></div>
            <div class="signal-profile-status" id="detailStatus"></div>
        </div>
        <div class="signal-profile-actions">
            <button class="signal-action-btn signal-action-primary" onclick="messageFromProfile()">
                <span class="material-symbols-rounded">chat</span>
                <span>Message</span>
            </button>
            <button class="signal-action-btn signal-action-secondary" onclick="startVoiceCallFromProfile()">
                <span class="material-symbols-rounded">call</span>
                <span>Call</span>
            </button>
        </div>
        <div class="signal-profile-info">
            <div class="signal-info-item">
                <span class="signal-info-label">Moments</span>
                <span class="signal-info-value" id="statMoments">0</span>
            </div>
            <div class="signal-divider"></div>
            <div class="signal-info-item">
                <span class="signal-info-label">Messages</span>
                <span class="signal-info-value" id="statMessages">0</span>
            </div>
        </div>
        <button class="signal-danger-btn" onclick="confirmUnfriend()">
            <span class="material-symbols-rounded">person_remove</span>
            Remove Friend
        </button>
    </div>

    <!-- Full Chat View -->
    <div id="fullChatView">
        <div id="chatHeader">
            <span class="material-symbols-rounded" id="chatBackBtn" onclick="closeFullChat()">arrow_back</span>
            <div class="chat-header-avatar-wrapper" onclick="showProfileDetailFromChat()">
                <img id="chatFriendAvatar" src="">
                <div class="chat-header-online" id="chatHeaderOnline" style="display:none;"></div>
            </div>
            <div onclick="showProfileDetailFromChat()" style="flex:1; cursor:pointer;">
                <div id="chatFriendName"></div>
                <div id="chatStatusInfo">Loading...</div>
            </div>
            <div class="chat-header-right">
                <span class="material-symbols-rounded chat-header-icon" onclick="startVoiceCall()">call</span>
                <span class="material-symbols-rounded chat-header-icon" onclick="confirmClearChat()">delete_sweep</span>
            </div>
        </div>
        <div id="messageList">
            <div class="typing-indicator" id="typingIndicator">
                typing
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        <div id="chatInputArea">
            <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleEnter(event)" oninput="updateActionBtn()">
            <span class="material-symbols-rounded" id="actionBtn">mic</span>
        </div>
        <div id="callControls">
            <span class="material-symbols-rounded" style="font-size:36px; color:var(--online-green);">phone_in_talk</span>
            <div id="callTimer">00:00</div>
            <span class="material-symbols-rounded" style="font-size:36px; color:#ff3b30; cursor:pointer;" onclick="endCall()">call_end</span>
        </div>
        <div id="recordingOverlay" class="recording-overlay">
            <span class="material-symbols-rounded" style="font-size:36px; color:#ff3b30;">radio_button_checked</span>
            <div class="recording-timer">00:00</div>
            <div id="recordingWaveform"></div>
            <div class="recording-label">Slide left to cancel</div>
        </div>
    </div>

    <!-- Custom Alerts -->
    <div class="custom-alert" id="deleteMessageAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Delete Message?</div>
            <div class="custom-alert-message">This will delete the message for everyone.</div>
            <button class="btn-primary btn-danger" onclick="confirmDeleteMessage()">Delete for Everyone</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('deleteMessageAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="clearChatAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Clear Chat?</div>
            <div class="custom-alert-message">This will delete all messages in this conversation for everyone.</div>
            <button class="btn-primary btn-danger" onclick="executeClearChat()">Clear Chat</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('clearChatAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="incomingCallAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Incoming Voice Call</div>
            <div class="custom-alert-message">From <span id="callerName"></span></div>
            <button class="btn-primary" style="background:var(--online-green);" onclick="acceptCall()">Accept</button>
            <button class="btn-primary btn-danger" style="margin-top:12px;" onclick="rejectCall()">Reject</button>
        </div>
    </div>

    <div class="custom-alert" id="unfriendModal">
        <h3>Remove Friend?</h3>
        <p style="color:var(--text-secondary); font-size:14px;">This will delete all messages and remove <strong id="unfriendName"></strong> from your contacts.</p>
        <button class="btn-primary btn-danger" onclick="executeUnfriend()">Remove Friend</button>
        <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeUnfriendModal()">Cancel</button>
    </div>

    <div class="bottom-sheet" id="viewsSheet">
        <h2 style="margin:0 0 20px 0;">Views</h2>
        <div id="viewsList"></div>
    </div>

    <div id="avatarEnlargeOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:8000;" onclick="this.style.display='none'">
        <img id="enlargedAvatarImg" style="max-width:90%; max-height:90%; border-radius:20px; object-fit:contain;">
    </div>

    <!-- Settings Custom Alerts -->
    <div class="custom-alert" id="clearCacheAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Clear Cache?</div>
            <div class="custom-alert-message">This will remove temporary files and cached data.</div>
            <button class="btn-primary btn-danger" onclick="executeClearCache()">Clear Cache</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('clearCacheAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="clearMediaCacheAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Clear Media Cache?</div>
            <div class="custom-alert-message">This will remove downloaded images and videos.</div>
            <button class="btn-primary btn-danger" onclick="executeClearMediaCache()">Clear Media</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('clearMediaCacheAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="exportChatAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Export Chat History?</div>
            <div class="custom-alert-message">Your chat history will be prepared for download.</div>
            <button class="btn-primary" onclick="executeExportChat()" style="background:var(--accent-blue);">Export</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('exportChatAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="storageUsageAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Storage Usage</div>
            <div class="custom-alert-message" id="storageUsageContent">Calculating storage usage...</div>
            <button class="btn-primary" onclick="closeCustomAlert('storageUsageAlert')" style="background:var(--accent-blue);">OK</button>
        </div>
    </div>

    <div class="custom-alert" id="customAlertHelp">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Help Center</div>
            <div class="custom-alert-message">You will be redirected to the Vynix Help Center in your browser.</div>
            <button class="btn-primary" style="background:var(--accent-blue);" onclick="openHelpCenterConfirm()">Open</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('customAlertHelp')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="feedbackAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Send Feedback</div>
            <div class="custom-alert-message">We'd love to hear your thoughts!</div>
            <textarea id="feedbackInput" class="v-input" placeholder="Type your feedback here..." style="height:120px; resize:none; margin-bottom:15px;"></textarea>
            <button class="btn-primary" style="background:var(--accent-blue);" onclick="executeSendFeedback()">Send</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('feedbackAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="bugAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Report a Bug</div>
            <div class="custom-alert-message">Help us improve Vynix by describing the issue.</div>
            <textarea id="bugInput" class="v-input" placeholder="Describe what happened..." style="height:120px; resize:none; margin-bottom:15px;"></textarea>
            <button class="btn-primary" style="background:var(--accent-blue);" onclick="executeReportBug()">Submit</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('bugAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="appInfoAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">About Vynix Chats</div>
            <div class="custom-alert-message" style="text-align:left;">
                <strong>Vynix</strong><br>
                Version: 1.0.0<br>
                Build: 2025.01.01<br><br>
                End-to-end encrypted messaging<br>
                Voice calls, ride & moments sharing<br><br>
                Â© 2024 Vynix Technologies
            </div>
            <button class="btn-primary" onclick="closeCustomAlert('appInfoAlert')" style="background:var(--accent-blue);">OK</button>
        </div>
    </div>

    <div class="custom-alert" id="fontSizeAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Font Size</div>
            <div class="custom-alert-message" style="text-align:left;">
                <div class="setting-item" onclick="selectFontSize('Small')" style="justify-content:center;">Small</div>
                <div class="setting-item" onclick="selectFontSize('Medium')" style="justify-content:center;">Medium</div>
                <div class="setting-item" onclick="selectFontSize('Large')" style="justify-content:center;">Large</div>
                <div class="setting-item" onclick="selectFontSize('Extra Large')" style="justify-content:center;">Extra Large</div>
            </div>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('fontSizeAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="deleteAccountConfirmAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Delete Account?</div>
            <div class="custom-alert-message">This will permanently delete your account and all data. This action cannot be undone.</div>
            <button class="btn-primary btn-danger" onclick="showFinalDeleteConfirmation()">Continue</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('deleteAccountConfirmAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="finalDeleteAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Final Confirmation</div>
            <div class="custom-alert-message">Type <strong>DELETE</strong> to permanently delete your account:</div>
            <input type="text" id="deleteConfirmationInput" class="v-input" placeholder="Type DELETE" style="margin-bottom:15px;">
            <button class="btn-primary btn-danger" onclick="executeDeleteAccount()">Delete Account</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('finalDeleteAlert')">Cancel</button>
        </div>
    </div>

    <div class="custom-alert" id="logoutAlert">
        <div class="custom-alert-box">
            <div class="custom-alert-title">Logout?</div>
            <div class="custom-alert-message">You will be signed out of your account.</div>
            <button class="btn-primary btn-danger" onclick="executeLogout()">Logout</button>
            <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeCustomAlert('logoutAlert')">Cancel</button>
        </div>
    </div>

    <!-- Firebase & Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

    <script>
        /* ========== CONFIG ========== */
        const CLOUD_NAME = "dqkujefxj";
        const UPLOAD_PRESET = "banter_box";
        const VAPID_PUBLIC_KEY = 'BDRGi03P4GgR-aTn-qKAYKg98Yx7jpOJhIQYRF9So6ROHdHuEfNWUOBngEhQp4CPw1ZhdiivZbqJy-CrP8PoIy0';
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com/",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const messaging = firebase.messaging();

        /* ========== GLOBAL VARS ========== */
        let currentUser = null;
        let myVId = "";
        let myProfile = { name: "", photo: "" };
        let friendProfileListeners = {};
        let onlineStatusListeners = {};
        let storyQueue = [];
        let storyIndex = 0;
        let storyTimer;
        let cachedChats = {};
        let cachedMoments = {};
        let cachedGroups = {};
        let isOnline = navigator.onLine;
        let currentFriendUid = null;
        let currentGroupId = null;
        let currentRoomId = null;
        let messagesListener = null;
        let lastSeenListener = null;
        let onlineListener = null;
        let typingListener = null;
        let messageToDelete = null;
        let hasShownReactionTutorial = false;
        let currentStoryVideo = null;
        let currentStoryKey = null;
        let currentStoryUid = null;
        let currentStoryTs = null;
        let storyMuted = true;
        let isTransitioning = false;
        let typingTimeout = null;
        let profileDetailFriendUid = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = 0;
        let recordingTimer = null;
        let currentVoiceBlob = null;
        let isRecording = false;
        let currentPlayingAudio = null;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let waveformInterval = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let callTimerInterval = null;
        let isCaller = false;
        let incomingCallListener = null;
        let currentViewedStoryKey = null;
        let currentViewedStoryUid = null;
        let currentViewedStoryTs = null;
        let msgNotifTimeout = null;
        let notificationAudio = null;
        let lastKnownStatus = 'Last seen recently';
        let currentChatSubtab = 'all';
        let favorites = JSON.parse(localStorage.getItem('vynix_favorites') || '{}');
        let sharedKeys = JSON.parse(localStorage.getItem('sharedKeys') || '{}');

        const availableReactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™'];
        const messageInput = document.getElementById('messageInput');
        const actionBtn = document.getElementById('actionBtn');
        const recordingOverlay = document.getElementById('recordingOverlay');

        /* ========== LETTER AVATAR ========== */
        function generateLetterAvatar(name, size = 58) {
            if (!name || typeof name !== 'string') name = 'U';
            const words = name.trim().split(/\s+/);
            let initials = words.length >= 2 ? words[0][0] + words[1][0] : words[0][0];
            initials = initials.toUpperCase().substring(0, 2);
            const colors = ['#3a76f0', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash += name.charCodeAt(i);
            const colorIndex = hash % colors.length;
            const backgroundColor = colors[colorIndex];
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#ffffff';
            ctx.font = `bold ${size * 0.4}px Poppins, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials, size / 2, size / 2);
            return canvas.toDataURL('image/png');
        }

        function setupAvatarWithFallback(imgElement, name, photoUrl) {
            if (photoUrl && photoUrl.trim() !== '') {
                imgElement.src = photoUrl;
                imgElement.onerror = () => { imgElement.src = generateLetterAvatar(name); };
            } else {
                imgElement.src = generateLetterAvatar(name);
            }
        }

        /* ========== PUSH NOTIFICATIONS ========== */
        class PushNotificationManager {
            constructor() {
                this.isSupported = 'Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window;
                this.isSubscribed = false;
                this.subscription = null;
            }
            async init() {
                if (!this.isSupported) return;
                await this.requestPermission();
                if (Notification.permission === 'granted') await this.subscribeToPush();
            }
            async requestPermission() {
                if (Notification.permission === 'granted') { this.isSubscribed = true; return true; }
                if (Notification.permission === 'default') {
                    const p = await Notification.requestPermission();
                    if (p === 'granted') { this.isSubscribed = true; return true; }
                }
                return false;
            }
            async subscribeToPush() {
                if (!this.isSupported || Notification.permission !== 'granted') return null;
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });
                    this.subscription = subscription;
                    await this.saveSubscription(subscription);
                    return subscription;
                } catch (error) {
                    console.log('Failed to subscribe to push:', error);
                    return null;
                }
            }
            async unsubscribeFromPush() {
                if (!this.subscription) return;
                try {
                    await this.subscription.unsubscribe();
                    this.subscription = null;
                    this.isSubscribed = false;
                    if (currentUser) await db.ref(`users/${currentUser.uid}/pushSubscription`).remove();
                } catch (error) {
                    console.log('Failed to unsubscribe:', error);
                }
            }
            async getExistingSubscription() {
                if (!this.isSupported) return null;
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        this.subscription = subscription;
                        return subscription;
                    }
                } catch (error) {
                    console.log('Failed to get existing subscription:', error);
                }
                return null;
            }
            async saveSubscription(subscription) {
                if (!currentUser) return;
                const subscriptionData = subscription.toJSON();
                subscriptionData.timestamp = Date.now();
                await db.ref(`users/${currentUser.uid}/pushSubscription`).set(subscriptionData);
            }
            urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
                return outputArray;
            }
        }
        const pushManager = new PushNotificationManager();

        /* ========== AUTH & INIT ========== */
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initApp();
            } else {
                window.location.href = "login.html";
            }
        });

        async function initApp() {
            const cachedProfile = localStorage.getItem('vynix_profile');
            if (cachedProfile) {
                const data = JSON.parse(cachedProfile);
                myProfile.name = data.name || "";
                myProfile.photo = data.photo || "";
                myVId = data.vynixId || "";
                document.getElementById('myAvatar').src = myProfile.photo;
                document.getElementById('settingsAvatar').src = myProfile.photo;
                document.getElementById('editDisplayName').value = myProfile.name;
                document.getElementById('myAvatar').classList.remove('shimmer');
                document.getElementById('settingsAvatar').classList.remove('shimmer');
                updateMyIdDisplay();
            }
            const cachedChatsStr = localStorage.getItem('vynix_chats');
            if (cachedChatsStr) { cachedChats = JSON.parse(cachedChatsStr); renderChatsFromCache(); }
            const cachedMomentsStr = localStorage.getItem('vynix_moments');
            if (cachedMomentsStr) { cachedMoments = JSON.parse(cachedMomentsStr); renderMomentsFromCache(); }
            listenToMyProfile();
            const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            const data = snap.val() || {};
            if (!data.vynixId) {
                toast('Generating your unique Vynix ID...');
                const newId = await generateAndAssignVynixId();
                if (newId) {
                    myVId = newId;
                    await db.ref(`users/${currentUser.uid}/profile`).update({ vynixId: myVId });
                    await db.ref(`vynix_ids/${myVId}`).set(currentUser.uid);
                    toast(`Your Vynix ID is @${myVId}`);
                }
            }
            if (!localStorage.getItem('privateKey')) {
                toast('Generating encryption keys...');
                const publicJwk = await generateKeyPair();
                await db.ref(`users/${currentUser.uid}/profile`).update({ publicKey: JSON.stringify(publicJwk) });
            }
            hasShownReactionTutorial = localStorage.getItem('reaction_tutorial_shown') === 'true';
            await pushManager.init();
            await checkNotificationStatus();
            messaging.onMessage((payload) => {
                console.log('Foreground message received:', payload);
                const notificationTitle = payload.notification?.title || payload.data?.title || 'New Message';
                const notificationOptions = {
                    body: payload.notification?.body || payload.data?.body || 'You have a new message',
                    icon: payload.notification?.icon || 'https://i.postimg.cc/W3Msxg6q/Gemini-Generated-Image-1oaeg71oaeg71oae.png',
                    badge: 'https://i.postimg.cc/W3Msxg6q/Gemini-Generated-Image-1oaeg71oaeg71oae.png',
                    data: payload.data || {}
                };
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'FOREGROUND_NOTIFICATION',
                        payload: notificationOptions
                    });
                }
                toast(`${notificationTitle}: ${notificationOptions.body}`);
            });
            loadChats();
            // Global listener for new messages (notifications)
            db.ref('messages').on('child_added', outerSnap => {
                const roomId = outerSnap.key;
                if (roomId === currentRoomId) return;
                outerSnap.ref.limitToLast(1).on('child_added', async innerSnap => {
                    const msg = innerSnap.val();
                    if (!msg || msg.sender === currentUser.uid) return;
                    const friendUid = roomId.replace(currentUser.uid, '').replace('_', '');
                    const profSnap = await db.ref(`users/${friendUid}/profile`).once('value');
                    const prof = profSnap.val() || { name: 'User', photo: '' };
                    const letterAvatar = generateLetterAvatar(prof.name || 'User');
                    const senderPhoto = prof.photo || letterAvatar;
                    cachedChats[friendUid] = { ...cachedChats[friendUid], photo: senderPhoto };
                    showMsgNotif(friendUid, prof.name, msg.text || '[Media]', senderPhoto);
                });
            });
            loadMoments();
            loadGroups();
            const myPresenceRef = db.ref(`users/${currentUser.uid}/online`);
            myPresenceRef.set(true);
            myPresenceRef.onDisconnect().set(false);
            db.ref(`users/${currentUser.uid}/lastSeen`).set(firebase.database.ServerValue.TIMESTAMP);
            db.ref(`users/${currentUser.uid}/lastSeen`).onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
            setupIncomingCallListener();
            hidePageLoader();
            switchTab('chats');
            notificationAudio = document.getElementById('notificationSound');
            if (notificationAudio) notificationAudio.load();
        }

        async function hidePageLoader() {
            await new Promise(resolve => setTimeout(resolve, 800));
            const loader = document.getElementById('pageLoader');
            loader.classList.add('fade-out');
            setTimeout(() => loader.style.display = 'none', 400);
        }

        /* ========== PROFILE & KEYS ========== */
        async function generateKeyPair() {
            const keyPair = await window.crypto.subtle.generateKey({ name: "ECDH", namedCurve: "P-256" }, true, ["deriveBits"]);
            const publicKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.publicKey);
            const privateKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.privateKey);
            localStorage.setItem('privateKey', JSON.stringify(privateKeyJwk));
            return publicKeyJwk;
        }

        async function deriveSharedSecret(friendPublicJwk) {
            const privateKeyJwk = JSON.parse(localStorage.getItem('privateKey'));
            const privateKey = await window.crypto.subtle.importKey("jwk", privateKeyJwk, { name: "ECDH", namedCurve: "P-256" }, false, ["deriveBits"]);
            const friendPublicKey = await window.crypto.subtle.importKey("jwk", friendPublicJwk, { name: "ECDH", namedCurve: "P-256" }, false, []);
            const sharedSecret = await window.crypto.subtle.deriveBits({ name: "ECDH", public: friendPublicKey }, privateKey, 256);
            return new Uint8Array(sharedSecret);
        }

        function listenToMyProfile() {
            db.ref(`users/${currentUser.uid}/profile`).on('value', snap => {
                const data = snap.val() || {};
                myProfile.name = data.name || "";
                myProfile.photo = data.photo || "";
                myVId = data.vynixId || myVId;
                if (!myProfile.photo || myProfile.photo.trim() === '') myProfile.photo = generateLetterAvatar(myProfile.name || "User");
                document.getElementById('myAvatar').src = myProfile.photo;
                document.getElementById('settingsAvatar').src = myProfile.photo;
                document.getElementById('editDisplayName').value = myProfile.name;
                document.getElementById('myAvatar').classList.remove('shimmer');
                document.getElementById('settingsAvatar').classList.remove('shimmer');
                updateVisibleMomentsOwnerInfo();
                localStorage.setItem('vynix_profile', JSON.stringify({name: myProfile.name, photo: myProfile.photo, vynixId: myVId}));
                updateMyIdDisplay();
            });
        }

        function updateVisibleMomentsOwnerInfo() {
            if (document.getElementById('storyViewer').style.display === 'block') {
                const header = document.getElementById('storyHeaderInfo');
                if (header.querySelector('b') && header.querySelector('b').textContent === myProfile.name) {
                    header.innerHTML = `<img src="${myProfile.photo}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"> <b>${myProfile.name}</b>`;
                }
            }
        }

        function updateMyIdDisplay() {
            const el = document.getElementById('myVynixIdDisplay');
            if (myVId) {
                el.innerHTML = `Your Vynix ID: <strong>@${myVId}</strong><br><small>Share this to let friends add you</small>`;
            } else {
                el.innerHTML = `<strong>Vynix ID not available</strong><br><small>Check internet or restart app to load your ID</small>`;
            }
        }

        /* ========== FAVORITES & SUBTABS ========== */
        function toggleFavorite(friendUid, chatCard) {
            if (favorites[friendUid]) {
                delete favorites[friendUid];
                chatCard.querySelector('.favorite-indicator')?.remove();
            } else {
                favorites[friendUid] = true;
                let star = document.createElement('span');
                star.className = 'material-symbols-rounded favorite-indicator';
                star.textContent = 'star';
                chatCard.appendChild(star);
            }
            localStorage.setItem('vynix_favorites', JSON.stringify(favorites));
            if (currentChatSubtab !== 'all') filterChatList();
        }

        function filterChatList() {
            const cards = document.querySelectorAll('#chatList .chat-card');
            cards.forEach(card => {
                if (card.classList.contains('group-card')) {
                    card.style.display = currentChatSubtab === 'groups' ? 'flex' : 'none';
                } else if (card.dataset.friendUid) {
                    const uid = card.dataset.friendUid;
                    if (currentChatSubtab === 'all') {
                        card.style.display = 'flex';
                    } else if (currentChatSubtab === 'favorites') {
                        card.style.display = favorites[uid] ? 'flex' : 'none';
                    } else if (currentChatSubtab === 'groups') {
                        card.style.display = 'none';
                    }
                }
            });
        }

        function switchChatSubtab(tab) {
            currentChatSubtab = tab;
            document.querySelectorAll('.chat-subtab').forEach(t => t.classList.remove('active'));
            document.getElementById('subtabAll').classList.toggle('active', tab === 'all');
            document.getElementById('subtabFavorites').classList.toggle('active', tab === 'favorites');
            document.getElementById('subtabGroups').classList.toggle('active', tab === 'groups');
            filterChatList();
            const fab = document.getElementById('fabCreateGroup');
            if (tab === 'groups') {
                fab.classList.add('active');
            } else {
                fab.classList.remove('active');
            }
        }

        /* ========== GROUPS ========== */
        async function loadGroups() {
            db.ref(`users/${currentUser.uid}/groups`).on('value', async snap => {
                const groups = [];
                cachedGroups = {};
                for (const groupId of snap.val() ? Object.keys(snap.val()) : []) {
                    const groupSnap = await db.ref(`groups/${groupId}`).once('value');
                    const groupData = groupSnap.val();
                    if (groupData) {
                        cachedGroups[groupId] = groupData;
                        groups.push({ id: groupId, ...groupData });
                    }
                }
                displayGroups(groups);
                localStorage.setItem('vynix_groups', JSON.stringify(cachedGroups));
            }, (error) => {
                console.log('Groups offline, using cache');
                const cached = localStorage.getItem('vynix_groups');
                if (cached) {
                    cachedGroups = JSON.parse(cached);
                    displayGroups(Object.values(cachedGroups));
                }
            });
        }

        function displayGroups(groups) {
            const list = document.getElementById('chatList');
            const groupCards = list.querySelectorAll('.group-card');
            groupCards.forEach(card => card.remove());

            groups.forEach(group => {
                const lastMsg = group.lastMessage?.text || 'No messages yet';
                const timeAgo = formatTimeAgo(group.lastMessage?.timestamp || group.createdAt);
                const unreadCount = group.unreadCount || 0;

                const groupCard = document.createElement('div');
                groupCard.className = 'chat-card group-card';
                groupCard.dataset.groupId = group.id;
                groupCard.onclick = () => openFullGroupChat(group.id);

                const letterAvatar = generateLetterAvatar(group.name);
                groupCard.innerHTML = `
                    <div class="avatar-box">
                        <img class="avatar" src="${group.photo || letterAvatar}" onerror="this.src='${letterAvatar}'" alt="${group.name}">
                    </div>
                    <div class="chat-info">
                        <span class="chat-name">${group.name}</span>
                        <span class="chat-msg">${lastMsg}</span>
                    </div>
                    ${timeAgo ? `<span class="chat-time">${timeAgo}</span>` : ''}
                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</span>` : ''}
                `;

                const rideCard = list.querySelector('.chat-card');
                if (rideCard) {
                    rideCard.parentNode.insertBefore(groupCard, rideCard.nextSibling);
                } else {
                    list.appendChild(groupCard);
                }
            });
        }

        function createNewGroup() {
            loadFriendsForGroup();
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('createGroupSheet').classList.add('active');
        }

        async function loadFriendsForGroup() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '<div style="text-align:center; padding:20px;">Loading friends...</div>';
            try {
                const snap = await db.ref(`users/${currentUser.uid}/chats`).once('value');
                const friends = [];
                for (const friendUid of Object.keys(snap.val() || {})) {
                    const profileSnap = await db.ref(`users/${friendUid}/profile`).once('value');
                    const profile = profileSnap.val() || { name: "User", photo: "" };
                    friends.push({ uid: friendUid, name: profile.name, photo: profile.photo });
                }
                friendsList.innerHTML = '';
                friends.forEach(friend => {
                    const letterAvatar = generateLetterAvatar(friend.name);
                    const friendItem = document.createElement('div');
                    friendItem.className = 'friend-checkbox';
                    friendItem.innerHTML = `
                        <input type="checkbox" id="friend-${friend.uid}" value="${friend.uid}">
                        <img src="${friend.photo || letterAvatar}" onerror="this.src='${letterAvatar}'" alt="${friend.name}">
                        <span>${friend.name}</span>
                    `;
                    friendsList.appendChild(friendItem);
                });
                if (friends.length === 0) {
                    friendsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">No friends to add yet</div>';
                }
            } catch (error) {
                friendsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Error loading friends</div>';
            }
        }

        function previewGroupPhoto(file) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('groupPhotoPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function createGroupLogic() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            if (!groupName) {
                toast("Please enter a group name");
                return;
            }
            const selectedFriends = [];
            document.querySelectorAll('#friendsList input[type="checkbox"]:checked').forEach(checkbox => {
                selectedFriends.push(checkbox.value);
            });
            if (selectedFriends.length === 0) {
                toast("Please select at least one member");
                return;
            }
            const createBtn = document.getElementById('createGroupBtn');
            createBtn.disabled = true;
            createBtn.innerText = "Creating...";
            try {
                const groupRef = db.ref('groups').push();
                const groupId = groupRef.key;
                const groupData = {
                    name: groupName,
                    createdAt: Date.now(),
                    createdBy: currentUser.uid,
                    members: {
                        [currentUser.uid]: { role: 'admin', joinedAt: Date.now() }
                    },
                    lastMessage: null
                };
                selectedFriends.forEach(friendUid => {
                    groupData.members[friendUid] = { role: 'member', joinedAt: Date.now() };
                });
                const photoFile = document.getElementById('groupPhotoUpload').files[0];
                if (photoFile) {
                    const formData = new FormData();
                    formData.append('file', photoFile);
                    formData.append('upload_preset', UPLOAD_PRESET);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.secure_url) groupData.photo = data.secure_url;
                }
                await groupRef.set(groupData);
                const updates = {};
                updates[`users/${currentUser.uid}/groups/${groupId}`] = true;
                selectedFriends.forEach(friendUid => {
                    updates[`users/${friendUid}/groups/${groupId}`] = true;
                });
                await db.ref().update(updates);
                toast("Group created successfully!");
                closeCreateGroupSheet();
                setTimeout(() => openFullGroupChat(groupId), 500);
            } catch (error) {
                toast("Failed to create group");
                console.error(error);
            } finally {
                createBtn.disabled = false;
                createBtn.innerText = "Create Group";
            }
        }

        function closeCreateGroupSheet() {
            document.getElementById('createGroupSheet').classList.remove('active');
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupPhotoPreview').src = '';
            document.getElementById('groupPhotoUpload').value = '';
        }

        /* ========== GROUP CHAT ========== */
        async function openFullGroupChat(groupId) {
            isTransitioning = true;
            currentGroupId = groupId;
            const groupSnap = await db.ref(`groups/${groupId}`).once('value');
            const groupData = groupSnap.val();
            if (!groupData) {
                toast("Group not found");
                return;
            }
            document.getElementById('chatFriendName').textContent = groupData.name;
            document.getElementById('chatFriendAvatar').src = groupData.photo || generateLetterAvatar(groupData.name);
            const statusEl = document.getElementById('chatStatusInfo');
            statusEl.innerHTML = `<span style="color:var(--text-secondary); font-size:13px;">${Object.keys(groupData.members || {}).length} members</span>`;
            document.getElementById('chatHeaderOnline').style.display = 'none';
            const headerRight = document.querySelector('.chat-header-right');
            headerRight.innerHTML = `
                <span class="material-symbols-rounded chat-header-icon" onclick="showGroupInfo()">info</span>
                <span class="material-symbols-rounded chat-header-icon" onclick="showGroupMembers()">group</span>
                <span class="material-symbols-rounded chat-header-icon" onclick="confirmClearGroupChat()">delete_sweep</span>
            `;
            document.getElementById('fullChatView').style.display = 'flex';
            document.getElementById('chatsTab').style.display = 'none';
            document.getElementById('statusTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.querySelector('.pill-nav').style.display = 'none';
            loadGroupMessages(groupId);
            setTimeout(() => { isTransitioning = false; }, 100);
        }

        function loadGroupMessages(groupId) {
            const list = document.getElementById('messageList');
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Loading messages...</div>';
            messagesListener = db.ref(`groupMessages/${groupId}`).limitToLast(50).on('value', async snap => {
                list.innerHTML = '';
                if (!snap.exists()) {
                    list.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">Start the group conversation!</div>';
                    return;
                }
                const msgs = [];
                snap.forEach(child => {
                    const val = child.val();
                    val.key = child.key;
                    msgs.push(val);
                });
                msgs.sort((a,b) => a.ts - b.ts);
                for (const m of msgs) {
                    const isSent = m.sender === currentUser.uid;
                    const timeStr = formatMessageTime(m.ts);
                    const senderProfile = await getMemberProfile(m.sender);
                    let content = '';
                    let reactionsHtml = renderReactions(m.reactions || {});
                    if (m.deleted) {
                        content = `<div class="deleted-message">This message was deleted</div>`;
                    } else if (m.type === 'voice') {
                        content = `
                            <div class="voice-message ${isSent ? 'sent' : ''}">
                                <div class="voice-play-btn" onclick="toggleAudioPlay(this)">
                                    <span class="material-symbols-rounded">play_arrow</span>
                                </div>
                                <audio src="${m.url}"></audio>
                                <div class="voice-waveform paused"></div>
                                <div class="voice-duration">${formatVoiceDuration(m.duration || 0)}</div>
                            </div>
                            <div class="message-time">${timeStr}</div>
                            ${reactionsHtml}
                        `;
                    } else {
                        const decrypted = decrypt(m.text || '', groupId);
                        content = `
                            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:4px;">${senderProfile.name}</div>
                            ${decrypted}
                            <div class="message-time">${timeStr}</div>
                            ${reactionsHtml}
                        `;
                    }
                    const msgEl = document.createElement('div');
                    msgEl.className = `message ${isSent ? 'sent' : 'received'}`;
                    msgEl.dataset.key = m.key;
                    msgEl.innerHTML = content;
                    if (isSent && !m.deleted) {
                        const deleteIcon = document.createElement('div');
                        deleteIcon.className = 'message-delete-icon material-symbols-rounded';
                        deleteIcon.textContent = 'delete';
                        deleteIcon.onclick = (e) => {
                            e.stopPropagation();
                            messageToDelete = m.key;
                            document.getElementById('deleteMessageAlert').classList.add('active');
                        };
                        msgEl.appendChild(deleteIcon);
                    }
                    msgEl.oncontextmenu = (e) => {
                        e.preventDefault();
                        showReactionPicker(msgEl, m.key);
                    };
                    list.appendChild(msgEl);
                }
                list.scrollTop = list.scrollHeight;
            });
        }

        async function getMemberProfile(memberUid) {
            const cached = localStorage.getItem(`group_member_${memberUid}`);
            if (cached) return JSON.parse(cached);
            const snap = await db.ref(`users/${memberUid}/profile`).once('value');
            const profile = snap.val() || { name: "User", photo: "" };
            localStorage.setItem(`group_member_${memberUid}`, JSON.stringify(profile));
            setTimeout(() => localStorage.removeItem(`group_member_${memberUid}`), 300000);
            return profile;
        }

        /* ========== CHAT & VOICE ========== */
        function updateActionBtn() {
            const hasText = messageInput.value.trim() !== '';
            if (hasText) {
                actionBtn.innerHTML = 'send';
                actionBtn.style.cursor = 'pointer';
                actionBtn.classList.remove('recording');
            } else {
                actionBtn.innerHTML = 'mic';
                actionBtn.style.cursor = 'grab';
            }
        }

        let pressTimer, touchStartX = 0;
        actionBtn.addEventListener('mousedown', (e) => {
            if (messageInput.value.trim() !== '') return;
            pressTimer = setTimeout(() => startVoiceRecording(), 400);
        });
        actionBtn.addEventListener('mouseup', () => {
            clearTimeout(pressTimer);
            if (isRecording) stopAndAutoSendVoice();
        });
        actionBtn.addEventListener('mouseleave', () => {
            clearTimeout(pressTimer);
            if (isRecording) cancelVoiceRecording();
        });
        actionBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (messageInput.value.trim() !== '') return;
            pressTimer = setTimeout(() => startVoiceRecording(), 400);
            if (isRecording) touchStartX = e.touches[0].clientX;
        });
        actionBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            clearTimeout(pressTimer);
            if (isRecording) stopAndAutoSendVoice();
        });
        actionBtn.addEventListener('touchcancel', () => {
            clearTimeout(pressTimer);
            if (isRecording) cancelVoiceRecording();
        });
        actionBtn.addEventListener('touchmove', (e) => {
            if (!isRecording) return;
            const diff = touchStartX - e.touches[0].clientX;
            if (diff > 100) cancelVoiceRecording();
        });
        actionBtn.addEventListener('click', (e) => {
            if (messageInput.value.trim() !== '') {
                e.preventDefault();
                e.stopPropagation();
                sendMessage();
            }
        });

        async function startVoiceRecording() {
            try {
                const preferredMime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false } });
                const options = { mimeType: preferredMime, audioBitsPerSecond: 128000 };
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    currentVoiceBlob = new Blob(audioChunks, { type: preferredMime });
                    stream.getTracks().forEach(track => track.stop());
                    stopWaveformVisualization();
                };
                mediaRecorder.start(250);
                isRecording = true;
                recordingStartTime = Date.now();
                actionBtn.classList.add('recording');
                recordingOverlay.style.display = 'flex';
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                waveformInterval = setInterval(updateWaveform, 50);
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
                    const secs = String(elapsed % 60).padStart(2, '0');
                    document.querySelector('.recording-timer').textContent = `${mins}:${secs}`;
                }, 200);
            } catch (err) {
                toast("Microphone access denied or unavailable");
                console.error(err);
            }
        }

        function updateWaveform() {
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            const waveform = document.getElementById('recordingWaveform');
            waveform.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const bar = document.createElement('div');
                bar.className = 'wave-bar';
                const height = Math.max(4, (dataArray[i * 12] / 255) * 24);
                bar.style.height = `${height}px`;
                waveform.appendChild(bar);
            }
        }

        function stopWaveformVisualization() {
            if (waveformInterval) clearInterval(waveformInterval);
            waveformInterval = null;
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            analyser = null;
            dataArray = null;
            const waveform = document.getElementById('recordingWaveform');
            if (waveform) waveform.innerHTML = '';
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            clearInterval(recordingTimer);
            isRecording = false;
            actionBtn.classList.remove('recording');
            recordingOverlay.style.display = 'none';
            updateActionBtn();
            stopWaveformVisualization();
        }

        function cancelVoiceRecording() {
            stopRecording();
            audioChunks = [];
            currentVoiceBlob = null;
            toast("Recording cancelled");
        }

        async function stopAndAutoSendVoice() {
            stopRecording();
            if (!currentVoiceBlob || currentVoiceBlob.size === 0) return;
            const duration = Math.max(1, Math.round((Date.now() - recordingStartTime) / 1000));
            toast("Sending voice message...");
            const formData = new FormData();
            formData.append('file', currentVoiceBlob, 'voice.webm');
            formData.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                if (data.secure_url) {
                    const key = currentGroupId ? `group_${currentGroupId}` : sharedKeys[currentFriendUid];
                    const encryptedUrl = CryptoJS.AES.encrypt(data.secure_url, key).toString();
                    const msgRef = currentGroupId ? db.ref(`groupMessages/${currentGroupId}`).push() : db.ref(`messages/${currentRoomId}`).push();
                    await msgRef.set({
                        type: 'voice',
                        url: encryptedUrl,
                        duration: duration,
                        sender: currentUser.uid,
                        ts: Date.now(),
                        reactions: {}
                    });
                    if (!currentGroupId) {
                        const updates = {};
                        updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsg`] = encryptedUrl;
                        updates[`users/${currentUser.uid}/chats/${currentFriendUid}/ts`] = Date.now();
                        updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsg`] = encryptedUrl;
                        updates[`users/${currentFriendUid}/chats/${currentUser.uid}/ts`] = Date.now();
                        updates[`users/${currentFriendUid}/chats/${currentUser.uid}/unreadCount`] = firebase.database.ServerValue.increment(1);
                        await db.ref().update(updates);
                    } else {
                        await db.ref(`groups/${currentGroupId}`).update({
                            lastMessage: { text: encryptedUrl, sender: currentUser.uid, timestamp: Date.now() }
                        });
                    }
                    toast("Voice message sent");
                }
            } catch (err) {
                toast("Failed to send voice message");
                console.error(err);
            } finally {
                currentVoiceBlob = null;
                audioChunks = [];
            }
        }

        function formatVoiceDuration(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function toggleAudioPlay(btn) {
            const audio = btn.nextElementSibling;
            const waveform = audio.nextElementSibling.nextElementSibling;
            if (currentPlayingAudio && currentPlayingAudio !== audio) {
                currentPlayingAudio.pause();
                currentPlayingAudio.previousElementSibling.querySelector('span').textContent = 'play_arrow';
                currentPlayingAudio.nextElementSibling.nextElementSibling.classList.remove('playing');
                currentPlayingAudio.nextElementSibling.nextElementSibling.classList.add('paused');
            }
            if (audio.paused) {
                audio.play();
                btn.querySelector('span').textContent = 'pause';
                waveform.classList.add('playing');
                waveform.classList.remove('paused');
                currentPlayingAudio = audio;
            } else {
                audio.pause();
                btn.querySelector('span').textContent = 'play_arrow';
                waveform.classList.remove('playing');
                waveform.classList.add('paused');
                currentPlayingAudio = null;
            }
        }

        /* ========== MESSAGES & REACTIONS ========== */
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            if (currentGroupId) {
                const encrypted = CryptoJS.AES.encrypt(text, `group_${currentGroupId}`).toString();
                const msgRef = db.ref(`groupMessages/${currentGroupId}`).push();
                await msgRef.set({
                    text: encrypted,
                    sender: currentUser.uid,
                    ts: Date.now(),
                    reactions: {}
                });
                await db.ref(`groups/${currentGroupId}`).update({
                    lastMessage: { text: encrypted, sender: currentUser.uid, timestamp: Date.now() }
                });
                messageInput.value = '';
                updateActionBtn();
            } else if (currentFriendUid && currentRoomId) {
                const key = sharedKeys[currentFriendUid];
                const encrypted = CryptoJS.AES.encrypt(text, key).toString();
                const msgRef = db.ref(`messages/${currentRoomId}`).push();
                msgRef.set({
                    text: encrypted,
                    sender: currentUser.uid,
                    ts: Date.now(),
                    reactions: {}
                }).then(() => {
                    const updates = {};
                    updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsg`] = encrypted;
                    updates[`users/${currentUser.uid}/chats/${currentFriendUid}/ts`] = Date.now();
                    updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsg`] = encrypted;
                    updates[`users/${currentFriendUid}/chats/${currentUser.uid}/ts`] = Date.now();
                    updates[`users/${currentFriendUid}/chats/${currentUser.uid}/unreadCount`] = firebase.database.ServerValue.increment(1);
                    return db.ref().update(updates);
                }).then(() => {
                    messageInput.value = '';
                    updateActionBtn();
                }).catch(err => {
                    toast("Failed to send (check internet)");
                    console.error(err);
                });
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function renderReactions(reactions = {}) {
            if (Object.keys(reactions).length === 0) return '';
            let html = '<div class="reactions">';
            Object.keys(reactions).forEach(emoji => {
                const count = reactions[emoji].count || 1;
                const users = reactions[emoji].users || {};
                const isMine = users[currentUser.uid] || false;
                html += `<div class="reaction ${isMine ? 'mine' : ''}">${emoji} ${count > 1 ? count : ''}</div>`;
            });
            html += '</div>';
            return html;
        }

        function showReactionPicker(messageElement, messageKey) {
            document.querySelectorAll('.reaction-picker, .reaction-picker-overlay').forEach(el => el.remove());
            const overlay = document.createElement('div');
            overlay.className = 'reaction-picker-overlay';
            overlay.onclick = () => document.querySelectorAll('.reaction-picker, .reaction-picker-overlay').forEach(el => el.remove());
            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            availableReactions.forEach(emoji => {
                const opt = document.createElement('div');
                opt.textContent = emoji;
                opt.style.cssText = 'font-size:28px; cursor:pointer; padding:8px; border-radius:50%; transition:all .2s; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center;';
                opt.onmouseenter = () => { opt.style.background = '#f0f0f0'; opt.style.transform = 'scale(1.1)'; };
                opt.onmouseleave = () => { opt.style.background = 'transparent'; opt.style.transform = 'scale(1)'; };
                opt.onclick = (e) => {
                    e.stopPropagation();
                    addReaction(messageKey, emoji);
                    document.querySelectorAll('.reaction-picker, .reaction-picker-overlay').forEach(el => el.remove());
                };
                picker.appendChild(opt);
            });
            document.body.appendChild(overlay);
            document.body.appendChild(picker);
            if (navigator.vibrate) navigator.vibrate(10);
        }

        async function addReaction(messageKey, emoji) {
            const roomRef = currentGroupId ? `groupMessages/${currentGroupId}` : `messages/${currentRoomId}`;
            const reactionRef = db.ref(`${roomRef}/${messageKey}/reactions/${emoji}`);
            const snap = await reactionRef.once('value');
            let current = snap.val() || { count: 0, users: {} };
            if (current.users[currentUser.uid]) {
                delete current.users[currentUser.uid];
                current.count--;
                if (current.count <= 0) await reactionRef.remove();
                else await reactionRef.set({ count: current.count, users: current.users });
            } else {
                current.users[currentUser.uid] = true;
                current.count++;
                await reactionRef.set({ count: current.count, users: current.users });
            }
        }

        /* ========== CHAT STATUS & TYPING ========== */
        function updateTypingStatus() {
            if (currentGroupId || !currentRoomId || !currentFriendUid) return;
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            clearTimeout(typingTimeout);
            if (text) {
                db.ref(`typing/${currentRoomId}/${currentUser.uid}`).set(true);
                typingTimeout = setTimeout(() => db.ref(`typing/${currentRoomId}/${currentUser.uid}`).remove(), 2000);
            } else {
                db.ref(`typing/${currentRoomId}/${currentUser.uid}`).remove();
            }
        }

        function listenForTyping() {
            if (!currentRoomId || !currentFriendUid) return;
            if (typingListener) typingListener.off();
            typingListener = db.ref(`typing/${currentRoomId}/${currentFriendUid}`).on('value', snap => {
                document.getElementById('typingIndicator').style.display = snap.val() === true ? 'flex' : 'none';
            });
        }

        /* ========== STATUS / STORIES ========== */
        async function validateAndUpload(file) {
            if (!file) return;
            if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(video.src);
                    if (video.duration > 61) toast("Video too long! (Max 60 seconds)");
                    else performUpload(file, video.duration);
                };
                video.src = URL.createObjectURL(file);
            } else performUpload(file, 0);
        }

        async function performUpload(file, duration = 0) {
            toast("Posting Moment...");
            const form = new FormData();
            form.append('file', file);
            form.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: form });
                const data = await res.json();
                if (data.secure_url) {
                    const pushRef = await db.ref(`moments/${currentUser.uid}`).push();
                    await pushRef.set({
                        url: data.secure_url,
                        type: data.resource_type,
                        ts: Date.now(),
                        name: myProfile.name || "User",
                        photo: myProfile.photo || "",
                        key: pushRef.key,
                        duration: duration > 0 ? Math.min(duration, 60) : 0
                    });
                    toast("Moment is live!");
                } else toast("Upload failed - no URL returned");
            } catch(e) {
                toast("No internet - try again when online");
                console.error("Upload error:", e);
            }
        }

        function loadMoments() {
            db.ref('moments').on('value', snap => {
                const grid = document.getElementById('statusGrid');
                grid.innerHTML = "";
                cachedMoments = {};
                const now = Date.now();
                snap.forEach(userNode => {
                    let items = [];
                    const uid = userNode.key;
                    userNode.forEach(m => {
                        const val = m.val();
                        val.key = m.key;
                        val.uid = uid;
                        if (uid === currentUser.uid) {
                            val.name = myProfile.name || val.name || "User";
                            val.photo = myProfile.photo || val.photo || "";
                        } else {
                            val.name = val.name || "User";
                            val.photo = val.photo || "";
                        }
                        if(now - val.ts < 86400000) items.push(val);
                    });
                    if(items.length) {
                        cachedMoments[uid] = items;
                        const last = items[items.length-1];
                        const isOwn = uid === currentUser.uid;
                        const profileName = last.name || "User";
                        const profilePhoto = last.photo || "";
                        const letterAvatar = generateLetterAvatar(profileName);
                        grid.innerHTML += `
                            <div class="status-card" data-friend-uid="${uid}" onclick="openStories('${uid}')">
                                ${last.type === 'video' ? `<video src="${last.url}" muted loop playsinline></video>` : `<img src="${last.url}">`}
                                <div class="status-info">
                                    <img src="${profilePhoto || letterAvatar}" onerror="this.onerror=null; this.src='${letterAvatar}'" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align:middle;">
                                    <b>${profileName}</b>
                                </div>
                                ${isOwn ? `<div class="status-views" onclick="event.stopPropagation(); showViewsList('${uid}', '${last.key}', '${last.ts}')"><span class="material-symbols-rounded" style="font-size:18px;vertical-align:middle;">visibility</span> 0</div>` : ''}
                            </div>`;
                        setupFriendProfileListener(uid);
                        setupOnlineStatusListener(uid);
                        if (isOwn) {
                            db.ref(`moments/${uid}/${last.key}/views`).on('value', vsnap => {
                                const count = Object.keys(vsnap.val() || {}).length;
                                const badge = grid.querySelector(`.status-card[data-friend-uid="${uid}"] .status-views`);
                                if (badge) {
                                    badge.innerHTML = `<span class="material-symbols-rounded" style="font-size:18px;vertical-align:middle;">visibility</span> ${count}`;
                                    badge.style.display = count > 0 ? 'block' : 'none';
                                }
                            });
                        }
                    }
                });
                localStorage.setItem('vynix_moments', JSON.stringify(cachedMoments));
            }, (error) => {
                console.log('Moments offline, using cache');
                renderMomentsFromCache();
            });
        }

        function renderMomentsFromCache() {
            const grid = document.getElementById('statusGrid');
            grid.innerHTML = "";
            const now = Date.now();
            Object.keys(cachedMoments).forEach(uid => {
                const items = cachedMoments[uid].filter(m => now - m.ts < 86400000);
                if (items.length) {
                    const last = items[items.length - 1];
                    const profileName = last.name || "User";
                    const profilePhoto = last.photo || "";
                    const letterAvatar = generateLetterAvatar(profileName);
                    grid.innerHTML += `
                        <div class="status-card" data-friend-uid="${uid}" onclick="openStoriesCached('${uid}')">
                            ${last.type === 'video' ? `<video src="${last.url}" muted loop playsinline></video>` : `<img src="${last.url}">`}
                            <div class="status-info">
                                <img src="${profilePhoto || letterAvatar}" onerror="this.onerror=null; this.src='${letterAvatar}'" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align:middle;">
                                <b>${profileName}</b>
                            </div>
                        </div>`;
                }
            });
        }

        function openStoriesCached(uid) {
            const now = Date.now();
            storyQueue = cachedMoments[uid]?.filter(m => now - m.ts < 86400000).map(m => ({...m, uid})) || [];
            storyIndex = 0;
            document.getElementById('storyViewer').style.display = 'block';
            showStory();
        }

        async function openStories(uid) {
            setupFriendProfileListener(uid);
            setupOnlineStatusListener(uid);
            const snap = await db.ref(`moments/${uid}`).once('value');
            storyQueue = [];
            const now = Date.now();
            snap.forEach(s => {
                const val = s.val();
                val.key = s.key;
                val.uid = uid;
                if (uid === currentUser.uid) {
                    val.name = myProfile.name || val.name || "User";
                    val.photo = myProfile.photo || val.photo || "";
                } else {
                    val.name = val.name || "User";
                    val.photo = val.photo || "";
                }
                if(now - val.ts < 86400000) storyQueue.push(val);
            });
            storyIndex = 0;
            document.getElementById('storyViewer').style.display = 'block';
            showStory();
        }

        async function deleteCurrentStory() {
            if (!currentStoryKey || !confirm('Delete this moment?')) return;
            await db.ref(`moments/${currentUser.uid}/${currentStoryKey}`).remove();
            toast('Moment deleted');
            closeStoryViewer();
        }

        function toggleStorySound(e) {
            e.stopPropagation();
            if (currentStoryVideo) {
                currentStoryVideo.muted = !currentStoryVideo.muted;
                storyMuted = currentStoryVideo.muted;
                document.getElementById('soundIcon').textContent = storyMuted ? 'volume_off' : 'volume_up';
            }
        }

        function handleStoryTap(e) {
            if (e.target.closest('.story-sound-btn') || e.target.closest('.story-delete')) return;
            const screenWidth = window.innerWidth;
            if(e.clientX < screenWidth / 3) storyIndex--;
            else storyIndex++;
            showStory();
        }

        function closeStoryViewer() {
            clearTimeout(storyTimer);
            if (currentStoryVideo) {
                currentStoryVideo.pause();
                currentStoryVideo = null;
            }
            document.getElementById('storyViewer').style.display = 'none';
            document.getElementById('storySoundBtn').style.display = 'none';
            document.getElementById('storyDeleteBtn').style.display = 'none';
            currentStoryKey = null;
            currentStoryUid = null;
            currentStoryTs = null;
        }

        async function showStory() {
            clearTimeout(storyTimer);
            if (currentStoryVideo) { currentStoryVideo.pause(); currentStoryVideo = null; }
            if(storyIndex >= storyQueue.length) return closeStoryViewer();
            if(storyIndex < 0) storyIndex = 0;
            const story = storyQueue[storyIndex];
            currentStoryKey = story.key;
            currentStoryUid = story.uid;
            currentStoryTs = story.ts;
            markStoryAsViewed(story.uid, story.key);
            const media = document.getElementById('storyMedia');
            const progress = document.getElementById('storyProgressBars');
            const header = document.getElementById('storyHeaderInfo');
            const soundBtn = document.getElementById('storySoundBtn');
            const deleteBtn = document.getElementById('storyDeleteBtn');
            const storyPhoto = story.photo || generateLetterAvatar(story.name);
            header.innerHTML = `<img src="${storyPhoto}" onerror="this.onerror=null; this.src='${generateLetterAvatar(story.name)}'" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"><b>${story.name}</b>`;
            if (story.type === 'video') {
                media.innerHTML = `<video src="${story.url}" autoplay playsinline id="currentStoryVideo"></video>`;
                currentStoryVideo = document.getElementById('currentStoryVideo');
                currentStoryVideo.muted = storyMuted;
                soundBtn.style.display = 'flex';
                document.getElementById('soundIcon').textContent = storyMuted ? 'volume_off' : 'volume_up';
            } else {
                media.innerHTML = `<img src="${story.url}">`;
                soundBtn.style.display = 'none';
            }
            deleteBtn.style.display = (story.uid === currentUser.uid) ? 'flex' : 'none';
            progress.innerHTML = storyQueue.map((_, i) => `
                <div class="progress-segment">
                    <div class="progress-fill" style="width: ${i < storyIndex ? '100%' : '0%'}"></div>
                </div>`).join('');
            setTimeout(() => {
                const bar = progress.querySelectorAll('.progress-fill')[storyIndex];
                const duration = story.type === 'video' ? (story.duration || 60) * 1000 : 5000;
                bar.style.transition = `width ${duration}ms linear`;
                bar.style.width = '100%';
            }, 50);
            const duration = story.type === 'video' ? (story.duration || 60) * 1000 : 5000;
            storyTimer = setTimeout(() => { storyIndex++; showStory(); }, duration);
            if (story.uid === currentUser.uid) {
                const viewsRef = db.ref(`moments/${story.uid}/${story.key}/views`);
                viewsRef.on('value', snap => {
                    const views = snap.val() || {};
                    const count = Object.keys(views).length;
                    let viewsBadge = media.querySelector('.status-views');
                    if (!viewsBadge) {
                        viewsBadge = document.createElement('div');
                        viewsBadge.className = 'status-views';
                        viewsBadge.onclick = (e) => { e.stopPropagation(); showViewsList(story.uid, story.key, story.ts); };
                        media.appendChild(viewsBadge);
                    }
                    viewsBadge.innerHTML = `<span class="material-symbols-rounded" style="font-size:18px;vertical-align:middle;">visibility</span> ${count}`;
                    viewsBadge.style.display = count > 0 ? 'block' : 'none';
                });
            } else {
                let viewsBadge = media.querySelector('.status-views');
                if (viewsBadge) viewsBadge.remove();
            }
        }

        async function markStoryAsViewed(storyUid, storyKey) {
            if (storyUid === currentUser.uid || !currentUser) return;
            const viewRef = db.ref(`moments/${storyUid}/${storyKey}/views/${currentUser.uid}`);
            const snap = await viewRef.once('value');
            if (!snap.exists()) await viewRef.set(firebase.database.ServerValue.TIMESTAMP);
        }

        async function showViewsList(storyUid, storyKey, storyTs) {
            currentViewedStoryUid = storyUid;
            currentViewedStoryKey = storyKey;
            currentViewedStoryTs = storyTs;
            const viewsRef = db.ref(`moments/${storyUid}/${storyKey}/views`);
            const snap = await viewsRef.once('value');
            const views = snap.val() || {};
            const viewerEntries = Object.entries(views).sort((a, b) => b[1] - a[1]);
            const list = document.getElementById('viewsList');
            list.innerHTML = viewerEntries.length ? '' : '<p style="text-align:center;color:#999;">No views yet</p>';
            for (const [uid, viewTs] of viewerEntries) {
                const profileSnap = await db.ref(`users/${uid}/profile`).once('value');
                const profile = profileSnap.val() || { name: 'User', photo: '' };
                const viewTime = formatViewTime(viewTs, storyTs);
                const letterAvatar = generateLetterAvatar(profile.name || 'User');
                const item = document.createElement('div');
                item.className = 'viewer-item';
                item.innerHTML = `
                    <img class="viewer-avatar" src="${profile.photo || letterAvatar}" onerror="this.src='${letterAvatar}'">
                    <div class="viewer-info">
                        <div class="viewer-name">${profile.name}</div>
                        <div class="viewer-time">Viewed at ${viewTime}</div>
                    </div>
                `;
                list.appendChild(item);
            }
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('viewsSheet').classList.add('active');
        }

        function formatViewTime(viewTs, storyTs) {
            const viewDate = new Date(viewTs);
            const storyDate = new Date(storyTs);
            if (viewDate.toDateString() === storyDate.toDateString()) return viewDate.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
            else return viewDate.toLocaleDateString([], {month: 'short', day: 'numeric'});
        }

        /* ========== PROFILE SHEETS ========== */
        function closeAll() {
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
            document.getElementById('overlay').style.display = 'none';
        }

        async function showProfileDetail(uid, e) {
            if (e) e.stopPropagation();
            profileDetailFriendUid = uid;
            setupFriendProfileListener(uid);
            setupOnlineStatusListener(uid);
            try {
                const snap = await db.ref(`users/${uid}/profile`).once('value');
                const data = snap.val() || {};
                document.getElementById('detailName').innerText = data.name || "User";
                document.getElementById('detailId').innerText = "@" + (data.vynixId || "unknown");
                const profilePhoto = data.photo || "";
                const letterAvatar = generateLetterAvatar(data.name || "User");
                const detailImg = document.getElementById('detailImg');
                setupAvatarWithFallback(detailImg, data.name || "User", profilePhoto);
                const onlineSnap = await db.ref(`users/${uid}/online`).once('value');
                const isOnline = onlineSnap.val() === true;
                const statusBadge = document.getElementById('detailStatusBadge');
                const statusText = document.getElementById('detailStatus');
                if (isOnline) {
                    statusBadge.classList.add('online');
                    statusText.innerHTML = '<span style="color: var(--accent-blue);">â—</span> Online';
                } else {
                    statusBadge.classList.remove('online');
                    const lastSeenSnap = await db.ref(`users/${uid}/lastSeen`).once('value');
                    const lastSeen = lastSeenSnap.val();
                    statusText.textContent = lastSeen ? 'Last seen ' + formatTimeAgo(lastSeen) : 'Last seen recently';
                }
                const momentsSnap = await db.ref(`moments/${uid}`).once('value');
                document.getElementById('statMoments').textContent = momentsSnap.numChildren();
                const roomId = currentUser.uid < uid ? currentUser.uid + "_" + uid : uid + "_" + currentUser.uid;
                const messagesSnap = await db.ref(`messages/${roomId}`).limitToLast(100).once('value');
                document.getElementById('statMessages').textContent = messagesSnap.numChildren();
            } catch (err) {
                toast("Offline - some details unavailable");
                document.getElementById('statMoments').textContent = "?";
                document.getElementById('statMessages').textContent = "?";
                const detailImg = document.getElementById('detailImg');
                detailImg.src = generateLetterAvatar("User");
            }
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('profileDetailSheet').classList.add('active');
        }

        function messageFromProfile() {
            closeAll();
            openFullChat(profileDetailFriendUid, document.getElementById('detailName').textContent, document.getElementById('detailImg').src);
        }

        function startVoiceCallFromProfile() {
            closeAll();
            openFullChat(profileDetailFriendUid);
            setTimeout(() => startVoiceCall(), 500);
        }

        function confirmUnfriend() {
            document.getElementById('unfriendName').textContent = document.getElementById('detailName').textContent;
            document.getElementById('unfriendModal').classList.add('active');
            document.getElementById('overlay').style.display = 'block';
        }

        function closeUnfriendModal() {
            document.getElementById('unfriendModal').classList.remove('active');
            document.getElementById('overlay').style.display = 'none';
        }

        async function executeUnfriend() {
            const uid = profileDetailFriendUid;
            if (!uid) return;
            try {
                await db.ref(`users/${currentUser.uid}/chats/${uid}`).remove();
                await db.ref(`users/${uid}/chats/${currentUser.uid}`).remove();
                await db.ref(`messages/${currentUser.uid < uid ? currentUser.uid + "_" + uid : uid + "_" + currentUser.uid}`).remove();
                toast("Friend removed");
            } catch (e) {
                toast("Failed to remove friend");
            }
            closeAll();
            loadChats();
            if (currentFriendUid === uid) closeFullChat();
            if (friendProfileListeners[uid]) db.ref(`users/${uid}/profile`).off('value', friendProfileListeners[uid]);
            if (onlineStatusListeners[uid]) db.ref(`users/${uid}/online`).off('value', onlineStatusListeners[uid]);
            delete friendProfileListeners[uid];
            delete onlineStatusListeners[uid];
        }

        function showProfileDetailFromChat() {
            showProfileDetail(currentFriendUid || currentGroupId);
        }

        /* ========== CALLS ========== */
        function setupIncomingCallListener() {
            incomingCallListener = db.ref(`incomingCalls/${currentUser.uid}`).on('value', async snap => {
                const callData = snap.val();
                if (callData) {
                    const profileSnap = await db.ref(`users/${callData.caller}/profile`).once('value');
                    const profile = profileSnap.val() || { name: "User", photo: "" };
                    document.getElementById('callerName').textContent = profile.name;
                    document.getElementById('incomingCallAlert').classList.add('active');
                    if (currentFriendUid !== callData.caller) {
                        openFullChat(callData.caller, profile.name, profile.photo);
                    }
                    setTimeout(() => {
                        if (document.getElementById('incomingCallAlert').classList.contains('active')) rejectCall();
                    }, 60000);
                }
            });
        }

        async function startVoiceCall() {
            if (!currentRoomId && !currentGroupId) return;
            toast("Starting call...");
            isCaller = true;
            db.ref(`incomingCalls/${currentFriendUid || currentGroupId}`).set({
                caller: currentUser.uid,
                roomId: currentRoomId || currentGroupId,
                ts: Date.now()
            });
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    createPeerConnection();
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
                    peerConnection.createOffer()
                        .then(offer => {
                            peerConnection.setLocalDescription(offer);
                            db.ref(`calls/${currentRoomId || currentGroupId}/offer`).set(offer);
                        });
                    listenForAnswer();
                    listenForICE();
                    document.getElementById('callTimer').textContent = 'Ringing...';
                    document.getElementById('callControls').style.display = 'flex';
                }).catch(err => {
                    toast("Microphone access denied");
                    console.error(err);
                    endCall();
                });
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref(`calls/${currentRoomId || currentGroupId}/iceCandidates`).push(event.candidate.toJSON());
                }
            };
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                const audio = new Audio();
                audio.srcObject = remoteStream;
                audio.play();
            };
            peerConnection.oniceconnectionstatechange = () => {
                if (peerConnection.iceConnectionState === 'disconnected') endCall();
            };
        }

        function listenForAnswer() {
            db.ref(`calls/${currentRoomId || currentGroupId}/answer`).on('value', snap => {
                const answer = snap.val();
                if (answer && !peerConnection.currentRemoteDescription) {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    startCallTimer();
                    document.getElementById('callTimer').textContent = '00:00';
                }
            });
        }

        function listenForICE() {
            db.ref(`calls/${currentRoomId || currentGroupId}/iceCandidates`).on('child_added', snap => {
                const candidate = snap.val();
                if (candidate) peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            });
        }

        function acceptCall() {
            closeCustomAlert('incomingCallAlert');
            toast("Accepting call...");
            isCaller = false;
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    createPeerConnection();
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
                    db.ref(`calls/${currentRoomId || currentGroupId}/offer`).once('value').then(offerSnap => {
                        const offer = offerSnap.val();
                        peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                        peerConnection.createAnswer()
                            .then(answer => {
                                peerConnection.setLocalDescription(answer);
                                db.ref(`calls/${currentRoomId || currentGroupId}/answer`).set(answer);
                            });
                    });
                    listenForICE();
                    startCallTimer();
                    document.getElementById('callControls').style.display = 'flex';
                    db.ref(`incomingCalls/${currentUser.uid}`).remove();
                }).catch(err => {
                    toast("Microphone access denied");
                    rejectCall();
                });
        }

        function rejectCall() {
            closeCustomAlert('incomingCallAlert');
            db.ref(`incomingCalls/${currentUser.uid}`).remove();
            toast("Call rejected");
        }

        function endCall() {
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (peerConnection) peerConnection.close();
            clearInterval(callTimerInterval);
            document.getElementById('callControls').style.display = 'none';
            db.ref(`calls/${currentRoomId || currentGroupId}`).remove();
            db.ref(`incomingCalls/${currentFriendUid || currentGroupId}`).remove();
            db.ref(`incomingCalls/${currentUser.uid}`).remove();
            toast("Call ended");
            isCaller = false;
            localStream = null;
            remoteStream = null;
            peerConnection = null;
        }

        function startCallTimer() {
            let seconds = 0;
            callTimerInterval = setInterval(() => {
                seconds++;
                const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
                const secs = String(seconds % 60).padStart(2, '0');
                document.getElementById('callTimer').textContent = `${mins}:${secs}`;
            }, 1000);
        }

        /* ========== CHAT LIST ========== */
        function renderChatsFromCache() {
            const list = document.getElementById('chatList');
            list.innerHTML = "";
            list.innerHTML += `
                <div class="chat-card" onclick="window.location.href='ride.html'">
                    <div class="avatar-box">
                        <div class="avatar" style="background:#000; display:flex; align-items:center; justify-content:center; color:#fff; font-size:28px;">
                            <span class="material-symbols-rounded">directions_car</span>
                        </div>
                    </div>
                    <div class="chat-info">
                        <span class="chat-name">My Two Minutes Ride</span>
                        <span class="chat-msg">Book a quick & safe ride in just 2 minutes</span>
                    </div>
                    <span class="chat-time">New</span>
                </div>`;
            Object.keys(cachedChats).sort((a,b) => (cachedChats[b].ts || 0) - (cachedChats[a].ts || 0)).forEach(key => {
                const c = cachedChats[key];
                const dMsg = c.lastMsg ? "[Encrypted Message]" : "You are now connected ðŸ”’";
                const timeAgo = formatTimeAgo(c.ts);
                const unreadCount = c.unreadCount || 0;
                const isFav = favorites[key] ? '<span class="material-symbols-rounded favorite-indicator">star</span>' : '';
                list.innerHTML += `
                    <div class="chat-card" data-friend-uid="${key}" onclick="openFullChat('${key}', 'User', '')">
                        <div class="avatar-box" data-friend-uid="${key}" onclick="event.stopPropagation(); showProfileDetail('${key}', event)">
                            <img class="avatar" src="">
                        </div>
                        <div class="chat-info">
                            <span class="chat-name">User</span>
                            <span class="chat-msg">${dMsg}</span>
                        </div>
                        ${timeAgo ? `<span class="chat-time">${timeAgo}</span>` : ''}
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</span>` : ''}
                        ${isFav}
                    </div>`;
            });
            filterChatList();
        }

        async function loadChats() {
            db.ref(`users/${currentUser.uid}/chats`).on('value', async snap => {
                const list = document.getElementById('chatList');
                // Preserve ride card
                const rideCard = list.querySelector('.chat-card[onclick*="ride.html"]');
                list.innerHTML = rideCard ? rideCard.outerHTML : `
                    <div class="chat-card" onclick="window.location.href='ride.html'">
                        <div class="avatar-box">
                            <div class="avatar" style="background:#000; display:flex; align-items:center; justify-content:center; color:#fff; font-size:28px;">
                                <span class="material-symbols-rounded">directions_car</span>
                            </div>
                        </div>
                        <div class="chat-info">
                            <span class="chat-name">My Two Minutes Ride</span>
                            <span class="chat-msg">Book a quick & safe ride in just 2 minutes</span>
                        </div>
                        <span class="chat-time">New</span>
                    </div>`;
                cachedChats = {};
                const chatsArray = [];
                snap.forEach(child => {
                    const data = child.val();
                    cachedChats[child.key] = data;
                    chatsArray.push({ key: child.key, data: data });
                    setupFriendProfileListener(child.key);
                    setupOnlineStatusListener(child.key);
                });
                localStorage.setItem('vynix_chats', JSON.stringify(cachedChats));
                chatsArray.sort((a, b) => (b.data.ts || 0) - (a.data.ts || 0));
                for (const chat of chatsArray) {
                    const friendUid = chat.key;
                    const chatData = chat.data;
                    const profileSnap = await db.ref(`users/${friendUid}/profile`).once('value');
                    const profile = profileSnap.val() || { name: "User", photo: "", publicKey: "" };
                    let dMsg = "You are now connected ðŸ”’";
                    if (chatData.lastMsg) {
                        dMsg = decrypt(chatData.lastMsg, friendUid);
                    }
                    const timeAgo = formatTimeAgo(chatData.ts);
                    const unreadCount = chatData.unreadCount || 0;
                    const isFav = favorites[friendUid] ? '<span class="material-symbols-rounded favorite-indicator">star</span>' : '';
                    const chatCard = document.createElement('div');
                    chatCard.className = 'chat-card';
                    chatCard.dataset.friendUid = friendUid;
                    chatCard.onclick = () => openFullChat(friendUid, profile.name, profile.photo || generateLetterAvatar(profile.name));
                    chatCard.innerHTML = `
                        <div class="avatar-box" data-friend-uid="${friendUid}" onclick="event.stopPropagation(); showProfileDetail('${friendUid}', event)">
                            <img class="avatar" src="${profile.photo || generateLetterAvatar(profile.name)}" onerror="this.src='${generateLetterAvatar(profile.name)}'">
                        </div>
                        <div class="chat-info">
                            <span class="chat-name">${profile.name}</span>
                            <span class="chat-msg">${dMsg}</span>
                        </div>
                        ${timeAgo ? `<span class="chat-time">${timeAgo}</span>` : ''}
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</span>` : ''}
                        ${isFav}
                    `;
                    list.appendChild(chatCard);
                }
                // Re-attach swipe listeners
                document.querySelectorAll('#chatList .chat-card[data-friend-uid]').forEach(card => {
                    let startX = 0;
                    card.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
                    card.addEventListener('touchend', e => {
                        const endX = e.changedTouches[0].clientX;
                        const diff = startX - endX;
                        if (diff > 80) {
                            const uid = card.dataset.friendUid;
                            toggleFavorite(uid, card);
                        }
                    });
                });
                filterChatList();
            }, (error) => {
                console.log('Chats offline, using cache');
                renderChatsFromCache();
            });
        }

        async function openFullChat(friendUid, fallbackName = "User", fallbackPhoto = "") {
            isTransitioning = true;
            markAsRead(friendUid);
            currentFriendUid = friendUid;
            currentGroupId = null;
            currentRoomId = currentUser.uid < friendUid ? currentUser.uid + "_" + friendUid : friendUid + "_" + currentUser.uid;
            const profileSnap = await db.ref(`users/${friendUid}/profile`).once('value');
            const profile = profileSnap.val() || { name: fallbackName, photo: fallbackPhoto, publicKey: "" };
            document.getElementById('chatFriendName').textContent = profile.name;
            document.getElementById('chatFriendAvatar').src = profile.photo || generateLetterAvatar(profile.name);
            document.getElementById('fullChatView').style.display = 'flex';
            document.getElementById('chatsTab').style.display = 'none';
            document.getElementById('statusTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.querySelector('.pill-nav').style.display = 'none';
            if (!profile.publicKey) {
                toast('Chat not end-to-end encrypted - friend needs to update app');
                sharedKeys[currentFriendUid] = currentRoomId;
            } else {
                if (!sharedKeys[currentFriendUid]) {
                    try {
                        const friendPublicJwk = JSON.parse(profile.publicKey);
                        const secret = await deriveSharedSecret(friendPublicJwk);
                        const keyHex = Array.from(secret).map(b => b.toString(16).padStart(2, '0')).join('');
                        sharedKeys[currentFriendUid] = keyHex;
                        localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
                    } catch (e) {
                        toast('Failed to establish secure channel');
                        console.error(e);
                        sharedKeys[currentFriendUid] = currentRoomId;
                    }
                }
            }
            loadMessages();
            updateChatStatus();
            listenForTyping();
            setupFriendProfileListener(friendUid);
            setupOnlineStatusListener(friendUid);
            setTimeout(() => { isTransitioning = false; }, 100);
            if (!hasShownReactionTutorial && document.querySelectorAll('#messageList .message').length > 0) {
                document.getElementById('reactionTutorial').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('reactionTutorial').style.display = 'none';
                    localStorage.setItem('reaction_tutorial_shown', 'true');
                    hasShownReactionTutorial = true;
                }, 5000);
            }
        }

        function updateChatStatus() {
            if (!currentFriendUid) return;
            if (onlineListener) { onlineListener.off(); onlineListener = null; }
            if (lastSeenListener) { lastSeenListener.off(); lastSeenListener = null; }
            const statusEl = document.getElementById('chatStatusInfo');
            statusEl.textContent = lastKnownStatus;
            onlineListener = db.ref(`users/${currentFriendUid}/online`).on('value', snap => {
                const isOnline = snap.val() === true;
                document.getElementById('chatHeaderOnline').style.display = isOnline ? 'block' : 'none';
                if (isOnline) {
                    lastKnownStatus = '<span style="color:var(--online-green);">â—</span> Online';
                    statusEl.innerHTML = lastKnownStatus;
                } else {
                    lastKnownStatus = 'Last seen recently';
                    statusEl.textContent = lastKnownStatus;
                    if (lastSeenListener) lastSeenListener.off();
                    lastSeenListener = db.ref(`users/${currentFriendUid}/lastSeen`).on('value', lsSnap => {
                        const ts = lsSnap.val();
                        if (ts) {
                            lastKnownStatus = 'Last seen ' + formatTimeAgo(ts);
                            statusEl.textContent = lastKnownStatus;
                        } else {
                            lastKnownStatus = 'Last seen recently';
                            statusEl.textContent = lastKnownStatus;
                        }
                    });
                }
            });
        }

        function loadMessages() {
            document.getElementById('messageList').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Loading messages...</div>';
            messagesListener = db.ref(`messages/${currentRoomId}`).limitToLast(50).on('value', snap => {
                const list = document.getElementById('messageList');
                list.innerHTML = '';
                if (!snap.exists()) {
                    list.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">Start the conversation!</div>';
                    return;
                }
                const msgs = [];
                snap.forEach(child => {
                    const val = child.val();
                    val.key = child.key;
                    msgs.push(val);
                });
                msgs.sort((a,b) => a.ts - b.ts);
                msgs.forEach(m => {
                    const isSent = m.sender === currentUser.uid;
                    const timeStr = formatMessageTime(m.ts);
                    let content = '';
                    let reactionsHtml = renderReactions(m.reactions || {});
                    if (m.deleted) {
                        content = `<div class="deleted-message">This message was deleted</div>`;
                    } else if (m.type === 'voice') {
                        const url = decrypt(m.url, currentFriendUid);
                        content = `
                            <div class="voice-message ${isSent ? 'sent' : ''}">
                                <div class="voice-play-btn" onclick="toggleAudioPlay(this)">
                                    <span class="material-symbols-rounded">play_arrow</span>
                                </div>
                                <audio src="${url}"></audio>
                                <div class="voice-waveform paused"></div>
                                <div class="voice-duration">${formatVoiceDuration(m.duration || 0)}</div>
                            </div>
                            <div class="message-time">${timeStr}</div>
                            ${reactionsHtml}
                        `;
                    } else {
                        const decrypted = decrypt(m.text || '', currentFriendUid);
                        content = `
                            ${decrypted}
                            <div class="message-time">${timeStr}</div>
                            ${reactionsHtml}
                        `;
                    }
                    const msgEl = document.createElement('div');
                    msgEl.className = `message ${isSent ? 'sent' : 'received'}`;
                    msgEl.dataset.key = m.key;
                    msgEl.innerHTML = content;
                    if (isSent && !m.deleted) {
                        const deleteIcon = document.createElement('div');
                        deleteIcon.className = 'message-delete-icon material-symbols-rounded';
                        deleteIcon.textContent = 'delete';
                        deleteIcon.onclick = (e) => {
                            e.stopPropagation();
                            messageToDelete = m.key;
                            document.getElementById('deleteMessageAlert').classList.add('active');
                        };
                        msgEl.appendChild(deleteIcon);
                    }
                    msgEl.oncontextmenu = (e) => {
                        e.preventDefault();
                        showReactionPicker(msgEl, m.key);
                    };
                    list.appendChild(msgEl);
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        /* ========== UTILS & UI ========== */
        function decrypt(ciphertext, context) {
            if (!ciphertext) return "[Message]";
            try {
                let key;
                if (currentGroupId) key = `group_${currentGroupId}`;
                else {
                    key = sharedKeys[context];
                    if (!key) return "ðŸ”’ Encrypted (re-open chat to fix)";
                }
                const bytes = CryptoJS.AES.decrypt(ciphertext, key);
                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                return decrypted || "ðŸ”’ Message";
            } catch(e) {
                console.error("Decryption error:", e);
                return "ðŸ”’ Message";
            }
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const now = Date.now();
            const diff = now - timestamp;
            if (diff < 60000) return 'now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d`;
            const date = new Date(timestamp);
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function formatMessageTime(ts) {
            const date = new Date(ts);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function switchTab(tab) {
            document.getElementById('chatsTab').style.display = tab === 'chats' ? 'block' : 'none';
            document.getElementById('statusTab').style.display = tab === 'status' ? 'block' : 'none';
            document.getElementById('settingsTab').style.display = tab === 'settings' ? 'block' : 'none';
            document.getElementById('navChats').classList.toggle('active', tab === 'chats');
            document.getElementById('navStatus').classList.toggle('active', tab === 'status');
            document.getElementById('navSettings').classList.toggle('active', tab === 'settings');
        }

        function searchFriends() {
            const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
            const clearBtn = document.getElementById('clearSearch');
            const chatCards = document.querySelectorAll('#chatList .chat-card');
            clearBtn.style.display = searchTerm ? 'block' : 'none';
            chatCards.forEach(card => {
                const friendName = card.querySelector('.chat-name')?.textContent.toLowerCase() || '';
                const lastMsg = card.querySelector('.chat-msg')?.textContent.toLowerCase() || '';
                card.style.display = (friendName.includes(searchTerm) || lastMsg.includes(searchTerm)) ? 'flex' : 'none';
            });
        }

        function clearSearch() {
            document.getElementById('friendSearch').value = '';
            searchFriends();
        }

        function openSheet(id) {
            document.getElementById('overlay').style.display='block';
            document.getElementById(id).classList.add('active');
            if (id === 'settingsSheet') updateMyIdDisplay();
        }

        function toast(m) {
            const t=document.getElementById('toast');
            t.innerText=m;
            t.style.display='block';
            setTimeout(()=>t.style.display='none',2800);
        }

        function closeCustomAlert(id) {
            document.getElementById(id).classList.remove('active');
            messageToDelete = null;
        }

        async function confirmDeleteMessage() {
            if (!messageToDelete) return;
            const roomRef = currentGroupId ? `groupMessages/${currentGroupId}` : `messages/${currentRoomId}`;
            await db.ref(`${roomRef}/${messageToDelete}`).update({ deleted: true });
            closeCustomAlert('deleteMessageAlert');
            toast('Message deleted for everyone');
        }

        function confirmClearChat() {
            document.getElementById('clearChatAlert').classList.add('active');
        }

        function confirmClearGroupChat() {
            document.getElementById('clearChatAlert').classList.add('active');
        }

        async function executeClearChat() {
            if (!currentRoomId && !currentGroupId) return;
            try {
                if (currentGroupId) await db.ref(`groupMessages/${currentGroupId}`).remove();
                else if (currentRoomId) await db.ref(`messages/${currentRoomId}`).remove();
                toast('Chat history cleared');
            } catch (e) {
                toast('Failed to clear chat');
            }
            closeCustomAlert('clearChatAlert');
        }

        function closeFullChat() {
            isTransitioning = true;
            if (document.getElementById('callControls').style.display === 'flex') endCall();
            const headerRight = document.querySelector('.chat-header-right');
            headerRight.innerHTML = `
                <span class="material-symbols-rounded chat-header-icon" onclick="startVoiceCall()">call</span>
                <span class="material-symbols-rounded chat-header-icon" onclick="confirmClearChat()">delete_sweep</span>
            `;
            document.getElementById('fullChatView').style.display = 'none';
            document.getElementById('chatsTab').style.display = 'block';
            document.querySelector('.pill-nav').style.display = 'flex';
            currentGroupId = null;
            currentFriendUid = null;
            currentRoomId = null;
            document.getElementById('messageList').innerHTML = '';
            document.getElementById('typingIndicator').style.display = 'none';
            if (messagesListener) { messagesListener.off(); messagesListener = null; }
            if (onlineListener) { onlineListener.off(); onlineListener = null; }
            if (lastSeenListener) { lastSeenListener.off(); lastSeenListener = null; }
            if (typingListener) { typingListener.off(); typingListener = null; }
            db.ref(`typing/${currentRoomId}/${currentUser.uid}`).remove();
            document.querySelectorAll('.reaction-picker').forEach(p => p.remove());
            setTimeout(() => { isTransitioning = false; }, 100);
            switchTab('chats');
        }

        async function markAsRead(friendUid) {
            try {
                if (currentUser && friendUid) {
                    await db.ref(`users/${currentUser.uid}/chats/${friendUid}`).update({ unreadCount: 0 });
                }
            } catch (error) {
                console.log("Error marking as read:", error);
            }
        }

        /* ========== NOTIFICATIONS ========== */
        async function checkNotificationStatus() {
            if (pushManager.isSupported && Notification.permission === 'granted') {
                const subscription = await pushManager.getExistingSubscription();
                if (subscription) document.getElementById('notificationToggle').classList.add('active');
            }
        }

        async function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            const enabled = toggle.classList.contains('active');
            if (!enabled) {
                const permission = await pushManager.requestPermission();
                if (permission) {
                    await pushManager.subscribeToPush();
                    toggle.classList.add('active');
                    toast('Notifications enabled!');
                } else {
                    toast('Notification permission denied');
                }
            } else {
                await pushManager.unsubscribeFromPush();
                toggle.classList.remove('active');
                toast('Notifications disabled');
            }
        }

        function showMsgNotif(senderUid, senderName, rawText, senderPhoto) {
            if (senderUid === currentFriendUid || senderUid === currentGroupId) return;
            const notifEl = document.getElementById('msgNotification');
            document.getElementById('notifAvatar').src = senderPhoto || generateLetterAvatar(senderName);
            document.getElementById('notifName').textContent = senderName;
            document.getElementById('notifMsg').textContent = decrypt(rawText, senderUid);
            notifEl.classList.add('show');
            clearTimeout(msgNotifTimeout);
            msgNotifTimeout = setTimeout(() => dismissMsgNotif(), 4000);
            if (notificationAudio) {
                notificationAudio.currentTime = 0;
                notificationAudio.play().catch(e => console.log('Sound play failed:', e));
            }
        }

        function dismissMsgNotif() {
            document.getElementById('msgNotification').classList.remove('show');
        }

        /* ========== SETTINGS & THEME ========== */
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('vynix_theme', theme);
            document.querySelectorAll('.theme-option').forEach(option => option.classList.remove('active'));
            document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            switch(theme) {
                case 'light':
                    root.style.setProperty('--bg-color', '#ffffff');
                    root.style.setProperty('--glass-white', 'rgba(255, 255, 255, 0.95)');
                    root.style.setProperty('--text-primary', '#111827');
                    root.style.setProperty('--text-secondary', '#6b7280');
                    root.style.setProperty('--received-bg', '#e5e5ea');
                    break;
                case 'dark':
                    root.style.setProperty('--bg-color', '#000000');
                    root.style.setProperty('--glass-white', 'rgba(20, 20, 20, 0.85)');
                    root.style.setProperty('--text-primary', '#f9f9f9');
                    root.style.setProperty('--text-secondary', '#a0a0a0');
                    root.style.setProperty('--received-bg', '#2c2c2e');
                    break;
                case 'amoled':
                    root.style.setProperty('--bg-color', '#000000');
                    root.style.setProperty('--glass-white', 'rgba(0, 0, 0, 0.9)');
                    root.style.setProperty('--text-primary', '#ffffff');
                    root.style.setProperty('--text-secondary', '#b0b0b0');
                    root.style.setProperty('--received-bg', '#1a1a1a');
                    break;
                default:
                    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (isDark) applyTheme('dark');
                    else applyTheme('light');
            }
        }

        function setAccentColor(color) {
            document.documentElement.style.setProperty('--accent-blue', color);
            localStorage.setItem('vynix_accent_color', color);
            document.querySelectorAll('.color-option').forEach(option => option.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }

        function toggleSetting(settingId) {
            const toggle = document.getElementById(settingId);
            const isActive = toggle.classList.contains('active');
            if (isActive) toggle.classList.remove('active');
            else toggle.classList.add('active');
            localStorage.setItem(`vynix_${settingId}`, !isActive);
        }

        function toggleOnlineStatus() { toggleSetting('onlineStatusToggle'); }
        function toggleReadReceipts() { toggleSetting('readReceiptsToggle'); }
        function toggleLastSeen() { toggleSetting('lastSeenToggle'); }
        function toggleProfilePhoto() { toggleSetting('profilePhotoToggle'); }
        function toggleAutoDownload() { toggleSetting('autoDownloadToggle'); }
        function toggleMessagePreview() { toggleSetting('messagePreviewToggle'); }
        function toggleEnterSend() { toggleSetting('enterSendToggle'); }

        /* ========== SETTINGS CUSTOM ALERTS ========== */
        function clearCache() { document.getElementById('clearCacheAlert').classList.add('active'); }
        function executeClearCache() {
            localStorage.removeItem('vynix_chats');
            localStorage.removeItem('vynix_moments');
            localStorage.removeItem('vynix_groups');
            toast('Cache cleared successfully');
            updateCacheSize();
            closeCustomAlert('clearCacheAlert');
        }
        function clearMediaCache() { document.getElementById('clearMediaCacheAlert').classList.add('active'); }
        function executeClearMediaCache() { toast('Media cache cleared'); updateMediaCacheSize(); closeCustomAlert('clearMediaCacheAlert'); }
        function exportChatHistory() { document.getElementById('exportChatAlert').classList.add('active'); }
        function executeExportChat() { toast('Chat history exported'); closeCustomAlert('exportChatAlert'); }
        function manageStorage() {
            let usage = 'Calculating...';
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    const used = (estimate.usage / 1024 / 1024).toFixed(1);
                    const total = (estimate.quota / 1024 / 1024 / 1024).toFixed(1);
                    usage = `${used} MB used of ${total} GB`;
                    document.getElementById('storageUsageContent').textContent = usage;
                });
            } else document.getElementById('storageUsageContent').textContent = 'Not available on this browser';
            document.getElementById('storageUsageAlert').classList.add('active');
        }
        function openHelpCenter() { document.getElementById('customAlertHelp').classList.add('active'); }
        function openHelpCenterConfirm() { window.open('https://help.vynix.com', '_blank'); closeCustomAlert('customAlertHelp'); }
        function sendFeedback() { document.getElementById('feedbackInput').value = ''; document.getElementById('feedbackAlert').classList.add('active'); }
        function executeSendFeedback() {
            const feedback = document.getElementById('feedbackInput').value.trim();
            if (feedback) { toast('Feedback sent! Thank you.'); closeCustomAlert('feedbackAlert'); }
            else toast('Please write something');
        }
        function reportBug() { document.getElementById('bugInput').value = ''; document.getElementById('bugAlert').classList.add('active'); }
        function executeReportBug() {
            const bug = document.getElementById('bugInput').value.trim();
            if (bug) { toast('Bug report sent! We\'ll fix it soon.'); closeCustomAlert('bugAlert'); }
            else toast('Please describe the bug');
        }
        function showAppInfo() { document.getElementById('appInfoAlert').classList.add('active'); }
        function openFontSizeSettings() { document.getElementById('fontSizeAlert').classList.add('active'); }
        function selectFontSize(size) {
            localStorage.setItem('vynix_font_size', size);
            document.getElementById('fontSizeValue').textContent = size;
            applyFontSize(size);
            closeCustomAlert('fontSizeAlert');
        }
        function applyFontSize(size) {
            const root = document.documentElement;
            switch(size) {
                case 'Small': root.style.setProperty('--base-font-size', '14px'); break;
                case 'Medium': root.style.setProperty('--base-font-size', '16px'); break;
                case 'Large': root.style.setProperty('--base-font-size', '18px'); break;
                case 'Extra Large': root.style.setProperty('--base-font-size', '20px'); break;
            }
        }
        function updateCacheSize() {
            let size = 0;
            for (let key in localStorage) if (key.startsWith('vynix_')) size += localStorage[key].length;
            document.getElementById('cacheSize').textContent = (size / 1024).toFixed(1) + ' KB';
        }
        function updateMediaCacheSize() { document.getElementById('mediaCacheSize').textContent = '0 MB'; }
        function showDeleteAccountDialog() { document.getElementById('deleteAccountConfirmAlert').classList.add('active'); }
        function showFinalDeleteConfirmation() {
            closeCustomAlert('deleteAccountConfirmAlert');
            document.getElementById('finalDeleteAlert').classList.add('active');
        }
        async function executeDeleteAccount() {
            const input = document.getElementById('deleteConfirmationInput').value.trim();
            if (input !== 'DELETE') { toast('Please type DELETE exactly'); return; }
            try {
                await db.ref(`users/${currentUser.uid}`).remove();
                await auth.currentUser.delete();
                toast('Account deleted');
                window.location.href = 'login.html';
            } catch (e) {
                toast('Error deleting account');
            }
            closeCustomAlert('finalDeleteAlert');
        }
        function executeLogout() {
            auth.signOut();
            closeCustomAlert('logoutAlert');
        }

        /* ========== INITIALIZE ========== */
        function initializeSettings() {
            const savedTheme = localStorage.getItem('vynix_theme') || 'auto';
            setTheme(savedTheme);
            const savedColor = localStorage.getItem('vynix_accent_color') || '#3a76f0';
            setAccentColor(savedColor);
            const settings = [
                'messageNotifs','callNotifs','momentNotifs','soundNotifs','vibrateNotifs',
                'onlineStatusToggle','readReceiptsToggle','lastSeenToggle','profilePhotoToggle',
                'autoDownloadToggle','messagePreviewToggle','enterSendToggle'
            ];
            settings.forEach(setting => {
                const saved = localStorage.getItem(`vynix_${setting}`);
                if (saved !== null) {
                    const el = document.getElementById(setting);
                    if (el) (saved === 'true') ? el.classList.add('active') : el.classList.remove('active');
                }
            });
            updateCacheSize();
            updateMediaCacheSize();
            const savedFontSize = localStorage.getItem('vynix_font_size') || 'Medium';
            document.getElementById('fontSizeValue').textContent = savedFontSize;
            applyFontSize(savedFontSize);
        }

        /* ========== BACK BUTTON ========== */
        function handleBackButton() {
            if (isTransitioning) return;
            if (document.getElementById('fullChatView').style.display === 'flex') closeFullChat();
            else if (document.getElementById('statusTab').style.display === 'block') switchTab('chats');
            else if (document.getElementById('settingsTab').style.display === 'block') switchTab('chats');
            else if (document.getElementById('overlay').style.display === 'block') closeAll();
            else if (document.getElementById('chatsTab').style.display === 'block') {
                if (window.navigator && window.navigator.app && window.navigator.app.exitApp) window.navigator.app.exitApp();
                else try { window.close(); } catch (e) {}
            } else switchTab('chats');
        }

        if (window.cordova) {
            document.addEventListener('deviceready', () => {
                document.addEventListener('backbutton', (e) => {
                    e.preventDefault();
                    handleBackButton();
                }, false);
            }, false);
        } else {
            window.addEventListener('popstate', (e) => {
                e.preventDefault();
                handleBackButton();
                history.pushState(null, null, location.href);
            });
            history.pushState(null, null, location.href);
        }

        /* ========== START ========== */
        document.addEventListener('DOMContentLoaded', () => setTimeout(initializeSettings, 100));
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
        }
    </script>

    <script>
        document.querySelectorAll('img, .avatar, .user-profile, .profile-avatar-large, .profile-pic-upload, #chatFriendAvatar, #detailImg, #settingsAvatar, #myAvatar').forEach(el => {
            el.addEventListener('contextmenu', e => e.preventDefault());
        });
        document.addEventListener('contextmenu', e => {
            if (e.target.tagName === 'IMG' || e.target.closest('.avatar-box')) e.preventDefault();
        });
    </script>
</body>
</html>
