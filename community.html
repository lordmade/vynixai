<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <title>CAPS Lingua â€“ South African Education AI</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="CAPS Lingua">
  <style>
    /* ---------- Design tokens â€“ South African education theme ---------- */
    :root {
      --bg-color: #ffffff;
      --surface-color: #f3f6fc;
      --text-primary: #1e1e1e;
      --text-secondary: #444746;
      --text-muted: #9aa0a6;
      --accent-green: #006400;      /* Dark green from SA flag */
      --accent-gold: #C3995B;       /* Gold from SA flag */
      --accent-blue: #008000;       /* Bright green variant */
      --logo-gradient: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-gold) 50%, var(--accent-blue) 100%);
      --radius-lg: 32px;
      --radius-md: 24px;
      --radius-sm: 16px;
      --shadow-soft: 0 8px 32px rgba(0,0,0,.06);
      --font-main: 'Noto Sans', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: var(--font-main);
      background: transparent;
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
      -webkit-font-smoothing: antialiased;
    }
    #rainCanvas { position: fixed; inset: 0; z-index: -1; background: #ffffff; }
    /* Header (glass-morphism) */
    .header {
      height: 64px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,0,0,.05);
      z-index: 10;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .vynix-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 12px;
      transition: transform .2s;
    }
    .vynix-logo:active { transform: scale(.96); }
    .logo-icon {
      font-size: 26px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-variation-settings: 'FILL' 1, 'wght' 600;
    }
    .logo-text {
      font-family: var(--font-head);
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .lingua-badge {
      background: var(--logo-gradient);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .lang-selector { position: relative; margin-left: auto; margin-right: 12px; }
    .lang-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--surface-color);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      transition: background .2s;
    }
    .lang-btn:hover { background: #e0e0e0; }
    .lang-dropdown {
      position: absolute;
      top: 48px;
      right: 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      padding: 8px;
      min-width: 240px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }
    .lang-dropdown.open { display: block; }
    .lang-option {
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: background .2s;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .lang-option:hover { background: var(--surface-color); }
    .lang-option.active { background: var(--accent-green); color: #fff; }
    .lang-flag { font-size: 20px; }
    .lang-name { font-weight: 600; }
    .lang-native { font-size: 12px; color: var(--text-muted); }
    .lang-option.active .lang-native { color: rgba(255,255,255,.8); }
    .profile-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--surface-color);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background .2s;
    }
    .profile-btn:active { background: #e0e0e0; }
    .profile-btn span { font-size: 24px; }
    /* Chat area */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0 160px;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
    }
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px;
      animation: fadeIn .5s ease;
    }
    .welcome-icon {
      font-size: 64px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 24px;
      font-variation-settings: 'wght' 200;
    }
    .welcome-text {
      font-family: var(--font-head);
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .welcome-sub {
      color: var(--text-muted);
      font-size: 16px;
      max-width: 400px;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    /* Input bar */
    .input-wrapper-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      background: var(--bg-color);
      padding: 12px max(20px, env(safe-area-inset-left)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-right));
      box-shadow: 0 -2px 10px rgba(0,0,0,.04);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .input-wrapper {
      width: 100%;
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(8px);
      border-radius: 28px;
      padding: 6px;
      display: flex;
      align-items: center;
      transition: background .2s, box-shadow .2s;
      border: 1px solid rgba(0,0,0,.06);
    }
    .input-wrapper:focus-within {
      background: #fff;
      box-shadow: var(--shadow-soft);
      border-color: var(--accent-green);
    }
    input {
      flex: 1;
      border: none;
      background: none;
      outline: none;
      font-size: 16px;
      font-family: var(--font-main);
      color: var(--text-primary);
      padding: 12px 14px;
      user-select: text;
    }
    .mic-btn, .send-btn, .translate-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      flex-shrink: 0;
    }
    .mic-btn.listening {
      color: #dc2626;
      background: rgba(220,38,38,.1);
      animation: pulse-red 1.5s infinite;
    }
    .send-btn.active { background: #1e1e1e; color: #fff; }
    .translate-btn.active { background: var(--accent-blue); color: #fff; }
    .send-btn span, .translate-btn span { font-size: 22px; }
    .disclaimer {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
      text-align: center;
      opacity: .8;
    }
    /* Token Counter */
    .token-counter {
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.06);
      z-index: 31;
      white-space: nowrap;
      transition: all .2s;
      pointer-events: none;
    }
    .token-counter.warning { background: rgba(255,193,7,0.95); color: #333; }
    .token-counter.danger { background: rgba(220,38,38,0.95); color: #fff; }
    .token-count { font-weight: 700; color: var(--accent-green); }
    .token-counter.warning .token-count { color: #d97706; }
    .token-counter.danger .token-count { color: #fff; }
    /* Messages */
    .message-row {
      display: flex;
      margin-bottom: 20px;
      max-width: 80%;
      position: relative;
    }
    .timestamp {
      font-size: 10px;
      color: var(--text-muted);
      position: absolute;
      bottom: -15px;
    }
    .message-row.user {
      margin-left: auto;
      text-align: right;
      flex-direction: column;
      align-items: flex-end;
    }
    .message-row.user .timestamp { right: 0; }
    .message-row.ai {
      margin-right: auto;
      padding-left: 50px;
      flex-direction: column;
      align-items: flex-start;
    }
    .message-row.ai .timestamp { left: 50px; }
    .message-content {
      padding: 14px 18px;
      border-radius: 20px;
      line-height: 1.6;
      font-size: 15px;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      display: inline-block;
    }
    .message-row.user .message-content {
      background: var(--logo-gradient);
      color: #fff;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,100,0,.2);
    }
    .message-row.ai .message-content {
      background: rgba(255,255,255,.95);
      border-top-left-radius: 4px;
      box-shadow: var(--shadow-soft);
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      background: var(--logo-gradient);
      color: #fff;
      font-size: 22px;
      left: 0;
      top: -10px;
    }
    .bubble-actions {
      position: absolute;
      right: 8px;
      bottom: 8px;
      display: flex;
      gap: 6px;
    }
    .bubble-btn {
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 12px;
      color: #4b5563;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all .2s;
    }
    .bubble-btn:hover {
      background: #e0e7ff;
      border-color: #c7d2fe;
      color: #3730a3;
    }
    .bubble-btn:active { transform: scale(.96); }
    .bubble-btn.copied {
      background: #dbeafe;
      border-color: #93c5fd;
      color: #1d4ed8;
    }
    .message-content pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 13px;
      margin: 10px -18px;
    }
    .message-content code {
      background: rgba(0,0,0,.05);
      padding: 2px 4px;
      border-radius: 4px;
      font-family: var(--font-mono);
    }
    .message-content pre code { background: none; padding: 0; }
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 18px;
      background: rgba(255,255,255,.95);
      border-radius: 20px;
      border-top-left-radius: 4px;
      box-shadow: var(--shadow-soft);
      width: fit-content;
      margin-bottom: 20px;
    }
    .typing-dots { display: flex; gap: 3px; }
    .typing-dot {
      width: 6px;
      height: 6px;
      background: #9aa0a6;
      border-radius: 50%;
      animation: typingBounce 1.2s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: .1s; }
    .typing-dot:nth-child(3) { animation-delay: .2s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-8px); }
    }
    /* Conversation drawer */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      z-index: 35;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s;
    }
    .drawer-overlay.open { opacity: 1; pointer-events: all; }
    .conversation-drawer {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 320px;
      background: var(--bg-color);
      box-shadow: 4px 0 20px rgba(0,0,0,.1);
      transform: translateX(-100%);
      transition: transform .3s ease-out;
      z-index: 36;
      display: flex;
      flex-direction: column;
    }
    .conversation-drawer.open { transform: translateX(0); }
    .drawer-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0,0,0,.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .drawer-title {
      font-family: var(--font-head);
      font-size: 20px;
      font-weight: 700;
    }
    .new-conversation-btn {
      background: var(--logo-gradient);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .2s, box-shadow .2s;
      box-shadow: 0 2px 8px rgba(0,100,0,.3);
    }
    .new-conversation-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,100,0,.4);
    }
    .conversation-list { flex: 1; overflow-y: auto; padding: 10px 0; }
    .conversation-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: background .2s;
      border-left: 3px solid transparent;
    }
    .conversation-item:hover { background: var(--surface-color); }
    .conversation-item.active {
      background: var(--surface-color);
      border-left-color: var(--accent-green);
    }
    .conversation-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .conversation-preview {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .drawer-toggle-mobile {
      background: none;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      transition: background .2s;
    }
    .drawer-toggle-mobile:hover { background: var(--surface-color); }
    .drawer-toggle-mobile span { font-size: 24px; }
    .desktop-only { display: none; }
    @media (min-width: 768px) {
      .desktop-only { display: flex; }
      .conversation-drawer {
        width: 280px;
        transform: translateX(0);
        position: fixed;
        left: 0;
        top: 64px;
        bottom: 0;
        box-shadow: 2px 0 10px rgba(0,0,0,.05);
        z-index: 5;
      }
      .chat-container {
        margin-left: 280px;
        width: calc(100% - 280px);
      }
      .input-wrapper-fixed {
        left: 280px;
        right: 0;
        transform: none;
        width: auto;
        max-width: none;
      }
      .header {
        left: 280px;
        right: 0;
        width: calc(100% - 280px);
      }
      .drawer-toggle-mobile { display: none; }
      .input-wrapper-fixed {
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 800px;
        border-radius: 24px;
        margin-bottom: 20px;
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(12px);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.08);
      }
    }
    /* Animations */
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(220,38,38,.4); }
      70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); }
      100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Drawer Overlay & Conversation Drawer -->
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <aside class="conversation-drawer" id="conversationDrawer">
    <div class="drawer-header">
      <h2 class="drawer-title">Conversations</h2>
      <button class="new-conversation-btn" id="newConversationBtn" title="New Conversation">
        <span class="material-symbols-rounded">add</span>
      </button>
    </div>
    <div class="conversation-list" id="conversationList"></div>
    <div class="community-pill-container">
      <button class="community-pill" onclick="window.location.href='community.html'">
        <span class="material-symbols-rounded">groups</span>
        <span>Community</span>
      </button>
    </div>
  </aside>

  <!-- Rain Canvas -->
  <canvas id="rainCanvas"></canvas>

  <!-- Snackbar -->
  <div id="customSnackbar"></div>

  <!-- Bottom Sheets -->
  <div class="sheet-overlay" id="sheetOverlay"></div>
  <div class="bottom-sheet" id="userSheet">
    <div class="sheet-header">
      Account Settings
      <button class="sheet-close-btn" onclick="closeSheet('user')"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="user-avatar-large"><span class="material-symbols-rounded">person</span></div>
    <div class="user-email-text" id="userEmail">example@email.com</div>
    <div class="user-info-group">
      <label for="userNameInput">Display Name</label>
      <input type="text" id="userNameInput" class="sheet-input" placeholder="Enter your name">
      <button class="sheet-btn sheet-btn-primary" onclick="updateDisplayName()">Save Name</button>
    </div>
    <button class="sheet-btn sheet-btn-logout" onclick="logout()">
      <span class="material-symbols-rounded" style="font-size:18px">logout</span> Logout
    </button>
  </div>

  <div class="bottom-sheet" id="authSheet">
    <div class="sheet-header">
      Welcome to CAPS Lingua
      <button class="sheet-btn sheet-btn-google" onclick="signInWithGoogle()" aria-label="Sign in with Google">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 18c3.24 0 5.97-1.075 7.956-2.92l-2.908-2.26c-1.075.72-2.456 1.155-4.048 1.155-3.097 0-5.716-2.092-6.655-4.906H.89v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M2.345 10.064A5.367 5.367 0 0 1 2.345 7.94V5.608H.89a8.997 8.997 0 0 0 0 8.088l1.455-1.332z" fill="#FBBC05"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 3.58c1.592 0 3.022.546 4.14 1.61l3.067-3.067C14.97.84 12.24 0 9 0 5.49 0 2.276 1.917.89 4.876l2.455 1.884C3.748 4.67 6.167 3.58 9 3.58z" fill="#EA4335"/>
        </svg>
        <span style="font-family:'Roboto',sans-serif;font-weight:500;font-size:14px;color:#1F1F1F">Sign in with Google</span>
      </button>
    </div>
    <div class="sheet-tab-bar" id="authTabs">
      <div class="sheet-tab active" data-tab="signin">Sign In</div>
      <div class="sheet-tab" data-tab="signup">Sign Up</div>
    </div>
    <div id="signin-content" class="sheet-tab-content">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signInEmail">
      <input type="password" placeholder="Password" class="sheet-input" id="signInPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignIn()">Sign In</button>
    </div>
    <div id="signup-content" class="sheet-tab-content" style="display:none">
      <input type="text" placeholder="Display Name" class="sheet-input" id="signUpName">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signUpEmail">
      <input type="password" placeholder="Password (min 6 chars)" class="sheet-input" id="signUpPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignUp()">Sign Up</button>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <button id="installBtn" class="profile-btn" style="display:none" title="Install app">
      <span class="material-symbols-rounded">download</span>
    </button>
    <div class="header-left">
      <button class="drawer-toggle-mobile" id="drawerToggleMobile">
        <span class="material-symbols-rounded">menu</span>
      </button>
      <div class="vynix-logo desktop-only" onclick="location.reload()">
        <span class="material-symbols-rounded logo-icon">auto_awesome</span>
        <span class="logo-text">CAPS</span>
        <span class="lingua-badge">Lingua</span>
      </div>
    </div>
    <div class="lang-selector">
      <button class="lang-btn" id="langBtn">
        <span class="material-symbols-rounded">translate</span>
        <span id="currentLangText">English</span>
      </button>
      <div class="lang-dropdown" id="langDropdown"></div>
    </div>
    <button class="profile-btn" id="profileBtn">
      <span class="material-symbols-rounded">person</span>
    </button>
  </header>

  <!-- Main Chat Area -->
  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <span class="lingua-badge">Lingua</span>
      <div class="welcome-text" id="welcomeText">Sawubona! How can I help with CAPS?</div>
      <div class="welcome-sub">I'm CAPS Lingua â€“ your South African education AI assistant focused on the CAPS curriculum (Grades R-12). I speak 11 African languages and understand local slang!</div>
    </div>
    <div id="messagesList"></div>
  </main>

  <!-- Input Bar -->
  <div class="input-wrapper-fixed">
    <div class="token-counter" id="tokenCounter">
      <span class="token-count" id="tokenCount">0</span> / <span class="token-limit">10,000</span> tokens
    </div>
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn"><span class="material-symbols-rounded">mic</span></button>
      <input type="text" id="input" placeholder="Ask about CAPS curriculum..." autocomplete="off">
      <button class="translate-btn" id="translateBtn" title="Auto-translate"><span class="material-symbols-rounded">g_translate</span></button>
      <button class="send-btn" id="sendBtn"><span class="material-symbols-rounded">arrow_upward</span></button>
    </div>
    <p class="disclaimer">CAPS Lingua specialises in South African CAPS education. Responses may vary.</p>
  </div>

  <!-- JavaScript -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { collection, query, orderBy, getDocs } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const db = getFirestore(app);

    const DAILY_TOKEN_LIMIT = 10000;
    const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";
    const ELEVENLABS_API_KEY = getString(rc, 'elevenlabs_api_key') || "sk_edbcfd60e4bc635edb37364e12b15ebdcbc0fcf48a810e3b";

    const LANGUAGES = {
      en: { name: 'English', native: 'English', flag: 'ðŸ‡¬ðŸ‡§', code: 'en-US', greeting: 'Hello' },
      zu: { name: 'Zulu', native: 'isiZulu', flag: 'ðŸ‡¿ðŸ‡¦', code: 'zu-ZA', greeting: 'Sawubona' },
      xh: { name: 'Xhosa', native: 'isiXhosa', flag: 'ðŸ‡¿ðŸ‡¦', code: 'xh-ZA', greeting: 'Molo' },
      af: { name: 'Afrikaans', native: 'Afrikaans', flag: 'ðŸ‡¿ðŸ‡¦', code: 'af-ZA', greeting: 'Hallo' },
      st: { name: 'Sotho', native: 'Sesotho', flag: 'ðŸ‡¿ðŸ‡¦', code: 'st-ZA', greeting: 'Lumela' },
      tn: { name: 'Tswana', native: 'Setswana', flag: 'ðŸ‡§ðŸ‡¼', code: 'tn-ZA', greeting: 'Dumela' },
      sw: { name: 'Swahili', native: 'Kiswahili', flag: 'ðŸ‡°ðŸ‡ª', code: 'sw-KE', greeting: 'Jambo' },
      yo: { name: 'Yoruba', native: 'YorÃ¹bÃ¡', flag: 'ðŸ‡³ðŸ‡¬', code: 'yo-NG', greeting: 'Bawo' },
      ig: { name: 'Igbo', native: 'Asá»¥sá»¥ Igbo', flag: 'ðŸ‡³ðŸ‡¬', code: 'ig-NG', greeting: 'Ndewo' },
      ha: { name: 'Hausa', native: 'Hausa', flag: 'ðŸ‡³ðŸ‡¬', code: 'ha-NG', greeting: 'Sannu' },
      am: { name: 'Amharic', native: 'áŠ áˆ›áˆ­áŠ›', flag: 'ðŸ‡ªðŸ‡¹', code: 'am-ET', greeting: 'áˆ°áˆ‹áˆ' }
    };

    const SLANG_DICTIONARY = {
      eish: { lang: 'zu', meaning: 'Expression of surprise or sympathy', translation: 'Oh my!' },
      yebo: { lang: 'zu', meaning: 'Yes', translation: 'Yes' },
      cha: { lang: 'zu', meaning: 'No', translation: 'No' },
      howzit: { lang: 'af', meaning: 'How are you?', translation: 'How are you?' },
      lekker: { lang: 'af', meaning: 'Nice/good', translation: 'Nice' },
      braai: { lang: 'af', meaning: 'Barbecue', translation: 'Barbecue' },
      molo: { lang: 'xh', meaning: 'Hello (singular)', translation: 'Hello' },
      molweni: { lang: 'xh', meaning: 'Hello (plural)', translation: 'Hello everyone' },
      sharp: { lang: 'multi', meaning: 'OK/bye', translation: 'OK' },
      ja: { lang: 'af', meaning: 'Yes', translation: 'Yes' },
      nee: { lang: 'af', meaning: 'No', translation: 'No' },
      ayoba: { lang: 'multi', meaning: 'Awesome/cool', translation: 'Awesome!' },
      'shap shap': { lang: 'multi', meaning: 'Quickly/hurry', translation: 'Hurry up' },
      'now now': { lang: 'multi', meaning: 'Soon', translation: 'In a moment' },
      'just now': { lang: 'multi', meaning: 'Later', translation: 'Later' }
    };

    const fmtDur = s => `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2, '0')}`;

    const ELEVENLABS_VOICE_IDS = {
      en: '21m00Tcm4TlvDq8ikWAM',
      zu: '21m00Tcm4TlvDq8ikWAM',
      xh: '21m00Tcm4TlvDq8ikWAM',
      af: '21m00Tcm4TlvDq8ikWAM',
      st: '21m00Tcm4TlvDq8ikWAM',
      tn: '21m00Tcm4TlvDq8ikWAM',
      sw: '21m00Tcm4TlvDq8ikWAM',
      yo: '21m00Tcm4TlvDq8ikWAM',
      ig: '21m00Tcm4TlvDq8ikWAM',
      ha: '21m00Tcm4TlvDq8ikWAM',
      am: '21m00Tcm4TlvDq8ikWAM'
    };

    let currentLang = 'en';
    let autoTranslate = false;
    let historyStack = [];
    let currentConversationId = null;

    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn'), $mic = $('#micBtn');
    const $translate = $('#translateBtn'), $list = $('#messagesList');
    const $welcome = $('#welcomeScreen'), $welcomeText = $('#welcomeText');
    const $profileBtn = $('#profileBtn'), $userSheet = $('#userSheet');
    const $authSheet = $('#authSheet'), $sheetOverlay = $('#sheetOverlay');
    const $langBtn = $('#langBtn'), $langDropdown = $('#langDropdown');
    const $currentLangText = $('#currentLangText');
    const $customSnackbar = $('#customSnackbar');
    const $tokenCounter = $('#tokenCounter');
    const $tokenCount = $('#tokenCount');

    function initLanguageDropdown() {
      $langDropdown.innerHTML = Object.keys(LANGUAGES).map(code => {
        const lang = LANGUAGES[code];
        return `
          <div class="lang-option ${code === currentLang ? 'active' : ''}" data-lang="${code}">
            <span class="lang-flag">${lang.flag}</span>
            <div class="lang-info">
              <div class="lang-name">${lang.name}</div>
              <div class="lang-native">${lang.native}</div>
            </div>
          </div>
        `;
      }).join('');
      document.querySelectorAll('.lang-option').forEach(opt => {
        opt.addEventListener('click', () => switchLanguage(opt.dataset.lang));
      });
    }

    function switchLanguage(langCode) {
      currentLang = langCode;
      const lang = LANGUAGES[langCode];
      $currentLangText.textContent = lang.name;
      $langDropdown.classList.remove('open');
      document.querySelectorAll('.lang-option').forEach(opt => opt.classList.toggle('active', opt.dataset.lang === langCode));
      updateSystemInstructions();
      showCustomSnackbar(`Language switched to ${lang.name}`);
      const user = auth.currentUser;
      const greeting = user && user.displayName ? `${lang.greeting} ${user.displayName.split(' ')[0]}!` : `${lang.greeting}!`;
      $welcomeText.textContent = `${greeting} How can I help with CAPS?`;
    }

    function updateSystemInstructions() {
      const lang = LANGUAGES[currentLang];
      const systemPrompt = `You are CAPS Lingua, a multilingual South African AI assistant specialized in the CAPS education system (Grades R-12).
CRITICAL INSTRUCTIONS:
1. ALWAYS respond in ${lang.name} when the user's selected language is ${lang.name}.
2. Expert in South African CAPS curriculum: Provide explanations, examples, practice questions, and assessments for subjects like Mathematics, Physical Sciences, Life Sciences, History, Geography, Languages, etc.
3. Structure responses by grade level and CAPS topic/sub-topic when relevant.
4. Understand and interpret South African slang naturally.
5. Be culturally sensitive and relevant to South African learners and educators.
6. Keep explanations clear, step-by-step, and aligned with official CAPS outcomes.
SLANG INTERPRETATION: Recognize and explain terms like "eish", "yebo", "howzit", "lekker", "braai", "sharp", "ayoba" when appropriate.
Keep responses educational, accurate, encouraging, and conversational.`;
      historyStack = [{ role: 'system', content: systemPrompt }];
    }

    $langBtn.addEventListener('click', () => $langDropdown.classList.toggle('open'));
    document.addEventListener('click', e => {
      if (!$langBtn.contains(e.target) && !$langDropdown.contains(e.target)) $langDropdown.classList.remove('open');
    });

    $translate.addEventListener('click', () => {
      autoTranslate = !autoTranslate;
      $translate.classList.toggle('active', autoTranslate);
      showCustomSnackbar(autoTranslate ? 'Auto-translate enabled' : 'Auto-translate disabled');
    });

    function formatTime(date) {
      const h = date.getHours().toString().padStart(2, '0');
      const m = date.getMinutes().toString().padStart(2, '0');
      return `${h}:${m}`;
    }

    function showCustomSnackbar(msg) {
      $customSnackbar.textContent = msg;
      $customSnackbar.classList.add('show');
      setTimeout(() => $customSnackbar.classList.remove('show'), 3000);
    }

    function updateTokenCounter(used, limit = DAILY_TOKEN_LIMIT) {
      $tokenCount.textContent = used.toLocaleString();
      const percentage = (used / limit) * 100;
      $tokenCounter.classList.remove('warning', 'danger');
      if (percentage >= 90) $tokenCounter.classList.add('danger');
      else if (percentage >= 75) $tokenCounter.classList.add('warning');
    }

    async function getCurrentTokenUsage() {
      const user = auth.currentUser;
      if (!user) return 0;
      const uid = user.uid;
      const today = new Date().toISOString().slice(0, 10);
      const usageRef = doc(db, 'tokenUsage', uid);
      const usageSnap = await getDoc(usageRef);
      const data = usageSnap.data() || {};
      return data.date === today ? (data.used || 0) : 0;
    }

    async function initializeTokenCounter() {
      const usage = await getCurrentTokenUsage();
      updateTokenCounter(usage);
    }

    async function updateTokenCounterAfterMessage() {
      const usage = await getCurrentTokenUsage();
      updateTokenCounter(usage);
    }

    async function checkAndUpdateTokenUsage(estimatedTokens) {
      const user = auth.currentUser;
      if (!user) return true;
      const uid = user.uid;
      const today = new Date().toISOString().slice(0, 10);
      const usageRef = doc(db, 'tokenUsage', uid);
      const usageSnap = await getDoc(usageRef);
      const data = usageSnap.data() || {};
      if (data.date !== today) {
        await setDoc(usageRef, { date: today, used: estimatedTokens, timestamp: serverTimestamp() });
        return true;
      }
      const newTotal = data.used + estimatedTokens;
      if (newTotal > DAILY_TOKEN_LIMIT) {
        showCustomSnackbar(`Daily limit reached (${DAILY_TOKEN_LIMIT.toLocaleString()} tokens). Try again tomorrow.`);
        return false;
      }
      await setDoc(usageRef, { used: newTotal, timestamp: serverTimestamp() }, { merge: true });
      return true;
    }

    window.closeSheet = type => {
      $sheetOverlay.classList.remove('open');
      if (type === 'user') $userSheet.classList.remove('open');
      else $authSheet.classList.remove('open');
    };

    window.openSheet = type => {
      $sheetOverlay.classList.add('open');
      if (type === 'user') $userSheet.classList.add('open');
      else $authSheet.classList.add('open');
    };

    $sheetOverlay.addEventListener('click', () => {
      closeSheet('user');
      closeSheet('auth');
    });

    $profileBtn.addEventListener('click', () => {
      const user = auth.currentUser;
      if (user) {
        document.getElementById('userNameInput').value = user.displayName || '';
        document.getElementById('userEmail').textContent = user.email || 'No email';
        openSheet('user');
      } else {
        openSheet('auth');
      }
    });

    document.getElementById('authTabs').addEventListener('click', e => {
      const tab = e.target.closest('.sheet-tab');
      if (!tab) return;
      const target = tab.dataset.tab;
      document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sheet-tab-content').forEach(c => c.style.display = 'none');
      tab.classList.add('active');
      document.getElementById(`${target}-content`).style.display = 'block';
    });

    window.updateDisplayName = async () => {
      const name = document.getElementById('userNameInput').value.trim();
      const user = auth.currentUser;
      if (!user || name === user.displayName) return;
      try {
        await updateProfile(user, { displayName: name });
        showCustomSnackbar('Display name updated!');
        const lang = LANGUAGES[currentLang];
        const greeting = `${lang.greeting} ${name.split(' ')[0]}!`;
        $welcomeText.textContent = `${greeting} How can I help with CAPS?`;
        closeSheet('user');
      } catch (e) {
        showCustomSnackbar('Failed to update name: ' + e.message);
      }
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        showCustomSnackbar('Logged out successfully.');
        closeSheet('user');
      } catch (e) {
        showCustomSnackbar('Logout failed.');
      }
    };

    window.signInWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        showCustomSnackbar('Google Sign-In failed: ' + e.message);
      }
    };

    window.handleSignIn = async () => {
      const email = document.getElementById('signInEmail').value.trim();
      const password = document.getElementById('signInPassword').value;
      if (!email || !password) return showCustomSnackbar('Please enter both email and password.');
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        let msg = 'Sign-In failed.';
        if (e.code === 'auth/user-not-found') msg = 'No user found with this email.';
        else if (e.code === 'auth/wrong-password') msg = 'Incorrect password.';
        showCustomSnackbar(msg);
      }
    };

    window.handleSignUp = async () => {
      const name = document.getElementById('signUpName').value.trim();
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value;
      if (!name || !email || password.length < 6) return showCustomSnackbar('Please enter valid details (password min 6 chars).');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: name });
      } catch (e) {
        let msg = 'Sign-Up failed.';
        if (e.code === 'auth/email-already-in-use') msg = 'Email already in use.';
        showCustomSnackbar(msg);
      }
    };

    onAuthStateChanged(auth, async user => {
      const lang = LANGUAGES[currentLang];
      if (user) {
        const firstName = user.displayName ? user.displayName.split(' ')[0] : '';
        $welcomeText.textContent = firstName ? `${lang.greeting} ${firstName}! How can I help with CAPS?` : `${lang.greeting}! How can I help with CAPS?`;
        closeSheet('auth');
        await initializeTokenCounter();
        await loadConversations();
      } else {
        $welcomeText.textContent = `${lang.greeting}! How can I help with CAPS?`;
        $('#conversationList').innerHTML = '';
        currentConversationId = null;
      }
    });

    function parseMarkdown(text) {
      let html = text.replace(/```([\s\S]*?)```/g, (m, c) => `<pre><code>${c.trim()}</code></pre>`);
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>')
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\*(.*?)\*/g, '<em>$1</em>');
      html = html.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>');
      if (html.includes('<li>')) {
        html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
        html = html.replace(/<\/ul><ul>/g, '');
      }
      html = html.split('<pre>').map((seg, i) => i % 2 === 0 ? seg.replace(/\n/g, '<br>') : seg).join('<pre>');
      html = html.replace(/<br><pre>/g, '<pre>').replace(/<\/pre><br>/g, '</pre>');
      return html;
    }

    function detectSlang(text) {
      const words = text.toLowerCase().split(/\s+/);
      const detected = [];
      for (const w of words) if (SLANG_DICTIONARY[w]) detected.push({ word: w, ...SLANG_DICTIONARY[w] });
      return detected;
    }

    function addMessage(text, type, showLangBadge = false) {
      $welcome.style.display = 'none';
      const row = document.createElement('div');
      row.className = `message-row ${type}`;
      const content = document.createElement('div');
      content.className = 'message-content';
      content.innerHTML = parseMarkdown(text);
      if (showLangBadge && currentLang !== 'en') {
        const badge = document.createElement('div');
        badge.className = 'lang-badge-msg';
        badge.textContent = LANGUAGES[currentLang].native;
        content.appendChild(badge);
      }
      const time = document.createElement('div');
      time.className = 'timestamp';
      time.textContent = formatTime(new Date());
      if (type === 'ai') {
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
        const bubble = document.createElement('div');
        bubble.className = 'message-content';
        bubble.innerHTML = parseMarkdown(text);
        const actions = document.createElement('div');
        actions.className = 'bubble-actions';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'bubble-btn';
        copyBtn.innerHTML = `<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="10" height="10" rx="2"/><path d="M6 2v4h4"/></svg>`;
        copyBtn.title = 'Copy';
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(text);
          copyBtn.classList.add('copied');
          setTimeout(() => copyBtn.classList.remove('copied'), 1500);
        };
        const speakBtn = document.createElement('button');
        speakBtn.className = 'bubble-btn';
        speakBtn.innerHTML = `<span class="material-symbols-rounded">volume_up</span>`;
        speakBtn.title = 'Speak';
        speakBtn.onclick = async () => {
          speakBtn.disabled = true;
          speakBtn.innerHTML = `<span class="material-symbols-rounded">hourglass_empty</span>`;
          try {
            const voiceId = ELEVENLABS_VOICE_IDS[currentLang] || ELEVENLABS_VOICE_IDS.en;
            const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`, {
              method: 'POST',
              headers: {
                'xi-api-key': ELEVENLABS_API_KEY,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                text,
                model_id: 'eleven_multilingual_v2',
                voice_settings: { stability: 0.5, similarity_boost: 0.85 }
              })
            });
            if (!res.ok) throw new Error('TTS failed');
            const blob = await res.blob();
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play();
          } catch (e) {
            showCustomSnackbar('Speech failed');
          } finally {
            speakBtn.innerHTML = `<span class="material-symbols-rounded">volume_up</span>`;
            speakBtn.disabled = false;
          }
        };
        actions.append(copyBtn, speakBtn);
        bubble.appendChild(actions);
        row.append(avatar, bubble, time);
      } else {
        row.append(content, time);
      }
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function addLoading() {
      const row = document.createElement('div');
      row.id = 'loading';
      row.className = 'message-row ai';
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
      const typing = document.createElement('div');
      typing.className = 'typing-indicator';
      typing.innerHTML = `
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <span style="font-size:14px;color:#666;margin-left:8px">CAPS Lingua is thinkingâ€¦</span>
      `;
      row.append(avatar, typing);
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function removeLoading() {
      const loading = $('#loading');
      if (loading) loading.remove();
    }

    function generateTitle(message) {
      const title = message.substring(0, 50);
      return title.length < message.length ? title + '...' : title;
    }

    async function saveConversation(messages, title = null) {
      const user = auth.currentUser;
      if (!user) return;
      const conversationId = currentConversationId || `conv_${Date.now()}`;
      const firstUserMsg = messages.find(m => m.role === 'user')?.content || 'New chat';
      const data = {
        id: conversationId,
        title: title || generateTitle(firstUserMsg),
        messages,
        lastMessage: new Date().toISOString(),
        updatedAt: serverTimestamp()
      };
      try {
        await setDoc(doc(db, 'conversations', user.uid, 'userConversations', conversationId), data, { merge: true });
        currentConversationId = conversationId;
        await loadConversations();
      } catch (e) {
        console.error('saveConversation', e);
        showCustomSnackbar('Could not save chat');
      }
    }

    async function loadConversations() {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const q = query(collection(db, 'conversations', user.uid, 'userConversations'), orderBy('updatedAt', 'desc'));
        const snap = await getDocs(q);
        const list = [];
        snap.forEach(d => list.push(d.data()));
        renderConversations(list);
      } catch (e) {
        console.error('loadConversations', e);
        showCustomSnackbar('Failed to load conversations');
      }
    }

    function renderConversations(conversations) {
      const conversationList = $('#conversationList');
      conversationList.innerHTML = '';
      if (conversations.length === 0) {
        conversationList.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
            <span class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">chat_bubble_outline</span>
            <p>No conversations yet</p>
            <p style="font-size: 13px; margin-top: 8px;">Start chatting to see them here</p>
          </div>
        `;
        return;
      }
      conversations.forEach(conv => {
        const item = document.createElement('div');
        item.className = `conversation-item ${conv.id === currentConversationId ? 'active' : ''}`;
        item.onclick = () => loadConversation(conv.id);
        const lastMsg = conv.messages?.[conv.messages.length - 1];
        const preview = lastMsg?.content?.substring(0, 60) || 'No messages';
        const time = new Date(conv.lastMessage).toLocaleDateString();
        item.innerHTML = `
          <div class="conversation-title">${conv.title}</div>
          <div class="conversation-preview">${preview}${preview.length < (lastMsg?.content?.length || 0) ? '...' : ''}</div>
          <div class="conversation-time">${time}</div>
        `;
        conversationList.appendChild(item);
      });
    }

    async function loadConversation(conversationId) {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const convDoc = await getDoc(doc(db, 'conversations', user.uid, 'userConversations', conversationId));
        if (convDoc.exists()) {
          const conversation = convDoc.data();
          $list.innerHTML = '';
          $welcome.style.display = 'none';
          conversation.messages.forEach(msg => {
            if (msg.role !== 'system') {
              addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai', msg.role === 'ai' && currentLang !== 'en');
            }
          });
          currentConversationId = conversationId;
          historyStack = conversation.messages;
          if (window.innerWidth < 768) closeDrawer();
          await loadConversations();
        }
      } catch (error) {
        console.error('Error loading conversation:', error);
        showCustomSnackbar('Failed to load conversation');
      }
    }

    function startNewConversation() {
      currentConversationId = null;
      historyStack = [{ role: 'system', content: historyStack[0]?.content || updateSystemInstructions() }];
      $list.innerHTML = '';
      $welcome.style.display = 'flex';
      if (window.innerWidth < 768) closeDrawer();
      showCustomSnackbar('New conversation started');
    }

    function openDrawer() {
      $('#drawerOverlay').classList.add('open');
      $('#conversationDrawer').classList.add('open');
      loadConversations();
    }

    function closeDrawer() {
      $('#drawerOverlay').classList.remove('open');
      $('#conversationDrawer').classList.remove('open');
    }

    $('#drawerToggleMobile').addEventListener('click', openDrawer);
    $('#drawerOverlay').addEventListener('click', closeDrawer);
    $('#newConversationBtn').addEventListener('click', startNewConversation);

    window.sendMessage = async () => {
      const msg = $i.value.trim();
      if (!msg) return;
      if (!auth.currentUser) {
        showCustomSnackbar('You must be logged in to chat.');
        openSheet('auth');
        return;
      }
      $i.value = '';
      $send.classList.remove('active');
      addMessage(msg, 'user');
      const slang = detectSlang(msg);
      if (slang.length > 0 && (msg.toLowerCase().includes('what does') || msg.toLowerCase().includes('meaning'))) {
        const expl = slang.map(s => `**${s.word}** (${LANGUAGES[s.lang].name}): ${s.meaning} â€“ "${s.translation}"`).join('\n\n');
        addMessage(`Here are the slang terms I found:\n\n${expl}`, 'ai', true);
        return;
      }
      const estimatedInputTokens = Math.ceil(msg.length / 4) + 200;
      const allowed = await checkAndUpdateTokenUsage(estimatedInputTokens);
      if (!allowed) {
        addMessage('You have reached your daily token limit. Please try again tomorrow.', 'ai');
        return;
      }
      addLoading();
      try {
        const messages = [...historyStack, { role: 'user', content: msg }];
        const res = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: { Authorization: `Bearer ${XAI_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'grok-4-1-fast-non-reasoning',
            messages,
            temperature: 0.7,
            max_tokens: 1500
          })
        });
        removeLoading();
        if (!res.ok) {
          await checkAndUpdateTokenUsage(-estimatedInputTokens);
          throw new Error(`API error: ${res.status}`);
        }
        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || 'No response.';
        const outputTokens = Math.ceil(reply.length / 4);
        await checkAndUpdateTokenUsage(outputTokens);
        addMessage(reply, 'ai', currentLang !== 'en');
        historyStack.push({ role: 'user', content: msg }, { role: 'assistant', content: reply });
        await updateTokenCounterAfterMessage();
        if (historyStack.length > 1) {
          const firstUserMsg = historyStack.find(m => m.role === 'user')?.content || 'New Conversation';
          const title = currentConversationId ? null : generateTitle(firstUserMsg);
          await saveConversation(historyStack, title);
        }
      } catch (e) {
        removeLoading();
        addMessage('Connection error. Please try again later.', 'ai');
        console.error(e);
      }
    };

    $i.addEventListener('input', () => $send.classList.toggle('active', $i.value.trim().length > 0));
    $i.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    $send.addEventListener('click', sendMessage);

    // Voice recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SR();
      rec.continuous = false;
      rec.interimResults = false;
      $mic.addEventListener('click', () => {
        if (!auth.currentUser) {
          showCustomSnackbar('You must be logged in to use voice.');
          openSheet('auth');
          return;
        }
        rec.lang = LANGUAGES[currentLang].code;
        rec.start();
      });
      rec.onstart = () => {
        $mic.classList.add('listening');
        $i.placeholder = 'Listening...';
      };
      rec.onresult = e => {
        const transcript = e.results[0][0].transcript;
        $i.value = transcript;
        sendMessage();
      };
      rec.onend = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Ask about CAPS curriculum...';
      };
      rec.onerror = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Ask about CAPS curriculum...';
      };
    } else {
      $mic.style.display = 'none';
    }

    initLanguageDropdown();
    updateSystemInstructions();

    // Rain animation
    const canvas = $('#rainCanvas');
    const ctx = canvas.getContext('2d');
    let w, h, drops = [];
    const colors = ['#006400', '#C3995B', '#008000', '#cbd5e1'];

    function resize() {
      w = innerWidth;
      h = innerHeight;
      canvas.width = w;
      canvas.height = h;
      drops = [];
      const count = Math.floor(w / 15);
      for (let i = 0; i < count; i++) {
        drops.push({
          x: Math.random() * w,
          y: Math.random() * h,
          len: Math.random() * 20 + 10,
          speed: Math.random() * 3 + 2,
          color: colors[Math.floor(Math.random() * colors.length)],
          opacity: Math.random() * 0.5 + 0.1
        });
      }
    }

    addEventListener('resize', resize);
    resize();

    function draw() {
      ctx.clearRect(0, 0, w, h);
      for (const d of drops) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x, d.y + d.len);
        ctx.strokeStyle = d.color;
        ctx.lineWidth = 1;
        ctx.globalAlpha = d.opacity;
        ctx.stroke();
        d.y += d.speed;
        if (d.y > h) {
          d.y = -d.len;
          d.x = Math.random() * w;
        }
      }
      requestAnimationFrame(draw);
    }
    draw();

    // PWA install prompt
    let deferredPrompt;
    const $install = $('#installBtn');
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      $install.style.display = 'flex';
    });
    $install.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Install:', outcome);
      deferredPrompt = null;
      $install.style.display = 'none';
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(() => console.log('SW registered'));
    }
  </script>
</body>
</html>
