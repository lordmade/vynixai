<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AlphaPal • Learn ABC, 123 & Shapes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    body {
      font-family: 'Comic Neue', cursive;
      background: linear-gradient(135deg, #fff8e1 0%, #e0f2fe 100%);
      min-height: 100dvh;
      margin: 0;
      overflow: hidden;
      touch-action: manipulation;
    }
    h1, h2, .text-display { font-family: 'Fredoka', sans-serif; }
    .rainbow-text {
      background: linear-gradient(90deg, #ff6bcb, #ff9d80, #a0e7ff, #9fffcb, #ffd580, #ff6bcb);
      background-size: 200%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: shimmer 8s linear infinite;
    }
    @keyframes shimmer { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
    .glass { background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
    .btn-mode {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 110px;
    }
    .btn-mode.active {
      transform: scale(1.12);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      opacity: 1 !important;
    }
    .float { animation: float 4s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-18px); } }
    .sparkle { animation: sparkle 2.5s infinite; }
    @keyframes sparkle { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.2) rotate(8deg); } }
    .tappable { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .tappable:active { transform: scale(0.92); }
    .confetti {
      position: fixed; width: 14px; height: 14px; background: #ff6bcb; z-index: 1000;
      pointer-events: none; animation: confetti-fall 3.5s linear forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(1080deg); opacity: 0; }
    }
    .mascot { animation: wiggle 5s ease-in-out infinite; }
    @keyframes wiggle { 0%, 100% { transform: rotate(-6deg) translateY(0); } 50% { transform: rotate(6deg) translateY(-12px); } }
    .progress-star { transition: all 0.5s; }
    .progress-star.earned { transform: scale(1.5) rotate(15deg); filter: drop-shadow(0 0 16px gold); }
    canvas { border-radius: 2rem; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
    .gesture-hint {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.75); color: white; padding: 10px 20px; border-radius: 30px;
      font-size: 16px; z-index: 100; animation: fade 3s forwards;
    }
    @keyframes fade { 0%, 80% { opacity: 1; } 100% { opacity: 0; } }
  </style>
</head>
<body class="flex flex-col text-gray-800">

  <!-- Mascot -->
  <div id="mascot" class="fixed top-4 right-4 w-20 h-20 z-50 mascot opacity-0 transition-opacity duration-1000">
    <svg viewBox="0 0 100 100" class="drop-shadow-2xl">
      <circle cx="50" cy="50" r="45" fill="#ff6bcb"/>
      <circle cx="35" cy="40" r="9" fill="white"/>
      <circle cx="65" cy="40" r="9" fill="white"/>
      <circle cx="33" cy="38" r="5" fill="black"/>
      <circle cx="63" cy="38" r="5" fill="black"/>
      <path d="M30 58 Q50 78 70 58" stroke="#ff1493" stroke-width="7" fill="none" stroke-linecap="round"/>
      <circle cx="25" cy="25" r="12" fill="#ffaecb" opacity="0.7"/>
    </svg>
  </div>

  <!-- Gesture Hint -->
  <div id="gestureHint" class="gesture-hint hidden">Swipe left for next!</div>

  <!-- Header -->
  <header class="text-center py-6 px-4 relative z-30">
    <h1 class="text-5xl md:text-7xl font-bold rainbow-text sparkle">AlphaPal</h1>
    <p class="text-2xl md:text-4xl text-purple-700 font-semibold mt-2">ABC • 123 • Shapes</p>

    <div class="mt-10 flex justify-center gap-5 flex-wrap">
      <button id="modeABC" class="btn-mode active px-12 py-5 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-3xl rounded-full shadow-2xl font-bold">ABC</button>
      <button id="mode123" class="btn-mode px-12 py-5 bg-gradient-to-r from-cyan-500 to-blue-600 text-white text-3xl rounded-full shadow-2xl font-bold opacity-70">123</button>
      <button id="modeShapes" class="btn-mode px-12 py-5 bg-gradient-to-r from-green-500 to-teal-600 text-white text-3xl rounded-full shadow-2xl font-bold opacity-70">Shapes</button>
    </div>
  </header>

  <!-- Progress -->
  <div class="flex justify-center gap-5 my-5">
    <span class="progress-star text-5xl">★</span>
    <span class="progress-star text-5xl">★</span>
    <span class="progress-star text-5xl">★</span>
    <span class="progress-star text-5xl">★</span>
    <span class="progress-star text-5xl">★</span>
  </div>
  <p id="progressText" class="text-center text-xl font-semibold text-purple-700 mb-4">Complete activities to earn stars!</p>

  <!-- Main Screen -->
  <main id="main" class="flex-1 flex flex-col items-center justify-center gap-10 px-6">
    <div id="display" class="text-display text-28vw md:text-24vw font-black leading-none sparkle tappable" style="color:hsl(320,90%,60%)">A</div>
    
    <div class="text-center space-y-6">
      <h2 id="word" class="text-7xl md:text-9xl font-bold text-purple-800 drop-shadow-lg">apple</h2>
      <img id="image" src="" alt="" class="w-64 h-64 md:w-96 md:h-96 mx-auto float tappable rounded-3xl shadow-2xl bg-white p-6 object-contain">
      <p id="funFact" class="text-2xl md:text-3xl text-blue-700 italic font-medium px-8 hidden">Did you know? Apples float because they're 25% air!</p>
    </div>
  </main>

  <!-- Drawing Screen -->
  <div id="drawScreen" class="hidden fixed inset-0 bg-gradient-to-br from-sky-300 via-pink-300 to-purple-400 flex flex-col items-center justify-center z-50 p-6">
    <div class="w-full max-w-4xl">
      <canvas id="canvas" class="w-full aspect-square bg-white glass border-8 border-white"></canvas>
      <div id="traceGuide" class="absolute top-8 left-8 w-12 h-12 bg-yellow-400 rounded-full animate-pulse hidden"></div>
    </div>

    <!-- Crayons -->
    <div class="mt-8 flex flex-wrap justify-center gap-5">
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#ff1493" style="background:#ff1493"></button>
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#ff6bcb" style="background:#ff6bcb"></button>
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#ff9d00" style="background:#ff9d00"></button>
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#ffed4e" style="background:#ffed4e"></button>
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#4eff7b" style="background:#4eff7b"></button>
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#4e9fff" style="background:#4e9fff"></button>
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#9c4eff" style="background:#9c4eff"></button>
      <button class="crayon w-16 h-16 rounded-full shadow-2xl tappable border-4 border-white" data-color="#000" style="background:#000"></button>
    </div>

    <!-- Draw Controls -->
    <div class="mt-10 flex gap-5 flex-wrap justify-center">
      <button id="modeTrace" class="px-12 py-6 bg-purple-600 text-white text-3xl rounded-full shadow-2xl font-bold active">Trace</button>
      <button id="modeColor" class="px-12 py-6 bg-pink-600 text-white text-3xl rounded-full shadow-2xl font-bold opacity-70">Color</button>
      <button id="undoBtn" class="px-12 py-6 bg-blue-600 text-white text-3xl rounded-full shadow-2xl font-bold">↶ Undo</button>
      <button id="clearBtn" class="px-12 py-6 bg-red-600 text-white text-3xl rounded-full shadow-2xl font-bold">Clear</button>
    </div>

    <p class="mt-8 text-white text-xl font-semibold">Swipe down to go back</p>
  </div>

  <!-- Audio -->
  <audio id="pop" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3"></audio>
  <audio id="sparkleSound" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-magical-coin-win-1937.mp3"></audio>
  <audio id="scribble" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-pencil-writing-fast-3343.mp3"></audio>
  <audio id="celebration" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-won-3110.mp3"></audio>
  <audio id="bgMusic" loop preload="auto" src="https://assets.mixkit.co/music/preview/mixkit-optimistic-children-background-2490.mp3"></audio>

  <script>
    // ===== DATA =====
    const letters = [
      {l:"A",s:"ă",w:"apple",e:"1f34e",fact:"Apples float in water because they're 25% air!"},
      {l:"B",s:"b",w:"ball",e:"26bd",fact:"Bouncing a ball makes you smarter!"},
      {l:"C",s:"k",w:"cat",e:"1f408",fact:"Cats can jump 6 times their length!"},
      {l:"D",s:"d",w:"dog",e:"1f436",fact:"Dogs can understand 250 words!"},
      {l:"E",s:"ĕ",w:"elephant",e:"1f418",fact:"Elephants are the only animals that can't jump!"},
      {l:"F",s:"f",w:"fish",e:"1f41f",fact:"Fish can recognize their owner's face!"},
      {l:"G",s:"g",w:"giraffe",e:"1f992",fact:"Giraffes have purple tongues!"},
      {l:"H",s:"h",w:"happy",e:"1f60a",fact:"Smiling makes you happier!"},
      {l:"I",s:"ĭ",w:"icecream",e:"1f366",fact:"Ice cream was invented in China!"},
      {l:"J",s:"j",w:"jam",e:"1f370",fact:"Strawberries have 200 seeds!"},
      {l:"K",s:"k",w:"kite",e:"1fa81",fact:"Kites were invented 2,800 years ago!"},
      {l:"L",s:"l",w:"lion",e:"1f981",fact:"Lions are the only cats that live in groups!"},
      {l:"M",s:"m",w:"monkey",e:"1f412",fact:"Monkeys can count to 10!"},
      {l:"N",s:"n",w:"nest",e:"1faba",fact:"Birds use 1,500 feathers to build a nest!"},
      {l:"O",s:"ŏ",w:"octopus",e:"1f419",fact:"Octopuses have 3 hearts!"},
      {l:"P",s:"p",w:"penguin",e:"1f427",fact:"Penguins propose with pebbles!"},
      {l:"Q",s:"kw",w:"queen",e:"1f451",fact:"Queen bees lay 2,000 eggs daily!"},
      {l:"R",s:"r",w:"rainbow",e:"1f308",fact:"Rainbows are actually circles!"},
      {l:"S",s:"s",w:"sun",e:"2600",fact:"The Sun is a giant star!"},
      {l:"T",s:"t",w:"tiger",e:"1f405",fact:"Tigers have striped skin!"},
      {l:"U",s:"ŭ",w:"umbrella",e:"2602",fact:"Umbrellas are 4,000 years old!"},
      {l:"V",s:"v",w:"violin",e:"1f3bb",fact:"Violins have 70 pieces of wood!"},
      {l:"W",s:"w",w:"watermelon",e:"1f349",fact:"Watermelons are 92% water!"},
      {l:"X",s:"ks",w:"box",e:"1f4e6",fact:"Cardboard boxes were invented in 1817!"},
      {l:"Y",s:"y",w:"yak",e:"1f402",fact:"Yaks live high in the mountains!"},
      {l:"Z",s:"z",w:"zebra",e:"1f993",fact:"Zebras sleep standing up!"}
    ];

    const numbers = [
      {n:"1",w:"one",e:"1f44d",c:"#ff6bcb",fact:"One is the first number!"},
      {n:"2",w:"two",e:"1f44c",c:"#ff9d9d",fact:"We have 2 eyes, 2 ears, 2 hands!"},
      {n:"3",w:"three",e:"1f64c",c:"#ffb380",fact:"Triangles have 3 sides!"},
      {n:"4",w:"four",e:"1f919",c:"#ffed80",fact:"Dogs have 4 legs!"},
      {n:"5",w:"five",e:"1f44c",c:"#bfff80",fact:"Starfish have 5 arms!"},
      {n:"6",w:"six",e:"1f44a",c:"#80ffea",fact:"Honeycombs have 6 sides!"},
      {n:"7",w:"seven",e:"1f44b",c:"#80d4ff",fact:"Rainbows have 7 colors!"},
      {n:"8",w:"eight",e:"1f44f",c:"#c780ff",fact:"Spiders have 8 legs!"},
      {n:"9",w:"nine",e:"1f44f",c:"#ff80c7",fact:"Cats have 9 lives!"},
      {n:"10",w:"ten",e:"1f389",c:"#ffd580",fact:"You have 10 fingers!"}
    ];

    const shapes = [
      {name:"Circle", speak:"This is a circle!", path:d=>`M${d} ${d*0.3} a ${d*0.7} ${d*0.7} 0 1 1 0.1 0 a ${d*0.7} ${d*0.7} 0 1 1 -0.1 0`, color:"#ff6bcb",fact:"Circles have no corners!"},
      {name:"Triangle", speak:"This is a triangle!", path:d=>`M${d} ${d*0.3} L${d*1.7} ${d*1.7} L${d*0.3} ${d*1.7} Z`, color:"#4e9fff",fact:"Triangles are super strong!"},
      {name:"Square", speak:"This is a square!", path:d=>`M${d*0.3} ${d*0.3} h${d*1.4} v${d*1.4} h-${d*1.4} Z`, color:"#ff9d00",fact:"Squares have 4 equal sides!"},
      {name:"Rectangle", speak:"This is a rectangle!", path:d=>`M${d*0.2} ${d*0.6} h${d*1.6} v${d*0.8} h-${d*1.6} Z`, color:"#9c4eff",fact:"Books are rectangles!"},
      {name:"Star", speak:"This is a star!", path:d=>`M${d} ${d*0.2} L${d*1.15} ${d*0.8} L${d*1.8} ${d*0.8} L${d*1.3} ${d*1.3} L${d*1.5} ${d*1.9} L${d} ${d*1.5} L${d*0.5} ${d*1.9} L${d*0.7} ${d*1.3} L${d*0.2} ${d*0.8} L${d*0.85} ${d*0.8} Z`, color:"#ffed4e",fact:"Stars twinkle in the sky!"},
      {name:"Heart", speak:"This is a heart!", path:d=>`M${d} ${d*1.3} Q${d*0.2} ${d*0.6} ${d*0.5} ${d*0.4} Q${d*0.85} ${d*0.2} ${d} ${d*0.6} Q${d*1.15} ${d*0.2} ${d*1.5} ${d*0.4} Q${d*1.8} ${d*0.6} ${d} ${d*1.3} Z`, color:"#ff1493",fact:"Hearts pump blood!"},
      {name:"Diamond", speak:"This is a diamond!", path:d=>`M${d} ${d*0.4} L${d*1.6} ${d} L${d} ${d*1.6} L${d*0.4} ${d} Z`, color:"#4eff7b",fact:"Diamonds are super hard!"},
      {name:"Pentagon", speak:"This is a pentagon!", path:d=>`M${d} ${d*0.4} L${d*1.55} ${d*0.75} L${d*1.35} ${d*1.5} L${d*0.65} ${d*1.5} L${d*0.45} ${d*0.75} Z`, color:"#ffaecb",fact:"Pentagons have 5 sides!"},
      {name:"Hexagon", speak:"This is a hexagon!", path:d=>`M${d*1.3} ${d*0.5} L${d*1.7} ${d} L${d*1.3} ${d*1.5} L${d*0.7} ${d*1.5} L${d*0.3} ${d} L${d*0.7} ${d*0.5} Z`, color:"#80d4ff",fact:"Honeycombs are hexagons!"}
    ];

    // ===== STATE =====
    let mode = "abc", i = 0, drawMode = "color", currentColor = "#ff1493", bgMusicEnabled = false;
    let progress = {abc:0, num:0, shapes:0}, undoStack = [];

    const displayEl = document.getElementById('display');
    const wordEl = document.getElementById('word');
    const imgEl = document.getElementById('image');
    const mascotEl = document.getElementById('mascot');
    const factEl = document.getElementById('funFact');
    const mainEl = document.getElementById('main');
    const drawScreenEl = document.getElementById('drawScreen');
    const gestureHint = document.getElementById('gestureHint');
    const progressStars = document.querySelectorAll('.progress-star');
    const progressText = document.getElementById('progressText');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // ===== AUDIO & SPEECH =====
    const playSound = (id, vol = 1) => {
      const a = document.getElementById(id);
      if (a) { a.currentTime = 0; a.volume = vol; a.play().catch(() => {}); }
    };

    const speak = (text, rate = 0.8, pitch = 1.4) => {
      const u = new SpeechSynthesisUtterance(text);
      u.rate = rate; u.pitch = pitch; u.volume = 0.9;
      const voices = speechSynthesis.getVoices();
      u.voice = voices.find(v => v.lang.startsWith('en') && (v.name.includes('child') || v.name.includes('Google'))) || voices[0];
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    };

    // ===== VISUAL EFFECTS =====
    const celebrate = () => {
      playSound('celebration', 0.6);
      for (let j = 0; j < 40; j++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.style.left = Math.random() * 100 + 'vw';
          c.style.background = `hsl(${Math.random()*360}, 80%, 60%)`;
          c.style.animationDelay = Math.random() * 0.5 + 's';
          document.body.appendChild(c);
          setTimeout(() => c.remove(), 4000);
        }, j * 60);
      }
    };

    const showMascot = (msg) => {
      mascotEl.style.opacity = 1;
      setTimeout(() => speak(msg, 0.9, 1.5), 400);
    };

    // ===== PROGRESS & DISPLAY =====
    const updateProgress = () => {
      const key = mode === 'abc' ? 'abc' : mode === '123' ? 'num' : 'shapes';
      progress[key]++;
      const total = Object.values(progress).reduce((a,b) => a+b, 0);
      progressStars.forEach((s, idx) => s.classList.toggle('earned', idx < total));
      progressText.textContent = `Amazing! ${total} star${total===1?'':'s'} earned!`;
      if (total >= 5) {
        setTimeout(() => {
          celebrate();
          speak("Wow! All stars earned! You're a superstar learner!", 0.7, 1.6);
        }, 800);
      }
    };

    const showCurrent = () => {
      playSound('sparkleSound', 0.4);
      if (mode === "abc") {
        const p = letters[i];
        displayEl.textContent = p.l;
        wordEl.textContent = p.w;
        imgEl.src = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${p.e}.svg`;
        imgEl.style.display = "block";
        displayEl.style.color = `hsl(${i * 360 / 26}, 90%, 60%)`;
        factEl.textContent = `Fun fact: ${p.fact}`;
        factEl.classList.remove('hidden');
      } else if (mode === "123") {
        const p = numbers[i];
        displayEl.textContent = p.n;
        wordEl.textContent = p.w;
        imgEl.src = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${p.e}.svg`;
        imgEl.style.display = "block";
        displayEl.style.color = p.c;
        factEl.textContent = `Fun fact: ${p.fact}`;
        factEl.classList.remove('hidden');
      } else {
        const s = shapes[i];
        displayEl.textContent = s.name;
        wordEl.textContent = "Shape";
        imgEl.style.display = "none";
        displayEl.style.color = s.color;
        factEl.textContent = `Fun fact: ${s.fact}`;
        factEl.classList.remove('hidden');
      }
    };

    // ===== MODE SWITCHING =====
    const setMode = (m) => {
      mode = m; i = 0;
      showCurrent();
      document.querySelectorAll('.btn-mode').forEach(b => {
        b.classList.remove('active');
        b.style.opacity = '0.7';
      });
      const btn = m === "abc" ? '#modeABC' : m === "123" ? '#mode123' : '#modeShapes';
      document.querySelector(btn).classList.add('active');
      document.querySelector(btn).style.opacity = '1';
      speak(`Let's learn ${m === 'abc' ? 'letters' : m === '123' ? 'numbers' : 'shapes'}!`, 0.8, 1.4);
    };

    document.getElementById('modeABC').onclick = () => setMode("abc");
    document.getElementById('mode123').onclick = () => setMode("123");
    document.getElementById('modeShapes').onclick = () => setMode("shapes");

    // ===== GESTURES =====
    let touchStartX = 0, touchStartY = 0, touchStartTime = 0, lastTapTime = 0;

    const handleTouchStart = (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    };

    const handleTouchEnd = (e) => {
      const dx = e.changedTouches[0].clientX - touchStartX;
      const dy = e.changedTouches[0].clientY - touchStartY;
      const dt = Date.now() - touchStartTime;
      const isTap = Math.abs(dx) < 30 && Math.abs(dy) < 30 && dt < 300;

      if (isTap) {
        const now = Date.now();
        if (now - lastTapTime < 500) {
          // Double tap
          if (mode === "abc") { speak("A B C D E F G... H I J K L M N O P... Q R S... T U V... W X Y Z!", 1.1, 1.5); }
          else if (mode === "123") { speak("One two three four five six seven eight nine ten!", 1, 1.4); }
          else { speak("Circle, triangle, square, star, heart, diamond, pentagon, hexagon!", 0.9, 1.5); }
          playSound('sparkleSound', 0.5);
        } else {
          // Single tap
          if (mode === "abc") speak(`${letters[i].s} as in ${letters[i].w} ... ${letters[i].l} ... ${letters[i].w}`, 0.8, 1.3);
          else if (mode === "123") speak(`${numbers[i].n} ... ${numbers[i].w}!`, 0.9, 1.4);
          else speak(shapes[i].speak, 0.9, 1.4);
          playSound('pop', 0.4);
        }
        lastTapTime = now;
      } else {
        if (Math.abs(dx) > Math.abs(dy)) {
          if (dx > 50) { i = (i - 1 + (mode === "abc" ? 26 : mode === "123" ? 10 : 9)) % (mode === "abc" ? 26 : mode === "123" ? 10 : 9); showCurrent(); }
          else if (dx < -50) { i = (i + 1) % (mode === "abc" ? 26 : mode === "123" ? 10 : 9); showCurrent(); updateProgress(); }
        } else {
          if (dy < -60 && drawScreenEl.classList.contains('hidden')) openDrawingForTrace();
          if (dy > 60 && !drawScreenEl.classList.contains('hidden')) {
            drawScreenEl.classList.add('hidden');
            mainEl.classList.remove('hidden');
            if (drawMode === 'trace') { celebrate(); updateProgress(); speak("Great job tracing!", 0.9, 1.5); }
          }
        }
      }
    };

    mainEl.addEventListener('touchstart', handleTouchStart);
    mainEl.addEventListener('touchend', handleTouchEnd);
    drawScreenEl.addEventListener('touchstart', handleTouchStart);
    drawScreenEl.addEventListener('touchend', handleTouchEnd);

    // ===== DRAWING SYSTEM =====
    const openDrawingForTrace = () => {
      drawMode = "trace";
      drawScreenEl.classList.remove('hidden');
      mainEl.classList.add('hidden');
      document.getElementById('modeTrace').classList.add('active');
      document.getElementById('modeColor').classList.remove('active');
      document.getElementById('modeTrace').style.opacity = '1';
      document.getElementById('modeColor').style.opacity = '0.7';
      resizeCanvas();
      drawGuide();
      showMascot(`Trace the ${mode === 'abc' ? 'letter' : mode === '123' ? 'number' : 'shape'}!`);
    };

    displayEl.onclick = imgEl.onclick = openDrawingForTrace;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * devicePixelRatio;
      canvas.height = rect.height * devicePixelRatio;
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      drawGuide();
    }
    window.addEventListener('resize', resizeCanvas);

    function drawGuide() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (drawMode !== "trace") return;
      const rect = canvas.getBoundingClientRect();
      const size = Math.min(rect.width, rect.height) * 0.7;
      const cx = rect.width / 2;
      const cy = rect.height / 2;

      ctx.strokeStyle = 'rgba(0,0,0,0.07)';
      ctx.lineWidth = 16;
      ctx.lineCap = 'round';

      if (mode === "abc") {
        ctx.font = `bold ${size * 1.3}px Fredoka`;
        ctx.fillStyle = 'rgba(0,0,0,0.07)';
        ctx.textAlign = 'center';
        ctx.fillText((mode === "abc" ? letters[i].l : numbers[i].n), cx, cy + size * 0.15);
      } else if (mode === "123") {
        ctx.font = `bold ${size * 1.3}px Fredoka`;
        ctx.fillStyle = 'rgba(0,0,0,0.07)';
        ctx.textAlign = 'center';
        ctx.fillText(numbers[i].n, cx, cy + size * 0.15);
      } else {
        const path = new Path2D(shapes[i].path(Math.min(rect.width, rect.height) / 3));
        ctx.stroke(path);
      }
    }

    // Drawing logic
    let drawing = false, lastX = 0, lastY = 0;
    const startDraw = (e) => { drawing = true; const r = canvas.getBoundingClientRect(); lastX = e.clientX - r.left; lastY = e.clientY - r.top; ctx.beginPath(); ctx.moveTo(lastX, lastY); };
    const draw = (e) => {
      if (!drawing) return;
      const r = canvas.getBoundingClientRect();
      const x = e.clientX - r.left;
      const y = e.clientY - r.top;
      ctx.lineWidth = 20;
      ctx.lineCap = 'round';
      ctx.strokeStyle = currentColor;
      ctx.globalAlpha = drawMode === 'trace' ? 0.85 : 1;
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
      playSound('scribble', 0.15);
    };
    const stopDraw = () => { if (drawing) { drawing = false; undoStack.push(canvas.toDataURL()); if (undoStack.length > 12) undoStack.shift(); } };

    canvas.addEventListener('pointerdown', startDraw);
    canvas.addEventListener('pointermove', draw);
    canvas.addEventListener('pointerup', stopDraw);
    canvas.addEventListener('pointerleave', stopDraw);

    // Crayon picker
    document.querySelectorAll('.crayon').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.crayon').forEach(b => b.classList.remove('ring-4', 'ring-white'));
        btn.classList.add('ring-4', 'ring-white');
        currentColor = btn.dataset.color;
        playSound('pop', 0.4);
      };
    });
    document.querySelector('.crayon').classList.add('ring-4', 'ring-white'); // default

    document.getElementById('modeTrace').onclick = () => { drawMode = "trace"; drawGuide(); document.getElementById('modeTrace').style.opacity = '1'; document.getElementById('modeColor').style.opacity = '0.7'; };
    document.getElementById('modeColor').onclick = () => { drawMode = "color"; ctx.clearRect(0,0,canvas.width,canvas.height); document.getElementById('modeColor').style.opacity = '1'; document.getElementById('modeTrace').style.opacity = '0.7'; };
    document.getElementById('undoBtn').onclick = () => { if (undoStack.length > 0) { undoStack.pop(); const img = new Image(); img.src = undoStack[undoStack.length-1] || ''; img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); }; } };
    document.getElementById('clearBtn').onclick = () => { undoStack = []; ctx.clearRect(0,0,canvas.width,canvas.height); drawGuide(); showMascot("All clean! Let's draw again!"); };

    // ===== INIT =====
    window.onload = () => {
      resizeCanvas();
      showCurrent();
      mascotEl.style.opacity = 1;
      speak("Hi! I'm AlphaPal! Tap to hear, swipe left or right to learn!", 0.9, 1.5);
      setTimeout(() => {
        if (confirm("Want happy background music?")) {
          bgMusicEnabled = true;
          const music = document.getElementById('bgMusic');
          music.volume = 0.2;
          music.play();
        }
      }, 3000);
    };
  </script>
</body>
</html>
