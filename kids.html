<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AlphaPal ‚Ä¢ ABC, 123 & Shapes!</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

  <style>
    *,*::before,*::after{-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;touch-action:none;}
    body{font-family:'Comic Neue',cursive;background:linear-gradient(135deg,#fffbe6,#e6f9ff);margin:0;height:100dvh;overflow:hidden;position:relative;}
    h1{font-family:'Fredoka One',cursive;}
    .rainbow{background:linear-gradient(90deg,#ff6bcb,#ffaecb,#a0e7ff,#9fffcb,#ffd580,#ff9f9f);-webkit-background-clip:text;color:transparent;}
    .sparkle{animation:sparkle 2s infinite;}@keyframes sparkle{0%,100%{transform:scale(1)}50%{transform:scale(1.18) rotate(6deg)}}
    .float{animation:float 3s infinite ease-in-out;}@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
    .tappable{cursor:pointer;transform:scale(1);transition:transform .2s cubic-bezier(.4,0,.2,1);}
    .tappable:active{transform:scale(0.94);}
    .pop{animation:pop .3s ease-out;}@keyframes pop{0%{transform:scale(0)}70%{transform:scale(1.1)}100%{transform:scale(1)}}
    .shake{animation:shake .5s;}@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
    .gesture-hint{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:8px 16px;border-radius:20px;font-size:14px;z-index:60;animation:fadeInOut 3s ease-in-out;}
    @keyframes fadeInOut{0%,100%{opacity:0}50%{opacity:1}}
    .mascot{position:fixed;top:20px;right:20px;width:80px;height:80px;z-index:40;animation:mascotWiggle 4s infinite ease-in-out;}@keyframes mascotWiggle{0%,100%{transform:rotate(-5deg) translateY(0)}50%{transform:rotate(5deg) translateY(-10px)}}
    .progress-star{transition:all .3s;}.progress-star.earned{transform:scale(1.3);filter:drop-shadow(0 0 10px gold);}
    .confetti{position:fixed;width:12px;height:12px;background:#ff6bcb;z-index:100;animation:confetti-fall 3s linear forwards;}@keyframes confetti-fall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
    @media (min-width:768px){.text-28vw{font-size:12rem;}.md\\:text-24vw{font-size:10rem;}}
  </style>
</head>
<body class="flex flex-col">

  <!-- Mascot -->
  <div id="mascot" class="mascot hidden">
    <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-lg">
      <circle cx="50" cy="50" r="45" fill="#ff6bcb"/>
      <circle cx="35" cy="40" r="5" fill="white"/>
      <circle cx="65" cy="40" r="5" fill="white"/>
      <path d="M50 60 Q40 70 50 70 Q60 70 50 60" fill="#ff1493"/>
      <circle cx="30" cy="30" r="8" fill="#ffaecb" opacity=".6"/>
    </svg>
  </div>

  <!-- Gesture Hint -->
  <div id="gestureHint" class="gesture-hint hidden">Swipe left for next!</div>

  <!-- Header -->
  <div class="text-center py-4 bg-gradient-to-b from-pink-200 to-transparent relative z-30">
    <h1 class="text-5xl rainbow sparkle">AlphaPal</h1>
    <p class="text-2xl text-purple-700 mt-1">ABC ‚Ä¢ 123 ‚Ä¢ Shapes</p>
    <div class="mt-4 flex flex-wrap justify-center gap-3 px-2">
      <button id="modeABC" class="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-2xl rounded-full shadow-xl tappable">ABC</button>
      <button id="mode123" class="px-8 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white text-2xl rounded-full shadow-xl opacity-60 tappable">123</button>
      <button id="modeShapes" class="px-8 py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white text-2xl rounded-full shadow-xl opacity-60 tappable">Shapes</button>
    </div>
  </div>

  <!-- Progress Stars -->
  <div class="flex justify-center gap-3 mt-2">
    <span class="progress-star text-3xl">‚≠ê</span>
    <span class="progress-star text-3xl">‚≠ê</span>
    <span class="progress-star text-3xl">‚≠ê</span>
    <span class="progress-star text-3xl">‚≠ê</span>
    <span class="progress-star text-3xl">‚≠ê</span>
  </div>
  <p id="progressText" class="text-center text-lg text-purple-600">Complete 5 to earn stars!</p>

  <!-- Main Screen -->
  <div id="main" class="flex-1 flex flex-col items-center justify-center gap-6 px-4 relative z-20">
    <div id="display" class="sparkle tappable text-28vw md:text-24vw font-black text-center leading-none" style="color:hsl(0,90%,60%)">A</div>
    <div class="text-center">
      <div id="word" class="text-5xl md:text-7xl font-bold text-purple-800 mb-4 drop-shadow-lg">apple</div>
      <img id="image" src="" alt="Learning image" class="float tappable w-48 h-48 md:w-64 md:h-64 mx-auto">
      <p id="funFact" class="mt-3 text-xl text-blue-600 italic hidden px-4"></p>
    </div>
  </div>

  <!-- DRAWING SCREEN -->
  <div id="drawScreen" class="hidden fixed inset-0 bg-gradient-to-br from-sky-200 via-pink-200 to-purple-200 flex flex-col items-center justify-center z-50">
    <div class="relative w-full max-w-2xl px-4">
      <canvas id="canvas" class="w-full h-80 md:h-[500px] bg-white rounded-3xl shadow-2xl border-8 border-white"></canvas>
      <div id="traceGuide" class="absolute top-4 left-4 w-10 h-10 bg-yellow-400 rounded-full hidden animate-pulse"></div>
    </div>

    <div class="mt-6 flex flex-wrap justify-center gap-4 px-4">
      <button class="crayon tappable" data-color="#ff1493" style="background:#ff1493"></button>
      <button class="crayon tappable" data-color="#ff6bcb" style="background:#ff6bcb"></button>
      <button class="crayon tappable" data-color="#ff9d00" style="background:#ff9d00"></button>
      <button class="crayon tappable" data-color="#ffed4e" style="background:#ffed4e"></button>
      <button class="crayon tappable" data-color="#4eff7b" style="background:#4eff7b"></button>
      <button class="crayon tappable" data-color="#4e9fff" style="background:#4e9fff"></button>
      <button class="crayon tappable" data-color="#9c4eff" style="background:#9c4eff"></button>
      <button class="crayon tappable" data-color="#000000" style="background:#000000"></button>
    </div>

    <div class="mt-6 flex flex-wrap justify-center gap-3 items-center px-4">
      <button id="modeTrace" class="px-8 py-4 bg-purple-600 text-white text-2xl rounded-full shadow-xl tappable">Trace</button>
      <button id="modeColor" class="px-8 py-4 bg-pink-600 text-white text-2xl rounded-full shadow-xl opacity-60 tappable">Color</button>
      <button id="undoBtn" class="px-10 py-4 bg-blue-600 text-white text-2xl rounded-full shadow-xl tappable">‚Ü∂ Undo</button>
      <button id="clearBtn" class="px-10 py-4 bg-red-600 text-white text-2xl rounded-full shadow-xl tappable">Clear</button>
    </div>
    <p class="text-center text-sm text-gray-600 mt-2">Swipe down to go back</p>
  </div>

  <!-- Sounds -->
  <audio id="pop" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3"></audio>
  <audio id="sparkleSound" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-magical-coin-win-1937.mp3"></audio>
  <audio id="scribble" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-pencil-writing-fast-3343.mp3"></audio>
  <audio id="celebration" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-won-3110.mp3"></audio>
  <audio id="bgMusic" preload="auto" loop src="https://assets.mixkit.co/music/preview/mixkit-optimistic-children-background-2490.mp3"></audio>

  <script>
    // ===== GLOBAL STATE =====
    const letters = [
      {l:"A",s:"ƒÉ",w:"apple",e:"1f34e",fact:"Apples float in water because they're 25% air!"},
      {l:"B",s:"b",w:"ball",e:"26bd",fact:"Bouncing a ball makes you smarter!"},
      {l:"C",s:"k",w:"cat",e:"1f408",fact:"Cats can jump 6 times their length!"},
      {l:"D",s:"d",w:"dog",e:"1f436",fact:"Dogs can understand 250 words!"},
      {l:"E",s:"ƒï",w:"elephant",e:"1f418",fact:"Elephants are the only animals that can't jump!"},
      {l:"F",s:"f",w:"fish",e:"1f41f",fact:"Fish can recognize their owner's face!"},
      {l:"G",s:"g",w:"giraffe",e:"1f992",fact:"Giraffes have purple tongues!"},
      {l:"H",s:"h",w:"happy",e:"1f60a",fact:"Smiling makes you happier!"},
      {l:"I",s:"ƒ≠",w:"icecream",e:"1f366",fact:"Ice cream was invented in China!"},
      {l:"J",s:"j",w:"jam",e:"1f370",fact:"Strawberries have 200 seeds!"},
      {l:"K",s:"k",w:"kite",e:"1fa81",fact:"Kites were invented 2,800 years ago!"},
      {l:"L",s:"l",w:"lion",e:"1f981",fact:"Lions are the only cats that live in groups!"},
      {l:"M",s:"m",w:"monkey",e:"1f412",fact:"Monkeys can count to 10!"},
      {l:"N",s:"n",w:"nest",e:"1faba",fact:"Birds use 1,500 feathers to build a nest!"},
      {l:"O",s:"≈è",w:"octopus",e:"1f419",fact:"Octopuses have 3 hearts!"},
      {l:"P",s:"p",w:"penguin",e:"1f427",fact:"Penguins propose with pebbles!"},
      {l:"Q",s:"kw",w:"queen",e:"1f451",fact:"Queen bees lay 2,000 eggs daily!"},
      {l:"R",s:"r",w:"rainbow",e:"1f308",fact:"Rainbows are actually circles!"},
      {l:"S",s:"s",w:"sun",e:"2600",fact:"The Sun is a giant star!"},
      {l:"T",s:"t",w:"tiger",e:"1f405",fact:"Tigers have striped skin!"},
      {l:"U",s:"≈≠",w:"umbrella",e:"2602",fact:"Umbrellas are 4,000 years old!"},
      {l:"V",s:"v",w:"violin",e:"1f3bb",fact:"Violins have 70 pieces of wood!"},
      {l:"W",s:"w",w:"watermelon",e:"1f349",fact:"Watermelons are 92% water!"},
      {l:"X",s:"ks",w:"box",e:"1f4e6",fact:"Cardboard boxes were invented in 1817!"},
      {l:"Y",s:"y",w:"yak",e:"1f402",fact:"Yaks live high in the mountains!"},
      {l:"Z",s:"z",w:"zebra",e:"1f993",fact:"Zebras sleep standing up!"}
    ];
    
    const numbers = [
      {n:"1",w:"one",e:"1f44d",c:"#ff6bcb",fact:"One is the first number!"},
      {n:"2",w:"two",e:"1f44c",c:"#ff9d9d",fact:"We have 2 eyes, 2 ears, 2 hands!"},
      {n:"3",w:"three",e:"1f64c",c:"#ffb380",fact:"Triangles have 3 sides!"},
      {n:"4",w:"four",e:"1f919",c:"#ffed80",fact:"Dogs have 4 legs!"},
      {n:"5",w:"five",e:"1f44c",c:"#bfff80",fact:"Starfish have 5 arms!"},
      {n:"6",w:"six",e:"1f44a",c:"#80ffea",fact:"Honeycombs have 6 sides!"},
      {n:"7",w:"seven",e:"1f44b",c:"#80d4ff",fact:"Rainbows have 7 colors!"},
      {n:"8",w:"eight",e:"1f44f",c:"#c780ff",fact:"Spiders have 8 legs!"},
      {n:"9",w:"nine",e:"1f44f",c:"#ff80c7",fact:"Cats have 9 lives!"},
      {n:"10",w:"ten",e:"1f389",c:"#ffd580",fact:"You have 10 fingers!"}
    ];
    
    const shapes = [
      {name:"Circle", speak:"This is a circle!", path:d=>`M${d} ${d*0.3} a ${d*0.7} ${d*0.7} 0 1 1 0.1 0 a ${d*0.7} ${d*0.7} 0 1 1 -0.1 0`, color:"#ff6bcb",fact:"Circles have no corners!"},
      {name:"Triangle", speak:"This is a triangle!", path:d=>`M${d} ${d*0.3} L${d*1.7} ${d*1.7} L${d*0.3} ${d*1.7} Z`, color:"#4e9fff",fact:"Triangles are super strong!"},
      {name:"Square", speak:"This is a square!", path:d=>`M${d*0.3} ${d*0.3} h${d*1.4} v${d*1.4} h-${d*1.4} Z`, color:"#ff9d00",fact:"Squares have 4 equal sides!"},
      {name:"Rectangle", speak:"This is a rectangle!", path:d=>`M${d*0.2} ${d*0.6} h${d*1.6} v${d*0.8} h-${d*1.6} Z`, color:"#9c4eff",fact:"Books are rectangles!"},
      {name:"Star", speak:"This is a star!", path:d=>`M${d} ${d*0.2} L${d*1.15} ${d*0.8} L${d*1.8} ${d*0.8} L${d*1.3} ${d*1.3} L${d*1.5} ${d*1.9} L${d} ${d*1.5} L${d*0.5} ${d*1.9} L${d*0.7} ${d*1.3} L${d*0.2} ${d*0.8} L${d*0.85} ${d*0.8} Z`, color:"#ffed4e",fact:"Stars twinkle in the sky!"},
      {name:"Heart", speak:"This is a heart!", path:d=>`M${d} ${d*1.3} Q${d*0.2} ${d*0.6} ${d*0.5} ${d*0.4} Q${d*0.85} ${d*0.2} ${d} ${d*0.6} Q${d*1.15} ${d*0.2} ${d*1.5} ${d*0.4} Q${d*1.8} ${d*0.6} ${d} ${d*1.3} Z`, color:"#ff1493",fact:"Hearts pump blood!"},
      {name:"Diamond", speak:"This is a diamond!", path:d=>`M${d} ${d*0.4} L${d*1.6} ${d} L${d} ${d*1.6} L${d*0.4} ${d} Z`, color:"#4eff7b",fact:"Diamonds are super hard!"},
      {name:"Pentagon", speak:"This is a pentagon!", path:d=>`M${d} ${d*0.4} L${d*1.55} ${d*0.75} L${d*1.35} ${d*1.5} L${d*0.65} ${d*1.5} L${d*0.45} ${d*0.75} Z`, color:"#ffaecb",fact:"Pentagons have 5 sides!"},
      {name:"Hexagon", speak:"This is a hexagon!", path:d=>`M${d*1.3} ${d*0.5} L${d*1.7} ${d} L${d*1.3} ${d*1.5} L${d*0.7} ${d*1.5} L${d*0.3} ${d} L${d*0.7} ${d*0.5} Z`, color:"#80d4ff",fact:"Honeycombs are hexagons!"}
    ];

    let mode = "abc", i = 0, drawMode = "color", currentColor = "#ff1493", bgMusicEnabled = false;
    let progress = {abc:0, num:0, shapes:0}, undoStack = [];
    
    const displayEl = document.getElementById('display');
    const wordEl = document.getElementById('word');
    const imgEl = document.getElementById('image');
    const mascotEl = document.getElementById('mascot');
    const factEl = document.getElementById('funFact');
    const mainEl = document.getElementById('main');
    const drawScreenEl = document.getElementById('drawScreen');
    const gestureHint = document.getElementById('gestureHint');
    const progressStars = document.querySelectorAll('.progress-star');
    const progressText = document.getElementById('progressText');
    
    // ===== AUDIO SYSTEM =====
    const playSound = (id, volume = 1) => {
      const a = document.getElementById(id);
      if (!a) return;
      a.currentTime = 0;
      a.volume = volume;
      a.play().catch(() => {});
    };
    
    const speak = (text, rate = 0.8, pitch = 1.4) => {
      const u = new SpeechSynthesisUtterance(text);
      u.rate = rate; u.pitch = pitch; u.volume = 0.8;
      const voices = speechSynthesis.getVoices();
      u.voice = voices.find(v => v.lang.startsWith('en') && v.name.includes('child')) || 
                voices.find(v => v.lang.startsWith('en')) || voices[0];
      speechSynthesis.cancel(); 
      speechSynthesis.speak(u);
    };
    
    // ===== VISUAL FEEDBACK =====
    const tapEffect = (b) => {
      b.classList.add('tapped');
      setTimeout(() => b.classList.remove('tapped'), 300);
      b.classList.add('pop');
      setTimeout(() => b.classList.remove('pop'), 300);
    };
    
    const celebrate = () => {
      playSound('celebration', 0.5);
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.background = `hsl(${Math.random() * 360}, 80%, 60%)`;
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 4000);
        }, i * 50);
      }
      mascotEl.classList.add('shake');
      setTimeout(() => mascotEl.classList.remove('shake'), 500);
    };
    
    const showMascot = (message) => {
      mascotEl.classList.remove('hidden');
      setTimeout(() => speak(message, 0.9, 1.5), 500);
    };
    
    const updateProgress = () => {
      let key = mode === 'abc' ? 'abc' : mode === '123' ? 'num' : 'shapes';
      progress[key]++;
      const total = progress.abc + progress.num + progress.shapes;
      progressStars.forEach((star, idx) => {
        star.classList.toggle('earned', idx < total);
      });
      progressText.textContent = `Great job! ${total}/5 stars earned!`;
      if (total === 5) {
        setTimeout(() => {
          celebrate();
          speak("Wow! You earned all 5 stars! You're a super learner!", 0.7, 1.6);
        }, 1000);
      }
    };

    // ===== DISPLAY UPDATE =====
    function showCurrent() {
      playSound('sparkleSound', 0.3);
      if (mode === "abc") {
        const p = letters[i];
        displayEl.textContent = p.l; wordEl.textContent = p.w;
        imgEl.src = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${p.e}.svg`;
        imgEl.alt = p.w;
        imgEl.style.display = "block";
        displayEl.style.color = `hsl(${i * 360 / 26},90%,60%)`;
        factEl.textContent = `üí° Did you know? ${p.fact}`;
        factEl.classList.remove('hidden');
      } else if (mode === "123") {
        const p = numbers[i];
        displayEl.textContent = p.n; wordEl.textContent = p.w;
        imgEl.src = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${p.e}.svg`;
        imgEl.alt = p.w;
        imgEl.style.display = "block";
        displayEl.style.color = p.c;
        factEl.textContent = `üí° Fun fact: ${p.fact}`;
        factEl.classList.remove('hidden');
      } else {
        const s = shapes[i];
        displayEl.textContent = s.name; wordEl.textContent = "Shape";
        imgEl.style.display = "none";
        displayEl.style.color = s.color;
        factEl.textContent = `üí° Did you know? ${s.fact}`;
        factEl.classList.remove('hidden');
      }
    }

    // ===== BUTTON ACTIONS =====
    const addBtn = (id, action) => {
      const b = document.getElementById(id);
      if (b) b.onclick = () => {
        if (!b.disabled) {
          playSound('pop', 0.4);
          tapEffect(b);
          action();
        }
      };
    };
    
    // MODE SWITCH
    const setMode = (m) => {
      mode = m; i = 0; showCurrent();
      document.querySelectorAll('#modeABC,#mode123,#modeShapes').forEach(b => b.style.opacity = 0.6);
      document.getElementById(m === "abc" ? "modeABC" : m === "123" ? "mode123" : "modeShapes").style.opacity = 1;
      speak(`Let's learn ${m === 'abc' ? 'letters' : m === '123' ? 'numbers' : 'shapes'}!`, 0.8, 1.4);
    };
    
    addBtn('modeABC', () => setMode("abc"));
    addBtn('mode123', () => setMode("123"));
    addBtn('modeShapes', () => setMode("shapes"));
    
    // ===== GESTURE SYSTEM =====
    let touchStartX = 0, touchStartY = 0, touchStartTime = 0;
    let lastTapTime = 0;
    
    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    }
    
    function handleTouchEnd(e) {
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      const deltaTime = Date.now() - touchStartTime;
      
      // Determine if it's a tap vs swipe
      const isTap = Math.abs(deltaX) < 30 && Math.abs(deltaY) < 30 && deltaTime < 200;
      
      if (isTap) {
        // Double-tap detection
        const now = Date.now();
        if (now - lastTapTime < 500) {
          // Double-tap: Sing
          handleDoubleTap();
        } else {
          // Single-tap: Sound
          handleTap();
        }
        lastTapTime = now;
      } else {
        // It's a swipe
        const absX = Math.abs(deltaX);
        const absY = Math.abs(deltaY);
        
        if (absX > absY) {
          // Horizontal swipe
          if (deltaX > 50) {
            handleSwipeRight();
          } else if (deltaX < -50) {
            handleSwipeLeft();
          }
        } else {
          // Vertical swipe
          if (deltaY > 50 && !drawScreenEl.classList.contains('hidden')) {
            handleSwipeDown();
          } else if (deltaY < -50 && drawScreenEl.classList.contains('hidden')) {
            handleSwipeUp();
          }
        }
      }
    }
    
    function handleTap() {
      playSound('pop', 0.3);
      if (mode === "abc") {
        const p = letters[i];
        speak(`${p.s} as in ${p.w} ‚Ä¶ ${p.l} ‚Ä¶ ${p.w}`, 0.75, 1.3);
      } else if (mode === "123") {
        speak(`${numbers[i].n} ‚Ä¶ ${numbers[i].w}! Count with me!`, 0.8, 1.4);
      } else {
        speak(shapes[i].speak, 0.8, 1.4);
      }
    }
    
    function handleDoubleTap() {
      playSound('sparkleSound', 0.4);
      if (mode === "abc") {
        singABC();
      } else if (mode === "123") {
        singNumbers();
      } else {
        speak("Circles, squares, triangles too! Stars and hearts just for you!", 0.9, 1.5);
      }
    }
    
    function handleSwipeLeft() {
      i = (i + 1) % (mode === "abc" ? letters.length : mode === "123" ? numbers.length : shapes.length);
      showCurrent();
      updateProgress();
      showGestureHint("Next!");
    }
    
    function handleSwipeRight() {
      const len = mode === "abc" ? letters.length : mode === "123" ? numbers.length : shapes.length;
      i = (i - 1 + len) % len;
      showCurrent();
      showGestureHint("Previous!");
    }
    
    function handleSwipeUp() {
      openDrawingForTrace();
      showGestureHint("Let's draw!");
    }
    
    function handleSwipeDown() {
      if (!drawScreenEl.classList.contains('hidden')) {
        drawScreenEl.classList.add('hidden');
        mainEl.classList.remove('hidden');
        if (drawMode === 'trace') {
          celebrate();
          updateProgress();
          speak("Great tracing! You did it!", 0.9, 1.5);
        }
      }
    }
    
    function showGestureHint(text) {
      gestureHint.textContent = text;
      gestureHint.classList.remove('hidden');
      setTimeout(() => gestureHint.classList.add('hidden'), 2000);
    }
    
    // Add event listeners
    mainEl.addEventListener('touchstart', handleTouchStart);
    mainEl.addEventListener('touchend', handleTouchEnd);
    drawScreenEl.addEventListener('touchstart', handleTouchStart);
    drawScreenEl.addEventListener('touchend', handleTouchEnd);
    
    // TAP TO TRACE (also works for click on desktop)
    const openDrawingForTrace = () => {
      drawMode = "trace";
      document.getElementById('modeTrace').style.opacity = 1;
      document.getElementById('modeColor').style.opacity = 0.6;
      drawScreenEl.classList.remove('hidden');
      mainEl.classList.add('hidden');
      document.getElementById('traceGuide').classList.toggle('hidden', mode === 'shapes');
      resizeCanvas();
      playSound('pop', 0.3);
      showMascot(`Trace the ${mode === 'abc' ? 'letter' : mode === '123' ? 'number' : 'shape'} carefully!`);
    };
    
    displayEl.onclick = openDrawingForTrace;
    imgEl.onclick = openDrawingForTrace;
    
    // ===== SINGING FEATURES =====
    function singABC() {
      const alphabet = "A B C D E F G H I J K L M N O P Q R S T U V W X Y Z";
      speak(alphabet, 1.2, 1.6);
      setTimeout(() => speak("Now I know my ABCs, next time won't you sing with me!", 1, 1.5), 3000);
    }
    
    function singNumbers() {
      const nums = "1 2 3 4 5 6 7 8 9 10";
      speak(nums, 1, 1.4);
      setTimeout(() => speak("Great counting! Let's do it again!", 1, 1.5), 2000);
    }
    
    // ===== DRAWING ENGINE =====
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false, lastX = 0, lastY = 0, lastTime = 0;
    
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * devicePixelRatio;
      canvas.height = rect.height * devicePixelRatio;
      ctx.resetTransform();
      ctx.scale(devicePixelRatio, devicePixelRatio);
      drawGuide();
    }
    window.addEventListener('resize', resizeCanvas);
    
    function drawGuide() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (drawMode !== "trace") return;
      
      const rect = canvas.getBoundingClientRect();
      const size = Math.min(rect.width, rect.height) * 0.7;
      const cx = rect.width / 2;
      const cy = rect.height / 2;
      
      ctx.strokeStyle = 'rgba(0,0,0,0.08)';
      ctx.lineWidth = 12;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      if (mode === "abc") {
        ctx.font = `bold ${size * 1.3}px Fredoka One`;
        ctx.fillStyle = 'rgba(0,0,0,0.05)';
        ctx.textAlign = 'center';
        ctx.fillText(letters[i].l, cx, cy + size * 0.15);
      } else if (mode === "123") {
        ctx.font = `bold ${size * 1.3}px Fredoka One`;
        ctx.fillStyle = 'rgba(0,0,0,0.05)';
        ctx.textAlign = 'center';
        ctx.fillText(numbers[i].n, cx, cy + size * 0.15);
      } else {
        const path = new Path2D(shapes[i].path(Math.min(rect.width, rect.height) / 3));
        ctx.stroke(path);
      }
    }
    
    function saveState() {
      undoStack.push(canvas.toDataURL());
      if (undoStack.length > 10) undoStack.shift();
    }
    
    function startDraw(e) {
      drawing = true;
      const r = canvas.getBoundingClientRect();
      lastX = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
      lastY = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
      lastTime = performance.now();
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
    }
    
    function draw(e) {
      if (!drawing) return;
      const r = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
      const now = performance.now();
      const dist = Math.hypot(x - lastX, y - lastY);
      const time = Math.max(1, now - lastTime);
      const speed = dist / time;
      const width = Math.max(4, Math.min(40, 120 / speed));
      
      ctx.lineWidth = width;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = currentColor;
      ctx.globalAlpha = drawMode === 'trace' ? 0.8 : 1;
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
      
      lastX = x; lastY = y; lastTime = now;
      if (speed > 0.5) playSound('scribble', 0.2);
    }
    
    function stopDraw() {
      if (drawing) {
        drawing = false;
        saveState();
      }
      ctx.beginPath();
    }
    
    canvas.addEventListener('pointerdown', startDraw);
    canvas.addEventListener('pointermove', draw);
    canvas.addEventListener('pointerup', stopDraw);
    canvas.addEventListener('pointerleave', stopDraw);
    
    // Color picker
    document.querySelectorAll('.crayon').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.crayon').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentColor = btn.dataset.color;
        playSound('pop', 0.3);
      };
    });
    
    // Drawing mode buttons
    document.getElementById('modeTrace').onclick = () => {
      drawMode = "trace";
      drawGuide();
      document.getElementById('modeTrace').style.opacity = 1;
      document.getElementById('modeColor').style.opacity = 0.6;
      document.getElementById('traceGuide').classList.toggle('hidden', mode === 'shapes');
      playSound('pop', 0.3);
    };
    
    document.getElementById('modeColor').onclick = () => {
      drawMode = "color";
      document.getElementById('modeColor').style.opacity = 1;
      document.getElementById('modeTrace').style.opacity = 0.6;
      document.getElementById('traceGuide').classList.add('hidden');
      playSound('pop', 0.3);
    };
    
    addBtn('undoBtn', () => {
      if (undoStack.length > 0) {
        undoStack.pop();
        const img = new Image();
        img.src = undoStack[undoStack.length - 1] || '';
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (undoStack.length > 0) ctx.drawImage(img, 0, 0);
          else drawGuide();
        };
        playSound('pop', 0.3);
      }
    });
    
    addBtn('clearBtn', () => {
      undoStack = [];
      drawGuide();
      showMascot("All clean! Let's try again!");
    });
    
    // ===== INITIALIZATION =====
    window.onload = () => {
      resizeCanvas();
      showCurrent();
      speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
      setTimeout(() => {
        showMascot("Hi! I'm AlphaPal! Tap to hear, swipe to explore!");
        showGestureHint("Tap: Sound | Swipe left/right: Next/Prev | Swipe up: Draw");
      }, 1000);
      
      setTimeout(() => {
        if (confirm("Want happy background music? üéµ")) {
          bgMusicEnabled = true;
          playSound('bgMusic', 0.2);
        }
      }, 3000);
    };
  </script>
</body>
</html>
