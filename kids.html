<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AlphaPal • ABC, 123 & Shapes for Kids</title>
  <script src="https://cdn.tailwindcss.com">script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Fredoka:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(135deg, #fde68a 0%, #c084fc 50%, #a5f3fc 100%);
      min-height: 100dvh;
      margin: 0;
      overflow: hidden;
      touch-action: manipulation;
    }
    h1, h2, .big-text { font-family: 'Fredoka One', sans-serif; }
    .rainbow {
      background: linear-gradient(90deg, #ff6bcb, #ff9d80, #ffd580, #a0e7ff, #9fffcb, #ff6bcb);
      background-size: 300%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: rainbow 12s linear infinite;
    }
    @keyframes rainbow { 0% { background-position: 0% 50%; } 100% { background-position: 300% 50%; } }
    .glass { background: rgba(255,255,255,0.35); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.6); }
    .btn-big { min-width: 100px; min-height: 80px; transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .btn-big:active, .tappable:active { transform: scale(0.92); }
    .float { animation: float 5s ease-in-out infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    .sparkle { animation: sparkle 1.8s infinite; }
    @keyframes sparkle { 0%,100% { transform: scale(1) rotate(0); } 50% { transform: scale(1.3) rotate(10deg); } }
    .confetti {
      position: fixed; width: 16px; height: 16px; pointer-events: none;
      background: #ff6bcb; z-index: 9999; animation: fall 4s linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-120px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(1080deg); opacity: 0; }
    }
    .mascot-bounce { animation: bounce 3s infinite; }
    @keyframes bounce { 0%,100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-30px) rotate(5deg); } }
    .star { transition: all 0.6s ease; }
    .star.earned { transform: scale(1.6) rotate(360deg); filter: drop-shadow(0 0 20px gold); }
    canvas { border-radius: 2.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
  style>
head>
<body class="flex flex-col text-gray-900">

  <!-- Mascot -->
  <div id="mascot" class="fixed top-4 left-4 w-32 h-32 z-50 mascot-bounce opacity-0">
    <svg viewBox="0 0 120 120" class="drop-shadow-2xl">
      <circle cx="60" cy="60" r="55" fill="#ff6bcb"/>
      <circle cx="40" cy="48" r="12" fill="white"/>
      <circle cx="80" cy="48" r="12" fill="white"/>
      <circle cx="37" cy="45" r="7" fill="#000"/>
      <circle cx="77" cy="45" r="7" fill="#000"/>
      <path d="M35 75 Q60 100 85 75" stroke="#ff1493" stroke-width="9" fill="none" stroke-linecap="round"/>
      <circle cx="25" cy="30" r="15" fill="#ffaecb"/>
      <circle cx="95" cy="30" r="15" fill="#ffaecb"/>
    svg>
  div>

  <!-- Header -->
  <header class="text-center pt-8 pb-4 relative z-10">
    <h1 class="text-6xl font-bold rainbow sparkle">AlphaPalh1>
    <p class="text-3xl text-purple-800 font-bold mt-1">Learn with Fun!p>

    <div class="mt-10 flex justify-center gap-8 px-4">
      <button id="modeABC" class="btn-big active px-16 py-8 bg-gradient-to-br from-purple-500 to-pink-500 text-white text-4xl rounded-3xl shadow-2xl font-bold">ABCbutton>
      <button id="mode123" class="btn-big px-16 py-8 bg-gradient-to-br from-cyan-500 to-blue-600 text-white text-4xl rounded-3xl shadow-2xl font-bold opacity-70">123button>
      <button id="modeShapes" class="btn-big px-16 py-8 bg-gradient-to-br from-green-500 to-teal-600 text-white text-4xl rounded-3xl shadow-2xl font-bold opacity-70">Shapesbutton>
    div>
  header>

  <!-- Progress Stars -->
  <div class="flex justify-center gap-6 my-6">
    <span class="star text-7xl">span>
    <span class="star text-7xl">span>
    <span class="star text-7xl">span>
    <span class="star text-7xl">span>
    <span class="star text-7xl">span>
  div>
  <p id="progressText" class="text-center text-2xl font-bold text-purple-700 mb-4">Tap or swipe to learn!p>

  <!-- Main Screen -->
  <main id="main" class="flex-1 flex flex-col items-center justify-center px-6 pb-20">
    <div class="text-center space-y-8">
      <div id="display" class="big-text text-28vw font-black leading-none sparkle tappable" style="color:#ff6bcb">Adiv>
      <h2 id="word" class="text-7xl font-bold text-purple-800 drop-shadow-2xl">appleh2>
      <img id="image" src="" alt="" class="w-80 h-80 mx-auto float rounded-3xl shadow-2xl bg-white p-8 object-contain">

      <p id="funFact" class="text-2xl text-blue-700 font-bold italic bg-white/70 glass rounded-3xl px-8 py-4 mx-4 hidden">
        Did you know? Apples float because they're 25% air!
      p>
    div>
  main>

  <!-- Drawing Screen -->
  <div id="drawScreen" class="hidden fixed inset-0 bg-gradient-to-br from-pink-300 via-purple-300 to-cyan-300 flex flex-col items-center justify-center z-50 p-6">
    <canvas id="canvas" class="w-full aspect-square glass">canvas>

    <!-- Crayons -->
    <div class="mt-10 flex flex-wrap justify-center gap-8">
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#ff1493" style="background:#ff1493">button>
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#ff6bcb" style="background:#ff6bcb">button>
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#ff9d00" style="background:#ff9d00">button>
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#ffed4e" style="background:#ffed4e">button>
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#4eff7b" style="background:#4eff7b">button>
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#4e9fff" style="background:#4e9fff">button>
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#9c4eff" style="background:#9c4eff">button>
      <button class="crayon w-20 h-20 rounded-full shadow-2xl border-6 border-white tappable" data-color="#000" style="background:#000">button>
    div>

    <div class="mt-12 flex gap-8 flex-wrap justify-center">
      <button id="modeTrace" class="px-16 py-8 bg-purple-600 text-white text-4xl rounded-3xl shadow-2xl font-bold active">Tracebutton>
      <button id="modeColor" class="px-16 py-8 bg-pink-600 text-white text-4xl rounded-3xl shadow-2xl font-bold opacity-70">Colorbutton>
      <button id="undoBtn" class="px-16 py-8 bg-blue-600 text-white text-4xl rounded-3xl shadow-2xl font-bold">UndoUndoBtn>
      <button id="clearBtn" class="px-16 py-8 bg-red-600 text-white text-4xl rounded-3xl shadow-2xl font-bold">Clearbutton>
    div>

    <p class="mt-10 text-white text-3xl font-bold bg-black/40 rounded-full px-8 py-4">Swipe down to go backp>
  div>

  <!-- Audio -->
  <audio id="pop" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3">audio>
  <audio id="sparkleSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magical-coin-win-1937.mp3">audio>
  <audio id="scribble" src="https://assets.mixkit.co/sfx/preview/mixkit-pencil-writing-fast-3343.mp3">audio>
  <audio id="celebration" src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-won-3110.mp3">audio>
  <audio id="bgMusic" loop src="https://assets.mixkit.co/music/preview/mixkit-optimistic-children-background-2490.mp3">audio>

  <script>
    // COMPLETE DATA (all 26 letters + 10 numbers + 9 shapes)
    const letters = [
      {l:"A", s:"ă", w:"apple",      e:"1f34e", fact:"Apples float because they're 25% air!"},
      {l:"B", s:"b", w:"ball",       e:"26bd",  fact:"Balls can bounce really high!"},
      {l:"C", s:"k", w:"cat",        e:"1f408", fact:"Cats sleep 16 hours a day!"},
      {l:"D", s:"d", w:"dog",        e:"1f436", fact:"A dog's nose print is unique like a fingerprint!"},
      {l:"E", s:"ĕ", w:"elephant",   e:"1f418", fact:"Elephants never forget!"},
      {l:"F", s:"f", w:"fish",       e:"1f41f", fact:"Goldfish can see more colors than humans!"},
      {l:"G", s:"g", w:"giraffe",    e:"1f992", fact:"Giraffes have purple tongues!"},
      {l:"H", s:"h", w:"house",      e:"1f3e0", fact:"Houses keep us safe and warm!"},
      {l:"I", s:"ĭ", w:"ice cream",  e:"1f366", fact:"Ice cream makes everyone happy!"},
      {l:"J", s:"j", w:"jellyfish",  e:"1fabc", fact:"Jellyfish have no brain!"},
      {l:"K", s:"k", w:"kite",       e:"1fa81", fact:"Kites can fly higher than airplanes!"},
      {l:"L", s:"l", w:"lion",       e:"1f981", fact:"A lion's roar can be heard 5 miles away!"},
      {l:"M", s:"m", w:"monkey",     e:"1f412", fact:"Monkeys love bananas!"},
      {l:"N", s:"n", w:"nest",       e:"1faba", fact:"Birds build cozy nests!"},
      {l:"O", s:"ŏ", w:"octopus",    e:"1f419", fact:"Octopuses have three hearts!"},
      {l:"P", s:"p", w:"penguin",    e:"1f427", fact:"Penguins can't fly but they swim super fast!"},
      {l:"Q", s:"kw",w:"queen",      e:"1f451", fact:"Queen bees are the boss of the hive!"},
      {l:"R", s:"r", w:"rainbow",    e:"1f308", fact:"Rainbows have 7 colors!"},
      {l:"S", s:"s", w:"sun",        e:"2600",  fact:"The Sun is a big star!"},
      {l:"T", s:"t", w:"tiger",      e:"1f405", fact:"Tigers have striped skin, not just fur!"},
      {l:"U", s:"ŭ", w:"umbrella",   e:"2602",  fact:"Umbrellas keep us dry in rain!"},
      {l:"V", s:"v", w:"violin",     e:"1f3bb", fact:"Violins make beautiful music!"},
      {l:"W", s:"w", w:"watermelon", e:"1f349", fact:"Watermelon is 92% water!"},
      {l:"X", s:"ks",w:"xylophone",  e:"1fa95", fact:"Xylophones make fun sounds!"},
      {l:"Y", s:"y", w:"yak",        e:"1f402", fact:"Yaks live in very cold mountains!"},
      {l:"Z", s:"z", w:"zebra",      e:"1f993", fact:"No two zebras have the same stripes!"}
    ];

    const numbers = [
      {n:"1", w:"one",      e:"1f44d", c:"#ff6bcb", fact:"One is the very first number!"},
      {n:"2", w:"two",      e:"1f44c", c:"#ff9d9d", fact:"We have two hands!"},
      {n:"3", w:"three",    e:"1f64c", c:"#ffb380", fact:"Triangles have three sides!"},
      {n:"4", w:"four",     e:"1f919", c:"#ffed80", fact:"A square has four sides!"},
      {n:"5", w:"five",     e:"1f44c", c:"#bfff80", fact:"You have five fingers on each hand!"},
      {n:"6", w:"six",      e:"1f44a", c:"#80ffea", fact:"Bees make honey in six-sided cells!"},
      {n:"7", w:"seven",    e:"1f44b", c:"#80d4ff", fact:"Rainbows have seven colors!"},
      {n:"8", w:"eight",    e:"1f44f", c:"#c780ff", fact:"Octopuses have eight arms!"},
      {n:"9", w:"nine",     e:"1f44f", c:"#ff80c7", fact:"Cats are said to have nine lives!"},
      {n:"10",w:"ten",      e:"1f389", c:"#ffd580", fact:"You have ten fingers and ten toes!"}
    ];

    const shapes = [
      {name:"Circle",    speak:"This is a circle!",    path:d=>`M${d} ${d*0.3} a ${d*0.7} ${d*0.7} 0 1 1 0.1 0 a ${d*0.7} ${d*0.7} 0 1 1 -0.1 0`, color:"#ff6bcb", fact:"Circles have no corners and roll!"},
      {name:"Triangle",  speak:"This is a triangle!",  path:d=>`M${d} ${d*0.3} L${d*1.7} ${d*1.7} L${d*0.3} ${d*1.7} Z`, color:"#4e9fff", fact:"Triangles are very strong shapes!"},
      {name:"Square",    speak:"This is a square!",    path:d=>`M${d*0.3} ${d*0.3} h${d*1.4} v${d*1.4} h-${d*1.4} Z`, color:"#ff9d00", fact:"Squares have four equal sides!"},
      {name:"Rectangle", speak:"This is a rectangle!", path:d=>`M${d*0.2} ${d*0.6} h${d*1.6} v${d*0.8} h-${d*1.6} Z`, color:"#9c4eff", fact:"Doors and books are rectangles!"},
      {name:"Star",      speak:"This is a star!",      path:d=>`M${d} ${d*0.2} L${d*1.15} ${d*0.8} L${d*1.8} ${d*0.8} L${d*1.3} ${d*1.3} L${d*1.5} ${d*1.9} L${d} ${d*1.5} L${d*0.5} ${d*1.9} L${d*0.7} ${d*1.3} L${d*0.2} ${d*0.8} L${d*0.85} ${d*0.8} Z`, color:"#ffed4e", fact:"Stars shine bright at night!"},
      {name:"Heart",     speak:"This is a heart!",     path:d=>`M${d} ${d*1.3} Q${d*0.2} ${d*0.6} ${d*0.5} ${d*0.4} Q${d*0.85} ${d*0.2} ${d} ${d*0.6} Q${d*1.15} ${d*0.2} ${d*1.5} ${d*0.4} Q${d*1.8} ${d*0.6} ${d} ${d*1.3} Z`, color:"#ff1493", fact:"Hearts show love!"},
      {name:"Diamond",   speak:"This is a diamond!",   path:d=>`M${d} ${d*0.4} L${d*1.6} ${d} L${d} ${d*1.6} L${d*0.4} ${d} Z`, color:"#4eff7b", fact:"Diamonds are the hardest gems!"},
      {name:"Pentagon",  speak:"This is a pentagon!",  path:d=>`M${d} ${d*0.4} L${d*1.55} ${d*0.75} L${d*1.35} ${d*1.5} L${d*0.65} ${d*1.5} L${d*0.45} ${d*0.75} Z`, color:"#ffaecb", fact:"The Pentagon building has five sides!"},
      {name:"Hexagon",   speak:"This is a hexagon!",   path:d=>`M${d*1.3} ${d*0.5} L${d*1.7} ${d} L${d*1.3} ${d*1.5} L${d*0.7} ${d*1.5} L${d*0.3} ${d} L${d*0.7} ${d*0.5} Z`, color:"#80d4ff", fact:"Honeycombs are made of hexagons!"}
    ];

    // STATE & ELEMENTS
    let mode = "abc", idx = 0, drawMode = "color", currentColor = "#ff1493", bgMusicEnabled = false;
    let progress = {abc:0, num:0, shapes:0}, undoStack = [];

    const displayEl = document.getElementById('display');
    const wordEl = document.getElementById('word');
    const imgEl = document.getElementById('image');
    const funFactEl = document.getElementById('funFact');
    const mascotEl = document.getElementById('mascot');
    const mainEl = document.getElementById('main');
    const drawScreenEl = document.getElementById('drawScreen');
    const stars = document.querySelectorAll('.star');
    const progressText = document.getElementById('progressText');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const play = (id, vol=1) => {
      const a = document.getElementById(id);
      if(a) { a.currentTime = 0; a.volume = vol; a.play().catch(()=>{}); }
    };

    const speak = (text, rate=0.85, pitch=1.5) => {
      const u = new SpeechSynthesisUtterance(text);
      u.rate = rate; u.pitch = pitch; u.volume = 0.9;
      const voices = speechSynthesis.getVoices();
      u.voice = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('child')) || voices.find(v => v.lang.startsWith('en')) || voices[0];
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    };

    const celebrate = () => {
      play('celebration', 0.6);
      for(let i=0; i<50; i++){
        setTimeout(()=>{
          const c = document.createElement('div');
          c.className = 'confetti';
          c.style.left = Math.random()*100+'vw';
          c.style.background = `hsl(${Math.random()*360},90%,65%)`;
          c.style.animationDelay = Math.random()*0.6+'s';
          document.body.appendChild(c);
          setTimeout(()=>c.remove(),5000);
        },i*80);
      }
    };

    const cheer = (msg) => {
      mascotEl.style.opacity = 1;
      setTimeout(()=>speak(msg,0.9,1.6),300);
    };

    const updateProgress = () => {
      const key = mode === 'abc' ? 'abc' : mode === '123' ? 'num' : 'shapes';
      progress[key]++;
      const total = Object.values(progress).reduce((a,b)=>a+b,0);
      stars.forEach((s,i)=> s.classList.toggle('earned', i < total));
      progressText.textContent = total >= 5 ? "Super Star!" : `Great job! ${total} stars earned!`;
      if(total >= 5) setTimeout(()=>{ celebrate(); speak("Wow! You got all the stars! You're amazing!",0.8,1.7); },800);
    };

    const showCurrent = () => {
      play('sparkleSound',0.5);
      const item = mode==="abc" ? letters[idx] : mode==="123" ? numbers[idx] : shapes[idx];

      if(mode==="abc"){
        displayEl.textContent = item.l;
        wordEl.textContent = item.w;
        imgEl.src = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${item.e}.svg`;
        imgEl.style.display = "block";
        displayEl.style.color = `hsl(${idx*360/26},90%,60%)`;
      } else if(mode==="123"){
        displayEl.textContent = item.n;
        wordEl.textContent = item.w;
        imgEl.src = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${item.e}.svg`;
        imgEl.style.display = "block";
        displayEl.style.color = item.c;
      } else {
        displayEl.textContent = item.name;
        wordEl.textContent = "Shape!";
        imgEl.style.display = "none";
        displayEl.style.color = item.color;
      }
      funFactEl.textContent = `Did you know? ${item.fact}`;
      funFactEl.classList.remove('hidden');

      setTimeout(()=>{
        if(mode==="abc") speak(`${item.l} says ${item.s} as in ${item.w}`);
        else if(mode==="123") speak(`${item.n} — ${item.w}`);
        else speak(item.speak);
      },600);
    };

    const setMode = (m) => {
      mode = m; idx = 0;
      document.querySelectorAll('.btn-big').forEach(b=> {
        b.classList.remove('active'); b.style.opacity='0.7';
      });
      const btnId = m==='abc'?'modeABC':m==='123'?'mode123':'modeShapes';
      document.getElementById(btnId).classList.add('active');
      document.getElementById(btnId).style.opacity='1';
      showCurrent();
      speak(`Let's learn ${m==='abc'?'letters':m==='123'?'numbers':'shapes'}!`,0.9,1.5);
    };

    document.getElementById('modeABC').onclick = ()=>setMode('abc');
    document.getElementById('mode123').onclick = ()=>setMode('123');
    document.getElementById('modeShapes').onclick = ()=>setMode('shapes');

    // Touch gestures
    let startX=0, startY=0, lastTap=0;
    const onStart = e => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; };
    const onEnd = e => {
      const dx = e.changedTouches[0].clientX - startX;
      const dy = e.changedTouches[0].clientY - startY;

      // Tap = speak
      if(Math.abs(dx)<40 && Math.abs(dy)<40){
        const now = Date.now();
        if(now - lastTap < 600){
          if(mode==="abc") speak("A B C D E F G H I J K L M N O P Q R S T U V W X Y Z!",1.1,1.5);
          else if(mode==="123") speak("One two three four five six seven eight nine ten!",1,1.4);
          else speak("Circle triangle square rectangle star heart diamond pentagon hexagon!",0.9,1.5);
        } else {
          const item = mode==="abc"?letters[idx]:mode==="123"?numbers[idx]:shapes[idx];
          if(mode==="abc") speak(`${item.l} ... ${item.s} ... ${item.w}`);
          else if(mode==="123") speak(`${item.n} is ${item.w}`);
          else speak(item.speak);
        }
        lastTap = now;
        play('pop',0.5);
        return;
      }

      // Swipe left = next
      if(dx < -60){
        const len = mode==="abc"?26:mode==="123"?10:9;
        idx = (idx + 1) % len;
        showCurrent();
        updateProgress();
        play('sparkleSound',0.6);
      }
      // Swipe right = previous
      else if(dx > 60){
        const len = mode==="abc"?26:mode==="123"?10:9;
        idx = (idx - 1 + len) % len;
        showCurrent();
      }
      // Swipe up = draw
      else if(dy < -80 && drawScreenEl.classList.contains('hidden')) openDrawing();
      // Swipe down on draw screen = back
      else if(dy > 80 && !drawScreenEl.classList.contains('hidden')){
        drawScreenEl.classList.add('hidden');
        mainEl.classList.remove('hidden');
        if(drawMode==='trace'){ celebrate(); updateProgress(); cheer("Yay! Perfect tracing!"); }
      }
    };

    mainEl.addEventListener('touchstart', onStart, {passive:true});
    mainEl.addEventListener('touchend', onEnd);
    drawScreenEl.addEventListener('touchstart', onStart, {passive:true});
    drawScreenEl.addEventListener('touchend', onEnd);

    // Drawing system
    const openDrawing = () => {
      drawMode = "trace";
      drawScreenEl.classList.remove('hidden');
      mainEl.classList.add('hidden');
      resizeCanvas();
      drawGuide();
      cheer(`Let's trace the ${mode==="abc"?'letter':mode==="123"?'number':'shape'}!`);
    };
    displayEl.onclick = imgEl.onclick = openDrawing;

    function resizeCanvas(){
      const r = canvas.getBoundingClientRect();
      canvas.width = r.width * devicePixelRatio;
      canvas.height = r.height * devicePixelRatio;
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      drawGuide();
    }
    window.addEventListener('resize', resizeCanvas);

    function drawGuide(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(drawMode !== "trace") return;
      const size = Math.min(canvas.width, canvas.height) * 0.7;
      const cx = canvas.width / 2 / devicePixelRatio;
      const cy = canvas.height / 2 / devicePixelRatio;

      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 30;
      ctx.lineCap = 'round';

      if(mode === "abc" || mode === "123"){
        ctx.font = `bold ${size*1.4}px Fredoka One`;
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(mode==="abc"?letters[idx].l : numbers[idx].n, cx, cy);
      } else {
        const path = new Path2D(shapes[idx].path(size/2));
        ctx.translate(cx, cy);
        ctx.stroke(path);
        ctx.translate(-cx, -cy);
      }
    }

    let drawing = false;
    canvas.addEventListener('touchstart', e => {
      drawing = true;
      const r = canvas.getBoundingClientRect();
      const x = e.touches[0].clientX - r.left;
      const y = e.touches[0].clientY - r.top;
      ctx.beginPath();
      ctx.moveTo(x,y);
    }, {passive:true});
    canvas.addEventListener('touchmove', e => {
      if(!drawing) return;
      e.preventDefault();
      const r = canvas.getBoundingClientRect();
      const x = e.touches[0].clientX - r.left;
      const y = e.touches[0].clientY - r.top;
      ctx.globalAlpha = drawMode==='trace'?0.9:1;
      ctx.lineWidth = 28;
      ctx.lineCap = 'round';
      ctx.strokeStyle = currentColor;
      ctx.lineTo(x,y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x,y);
      play('scribble',0.2);
    }, {passive:false});
    canvas.addEventListener('touchend', () => {
      if(drawing){
        drawing = false;
        undoStack.push(canvas.toDataURL());
        if(undoStack.length>15) undoStack.shift();
      }
    });

    // Crayons + buttons (same as before)
    document.querySelectorAll('.crayon').forEach(c=>{
      c.onclick = () => {
        document.querySelectorAll('.crayon').forEach(b=>b.classList.remove('ring-8','ring-white'));
        c.classList.add('ring-8','ring-white');
        currentColor = c.dataset.color;
        play('pop',0.5);
      };
    });
    document.querySelector('.crayon').classList.add('ring-8','ring-white');

    document.getElementById('modeTrace').onclick = () => { drawMode="trace"; drawGuide(); document.getElementById('modeTrace').style.opacity='1'; document.getElementById('modeColor').style.opacity='0.7'; };
    document.getElementById('modeColor').onclick = () => { drawMode="color"; ctx.clearRect(0,0,canvas.width,canvas.height); document.getElementById('modeColor').style.opacity='1'; document.getElementById('modeTrace').style.opacity='0.7'; };
    document.getElementById('undoBtn').onclick = () => {
      if(undoStack.length){
        undoStack.pop();
        const img = new Image();
        img.src = undoStack[undoStack.length-1] || '';
        img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); };
      }
    };
    document.getElementById('clearBtn').onclick = () => {
      undoStack = [];
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawGuide();
      cheer("All clean! Draw again!");
    };

    // INIT
    window.onload = () => {
      resizeCanvas();
      showCurrent();
      mascotEl.style.opacity = 1;
      speak("Hi friends! I'm AlphaPal! Tap anything to hear me talk! Swipe left for next!",0.9,1.6);
      setTimeout(()=>{
        if(confirm("Turn on happy music?")){
          document.getElementById('bgMusic').volume = 0.25;
          document.getElementById('bgMusic').play();
        }
      },4000);
    };
  script>
body>
html>
