<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weekly Math Quiz – Vynix AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  
  <!-- MathJax -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
      },
      chtml: { linebreaks: { automatic: true } }
    };
  </script>
  <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary: #4285F4;
      --gradient: linear-gradient(135deg, #4285F4, #D96570);
      --bg: #f8f9fc;
      --card: white;
      --text: #1f1f1f;
      --muted: #6c757d;
    }
    body {
      font-family: 'Outfit', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px 16px;
      min-height: 100vh;
      line-height: 1.5;
    }
    .container { max-width: 820px; margin: 0 auto; }
    h1 {
      text-align: center;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .subtitle { text-align: center; color: var(--muted); margin-bottom: 32px; }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .question { margin-bottom: 20px; }
    .question h3 { font-size: 1.25rem; margin: 0 0 16px; }
    .option {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin: 8px 0;
      background: #f0f4f9;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .option:hover { background: #e3e9f0; }
    .option input { margin-right: 12px; }
    .btn {
      display: block;
      width: 100%;
      max-width: 280px;
      margin: 40px auto 0;
      padding: 14px;
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
      background: var(--primary);
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: #3267d6; transform: translateY(-1px); }
    #result {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 40px 0;
      padding: 24px;
      border-radius: 16px;
    }
    #result.good  { background: #e6ffe6; color: #006400; }
    #result.ok    { background: #fff3cd; color: #856404; }
    #result.bad   { background: #ffebee; color: #c62828; }
    .loading, .status { text-align: center; font-size: 1.2rem; color: var(--muted); padding: 60px 0; }
    .error-msg { color: #c62828; text-align: center; padding: 24px; font-size: 1.1rem; }
    .small { font-size: 0.9rem; color: var(--muted); text-align: center; margin: 32px 0; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Weekly Math Challenge</h1>
    <p class="subtitle">Complete set of 15 harder mathematics questions</p>

    <div id="status" class="loading">Checking quiz availability...</div>
    <div id="error" class="error-msg" style="display:none;"></div>

    <form id="quizForm" style="display:none;">
      <div id="questionsContainer"></div>
      <button type="submit" class="btn">Submit Answers & See Score</button>
    </form>

    <div id="result" style="display:none;"></div>

    <div style="text-align:center; margin:48px 0;">
      <button class="btn" style="background:#6c757d;" onclick="location.reload()">Refresh / Load Latest Set</button>
      <br><br>
      <a href="index.html" style="color:#4285F4; text-decoration:none; font-weight:500;">← Back to Chat</a>
    </div>

    <p class="small">All users see the same 15 questions • New set generated automatically every 7 days</p>
  </div>

  <script>
    // ── Firebase Config (same as main app) ─────────────────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const remoteConfig = firebase.remoteConfig();

    const MODEL_ID = "grok-4-1-fast-reasoning";
    const API_URL = "https://api.x.ai/v1/chat/completions";
    let XAI_API_KEY = "";

    const QUIZ_REF = database.ref('shared_quizzes/math_weekly');
    const QUESTIONS_COUNT_TOTAL = 15;
    const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;

    // ── Load xAI API key from Remote Config ────────────────────────────────────
    async function loadApiKey() {
      remoteConfig.settings = { minimumFetchIntervalMillis: 0 };
      try {
        await remoteConfig.fetchAndActivate();
        XAI_API_KEY = remoteConfig.getValue('xai_api_key').asString();
        if (!XAI_API_KEY) throw new Error("xAI API key missing in Remote Config");
        return true;
      } catch (err) {
        console.error("Remote Config failed:", err);
        showError("Cannot load API configuration. Please try again later.");
        return false;
      }
    }

    // ── Generate & save 15 new hard questions ──────────────────────────────────
    async function generateAndSaveQuestions() {
      if (!XAI_API_KEY) {
        const ok = await loadApiKey();
        if (!ok) return false;
      }

      setStatus("Generating new set of 15 challenging mathematics questions...");

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${XAI_API_KEY}`
          },
          body: JSON.stringify({
            model: MODEL_ID,
            temperature: 0.75,
            max_tokens: 3200,
            messages: [
              {
                role: "system",
                content: `You are an advanced mathematics quiz creator (grade 11–undergraduate level).
Generate exactly ${QUESTIONS_COUNT_TOTAL} difficult multiple-choice questions covering a mix of algebra, calculus, linear algebra, probability, number theory, geometry, trigonometry, differential equations, complex numbers, etc.
Each question must have:
- Precise question text using LaTeX: \\( ... \\) for inline math, $$ ... $$ for display equations when appropriate
- Exactly 4 options labeled A) B) C) D)
- Exactly one correct answer

Return ONLY a valid JSON array — no extra text, no markdown, no explanations:

[
  {
    "question": "...",
    "options": ["A) ...", "B) ...", "C) ...", "D) ..."],
    "correct": "A"   // or B, C, D
  }
]

Must be exactly ${QUESTIONS_COUNT_TOTAL} items. Nothing else outside the array.`
              },
              { role: "user", content: "Create 15 brand new difficult maths multiple-choice questions right now." }
            ]
          })
        });

        if (!res.ok) throw new Error(`API status ${res.status}`);

        const data = await res.json();
        const content = data.choices?.[0]?.message?.content?.trim();

        let parsed;
        try {
          parsed = JSON.parse(content);
        } catch (e) {
          console.error("Bad JSON response:", content);
          throw new Error("Could not parse questions from API");
        }

        if (!Array.isArray(parsed) || parsed.length !== QUESTIONS_COUNT_TOTAL) {
          throw new Error(`Expected exactly ${QUESTIONS_COUNT_TOTAL} questions, received ${parsed?.length || 'none'}`);
        }

        await QUIZ_REF.set({
          last_generated: firebase.database.ServerValue.TIMESTAMP,
          questions: parsed
        });

        return parsed;

      } catch (err) {
        console.error(err);
        showError(`Failed to generate new question set: ${err.message}`);
        return false;
      }
    }

    // ── Load or regenerate logic ───────────────────────────────────────────────
    async function loadOrRefreshQuiz() {
      setStatus("Loading weekly math challenge...");

      try {
        const snap = await QUIZ_REF.once('value');
        const data = snap.val();

        const now = Date.now();
        let questions = data?.questions;

        // No data OR older than 1 week → regenerate
        if (!data || !questions || !data.last_generated || (now - data.last_generated > ONE_WEEK_MS)) {
          setStatus("Current set is outdated — generating new 15-question challenge...");
          questions = await generateAndSaveQuestions();
          if (!questions) return;
        }

        // Show ALL questions
        displayQuestions(questions);

      } catch (err) {
        console.error(err);
        showError("Cannot load the question set right now. Please try again later.");
      }
    }

    function displayQuestions(questions) {
      const container = document.getElementById("questionsContainer");
      container.innerHTML = "";

      questions.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "card question";
        div.innerHTML = `
          <h3>Question ${i+1}</h3>
          <div>${q.question
            .replace(/\$\$([\s\S]*?)\$\$/g, '<div style="margin:20px 0; text-align:center; font-size:1.1rem;">$1</div>')
            .replace(/\\\((.*?)\\\)/g, '<span class="math">$1</span>')}
          </div>
          <div class="options">
            ${q.options.map((opt, j) => `
              <label class="option">
                <input type="radio" name="q${i}" value="${String.fromCharCode(65+j)}" required>
                ${opt}
              </label>
            `).join('')}
          </div>
          <input type="hidden" name="correct${i}" value="${q.correct}">
        `;
        container.appendChild(div);
      });

      document.getElementById("status").style.display = "none";
      document.getElementById("quizForm").style.display = "block";
      MathJax.typesetPromise().catch(e => console.warn("MathJax render failed:", e));
    }

    // ── Submit ──────────────────────────────────────────────────────────────────
    document.getElementById("quizForm").addEventListener("submit", e => {
      e.preventDefault();
      const form = new FormData(e.target);
      let score = 0;
      const total = QUESTIONS_COUNT_TOTAL;

      for (let i = 0; i < total; i++) {
        if (form.get(`q${i}`) === form.get(`correct${i}`)) score++;
      }

      const result = document.getElementById("result");
      let msg = `You scored ${score} / ${total}`;

      if (score === total) {
        result.className = "good";
        msg += " — Outstanding performance!";
      } else if (score >= 10) {
        result.className = "ok";
        msg += " — Very strong result!";
      } else if (score >= 7) {
        result.className = "ok";
        msg += " — Good effort!";
      } else {
        result.className = "bad";
        msg += " — Keep practicing — these are challenging!";
      }

      result.textContent = msg;
      result.style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    function setStatus(text) {
      document.getElementById("status").textContent = text;
      document.getElementById("status").style.display = "block";
    }

    function showError(msg) {
      document.getElementById("error").textContent = msg;
      document.getElementById("error").style.display = "block";
      document.getElementById("status").style.display = "none";
    }

    // Start
    loadOrRefreshQuiz();
  </script>
</body>
</html>
