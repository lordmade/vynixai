<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="google-adsense-account" content="ca-pub-1322747625222761">
  <title>Subscriptions</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Add AdSense JavaScript Library -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=pub-1322747625222761"
          crossorigin="anonymous"></script>
  <style>
    :root {
      --bg: #ffffff;
      --card-bg: #f9f9f9;
      --text-primary: #1a1a1a;
      --text-secondary: #606060;
      --border: #e0e0e0;
      --accent: #6200ea;
      --gradient: linear-gradient(45deg, #3b82f6, #a855f7);
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .sidebar {
      width: 72px;
      background-color: var(--card-bg);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      transition: width 0.3s ease;
      z-index: 20;
      padding-top: 56px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .sidebar:hover {
      width: 240px;
    }
    .sidebar button {
      display: flex;
      align-items: center;
      background: var(--gradient);
      color: #ffffff;
      border-radius: 9999px; /* Pill shape */
      padding: 8px 12px;
      margin: 4px;
      transition: transform 0.2s ease;
      width: calc(100% - 8px);
      justify-content: flex-start;
    }
    .sidebar button:hover {
      transform: scale(1.05);
    }
    .sidebar .material-icons {
      font-size: 24px;
      margin-right: 8px;
    }
    .sidebar span:not(.material-icons) {
      display: none;
      font-size: 14px;
      font-weight: 500;
    }
    .sidebar:hover span:not(.material-icons) {
      display: inline;
    }
    .video-grid {
      padding: 16px;
      margin-top: 96px; /* Adjusted for new header elements */
      margin-left: 72px;
      margin-bottom: 64px;
      transition: margin-left 0.3s ease;
    }
    .sidebar:hover ~ .video-grid {
      margin-left: 240px;
    }
    .video-card {
      transition: transform 0.2s ease;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .video-card:hover {
      transform: translateY(-4px);
    }
    .thumbnail {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 8px;
      overflow: hidden;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 0 1rem;
    }
    .header-controls select,
    .header-controls input {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 9999px; /* Pill shape */
      background: #f1f1f1;
      font-size: 0.875rem;
    }
    .header-controls input:focus {
      border-color: var(--accent);
      outline: none;
    }
    .manage-subs-btn {
      background: var(--gradient);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 9999px; /* Pill shape */
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .manage-subs-btn:hover {
      transform: scale(1.05);
    }
    .status-bar {
      display: flex;
      overflow-x: auto;
      padding: 8px 16px;
      gap: 16px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .status-bar::-webkit-scrollbar {
      display: none;
    }
    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 72px;
      cursor: pointer;
      flex-shrink: 0;
      scroll-snap-align: start;
    }
    .status-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: var(--gradient);
      color: white;
      font-size: 24px;
      font-weight: bold;
      overflow: hidden;
    }
    .status-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .status-label {
      font-size: 12px;
      text-align: center;
      margin-top: 4px;
      color: var(--text-secondary);
      max-width: 72px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--card-bg);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 64px;
      z-index: 10;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      padding: 0 8px;
    }
    .bottom-nav button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      background: none;
      color: var(--text-primary);
      font-size: 10px;
      font-weight: 500;
      transition: transform 0.2s ease, color 0.2s ease;
      border-radius: 9999px; /* Pill shape for nav buttons */
      padding: 0.25rem;
      margin: 0 0.25rem;
    }
    .bottom-nav button.active, .bottom-nav button:hover {
      color: var(--accent);
      transform: scale(1.1);
      background: rgba(98, 0, 234, 0.1); /* Subtle bg on active */
    }
    .bottom-nav button .material-icons {
      font-size: 24px;
      margin-bottom: 4px;
    }
    .avatar {
      background-color: var(--accent);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      border-radius: 50%;
    }
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--card-bg);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -2px 16px rgba(0, 0, 0, 0.2);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 50;
      max-height: 80vh;
      overflow-y: auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }
    .bottom-sheet.active {
      transform: translateY(0);
    }
    .bottom-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
    }
    .bottom-sheet button[type="submit"], .bottom-sheet button#select-video, .bottom-sheet button#select-status-image {
      background: var(--gradient);
      color: #ffffff;
      border-radius: 9999px; /* Pill shape */
      padding: 8px 16px;
      font-weight: 500;
      text-align: center;
    }
    .bottom-sheet button#select-video:hover, .bottom-sheet button#select-status-image:hover, .bottom-sheet button[type="submit"]:hover {
      transform: scale(1.05);
    }
    .channel-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .channel-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }
    .channel-unsub {
      background: #ef4444;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 9999px; /* Pill shape */
      font-size: 0.875rem;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .channel-unsub:hover {
      opacity: 0.8;
    }
    .verified-badge {
      color: #000000;
      font-size: 16px;
      margin-left: 4px;
      vertical-align: middle;
    }
    #video-file, #status-image-file {
      display: none;
    }
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .spinner-overlay.active {
      display: flex;
    }
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .alert {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 14px;
      z-index: 40;
      display: none;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .alert.active {
      display: block;
    }
    .notification-btn {
      position: relative;
    }
    .notification-count {
      position: absolute;
      top: -4px;
      right: -4px;
      background-color: #ef4444;
      color: #ffffff;
      font-size: 10px;
      font-weight: 600;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .status-image-grid {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 8px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .status-image-grid::-webkit-scrollbar {
      display: none;
    }
    .status-image {
      width: 200px;
      height: 200px;
      object-fit: cover;
      border-radius: 50%;
      flex-shrink: 0;
      scroll-snap-align: start;
      cursor: pointer;
    }
    .controls-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
    }
    #sort-select, .manage-subs-btn {
      flex: 1;
    }
    @media (min-width: 768px) {
      .sidebar {
        display: block;
      }
      .bottom-nav {
        display: none;
      }
      .video-grid {
        padding: 2rem;
        grid-gap: 1.5rem;
      }
    }
    @media (max-width: 767px) {
      .sidebar {
        display: none;
      }
      .video-grid {
        margin-left: 0;
        padding: 12px;
        margin-top: 96px; /* Adjusted for header */
        margin-bottom: 64px;
      }
      .header-controls {
        padding: 0 0.5rem;
      }
      .header-controls input,
      .header-controls select {
        width: 100%; /* Full width on mobile */
      }
      .manage-subs-btn {
        width: 100%;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <nav class="sidebar" id="sidebar">
    <div class="flex flex-col space-y-2 p-4">
      <button class="flex items-center space-x-2 text-white" onclick="window.location.href='play.html'">
        <span class="material-icons">home</span>
        <span>Home</span>
      </button>
      <button class="flex items-center space-x-2 text-white active" onclick="window.location.href='subscriptions.html'">
        <span class="material-icons">subscriptions</span>
        <span>Subscriptions</span>
      </button>
      <button class="flex items-center space-x-2 text-white" id="upload-btn">
        <span class="material-icons">add_circle</span>
        <span>Upload</span>
      </button>
      <button class="flex items-center space-x-2 text-white" onclick="window.location.href='reels.html'">
        <span class="material-icons">movie</span>
        <span>Reels</span>
      </button>
      <button class="flex items-center space-x-2 text-white" onclick="window.location.href='library.html'">
        <span class="material-icons">video_library</span>
        <span>Library</span>
      </button>
      <button class="flex items-center space-x-2 text-white notification-btn" onclick="window.location.href='notifications.html'">
        <span class="material-icons">notifications</span>
        <span>Notifications</span>
        <span id="notification-count-sidebar" class="notification-count hidden">0</span>
      </button>
    </div>
  </nav>

  <main class="video-grid">
    <div class="header-controls">
  <div class="controls-row">
    <select id="sort-select">
      <option value="recent">Most Recent</option>
      <option value="views">Most Viewed</option>
    </select>
    <button class="manage-subs-btn" id="manage-subs-btn">
      <span class="material-icons">manage_accounts</span>
      Manage
    </button>
  </div>
  
</div>
    <div class="status-bar" id="status-bar">
      <div class="status-item" id="my-status" onclick="openStatusUploadModal()">
        <div class="status-avatar">+</div>
        <p class="status-label">My Status</p>
      </div>
      <div id="subscribed-statuses-container"></div>
    </div>
    <h1 class="text-2xl font-bold mb-4 px-4">Subscriptions</h1>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="video-grid">
      <p class="text-center text-gray-600 col-span-full">Loading videos...</p>
    </div>
  </main>

  <nav class="bottom-nav" id="bottom-nav">
    <button class="nav-btn" onclick="window.location.href='play.html'">
      <span class="material-icons">home</span>
      <span>Home</span>
    </button>
    <button class="nav-btn active" onclick="window.location.href='subscriptions.html'">
      <span class="material-icons">subscriptions</span>
      <span>Subscriptions</span>
    </button>
    <button class="nav-btn" id="upload-btn-mobile">
      <span class="material-icons">add_circle</span>
      <span>Upload</span>
    </button>
    <button class="nav-btn" onclick="window.location.href='reels.html'">
      <span class="material-icons">movie</span>
      <span>Reels</span>
    </button>
    <button class="nav-btn" onclick="window.location.href='library.html'">
      <span class="material-icons">video_library</span>
      <span>Library</span>
    </button>
    <button class="nav-btn notification-btn" onclick="window.location.href='notifications.html'">
      <span class="material-icons">notifications</span>
      <span>Notifications</span>
      <span id="notification-count-mobile" class="notification-count hidden">0</span>
    </button>
  </nav>

  <div class="bottom-sheet" id="upload-sheet">
    <div class="bottom-sheet-header">
      <h2 class="text-lg font-medium">Upload Video</h2>
      <button id="close-sheet" class="text-black material-icons">close</button>
    </div>
    <form id="upload-form" class="flex flex-col gap-4 p-4">
      <div>
        <label for="video-file" class="block text-sm font-medium mb-2">Video File</label>
        <button type="button" id="select-video">Choose Video</button>
        <input type="file" id="video-file" accept="video/*">
        <p id="selected-file" class="text-sm text-gray-600 mt-2"></p>
      </div>
      <div>
        <label for="caption" class="block text-sm font-medium">Caption</label>
        <textarea id="caption" rows="3" class="w-full p-2 border border-[#e0e0e0] rounded-md" placeholder="Add a caption..."></textarea>
      </div>
      <button type="submit">Upload</button>
    </form>
  </div>

  <!-- Status Upload Modal -->
  <div class="bottom-sheet" id="status-upload-sheet">
    <div class="bottom-sheet-header">
      <h2 class="text-lg font-medium">Set Status</h2>
      <button id="close-status-upload" class="text-black material-icons">close</button>
    </div>
    <form id="status-upload-form" class="flex flex-col gap-4 p-4">
      <div>
        <label for="status-image-file" class="block text-sm font-medium mb-2">Status Image</label>
        <button type="button" id="select-status-image">Choose Image</button>
        <input type="file" id="status-image-file" accept="image/*">
        <p id="selected-status-file" class="text-sm text-gray-600 mt-2"></p>
      </div>
      <button type="submit">Set Status</button>
    </form>
  </div>

  <!-- View Status Modal -->
  <div class="bottom-sheet" id="view-status-sheet">
    <div class="bottom-sheet-header">
      <h2 class="text-lg font-medium" id="view-status-title">Statuses</h2>
      <button id="close-view-status" class="text-black material-icons">close</button>
    </div>
    <div id="status-images" class="status-image-grid p-4">
      <p class="text-center text-gray-600 col-span-full">Loading...</p>
    </div>
  </div>

  <!-- New: Channel Management Bottom Sheet -->
  <div class="bottom-sheet" id="manage-subs-sheet">
    <div class="bottom-sheet-header">
      <h2 class="text-lg font-medium" id="manage-header">Manage Subscriptions</h2>
      <button id="close-manage-sheet" class="text-black material-icons">close</button>
    </div>
    <div id="channel-list" class="p-4">
      <p class="text-center text-gray-600">Loading subscriptions...</p>
    </div>
  </div>

  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <div id="alert-message" class="alert"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, push, set, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const CLOUDINARY_UPLOAD_PRESET = 'banter_box';
    const CLOUDINARY_CLOUD_NAME = 'dqkujefxj';
    const CLOUDINARY_VIDEO_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`;
    const CLOUDINARY_IMAGE_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    let app, auth, db, currentUser;

    const showSpinner = () => {
      const spinnerOverlay = document.getElementById('spinner-overlay');
      if (spinnerOverlay) spinnerOverlay.classList.add('active');
    };

    const hideSpinner = () => {
      const spinnerOverlay = document.getElementById('spinner-overlay');
      if (spinnerOverlay) spinnerOverlay.classList.remove('active');
    };

    const showAlert = (message) => {
      const alert = document.getElementById('alert-message');
      if (alert) {
        alert.textContent = message;
        alert.classList.add('active');
        setTimeout(() => alert.classList.remove('active'), 3000);
      }
    };

    const formatNumber = (count) => {
      if (count >= 1000000) return `${(count / 1000000).toFixed(1)}M`;
      if (count >= 1000) return `${(count / 1000).toFixed(1)}K`;
      return count.toString();
    };

    const formatTimestamp = (timestamp) => {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHr = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHr / 24);
      if (diffSec < 60) return `${diffSec} second${diffSec === 1 ? '' : 's'} ago`;
      if (diffMin < 60) return `${diffMin} minute${diffMin === 1 ? '' : 's'} ago`;
      if (diffHr < 24) return `${diffHr} hour${diffHr === 1 ? '' : 's'} ago`;
      return `${diffDay} day${diffDay === 1 ? '' : 's'} ago`;
    };

    function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getDatabase(app);
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            loadStatusBar();
            loadSubscribedVideos();
            setupNotifications();
          } else {
            showAlert('Please log in to view subscriptions.');
            window.location.href = 'signup.html';
          }
        }, (error) => {
          console.error('Auth state error:', error.message, error.stack);
          showAlert('Authentication error. Please try again.');
        });
      } catch (error) {
        console.error('Firebase initialization error:', error.message, error.stack);
        showAlert('Failed to initialize Firebase. Please check your connection.');
      }
    }

    async function saveToLibrary(videoId) {
      if (!currentUser) {
        showAlert('Please log in to save videos.');
        return;
      }
      try {
        const libraryRef = ref(db, `users/${currentUser.uid}/library/${videoId}`);
        await set(libraryRef, true);
        showAlert('Video saved to library!');
      } catch (error) {
        console.error('Error saving video to library:', error.message, error.stack);
        showAlert('Failed to save video. Please try again.');
      }
    }

    async function setupNotifications() {
      if (!currentUser) return;
      const notificationsRef = ref(db, `users/${currentUser.uid}/notifications`);
      onValue(notificationsRef, (snapshot) => {
        const notifications = snapshot.val() || {};
        const unreadCount = Object.values(notifications).filter(n => !n.read).length;
        const countElSidebar = document.getElementById('notification-count-sidebar');
        const countElMobile = document.getElementById('notification-count-mobile');
        if (countElSidebar) {
          countElSidebar.textContent = unreadCount;
          countElSidebar.classList.toggle('hidden', unreadCount === 0);
        }
        if (countElMobile) {
          countElMobile.textContent = unreadCount;
          countElMobile.classList.toggle('hidden', unreadCount === 0);
        }
      }, (error) => {
        console.error('Error setting up notifications:', error.message, error.stack);
      });
    }

    // Load Status Bar
    async function loadStatusBar() {
      if (!currentUser) return;
      const container = document.getElementById('subscribed-statuses-container');
      if (!container) return;
      const subsRef = ref(db, `users/${currentUser.uid}/subscriptions`);
      onValue(subsRef, async (subsSnapshot) => {
        container.innerHTML = '';
        if (!subsSnapshot.exists()) return;
        const subscribedUserIds = Object.keys(subsSnapshot.val());
        for (const userId of subscribedUserIds) {
          const userRef = ref(db, `users/${userId}`);
          await new Promise((resolve) => {
            onValue(userRef, async (userSnapshot) => {
              const userData = userSnapshot.val();
              if (!userData) {
                resolve();
                return;
              }
              let statusImage = null;
              // Fetch recent status
              const statusesRef = ref(db, `users/${userId}/statuses`);
              await new Promise((statusResolve) => {
                onValue(statusesRef, (statusSnapshot) => {
                  const statuses = statusSnapshot.val() || {};
                  const now = new Date().getTime();
                  const recentStatuses = Object.entries(statuses)
                    .filter(([id, status]) => now - new Date(status.timestamp).getTime() < 24 * 60 * 60 * 1000)
                    .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
                  if (recentStatuses.length > 0) {
                    statusImage = recentStatuses[0][1].imageURL;
                  }
                  statusResolve();
                }, { onlyOnce: true });
              });
              const item = document.createElement('div');
              item.className = 'status-item';
              item.onclick = () => openStatusView(userId, userData.displayName || 'Unknown User');
              let avatarHtml;
              if (statusImage) {
                avatarHtml = `<img src="${statusImage}" alt="Status" class="w-full h-full rounded-full object-cover">`;
              } else if (userData.photoURL) {
                avatarHtml = `<img src="${userData.photoURL}" alt="${userData.displayName}" class="w-full h-full rounded-full object-cover">`;
              } else {
                avatarHtml = `<div class="w-full h-full flex items-center justify-center bg-[var(--gradient)] text-white text-sm font-bold">${userData.displayName ? userData.displayName[0].toUpperCase() : 'U'}</div>`;
              }
              item.innerHTML = `
                <div class="status-avatar relative">${avatarHtml}</div>
                <p class="status-label">${userData.displayName || 'Unknown User'}</p>
              `;
              container.appendChild(item);
              resolve();
            }, { onlyOnce: true });
          });
        }
      }, (error) => {
        console.error('Error loading status bar:', error);
      });
    }

    // Open Status View
    window.openStatusView = async (userId, displayName) => {
      const sheet = document.getElementById('view-status-sheet');
      const title = document.getElementById('view-status-title');
      const imagesContainer = document.getElementById('status-images');
      if (!sheet || !title || !imagesContainer) return;
      title.textContent = `${displayName}'s Statuses`;
      imagesContainer.innerHTML = '<p class="text-center text-gray-600">Loading...</p>';
      sheet.classList.add('active');
      try {
        const statusesRef = ref(db, `users/${userId}/statuses`);
        onValue(statusesRef, (snapshot) => {
          const statuses = snapshot.val() || {};
          const now = Date.now();
          const recentStatuses = Object.entries(statuses)
            .filter(([id, status]) => now - new Date(status.timestamp).getTime() < 24 * 60 * 60 * 1000)
            .map(([id, status]) => ({ id, ...status }));
          imagesContainer.innerHTML = '';
          if (recentStatuses.length === 0) {
            imagesContainer.innerHTML = '<p class="text-center text-gray-600">No recent statuses</p>';
            return;
          }
          recentStatuses.forEach(status => {
            const img = document.createElement('img');
            img.src = status.imageURL;
            img.className = 'status-image';
            img.alt = 'Status';
            img.onclick = () => {
              // Optional: Full screen view or something, but for now, just view in modal
            };
            imagesContainer.appendChild(img);
          });
        }, { onlyOnce: true });
      } catch (error) {
        console.error('Error loading statuses:', error);
        imagesContainer.innerHTML = '<p class="text-center text-red-500">Failed to load statuses</p>';
      }
    };

    // Open Status Upload Modal
    window.openStatusUploadModal = () => {
      const sheet = document.getElementById('status-upload-sheet');
      if (sheet) sheet.classList.add('active');
    };

    // Updated: Support for sorting and searching
    let currentSort = 'recent'; // Default sort
    let currentSearchQuery = ''; // Default search

    async function loadSubscribedVideos(sort = 'recent', searchQuery = '') {
      currentSort = sort;
      currentSearchQuery = searchQuery;
      showSpinner();
      const videoGrid = document.getElementById('video-grid');
      if (!videoGrid) {
        console.error('Video grid element not found');
        hideSpinner();
        return;
      }
      try {
        const subsRef = ref(db, `users/${currentUser.uid}/subscriptions`);
        onValue(subsRef, async (subsSnapshot) => {
          if (!subsSnapshot.exists()) {
            videoGrid.innerHTML = '<p class="text-center text-gray-600 col-span-full">You have no subscriptions.</p>';
            hideSpinner();
            return;
          }
          const subscribedUserIds = Object.keys(subsSnapshot.val());
          const videosRef = ref(db, 'shorts');
          onValue(videosRef, async (videosSnapshot) => {
            if (!videosSnapshot.exists()) {
              videoGrid.innerHTML = '<p class="text-center text-gray-600 col-span-full">No videos from subscribed channels.</p>';
              hideSpinner();
              return;
            }
            let videoArray = Object.entries(videosSnapshot.val())
              .map(([videoId, videoData]) => ({ videoId, ...videoData }))
              .filter(video => video.mediaType === 'video' && subscribedUserIds.includes(video.userId));

            // Apply search filter
            if (searchQuery) {
              videoArray = videoArray.filter(video => {
                // Simple caption filter; extend to user/channel if needed
                return video.caption?.toLowerCase().includes(searchQuery.toLowerCase());
              });
            }

            // Apply sorting
            if (sort === 'views') {
              videoArray.sort((a, b) => Object.keys(b.views || {}).length - Object.keys(a.views || {}).length);
            } else { // 'recent' default
              videoArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            videoGrid.innerHTML = '';
            if (videoArray.length === 0) {
              videoGrid.innerHTML = '<p class="text-center text-gray-600 col-span-full">No videos match your search.</p>';
              hideSpinner();
              return;
            }
            for (const video of videoArray) {
              const userRef = ref(db, `users/${video.userId}`);
              await new Promise((resolve) => {
                onValue(userRef, (userSnapshot) => {
                  const userData = userSnapshot.val();
                  const subscriberCount = Object.keys(userData?.subscribers || {}).length;
                  const isVerified = subscriberCount >= 500; // Dynamic verified check
                  const card = document.createElement('div');
                  card.className = 'video-card cursor-pointer';
                  card.addEventListener('click', () => {
                    window.location.href = `videoplay.html?videoId=${video.videoId}`;
                  });
                  card.innerHTML = `
                    <video class="thumbnail" muted loop playsinline src="${video.mediaURL}?w=320&h=180"></video>
                    <div class="flex mt-2">
                      ${userData?.photoURL
                        ? `<img src="${userData.photoURL}" alt="${userData.displayName || 'User'}" class="h-9 w-9 rounded-full mr-3">`
                        : `<div class="h-9 w-9 rounded-full mr-3 avatar">${userData?.displayName ? userData.displayName[0].toUpperCase() : 'U'}</div>`}
                      <div class="flex-1">
                        <h3 class="text-black text-sm font-medium line-clamp-2">${video.caption || 'Untitled Video'}</h3>
                        <p class="text-gray-600 text-xs mt-1">${userData?.displayName || 'Unknown Channel'} ${isVerified ? '<span class="verified-badge material-icons" aria-label="Verified account">verified</span>' : ''}</p>
                        <p class="text-gray-600 text-xs">${formatNumber(Object.keys(video.views || {}).length)} views • ${formatTimestamp(video.timestamp)}</p>
                      </div>
                      <button class="save-btn text-gray-600 hover:text-[var(--accent)] material-icons text-sm" data-video-id="${video.videoId}" title="Save to Library">bookmark_add</button>
                    </div>
                  `;
                  videoGrid.appendChild(card);
                  resolve();
                }, { onlyOnce: true });
              });
            }
            setupIntersectionObserver();
            hideSpinner();
          }, (error) => {
            console.error('Error loading videos:', error.message, error.stack);
            showAlert('Failed to load videos. Please try again.');
            hideSpinner();
          });
        }, (error) => {
          console.error('Error loading subscriptions:', error.message, error.stack);
          showAlert('Failed to load subscriptions. Please try again.');
          hideSpinner();
        });
      } catch (error) {
        console.error('Error fetching subscribed videos:', error.message, error.stack);
        showAlert('Failed to load subscribed videos. Please check your connection.');
        hideSpinner();
      }
    }

    // New: Load and display subscribed channels in management sheet
    async function loadManageSubscriptions() {
      const channelList = document.getElementById('channel-list');
      const manageHeader = document.getElementById('manage-header');
      if (!channelList || !currentUser || !manageHeader) return;
      showSpinner();
      try {
        // Fetch current user's subscriber count
        const mySubRef = ref(db, `users/${currentUser.uid}/subscribers`);
        onValue(mySubRef, (mySnapshot) => {
          const mySubCount = Object.keys(mySnapshot.val() || {}).length + 1; // Including self
          manageHeader.textContent = `Manage Subscriptions • ${formatNumber(mySubCount)} Subscribers`;
        }, { onlyOnce: true });

        const subsRef = ref(db, `users/${currentUser.uid}/subscriptions`);
        onValue(subsRef, async (subsSnapshot) => {
          if (!subsSnapshot.exists()) {
            channelList.innerHTML = '<p class="text-center text-gray-600">No subscriptions yet.</p>';
            hideSpinner();
            return;
          }
          const subscribedUserIds = Object.keys(subsSnapshot.val());
          channelList.innerHTML = '';
          for (const userId of subscribedUserIds) {
            const userRef = ref(db, `users/${userId}`);
            await new Promise((resolve) => {
              onValue(userRef, (userSnapshot) => {
                const userData = userSnapshot.val();
                const subscriberCount = Object.keys(userData?.subscribers || {}).length;
                const isVerified = subscriberCount >= 500;
                const channelItem = document.createElement('div');
                channelItem.className = 'channel-item';
                channelItem.innerHTML = `
                  <div class="channel-info">
                    ${userData?.photoURL
                      ? `<img src="${userData.photoURL}" alt="${userData.displayName || 'Channel'}" class="h-10 w-10 rounded-full">`
                      : `<div class="h-10 w-10 rounded-full avatar">${userData?.displayName ? userData.displayName[0].toUpperCase() : 'C'}</div>`}
                    <div>
                      <p class="font-medium">${userData?.displayName || 'Unknown Channel'} ${isVerified ? '<span class="verified-badge material-icons" aria-label="Verified">verified</span>' : ''}</p>
                      <p class="text-sm text-[var(--text-secondary)]">${formatNumber(subscriberCount)} subscribers</p>
                    </div>
                  </div>
                  <button class="channel-unsub" onclick="unsubscribeFromChannel('${userId}')">Unsubscribe</button>
                `;
                channelList.appendChild(channelItem);
                resolve();
              }, { onlyOnce: true });
            });
          }
          hideSpinner();
        });
      } catch (error) {
        console.error('Error loading manage subscriptions:', error);
        channelList.innerHTML = '<p class="text-center text-red-500">Failed to load subscriptions.</p>';
        hideSpinner();
      }
    }

    // New: Unsubscribe function
    window.unsubscribeFromChannel = async (channelId) => {
      if (!currentUser) return;
      try {
        const unsubRef = ref(db, `users/${currentUser.uid}/subscriptions/${channelId}`);
        await remove(unsubRef);
        // Also remove from channel's subscribers if needed (optional)
        const channelSubRef = ref(db, `users/${channelId}/subscribers/${currentUser.uid}`);
        await remove(channelSubRef);
        showAlert('Unsubscribed successfully!');
        // Refresh the list
        loadManageSubscriptions();
      } catch (error) {
        console.error('Error unsubscribing:', error);
        showAlert('Failed to unsubscribe. Please try again.');
      }
    };

    function setupIntersectionObserver() {
      const videos = document.querySelectorAll('.video-card video');
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const video = entry.target;
            if (entry.isIntersecting) {
              video.play().catch((error) => {
                console.error('Error playing video:', error.message, error.stack);
              });
            } else {
              video.pause();
            }
          });
        },
        { threshold: 0.5 }
      );
      videos.forEach((video) => observer.observe(video));
    }

    async function handleVideoUpload(e) {
      e.preventDefault();
      if (!currentUser) {
        showAlert('Please log in to upload videos.');
        return;
      }
      const videoFileInput = document.getElementById('video-file');
      const captionInput = document.getElementById('caption');
      if (!videoFileInput || !captionInput) {
        console.error('Upload form elements not found');
        showAlert('Upload form error. Please try again.');
        return;
      }
      const videoFile = videoFileInput.files[0];
      const caption = captionInput.value.trim();
      if (!videoFile) {
        showAlert('Please select a video file.');
        return;
      }
      showSpinner();
      try {
        const formData = new FormData();
        formData.append('file', videoFile);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', `videos/${currentUser.uid}`);
        formData.append('resource_type', 'video');

        const response = await fetch(CLOUDINARY_VIDEO_URL, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error?.message || 'Cloudinary upload failed');
        }
        const mediaURL = data.secure_url;

        const videosRef = ref(db, 'shorts');
        const newVideoRef = push(videosRef);
        await set(newVideoRef, {
          mediaURL,
          mediaType: 'video',
          caption: caption || 'Untitled Video',
          userId: currentUser.uid,
          timestamp: new Date().toISOString(),
          views: {}
        });

        const subscribersRef = ref(db, `users/${currentUser.uid}/subscribers`);
        onValue(subscribersRef, async (snapshot) => {
          if (snapshot.exists()) {
            const subscribers = Object.keys(snapshot.val());
            for (const subscriberId of subscribers) {
              const notificationRef = ref(db, `users/${subscriberId}/notifications/${newVideoRef.key}`);
              await set(notificationRef, {
                type: 'new_video',
                videoId: newVideoRef.key,
                message: `${currentUser.displayName || 'A user'} uploaded a new video: ${caption || 'Untitled Video'}`,
                timestamp: new Date().toISOString(),
                read: false
              });
            }
          }
        }, { onlyOnce: true });

        const uploadSheet = document.getElementById('upload-sheet');
        const uploadForm = document.getElementById('upload-form');
        const selectedFile = document.getElementById('selected-file');
        if (uploadSheet && uploadForm && selectedFile) {
          uploadSheet.classList.remove('active');
          uploadForm.reset();
          selectedFile.textContent = '';
        }
        showAlert('Video uploaded successfully!');
      } catch (error) {
        console.error('Error uploading video:', error.message, error.stack);
        showAlert('Failed to upload video. Please try again.');
      } finally {
        hideSpinner();
      }
    }

    // Handle Status Upload
    async function handleStatusUpload(e) {
      e.preventDefault();
      if (!currentUser) {
        showAlert('Please log in to set status.');
        return;
      }
      const imageFileInput = document.getElementById('status-image-file');
      if (!imageFileInput) {
        console.error('Status upload form elements not found');
        showAlert('Status upload form error. Please try again.');
        return;
      }
      const imageFile = imageFileInput.files[0];
      if (!imageFile) {
        showAlert('Please select an image file.');
        return;
      }
      showSpinner();
      try {
        const formData = new FormData();
        formData.append('file', imageFile);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', `statuses/${currentUser.uid}`);
        formData.append('resource_type', 'image');

        const response = await fetch(CLOUDINARY_IMAGE_URL, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error?.message || 'Cloudinary upload failed');
        }
        const imageURL = data.secure_url;

        const statusesRef = ref(db, `users/${currentUser.uid}/statuses`);
        const newStatusRef = push(statusesRef);
        await set(newStatusRef, {
          imageURL,
          timestamp: new Date().toISOString()
        });

        const statusUploadSheet = document.getElementById('status-upload-sheet');
        const statusUploadForm = document.getElementById('status-upload-form');
        const selectedStatusFile = document.getElementById('selected-status-file');
        if (statusUploadSheet && statusUploadForm && selectedStatusFile) {
          statusUploadSheet.classList.remove('active');
          statusUploadForm.reset();
          selectedStatusFile.textContent = '';
        }
        showAlert('Status set successfully!');
        loadStatusBar(); // Refresh to update my status if needed
      } catch (error) {
        console.error('Error uploading status:', error.message, error.stack);
        showAlert('Failed to set status. Please try again.');
      } finally {
        hideSpinner();
      }
    }

    function setupEventListeners() {
      const uploadBtn = document.getElementById('upload-btn');
      const uploadBtnMobile = document.getElementById('upload-btn-mobile');
      const closeSheet = document.getElementById('close-sheet');
      const selectVideo = document.getElementById('select-video');
      const videoFile = document.getElementById('video-file');
      const uploadForm = document.getElementById('upload-form');
      const subSearchInput = document.getElementById('sub-search-input');
      const sortSelect = document.getElementById('sort-select');
      const manageSubsBtn = document.getElementById('manage-subs-btn');
      const closeManageSheet = document.getElementById('close-manage-sheet');

      // Status Upload Listeners
      const closeStatusUpload = document.getElementById('close-status-upload');
      const selectStatusImage = document.getElementById('select-status-image');
      const statusImageFile = document.getElementById('status-image-file');
      const statusUploadForm = document.getElementById('status-upload-form');
      const selectedStatusFile = document.getElementById('selected-status-file');

      // View Status Listeners
      const closeViewStatus = document.getElementById('close-view-status');

      if (uploadBtn) {
        uploadBtn.addEventListener('click', () => {
          const uploadSheet = document.getElementById('upload-sheet');
          if (uploadSheet) uploadSheet.classList.toggle('active');
        });
      }

      if (uploadBtnMobile) {
        uploadBtnMobile.addEventListener('click', () => {
          const uploadSheet = document.getElementById('upload-sheet');
          if (uploadSheet) uploadSheet.classList.toggle('active');
        });
      }

      if (closeSheet) {
        closeSheet.addEventListener('click', () => {
          const uploadSheet = document.getElementById('upload-sheet');
          const uploadForm = document.getElementById('upload-form');
          const selectedFile = document.getElementById('selected-file');
          if (uploadSheet && uploadForm && selectedFile) {
            uploadSheet.classList.remove('active');
            uploadForm.reset();
            selectedFile.textContent = '';
          }
        });
      }

      if (selectVideo && videoFile) {
        selectVideo.addEventListener('click', () => {
          videoFile.click();
        });
      }

      if (videoFile) {
        videoFile.addEventListener('change', () => {
          const file = videoFile.files[0];
          const selectedFile = document.getElementById('selected-file');
          if (selectedFile) selectedFile.textContent = file ? file.name : '';
        });
      }

      if (uploadForm) {
        uploadForm.addEventListener('submit', handleVideoUpload);
      }

      // Status Upload Events
      if (selectStatusImage && statusImageFile) {
        selectStatusImage.addEventListener('click', () => {
          statusImageFile.click();
        });
      }

      if (statusImageFile) {
        statusImageFile.addEventListener('change', () => {
          const file = statusImageFile.files[0];
          if (selectedStatusFile) selectedStatusFile.textContent = file ? file.name : '';
        });
      }

      if (statusUploadForm) {
        statusUploadForm.addEventListener('submit', handleStatusUpload);
      }

      if (closeStatusUpload) {
        closeStatusUpload.addEventListener('click', () => {
          const sheet = document.getElementById('status-upload-sheet');
          const form = document.getElementById('status-upload-form');
          const fileEl = document.getElementById('selected-status-file');
          if (sheet && form && fileEl) {
            sheet.classList.remove('active');
            form.reset();
            fileEl.textContent = '';
          }
        });
      }

      if (closeViewStatus) {
        closeViewStatus.addEventListener('click', () => {
          const sheet = document.getElementById('view-status-sheet');
          if (sheet) sheet.classList.remove('active');
        });
      }

      // New: Event listeners for search and sort
      if (subSearchInput) {
        subSearchInput.addEventListener('input', (e) => {
          loadSubscribedVideos(currentSort, e.target.value.trim());
        });
      }

      if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
          loadSubscribedVideos(e.target.value, currentSearchQuery);
        });
      }

      // New: Manage Subscriptions Sheet
      if (manageSubsBtn) {
        manageSubsBtn.addEventListener('click', () => {
          const manageSheet = document.getElementById('manage-subs-sheet');
          if (manageSheet) {
            manageSheet.classList.toggle('active');
            if (manageSheet.classList.contains('active')) {
              loadManageSubscriptions();
            }
          }
        });
      }

      if (closeManageSheet) {
        closeManageSheet.addEventListener('click', () => {
          const manageSheet = document.getElementById('manage-subs-sheet');
          if (manageSheet) manageSheet.classList.remove('active');
        });
      }

      // Close sheet on outside click
      document.addEventListener('click', (e) => {
        const uploadSheet = document.getElementById('upload-sheet');
        const statusUploadSheet = document.getElementById('status-upload-sheet');
        const viewStatusSheet = document.getElementById('view-status-sheet');
        const manageSheet = document.getElementById('manage-subs-sheet');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadBtnMobile = document.getElementById('upload-btn-mobile');
        const manageSubsBtn = document.getElementById('manage-subs-btn');
        const myStatus = document.getElementById('my-status');
        if (uploadSheet && uploadBtn && uploadBtnMobile &&
            uploadSheet.classList.contains('active') &&
            !uploadSheet.contains(e.target) &&
            !uploadBtn.contains(e.target) &&
            !uploadBtnMobile.contains(e.target)) {
          uploadSheet.classList.remove('active');
          const uploadForm = document.getElementById('upload-form');
          const selectedFile = document.getElementById('selected-file');
          if (uploadForm && selectedFile) {
            uploadForm.reset();
            selectedFile.textContent = '';
          }
        }
        if (statusUploadSheet && myStatus &&
            statusUploadSheet.classList.contains('active') &&
            !statusUploadSheet.contains(e.target) &&
            !myStatus.contains(e.target)) {
          statusUploadSheet.classList.remove('active');
          const statusForm = document.getElementById('status-upload-form');
          const statusFile = document.getElementById('selected-status-file');
          if (statusForm && statusFile) {
            statusForm.reset();
            statusFile.textContent = '';
          }
        }
        if (viewStatusSheet &&
            viewStatusSheet.classList.contains('active') &&
            !viewStatusSheet.contains(e.target)) {
          viewStatusSheet.classList.remove('active');
        }
        if (manageSheet && manageSubsBtn &&
            manageSheet.classList.contains('active') &&
            !manageSheet.contains(e.target) &&
            !manageSubsBtn.contains(e.target)) {
          manageSheet.classList.remove('active');
        }
        if (e.target.classList.contains('save-btn')) {
          const videoId = e.target.getAttribute('data-video-id');
          if (videoId) saveToLibrary(videoId);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      try {
        initializeFirebase();
        setupEventListeners();
      } catch (error) {
        console.error('DOMContentLoaded error:', error.message, error.stack);
        showAlert('Failed to initialize application. Please refresh the page.');
      }
    });
  </script>
</body>
</html>
