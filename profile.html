<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Profile • Vynix</title>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Symbols+Rounded" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff;
      --text:#161823; --text2:#86878b;
      --border:#e3e3e4; --accent:#ff2a6d;
      --btn-bg:#f1f1f2;
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000;
      --text:#ffffff; --text2:#71767b;
      --border:#2f3336; --btn-bg:#2f2f2f;
    }
    *{ -webkit-user-select:none !important; user-select:none !important;
       -webkit-touch-callout:none !important; -webkit-tap-highlight-color:transparent !important; }
    input,textarea,button{ -webkit-user-select:auto !important; user-select:text !important; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg); color:var(--text); padding-bottom:85px; margin:0;}
    .btn-secondary{background:var(--btn-bg); color:var(--text); font-weight:600; transition:0.2s;}
    .btn-secondary:active{transform:scale(0.98); opacity:0.8;}
    ::-webkit-scrollbar{display:none;}
    .toast{position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px);
           background:rgba(0,0,0,0.8); color:#fff; padding:12px 24px; border-radius:999px;
           font-size:14px; opacity:0; transition:all .4s ease; z-index:99;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
    .spinner{border:3px solid rgba(255,255,255,.3); border-top:3px solid var(--accent); border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* ---- pill follow button ---- */
    #followBtn{
      background:var(--accent); color:#fff; border:none;
      padding:10px 24px; border-radius:999px; font-weight:700; font-size:14px;
      transition:background .2s, color .2s, border .2s;
    }
    #followBtn.following{
      background:transparent; color:var(--text); border:1px solid var(--border);
    }
    #followBtn.following:hover{
      background:rgba(244,33,46,.08); color:#f4212e; border-color:#f4212e;
    }
    #followBtn.following:hover span{display:none;}
    #followBtn.following:hover::after{content:'Unfollow';}

    #global-shimmer{
      position:fixed; inset:0; z-index:100;
      background:var(--bg);
      display:flex; align-items:center; justify-content:center;
      opacity:1; pointer-events:auto; transition:opacity .3s;
    }
    #global-shimmer.hidden{opacity:0; pointer-events:none;}
    .shimmer-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:0.5px; width:100%; max-width:400px;}
    .shimmer-cell{
      aspect-ratio:3/4;
      background:linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.3) 50%, var(--border) 75%);
      background-size:200% 100%; animation:shimmer 1.2s infinite;
    }
    [data-theme="dark"] .shimmer-cell{
      background:linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.05) 50%, var(--border) 75%);
    }
    @keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
  </style>
</head>
<body>

  <!-- GLOBAL SHIMMER -->
  <div id="global-shimmer">
    <div class="shimmer-grid">
      <div class="shimmer-cell"></div><div class="shimmer-cell"></div><div class="shimmer-cell"></div>
      <div class="shimmer-cell"></div><div class="shimmer-cell"></div><div class="shimmer-cell"></div>
      <div class="shimmer-cell"></div><div class="shimmer-cell"></div><div class="shimmer-cell"></div>
    </div>
  </div>

  <!-- Header -->
  <div class="sticky top-0 z-30 bg-[var(--bg)] border-b border-[var(--border)] h-12 flex items-center justify-between px-4">
    <div class="w-8"></div>
    <div class="font-bold text-lg flex items-center gap-1">
      <span id="navDisplayName">Loading...</span>
    </div>
    <button id="menuBtn" class="w-8 flex justify-end"><span class="material-icons">menu</span></button>
  </div>

  <!-- Menu Drawer -->
  <div id="menuDrawer" class="fixed inset-0 z-50 hidden">
    <div id="menuBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--card)] rounded-t-2xl p-4 flex flex-col gap-2 pb-8">
      <h3 class="text-center font-bold mb-2 text-[var(--text2)]">Settings</h3>
      <button id="logoutBtn" class="w-full py-3.5 rounded-lg bg-[var(--btn-bg)] font-semibold text-red-500">Log out</button>
      <button id="closeMenu" class="w-full py-3.5 rounded-lg bg-[var(--btn-bg)] font-semibold">Cancel</button>
    </div>
  </div>

  <!-- Profile Info -->
  <div class="pt-6 pb-2 px-4 text-center">
    <div class="relative mx-auto w-24 h-24 mb-3">
      <img id="profileAvatar" class="w-24 h-24 rounded-full object-cover border-2 border-[var(--border)]" src="" alt="avatar">
      <label for="avatarInput" id="avatarChangeBtn" class="absolute bottom-0 right-0 bg-[var(--accent)] text-white w-8 h-8 flex items-center justify-center rounded-full border-4 border-[var(--bg)] cursor-pointer shadow-lg text-lg">
        <span class="material-icons text-sm">add_a_photo</span>
      </label>
      <input type="file" id="avatarInput" accept="image/*" class="hidden">
    </div>

    <h2 id="displayName" class="text-xl font-bold leading-tight">@username</h2>
    <p id="bio" class="text-sm px-4 mb-4 whitespace-pre-wrap text-center leading-relaxed text-[var(--text2)] mt-2">No bio yet.</p>

    <div class="flex justify-center items-center gap-8 mt-5 mb-5">
      <div class="flex flex-col items-center"><span id="followingCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Following</span></div>
      <div class="flex flex-col items-center"><span id="followersCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Followers</span></div>
      <div class="flex flex-col items-center"><span id="likesCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Likes</span></div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 justify-center px-4 mb-6">
      <button id="editBtn" class="flex-1 btn-secondary py-2.5 rounded text-sm font-bold">Edit profile</button>
      <button id="followBtn" class="hidden"><span>Follow</span></button>
      <button id="shareBtn" class="w-12 btn-secondary flex items-center justify-center rounded"><span class="material-icons-outlined">share</span></button>
    </div>

    <div class="flex items-center justify-center gap-4 text-xs text-[var(--text2)] mb-4">
      <span class="flex items-center gap-1 hidden" id="locationWrapper">
        <span class="material-icons text-sm">location_on</span> <span id="location">Earth</span>
      </span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="sticky top-12 z-20 bg-[var(--bg)] border-t border-b border-[var(--border)] h-10 flex items-center justify-center">
    <span class="text-xs font-bold uppercase tracking-widest text-[var(--accent)] flex items-center gap-2">
      <span class="material-icons text-base">grid_on</span> Media
    </span>
  </div>

  <!-- Media Grid -->
  <div id="postsGrid" class="grid grid-cols-3 gap-0.5 min-h-[300px] bg-[var(--bg)]"></div>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-[var(--border)] z-40">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 z-50 bg-[var(--bg)] flex flex-col">
    <div class="flex items-center justify-between px-4 py-3 border-b border-[var(--border)]">
      <button id="closeEdit" class="text-sm font-medium">Cancel</button>
      <h3 class="font-bold text-base">Edit profile</h3>
      <button id="saveBtn" class="text-sm font-bold text-[var(--accent)]">Save</button>
    </div>
    <div class="p-6 flex flex-col items-center gap-6 overflow-y-auto">
      <div class="flex flex-col items-center gap-2">
        <img id="editPreviewAvatar" class="w-24 h-24 rounded-full object-cover opacity-60" src="">
        <span class="text-sm font-medium">Change photo</span>
      </div>
      <div class="w-full space-y-4">
        <div><label class="text-xs font-bold text-[var(--text2)] ml-1">Name</label>
          <input id="nameInput" class="w-full bg-transparent border-b border-[var(--border)] py-2 px-1 outline-none font-medium" placeholder="Name">
        </div>
        <div><label class="text-xs font-bold text-[var(--text2)] ml-1">Bio</label>
          <textarea id="bioInput" class="w-full bg-transparent border-b border-[var(--border)] py-2 px-1 outline-none h-20 resize-none font-medium" placeholder="About you"></textarea>
        </div>
        <div><label class="text-xs font-bold text-[var(--text2)] ml-1">Location</label>
          <input id="locationInput" class="w-full bg-transparent border-b border-[var(--border)] py-2 px-1 outline-none font-medium" placeholder="City, Country">
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="overlay" class="overlay hidden"><div class="spinner"></div></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, update, remove, query, orderByChild, equalTo, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const $ = s => document.querySelector(s);

    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
      document.body.setAttribute('data-theme', 'dark');

    const urlParams = new URLSearchParams(location.search);
    const viewedUid = urlParams.get('uid');
    let currentUid = null;
    let targetUid = null;
    let isOwner = false;

    const grid = $('#postsGrid');
    const followBtn = $('#followBtn');
    const CLOUD_NAME = "dqkujefxj";
    const UPLOAD_PRESET = "banter_box";

    function showGlobalShimmer(show = true) {
      $('#global-shimmer').classList.toggle('hidden', !show);
    }

    function toast(msg) {
      $('#toast').textContent = msg;
      $('#toast').classList.add('show');
      setTimeout(() => $('#toast').classList.remove('show'), 2500);
    }

    function updateUserProfile(updates) {
      return update(ref(db, `users/${currentUid}/profile`), updates);
    }

   async function toggleFollow() {
  if (isOwner || !targetUid) return;

  const followingRef = ref(db, `following/${currentUid}/${targetUid}`);
  const followersRef = ref(db, `followers/${targetUid}/${currentUid}`);

  try {
    const snap = await get(followingRef);
    if (snap.exists()) {
      /* ----- UNFOLLOW ----- */
      await set(followingRef, null);   // idempotent delete
      await set(followersRef, null);
      toast('Unfollowed');
    } else {
      /* ----- FOLLOW ----- */
      await set(followingRef, true);
      await set(followersRef, true);
      toast('Following');
    }
  } catch (err) {
    console.error('Follow toggle error:', err);
    toast('Error updating follow status');
  }
}

    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }
      currentUid = user.uid;
      targetUid = viewedUid || currentUid;
      isOwner = currentUid === targetUid;

      $('#editBtn').style.display = isOwner ? 'block' : 'none';
      $('#shareBtn').style.display = isOwner ? 'flex' : 'none';
      $('#avatarChangeBtn').style.display = isOwner ? 'flex' : 'none';
      followBtn.classList.toggle('hidden', isOwner);

      loadProfile(targetUid);
      loadCounts(targetUid);
      loadMedia(targetUid);
      setupFollowButton();
    });

    function setupFollowButton() {
      if (isOwner) return;

      const followingRef = ref(db, `social/${currentUid}/following/${targetUid}`);
      onValue(followingRef, snap => {
        if (snap.exists()) {
          followBtn.className = 'following';
          followBtn.innerHTML = '<span>Following</span>';
        } else {
          followBtn.className = 'follow';
          followBtn.innerHTML = '<span>Follow</span>';
        }
      });
      followBtn.onclick = toggleFollow;
    }

    function emptyState() {
      grid.innerHTML = `<div class="col-span-3 text-center text-sm text-[var(--text2)] py-12">No posts with media yet</div>`;
    }

    function addCell(url, isVideo) {
      const div = document.createElement('div');
      div.className = 'relative aspect-[3/4] bg-black overflow-hidden';
      if (isVideo) {
        div.innerHTML = `
          <video class="w-full h-full object-cover" src="${url}" muted loop playsinline preload="metadata"></video>
          <div class="video-play-overlay absolute inset-0 flex items-center justify-center pointer-events-none">
            <span class="material-icons text-white text-5xl drop-shadow-2xl">play_circle</span>
          </div>
        `;
        const video = div.querySelector('video');
        const overlay = div.querySelector('.video-play-overlay');
        video.onplay = () => overlay.style.opacity = '0';
        video.onpause = () => overlay.style.opacity = '1';
        div.onclick = (e) => { e.stopPropagation(); video.paused ? video.play() : video.pause(); openVideoModal(url); };
      } else {
        div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" loading="lazy">`;
        div.onclick = () => openImageModal(url);
      }
      grid.appendChild(div);
    }

    async function loadProfile(uid) {
      showGlobalShimmer(true);
      const fallbackName = 'User';
      const fallbackAvatar = `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${fallbackName}`;

      $('#profileAvatar').src = fallbackAvatar;
      $('#editPreviewAvatar').src = fallbackAvatar;
      $('#displayName').textContent = '@user';
      $('#navDisplayName').textContent = 'User';
      $('#bio').textContent = 'No bio yet.';
      $('#locationWrapper').classList.add('hidden');

      const profileRef = ref(db, `users/${uid}/profile`);
      onValue(profileRef, async (snap) => {
        const p = snap.val() || {};

        const name = p.displayName || fallbackName;
        const avatar = p.avatar || fallbackAvatar;
        const bio = p.bio || 'No bio yet.';
        const location = p.location || '';

        $('#displayName').textContent = '@' + name.replace(/\s/g, '').toLowerCase();
        $('#navDisplayName').textContent = name;
        $('#profileAvatar').src = avatar;
        $('#editPreviewAvatar').src = avatar;
        $('#bio').textContent = bio === '' ? 'No bio yet.' : bio;
        $('#location').textContent = location;
        $('#locationWrapper').classList.toggle('hidden', !location);

        showGlobalShimmer(false);
      });
    }

    function loadCounts(uid) {
      onValue(ref(db, `social/${uid}/following`), s => $('#followingCount').textContent = s.size || 0);
      onValue(ref(db, `social/${uid}/followers`), s => $('#followersCount').textContent = s.size || 0);
      const likesQuery = query(ref(db, 'likes'), orderByChild('authorId'), equalTo(uid));
      onValue(likesQuery, s => $('#likesCount').textContent = s.size || 0);
    }

    async function loadMedia(uid) {
      showGlobalShimmer(true);
      const q = query(ref(db, 'posts'), orderByChild('authorId'), equalTo(uid));
      onValue(q, snap => {
        grid.innerHTML = '';
        const items = [];
        snap.forEach(child => {
          const p = child.val();
          if (p.image) {
            const isVideo = p.image.includes('/video/upload') || p.image.endsWith('.mp4');
            items.push({ url: p.image, isVideo });
          }
        });

        if (!items.length) {
          emptyState();
        } else {
          items.reverse();
          items.forEach(i => addCell(i.url, i.isVideo));
        }
        showGlobalShimmer(false);
      });
    }

    $('#menuBtn').onclick = () => $('#menuDrawer').classList.remove('hidden');
    $('#closeMenu').onclick = $('#menuBackdrop').onclick = () => $('#menuDrawer').classList.add('hidden');
    $('#logoutBtn').onclick = async () => { await signOut(auth); location.href = 'login.html'; };

    $('#editBtn').onclick = () => {
      onValue(ref(db, `users/${currentUid}/profile`), snap => {
        const p = snap.val() || {};
        $('#nameInput').value = p.displayName || auth.currentUser.displayName || '';
        $('#bioInput').value = p.bio || '';
        $('#locationInput').value = p.location || '';
      }, { onlyOnce: true });
      $('#editModal').classList.remove('hidden');
    };

    $('#closeEdit').onclick = () => $('#editModal').classList.add('hidden');

    $('#saveBtn').onclick = async () => {
      if (!isOwner) return;
      $('#overlay').classList.remove('hidden');

      const name = $('#nameInput').value.trim();
      const bio = $('#bioInput').value.trim();
      const loc = $('#locationInput').value.trim();

      const updates = {};
      if (name && name !== auth.currentUser.displayName) {
        await updateProfile(auth.currentUser, { displayName: name });
        updates.displayName = name;
      }
      if (bio !== $('#bio').textContent) updates.bio = bio || null;
      if (loc !== $('#location').textContent) updates.location = loc || null;

      if (Object.keys(updates).length) await updateUserProfile(updates);

      toast('Profile updated!');
      $('#overlay').classList.add('hidden');
      $('#editModal').classList.add('hidden');
    };

    $('#avatarInput').addEventListener('change', async e => {
      if (!isOwner) return;
      const file = e.target.files[0];
      if (!file) return;

      $('#overlay').classList.remove('hidden');
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        const newUrl = data.secure_url;

        await updateProfile(auth.currentUser, { photoURL: newUrl });
        await updateUserProfile({ avatar: newUrl });

        $('#profileAvatar').src = newUrl;
        $('#editPreviewAvatar').src = newUrl;
        toast('Avatar updated!');
      } catch (err) {
        console.error(err);
        toast('Upload failed');
      }
      $('#overlay').classList.add('hidden');
    });

    window.openImageModal = src => {
      const wrap = document.createElement('div');
      wrap.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center';
      wrap.innerHTML = `<img src="${src}" class="max-w-[95%] max-h-[95%] object-contain rounded-lg">`;
      wrap.onclick = () => wrap.remove();
      document.body.appendChild(wrap);
    };

    window.openVideoModal = src => {
      const wrap = document.createElement('div');
      wrap.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center';
      wrap.innerHTML = `
        <video src="${src}" controls autoplay class="max-w-[95%] max-h-[95%] object-contain rounded-lg"></video>
        <span class="absolute top-4 right-4 text-white text-5xl cursor-pointer select-none">×</span>
      `;
      wrap.onclick = e => { if (e.target.tagName !== 'VIDEO') wrap.remove(); };
      document.body.appendChild(wrap);
    };
  </script>
</body>
</html>
