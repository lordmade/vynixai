<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix - Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
      --online: #34C759;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
    }

    .header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--background);
    }

    .chat-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 1.5rem;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      loading: lazy;
    }

    .avatar.editable:hover::after {
      content: '\f083'; /* Camera icon (Unicode from FontAwesome) */
      font-family: 'FontAwesome';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      color: #FFFFFF;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
    }

    .profile-container {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      background: var(--background);
      transition: background 0.3s ease;
    }

    .profile-field {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .profile-field label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .profile-field input, .profile-field textarea {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
      font-size: 0.95rem;
      outline: none;
    }

    .profile-field input[readonly], .profile-field textarea[readonly] {
      background: var(--background);
      border-color: transparent;
    }

    .status-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .status-dot.online {
      background: var(--online);
    }

    .save-btn {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #FFFFFF;
      font-size: 0.875rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .save-btn:hover {
      transform: scale(1.05);
    }

    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .image-modal.active {
      display: flex;
    }

    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      transform: scale(1);
      transition: transform 0.3s ease;
    }

    .image-modal img:hover {
      transform: scale(1.2);
    }

    .menu-dropdown {
      position: absolute;
      top: 60px;
      right: 1rem;
      background: var(--chat-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1000;
    }

    .menu-dropdown.active {
      display: block;
    }

    .menu-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .menu-item:hover {
      background: var(--background);
    }

    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .custom-alert.active {
      display: flex;
    }

    .alert-content {
      background: var(--background);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .alert-content p {
      margin: 0 0 1rem;
      font-size: 1rem;
    }

    .alert-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .alert-buttons button {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    #alert-confirm {
      background: var(--accent);
      color: #FFFFFF;
    }

    #alert-cancel {
      background: var(--border);
      color: var(--text-primary);
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 640px) {
      .header { padding: 0.75rem; }
      .avatar { width: 60px; height: 60px; font-size: 1.2rem; }
      .profile-container { padding: 1rem; }
      .profile-field input, .profile-field textarea { font-size: 0.9rem; padding: 0.5rem; }
      .save-btn { font-size: 0.8rem; padding: 0.5rem 1rem; }
      .menu-dropdown { top: 50px; }
      .menu-item { font-size: 0.8rem; padding: 0.5rem 1rem; }
      .icon-btn svg { width: 18px; height: 18px; }
      .image-modal img { max-width: 95%; max-height: 95%; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="chat-profile">
      <button class="icon-btn" onclick="window.location.href='index.html'" aria-label="Back to Home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6" />
        </svg>
      </button>
      <span>Profile</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="window.toggleMenu()" aria-label="Open Menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
  <div id="menu-dropdown" class="menu-dropdown">
    <div class="menu-item" onclick="window.location.href='index.html'">Home</div>
    <div class="menu-item" onclick="window.location.href='settings.html'">Settings</div>
    <div class="menu-item" onclick="setBackground()">Change Background</div>
    <div class="menu-item" onclick="firebase.auth().signOut()">Sign Out</div>
  </div>
  <div class="profile-container">
    <div id="profile-avatar" class="avatar" aria-label="Profile Picture"></div>
    <input id="profile-upload" type="file" accept="image/jpeg,image/png" style="display: none;" aria-label="Upload Profile Picture" />
    <div class="profile-field">
      <label for="profile-name">Name</label>
      <input id="profile-name" type="text" placeholder="Your name" maxlength="50" aria-label="Profile Name" />
    </div>
    <div class="profile-field">
      <label for="profile-bio">Bio</label>
      <textarea id="profile-bio" placeholder="Tell us about yourself" rows="4" maxlength="150" aria-label="Profile Bio"></textarea>
    </div>
    <div class="profile-field">
      <label for="profile-status">Status</label>
      <div class="status-container">
        <span id="status-dot" class="status-dot"></span>
        <input id="profile-status" type="text" placeholder="Online" maxlength="30" aria-label="Profile Status" />
      </div>
    </div>
    <button id="save-btn" class="save-btn" aria-label="Save Profile">Save</button>
  </div>
  <div id="image-modal" class="image-modal" role="dialog" aria-label="Profile Picture Viewer">
    <img id="modal-image" src="" alt="Full-size Profile Picture" />
  </div>
  <div id="custom-alert" class="custom-alert" role="dialog" aria-label="Alert Dialog">
    <div class="alert-content">
      <p id="alert-message"></p>
      <input id="alert-input" type="text" style="display: none;" aria-label="Alert Input" />
      <div id="alert-buttons" class="alert-buttons">
        <button id="alert-confirm">OK</button>
        <button id="alert-cancel">Cancel</button>
      </div>
    </div>
  </div>
  <div id="spinner-overlay" class="spinner-overlay" aria-label="Loading">
    <div class="spinner"></div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const ROUTES = {
      INDEX: 'index.html',
      LOGIN: 'login.html'
    };

    const MESSAGES = {
      SIGN_IN_REQUIRED: 'Please sign in to view this page.',
      PROFILE_NOT_FOUND: 'Profile not found.',
      PROFILE_UPDATE_SUCCESS: 'Profile updated successfully!',
      PROFILE_UPDATE_FAIL: 'Failed to update profile.',
      UPLOAD_FAIL: 'Failed to upload profile picture.',
      BACKGROUND_UPDATE_SUCCESS: 'Background updated successfully!',
      BACKGROUND_UPDATE_FAIL: 'Failed to update background.'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const profileAvatar = document.getElementById("profile-avatar");
    const profileName = document.getElementById("profile-name");
    const profileBio = document.getElementById("profile-bio");
    const profileStatus = document.getElementById("profile-status");
    const statusDot = document.getElementById("status-dot");
    const saveBtn = document.getElementById("save-btn");
    const profileUpload = document.getElementById("profile-upload");
    const imageModal = document.getElementById("image-modal");
    const modalImage = document.getElementById("modal-image");
    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    const alertInput = document.getElementById("alert-input");
    const alertConfirm = document.getElementById("alert-confirm");
    const alertCancel = document.getElementById("alert-cancel");
    const spinnerOverlay = document.getElementById("spinner-overlay");
    let alertResolve = null;
    let isEditable = false;

    window.showAlert = function (message, autoHide = true, input = false, confirmCallback = null, cancelCallback = null) {
      return new Promise((resolve) => {
        alertMessage.textContent = message;
        alertInput.style.display = input ? "block" : "none";
        alertConfirm.style.display = confirmCallback ? "block" : "none";
        alertCancel.style.display = cancelCallback ? "none" : "none";
        customAlert.classList.add("active");
        alertResolve = resolve;

        if (input) {
          alertInput.focus();
        }

        if (autoHide && !confirmCallback && !cancelCallback) {
          setTimeout(window.hideAlert, 5000);
        }

        alertConfirm.onclick = () => {
          if (confirmCallback) {
            confirmCallback(input ? alertInput.value : true);
          }
          resolve(input ? alertInput.value : true);
          window.hideAlert();
        };

        alertCancel.onclick = () => {
          if (cancelCallback) {
            cancelCallback();
          }
          resolve(false);
          window.hideAlert();
        };
      });
    };

    window.hideAlert = function () {
      customAlert.classList.remove("active");
      alertInput.style.display = "none";
      alertConfirm.style.display = "none";
      alertCancel.style.display = "none";
      alertInput.value = "";
      alertResolve = null;
    };

    window.toggleMenu = function () {
      document.getElementById("menu-dropdown").classList.toggle("active");
    };

    async function uploadMedia(file, isProfile = true) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'banter_box');
      try {
        spinnerOverlay.classList.add('active');
        const response = await fetch(`https://api.cloudinary.com/v1_1/dqkujefxj/image/upload`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        spinnerOverlay.classList.remove('active');
        if (data.secure_url) {
          return { url: data.secure_url, type: 'image' };
        } else {
          throw new Error('Upload failed');
        }
      } catch (error) {
        spinnerOverlay.classList.remove('active');
        console.error('Error uploading media:', error);
        window.showAlert(MESSAGES.UPLOAD_FAIL, false);
        return null;
      }
    }

    async function setBackground() {
      if (!isEditable) return;
      const backgroundUrl = await window.showAlert('Enter background image URL (or leave blank for default):', false, true);
      try {
        await set(ref(db, `users/${auth.currentUser.uid}/profileSettings/background`), backgroundUrl || '');
        document.querySelector('.profile-container').style.background = backgroundUrl ? `url(${backgroundUrl}) center/cover no-repeat` : 'var(--background)';
        window.showAlert(MESSAGES.BACKGROUND_UPDATE_SUCCESS, true);
      } catch (error) {
        console.error('Error updating background:', error);
        window.showAlert(MESSAGES.BACKGROUND_UPDATE_FAIL, false);
      }
    }

    async function loadProfile(userId, targetUserId) {
      const userRef = ref(db, `users/${targetUserId}`);
      const userSnapshot = await get(userRef);
      if (!userSnapshot.exists()) {
        window.showAlert(MESSAGES.PROFILE_NOT_FOUND, false);
        window.location.href = ROUTES.INDEX;
        return;
      }
      const user = userSnapshot.val();
      profileAvatar.innerHTML = user.name ? user.name.charAt(0) : 'U';
      if (user.profilePicture) {
        profileAvatar.innerHTML = `<img src="${user.profilePicture}" alt="Profile Picture" />`;
      }
      profileName.value = user.name || 'Anonymous';
      profileBio.value = user.bio || '';
      profileStatus.value = user.status || 'Offline';
      if (user.profileSettings?.background) {
        document.querySelector('.profile-container').style.background = `url(${user.profileSettings.background}) center/cover no-repeat`;
      }

      isEditable = userId === targetUserId;
      profileName.readOnly = !isEditable;
      profileBio.readOnly = !isEditable;
      profileStatus.readOnly = !isEditable;
      profileAvatar.classList.toggle('editable', isEditable);
      saveBtn.style.display = isEditable ? 'block' : 'none';
      profileUpload.style.display = isEditable ? 'block' : 'none';

      // Dynamic status
      onValue(ref(db, `users/${targetUserId}/lastSeen`), (snapshot) => {
        const lastSeen = snapshot.val();
        if (lastSeen) {
          const now = Date.now();
          const diffMinutes = Math.floor((now - lastSeen) / (1000 * 60));
          if (diffMinutes < 5) {
            statusDot.classList.add('online');
            profileStatus.value = 'Online';
          } else {
            statusDot.classList.remove('online');
            profileStatus.value = `Last seen ${diffMinutes} mins ago`;
            if (diffMinutes > 60) {
              const hours = Math.floor(diffMinutes / 60);
              profileStatus.value = `Last seen ${hours} ${hours === 1 ? 'hour' : 'hours'} ago`;
            }
          }
        }
      });
    }

    async function saveProfile(userId) {
      if (!profileName.value || profileName.value.length > 50 || profileBio.value.length > 150 || profileStatus.value.length > 30) {
        window.showAlert('Invalid input: Name (max 50 chars), Bio (max 150 chars), Status (max 30 chars).', false);
        return;
      }
      try {
        await set(ref(db, `users/${userId}`), {
          name: profileName.value,
          bio: profileBio.value,
          status: profileStatus.value,
          profilePicture: profileAvatar.querySelector('img')?.src || '',
          lastSeen: Date.now()
        });
        window.showAlert(MESSAGES.PROFILE_UPDATE_SUCCESS, true);
      } catch (error) {
        console.error('Error updating profile:', error);
        window.showAlert(MESSAGES.PROFILE_UPDATE_FAIL, false);
      }
    }

    // Initialize
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('userId') || user.uid;
        loadProfile(user.uid, targetUserId);

        // Update lastSeen periodically
        setInterval(() => {
          if (isEditable) {
            set(ref(db, `users/${user.uid}/lastSeen`), Date.now());
          }
        }, 60000);
      } else {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        window.location.href = ROUTES.LOGIN;
      }
    });

    profileAvatar.addEventListener('click', () => {
      if (isEditable) {
        profileUpload.click();
      } else if (profileAvatar.querySelector('img')) {
        modalImage.src = profileAvatar.querySelector('img').src;
        imageModal.classList.add('active');
      }
    });

    imageModal.addEventListener('click', () => {
      imageModal.classList.remove('active');
    });

    profileUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file && isEditable) {
        const media = await uploadMedia(file);
        if (media) {
          profileAvatar.innerHTML = `<img src="${media.url}" alt="Profile Picture" />`;
          saveProfile(auth.currentUser.uid);
        }
        e.target.value = '';
      }
    });

    saveBtn.addEventListener('click', () => {
      if (isEditable) {
        saveProfile(auth.currentUser.uid);
      }
    });
  </script>
</body>
</html>
