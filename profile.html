<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Profile • Vynix</title>

  <!-- PWA / theme -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0f1419; --text2:#536471;
      --border:#eff3f4; --accent:#ff2a6d; --hover-accent:rgba(255,42,109,.1);
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000; --text:#e7e9ea; --text2:#71767b;
      --border:#2f3336;
    }
    *{-webkit-user-select:none !important; user-select:none !important; -webkit-touch-callout:none !important; -webkit-tap-highlight-color:transparent !important;}
    input,textarea,button{-webkit-user-select:auto !important; user-select:text !important;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .btn-primary{background:var(--accent); color:#fff;}
    .btn-primary:disabled{opacity:.5;}
    .toast{position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--accent); color:#fff; padding:12px 24px; border-radius:999px; box-shadow:0 10px 15px -3px rgba(0,0,0,.3); font-weight:600; opacity:0; transition:all .4s cubic-bezier(.175,.885,.32,1.275); z-index:50;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:40;}
    .spinner{border:3px solid rgba(255,255,255,.3); border-top:3px solid #fff; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    main{padding-bottom:80px;}
    .tab-active{color:var(--accent) !important; border-bottom:2px solid var(--accent);}
    .post-card{border-bottom:1px solid var(--border); padding:16px;}
    .post-avatar{width:40px; height:40px; border-radius:50%; object-fit:cover;}
    .post-image{border-radius:16px; margin-top:12px; max-width:100%; border:1px solid var(--border);}
    .post-actions{display:flex; justify-content:space-between; margin-top:12px; max-width:400px; color:var(--text2);}
    .action-item{display:flex; align-items:center; gap:6px; font-size:13px; cursor:pointer;}
    .action-item:hover.reply{color:#1d9bf0;}
    .action-item:hover.repost{color:#00ba7c;}
    .action-item:hover.like{color:#f91880;}
    .action-item svg{width:18px; height:18px;}
    .action-item.liked svg{fill:#f91880; stroke:#f91880;}
  </style>
</head>

<body>
  <!-- top bar -->
  <header class="sticky top-0 z-30 bg-white/80 dark:bg-black/80 backdrop-blur border-b border-[var(--border)] flex items-center px-4 h-14">
    <button onclick="history.back()" class="material-icons-outlined text-xl text-[var(--text2)]">arrow_back</button>
    <h1 class="ml-4 font-bold text-lg">Profile</h1>
  </header>

  <!-- PROFILE -->
  <div id="profile-wrapper" class="min-h-screen">
    <!-- cover -->
    <div class="relative h-52 bg-gradient-to-br from-[#ff2a6d] to-[#05d9e8]">
      <img id="coverImg" class="w-full h-full object-cover" src="https://via.placeholder.com/800x200/e1e8ed/999?text=Cover">
      <label for="coverInput" class="absolute bottom-2 right-2 bg-black/50 text-white p-2 rounded-full cursor-pointer hidden owner-only"><span class="material-icons-outlined">photo_camera</span></label>
      <input type="file" id="coverInput" accept="image/*" class="hidden">
    </div>

    <!-- avatar + buttons -->
    <div class="flex justify-between items-start px-4 -mt-16">
      <div class="relative">
        <img id="profileAvatar" class="w-32 h-32 rounded-full border-4 border-[var(--card)] object-cover" src="" alt="avatar">
        <label for="avatarInput" class="absolute bottom-0 right-0 bg-black/50 text-white p-2 rounded-full cursor-pointer hidden owner-only"><span class="material-icons-outlined">photo_camera</span></label>
        <input type="file" id="avatarInput" accept="image/*" class="hidden">
      </div>
      <div class="mt-20 flex gap-2">
        <button id="followBtn" class="px-4 py-2 rounded-full border border-[var(--border)] text-sm font-bold hidden visitor-only">Follow</button>
        <button id="editBtn" class="px-4 py-2 rounded-full border border-[var(--border)] text-sm font-bold hidden owner-only">Edit profile</button>
        <button id="logoutBtn" class="px-4 py-2 rounded-full border border-[var(--border)] text-sm font-bold hidden owner-only">Log out</button>
      </div>
    </div>

    <!-- name / bio -->
    <div class="px-4 mt-4">
      <h2 id="displayName" class="text-xl font-extrabold leading-tight">Loading…</h2>
      <p id="userHandle" class="text-sm text-[var(--text2)]"></p>
      <p id="bio" class="mt-3 text-[15px] whitespace-pre-wrap"></p>
      <div class="flex items-center gap-4 mt-3 text-sm text-[var(--text2)]">
        <span class="flex items-center gap-1"><span class="material-icons-outlined text-base">location_on</span> <span id="location"></span></span>
        <span class="flex items-center gap-1"><span class="material-icons-outlined text-base">calendar_month</span> <span id="joined"></span></span>
      </div>
      <div class="flex gap-5 mt-3 text-sm">
        <span><b id="followingCount">0</b> <span class="text-[var(--text2)]">Following</span></span>
        <span><b id="followersCount">0</b> <span class="text-[var(--text2)]">Followers</span></span>
      </div>
    </div>

    <!-- tabs -->
    <div class="flex border-b border-[var(--border)] mt-4 text-sm font-bold">
      <button class="tab flex-1 py-3 tab-active" data-tab="posts">Posts</button>
      <button class="tab flex-1 py-3" data-tab="replies">Replies</button>
      <button class="tab flex-1 py-3" data-tab="media">Media</button>
      <button class="tab flex-1 py-3" data-tab="likes">Likes</button>
    </div>

    <!-- feed -->
    <main id="profile-feed" class="feed pb-20"></main>
  </div>

  <!-- EDIT MODAL (owner only) -->
  <div id="editModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center px-4">
    <div class="bg-[var(--card)] rounded-2xl w-full max-w-md p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">Edit profile</h3>
        <button id="closeEdit" class="material-icons-outlined">close</button>
      </div>

      <label class="block mb-2 text-sm font-semibold">Name</label>
      <input id="nameInput" class="w-full mb-3 rounded-xl border border-[var(--border)] bg-transparent px-4 py-2" placeholder="Your name">

      <label class="block mb-2 text-sm font-semibold">Bio</label>
      <textarea id="bioInput" class="w-full mb-3 rounded-xl border border-[var(--border)] bg-transparent px-4 py-2" rows="3" placeholder="About you"></textarea>

      <label class="block mb-2 text-sm font-semibold">Location</label>
      <input id="locationInput" class="w-full mb-4 rounded-xl border border-[var(--border)] bg-transparent px-4 py-2" placeholder="City, Country">

      <div class="flex gap-3">
        <button id="saveBtn" class="btn-primary flex-1 py-2 rounded-full font-bold">Save</button>
        <button id="cancelEdit" class="flex-1 py-2 rounded-full border border-[var(--border)] font-bold">Cancel</button>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-[var(--border)] z-40">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <!-- toast / spinner -->
  <div id="toast" class="toast"></div>
  <div id="overlay" class="overlay hidden"><div class="spinner"></div></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, query, orderByChild, limitToLast, endAt, get, push, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey:"AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain:"fire-b-a8878.firebaseapp.com",
      databaseURL:"https://fire-b-a8878.firebaseio.com",
      projectId:"fire-b-a8878",
      storageBucket:"fire-b-a8878.firebasestorage.app",
      messagingSenderId:"658673187627",
      appId:"1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches) document.body.setAttribute('data-theme','dark');

    const $ = s => document.querySelector(s);
    const toast = msg => {
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };
    const overlay = $('#overlay');

    const CLOUD_NAME = "dqkujefxj";
    const UPLOAD_PRESET = "banter_box";

    /* ---------- who is this page about? ---------- */
    const searchParams = new URLSearchParams(location.search);
    const profileId = searchParams.get('u') || ''; // ?u=<uid>
    let viewerId, viewerName, viewerAvatar;
    let isOwner = false;

    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }
      viewerId = user.uid;
      viewerName = user.displayName || user.email.split('@')[0];
      viewerAvatar = user.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${viewerName}`;
      isOwner = !profileId || profileId === viewerId;
      initPage();
    });

    /* ---------- page init ---------- */
    let ownerId, ownerName, ownerAvatar;
    async function initPage(){
      if (isOwner){
        ownerId = viewerId; ownerName = viewerName; ownerAvatar = viewerAvatar;
        showOwnerUI();
        fillProfile(ownerId);
        switchTab('posts');
        loadCounts();
      } else {
        const snap = await get(ref(db, `users/${profileId}/profile`));
        if (!snap.exists()) { toast('User not found'); history.back(); return; }
        const p = snap.val();
        ownerId = profileId; ownerName = p.displayName || 'User'; ownerAvatar = p.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${ownerName}`;
        showVisitorUI();
        fillProfile(ownerId);
        switchTab('posts');
        loadCounts();
        listenFollowBtn();
      }
    }

    /* ---------- UI helpers ---------- */
    function showOwnerUI(){
      document.querySelectorAll('.owner-only').forEach(el => el.classList.remove('hidden'));
      document.querySelectorAll('.visitor-only').forEach(el => el.classList.add('hidden'));
    }
    function showVisitorUI(){
      document.querySelectorAll('.owner-only').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.visitor-only').forEach(el => el.classList.remove('hidden'));
    }

    /* ---------- fill profile ---------- */
    async function fillProfile(uid){
      const userSnap = await get(ref(db, `users/${uid}/profile`));
      const p = userSnap.val()||{};
      $('#displayName').textContent = p.displayName || 'User';
      $('#userHandle').textContent = '@' + (p.displayName||'user').replace(/\s/g,'').toLowerCase();
      $('#profileAvatar').src = p.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${p.displayName||'U'}`;
      $('#bio').textContent = p.bio || '';
      $('#location').textContent = p.location || '';
      $('#joined').textContent = 'Joined ' + new Date(p.joined||Date.now()).toLocaleDateString('en-US',{month:'short', year:'numeric'});
      if (p.coverURL) $('#coverImg').src = p.coverURL;
    }

    /* ---------- follow system ---------- */
    async function loadCounts(){
      onValue(ref(db, `social/${ownerId}/followers`), s => {
        $('#followersCount').textContent = s.size||0;
        $('#followBtn').textContent = s.hasChild(viewerId) ? 'Following' : 'Follow';
      });
      onValue(ref(db, `social/${ownerId}/following`), s => $('#followingCount').textContent = s.size||0);
    }
    function listenFollowBtn(){
      $('#followBtn').onclick = async () => {
        const followingRef = ref(db, `social/${viewerId}/following/${ownerId}`);
        const followersRef = ref(db, `social/${ownerId}/followers/${viewerId}`);
        const snap = await get(followingRef);
        if (snap.exists()){
          await remove(followingRef);
          await remove(followersRef);
          toast('Unfollowed');
        } else {
          await set(followingRef, {timestamp: serverTimestamp()});
          await set(followersRef, {timestamp: serverTimestamp()});
          toast('Followed');
        }
      };
    }

    /* ---------- upload avatar ---------- */
    $('#avatarInput').addEventListener('change', async e => {
      if (!isOwner) return;
      const file = e.target.files[0]; if (!file) return;
      overlay.classList.remove('hidden');
      const fd = new FormData();
      fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:'POST', body:fd});
        const data = await res.json();
        await updateProfile(auth.currentUser, {photoURL:data.secure_url});
        $('#profileAvatar').src = data.secure_url;
        await set(ref(db, `users/${ownerId}/profile/photoURL`), data.secure_url);
        toast('Avatar updated');
      } catch { toast('Upload failed'); }
      overlay.classList.add('hidden');
    });

    /* ---------- upload cover ---------- */
    $('#coverInput').addEventListener('change', async e => {
      if (!isOwner) return;
      const file = e.target.files[0]; if (!file) return;
      overlay.classList.remove('hidden');
      const fd = new FormData();
      fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:'POST', body:fd});
        const data = await res.json();
        $('#coverImg').src = data.secure_url;
        await set(ref(db, `users/${ownerId}/profile/coverURL`), data.secure_url);
        toast('Cover updated');
      } catch { toast('Upload failed'); }
      overlay.classList.add('hidden');
    });

    /* ---------- tabs ---------- */
    const tabs = ['posts','replies','media','likes'];
    tabs.forEach(t => $(`[data-tab="${t}"]`).addEventListener('click', () => switchTab(t)));
    function switchTab(tab){
      $('#profile-feed').innerHTML = '';
      $('.tab-active').classList.remove('tab-active');
      $(`[data-tab="${tab}"]`).classList.add('tab-active');
      if (tab === 'posts')   loadPosts();
      if (tab === 'replies') loadReplies();
      if (tab === 'media')   loadMedia();
      if (tab === 'likes')   loadLikes();
    }

    /* ---------- posts tab (owner’s posts) ---------- */
    async function loadPosts(){
      const q = query(ref(db, 'posts'), orderByChild('authorId'), endAt(ownerId), limitToLast(20));
      const snap = await get(q);
      const arr = []; snap.forEach(c => { if(c.val().authorId === ownerId) arr.unshift({key:c.key, ...c.val()}); });
      arr.forEach(p => $('#profile-feed').appendChild(renderPostCard(p)));
    }
    /* ---------- replies tab (owner’s comments) ---------- */
    async function loadReplies(){
      const q = query(ref(db, 'comments'), orderByChild('authorId'), endAt(ownerId), limitToLast(20));
      const snap = await get(q);
      const arr = []; snap.forEach(c => { if(c.val().authorId === ownerId) arr.unshift({key:c.key, ...c.val()}); });
      arr.forEach(c => $('#profile-feed').appendChild(renderCommentCard(c)));
    }
    /* ---------- media tab (owner’s posts with image/video) ---------- */
    async function loadMedia(){
      const q = query(ref(db, 'posts'), orderByChild('authorId'), endAt(ownerId), limitToLast(50));
      const snap = await get(q);
      const arr = []; snap.forEach(c => { const v = c.val(); if(v.authorId === ownerId && v.image) arr.unshift({key:c.key, ...v}); });
      arr.forEach(p => $('#profile-feed').appendChild(renderPostCard(p)));
    }
    /* ---------- likes tab (posts owner liked) ---------- */
    async function loadLikes(){
      const likesSnap = await get(ref(db, `likes/${ownerId}`));
      if (!likesSnap.exists()) return $('#profile-feed').innerHTML = '<div class="p-4 text-sm text-[var(--text2)]">No likes yet</div>';
      const keys = Object.keys(likesSnap.val());
      for (const k of keys.reverse().slice(0,20)){
        const postSnap = await get(ref(db, `posts/${k}`));
        if (postSnap.exists()) $('#profile-feed').appendChild(renderPostCard({key:k, ...postSnap.val()}));
      }
    }

    /* ---------- render post card (same as feed) ---------- */
    function renderPostCard(p){
      const div = document.createElement('div'); div.className = 'post-card';
      div.innerHTML = `
        <div class="flex gap-3">
          <img src="${p.authorAvatar}" class="post-avatar">
          <div class="flex-1">
            <div class="flex items-center gap-2 text-sm">
              <span class="font-bold">${esc(p.authorName)}</span>
              ${p.verified ? '<span class="material-icons text-blue-500 text-sm">verified</span>' : ''}
              <span class="text-[var(--text2)]">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
            </div>
            <div class="mt-1 text-[15px] whitespace-pre-wrap">${esc(p.text)}</div>
            ${p.image ? `<img src="${p.image}" class="post-image">` : ''}
            <div class="post-actions">
              <div class="action-item reply"><span class="material-icons-outlined">chat_bubble_outline</span> ${p.replies||0}</div>
              <div class="action-item repost"><span class="material-icons-outlined">repeat</span> ${p.reposts||0}</div>
              <div class="action-item like ${p.liked ? 'liked' : ''}" data-pid="${p.key}"><span class="material-icons-outlined">${p.liked ? 'favorite' : 'favorite_border'}</span> ${p.likes||0}</div>
              <div class="action-item share"><span class="material-icons-outlined">share</span></div>
            </div>
          </div>
        </div>`;
      div.querySelector('.like').onclick = () => toggleLike(p.key);
      div.querySelector('.share').onclick = () => navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
      return div;
    }
    /* ---------- render comment card (replies tab) ---------- */
    function renderCommentCard(c){
      const div = document.createElement('div'); div.className = 'post-card';
      div.innerHTML = `
        <div class="flex gap-3">
          <img src="${ownerAvatar}" class="post-avatar">
          <div class="flex-1">
            <div class="flex items-center gap-2 text-sm">
              <span class="font-bold">${ownerName}</span>
              <span class="text-[var(--text2)]">· ${timeAgo(c.timestamp)}</span>
            </div>
            <div class="mt-1 text-[15px] whitespace-pre-wrap">${esc(c.text)}</div>
          </div>
        </div>`;
      return div;
    }

    /* ---------- like toggle ---------- */
    async function toggleLike(pid){
      const likeRef = ref(db, `likes/${pid}/${viewerId}`);
      const snap = await get(likeRef);
      if (snap.exists()) await remove(likeRef); else await set(likeRef, true);
    }

    /* ---------- edit modal (owner only) ---------- */
    $('#editBtn').onclick = () => $('#editModal').classList.remove('hidden');
    $('#closeEdit').onclick = $('#cancelEdit').onclick = () => $('#editModal').classList.add('hidden');
    $('#saveBtn').onclick = async () => {
      overlay.classList.remove('hidden');
      const name = $('#nameInput').value.trim();
      const bio  = $('#bioInput').value.trim();
      const loc  = $('#locationInput').value.trim();
      if (name && name !== viewerName) await updateProfile(auth.currentUser, {displayName:name});
      await set(ref(db, `users/${ownerId}/profile`), {bio, location:loc, displayName:name});
      toast('Profile saved');
      overlay.classList.add('hidden');
      $('#editModal').classList.add('hidden');
    };

    /* ---------- logout (owner only) ---------- */
    $('#logoutBtn').onclick = async () => {
      overlay.classList.remove('hidden');
      await signOut(auth);
      location.href = 'login.html';
    };

    /* ---------- util ---------- */
    const esc = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const timeAgo = ts => {
      if (!ts) return '';
      const s = Math.floor((Date.now() - ts) / 1000);
      return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
    };
  </script>
</body>
</html>
