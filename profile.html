<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Profile â€¢ Vynix</title>
  <meta name="theme-color" content="#1877f2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ===========  DESIGN TOKENS  (same as feed.html)  =========== -->
  <style>
    :root{
      --bg:#f0f2f5;
      --card:#ffffff;
      --text:#1c1e21;
      --text2:#65676b;
      --border:#ced0d4;
      --accent:#1877f2;
      --accent-green:#42b72a;
      --hover-accent:#f0f2f5;
      --card-shadow:0 1px 2px rgba(0,0,0,0.1);
      --radius:8px;
      --avatar:40px;
      --gutter:16px;
      --trans:.2s ease;
    }
    [data-theme="dark"]{
      --bg:#18191a;
      --card:#242526;
      --text:#e4e6eb;
      --text2:#b0b3b8;
      --border:#3e4042;
      --hover-accent:#3a3b3c;
      --card-shadow:0 1px 2px rgba(0,0,0,0.2);
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text); margin:0; padding-bottom:80px;
    }
    *{box-sizing:border-box; -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;}
    input,textarea{ -webkit-user-select:auto; user-select:auto; }

    /* ----------  reused feed-card styles  ---------- */
    .post-card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--card-shadow);
      margin:0 auto 16px; max-width:680px; transition:var(--trans);
    }
    .post-header{display:flex; align-items:center; gap:12px; padding:16px 16px 12px;}
    .post-avatar{width:var(--avatar); height:var(--avatar); border-radius:50%; object-fit:cover;}
    .user-name{font-size:15px; font-weight:600; color:var(--text);}
    .user-handle,.post-time{font-size:13px; color:var(--text2);}
    .post-content{padding:0 16px 12px; font-size:15px; line-height:1.5; white-space:pre-wrap;}
    .post-image,.post-video{width:100%; max-height:500px; object-fit:cover; border-top:1px solid var(--border);}
    .post-actions{display:flex; align-items:center; justify-content:space-around; padding:8px 16px; border-top:1px solid var(--border);}
    .action-item{display:flex; align-items:center; gap:6px; font-size:15px; color:var(--text2); cursor:pointer; padding:8px; border-radius:6px; transition:var(--trans);}
    .action-item:hover{background:var(--hover-accent);}
    .action-item svg{width:20px; height:20px; stroke-width:1.8;}
    .action-item.liked{color:var(--accent);}
    .action-item.liked svg{fill:var(--accent);}

    /* ----------  profile top (same cards)  ---------- */
    #profileTop{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--card-shadow);
      margin:16px auto; max-width:680px; padding:24px; text-align:center;
    }
    #profileAvatar{width:96px; height:96px; border-radius:50%; object-fit:cover; border:2px solid var(--border);}
    #displayName{font-size:20px; font-weight:700; margin-top:12px;}
    #bio{font-size:15px; color:var(--text2); margin:8px 0 16px;}
    .stat-box{display:flex; justify-content:center; gap:32px; margin:16px 0;}
    .stat{display:flex; flex-direction:column; align-items:center;}
    .stat-val{font-size:18px; font-weight:700;}
    .stat-label{font-size:13px; color:var(--text2);}
    /* pill follow button (keep your existing) */
    #followBtn{background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:999px; font-weight:700; font-size:14px; transition:background .2s;}
    #followBtn.following{background:transparent; color:var(--text); border:1px solid var(--border);}
    #followBtn.following:hover{background:rgba(244,33,46,.08); color:#f4212e; border-color:#f4212e;}
    #followBtn.following:hover span{display:none;}
    #followBtn.following:hover::after{content:'Unfollow';}
    /* nav sticky bar */
    .sticky-bar{position:sticky; top:0; z-index:30; background:var(--bg); border-bottom:1px solid var(--border); height:48px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:600; color:var(--accent);}
    /* bottom nav (same as feed) */
    nav{position:fixed; bottom:0; left:0; right:0; height:56px; background:var(--card); border-top:1px solid var(--border); z-index:40;}
    /* utilities */
    .hidden{display:none;}
    .toast{position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px); background:rgba(0,0,0,.8); color:#fff; padding:12px 24px; border-radius:999px; font-size:14px; opacity:0; transition:all .4s ease; z-index:99;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
    .spinner{border:3px solid rgba(255,255,255,.3); border-top:3px solid var(--accent); border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body>

<!-- =========  HEADER (same sticky bar as feed)  ========= -->
<div class="sticky top-0 z-30 bg-[var(--bg)] border-b border-[var(--border)] h-12 flex items-center justify-between px-4">
  <a href="javascript:history.back()" class="material-icons text-xl">arrow_back</a>
  <div id="navDisplayName" class="font-bold text-base">Profile</div>
  <button id="menuBtn" class="material-icons">more_vert</button>
</div>

<!-- =========  PROFILE TOP CARD  ========= -->
<div id="profileTop">
  <img id="profileAvatar" class="mx-auto" src="" alt="avatar">
  <div id="displayName" class="mt-3">@username</div>
  <p id="bio" class="px-4">No bio yet.</p>
  <div class="stat-box">
    <div class="stat">
      <span id="followingCount" class="stat-val">0</span>
      <span class="stat-label">Following</span>
    </div>
    <div class="stat">
      <span id="followersCount" class="stat-val">0</span>
      <span class="stat-label">Followers</span>
    </div>
    <div class="stat">
      <span id="likesCount" class="stat-val">0</span>
      <span class="stat-label">Likes</span>
    </div>
  </div>
  <div class="flex gap-3 justify-center mt-4">
    <button id="editBtn" class="flex-1 btn-secondary py-2.5 rounded-lg text-sm font-bold">Edit profile</button>
    <button id="followBtn" class="hidden"></button>
    <button id="shareBtn" class="w-12 btn-secondary flex items-center justify-center rounded-lg"><span class="material-icons-outlined">share</span></button>
  </div>
</div>

<!-- =========  STICKY TAB BAR  ========= -->
<div class="sticky-bar">
  <span class="flex items-center gap-2"><span class="material-icons-outlined">grid_on</span> Posts</span>
</div>

<!-- =========  POSTS FEED (same cards as home)  ========= -->
<main id="postsFeed" class="px-2"></main>

<!-- =========  BOTTOM NAV (identical to feed.html)  ========= -->
<nav>
  <div class="h-full flex items-center justify-around text-[var(--text2)]">
    <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
    <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
    <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
    <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
    <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
    <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
  </div>
</nav>

<!-- =========  SMALL HELPERS  ========= -->
<div id="toast" class="toast"></div>
<div id="overlay" class="overlay hidden"><div class="spinner"></div></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue, update, get, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const $ = s => document.querySelector(s);

/* ----------  dark mode  ---------- */
if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.body.setAttribute('data-theme', 'dark');

/* ----------  url params  ---------- */
const urlParams = new URLSearchParams(location.search);
const viewedUid = urlParams.get('uid');
let currentUid = null;
let targetUid = null;
let isOwner = false;

/* ----------  auth  ---------- */
onAuthStateChanged(auth, user => {
  if (!user) { location.href = 'login.html'; return; }
  currentUid = user.uid;
  targetUid = viewedUid || currentUid;
  isOwner = currentUid === targetUid;
  $('#editBtn').style.display = isOwner ? 'block' : 'none';
  $('#followBtn').classList.toggle('hidden', isOwner);
  loadProfile();
  loadCounts();
  loadPosts();
  setupFollowBtn();
});

/* ----------  profile data  ---------- */
function loadProfile() {
  const profRef = ref(db, `users/${targetUid}/profile`);
  onValue(profRef, snap => {
    const p = snap.val() || {};
    const n = p.displayName || 'User';
    $('#profileAvatar').src = p.avatar || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${n}`;
    $('#displayName').textContent = '@' + n.replace(/\s/g, '').toLowerCase();
    $('#navDisplayName').textContent = n;
    $('#bio').textContent = p.bio || 'No bio yet.';
  });
}

/* ----------  counts  ---------- */
function loadCounts() {
  onValue(ref(db, `social/${targetUid}/following`), s => $('#followingCount').textContent = s.size || 0);
  onValue(ref(db, `social/${targetUid}/followers`), s => $('#followersCount').textContent = s.size || 0);
  const q = query(ref(db, 'likes'), orderByChild('authorId'), equalTo(targetUid));
  onValue(q, s => $('#likesCount').textContent = s.size || 0);
}

/* ----------  follow button  ---------- */
function setupFollowBtn() {
  if (isOwner) return;
  const fRef = ref(db, `social/${currentUid}/following/${targetUid}`);
  onValue(fRef, snap => {
    followBtn.className = snap.exists() ? 'following' : '';
  });
  followBtn.onclick = async () => {
    const fRef = ref(db, `social/${currentUid}/following/${targetUid}`);
    const fSnap = await get(fRef);
    const updates = {};
    if (fSnap.exists()) {
      updates[`social/${currentUid}/following/${targetUid}`] = null;
      updates[`social/${targetUid}/followers/${currentUid}`] = null;
    } else {
      updates[`social/${currentUid}/following/${targetUid}`] = true;
      updates[`social/${targetUid}/followers/${currentUid}`] = true;
    }
    await update(ref(db), updates);
  };
}

/* ----------  posts (full-width feed cards)  ---------- */
function loadPosts() {
  const q = query(ref(db, 'posts'), orderByChild('authorId'), equalTo(targetUid));
  onValue(q, snap => {
    const feed = $('#postsFeed');
    feed.innerHTML = '';
    const rows = [];
    snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
    if (!rows.length) {
      feed.innerHTML = '<div class="post-card text-center p-8 text-[var(--text2)]">No posts yet</div>';
      return;
    }
    rows.forEach(p => feed.appendChild(renderPostCard(p)));
  });
}

/* ----------  post card (same markup as feed.html)  ---------- */
function renderPostCard(p) {
  const isLiked = false; // realtime listener below
  const div = document.createElement('div');
  div.className = 'post-card';
  div.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar}" class="post-avatar">
      <div>
        <div class="user-name">${esc(p.authorName)}</div>
        <div class="post-time">${timeAgo(p.timestamp || Date.now())}</div>
      </div>
    </div>
    <div class="post-content">${linkify(esc(p.text))}</div>
    ${p.image ? (p.image.includes('/video/upload') || p.image.endsWith('.mp4') ?
      `<video class="post-video" controls muted loop playsinline><source src="${p.image}" type="video/mp4"></video>` :
      `<img class="post-image" src="${p.image}" loading="lazy">`) : ''}
    <div class="post-actions">
      <div class="action-item reply" data-post="${p.key}"><svg><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span>${p.replies||0}</span></div>
      <div class="action-item repost" data-post="${p.key}"><svg><!-- repost icon --></svg><span>${p.reposts||0}</span></div>
      <div class="action-item like" data-post="${p.key}"><svg><!-- like icon --></svg><span>${p.likes||0}</span></div>
      <div class="action-item share" data-post="${p.key}"><svg><!-- share icon --></svg></div>
    </div>
  `;
  listenCounters(p.key, div);
  return div;
}

/* ----------  realtime like counter  ---------- */
function listenCounters(postId, card) {
  onValue(ref(db, `likes/${postId}`), s => {
    card.querySelector('.like span').textContent = s.size;
    card.querySelector('.like').classList.toggle('liked', s.hasChild(currentUid));
  });
}

/* ----------  utils  ---------- */
const esc = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const timeAgo = ts => {
  const s = Math.floor((Date.now() - (ts||Date.now())) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s/60)}m` : s < 86400 ? `${Math.floor(s/3600)}h` : `${Math.floor(s/86400)}d`;
};
const linkify = t => t
  .replace(/#(\w+)/g, '<a href="search.html?q=%23$1" class="hash-link">#$1</a>')
  .replace(/@(\w+)/g, '<a href="profile.html?handle=$1" class="mention-link">@$1</a>');

/* ----------  menu / toast / overlay  ---------- */
$('#menuBtn').onclick = () => $('#menuDrawer').classList.remove('hidden');
$('#closeMenu').onclick = () => $('#menuDrawer').classList.add('hidden');
window.toast = msg => {
  const t = $('#toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
};
</script>
</body>
</html>
