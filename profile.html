<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNkOTQ2ZWYiLCJ0aGVtZV9jb2xvciI6IiNkOTQ2ZWYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#d946ef">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#f0f2f5;
      --card:#ffffff;
      --text:#1c1e21;
      --text2:#65676b;
      --border:#ced0d4;
      --accent:#d946ef;
      --accent-blue:#1877f2;
      --accent-green:#42b72a;
      --hover-accent:#f0f2f5;
      --card-shadow:0 1px 2px rgba(0,0,0,0.1);
      --radius:8px;
      --avatar:40px;
      --gutter:0px;
      --trans:.2s ease;
    }
    [data-theme="dark"]{
      --bg:#18191a;
      --card:#242526;
      --text:#e4e6eb;
      --text2:#b0b3b8;
      --border:#3e4042;
      --card-shadow:0 1px 2px rgba(0,0,0,0.2);
      --hover-accent:#3a3b3c;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding-bottom:80px;
    }
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    input,textarea{-webkit-user-select:auto;user-select:auto}
    .profile-header{
      background:var(--card);
      box-shadow:var(--card-shadow);
      padding:20px 16px 16px;
      text-align:center;
      position:relative;
    }
    .profile-avatar{
      width:120px;
      height:120px;
      border-radius:50%;
      object-fit:cover;
      border:4px solid var(--card);
      margin-top:-60px;
    }
    .cover-photo{
      width:100%;
      height:200px;
      object-fit:cover;
      border-radius:var(--radius) var(--radius) 0 0;
    }
    .profile-name{
      font-size:24px;
      font-weight:600;
      margin:12px 0 4px;
    }
    .profile-handle{
      font-size:15px;
      color:var(--text2);
      margin-bottom:12px;
    }
    .profile-bio{
      font-size:15px;
      max-width:600px;
      margin:0 auto 16px;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .profile-stats{
      display:flex;
      justify-content:center;
      gap:32px;
      margin:16px 0;
    }
    .stat-item{
      text-align:center;
    }
    .stat-number{
      font-size:18px;
      font-weight:600;
    }
    .stat-label{
      font-size:14px;
      color:var(--text2);
    }
    .profile-actions{
      display:flex;
      justify-content:center;
      gap:12px;
      margin:16px 0;
    }
    .btn-primary{
      background:var(--accent-blue);
      color:#fff;
      border:none;
      border-radius:6px;
      padding:8px 20px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-secondary{
      background:var(--hover-accent);
      color:var(--text);
      border:none;
      border-radius:6px;
      padding:8px 20px;
      font-weight:600;
      cursor:pointer;
    }
    /* ---------- POST CARDS (same as feed) ---------- */
    .post-card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      margin:0 auto 16px;
      max-width:680px;
      transition:var(--trans);
      position:relative;
    }
    .post-card:hover{box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .post-header{display:flex;align-items:center;gap:12px;padding:16px 16px 12px}
    .post-avatar{width:var(--avatar);height:var(--avatar);border-radius:50%;object-fit:cover;flex-shrink:0}
    .user-info{flex:1}
    .user-name{font-size:15px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:4px}
    .user-handle{font-size:13px;color:var(--text2)}
    .post-time{font-size:13px;color:var(--text2)}
    .verified-badge{color:var(--accent-blue);font-size:16px!important}
    .post-content{padding:0 16px 12px;font-size:15px;line-height:1.5;color:var(--text);white-space:pre-wrap}
    .post-image,.post-video{width:100%;max-height:500px;object-fit:cover;margin:0;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    .post-video{max-height:400px}
    .post-actions{display:flex;align-items:center;justify-content:space-around;padding:8px 16px;border-top:1px solid var(--border)}
    .action-item{display:flex;align-items:center;gap:6px;font-size:15px;color:var(--text2);cursor:pointer;padding:8px;border-radius:6px;transition:var(--trans);font-weight:500}
    .action-item:hover{background:var(--hover-accent)}
    .action-item svg{width:20px;height:20px;stroke-width:1.8}
    .action-item.liked{color:var(--accent-blue)}
    .action-item.liked svg{fill:var(--accent-blue)}
    .action-item.disabled{opacity:0.5;cursor:not-allowed;pointer-events:none}
    .action-item.reply:hover{color:var(--accent-blue)}
    .action-item.repost:hover{color:var(--accent-green)}
    .action-item.like:hover{color:var(--accent-blue)}
    .action-item.delete-btn:hover{color:#f4212e}
    .post-content .hash-link,
    .post-content .url-link,
    .post-content .mention-link{
      color:var(--accent-blue);
      font-weight:500;
      text-decoration:none;
    }
    .post-content .hash-link:hover,
    .post-content .url-link:hover,
    .post-content .mention-link:hover{
      text-decoration:underline;
    }
    .video-play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .video-play-overlay .material-icons{font-size:48px;color:var(--accent-blue);text-shadow:0 2px 8px rgba(0,0,0,.45);background:rgba(0,0,0,.35);border-radius:50%;padding:10px}
    .post-video-wrapper{position:relative;display:block;width:100%}
    nav{position:fixed;bottom:0;left:0;right:0;height:56px;background:var(--card);border-top:1px solid var(--border);z-index:40}
    .custom-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--accent-blue);color:#fff;padding:12px 24px;border-radius:20px;box-shadow:0 10px 15px -3px rgba(0,0,0,.3);font-weight:600;opacity:0;transition:all .4s cubic-bezier(.175,.885,.32,1.275);z-index:50;display:flex;align-items:center;gap:8px}
    .custom-toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    /* Edit Modal */
    #edit-modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s ease;
    }
    #edit-modal-overlay.show{opacity:1;pointer-events:auto}
    .edit-modal-box{
      background:var(--card);border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,.25);transform:scale(.95);transition:transform .25s ease;
    }
    #edit-modal-overlay.show .edit-modal-box{transform:scale(1)}
    .edit-modal-title{font-weight:600;font-size:18px;margin-bottom:16px}
    .edit-input{margin-bottom:16px}
    .edit-input label{display:block;font-size:14px;color:var(--text2);margin-bottom:4px}
    .edit-input input,.edit-input textarea{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:15px;
    }
    .edit-input textarea{resize:vertical;min-height:80px}
    .edit-buttons{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
    .change-photo-btn{
      position:absolute;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.5);
      color:#fff;
      border:none;
      border-radius:50%;
      width:36px;
      height:36px;
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .cover-wrapper{position:relative;display:block;width:100%}
    .cover-wrapper .change-photo-btn{bottom:20px;right:20px;left:auto;transform:none}
    .avatar-wrapper{position:relative;display:inline-block}
    .spinner{border:3px solid rgba(255,255,255,.3);border-top:3px solid #fff;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="cover-wrapper">
      <img id="cover-photo" class="cover-photo" src="https://via.placeholder.com/680x200/1877f2/ffffff?text=Cover+Photo" alt="Cover">
      <button class="change-photo-btn hidden" id="change-cover-btn" title="Change cover">
        <span class="material-icons">photo_camera</span>
      </button>
    </div>
    <div class="avatar-wrapper">
      <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
      <button class="change-photo-btn hidden" id="change-avatar-btn" title="Change avatar">
        <span class="material-icons">photo_camera</span>
      </button>
    </div>
    <div class="profile-name" id="profile-name">Loading...</div>
    <div class="profile-handle" id="profile-handle">@loading</div>
    <div class="profile-bio" id="profile-bio"></div>
    <div class="profile-stats">
      <div class="stat-item">
        <div class="stat-number" id="stat-posts">0</div>
        <div class="stat-label">Posts</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="stat-followers">0</div>
        <div class="stat-label">Followers</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="stat-following">0</div>
        <div class="stat-label">Following</div>
      </div>
    </div>
    <div class="profile-actions" id="profile-actions"></div>
  </div>

  <!-- Posts Feed -->
  <main id="feed" class="max-w-2xl mx-auto px-4"></main>

  <div class="text-center p-4">
    <button id="load-more-btn" class="bg-[#1877f2] text-white px-6 py-2 rounded-full font-semibold hidden">Load More</button>
  </div>

  <!-- Hidden file inputs -->
  <input type="file" id="avatar-input" accept="image/*" class="hidden"/>
  <input type="file" id="cover-input" accept="image/*" class="hidden"/>

  <!-- Edit Profile Modal -->
  <div id="edit-modal-overlay">
    <div class="edit-modal-box">
      <div class="edit-modal-title">Edit Profile</div>
      <div class="edit-input">
        <label>Display Name</label>
        <input type="text" id="edit-name" maxlength="50">
      </div>
      <div class="edit-input">
        <label>Handle (no spaces)</label>
        <input type="text" id="edit-handle" maxlength="30" placeholder="e.g. john_doe">
      </div>
      <div class="edit-input">
        <label>Bio</label>
        <textarea id="edit-bio" maxlength="200" rows="3"></textarea>
      </div>
      <div class="edit-buttons">
        <button class="btn-secondary" id="edit-cancel">Cancel</button>
        <button class="btn-primary" id="edit-save">Save</button>
      </div>
    </div>
  </div>

  <!-- Image Modal (reused from feed) -->
  <div id="image-modal">
    <img id="modal-image" src="" alt="Full image">
    <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100" onclick="closeImageModal()">
      <span class="material-icons-outlined text-5xl">close</span>
    </button>
  </div>

  <!-- Navigation -->
  <nav id="navbar" class="fixed bottom-0 left-0 right-0 h-14 bg-white dark:bg-[#242526] border-t border-gray-200 dark:border-gray-700 z-40">
    <div class="h-full flex items-center justify-around text-gray-500">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-20">home</span>
        <span class="text-xs mt-0.5">Home</span>
      </a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-20">chat_bubble_outline</span>
        <span class="text-xs mt-0.5">Chat</span>
      </a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-20">search</span>
        <span class="text-xs mt-0.5">Search</span>
      </a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-20">auto_awesome</span>
        <span class="text-xs mt-0.5">AI</span>
      </a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-20">notifications</span>
        <span class="text-xs mt-0.5">Alerts</span>
      </a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[#1877f2]">
        <span class="material-icons text-20">person</span>
        <span class="text-xs mt-0.5 font-medium">Profile</span>
      </a>
    </div>
  </nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue, query, orderByChild, limitToLast, get, set } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const CLOUD_NAME = "dqkujefxj";
const UPLOAD_PRESET = "banter_box";

let currentUid = null;
let myUid = null;
let isAnonymous = true;
let currentProfileData = {};

const urlParams = new URLSearchParams(location.search);
const profileUid = urlParams.get('uid') || null;

const $ = s => document.querySelector(s);
const feedEl = $('#feed');
const loadMoreBtn = $('#load-more-btn');
const POST_LIMIT = 10;
let lastTimestamp = null;
let lastKey = null;
let initialLoadDone = false;

if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.body.setAttribute('data-theme', 'dark');

onAuthStateChanged(auth, user => {
  if (!user) {
    signInAnonymously(auth).catch(console.error);
  } else {
    myUid = user.uid;
    isAnonymous = false;
    currentUid = profileUid || myUid;
    loadProfile(currentUid);
    initFeed(currentUid);
  }
});

async function loadProfile(uid) {
  const profileRef = ref(db, `users/${uid}/profile`);
  onValue(profileRef, snap => {
    const p = snap.val() || {};
    currentProfileData = p;

    $('#profile-avatar').src = p.avatar || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${encodeURIComponent(p.displayName || 'User')}`;
    $('#profile-name').textContent = p.displayName || 'User';
    $('#profile-handle').textContent = '@' + (p.handle || uid.slice(0,8));
    $('#profile-bio').textContent = p.bio || 'No bio yet.';
    $('#cover-photo').src = p.cover || 'https://via.placeholder.com/680x200/1877f2/ffffff?text=Cover+Photo';

    $('#stat-posts').textContent = '—';
    $('#stat-followers').textContent = '0';
    $('#stat-following').textContent = '0';

    const actions = $('#profile-actions');
    const isOwn = uid === myUid && !isAnonymous;
    $('#change-avatar-btn').classList.toggle('hidden', !isOwn);
    $('#change-cover-btn').classList.toggle('hidden', !isOwn);

    if (isOwn) {
      actions.innerHTML = `<button class="btn-primary" id="edit-profile-btn">Edit Profile</button>`;
      $('#edit-profile-btn').onclick = openEditModal;
    } else {
      actions.innerHTML = `<button class="btn-primary">Follow</button><button class="btn-secondary">Message</button>`;
    }
  });
}

function openEditModal() {
  $('#edit-name').value = currentProfileData.displayName || '';
  $('#edit-handle').value = currentProfileData.handle || '';
  $('#edit-bio').value = currentProfileData.bio || '';
  $('#edit-modal-overlay').classList.add('show');
}

$('#edit-cancel').onclick = () => $('#edit-modal-overlay').classList.remove('show');

$('#edit-save').onclick = async () => {
  const updates = {
    displayName: $('#edit-name').value.trim() || 'User',
    handle: $('#edit-handle').value.trim().replace(/\s/g, '').toLowerCase() || '',
    bio: $('#edit-bio').value.trim()
  };

  if (!updates.displayName) {
    toast('Display name cannot be empty');
    return;
  }

  try {
    await set(ref(db, `users/${myUid}/profile`), {...currentProfileData, ...updates});
    toast('Profile updated!');
    $('#edit-modal-overlay').classList.remove('show');
  } catch (err) {
    toast('Error saving profile');
    console.error(err);
  }
};

// Photo upload
$('#change-avatar-btn').onclick = () => $('#avatar-input').click();
$('#change-cover-btn').onclick = () => $('#cover-input').click();

async function uploadPhoto(file, field) {
  if (!file || !file.type.startsWith('image/')) {
    toast('Please select an image');
    return;
  }

  const btn = field === 'avatar' ? $('#change-avatar-btn') : $('#change-cover-btn');
  const spinner = document.createElement('span');
  spinner.className = 'spinner';
  btn.disabled = true;
  btn.appendChild(spinner);

  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);

  try {
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: 'POST',
      body: fd
    });
    const data = await res.json();
    if (data.secure_url) {
      await set(ref(db, `users/${myUid}/profile/${field}`), data.secure_url);
      toast('Photo updated!');
    } else {
      toast('Upload failed');
    }
  } catch (err) {
    toast('Upload error');
    console.error(err);
  } finally {
    btn.disabled = false;
    if (spinner.parentNode) spinner.remove();
  }
}

$('#avatar-input').onchange = e => { if (e.target.files[0]) uploadPhoto(e.target.files[0], 'avatar'); };
$('#cover-input').onchange = e => { if (e.target.files[0]) uploadPhoto(e.target.files[0], 'cover'); };

function showSkeletonLoaders(count = 5) {
  feedEl.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'post-card';
    skeleton.innerHTML = `
      <div class="post-header">
        <div style="width:40px;height:40px;border-radius:50%;background:var(--border)"></div>
        <div class="flex-1">
          <div style="height:16px;background:var(--border);border-radius:8px;width:40%;margin-bottom:8px"></div>
          <div style="height:12px;background:var(--border);border-radius:6px;width:70%"></div>
        </div>
      </div>
      <div style="height:200px;background:var(--border);border-radius:8px;margin-top:12px"></div>
    `;
    feedEl.appendChild(skeleton);
  }
}

async function initFeed(uid) {
  showSkeletonLoaders();
  const postsRef = ref(db, 'posts');
  const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT * 2));
  const snap = await get(q);

  feedEl.innerHTML = '';
  if (!snap.exists()) {
    feedEl.innerHTML = '<div class="text-center p-8 text-gray-500">No posts yet.</div>';
    return;
  }

  const rows = [];
  snap.forEach(c => {
    const val = c.val();
    if (val.authorId === uid) rows.unshift({key: c.key, ...val});
  });

  if (!rows.length) {
    feedEl.innerHTML = '<div class="text-center p-8 text-gray-500">No posts yet.</div>';
    return;
  }

  rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
  const last = rows[rows.length-1];
  lastTimestamp = last.timestamp;
  lastKey = last.key;

  loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
  initialLoadDone = true;
}

function renderPostCard(p) {
  const isMine = p.authorId === myUid;
  const isAnon = isAnonymous;
  const div = document.createElement('div');
  div.className = 'post-card';
  div.id = `post-${p.key}`;

  const mediaMarkup = p.image ? (
    p.image.includes('/video/upload') || p.image.endsWith('.mp4') ?
    `<div class="post-video-wrapper">
       <video class="post-video" muted loop playsinline>
         <source src="${p.image}" type="video/mp4">
       </video>
       <div class="video-play-overlay">
         <span class="material-icons">play_circle_filled</span>
       </div>
     </div>` :
    `<img class="post-image" src="${p.image}" loading="lazy">`
  ) : '';

  div.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar}" class="post-avatar">
      <div class="user-info">
        <div class="user-name">
          <span class="name">${esc(p.authorName)}</span>
        </div>
        <div class="user-handle">@${(p.authorName || '').replace(/\s/g,'').toLowerCase()}</div>
        <div class="post-time">${timeAgo(p.timestamp || Date.now())}</div>
      </div>
    </div>
    <div class="post-content">${linkify(esc(p.text || ''))}</div>
    ${mediaMarkup}
    <div class="post-actions">
      <div class="action-item reply ${isAnon ? 'disabled' : ''}">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        <span>${p.replies || 0}</span>
      </div>
      <div class="action-item repost ${isAnon ? 'disabled' : ''}">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2l4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
        <span>${p.reposts || 0}</span>
      </div>
      <div class="action-item like ${isAnon ? 'disabled' : ''}">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <span>${p.likes || 0}</span>
      </div>
      ${isMine && !isAnon ? `<div class="action-item delete-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      </div>` : ''}
    </div>
  `;

  div.addEventListener('click', e => {
    const img = e.target.closest('.post-image');
    if (img) { openImageModal(img.src); return; }
  });

  return div;
}

function openImageModal(src) {
  $('#modal-image').src = src;
  $('#image-modal').classList.add('show');
}

window.closeImageModal = () => $('#image-modal').classList.remove('show');
$('#image-modal').addEventListener('click', e => { if (e.target === $('#image-modal')) closeImageModal(); });

function esc(s) { return s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }

function timeAgo(ts) {
  if (!ts) return 'now';
  const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s/60)}m` : s < 86400 ? `${Math.floor(s/3600)}h` : `${Math.floor(s/86400)}d`;
}

function linkify(str) {
  str = str.replace(/#(\w+)/g, '<a href="search.html?q=%23$1" class="hash-link">#$1</a>');
  str = str.replace(/@(\w+)/g, '<a href="profile.html?handle=$1" class="mention-link">@$1</a>');
  const urlRegex = /(https?:\/\/|www\.)([^\s<]+)/gi;
  str = str.replace(urlRegex, match => {
    const href = match.startsWith('www.') ? 'https://' + match : match;
    return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="url-link">${match}</a>`;
  });
  return str;
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'custom-toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
}

// Nav highlight
document.querySelector('nav a[href="profile.html"]').classList.add('text-[#1877f2]');
document.querySelector('nav a[href="profile.html"] span.material-icons-outlined')?.classList.replace('material-icons-outlined', 'material-icons');
</script>
</body>
</html>
