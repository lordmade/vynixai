<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Profile â€¢ Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --bg: #000; --card: #16181c; --text: #fff; --sub: #71767b; --border: #2f3336; --blue: #1d9bf0; }
    body.light { --bg: #fff; --card: #f7f9fa; --text: #0f1419; --sub: #536471; --border: #e1e8ed; }
    body { font-family: system-ui; background: var(--bg); color: var(--text); margin:0; overflow-x:hidden; }
    .header { position:fixed; top:0; left:0; right:0; background:var(--bg); border-bottom:1px solid var(--border); z-index:100; display:flex; align-items:center; justify-content:space-between; padding:12px 16px; height:64px; }
    .back { font-size:28px; cursor:pointer; }
    .main { padding-top:84px; }
    .cover { height:200px; background:var(--blue); background-size:cover; border-radius:0 0 16px 16px; }
    .avatar { width:134px; height:134px; border-radius:50%; border:5px solid var(--card); position:absolute; top:140px; left:20px; object-fit:cover; box-shadow:0 4px 20px rgba(0,0,0,0.5); }
    .info { padding:80px 20px 20px; }
    .name { font-size:20px; font-weight:800; display:flex; align-items:center; gap:6px; }
    .verified { color:var(--blue); }
    .handle { color:var(--sub); font-size:15px; }
    .bio { margin:12px 0; line-height:1.5; }
    .stats { display:flex; gap:30px; margin:16px 0; }
    .stat { cursor:pointer; }
    .num { font-weight:800; font-size:18px; }
    .label { font-size:13px; color:var(--sub); }
    .actions { display:flex; gap:12px; margin-top:20px; }
    .btn { flex:1; padding:14px; border-radius:999px; font-weight:700; text-align:center; cursor:pointer; }
    .follow { background:#fff; color:#000; }
    .following { background:transparent; border:1px solid var(--border); }
    .edit { background:transparent; border:1px solid var(--border); }
    .tabs { display:flex; margin:20px; border-bottom:1px solid var(--border); }
    .tab { flex:1; padding:16px; text-align:center; font-weight:600; color:var(--sub); cursor:pointer; position:relative; }
    .tab.active { color:var(--blue); }
    .tab.active::after { content:''; position:absolute; bottom:-1px; left:0; right:0; height:2px; background:var(--blue); }
    .post { background:var(--card); border:1px solid var(--border); border-radius:16px; margin:12px 20px; overflow:hidden; }
    .post-header { padding:12px 16px; display:flex; gap:12px; align-items:center; }
    .post-avatar { width:44px; height:44px; border-radius:50%; object-fit:cover; }
    .post-name { font-weight:700; font-size:15px; display:flex; align-items:center; gap:4px; }
    .post-time { font-size:13px; color:var(--sub); }
    .post-content { padding:0 16px 12px; white-space:pre-wrap; }
    .post-media { width:100%; max-height:500px; object-fit:contain; background:#000; }
    .post-actions { padding:8px 16px; display:flex; justify-content:space-around; border-top:1px solid var(--border); }
    .action { color:var(--sub); display:flex; align-items:center; gap:8px; cursor:pointer; }
    .action.liked { color:#f91880; }
    .empty { text-align:center; padding:80px 20px; color:var(--sub); }
    .empty span { font-size:64px; opacity:0.5; display:block; margin-bottom:16px; }
    #spinner { position:fixed; top:0; left:0; right:0; height:3px; background:transparent; z-index:101; overflow:hidden; display:none; }
    #spinner.active { display:block; }
    #bar { height:100%; width:150%; background:linear-gradient(90deg,transparent,var(--blue),transparent); animation:shimmer 1.5s infinite; }
    @keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
    .alert { position:fixed; top:84px; left:50%; transform:translateX(-50%); background:var(--blue); color:#000; padding:12px 32px; border-radius:999px; z-index:1000; font-weight:700; display:none; }
    .alert.active { display:block; animation:down 0.4s; }
    @keyframes down { from{opacity:0; transform:translateX(-50%) translateY(-20px)} to{opacity:1} }
  </style>
</head>
<body class="dark">

<div id="spinner"><div id="bar"></div></div>
<div id="alert" class="alert"></div>

<header class="header">
  <span class="material-icons back" onclick="history.back()">arrow_back</span>
  <h1 style="font-weight:800;font-size:20px;">Profile</h1>
  <div style="display:flex;gap:12px;">
    <span class="material-icons" onclick="toggleTheme()" style="font-size:26px;cursor:pointer;">bedtime</span>
    <span class="material-icons" onclick="signOut()" style="font-size:26px;cursor:pointer;">logout</span>
  </div>
</header>

<main class="main">
  <div id="profile-header"></div>
  
  <div class="tabs">
    <div class="tab active" data-tab="posts">Posts</div>
    <div class="tab" data-tab="replies">Replies</div>
    <div class="tab" data-tab="media">Media</div>
    <div class="tab" data-tab="likes">Likes</div>
  </div>

  <div id="posts-tab" class="tab-content active"></div>
  <div id="replies-tab" class="tab-content"></div>
  <div id="media-tab" class="tab-content"></div>
  <div id="likes-tab" class="tab-content"></div>
</main>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
  import { getDatabase, ref, onValue, get, query, orderByChild, equalTo, limitToLast } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

  const app = initializeApp({
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    storageBucket: "fire-b-a8878.firebasestorage.app",
    messagingSenderId: "658673187627",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  });

  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let profileUser = null;
  let profileUid = new URLSearchParams(location.search).get('uid') || null;
  let isOwnProfile = false;

  const alertEl = document.getElementById('alert');
  const showAlert = (msg) => {
    alertEl.textContent = msg;
    alertEl.classList.add('active');
    setTimeout(() => alertEl.classList.remove('active'), 3000);
  };
  const spinner = document.getElementById('spinner');
  const showSpinner = () => spinner.classList.add('active');
  const hideSpinner = () => spinner.classList.remove('active');

  function formatTime(ts) {
    const d = Date.now() - ts;
    const m = 6e4, h = m*60, day = h*24;
    if (d < m) return Math.floor(d/1e3)+'s';
    if (d < h) return Math.floor(d/m)+'m';
    if (d < day) return Math.floor(d/h)+'h';
    return Math.floor(d/day)+'d';
  }

  function renderPost(s, container) {
    const avatar = profileUser.photoURL || `https://ui-avatars.com/api/?name=${(profileUser.displayName||'U')[0]}&background=1d9bf0&color=fff`;
    const post = document.createElement('div');
    post.className = 'post';
    post.innerHTML = `
      <div class="post-header">
        <img src="${avatar}" class="post-avatar">
        <div>
          <div class="post-name">${profileUser.displayName||'User'} ${profileUser.verified?'<span class="material-icons verified">verified</span>':''}</div>
          <div class="post-time">${formatTime(s.timestamp)}</div>
        </div>
      </div>
      ${s.content ? `<div class="post-content">${s.content.replace(/\n/g,'<br>')}</div>` : ''}
      ${s.mediaUrl ? `<img src="${s.mediaUrl}" class="post-media">` : ''}
      <div class="post-actions">
        <div class="action"><span class="material-icons">chat_bubble_outline</span> 0</div>
        <div class="action"><span class="material-icons">repeat</span> 0</div>
        <div class="action ${s.liked?'liked':''}"><span class="material-icons">${s.liked?'favorite':'favorite_border'}</span> ${s.likes||0}</div>
      </div>
    `;
    container.appendChild(post);
  }

  async function loadTab(tab) {
    const containers = {
      posts: document.getElementById('posts-tab'),
      replies: document.getElementById('replies-tab'),
      media: document.getElementById('media-tab'),
      likes: document.getElementById('likes-tab')
    };
    Object.values(containers).forEach(c => c.innerHTML = '');
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    const container = containers[tab];
    container.innerHTML = '<div class="empty"><span class="material-icons">hourglass_empty</span><p>Loading...</p></div>';

    const statusesRef = ref(db, 'statuses');
    let q;

    if (tab === 'posts') {
      q = query(statusesRef, orderByChild('userId'), equalTo(profileUid));
    } else if (tab === 'replies') {
      // Replies = statuses where parentId exists and userId = profileUid
      const all = await get(statusesRef);
      const replies = [];
      all.forEach(snap => {
        const s = snap.val();
        if (s.parentId && s.userId === profileUid) replies.push({id: snap.key, ...s});
      });
      if (replies.length === 0) {
        container.innerHTML = '<div class="empty"><span class="material-icons">question_answer</span><p>No replies yet</p></div>';
        return;
      }
      replies.sort((a,b) => b.timestamp - a.timestamp);
      replies.forEach(s => renderPost(s, container));
      return;
    } else if (tab === 'media') {
      q = query(statusesRef, orderByChild('userId'), equalTo(profileUid));
      const snap = await get(q);
      const media = [];
      snap.forEach(child => {
        const s = child.val();
        if (s.mediaUrl) media.push({id: child.key, ...s});
      });
      if (media.length === 0) {
        container.innerHTML = '<div class="empty"><span class="material-icons">perm_media</span><p>No media posts</p></div>';
        return;
      }
      media.sort((a,b) => b.timestamp - a.timestamp);
      media.forEach(s => renderPost(s, container));
      return;
    } else if (tab === 'likes') {
      // Get all statuses liked by this user
      const likesRef = ref(db, `statuses`);
      const allSnap = await get(likesRef);
      const liked = [];
      allSnap.forEach(child => {
        const s = child.val();
        if (s.likes && s.likes[currentUser.uid]) liked.push({id: child.key, ...s, liked: true});
      });
      if (liked.length === 0) {
        container.innerHTML = '<div class="empty"><span class="material-icons">favorite_border</span><p>No liked posts</p></div>';
        return;
      }
      liked.sort((a,b) => b.timestamp - a.timestamp);
      liked.forEach(s => renderPost(s, container));
      return;
    }

    const snap = await get(q);
    if (!snap.exists()) {
      container.innerHTML = '<div class="empty"><span class="material-icons">article</span><p>No posts yet</p></div>';
      return;
    }

    const posts = [];
    snap.forEach(child => posts.push({id: child.key, ...child.val()}));
    posts.sort((a,b) => b.timestamp - a.timestamp);
    posts.forEach(p => renderPost(p, container));
  }

  async function loadProfile() {
    if (!profileUser) return;

    isOwnProfile = currentUser.uid === profileUid;
    const following = Object.keys(profileUser.following || {}).length;
    const followers = profileUser.followersCount || 0;
    const avatar = profileUser.photoURL || `https://ui-avatars.com/api/?name=${(profileUser.displayName||'U')[0]}&background=1d9bf0&color=fff`;
    const cover = profileUser.coverUrl || 'https://images.unsplash.com/photo-1557682250-33bd709cbe85?w=1200&h=400&fit=crop';

    const isFollowing = !isOwnProfile && (currentUser.following?.[profileUid]);

    document.getElementById('profile-header').innerHTML = `
      <div class="cover" style="background-image:url('${cover}')"></div>
      <img src="${avatar}" class="avatar">
      <div class="info">
        <div class="name">${profileUser.displayName||'User'} ${profileUser.verified?'<span class="material-icons verified">verified</span>':''}</div>
        <div class="handle">@${profileUser.username||'user'}</div>
        ${profileUser.bio ? `<div class="bio">${profileUser.bio}</div>` : ''}
        <div class="stats">
          <div class="stat"><div class="num">${following}</div><div class="label">Following</div></div>
          <div class="stat"><div class="num">${followers}</div><div class="label">Followers</div></div>
        </div>
        <div class="actions">
          ${isOwnProfile 
            ? `<button class="btn edit" onclick="location.href='settings.html'">Edit Profile</button>`
            : `<button class="btn ${isFollowing?'following':'follow'}" id="followBtn">${isFollowing?'Following':'Follow'}</button>`
          }
        </div>
      </div>
    `;

    if (!isOwnProfile) {
      document.getElementById('followBtn').onclick = toggleFollow;
    }

    // Real-time followers
    onValue(ref(db, `users/${profileUid}/followersCount`), snap => {
      const c = snap.val() || 0;
      document.querySelector('.stat:nth-child(2) .num').textContent = c;
    });
  }

  async function toggleFollow() {
    const btn = document.getElementById('followBtn');
    const followingRef = ref(db, `users/${currentUser.uid}/following/${profileUid}`);
    const followerRef = ref(db, `users/${profileUid}/followersCount`);
    const wasFollowing = (await get(followingRef)).exists();

    if (wasFollowing) {
      await set(followingRef, null);
      const c = (await get(followerRef)).val() || 1;
      await set(followerRef, Math.max(0, c-1));
      btn.textContent = 'Follow';
      btn.className = 'btn follow';
    } else {
      await set(followingRef, Date.now());
      const c = (await get(followerRef)).val() || 0;
      await set(followerRef, c+1);
      btn.textContent = 'Following';
      btn.className = 'btn following';
    }
    showAlert(wasFollowing ? 'Unfollowed' : 'Now following');
  }

  function toggleTheme() {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light')?'light':'dark');
  }

  onAuthStateChanged(auth, async user => {
    if (!user) return location.href = 'login.html';
    currentUser = user;
    if (!profileUid) profileUid = user.uid;

    const userSnap = await get(ref(db, `users/${profileUid}`));
    if (!userSnap.exists()) return showAlert('User not found'), setTimeout(()=>location.href='index.html',2000);

    profileUser = userSnap.val();
    profileUser.uid = profileUid;

    if (!isOwnProfile) {
      const followingSnap = await get(ref(db, `users/${user.uid}/following`));
      currentUser.following = followingSnap.val() || {};
    }

    loadProfile();
    loadTab('posts');
    hideSpinner();

    document.querySelectorAll('.tab').forEach(t => {
      t.onclick = () => loadTab(t.dataset.tab);
    });
  });

  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  window.signOut = () => signOut(auth).then(()=>location.href='login.html');
</script>
</body>
</html>
