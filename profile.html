<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Profile • Vynix</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0f1419; --text2:#536471;
      --border:#eff3f4; --accent:#ff2a6d; --hover-accent:rgba(255,42,109,.1);
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000; --text:#e7e9ea; --text2:#71767b;
      --border:#2f3336;
    }
    *{-webkit-user-select:none; user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;}
    input,textarea,button{-webkit-user-select:auto; user-select:auto;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg); color:var(--text);}
    .tab-active{color:var(--accent) !important; border-b-2 border-accent;}
    .btn-primary{background:var(--accent); color:#fff;}
    .btn-primary:disabled{opacity:.5;}
    .toast{position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px);
           background:var(--accent); color:#fff; padding:12px 24px; border-radius:999px;
           box-shadow:0 10px 15px -3px rgba(0,0,0,.3); font-weight:600; opacity:0;
           transition:all .4s cubic-bezier(.175,.885,.32,1.275); z-index:50;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:40;}
    .spinner{border:3px solid rgba(255,255,255,.3); border-top:3px solid #fff; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    main{padding-bottom:80px;}
  </style>
</head>

<body>
  <!-- Top bar -->
  <header class="sticky top-0 z-30 bg-white/80 dark:bg-black/80 backdrop-blur border-b border-[var(--border)] flex items-center px-4 h-14">
    <button onclick="history.back()" class="material-icons-outlined text-xl text-[var(--text2)]">arrow_back</button>
    <h1 class="ml-4 font-bold text-lg">Profile</h1>
  </header>

  <!-- PROFILE -->
  <div id="profile-wrapper" class="min-h-screen">
    <!-- cover -->
    <div class="h-52 bg-gradient-to-br from-[#ff2a6d] to-[#05d9e8]"></div>

    <!-- avatar + buttons -->
    <div class="flex justify-between items-start px-4 -mt-16">
      <img id="profileAvatar" class="w-32 h-32 rounded-full border-4 border-[var(--card)] object-cover" src="" alt="avatar">
      <div class="mt-20 flex gap-2">
        <button id="editBtn" class="px-4 py-2 rounded-full border border-[var(--border)] text-sm font-bold">Edit profile</button>
        <button id="logoutBtn" class="px-4 py-2 rounded-full border border-[var(--border)] text-sm font-bold">Log out</button>
      </div>
    </div>

    <!-- name / bio -->
    <div class="px-4 mt-4">
      <h2 id="displayName" class="text-xl font-extrabold leading-tight">Loading…</h2>
      <p id="userHandle" class="text-sm text-[var(--text2)]"></p>
      <p id="bio" class="mt-3 text-[15px] whitespace-pre-wrap"></p>
      <div class="flex items-center gap-4 mt-3 text-sm text-[var(--text2)]">
        <span class="flex items-center gap-1"><span class="material-icons-outlined text-base">location_on</span> <span id="location"></span></span>
        <span class="flex items-center gap-1"><span class="material-icons-outlined text-base">calendar_month</span> <span id="joined"></span></span>
      </div>
      <div class="flex gap-5 mt-3 text-sm">
        <span><b id="followingCount">0</b> <span class="text-[var(--text2)]">Following</span></span>
        <span><b id="followersCount">0</b> <span class="text-[var(--text2)]">Followers</span></span>
      </div>
    </div>

    <!-- tabs -->
    <div class="flex border-b border-[var(--border)] mt-4 text-sm font-bold">
      <button class="tab flex-1 py-3 tab-active" data-tab="posts">Posts</button>
      <button class="tab flex-1 py-3" data-tab="replies">Replies</button>
      <button class="tab flex-1 py-3" data-tab="media">Media</button>
      <button class="tab flex-1 py-3" data-tab="likes">Likes</button>
    </div>

    <!-- feed -->
    <main id="profile-feed" class="feed pb-20"></main>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center px-4">
    <div class="bg-[var(--card)] rounded-2xl w-full max-w-md p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">Edit profile</h3>
        <button id="closeEdit" class="material-icons-outlined">close</button>
      </div>

      <label class="block mb-2 text-sm font-semibold">Name</label>
      <input id="nameInput" class="w-full mb-3 rounded-xl border border-[var(--border)] bg-transparent px-4 py-2" placeholder="Your name">

      <label class="block mb-2 text-sm font-semibold">Bio</label>
      <textarea id="bioInput" class="w-full mb-3 rounded-xl border border-[var(--border)] bg-transparent px-4 py-2" rows="3" placeholder="About you"></textarea>

      <label class="block mb-2 text-sm font-semibold">Location</label>
      <input id="locationInput" class="w-full mb-4 rounded-xl border border-[var(--border)] bg-transparent px-4 py-2" placeholder="City, Country">

      <div class="flex gap-3">
        <button id="saveBtn" class="btn-primary flex-1 py-2 rounded-full font-bold">Save</button>
        <button id="cancelEdit" class="flex-1 py-2 rounded-full border border-[var(--border)] font-bold">Cancel</button>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-[var(--border)] z-40">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="feed.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <!-- toast -->
  <div id="toast" class="toast"></div>
  <!-- spinner -->
  <div id="overlay" class="overlay hidden"><div class="spinner"></div></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, query, orderByChild, limitToLast, endAt, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey:"AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain:"fire-b-a8878.firebaseapp.com",
      databaseURL:"https://fire-b-a8878.firebaseio.com",
      projectId:"fire-b-a8878",
      storageBucket:"fire-b-a8878.firebasestorage.app",
      messagingSenderId:"658673187627",
      appId:"1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    /* ---------- theme ---------- */
    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches) document.body.setAttribute('data-theme','dark');

    /* ---------- shortcuts ---------- */
    const $ = s => document.querySelector(s);
    const toast = msg => {
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };
    const overlay = $('#overlay');

    /* ---------- auth ---------- */
    let uid, uname, uavatar;
    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }
      uid   = user.uid;
      uname = user.displayName || user.email.split('@')[0];
      uavatar = user.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
      fillProfile(user);
      loadPosts();
      loadCounts();
    });

    /* ---------- fill profile ---------- */
    function fillProfile(user){
      $('#displayName').textContent = user.displayName || 'Set your name';
      $('#userHandle').textContent = '@' + (user.displayName||'user').replace(/\s/g,'').toLowerCase();
      $('#profileAvatar').src = uavatar;
      $('#joined').textContent = 'Joined ' + new Date(user.metadata.creationTime).toLocaleDateString('en-US',{month:'short', year:'numeric'});
      onValue(ref(db, `users/${uid}/profile`), s => {
        const p = s.val()||{};
        $('#bio').textContent = p.bio || '';
        $('#location').textContent = p.location || '';
      });
    }
    /* ---------- counts ---------- */
    function loadCounts(){
      onValue(ref(db, `social/${uid}/following`), s => $('#followingCount').textContent = s.size||0);
      onValue(ref(db, `social/${uid}/followers`), s => $('#followersCount').textContent = s.size||0);
    }

    /* ---------- posts tab ---------- */
    let lastTs = null, lastKey = null;
    async function loadPosts(){
      const q = query(ref(db, 'posts'), orderByChild('authorId'), endAt(uid), limitToLast(20));
      const snap = await get(q);
      const arr = []; snap.forEach(c => { if(c.val().authorId === uid) arr.unshift({key:c.key, ...c.val()}); });
      arr.forEach(p => $('#profile-feed').appendChild(renderPost(p)));
      const last = arr[arr.length-1]; if(last){ lastTs = last.timestamp; lastKey = last.key; }
    }
    function renderPost(p){
      const div = document.createElement('div');
      div.className = 'border-b border-[var(--border)] px-4 py-3';
      div.innerHTML = `
        <div class="flex gap-3">
          <img src="${uavatar}" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-bold">${uname}</span>
              <span class="text-sm text-[var(--text2)]">@${uname.replace(/\s/g,'').toLowerCase()}</span>
              <span class="text-sm text-[var(--text2)]">· ${timeAgo(p.timestamp)}</span>
            </div>
            <div class="mt-1 text-[15px] whitespace-pre-wrap">${esc(p.text)}</div>
            ${p.image ? `<img src="${p.image}" class="mt-2 rounded-2xl border border-[var(--border)]">` : ''}
            <div class="flex justify-between max-w-xs mt-3 text-[var(--text2)]">
              <span class="flex items-center gap-2"><span class="material-icons-outlined text-base">chat_bubble_outline</span> ${p.replies||0}</span>
              <span class="flex items-center gap-2"><span class="material-icons-outlined text-base">repeat</span> ${p.reposts||0}</span>
              <span class="flex items-center gap-2"><span class="material-icons-outlined text-base">favorite_border</span> ${p.likes||0}</span>
            </div>
          </div>
        </div>`;
      return div;
    }

    /* ---------- edit modal ---------- */
    $('#editBtn').onclick = () => $('#editModal').classList.remove('hidden');
    $('#closeEdit').onclick = $('#cancelEdit').onclick = () => $('#editModal').classList.add('hidden');
    $('#saveBtn').onclick = async () => {
      overlay.classList.remove('hidden');
      const name = $('#nameInput').value.trim();
      const bio  = $('#bioInput').value.trim();
      const loc  = $('#locationInput').value.trim();
      if (name && name !== uname) await updateProfile(auth.currentUser, { displayName: name });
      await set(ref(db, `users/${uid}/profile`), { bio, location: loc });
      toast('Profile saved');
      overlay.classList.add('hidden');
      $('#editModal').classList.add('hidden');
    };

    /* ---------- logout ---------- */
    $('#logoutBtn').onclick = async () => {
      overlay.classList.remove('hidden');
      await signOut(auth);
      location.href = 'login.html';
    };

    /* ---------- util ---------- */
    const esc = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const timeAgo = ts => {
      if (!ts) return '';
      const s = Math.floor((Date.now() - ts) / 1000);
      return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
    };
  </script>
</body>
</html>
