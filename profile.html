<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix - Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
    }

    .header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--background);
    }

    .chat-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 1.5rem;
      overflow: hidden;
      cursor: pointer;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
    }

    .profile-container {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .profile-field {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .profile-field label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .profile-field input, .profile-field textarea {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
      font-size: 0.95rem;
      outline: none;
    }

    .profile-field input[readonly], .profile-field textarea[readonly] {
      background: var(--background);
      border-color: transparent;
    }

    .save-btn {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #FFFFFF;
      font-size: 0.875rem;
      cursor: pointer;
    }

    .menu-dropdown {
      position: absolute;
      top: 60px;
      right: 1rem;
      background: var(--chat-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1000;
    }

    .menu-dropdown.active {
      display: block;
    }

    .menu-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .menu-item:hover {
      background: var(--background);
    }

    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .custom-alert.active {
      display: flex;
    }

    .alert-content {
      background: var(--background);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .alert-content p {
      margin: 0 0 1rem;
      font-size: 1rem;
    }

    .alert-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .alert-buttons button {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    #alert-confirm {
      background: var(--accent);
      color: #FFFFFF;
    }

    #alert-cancel {
      background: var(--border);
      color: var(--text-primary);
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 640px) {
      .header { padding: 0.75rem; }
      .avatar { width: 60px; height: 60px; font-size: 1.2rem; }
      .profile-container { padding: 1rem; }
      .profile-field input, .profile-field textarea { font-size: 0.9rem; padding: 0.5rem; }
      .save-btn { font-size: 0.8rem; padding: 0.5rem 1rem; }
      .menu-dropdown { top: 50px; }
      .menu-item { font-size: 0.8rem; padding: 0.5rem 1rem; }
      .icon-btn svg { width: 18px; height: 18px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="chat-profile">
      <button class="icon-btn" onclick="window.location.href='index.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6" />
        </svg>
      </button>
      <span>Profile</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="window.toggleMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
  <div id="menu-dropdown" class="menu-dropdown">
    <div class="menu-item" onclick="window.location.href='index.html'">Home</div>
    <div class="menu-item" onclick="window.location.href='settings.html'">Settings</div>
    <div class="menu-item" onclick="firebase.auth().signOut()">Sign Out</div>
  </div>
  <div class="profile-container">
    <div id="profile-avatar" class="avatar"></div>
    <input id="profile-upload" type="file" accept="image/jpeg,image/png" style="display: none;" />
    <div class="profile-field">
      <label for="profile-name">Name</label>
      <input id="profile-name" type="text" placeholder="Your name" />
    </div>
    <div class="profile-field">
      <label for="profile-bio">Bio</label>
      <textarea id="profile-bio" placeholder="Tell us about yourself" rows="4"></textarea>
    </div>
    <div class="profile-field">
      <label for="profile-status">Status</label>
      <input id="profile-status" type="text" placeholder="Online" />
    </div>
    <button id="save-btn" class="save-btn">Save</button>
  </div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-content">
      <p id="alert-message"></p>
      <div id="alert-buttons" class="alert-buttons">
        <button id="alert-confirm">OK</button>
        <button id="alert-cancel">Cancel</button>
      </div>
    </div>
  </div>
  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const ROUTES = {
      INDEX: 'index.html',
      LOGIN: 'login.html'
    };

    const MESSAGES = {
      SIGN_IN_REQUIRED: 'Please sign in to view this page.',
      PROFILE_NOT_FOUND: 'Profile not found.',
      PROFILE_UPDATE_SUCCESS: 'Profile updated successfully!',
      PROFILE_UPDATE_FAIL: 'Failed to update profile.',
      UPLOAD_FAIL: 'Failed to upload profile picture.'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const profileAvatar = document.getElementById("profile-avatar");
    const profileName = document.getElementById("profile-name");
    const profileBio = document.getElementById("profile-bio");
    const profileStatus = document.getElementById("profile-status");
    const saveBtn = document.getElementById("save-btn");
    const profileUpload = document.getElementById("profile-upload");
    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    const alertConfirm = document.getElementById("alert-confirm");
    const alertCancel = document.getElementById("alert-cancel");
    const spinnerOverlay = document.getElementById("spinner-overlay");
    let alertResolve = null;
    const ENCRYPTION_KEY = "my-secret-key-123";
    let isEditable = false;

    window.showAlert = function (message, autoHide = true, confirmCallback = null, cancelCallback = null) {
      return new Promise((resolve) => {
        alertMessage.textContent = message;
        alertConfirm.style.display = confirmCallback ? "block" : "none";
        alertCancel.style.display = cancelCallback ? "none" : "none";
        customAlert.classList.add("active");
        alertResolve = resolve;

        if (autoHide && !confirmCallback && !cancelCallback) {
          setTimeout(window.hideAlert, 5000);
        }

        alertConfirm.onclick = () => {
          if (confirmCallback) {
            confirmCallback(true);
          }
          resolve(true);
          window.hideAlert();
        };

        alertCancel.onclick = () => {
          if (cancelCallback) {
            cancelCallback();
          }
          resolve(false);
          window.hideAlert();
        };
      });
    };

    window.hideAlert = function () {
      customAlert.classList.remove("active");
      alertConfirm.style.display = "none";
      alertCancel.style.display = "none";
      alertResolve = null;
    };

    window.toggleMenu = function () {
      document.getElementById("menu-dropdown").classList.toggle("active");
    };

    function decryptField(ciphertext) {
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_KEY);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        return decrypted || '';
      } catch (error) {
        console.error("Decryption error:", error);
        return '';
      }
    }

    async function uploadMedia(file, isProfile = true) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'banter_box');
      try {
        spinnerOverlay.classList.add('active');
        const response = await fetch(`https://api.cloudinary.com/v1_1/dqkujefxj/image/upload`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        spinnerOverlay.classList.remove('active');
        if (data.secure_url) {
          return { url: data.secure_url, type: 'image' };
        } else {
          throw new Error('Upload failed');
        }
      } catch (error) {
        spinnerOverlay.classList.remove('active');
        console.error('Error uploading media:', error);
        window.showAlert(MESSAGES.UPLOAD_FAIL, false);
        return null;
      }
    }

    async function loadProfile(userId, targetUserId) {
      const userRef = ref(db, `users/${targetUserId}`);
      const userSnapshot = await get(userRef);
      if (!userSnapshot.exists()) {
        window.showAlert(MESSAGES.PROFILE_NOT_FOUND, false);
        window.location.href = ROUTES.INDEX;
        return;
      }
      const user = userSnapshot.val();
      profileAvatar.innerHTML = user.name ? user.name.charAt(0) : 'U';
      if (user.profilePicture) {
        profileAvatar.innerHTML = `<img src="${decryptField(user.profilePicture)}" alt="Profile Picture" />`;
      }
      profileName.value = decryptField(user.name) || 'Anonymous';
      profileBio.value = decryptField(user.bio) || '';
      profileStatus.value = decryptField(user.status) || 'Offline';

      isEditable = userId === targetUserId;
      profileName.readOnly = !isEditable;
      profileBio.readOnly = !isEditable;
      profileStatus.readOnly = !isEditable;
      profileAvatar.style.cursor = isEditable ? 'pointer' : 'default';
      saveBtn.style.display = isEditable ? 'block' : 'none';
      profileUpload.style.display = isEditable ? 'block' : 'none';
    }

    async function saveProfile(userId) {
      try {
        const encryptedName = CryptoJS.AES.encrypt(profileName.value, ENCRYPTION_KEY).toString();
        const encryptedBio = CryptoJS.AES.encrypt(profileBio.value, ENCRYPTION_KEY).toString();
        const encryptedStatus = CryptoJS.AES.encrypt(profileStatus.value, ENCRYPTION_KEY).toString();
        await set(ref(db, `users/${userId}`), {
          name: encryptedName,
          bio: encryptedBio,
          status: encryptedStatus,
          profilePicture: profileAvatar.querySelector('img')?.src || ''
        });
        window.showAlert(MESSAGES.PROFILE_UPDATE_SUCCESS, true);
      } catch (error) {
        console.error('Error updating profile:', error);
        window.showAlert(MESSAGES.PROFILE_UPDATE_FAIL, false);
      }
    }

    // Initialize
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('userId') || user.uid;
        loadProfile(user.uid, targetUserId);
      } else {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        window.location.href = ROUTES.LOGIN;
      }
    });

    profileAvatar.addEventListener('click', () => {
      if (isEditable) {
        profileUpload.click();
      }
    });

    profileUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file && isEditable) {
        const media = await uploadMedia(file);
        if (media) {
          profileAvatar.innerHTML = `<img src="${media.url}" alt="Profile Picture" />`;
          saveProfile(auth.currentUser.uid);
        }
        e.target.value = '';
      }
    });

    saveBtn.addEventListener('click', () => {
      if (isEditable) {
        saveProfile(auth.currentUser.uid);
      }
    });
  </script>
</body>
</html>
