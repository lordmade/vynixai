<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Profile â€¢ Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000000; --card-bg: #16181c; --text-primary: #ffffff; --text-secondary: #71767b;
      --border: #2f3336; --accent: #1d9bf0; --header-bg: rgba(0,0,0,0.9);
    }
    body.light { 
      --bg: #ffffff; --card-bg: #f7f9fa; --text-primary: #0f1419; --text-secondary: #536471; 
      --border: #e1e8ed; --header-bg: rgba(255,255,255,0.95);
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-primary); margin: 0; overflow-x: hidden; }
    .header { position: fixed; top: 0; left: 0; right: 0; background: var(--header-bg); backdrop-filter: blur(12px);
      z-index: 100; padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; height: 64px; }
    .back-btn { background: none; border: none; color: var(--text-primary); font-size: 28px; cursor: pointer; }
    .main-content { padding-top: 84px; min-height: 100vh; }
    .profile-header { background: var(--card-bg); padding: 20px; position: relative; border-bottom: 1px solid var(--border); }
    .cover { height: 200px; background: #1d9bf0; background-size: cover; background-position: center; border-radius: 16px; margin-bottom: 60px; }
    .avatar { width: 134px; height: 134px; border-radius: 50%; border: 5px solid var(--card-bg); position: absolute; bottom: -67px; left: 20px; object-fit: cover; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .info { margin-top: 70px; padding: 0 20px; }
    .name { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .verified { color: #1d9bf0; font-size: 22px; }
    .handle { color: var(--text-secondary); font-size: 15px; }
    .bio { margin: 12px 0; line-height: 1.5; }
    .stats { display: flex; gap: 30px; margin: 16px 0; }
    .stat { text-align: center; cursor: pointer; }
    .number { font-weight: 800; font-size: 18px; }
    .label { font-size: 13px; color: var(--text-secondary); }
    .actions { display: flex; gap: 12px; margin-top: 20px; }
    .btn { flex: 1; padding: 14px; border-radius: 999px; font-weight: 700; text-align: center; cursor: pointer; transition: all 0.2s; }
    .btn-follow { background: white; color: black; }
    .btn-following { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }
    .btn-edit { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }
    .tab-switcher { display: flex; margin: 20px; border-bottom: 1px solid var(--border); }
    .tab { flex: 1; padding: 16px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer; }
    .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
    .status-post { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; margin: 12px 20px; overflow: hidden; }
    .post-header { padding: 12px 16px; display: flex; align-items: center; gap: 12px; }
    .post-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }
    .post-name { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 4px; }
    .post-time { font-size: 13px; color: var(--text-secondary); }
    .post-content { padding: 0 16px 12px; white-space: pre-wrap; }
    .post-media { width: 100%; max-height: 500px; object-fit: contain; background: black; }
    .post-actions { padding: 8px 16px; display: flex; justify-content: space-around; border-top: 1px solid var(--border); }
    .action { color: var(--text-secondary); display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .action.liked { color: #f91880; }
    #horizontal-spinner { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: transparent; z-index: 101; overflow: hidden; display: none; }
    #horizontal-spinner.active { display: block; }
    #spinner-segment { height: 100%; width: 150%; background: linear-gradient(90deg, transparent, var(--accent), transparent); animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    .alert { position: fixed; top: 84px; left: 50%; transform: translateX(-50%); background: var(--accent); color: black; padding: 12px 32px; border-radius: 999px; z-index: 1000; font-weight: 700; box-shadow: 0 4px 20px rgba(29,155,240,0.4); display: none; }
    .alert.active { display: block; animation: slideDown 0.4s ease; }
    @keyframes slideDown { from { transform: translateX(-50%) translateY(-20px); opacity: 0; } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .empty { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty .material-icons { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
  </style>
</head>
<body class="dark">

  <div id="horizontal-spinner"><div id="spinner-segment"></div></div>
  <div id="alert" class="alert"></div>

  <header class="header">
    <button class="back-btn material-icons" onclick="history.back()">arrow_back</button>
    <h1 style="font-weight:800;font-size:20px;">Profile</h1>
    <div style="display:flex;gap:12px;">
      <button onclick="toggleTheme()" class="material-icons" style="font-size:26px;cursor:pointer;">bedtime</button>
      <button onclick="signOut()" class="material-icons" style="font-size:26px;cursor:pointer;">logout</button>
    </div>
  </header>

  <main class="main-content">
    <div id="profile-header"></div>
    <div class="tab-switcher">
      <div class="tab active" data-tab="posts">Posts</div>
      <div class="tab" data-tab="replies">Replies</div>
      <div class="tab" data-tab="media">Media</div>
      <div class="tab" data-tab="likes">Likes</div>
    </div>
    <div id="posts-tab" class="tab-content active"></div>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, get, update, set } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let profileUser = null;
    let profileUid = new URLSearchParams(location.search).get('uid') || null;
    let isOwnProfile = false;

    const alert = document.getElementById('alert');
    const showAlert = (msg) => {
      alert.textContent = msg;
      alert.classList.add('active');
      setTimeout(() => alert.classList.remove('active'), 3000);
    };

    const spinner = document.getElementById('horizontal-spinner');
    const showSpinner = () => spinner.classList.add('active');
    const hideSpinner = () => spinner.classList.remove('active');

    function formatTime(ts) {
      const diff = Date.now() - ts;
      const min = 60_000, hour = min*60, day = hour*24;
      if (diff < min) return Math.floor(diff/1000) + 's';
      if (diff < hour) return Math.floor(diff/min) + 'm';
      if (diff < day) return Math.floor(diff/hour) + 'h';
      return Math.floor(diff/day) + 'd';
    }

    async function loadProfile() {
      if (!profileUser) return;

      isOwnProfile = currentUser.uid === profileUid;
      const following = Object.keys(profileUser.following || {}).length;
      const followers = profileUser.followersCount || 0;

      const avatar = profileUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(profileUser.displayName || 'U')}&background=1d9bf0&color=fff&size=256`;
      const cover = profileUser.coverUrl || 'https://images.unsplash.com/photo-1557682250-33bd709cbe85?w=1200&h=400&fit=crop';

      const isFollowing = currentUser.uid !== profileUid && (currentUser.following?.[profileUid]);

      document.getElementById('profile-header').innerHTML = `
        <div class="cover" style="background-image:url('${cover}')"></div>
        <img src="${avatar}" class="avatar">
        <div class="info">
          <div class="name">
            ${profileUser.displayName || 'User'} ${profileUser.verified ? '<span class="material-icons verified">verified</span>' : ''}
          </div>
          <div class="handle">@${profileUser.username || 'user'}</div>
          ${profileUser.bio ? `<div class="bio">${profileUser.bio}</div>` : ''}
          <div class="stats">
            <div class="stat"><div class="number">${following}</div><div class="label">Following</div></div>
            <div class="stat"><div class="number">${followers}</div><div class="label">Followers</div></div>
          </div>
          <div class="actions">
            ${isOwnProfile 
              ? `<button class="btn btn-edit" onclick="location.href='settings.html'">Edit Profile</button>`
              : `<button class="btn ${isFollowing ? 'btn-following' : 'btn-follow'}" id="follow-btn" onclick="toggleFollow()">
                   ${isFollowing ? 'Following' : 'Follow'}
                 </button>`
            }
          </div>
        </div>
      `;

      // Real-time follower count
      onValue(ref(db, `users/${profileUid}/followersCount`), (snap) => {
        const count = snap.val() || 0;
        document.querySelector('.stat:nth-child(2) .number').textContent = count;
      });
    }

    async function loadStatuses() {
      const container = document.getElementById('posts-tab');
      container.innerHTML = '<div class="empty"><span class="material-icons">auto_stories</span><p>Loading posts...</p></div>';

      const statusesRef = ref(db, 'statuses');
      const snap = await get(query(statusesRef, orderByChild('userId'), equalTo(profileUid)));

      if (!snap.exists()) {
        container.innerHTML = '<div class="empty"><span class="material-icons">article</span><p>No posts yet</p></div>';
        return;
      }

      const statuses = [];
      snap.forEach(child => {
        const s = child.val();
        s.id = child.key;
        statuses.push(s);
      });

      statuses.sort((a, b) => b.timestamp - a.timestamp);

      container.innerHTML = statuses.map(s => {
        const avatar = profileUser.photoURL || `https://ui-avatars.com/api/?name=${(profileUser.displayName || 'U')[0]}&background=1d9bf0&color=fff`;
        return `
          <div class="status-post">
            <div class="post-header">
              <img src="${avatar}" class="post-avatar">
              <div>
                <div class="post-name">${profileUser.displayName || 'User'}</div>
                <div class="post-time">${formatTime(s.timestamp)}</div>
              </div>
            </div>
            ${s.content ? `<div class="post-content">${s.content.replace(/\n/g, '<br>')}</div>` : ''}
            ${s.mediaUrl ? `<img src="${s.mediaUrl}" class="post-media">` : ''}
            <div class="post-actions">
              <div class="action"><span class="material-icons">chat_bubble_outline</span> 0</div>
              <div class="action"><span class="material-icons">repeat</span> 0</div>
              <div class="action"><span class="material-icons">favorite_border</span> 0</div>
            </div>
          </div>
        `;
      }).join('');
    }

    window.toggleFollow = async () => {
      if (isOwnProfile) return;
      const btn = document.getElementById('follow-btn');
      const followingRef = ref(db, `users/${currentUser.uid}/following/${profileUid}`);
      const followerRef = ref(db, `users/${profileUid}/followersCount`);

      const snap = await get(followingRef);
      const wasFollowing = snap.exists();

      if (wasFollowing) {
        await set(followingRef, null);
        const countSnap = await get(followerRef);
        await set(followerRef, Math.max(0, (countSnap.val() || 1) - 1));
        btn.textContent = 'Follow';
        btn.className = 'btn btn-follow';
      } else {
        await set(followingRef, Date.now());
        const countSnap = await get(followerRef);
        await set(followerRef, (countSnap.val() || 0) + 1);
        btn.textContent = 'Following';
        btn.className = 'btn btn-following';
      }
      showAlert(wasFollowing ? 'Unfollowed' : 'Now following');
    };

    function toggleTheme() {
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    }

    async function signOut() {
      await auth.signOut();
      location.href = 'login.html';
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = 'login.html';
      currentUser = user;

      if (!profileUid) profileUid = user.uid;

      const userSnap = await get(ref(db, `users/${profileUid}`));
      if (!userSnap.exists()) {
        showAlert('User not found');
        return setTimeout(() => location.href = 'index.html', 2000);
      }

      profileUser = userSnap.val();
      profileUser.uid = profileUid;

      // Load current user's following for accurate button
      if (!isOwnProfile) {
        const followingSnap = await get(ref(db, `users/${user.uid}/following`));
        currentUser.following = followingSnap.val() || {};
      }

      loadProfile();
      loadStatuses();
      hideSpinner();
    });

    // Respect saved theme
    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');
  </script>
</body>
</html>
