<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNkOTQ2ZWYiLCJ0aGVtZV9jb2xvciI6IiNkOTQ2ZWYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#d946ef">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#f0f2f5;
      --card:#ffffff;
      --text:#1c1e21;
      --text2:#65676b;
      --border:#ced0d4;
      --accent:#1877f2;
      --hover-accent:#f0f2f5;
      --card-shadow:0 1px 2px rgba(0,0,0,0.1);
      --radius:8px;
      --gutter:16px;
    }
    [data-theme="dark"]{
      --bg:#18191a;
      --card:#242526;
      --text:#e4e6eb;
      --text2:#b0b3b8;
      --border:#3e4042;
      --hover-accent:#3a3b3c;
      --card-shadow:0 1px 2px rgba(0,0,0,0.2);
    }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:80px}
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    input,textarea{-webkit-user-select:auto;user-select:auto}
    .cover{height:220px;background:var(--accent);background-size:cover;background-position:center}
    .avatar-ring{width:120px;height:120px;border-radius:50%;border:4px solid var(--card);margin:-60px auto 0;background:var(--card);overflow:hidden}
    .avatar-ring img{width:100%;height:100%;object-fit:cover}
    .btn-primary{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-weight:600;font-size:15px;cursor:pointer}
    .btn-secondary{background:var(--hover-accent);color:var(--text);border:none;border-radius:6px;padding:8px 16px;font-weight:600;font-size:15px;cursor:pointer}
    .stat-box{text-align:center;flex:1}
    .stat-val{font-size:18px;font-weight:700}
    .stat-label{font-size:13px;color:var(--text2)}
    .post-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--card-shadow);margin:0 auto 16px;max-width:680px;padding:16px}
    .skeleton-post{background:var(--card);border-radius:var(--radius);box-shadow:var(--card-shadow);margin:0 auto 16px;max-width:680px;padding:16px;animation:shimmer 1.5s infinite;background:linear-gradient(90deg,var(--border) 25%,rgba(0,0,0,.05) 50%,var(--border) 75%);background-size:200% 100%}
    @keyframes shimmer{to{background-position:-200% 0}}
    nav{position:fixed;bottom:0;left:0;right:0;height:56px;background:var(--card);border-top:1px solid var(--border);z-index:40}
    nav a{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:var(--text2)}
    nav a.active{color:var(--accent)}
    .hidden{display:none}
    .text-center{text-align:center}
    .p-4{padding:16px}
    .text-gray{color:var(--text2)}
    .text-xl{font-size:20px;font-weight:600}
  </style>
</head>
<body>
  <!-- === Cover + Avatar + Name Row === -->
  <div class="cover" id="cover" style="background-image:url('https://source.unsplash.com/random/800x220/?abstract')"></div>
  <div class="avatar-ring">
    <img id="profile-avatar" src="https://ui-avatars.com/api/?background=1877f2&color=fff&name=User">
  </div>

  <!-- === Name / Bio / Edit === -->
  <div class="px-4 py-3">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-xl" id="profile-name">User</div>
        <div class="text-gray" id="profile-handle">@handle</div>
      </div>
      <button id="edit-toggle" class="btn-secondary">Edit</button>
    </div>
    <p id="profile-bio" class="mt-2 text-gray"></p>
  </div>

  <!-- === Stats Row === -->
  <div class="flex px-4 pb-3 border-b border-[var(--border)]">
    <div class="stat-box"><div class="stat-val" id="stat-posts">0</div><div class="stat-label">Posts</div></div>
    <div class="stat-box"><div class="stat-val" id="stat-followers">0</div><div class="stat-label">Followers</div></div>
    <div class="stat-box"><div class="stat-val" id="stat-following">0</div><div class="stat-label">Following</div></div>
  </div>

  <!-- === Edit Form (hidden by default) === -->
  <div id="edit-box" class="hidden px-4 py-3 border-b border-[var(--border)]">
    <input id="edit-name" class="w-full mb-2 px-3 py-2 rounded bg-[var(--hover-accent)] text-[var(--text)] placeholder-[var(--text2)]" placeholder="Name">
    <textarea id="edit-bio" class="w-full mb-2 px-3 py-2 rounded bg-[var(--hover-accent)] text-[var(--text)] placeholder-[var(--text2)]" rows="2" placeholder="Bio"></textarea>
    <div class="flex gap-2">
      <button id="save-profile" class="btn-primary">Save</button>
      <button id="cancel-edit" class="btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- === User's Posts === -->
  <main id="posts" class="p-4"></main>
  <div class="text-center p-4">
    <button id="load-more" class="btn-primary hidden">Load More</button>
  </div>

  <!-- === Bottom Nav (copy of feed.html) === -->
  <nav>
    <a href="feed.html"><span class="material-icons">home</span><span>Home</span></a>
    <a href="chat.html"><span class="material-icons-outlined">chat_bubble_outline</span><span>Chat</span></a>
    <a href="search.html"><span class="material-icons-outlined">search</span><span>Search</span></a>
    <a href="ai.html"><span class="material-icons-outlined">auto_awesome</span><span>AI</span></a>
    <a href="notifications.html"><span class="material-icons-outlined">notifications</span><span>Alerts</span></a>
    <a href="profile.html" class="active"><span class="material-icons">person</span><span>Profile</span></a>
  </nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue, set, push, query, orderByChild, limitToLast, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// ---------- Grab target user ----------
const params = new URLSearchParams(location.search);
let targetUid = params.get('uid');
let currentUid = null;
let isOwner = false;
let lastTimestamp = null;
const POSTS_PER_PAGE = 10;

// ---------- Auth ----------
onAuthStateChanged(auth, user => {
  if (!user) {
    signInAnonymously(auth);
  } else {
    currentUid = user.uid;
    if (!targetUid) targetUid = currentUid;
    isOwner = targetUid === currentUid;
    loadProfile();
    loadPosts();
  }
});

// ---------- Load profile data ----------
function loadProfile() {
  onValue(ref(db, `users/${targetUid}/profile`), snap => {
    const p = snap.val() || {};
    $('#profile-name').textContent = p.displayName || 'User';
    $('#profile-handle').textContent = '@' + (p.handle || targetUid.slice(0, 8));
    $('#profile-bio').textContent = p.bio || '';
    $('#profile-avatar').src = p.avatar || `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${p.displayName || 'User'}`;
    if (p.banner) $('#cover').style.backgroundImage = `url(${p.banner})`;
    $('#edit-toggle').classList.toggle('hidden', !isOwner);
  });

  // counts
  onValue(ref(db, `posts`), snap => {
    let c = 0;
    snap.forEach(ch => { if (ch.val().authorId === targetUid) c++; });
    $('#stat-posts').textContent = c;
  });
  onValue(ref(db, `followers/${targetUid}`), s => $('#stat-followers').textContent = s.size);
  onValue(ref(db, `following/${targetUid}`), s => $('#stat-following').textContent = s.size);
}

// ---------- Edit logic ----------
$('#edit-toggle').onclick = () => {
  const name = $('#profile-name').textContent;
  const bio = $('#profile-bio').textContent;
  $('#edit-name').value = name === 'User' ? '' : name;
  $('#edit-bio').value = bio;
  $('#edit-box').classList.remove('hidden');
};
$('#cancel-edit').onclick = () => $('#edit-box').classList.add('hidden');
$('#save-profile').onclick = async () => {
  const name = $('#edit-name').value.trim() || 'User';
  const bio = $('#edit-bio').value.trim();
  await set(ref(db, `users/${currentUid}/profile`), {
    displayName: name,
    bio,
    handle: name.toLowerCase().replace(/\s/g, ''),
    avatar: `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${name}`
  });
  $('#edit-box').classList.add('hidden');
};

// ---------- Posts ----------
async function loadPosts() {
  $('#posts').innerHTML = '<div class="skeleton-post"></div>'.repeat(3);
  const q = query(ref(db, 'posts'), orderByChild('authorId'), limitToLast(POSTS_PER_PAGE));
  const snap = await get(q);
  const rows = [];
  snap.forEach(c => { if (c.val().authorId === targetUid) rows.unshift({key: c.key, ...c.val()}); });
  $('#posts').innerHTML = '';
  rows.forEach(p => $('#posts').appendChild(renderPost(p)));
  lastTimestamp = rows.length ? rows[rows.length - 1].timestamp : null;
  $('#load-more').classList.toggle('hidden', rows.length < POSTS_PER_PAGE);
}

$('#load-more').onclick = async () => {
  $('#load-more').textContent = 'Loading…';
  const q = query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(POSTS_PER_PAGE + 1));
  const snap = await get(q);
  const rows = [];
  snap.forEach(c => { if (c.val().authorId === targetUid && c.val().timestamp < lastTimestamp) rows.unshift({key: c.key, ...c.val()}); });
  rows.pop(); // duplicate
  rows.forEach(p => $('#posts').appendChild(renderPost(p)));
  lastTimestamp = rows.length ? rows[rows.length - 1].timestamp : null;
  $('#load-more').textContent = 'Load More';
  if (!rows.length) $('#load-more').classList.add('hidden');
};

// ---------- Post card (reuse feed.html style) ----------
function renderPost(p) {
  const div = document.createElement('div');
  div.className = 'post-card';
  div.innerHTML = `
    <div class="post-header flex items-center gap-3 mb-2">
      <img class="w-10 h-10 rounded-full object-cover" src="${p.authorAvatar}">
      <div>
        <div class="font-semibold">${p.authorName}</div>
        <div class="text-sm text-gray">${timeAgo(p.timestamp)}</div>
      </div>
    </div>
    <div class="mb-2 whitespace-pre-wrap">${linkify(p.text)}</div>
    ${p.image ? `<img class="w-full rounded" src="${p.image}">` : ''}
  `;
  return div;
}

// ---------- helpers ----------
const esc = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const timeAgo = ts => {
  const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
};
function linkify(str) {
  return str
    .replace(/#(\w+)/g, '<a class="text-[#1877f2]" href="search.html?q=%23$1">#$1</a>')
    .replace(/@(\w+)/g, '<a class="text-[#1877f2]" href="profile.html?handle=$1">@$1</a>')
    .replace(/(https?:\/\/|www\.)([^\s<]+)/gi, m => `<a class="text-[#1877f2]" target="_blank" rel="noopener" href="${m.startsWith('www')?'https://'+m:m}">${m}</a>`);
}
</script>
</body>
</html>
