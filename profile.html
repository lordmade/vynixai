<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Profile • Vynix</title>
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff;
      --text:#161823; --text2:#86878b;
      --border:#e3e3e4; --accent:#ff2a6d;
      --btn-bg:#f1f1f2;
      --shimmer:#e5e7eb;
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000;
      --text:#ffffff; --text2:#71767b;
      --border:#2f3336; --btn-bg:#1a1a1a;
      --shimmer:#111111;
    }
    *{ -webkit-user-select:none !important; user-select:none !important;
       -webkit-touch-callout:none !important; -webkit-tap-highlight-color:transparent !important; }
    input,textarea,button{ -webkit-user-select:auto !important; user-select:text !important; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg); color:var(--text); padding-bottom:85px; overflow-x:hidden;}

    .btn-secondary{background:var(--btn-bg); color:var(--text); font-weight:600; transition:0.2s;}
    .btn-secondary:active{transform:scale(0.98); opacity:0.8;}

    .btn-follow{
      background:var(--accent); color:white; font-weight:700;
      transition:all 0.3s ease; border-radius:9999px;
    }
    .btn-follow.following{
      background:transparent; color:var(--text); border:1px solid var(--border);
    }
    .btn-follow.following:hover{
      background:rgba(255,42,109,0.1); border-color:var(--accent); color:var(--accent);
    }

    ::-webkit-scrollbar{display:none;}

    .toast{position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px);
           background:rgba(0,0,0,0.9); color:#fff; padding:14px 28px; border-radius:9999px;
           font-size:14px; opacity:0; transition:all .4s ease; z-index:999;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
    .spinner{border:3px solid rgba(255,255,255,.3); border-top:3px solid var(--accent); border-radius:50%; width:28px; height:28px; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* ---- shimmer skeleton ---- */
    @keyframes shimmer{
      0%{background-position:200% 0;}
      100%{background-position:-200% 0;}
    }
    .shimmer{
      background:linear-gradient(90deg,var(--shimmer) 25%,#d1d5db 50%,var(--shimmer) 75%);
      background-size:200% 100%;
      animation:shimmer 1.6s infinite;
      border-radius:8px;
    }
    [data-theme="dark"] .shimmer{
      background:linear-gradient(90deg,#111 25%,#222 50%,#111 75%);
    }
    .skeleton-avatar{width:96px;height:96px;border-radius:9999px;margin:0 auto 12px;}
    .skeleton-text{height:20px;margin:6px auto;border-radius:6px;}
    .skeleton-stat{height:28px;width:48px;margin:0 auto 4px;}
    .skeleton-grid{aspect-ratio:3/4;}
  </style>
</head>
<body>

  <!-- ***************  HEADER  *************** -->
  <div class="sticky top-0 z-30 bg-[var(--bg)] border-b border-[var(--border)] h-12 flex items-center justify-between px-4">
    <div class="w-8"></div>
    <div class="font-bold text-lg flex items-center gap-1">
      <span id="navDisplayName" class="shimmer w-32 h-6 inline-block"></span>
      <span class="material-icons text-sm text-[#20D5EC]">verified</span>
    </div>
    <button id="menuBtn" class="w-8 flex justify-end"><span class="material-icons">menu</span></button>
  </div>

  <!-- ***************  SKELETON  *************** -->
  <div id="profileSkeleton" class="pt-6 pb-2 px-4 text-center">
    <div class="skeleton-avatar shimmer"></div>
    <div class="skeleton-text w-40 shimmer"></div>
    <div class="skeleton-text w-56 shimmer mb-6"></div>
    <div class="flex justify-center gap-12 mb-6">
      <div><div class="skeleton-stat shimmer"></div><div class="skeleton-text w-20 mt-2"></div></div>
      <div><div class="skeleton-stat shimmer"></div><div class="skeleton-text w-20 mt-2"></div></div>
      <div><div class="skeleton-stat shimmer"></div><div class="skeleton-text w-20 mt-2"></div></div>
    </div>
    <div class="skeleton-text w-11/12 h-16 mx-auto"></div>
  </div>

  <!-- ***************  REAL PROFILE  *************** -->
  <div id="profileContent" class="hidden pt-6 pb-2 px-4 text-center">
    <div class="relative mx-auto w-24 h-24 mb-3">
      <img id="profileAvatar" class="w-24 h-24 rounded-full object-cover border-2 border-[var(--border)]" src="" alt="avatar">
      <label for="avatarInput" id="avatarChangeBtn" class="absolute bottom-0 right-0 bg-[var(--accent)] text-white w-8 h-8 rounded-full border-4 border-[var(--bg)] flex items-center justify-center cursor-pointer shadow-lg"><span class="material-icons text-base">add</span></label>
      <input type="file" id="avatarInput" accept="image/*" class="hidden">
    </div>

    <h2 id="displayName" class="text-xl font-bold">@username</h2>
    <p id="bio" class="text-sm text-[var(--text2)] mt-2 px-6 leading-relaxed">Loading bio...</p>

    <div class="flex justify-center gap-12 mt-6 mb-4">
      <div class="text-center"><div id="followingCount" class="font-bold text-2xl">0</div><div class="text-xs text-[var(--text2)]">Following</div></div>
      <div class="text-center"><div id="followersCount" class="font-bold text-2xl">0</div><div class="text-xs text-[var(--text2)]">Followers</div></div>
      <div class="text-center"><div class="font-bold text-2xl">0</div><div class="text-xs text-[var(--text2)]">Likes</div></div>
    </div>

    <!-- follow / edit row -->
    <div id="followButtonContainer" class="flex justify-center px-6 mb-6 hidden">
      <button id="followBtn" class="px-8 py-3 rounded-full font-bold text-base btn-follow">Follow</button>
    </div>
    <div id="editButtonContainer" class="flex gap-3 justify-center px-6 mb-6">
      <button id="editBtn" class="flex-1 btn-secondary py-3 rounded-xl font-bold">Edit profile</button>
      <button id="shareBtn" class="w-12 btn-secondary rounded-xl flex items-center justify-center"><span class="material-icons-outlined">share</span></button>
    </div>

    <div class="flex justify-center gap-2 text-sm text-[var(--text2)]">
      <span id="locationWrapper" class="flex items-center gap-1 hidden"><span class="material-icons text-base">location_on</span><span id="location">Earth</span></span>
    </div>
  </div>

  <!-- ***************  TABS  *************** -->
  <div class="sticky top-12 z-20 bg-[var(--bg)] border-t border-b border-[var(--border)] h-11 flex items-center justify-center">
    <div class="text-sm font-bold uppercase tracking-wider text-[var(--text2)] flex items-center gap-2"><span class="material-icons">grid_on</span> Media</div>
  </div>

  <!-- ***************  SKELETON GRID  *************** -->
  <div id="gridSkeleton" class="grid grid-cols-3 gap-0.5">
    <!-- 12 cells looks nicer while waiting -->
    <div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div>
    <div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div>
    <div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div>
    <div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div><div class="skeleton-grid shimmer"></div>
  </div>

  <!-- ***************  REAL GRID  *************** -->
  <div id="postsGrid" class="grid grid-cols-3 gap-0.5 min-h-[300px] hidden"></div>

  <!-- ***************  BOTTOM NAV  *************** -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-[var(--card)] border-t border-[var(--border)] z-40 shadow-lg">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-1">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-1">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-1">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-1">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-1">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">person</span><span class="text-xs mt-1">Profile</span></a>
    </div>
  </nav>

  <!-- ***************  EDIT MODAL  *************** -->
  <div id="editModal" class="hidden fixed inset-0 z-50 bg-[var(--bg)] flex flex-col">
    <div class="flex items-center justify-between px-5 py-4 border-b border-[var(--border)]">
      <button id="closeEdit" class="text-base">Cancel</button>
      <h3 class="font-bold text-lg">Edit profile</h3>
      <button id="saveBtn" class="text-base font-bold text-[var(--accent)]">Save</button>
    </div>
    <div class="flex-1 overflow-y-auto p-6">
      <div class="text-center mb-8"><img id="editPreviewAvatar" class="w-28 h-28 rounded-full object-cover mx-auto border-4 border-[var(--border)]" src=""></div>
      <div class="space-y-6">
        <div><label class="block text-sm font-bold text-[var(--text2)] mb-2">Display Name</label><input id="nameInput" class="w-full px-4 py-3 bg-[var(--btn-bg)] rounded-xl outline-none" placeholder="Your name"></div>
        <div><label class="block text-sm font-bold text-[var(--text2)] mb-2">Bio</label><textarea id="bioInput" class="w-full px-4 py-3 bg-[var(--btn-bg)] rounded-xl outline-none h-32 resize-none" placeholder="Tell us about yourself"></textarea></div>
        <div><label class="block text-sm font-bold text-[var(--text2)] mb-2">Location</label><input id="locationInput" class="w-full px-4 py-3 bg-[var(--btn-bg)] rounded-xl outline-none" placeholder="City, Country"></div>
      </div>
    </div>
  </div>

  <!-- ***************  TOAST & OVERLAY  *************** -->
  <div id="toast" class="toast"></div>
  <div id="overlay" class="overlay hidden"><div class="spinner"></div></div>

  <!-- ***************  FIREBASE & APP  *************** -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, remove, query, orderByChild, equalTo, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const $ = s => document.querySelector(s);

    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches) document.body.setAttribute('data-theme','dark');

    const urlParams = new URLSearchParams(location.search);
    const viewedUid = urlParams.get('uid');
    let currentUid = null;
    let isOwner = false;
    let viewedUserId = null;

    const grid = $('#postsGrid');
    const gridSkeleton = $('#gridSkeleton');
    const profileSkeleton = $('#profileSkeleton');
    const profileContent = $('#profileContent');
    const CLOUD_NAME = "dqkujefxj";
    const UPLOAD_PRESET = "banter_box";

    /* ----------  shimmer → real switch  ---------- */
    function showRealContent(){
      profileSkeleton.classList.add('hidden');
      profileContent.classList.remove('hidden');
      gridSkeleton.classList.add('hidden');
      grid.classList.remove('hidden');
    }

    /* ----------  add media cell  ---------- */
    function addCell(url,isVideo){
      const div=document.createElement('div');
      div.className='relative aspect-[3/4] bg-black overflow-hidden';
      if(isVideo){
        div.innerHTML=`
          <video class="w-full h-full object-cover" src="${url}" muted loop playsinline autoplay preload="metadata"></video>
          <div class="video-play-overlay absolute inset-0 flex items-center justify-center pointer-events-none opacity-100">
            <span class="material-icons text-white text-6xl drop-shadow-2xl">play_circle</span>
          </div>`;
        const video=div.querySelector('video'), overlay=div.querySelector('.video-play-overlay');
        video.onplay=()=>overlay.style.opacity='0';
        div.onclick=e=>{e.stopPropagation();if(video.paused)video.play();openVideoModal(url);};
      }else{
        div.innerHTML=`<img src="${url}" class="w-full h-full object-cover" loading="lazy">`;
        div.onclick=()=>openImageModal(url);
      }
      grid.appendChild(div);
    }

    /* ----------  follow / unfollow  ---------- */
    async function toggleFollow(){
      if(isOwner||!viewedUserId)return;
      const followRef=ref(db,`social/${currentUid}/following/${viewedUserId}`);
      const followerRef=ref(db,`social/${viewedUserId}/followers/${currentUid}`);
      const snap=await get(followRef);
      if(snap.exists()){
        await remove(followRef); await remove(followerRef);
        $('#followBtn').textContent='Follow'; $('#followBtn').classList.remove('following');
      }else{
        await set(followRef,true); await set(followerRef,true);
        $('#followBtn').textContent='Following'; $('#followBtn').classList.add('following');
      }
    }

    /* ----------  auth state  ---------- */
    onAuthStateChanged(auth,user=>{
      if(!user){location.href='login.html';return;}
      currentUid=user.uid;
      viewedUserId=viewedUid||currentUid;
      isOwner=!viewedUid||viewedUid===currentUid;

      $('#followButtonContainer').classList.toggle('hidden',isOwner);
      $('#editButtonContainer').classList.toggle('hidden',!isOwner);
      $('#avatarChangeBtn').style.display=isOwner?'flex':'none';

      let loads=0, total=4;
      const done=()=>{if(++loads===total)showRealContent();};

      loadProfile(viewedUserId,done);
      loadCounts(viewedUserId,done);
      loadMedia(viewedUserId,done);
      loadFollowStatus(done);
    });

    /* ----------  loaders  ---------- */
    function loadProfile(uid,cb){
      const user=auth.currentUser;
      const name=user.displayName||'User';
      $('#displayName').textContent='@'+name.replace(/\s/g,'').toLowerCase();
      $('#navDisplayName').textContent=name;
      $('#profileAvatar').src=user.photoURL||`https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${encodeURIComponent(name)}`;
      $('#editPreviewAvatar').src=$('#profileAvatar').src;

      onValue(ref(db,`users/${uid}/profile`),snap=>{
        const p=snap.val()||{};
        if(p.displayName){
          const clean=p.displayName.trim();
          $('#displayName').textContent='@'+clean.replace(/\s/g,'').toLowerCase();
          $('#navDisplayName').textContent=clean;
        }
        $('#bio').textContent=p.bio||'No bio yet.';
        $('#location').textContent=p.location||'Earth';
        $('#locationWrapper').classList.toggle('hidden',!p.location);
      },{onlyOnce:true});
      cb();
    }
    function loadCounts(uid,cb){
      let c1=false,c2=false; const check=()=>{if(c1&&c2)cb();};
      onValue(ref(db,`social/${uid}/following`),s=>{$('#followingCount').textContent=s.size||0;c1=true;check();});
      onValue(ref(db,`social/${uid}/followers`),s=>{$('#followersCount').textContent=s.size||0;c2=true;check();});
    }
    function loadMedia(uid,cb){
      const q=query(ref(db,'posts'),orderByChild('authorId'),equalTo(uid));
      onValue(q,snap=>{
        grid.innerHTML='';
        const items=[];
        snap.forEach(c=>{
          const p=c.val();
          if(p.image)items.push({url:p.image,isVideo:p.image.includes('/video/upload')||p.image.endsWith('.mp4')});
        });
        if(!items.length)grid.innerHTML='<div class="col-span-3 text-center py-20 text-[var(--text2)]">No posts yet</div>';
        else{items.reverse(); items.forEach(i=>addCell(i.url,i.isVideo));}
        cb();
      });
    }
    function loadFollowStatus(cb){
      if(isOwner){cb();return;}
      const followRef=ref(db,`social/${currentUid}/following/${viewedUserId}`);
      onValue(followRef,snap=>{
        const following=snap.exists();
        const btn=$('#followBtn');
        btn.textContent=following?'Following':'Follow';
        btn.classList.toggle('following',following);
      },{onlyOnce:true});
      cb();
    }

    /* ----------  UI bindings  ---------- */
    $('#menuBtn').onclick=()=>$('#menuDrawer').classList.remove('hidden');
    $('#closeMenu').onclick=$('#menuBackdrop').onclick=()=>$('#menuDrawer').classList.add('hidden');
    $('#logoutBtn').onclick=async()=>{await signOut(auth);location.href='login.html';};
    $('#followBtn')?.addEventListener('click',toggleFollow);
    $('#editBtn').onclick=()=>{
      $('#nameInput').value=auth.currentUser.displayName||'';
      $('#bioInput').value=$('#bio').textContent==='No bio yet.'?'':$('#bio').textContent;
      $('#locationInput').value=$('#location').textContent==='Earth'?'':$('#location').textContent;
      $('#editModal').classList.remove('hidden');
    };
    $('#closeEdit').onclick=()=>$('#editModal').classList.add('hidden');
    $('#saveBtn').onclick=async()=>{
      if(!isOwner)return;
      $('#overlay').classList.remove('hidden');
      const name=$('#nameInput').value.trim(),bio=$('#bioInput').value.trim(),loc=$('#locationInput').value.trim();
      if(name&&name!==auth.currentUser.displayName)await updateProfile(auth.currentUser,{displayName:name});
      await set(ref(db,`users/${currentUid}/profile`),{displayName:name||null,bio:bio||null,location:loc||null});
      toast('Profile updated!');
      $('#overlay').classList.add('hidden');
      $('#editModal').classList.add('hidden');
    };
    $('#avatarInput').onchange=async(e)=>{
      if(!isOwner)return;
      const file=e.target.files[0];if(!file)return;
      $('#overlay').classList.remove('hidden');
      const fd=new FormData();fd.append('file',file);fd.append('upload_preset',UPLOAD_PRESET);
      try{
        const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:'POST',body:fd});
        const d=await r.json();
        await updateProfile(auth.currentUser,{photoURL:d.secure_url});
        $('#profileAvatar').src=d.secure_url;$('#editPreviewAvatar').src=d.secure_url;
        toast('Avatar updated');
      }catch{toast('Upload failed');}
      $('#overlay').classList.add('hidden');
    };
    function toast(msg){
      const t=$('#toast');t.textContent=msg;t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),3000);
    }
    window.openImageModal=src=>{
      const div=document.createElement('div');div.className='fixed inset-0 z-[200] bg-black/95 flex items-center justify-center';
      div.innerHTML=`<img src="${src}" class="max-w-[95%] max-h-[95%] object-contain rounded-xl">`;
      div.onclick=()=>div.remove();document.body.appendChild(div);
    };
    window.openVideoModal=src=>{
      const div=document.createElement('div');div.className='fixed inset-0 z-[200] bg-black/95 flex items-center justify-center';
      div.innerHTML=`<video src="${src}" controls autoplay class="max-w-[95%] max-h-[95%] rounded-xl"></video><button class="absolute top-4 right-4 text-white text-5xl">&times;</button>`;
      div.onclick=e=>{if(e.target.tagName!=='VIDEO')div.remove();};document.body.appendChild(div);
    };
  </script>
</body>
</html>
