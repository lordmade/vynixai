<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Profile • Vynix</title>
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Symbols+Rounded" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff;
      --text:#161823; --text2:#86878b;
      --border:#e3e3e4; --accent:#ff2a6d;
      --btn-bg:#f1f1f2;
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000;
      --text:#ffffff; --text2:#71767b;
      --border:#2f3336; --btn-bg:#2f2f2f;
    }
    *{ -webkit-user-select:none !important; user-select:none !important;
       -webkit-touch-callout:none !important; -webkit-tap-highlight-color:transparent !important; }
    input,textarea,button{ -webkit-user-select:auto !important; user-select:text !important; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg); color:var(--text); padding-bottom:85px;}
    .btn-secondary{background:var(--btn-bg); color:var(--text); font-weight:600; transition:0.2s;}
    .btn-secondary:active{transform:scale(0.98); opacity:0.8;}
    ::-webkit-scrollbar{display:none;}
    .toast{position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px);
           background:rgba(0,0,0,0.8); color:#fff; padding:12px 24px; border-radius:999px;
           font-size:14px; opacity:0; transition:all .4s ease; z-index:99;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
    .spinner{border:3px solid rgba(255,255,255,.3); border-top:3px solid var(--accent); border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .video-play-overlay{
      background:rgba(0,0,0,0.25);
      transition:opacity 0.4s ease;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="sticky top-0 z-30 bg-[var(--bg)] border-b border-[var(--border)] h-12 flex items-center justify-between px-4">
    <div class="w-8"></div>
    <div class="font-bold text-lg flex items-center gap-1">
      <span id="navDisplayName">Loading...</span>
      <span class="material-icons text-sm text-[#20D5EC]">verified</span>
    </div>
    <button id="menuBtn" class="w-8 flex justify-end"><span class="material-icons">menu</span></button>
  </div>

  <!-- Menu Drawer -->
  <div id="menuDrawer" class="fixed inset-0 z-50 hidden">
    <div id="menuBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--card)] rounded-t-2xl p-4 flex flex-col gap-2 pb-8">
      <h3 class="text-center font-bold mb-2 text-[var(--text2)]">Settings</h3>
      <button id="logoutBtn" class="w-full py-3.5 rounded-lg bg-[var(--btn-bg)] font-semibold text-red-500">Log out</button>
      <button id="closeMenu" class="w-full py-3.5 rounded-lg bg-[var(--btn-bg)] font-semibold">Cancel</button>
    </div>
  </div>

  <!-- Profile Info -->
  <div class="pt-6 pb-2 px-4 text-center">
    <div class="relative mx-auto w-24 h-24 mb-3">
      <img id="profileAvatar" class="w-24 h-24 rounded-full object-cover border border-[var(--border)]" src="" alt="avatar">
      <!-- Avatar change button - hidden for non-owners -->
      <label for="avatarInput" id="avatarChangeBtn" class="absolute bottom-0 right-0 bg-[var(--accent)] text-white w-7 h-7 flex items-center justify-center rounded-full border-2 border-[var(--bg)] cursor-pointer shadow-sm">
        <span class="material-icons text-sm">add</span>
      </label>
      <input type="file" id="avatarInput" accept="image/*" class="hidden">
    </div>

    <h2 id="displayName" class="text-lg font-bold leading-tight">@username</h2>
    <p id="userHandle" class="text-sm text-[var(--text2)] mt-1">Short bio or status</p>

    <div class="flex justify-center items-center gap-8 mt-5 mb-5">
      <div class="flex flex-col items-center"><span id="followingCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Following</span></div>
      <div class="flex flex-col items-center"><span id="followersCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Followers</span></div>
      <div class="flex flex-col items-center"><span class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Likes</span></div>
    </div>

    <div class="flex gap-2 justify-center px-4 mb-4">
      <button id="editBtn" class="flex-1 btn-secondary py-2.5 rounded text-sm">Edit profile</button>
      <button id="shareBtn" class="w-10 btn-secondary flex items-center justify-center rounded"><span class="material-icons-outlined text-xl">share</span></button>
    </div>

    <p id="bio" class="text-sm px-4 mb-4 whitespace-pre-wrap text-center leading-relaxed"></p>

    <div class="flex items-center justify-center gap-4 text-xs text-[var(--text2)] mb-4">
      <span class="flex items-center gap-1 hidden" id="locationWrapper"><span class="material-icons text-sm">location_on</span> <span id="location">Earth</span></span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="sticky top-12 z-20 bg-[var(--bg)] border-t border-b border-[var(--border)] h-10 flex items-center justify-center">
    <span class="text-xs font-bold uppercase tracking-widest text-[var(--text2)] flex items-center gap-2">
      <span class="material-icons text-base">grid_on</span> Media
    </span>
  </div>

  <!-- Media Grid -->
  <div id="postsGrid" class="grid grid-cols-3 gap-0.5 min-h-[300px]"></div>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-[var(--border)] z-40">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 z-50 bg-[var(--bg)] flex flex-col">
    <div class="flex items-center justify-between px-4 py-3 border-b border-[var(--border)]">
      <button id="closeEdit" class="text-sm font-medium">Cancel</button>
      <h3 class="font-bold text-base">Edit profile</h3>
      <button id="saveBtn" class="text-sm font-bold text-[var(--accent)]">Save</button>
    </div>
    <div class="p-6 flex flex-col items-center gap-6 overflow-y-auto">
      <div class="flex flex-col items-center gap-2">
        <img id="editPreviewAvatar" class="w-24 h-24 rounded-full object-cover opacity-60" src="">
        <span class="text-sm font-medium">Change photo</span>
      </div>
      <div class="w-full space-y-4">
        <div><label class="text-xs font-bold text-[var(--text2)] ml-1">Name</label>
          <input id="nameInput" class="w-full bg-transparent border-b border-[var(--border)] py-2 px-1 outline-none font-medium" placeholder="Name">
        </div>
        <div><label class="text-xs font-bold text-[var(--text2)] ml-1">Bio</label>
          <textarea id="bioInput" class="w-full bg-transparent border-b border-[var(--border)] py-2 px-1 outline-none h-20 resize-none font-medium" placeholder="About you"></textarea>
        </div>
        <div><label class="text-xs font-bold text-[var(--text2)] ml-1">Location</label>
          <input id="locationInput" class="w-full bg-transparent border-b border-[var(--border)] py-2 px-1 outline-none font-medium" placeholder="City, Country">
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="overlay" class="overlay hidden"><div class="spinner"></div></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey:"AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain:"fire-b-a8878.firebaseapp.com",
      databaseURL:"https://fire-b-a8878.firebaseio.com",
      projectId:"fire-b-a8878",
      storageBucket:"fire-b-a8878.firebasestorage.app",
      messagingSenderId:"658673187627",
      appId:"1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const $ = s => document.querySelector(s);

    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches) document.body.setAttribute('data-theme','dark');

    const urlParams = new URLSearchParams(location.search);
    const viewedUid = urlParams.get('uid'); // if present → viewing someone else

    let currentUid = null;
    let isOwner = false;

    const grid = $('#postsGrid');
    const CLOUD_NAME = "dqkujefxj";
    const UPLOAD_PRESET = "banter_box";

    function emptyState(){
      grid.innerHTML = `<div class="col-span-3 text-center text-sm text-[var(--text2)] py-12">No posts yet</div>`;
    }

    function addCell(url, isVideo) {
      const div = document.createElement('div');
      div.className = 'relative aspect-[3/4] bg-black overflow-hidden';

      if (isVideo) {
        div.innerHTML = `
          <video class="w-full h-full object-cover" src="${url}" muted loop playsinline autoplay preload="metadata"></video>
          <div class="video-play-overlay absolute inset-0 flex items-center justify-center pointer-events-none opacity-100">
            <span class="material-icons text-white text-5xl drop-shadow-2xl">play_circle</span>
          </div>
        `;
        const video = div.querySelector('video');
        const overlay = div.querySelector('.video-play-overlay');
        video.onplay = () => overlay.style.opacity = '0';
        div.onclick = (e) => { e.stopPropagation(); if(video.paused) video.play(); openVideoModal(url); };
      } else {
        div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" loading="lazy">`;
        div.onclick = () => openImageModal(url);
      }
      grid.appendChild(div);
    }

    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }

      currentUid = user.uid;
      isOwner = !viewedUid || viewedUid === currentUid;

      // Hide edit controls if not owner
      $('#editBtn').style.display = isOwner ? 'block' : 'none';
      $('#shareBtn').style.display = isOwner ? 'flex' : 'none';
      $('#avatarChangeBtn').style.display = isOwner ? 'flex' : 'none';

      loadProfile(viewedUid || currentUid);
      loadCounts(viewedUid || currentUid);
      loadMedia(viewedUid || currentUid);
    });

    function loadProfile(uidToLoad) {
      // Get display name from Auth first
      const authUser = auth.currentUser;
      const displayName = authUser?.displayName || 'User';

      $('#displayName').textContent = '@' + (displayName || 'user').replace(/\s/g,'').toLowerCase();
      $('#navDisplayName').textContent = displayName || 'User';
      $('#profileAvatar').src = authUser?.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${displayName}`;
      $('#editPreviewAvatar').src = $('#profileAvatar').src;

      // Then override with custom profile data from DB
      onValue(ref(db, `users/${uidToLoad}/profile`), s => {
        const p = s.val() || {};
        $('#displayName').textContent = '@' + (p.displayName || displayName || 'user').replace(/\s/g,'').toLowerCase();
        $('#navDisplayName').textContent = p.displayName || displayName || 'User';
        $('#bio').textContent = p.bio || 'No bio yet.';
        $('#location').textContent = p.location || 'Unknown';
        $('#locationWrapper').classList.toggle('hidden', !p.location);
      });
    }

    function loadCounts(uidToLoad) {
      onValue(ref(db, `social/${uidToLoad}/following`), s => $('#followingCount').textContent = s.size || 0);
      onValue(ref(db, `social/${uidToLoad}/followers`), s => $('#followersCount').textContent = s.size || 0);
    }

    function loadMedia(uidToLoad) {
      const q = query(ref(db,'posts'), orderByChild('authorId'), equalTo(uidToLoad));
      onValue(q, snap => {
        grid.innerHTML = '';
        const items = [];
        snap.forEach(child => {
          const p = child.val();
          if (p.image) items.push({url: p.image, isVideo: p.image.includes('/video/upload') || p.image.endsWith('.mp4')});
        });
        if (!items.length) { emptyState(); return; }
        items.reverse(); // newest first
        items.forEach(i => addCell(i.url, i.isVideo));
      });
    }

    // Menu
    $('#menuBtn').onclick = () => $('#menuDrawer').classList.remove('hidden');
    $('#closeMenu').onclick = $('#menuBackdrop').onclick = () => $('#menuDrawer').classList.add('hidden');

    // Logout
    $('#logoutBtn').onclick = async () => { await signOut(auth); location.href = 'login.html'; };

    // Edit Modal (only owner)
    $('#editBtn').onclick = () => {
      $('#nameInput').value = auth.currentUser.displayName || '';
      $('#bioInput').value = $('#bio').textContent === 'No bio yet.' ? '' : $('#bio').textContent;
      $('#locationInput').value = $('#location').textContent === 'Unknown' ? '' : $('#location').textContent;
      $('#editModal').classList.remove('hidden');
    };
    $('#closeEdit').onclick = () => $('#editModal').classList.add('hidden');

    $('#saveBtn').onclick = async () => {
      if (!isOwner) return;
      $('#overlay').classList.remove('hidden');
      const name = $('#nameInput').value.trim();
      const bio = $('#bioInput').value.trim();
      const loc = $('#locationInput').value.trim();

      if (name && name !== auth.currentUser.displayName) await updateProfile(auth.currentUser, {displayName: name});
      await set(ref(db, `users/${currentUid}/profile`), {displayName: name || null, bio: bio || null, location: loc || null});

      toast('Saved!');
      $('#overlay').classList.add('hidden');
      $('#editModal').classList.add('hidden');
    };

    // Avatar Upload (only owner)
    $('#avatarInput').addEventListener('change', async e => {
      if (!isOwner) return;
      const file = e.target.files[0]; if (!file) return;
      $('#overlay').classList.remove('hidden');
      const fd = new FormData();
      fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:'POST', body:fd});
        const data = await res.json();
        await updateProfile(auth.currentUser, {photoURL: data.secure_url});
        $('#profileAvatar').src = data.secure_url;
        $('#editPreviewAvatar').src = data.secure_url;
        toast('Avatar updated');
      } catch { toast('Upload failed'); }
      $('#overlay').classList.add('hidden');
    });

    function toast(msg){
      $('#toast').textContent = msg;
      $('#toast').classList.add('show');
      setTimeout(()=>$('#toast').classList.remove('show'), 2500);
    }

    // Lightbox
    window.openImageModal = src => {
      const wrap = document.createElement('div');
      wrap.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center';
      wrap.innerHTML = `<img src="${src}" class="max-w-[95%] max-h-[95%] object-contain rounded-lg">`;
      wrap.onclick = () => wrap.remove();
      document.body.appendChild(wrap);
    };
    window.openVideoModal = src => {
      const wrap = document.createElement('div');
      wrap.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center';
      wrap.innerHTML = `<video src="${src}" controls autoplay class="max-w-[95%] max-h-[95%] object-contain rounded-lg"></video><span class="absolute top-4 right-4 text-white text-4xl cursor-pointer">&times;</span>`;
      wrap.onclick = e => { if(e.target.tagName!=='VIDEO') wrap.remove(); };
      document.body.appendChild(wrap);
    };
  </script>
</body>
</html>
