<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Profile • Vynix</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#ff2a6d;--bg:#ffffff;--text:#0f1419;--text2:#536471;--border:#eff3f4}
    [data-theme="dark"]{--bg:#000000;--text:#e7e9ea;--text2:#71767b;--border:#2f3336}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);padding-bottom:80px;-webkit-user-select:none;user-select:none}
    input,textarea,button{-webkit-user-select:text!important;user-select:text!important}

    /* ----- profile header (same gradient as your edit page) ----- */
    .prof-header{background:linear-gradient(135deg,var(--accent),#05d9e8);padding:32px 16px 48px;text-align:center;position:relative}
    .prof-avatar{width:96px;height:96px;border-radius:50%;object-fit:cover;border:4px solid #fff;box-shadow:0 8px 32px rgba(0,0,0,.2);margin:0 auto 12px}
    .prof-name{font-size:24px;font-weight:800;color:#fff}
    .prof-bio{font-size:15px;color:#fff;margin-top:4px}
    .prof-location{font-size:14px;color:#fff;margin-top:4px;opacity:.9}
    .prof-stats{display:flex;justify-content:space-around;padding:12px 0;margin-top:16px}
    .stat{text-align:center}
    .stat-val{font-size:20px;font-weight:700;color:#fff}
    .stat-lab{font-size:12px;color:#fff;opacity:.9}

    /* ----- action row ----- */
    .prof-actions{display:flex;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border)}
    .btn-flex{flex:1;padding:10px;border-radius:999px;font-weight:600;font-size:14px;border:none;cursor:pointer;transition:.2s}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:var(--border);color:var(--text)}

    /* ----- posts (identical cards to feed) ----- */
    .feed{padding-bottom:40px}
    .post-card{border-bottom:1px solid var(--border);padding:16px;cursor:pointer;transition:background .2s}
    .post-card:hover{background:rgba(0,0,0,.03)}
    [data-theme="dark"] .post-card:hover{background:rgba(255,255,255,.03)}
    .post-header{display:flex;gap:12px;align-items:flex-start}
    .post-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .user-meta{display:flex;gap:4px;align-items:center;font-size:15px}
    .name{font-weight:700;color:var(--text)}
    .verified-badge{color:#1d9bf0;font-size:16px!important;margin-left:2px}
    .handle,.time{color:var(--text2);font-weight:400}
    .post-content{margin-top:4px;font-size:15px;line-height:1.5;white-space:pre-wrap;margin-left:52px}
    .post-image{border-radius:16px;margin-top:12px;max-width:100%;border:1px solid var(--border)}
    .post-actions{display:flex;justify-content:space-between;margin-top:12px;margin-left:52px;max-width:400px;color:var(--text2)}
    .action-item{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;transition:.2s}
    .action-item .material-icons-outlined{font-size:18px;padding:8px;border-radius:50%;transition:.2s}
    .action-item:hover.reply{color:#1d9bf0}
    .action-item:hover.repost{color:#00ba7c}
    .action-item:hover.like{color:#f91880}
    .action-item:hover svg{transform:scale(1.1)}
    .post-actions svg{width:24px;height:24px}
    .post-actions .filled-heart{display:none}
    .post-actions .like.liked .outline-heart{display:none}
    .post-actions .like.liked .filled-heart{display:block}

    /* ----- bottom nav ----- */
    nav{position:fixed;bottom:0;left:0;right:0;height:64px;background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-around;z-index:40}
    nav a{flex:1;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:var(--text2)}
    nav a.active{color:var(--accent)}
    nav a span{font-size:24px;margin-bottom:2px}
  </style>
</head>
<body>

<!-- ---------- PWA banner (same as feed) ---------- -->
<div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#ff2a6d] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
  <div class="font-semibold text-sm">Install Vynix for a better experience</div>
  <div class="flex items-center gap-3">
    <button id="pwa-install-btn" class="bg-white text-[#ff2a6d] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
    <button id="pwa-install-close" class="text-white/80 hover:text-white"><span class="material-icons text-xl">close</span></button>
  </div>
</div>

<!-- ---------- PROFILE HEADER (same gradient card) ---------- -->
<div class="prof-header">
  <img id="prof-avatar" class="prof-avatar" src="" alt="avatar">
  <div class="prof-name" id="prof-name">Loading…</div>
  <div class="prof-bio" id="prof-bio"></div>
  <div class="prof-location" id="prof-location"></div>
  <div class="prof-stats">
    <div class="stat"><div class="stat-val" id="stat-posts">0</div><div class="stat-lab">Posts</div></div>
    <div class="stat"><div class="stat-val" id="stat-followers">0</div><div class="stat-lab">Followers</div></div>
    <div class="stat"><div class="stat-val" id="stat-following">0</div><div class="stat-lab">Following</div></div>
  </div>
</div>

<!-- ---------- ACTION ROW ---------- -->
<div class="prof-actions">
  <button class="btn-flex btn-secondary" onclick="location.href='edit-profile.html'">Edit Profile</button>
  <button class="btn-flex btn-primary" id="share-btn">Share Profile</button>
</div>

<!-- ---------- OWNER’S POSTS (identical cards to feed) ---------- -->
<main id="feed" class="feed"></main>
<div class="text-center p-4"><button id="load-more-btn" class="post-btn hidden">Load More Posts</button></div>

<!-- ---------- BOTTOM NAV ---------- -->
<nav>
  <a href="index.html"><span class="material-icons-outlined">home</span><span>Home</span></a>
  <a href="chat.html"><span class="material-icons-outlined">chat_bubble_outline</span><span>Chat</span></a>
  <a href="search.html"><span class="material-icons-outlined">search</span><span>Search</span></a>
  <a href="ai.html"><span class="material-icons-outlined">auto_awesome</span><span>AI</span></a>
  <a href="notifications.html"><span class="material-icons-outlined">notifications</span><span>Alerts</span></a>
  <a href="profile.html" class="active"><span class="material-icons">person</span><span>Profile</span></a>
</nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue, get, query, orderByChild, limitToLast, endAt, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let myUid, myName, myAvatar, lastTimestamp = null, lastKey = null, initialLoadDone = false;
const POST_LIMIT = 18;

/* ---------- theme ---------- */
if (matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');

/* ---------- auth ---------- */
onAuthStateChanged(auth, user => {
  if (!user) { location.href = 'index.html'; return; }
  myUid = user.uid;
  myName = user.displayName || 'User';
  myAvatar = user.photoURL || `https://ui-avatars.com/api/?name=${myName}&background=ff2a6d&color=fff`;
  initProfile();
  initMyPosts();
});

/* ---------- profile header ---------- */
function initProfile() {
  const profRef = ref(db, `users/${myUid}/profile`);
  onValue(profRef, snap => {
    const p = snap.val() || {};
    $('#prof-avatar').src = myAvatar;
    $('#prof-name').textContent = myName;
    $('#prof-bio').textContent = p.bio || '';
    $('#prof-location').textContent = p.location || '';
  });

  /* stats */
  onValue(ref(db, `posts`), snap => {
    let posts = 0;
    snap.forEach(c => { if (c.val().authorId === myUid) posts++; });
    $('#stat-posts').textContent = posts;
  });
  onValue(ref(db, `followers/${myUid}`), s => $('#stat-followers').textContent = s.size);
  onValue(ref(db, `following/${myUid}`), s => $('#stat-following').textContent = s.size);
}

/* ---------- my posts (identical cards) ---------- */
async function initMyPosts() {
  const q = query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(POST_LIMIT));
  const snap = await get(q);
  const rows = [];
  snap.forEach(c => { if (c.val().authorId === myUid) rows.unshift({key: c.key, ...c.val()}); });
  rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
  const last = rows[rows.length - 1];
  if (last) { lastTimestamp = last.timestamp; lastKey = last.key; }
  $('#load-more-btn').classList.toggle('hidden', rows.length < POST_LIMIT);
  initialLoadDone = true;
}

/* ---------- load more ---------- */
$('#load-more-btn').onclick = async () => {
  $('#load-more-btn').disabled = true;
  const q = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT + 1));
  const snap = await get(q);
  const rows = []; snap.forEach(c => rows.push({key: c.key, ...c.val()}));
  const mine = rows.filter(p => p.authorId === myUid && p.key !== lastKey);
  if (!mine.length) { $('#load-more-btn').classList.add('hidden'); return; }
  mine.reverse(); mine.forEach(p => feedEl.appendChild(renderPostCard(p)));
  lastTimestamp = mine[mine.length - 1].timestamp;
  lastKey = mine[mine.length - 1].key;
  $('#load-more-btn').disabled = false;
};

/* ---------- card renderer (same as feed) ---------- */
function renderPostCard(p) {
  const isMine = p.authorId === myUid;
  const div = document.createElement('div');
  div.id = `post-${p.key}`;
  div.className = 'post-card';
  div.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar}" class="post-avatar">
      <div class="flex-1">
        <div class="user-meta">
          <span class="name">${esc(p.authorName)}</span>
          ${p.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}
          <span class="handle">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
        </div>
        <div class="post-content">${esc(p.text)}</div>
        ${mediaMarkup(p.image)}
        <div class="post-actions">
          <div class="action-item reply" data-post="${p.key}" data-action="reply">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            <span id="replies-${p.key}">${p.replies||0}</span>
          </div>
          <div class="action-item repost" data-post="${p.key}" data-action="repost">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2l4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
            <span id="reposts-${p.key}">${p.reposts||0}</span>
          </div>
          <div class="action-item like" data-post="${p.key}" data-action="like">
            <svg class="outline-heart" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <svg class="filled-heart hidden" width="24" height="24" viewBox="0 0 24 24" fill="#f91880" stroke="#f91880" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <span id="likes-${p.key}">${p.likes||0}</span>
          </div>
          <div class="action-item share" data-post="${p.key}" data-action="share">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </div>
          ${isMine ? `<div class="action-item delete-btn" data-post="${p.key}" data-action="delete">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
          </div>` : ''}
        </div>
      </div>
    </div>`;
  div.addEventListener('click', e => {
    const action = e.target.closest('[data-action]')?.dataset.action;
    const postId = e.target.closest('[data-post]')?.dataset.post;
    if (!action || !postId) return;
    e.stopPropagation();
    if (action === 'reply')   openComments(postId);
    if (action === 'repost')  doRepost(postId);
    if (action === 'like')    toggleLike(postId);
    if (action === 'share')   navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
    if (action === 'delete')  confirmDelete(postId);
  });
  listenCounters(p.key);
  return div;
}

/* ---------- media / counters / actions (same as feed) ---------- */
function mediaMarkup(url) {
  if (!url) return '';
  const isVideo = url.includes('/video/upload') || url.endsWith('.mp4');
  if (isVideo) {
    return `<video class="post-image" controls muted loop playsinline onloadedmetadata="this.style.height=this.videoHeight/this.videoWidth*this.parentElement.offsetWidth+'px'"><source src="${url}" type="video/mp4"></video>`;
  }
  return `<img class="post-image cursor-pointer hover:opacity-90 transition" src="${url}" loading="lazy" onclick="openImageModal('${url}')">`;
}
function listenCounters(postId) {
  onValue(ref(db, `likes/${postId}`),   s => { $('#likes-'+postId).textContent = s.size; const ic = document.querySelector(`[data-post="${postId}"].like`); if(ic) ic.classList.toggle('liked', s.hasChild(myUid)); });
  onValue(ref(db, `comments/${postId}`),s => $('#replies-'+postId).textContent = s.size);
  onValue(ref(db, `reposts/${postId}`), s => $('#reposts-'+postId).textContent = s.size);
}
async function toggleLike(postId) {
  const likeRef = ref(db, `likes/${postId}/${myUid}`);
  const snap = await get(likeRef);
  if (snap.exists()) await remove(likeRef); else await set(likeRef, true);
}
async function doRepost(postId) {
  const orig = (await get(ref(db, `posts/${postId}`))).val();
  if (!orig) return;
  const newRef = push(ref(db, 'posts'));
  await set(newRef, { authorId: myUid, authorName: myName, authorAvatar: myAvatar, text: orig.text, image: orig.image, verified: false, repostOf: {authorName: orig.authorName, key: postId}, likes: 0, replies: 0, reposts: 0, timestamp: serverTimestamp() });
  toast('Re-posted');
}
function openComments(postId) { /* same as feed */ }
function confirmDelete(key) { /* same as feed */ }
function toast(msg) {
  const t = document.createElement('div');
  t.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-[#ff2a6d] text-white px-4 py-2 rounded-full text-sm shadow-lg z-50';
  t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
}
function esc(s) { return s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }
function timeAgo(ts) { if (!ts) return 'now'; const s = Math.floor((Date.now() - ts) / 1000); return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`; }
function openImageModal(src) { /* same as feed */ }

/* ---------- pwa banner (same as feed) ---------- -->
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; document.getElementById('pwa-install-banner').classList.remove('-translate-y-full'); });
document.getElementById('pwa-install-btn')?.addEventListener('click', async () => {
  if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; document.getElementById('pwa-install-banner').classList.add('-translate-y-full');
});
document.getElementById('pwa-install-close')?.addEventListener('click', () => { document.getElementById('pwa-install-banner').classList.add('-translate-y-full'); });
</script>

</body>
</html>
