<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Vynix - Profile</title>

  <!-- PWA & Security -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src * data:; media-src *;">
  <meta name="theme-color" content="#ff2a6d">
  <link rel="manifest" href="/manifest.json">

  <!-- Critical CSS -->
  <style>
    /* Modern CSS Reset & Variables */
    :root {
      --bg: #ffffff;
      --surface: #f7f9fa;
      --primary: #ff2a6d;
      --primary-glow: 0 0 20px rgba(255, 42, 109, 0.4);
      --text: #0f1419;
      --text-muted: #536471;
      --border: #e1e8ed;
      --radius: 16px;
      --transition: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000;
        --surface: #16181c;
        --text: #ffffff;
        --text-muted: #71767b;
        --border: #2f3336;
      }
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; -webkit-font-smoothing: antialiased; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
      overflow-x: hidden;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    /* Layout */
    .app { min-height: 100vh; display: flex; flex-direction: column; }
    .header {
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(20px); background: var(--bg);
      border-bottom: 1px solid var(--border); padding: 12px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .header h1 { flex: 1; font-weight: 800; font-size: 18px; }
    .header-btn {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--border);
      display: grid; place-items: center; cursor: pointer;
      transition: all 0.2s var(--transition);
    }
    .header-btn:active { transform: scale(0.95); }

    .main { flex: 1; padding-bottom: env(safe-area-inset-bottom); }

    /* Profile Card */
    .profile-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); margin: 12px;
      overflow: hidden; animation: slideUp 0.4s var(--transition);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cover-container { position: relative; height: 180px; }
    .cover-img {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform 0.3s var(--transition);
    }
    .avatar-container {
      position: absolute; bottom: -40px; left: 16px;
      width: 80px; height: 80px; border-radius: 50%;
      border: 4px solid var(--bg); overflow: hidden;
      background: var(--primary);
    }
    .avatar-img {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform 0.3s var(--transition);
    }
    .avatar-container:hover .avatar-img { transform: scale(1.1); }

    .profile-details { padding: 56px 16px 20px; }
    .display-name {
      font-size: 20px; font-weight: 800; margin-bottom: 4px;
      display: flex; align-items: center; gap: 6px;
    }
    .username { color: var(--text-muted); font-size: 14px; margin-bottom: 12px; }
    .bio { font-size: 15px; line-height: 1.5; margin-bottom: 16px; }
    
    .stats-row {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 12px; padding: 16px 0; border-top: 1px solid var(--border);
    }
    .stat-block { text-align: center; cursor: pointer; }
    .stat-value { font-size: 18px; font-weight: 700; }
    .stat-label { font-size: 12px; color: var(--text-muted); }

    .action-row {
      display: flex; gap: 8px; padding-top: 16px;
    }
    .btn {
      flex: 1; padding: 10px 20px; border-radius: 999px;
      font-weight: 600; cursor: pointer; transition: all 0.2s;
      border: 1px solid var(--border); background: transparent;
      color: var(--text);
    }
    .btn-primary {
      background: var(--primary); color: white; border-color: var(--primary);
      box-shadow: var(--primary-glow);
    }
    .btn:active { transform: scale(0.98); }

    /* Stories */
    .stories-section {
      padding: 0 12px 12px; display: none;
    }
    .stories-section.has-content { display: block; }
    .stories-scroll {
      display: flex; gap: 12px; overflow-x: auto;
      padding-bottom: 8px; scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .stories-scroll::-webkit-scrollbar { display: none; }
    .story-thumb {
      flex-shrink: 0; width: 64px; height: 64px; border-radius: 50%;
      border: 2px solid var(--primary); padding: 2px;
      cursor: pointer; position: relative;
    }
    .story-thumb img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

    /* Media Grid */
    .media-grid {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 2px; padding: 0 12px;
    }
    .grid-item {
      position: relative; aspect-ratio: 1; overflow: hidden;
      background: var(--surface); border-radius: 8px;
      cursor: pointer;
    }
    .grid-item img, .grid-item video {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform 0.3s var(--transition);
    }
    .grid-item:hover img, .grid-item:hover video { transform: scale(1.05); }
    
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-muted);
    }
    .empty-state .material-icons { font-size: 48px; margin-bottom: 16px; }

    /* Modals */
    .sheet {
      position: fixed; inset: 0; z-index: 200;
      display: none; align-items: flex-end;
    }
    .sheet.active { display: flex; }
    .sheet-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    .sheet-content {
      background: var(--surface); width: 100%; max-height: 90vh;
      border-top-left-radius: 24px; border-top-right-radius: 24px;
      transform: translateY(100%); animation: slideUp 0.3s forwards;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Media Viewer */
    .media-viewer {
      position: fixed; inset: 0; z-index: 300;
      background: #000; display: none;
    }
    .media-viewer.active { display: block; }
    .viewer-header {
      position: absolute; top: 0; left: 0; right: 0;
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; z-index: 10; color: white;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
    }

    /* Loading */
    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--border) 50%, var(--surface) 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { to { background-position: -200% 0; } }

    /* Responsive */
    @media (min-width: 768px) {
      .profile-card { margin: 16px auto; max-width: 600px; }
      .media-grid { grid-template-columns: repeat(4, 1fr); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <button class="header-btn" onclick="history.back()">
        <span class="material-icons">arrow_back</span>
      </button>
      <h1 id="header-title">Profile</h1>
      <div style="display: flex; gap: 8px;">
        <button class="header-btn" onclick="toggleTheme()" aria-label="Theme">
          <span class="material-icons" id="theme-icon">dark_mode</span>
        </button>
        <button class="header-btn" onclick="openMenu()" aria-label="Menu">
          <span class="material-icons">more_vert</span>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main" id="main-content">
      <!-- Profile Card Skeleton -->
      <div class="profile-card" id="profile-card">
        <div class="cover-container skeleton"></div>
        <div class="profile-details">
          <div class="skeleton" style="height: 20px; width: 200px; margin-bottom: 8px;"></div>
          <div class="skeleton" style="height: 14px; width: 120px; margin-bottom: 16px;"></div>
          <div class="skeleton" style="height: 40px; width: 100%;"></div>
        </div>
      </div>

      <!-- Stories Section -->
      <section class="stories-section" id="stories-section">
        <div class="stories-scroll" id="stories-scroll"></div>
      </section>

      <!-- Media Grid -->
      <section class="media-grid" id="media-grid"></section>

      <!-- Empty State -->
      <div class="empty-state" id="empty-state" style="display: none;">
        <span class="material-icons">photo_library</span>
        <div id="empty-message">No posts yet</div>
      </div>
    </main>

    <!-- Media Viewer -->
    <div class="media-viewer" id="media-viewer">
      <div class="viewer-header">
        <button class="header-btn" onclick="closeViewer()">
          <span class="material-icons">close</span>
        </button>
        <div id="viewer-title"></div>
        <button class="header-btn" onclick="shareMedia()">
          <span class="material-icons">share</span>
        </button>
      </div>
      <div id="viewer-content" style="height: 100%; display: flex; align-items: center; justify-content: center;"></div>
    </div>

    <!-- Bottom Sheet -->
    <div class="sheet" id="bottom-sheet">
      <div class="sheet-overlay" onclick="closeSheet()"></div>
      <div class="sheet-content" id="sheet-content"></div>
    </div>

    <!-- Context Menu -->
    <div class="sheet" id="menu-sheet">
      <div class="sheet-overlay" onclick="closeMenu()"></div>
      <div class="sheet-content">
        <div style="padding: 16px; border-bottom: 1px solid var(--border);">
          <h3 style="font-weight: 700; margin: 0;">More Options</h3>
        </div>
        <div style="padding: 8px;">
          <div class="btn" style="text-align: left;" onclick="reportUser()">
            <span class="material-icons" style="vertical-align: middle; margin-right: 12px;">flag</span>
            Report User
          </div>
          <div class="btn" style="text-align: left; color: #ff4444;" onclick="blockUser()">
            <span class="material-icons" style="vertical-align: middle; margin-right: 12px;">block</span>
            Block User
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    /* ==================== SECURE FIREBASE SETUP ==================== */
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const CLOUDINARY_CONFIG = {
      cloudName: 'dqkujefxj',
      uploadPreset: 'banter_box_secure' // Use a secure preset with signed uploads in production
    };

    // Dynamic imports to prevent blocking render
    const [{ initializeApp }, { getAuth, onAuthStateChanged }, { 
      getDatabase, ref, get, set, update, onValue, serverTimestamp, query, orderByChild, equalTo, limitToLast 
    }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js'),
      import('https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js')
    ]);

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getDatabase(app);

    /* ==================== STATE MANAGEMENT ==================== */
    const state = {
      currentUser: null,
      profileUser: null,
      profileId: null,
      isOwnProfile: false,
      followers: {},
      following: {},
      media: [],
      stories: [],
      isLoading: true,
      listeners: new Map()
    };

    /* ==================== UI HELPERS ==================== */
    const $ = id => document.getElementById(id);
    const toast = (msg) => {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-accent text-white px-4 py-2 rounded-full font-semibold shadow-lg z-50';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    };

    const setLoading = (isLoading) => {
      state.isLoading = isLoading;
      $('main-content').classList.toggle('opacity-50', isLoading);
    };

    const formatTime = (timestamp) => {
      const diff = Date.now() - timestamp;
      const mins = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (mins < 1) return 'now';
      if (mins < 60) return `${mins}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      return new Date(timestamp).toLocaleDateString();
    };

    const generateAvatar = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ff2a6d&color=fff&size=200`;

    /* ==================== PROFILE RENDERING ==================== */
    async function renderProfile() {
      const user = state.profileUser;
      if (!user) return;

      const isVerified = user.verified || false;
      const isBusiness = user.businessMode || false;
      const avatarUrl = user.photoURL || generateAvatar(user.displayName || 'User');
      const coverUrl = user.coverUrl || generateAvatar('Cover');
      const followingCount = Object.keys(state.following).length;
      const followersCount = user.followersCount || 0;
      const postsCount = user.postsCount || 0;

      $('profile-card').innerHTML = `
        <div class="cover-container">
          <img src="${coverUrl}" class="cover-img" alt="Cover" loading="eager" onerror="this.src='${generateAvatar('Cover')}'">
          <div class="avatar-container">
            <img src="${avatarUrl}" class="avatar-img" alt="Avatar" loading="eager" onerror="this.src='${generateAvatar('User')}'">
          </div>
        </div>
        <div class="profile-details">
          <div class="display-name">
            ${user.displayName || 'User'}
            ${isVerified ? '<span class="material-icons" style="color: var(--primary); font-size: 20px;">verified</span>' : ''}
            ${isBusiness ? '<span class="material-icons" style="color: var(--primary); font-size: 20px;">business_center</span>' : ''}
          </div>
          <div class="username">@${user.username || state.profileId}</div>
          ${user.bio ? `<div class="bio">${user.bio}</div>` : ''}
          <div class="stats-row">
            <div class="stat-block" onclick="showFollowers()">
              <div class="stat-value" id="followers-count">${followersCount}</div>
              <div class="stat-label">Followers</div>
            </div>
            <div class="stat-block" onclick="showFollowing()">
              <div class="stat-value" id="following-count">${followingCount}</div>
              <div class="stat-label">Following</div>
            </div>
            <div class="stat-block">
              <div class="stat-value">${postsCount}</div>
              <div class="stat-label">Posts</div>
            </div>
          </div>
          <div class="action-row" id="action-row"></div>
        </div>
      `;

      renderActions();
    }

    function renderActions() {
      const row = $('action-row');
      if (state.isOwnProfile) {
        row.innerHTML = `<button class="btn" onclick="editProfile()">Edit Profile</button>`;
      } else {
        const isFollowing = state.currentUser && state.followers[state.currentUser.uid];
        row.innerHTML = `
          <button class="btn ${isFollowing ? '' : 'btn-primary'}" id="follow-btn" onclick="toggleFollow()">
            ${isFollowing ? 'Following' : 'Follow'}
          </button>
          <button class="btn" onclick="startChat()">Message</button>
        `;
      }
    }

    /* ==================== MEDIA GRID ==================== */
    async function loadMedia() {
      const mediaRef = ref(db, 'media');
      const userMediaQuery = query(mediaRef, orderByChild('userId'), equalTo(state.profileId), limitToLast(30));
      
      const unsubscribe = onValue(userMediaQuery, (snapshot) => {
        state.media = [];
        const mediaGrid = $('media-grid');
        mediaGrid.innerHTML = '';

        snapshot.forEach(child => {
          const media = { id: child.key, ...child.val() };
          if (Date.now() - media.timestamp < 30 * 24 * 60 * 60 * 1000) { // 30 days
            state.media.push(media);
          }
        });

        state.media.reverse(); // Newest first

        if (state.media.length === 0) {
          $('empty-state').style.display = 'block';
          $('empty-message').textContent = state.isOwnProfile ? 'Your posts will appear here' : 'No posts yet';
          return;
        }

        state.media.forEach(media => {
          const item = document.createElement('div');
          item.className = 'grid-item';
          if (media.type === 'video') {
            item.innerHTML = `
              <video src="${media.url}" muted loop preload="metadata"
                     onmouseover="this.play()" onmouseout="this.pause()"></video>
              <span class="material-icons" style="position: absolute; top: 8px; right: 8px; color: white; font-size: 20px;">play_circle</span>
            `;
          } else {
            item.innerHTML = `<img src="${media.url}" alt="Post" loading="lazy">`;
          }
          item.onclick = () => openMediaViewer(media);
          mediaGrid.appendChild(item);
        });

        state.listeners.set('media', unsubscribe);
      });
    }

    /* ==================== STORIES ==================== */
    async function loadStories() {
      const storiesRef = ref(db, 'stories');
      const storyQuery = query(storiesRef, orderByChild('userId'), equalTo(state.profileId), limitToLast(20));
      
      const unsubscribe = onValue(storyQuery, (snapshot) => {
        state.stories = [];
        const storiesSection = $('stories-section');
        const storiesScroll = $('stories-scroll');
        storiesScroll.innerHTML = '';

        snapshot.forEach(child => {
          const story = { id: child.key, ...child.val() };
          if (Date.now() - story.expiresAt > 0) return; // Skip expired
          state.stories.push(story);
        });

        if (state.stories.length > 0) {
          storiesSection.classList.add('has-content');
          state.stories.forEach(story => {
            const thumb = document.createElement('div');
            thumb.className = 'story-thumb';
            thumb.innerHTML = `<img src="${story.thumbnail}" alt="Story" loading="lazy">`;
            thumb.onclick = () => openStoryViewer(story);
            storiesScroll.appendChild(thumb);
          });
        }

        state.listeners.set('stories', unsubscribe);
      });
    }

    /* ==================== INTERACTIONS ==================== */
    window.toggleFollow = async () => {
      if (!state.currentUser || state.isOwnProfile) return;

      const followRef = ref(db, `users/${state.currentUser.uid}/following/${state.profileId}`);
      const followersRef = ref(db, `users/${state.profileId}/followersCount`);
      const btn = $('follow-btn');

      try {
        const isFollowing = state.followers[state.currentUser.uid];
        if (isFollowing) {
          await Promise.all([
            set(followRef, null),
            set(followersRef, (state.profileUser.followersCount || 1) - 1)
          ]);
          toast('Unfollowed');
        } else {
          await Promise.all([
            set(followRef, serverTimestamp()),
            set(followersRef, (state.profileUser.followersCount || 0) + 1)
          ]);
          toast('Now following!');
        }
      } catch (error) {
        toast('Failed to update');
        console.error(error);
      }
    };

    window.startChat = () => {
      if (state.isOwnProfile) return;
      const params = new URLSearchParams({
        chatId: [state.currentUser.uid, state.profileId].sort().join('_'),
        userId: state.profileId,
        username: state.profileUser.displayName || '',
        avatar: state.profileUser.photoURL || ''
      });
      location.href = `chat.html?${params.toString()}`;
    };

    window.editProfile = () => {
      const sheet = $('bottom-sheet');
      sheet.classList.add('active');
      $('sheet-content').innerHTML = `
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
          <h2 style="font-size: 22px; font-weight: 800; margin-bottom: 24px;">Edit Profile</h2>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Display Name</label>
            <input type="text" id="edit-name" class="input-field" value="${state.profileUser.displayName || ''}" maxlength="50">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Bio</label>
            <textarea id="edit-bio" class="input-field" maxlength="500" rows="3">${state.profileUser.bio || ''}</textarea>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Profile Photo</label>
            <input type="file" id="edit-avatar" accept="image/*" onchange="uploadAvatar(event)">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Cover Photo</label>
            <input type="file" id="edit-cover" accept="image/*" onchange="uploadCover(event)">
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-primary" onclick="saveProfile()" style="flex: 1;">Save</button>
            <button class="btn" onclick="closeSheet()" style="flex: 1;">Cancel</button>
          </div>
        </div>
      `;
    };

    async function uploadAvatar(event) {
      const file = event.target.files[0];
      if (!file) return;
      await uploadToCloudinary(file, 'photoURL');
    }

    async function uploadCover(event) {
      const file = event.target.files[0];
      if (!file) return;
      await uploadToCloudinary(file, 'coverUrl');
    }

    async function uploadToCloudinary(file, field) {
      showSpinner();
      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/upload`);
        
        await new Promise((resolve, reject) => {
          xhr.onload = () => xhr.status === 200 ? resolve(JSON.parse(xhr.responseText)) : reject();
          xhr.onerror = reject;
          xhr.send(formData);
        }).then(async (data) => {
          await update(ref(db, `users/${state.profileId}`), { [field]: data.secure_url });
          state.profileUser[field] = data.secure_url;
          renderProfile();
          toast(`${field === 'photoURL' ? 'Avatar' : 'Cover'} updated`);
        });
      } catch {
        toast('Upload failed');
      } finally {
        hideSpinner();
      }
    }

    window.saveProfile = async () => {
      const name = $('edit-name').value.trim();
      const bio = $('edit-bio').value.trim();
      
      if (name.length > 50) return toast('Name too long');
      if (bio.length > 500) return toast('Bio too long');

      try {
        await update(ref(db, `users/${state.profileId}`), {
          displayName: name || state.profileUser.displayName,
          bio: bio || state.profileUser.bio,
          updatedAt: serverTimestamp()
        });
        state.profileUser.displayName = name || state.profileUser.displayName;
        state.profileUser.bio = bio || state.profileUser.bio;
        renderProfile();
        closeSheet();
        toast('Profile saved');
      } catch (error) {
        toast('Save failed');
      }
    };

    window.openMediaViewer = (media) => {
      const viewer = $('media-viewer');
      const content = $('viewer-content');
      viewer.classList.add('active');
      
      if (media.type === 'video') {
        content.innerHTML = `<video src="${media.url}" controls autoplay style="max-width: 100%; max-height: 80vh;"></video>`;
      } else {
        content.innerHTML = `<img src="${media.url}" alt="Post" style="max-width: 100%; max-height: 80vh;">`;
      }
      
      $('viewer-title').textContent = formatTime(media.timestamp);
    };

    window.closeViewer = () => {
      $('media-viewer').classList.remove('active');
      $('viewer-content').innerHTML = '';
    };

    window.shareMedia = () => {
      if (navigator.share) {
        navigator.share({ title: 'Vynix Post', url: window.location.href });
      } else {
        navigator.clipboard.writeText(window.location.href);
        toast('Link copied');
      }
    };

    window.closeSheet = () => {
      $('bottom-sheet').classList.remove('active');
    };

    window.openMenu = () => {
      $('menu-sheet').classList.add('active');
    };

    window.closeMenu = () => {
      $('menu-sheet').classList.remove('active');
    };

    window.reportUser = () => {
      toast('Report submitted');
      closeMenu();
    };

    window.blockUser = () => {
      toast('User blocked');
      closeMenu();
      setTimeout(() => history.back(), 1000);
    };

    window.showFollowers = () => toast('Followers list coming soon');
    window.showFollowing = () => toast('Following list coming soon');
    window.openStoryViewer = () => toast('Story viewer coming soon');

    window.toggleTheme = () => {
      const isDark = document.body.classList.toggle('dark');
      document.body.classList.toggle('light', !isDark);
      localStorage.setItem('darkMode', isDark);
      $('theme-icon').textContent = isDark ? 'light_mode' : 'dark_mode';
    };

    /* ==================== INITIALIZATION ==================== */
    async function init() {
      // Wait for auth
      await new Promise((resolve) => {
        onAuthStateChanged(auth, resolve);
      });

      if (!auth.currentUser) {
        location.href = 'login.html';
        return;
      }

      state.currentUser = auth.currentUser;
      state.profileId = new URLSearchParams(location.search).get('uid') || state.currentUser.uid;
      state.isOwnProfile = state.currentUser.uid === state.profileId;

      // Load profile data
      const userSnap = await get(ref(db, `users/${state.profileId}`));
      if (!userSnap.exists()) {
        toast('User not found');
        location.href = 'index.html';
        return;
      }
      state.profileUser = userSnap.val();

      // Load follows
      const [followersSnap, followingSnap] = await Promise.all([
        get(ref(db, `users/${state.profileId}/followers`)),
        get(ref(db, `users/${state.profileId}/following`))
      ]);
      state.followers = followersSnap.val() || {};
      state.following = followingSnap.val() || {};

      // Render everything
      renderProfile();
      loadMedia();
      loadStories();

      // Update header
      $('header-title').textContent = state.profileUser.displayName || 'Profile';

      // Theme sync
      const savedTheme = localStorage.getItem('darkMode') === 'true';
      document.body.classList.toggle('dark', savedTheme);
      $('theme-icon').textContent = savedTheme ? 'light_mode' : 'dark_mode';
    }

    // Initialize app
    init().catch(console.error);

    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      state.listeners.forEach(unsubscribe => unsubscribe());
    });
  </script>
</body>
</html>
