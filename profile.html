<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <!-- Title -->
  <title>Vynix - Profile</title>

  <!-- PWA Tags -->
  <meta name="theme-color" content="#ff2a6d">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly91aS1hdmF0YXJzLmNvbS9hcGkvP2JhY2tncm91bmQ9ZmYyYTZkJmNvbG9yPWZmZiZzaXplPTE5MiIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

  <!-- External Resources -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Critical CSS -->
  <style>
    /* ... (keep all previous CSS) ... */
    
    /* Add this for debugging */
    .debug-info {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.8); color: lime;
      font-family: monospace; font-size: 10px;
      padding: 8px; z-index: 1000; max-height: 100px;
      overflow-y: auto; display: none;
    }
    .debug-info.active { display: block; }
  </style>
</head>
<body>
  <!-- Add debug panel -->
  <div class="debug-info" id="debug-panel"></div>
  
  <div class="app">
    <!-- Header -->
    <header class="header">
      <button class="header-btn" onclick="history.back()">
        <span class="material-icons">arrow_back</span>
      </button>
      <h1 id="header-title">Profile</h1>
      <div style="display: flex; gap: 8px;">
        <button class="header-btn" onclick="toggleTheme()" aria-label="Theme">
          <span class="material-icons" id="theme-icon">dark_mode</span>
        </button>
        <button class="header-btn" onclick="openMenu()" aria-label="Menu">
          <span class="material-icons">more_vert</span>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main" id="main-content">
      <!-- Skeleton Loader -->
      <div class="skeleton-card" id="skeleton-card">
        <div class="cover-container">
          <div class="skeleton-cover"></div>
          <div class="skeleton skeleton-avatar"></div>
        </div>
        <div class="skeleton-details">
          <div class="skeleton skeleton-line" style="width: 60%;"></div>
          <div class="skeleton skeleton-line" style="width: 40%;"></div>
          <div class="skeleton skeleton-line" style="width: 80%;"></div>
        </div>
      </div>

      <!-- Profile Card -->
      <div class="profile-card" id="profile-card"></div>

      <!-- Media Grid -->
      <div class="media-grid" id="media-grid"></div>

      <!-- Empty State -->
      <div class="empty-state" id="empty-state">
        <span class="material-icons">photo_library</span>
        <div id="empty-message">No posts yet</div>
      </div>
    </main>

    <!-- ... (keep other UI elements) ... -->
  </div>

  <script type="module">
    /* ==================== DEBUG LOGGER ==================== */
    const debug = (msg) => {
      console.log(`[Vynix Debug] ${msg}`);
      const panel = $('debug-panel');
      if (panel) {
        panel.textContent += `\n${new Date().toISOString()}: ${msg}`;
        panel.classList.add('active');
      }
    };

    /* ==================== STATE ==================== */
    const state = {
      currentUser: null,
      profileUser: null,
      profileId: null,
      isOwnProfile: false,
      followers: {},
      following: {},
      media: [],
      stories: [],
      listeners: new Map()
    };

    /* ==================== FIREBASE INITIALIZATION ==================== */
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const CLOUDINARY_CONFIG = {
      cloudName: 'dqkujefxj',
      uploadPreset: 'banter_box'
    };

    // Import Firebase
    debug('Loading Firebase modules...');
    const firebaseApp = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js');
    const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js');
    const firebaseDatabase = await import('https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js');
    
    const { initializeApp } = firebaseApp;
    const { getAuth, onAuthStateChanged } = firebaseAuth;
    const { getDatabase, ref, get, set, update, onValue, serverTimestamp, query, orderByChild, equalTo, limitToLast } = firebaseDatabase;
    
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getDatabase(app);
    debug('Firebase initialized');

    /* ==================== UI HELPERS ==================== */
    const $ = id => document.getElementById(id);
    
    const toast = (msg) => {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-accent text-white px-4 py-2 rounded-full font-semibold shadow-lg z-50';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    };

    const showError = (msg) => {
      debug(`ERROR: ${msg}`);
      $('main-content').innerHTML = `
        <div class="empty-state active">
          <span class="material-icons">error</span>
          <div>${msg}</div>
          <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 16px;">Retry</button>
        </div>
      `;
    };

    const showSkeleton = () => {
      debug('Showing skeleton loader');
      $('skeleton-card').style.display = 'block';
      $('profile-card').classList.remove('loaded');
      $('profile-card').style.display = 'none';
      $('empty-state').classList.remove('active');
    };

    const hideSkeleton = () => {
      debug('Hiding skeleton, showing profile');
      $('skeleton-card').style.display = 'none';
      $('profile-card').style.display = 'block';
      $('profile-card').classList.add('loaded');
    };

    const formatTime = (timestamp) => {
      const diff = Date.now() - timestamp;
      const mins = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (mins < 1) return 'now';
      if (mins < 60) return `${mins}m`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      return new Date(timestamp).toLocaleDateString();
    };

    const generateAvatar = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ff2a6d&color=fff&size=200`;

    /* ==================== PROFILE LOADING ==================== */
    async function loadProfile() {
      debug('Starting profile load...');
      showSkeleton();
      
      try {
        // Get profile ID from URL
        const urlParams = new URLSearchParams(location.search);
        state.profileId = urlParams.get('uid') || state.currentUser.uid;
        state.isOwnProfile = state.currentUser.uid === state.profileId;
        debug(`Loading profile: ${state.profileId}, isOwn: ${state.isOwnProfile}`);

        // Load user data
        debug('Fetching user data...');
        const userSnap = await get(ref(db, `users/${state.profileId}`));
        if (!userSnap.exists()) {
          throw new Error('User not found');
        }
        state.profileUser = userSnap.val();
        debug('User data loaded:', state.profileUser);

        // Load followers/following
        debug('Loading follows...');
        const [followersSnap, followingSnap] = await Promise.all([
          get(ref(db, `users/${state.profileId}/followers`)),
          get(ref(db, `users/${state.profileId}/following`))
        ]);
        state.followers = followersSnap.val() || {};
        state.following = followingSnap.val() || {};
        debug(`Followers: ${Object.keys(state.followers).length}, Following: ${Object.keys(state.following).length}`);

        // Render profile
        hideSkeleton();
        renderProfile();
        
        // Load additional content
        await Promise.all([loadMedia(), loadStories()]);
        
        // Setup real-time listeners
        setupListeners();
        
        debug('Profile load complete');
        
      } catch (error) {
        debug(`Profile load failed: ${error.message}`);
        showError(`Failed to load profile: ${error.message}`);
      }
    }

    /* ==================== RENDERING ==================== */
    function renderProfile() {
      if (!state.profileUser) {
        debug('No profile user to render');
        return;
      }

      debug('Rendering profile...');
      const isVerified = state.profileUser.verified || false;
      const isBusiness = state.profileUser.businessMode || false;
      const avatarUrl = state.profileUser.photoURL || generateAvatar(state.profileUser.displayName || 'User');
      const coverUrl = state.profileUser.coverUrl || generateAvatar('Cover');
      const followingCount = Object.keys(state.following).length;
      const followersCount = state.profileUser.followersCount || 0;
      const postsCount = state.profileUser.postsCount || 0;

      $('profile-card').innerHTML = `
        <div class="cover-container">
          <img src="${coverUrl}" class="cover-img" alt="Cover" onerror="this.src='${generateAvatar('Cover')}'">
          <div class="avatar-container">
            <img src="${avatarUrl}" class="avatar-img" alt="Avatar" onerror="this.src='${generateAvatar('User')}'">
          </div>
        </div>
        <div class="profile-details">
          <div class="display-name">
            ${state.profileUser.displayName || 'User'}
            ${isVerified ? '<span class="material-icons" style="color: var(--primary); font-size: 20px;">verified</span>' : ''}
            ${isBusiness ? '<span class="material-icons" style="color: var(--primary); font-size: 20px;">business_center</span>' : ''}
          </div>
          <div class="username">@${state.profileUser.username || state.profileId}</div>
          ${state.profileUser.bio ? `<div class="bio">${state.profileUser.bio}</div>` : ''}
          <div class="stats-row">
            <div class="stat-block" onclick="showFollowers()">
              <div class="stat-value" id="followers-count">${followersCount}</div>
              <div class="stat-label">Followers</div>
            </div>
            <div class="stat-block" onclick="showFollowing()">
              <div class="stat-value" id="following-count">${followingCount}</div>
              <div class="stat-label">Following</div>
            </div>
            <div class="stat-block">
              <div class="stat-value" id="posts-count">${postsCount}</div>
              <div class="stat-label">Posts</div>
            </div>
          </div>
          <div class="action-row" id="action-row"></div>
        </div>
      `;

      renderActions();
      debug('Profile rendered');
    }

    function renderActions() {
      const row = $('action-row');
      if (state.isOwnProfile) {
        row.innerHTML = `<button class="btn" onclick="editProfile()">Edit Profile</button>`;
      } else {
        const isFollowing = state.followers[state.currentUser?.uid];
        row.innerHTML = `
          <button class="btn ${isFollowing ? '' : 'btn-primary'}" id="follow-btn" onclick="toggleFollow()">
            ${isFollowing ? 'Following' : 'Follow'}
          </button>
          <button class="btn" onclick="startChat()">Message</button>
        `;
      }
      debug('Actions rendered');
    }

    /* ==================== LISTENERS & CLEANUP ==================== */
    function setupListeners() {
      // Followers count listener
      const followersListener = onValue(ref(db, `users/${state.profileId}/followersCount`), (snap) => {
        const el = $('followers-count');
        if (el) el.textContent = snap.val() || 0;
      });
      state.listeners.set('followersCount', followersListener);
      debug('Followers listener attached');
    }

    window.addEventListener('beforeunload', () => {
      debug('Cleaning up listeners...');
      state.listeners.forEach(unsubscribe => {
        if (typeof unsubscribe === 'function') unsubscribe();
      });
    });

    /* ==================== APP START ==================== */
    debug('=== APP INITIALIZING ===');
    
    // Subscribe to auth state
    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
      if (!user) {
        debug('No user, redirecting to login');
        location.href = 'login.html';
        return;
      }
      
      debug(`User authenticated: ${user.uid}`);
      state.currentUser = user;
      unsubscribeAuth(); // Clean up auth listener
      
      // Load profile after auth confirmed
      loadProfile();
    }, (error) => {
      debug(`Auth error: ${error.message}`);
      showError('Authentication failed');
    });
  </script>
</body>
</html>
