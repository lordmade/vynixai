<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Professional Portfolio - Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --border: #e9ecef;
      --accent: #ff2a6d;
      --accent-light: rgba(255, 42, 109, 0.1);
      --success: #28a745;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
      --gradient: linear-gradient(135deg, #ff2a6d, #05d9e8);
    }
    body.dark {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text-primary: #e9ecef;
      --text-secondary: #adb5bd;
      --border: #343a40;
      --accent-light: rgba(255, 42, 109, 0.15);
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      user-select: text;
      transition: background-color 0.3s ease;
    }
    .header {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: var(--card-bg);
      z-index: 100;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      box-shadow: var(--shadow);
    }
    .back-btn {
      background: none; border: none;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .back-btn:hover {
      background: var(--accent-light);
    }
    .share-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(255,42,109,0.3);
      transition: transform 0.2s;
    }
    .share-btn:hover {
      transform: scale(1.1);
    }
    .hero-section {
      padding-top: 84px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .profile-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 32px;
      padding: 40px 0;
    }
    .avatar-wrapper {
      position: relative;
      flex-shrink: 0;
    }
    .profile-avatar {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--accent);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .edit-avatar-overlay {
      position: absolute;
      bottom: 0;
      right: 0;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .profile-info {
      flex: 1;
      min-width: 200px;
    }
    .name-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .name-input {
      font-size: 32px;
      font-weight: 700;
      border: none;
      background: transparent;
      color: var(--text-primary);
      padding: 4px;
      flex: 1;
    }
    .view-mode-name {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .verified-badge {
      color: var(--accent);
      font-size: 24px;
      vertical-align: middle;
    }
    .professional-title-input {
      font-size: 18px;
      color: var(--text-secondary);
      border: none;
      background: transparent;
      width: 100%;
      margin-bottom: 12px;
      padding: 4px;
    }
    .location-input {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
    .location-input input {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      flex: 1;
    }
    .bio-section {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .bio-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .bio-textarea {
      width: 100%;
      min-height: 100px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 16px;
      line-height: 1.6;
      resize: vertical;
    }
    .bio-textarea:focus {
      outline: none;
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 12px;
    }
    .section-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s;
    }
    .section-card:hover {
      box-shadow: var(--shadow-lg);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .section-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .edit-toggle {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 16px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .edit-toggle:hover {
      transform: scale(1.05);
    }
    .edit-toggle.active {
      background: var(--success);
    }
    .tag-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .skill-tag {
      background: var(--accent-light);
      border: 1px solid var(--accent);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .skill-tag .remove {
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .add-skill-input {
      border: 1px dashed var(--border);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 14px;
      background: transparent;
      color: var(--text-primary);
      min-width: 120px;
      outline: none;
    }
    .add-skill-input:focus {
      border-style: solid;
      border-color: var(--accent);
    }
    .experience-item, .project-item, .education-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      background: var(--bg);
      transition: border-color 0.2s;
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    .item-title-input, .item-company-input, .item-school-input {
      font-weight: 600;
      font-size: 16px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      flex: 1;
      padding: 4px;
    }
    .item-title-input:focus, .item-company-input:focus, .item-school-input:focus {
      border: 1px solid var(--accent);
      border-radius: 6px;
    }
    .item-date-input {
      font-size: 13px;
      color: var(--text-secondary);
      border: none;
      background: transparent;
      padding: 4px;
    }
    .item-description-input {
      width: 100%;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      min-height: 60px;
      padding: 4px;
    }
    .item-description-input:focus {
      border: 1px solid var(--accent);
      border-radius: 6px;
      padding: 8px;
    }
    .add-item-btn {
      width: 100%;
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 16px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    .add-item-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 16px;
      flex-shrink: 0;
      transition: transform 0.2s;
    }
    .delete-btn:hover {
      transform: scale(1.1);
    }
    /* HIDDEN for non-owners */
    .owner-controls {
      display: none;
    }
    .is-owner .owner-controls {
      display: block;
    }
    .is-owner .edit-avatar-overlay {
      display: flex;
    }
    .is-owner .edit-toggle {
      display: block;
    }
    /* Download button - only for owners */
    .download-resume-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      z-index: 50;
      display: none; /* Hidden by default */
      transition: transform 0.2s;
    }
    .is-owner .download-resume-btn {
      display: block; /* Show for owners */
    }
    .download-resume-btn:hover {
      transform: scale(1.1);
    }
    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 24px;
      }
      .name-input, .view-mode-name {
        font-size: 24px;
      }
      .container {
        padding: 0 16px;
      }
    }
  </style>
</head>
<body>

  <header class="header">
    <button class="back-btn material-icons" onclick="history.back()">arrow_back</button>
    <div class="header-title" id="page-title">Portfolio</div>
    <!-- Share button (owner only) -->
    <button class="share-btn owner-controls" id="share-btn" title="Copy portfolio link">
      <i class="fas fa-link"></i>
    </button>
    <div class="non-owner-spacer owner-controls" style="width: 40px;"></div>
  </header>

  <div class="hero-section">
    <div class="container">
      <div class="profile-header">
        <!-- Owner avatar with edit -->
        <div class="avatar-wrapper owner-controls">
          <img class="profile-avatar" id="profile-avatar" src="" alt="Profile">
          <button class="edit-avatar-overlay material-icons" id="edit-avatar-btn">edit</button>
        </div>
        <!-- Visitor avatar (no edit) -->
        <div class="avatar-wrapper non-owner-avatar" style="display: none;">
          <img class="profile-avatar" id="visitor-avatar" src="" alt="Profile">
        </div>
        
        <div class="profile-info">
          <!-- Owner: Name with verified badge -->
          <div class="name-wrapper owner-controls">
            <input type="text" class="name-input" id="name-input" placeholder="Your Name" disabled>
            <span id="verified-badge-owner" class="material-icons verified-badge" style="display: none;">verified</span>
          </div>
          <!-- Visitor: Name with verified badge -->
          <div class="view-mode-name non-owner-name" id="visitor-name" style="display: none;">
            <span id="visitor-name-text"></span>
            <span id="verified-badge-visitor" class="material-icons verified-badge" style="display: none;">verified</span>
          </div>
          
          <!-- Professional title -->
          <input type="text" class="professional-title-input owner-controls" id="title-input" placeholder="e.g. Senior Software Engineer" disabled>
          <div class="professional-title-input non-owner-title" id="visitor-title" style="display: none; color: var(--text-secondary);"></div>
          
          <!-- Location/Country -->
          <div class="location-input">
            <span class="material-icons" style="font-size: 20px;">location_on</span>
            <input type="text" class="owner-controls" id="location-input" placeholder="City, Country" disabled>
            <div class="non-owner-location" id="visitor-location" style="display: none;"></div>
          </div>
          
          <!-- Social links with icons -->
          <div class="social-links owner-controls" id="social-links"></div>
          <div class="social-links non-owner-social" id="visitor-social" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="padding-bottom: 100px;">
    
    <!-- About / Bio Section -->
    <div class="section-card bio-section">
      <div class="section-header">
        <div class="section-title">
          <span class="material-icons">person</span>
          About
        </div>
        <button class="edit-toggle owner-controls" id="edit-about-btn">Edit</button>
      </div>
      <div class="bio-label">Professional Summary</div>
      <textarea class="bio-textarea" id="bio-textarea" placeholder="Tell us about yourself, your experience, and what you're passionate about..." disabled></textarea>
    </div>

    <!-- Skills Section -->
    <div class="section-card owner-controls" id="skills-section">
      <div class="section-header">
        <div class="section-title">
          <span class="material-icons">build</span>
          Skills
        </div>
        <button class="edit-toggle" id="edit-skills-btn">Edit</button>
      </div>
      <div class="tag-input-container" id="skills-container"></div>
    </div>

    <!-- Experience Section -->
    <div class="section-card owner-controls" id="experience-section">
      <div class="section-header">
        <div class="section-title">
          <span class="material-icons">work</span>
          Experience
        </div>
        <button class="edit-toggle" id="edit-experience-btn">Edit</button>
      </div>
      <div id="experience-container"></div>
    </div>

    <!-- Projects Section -->
    <div class="section-card owner-controls" id="projects-section">
      <div class="section-header">
        <div class="section-title">
          <span class="material-icons">folder</span>
          Projects
        </div>
        <button class="edit-toggle" id="edit-projects-btn">Edit</button>
      </div>
      <div id="projects-container"></div>
    </div>

    <!-- Education Section -->
    <div class="section-card owner-controls" id="education-section">
      <div class="section-header">
        <div class="section-title">
          <span class="material-icons">school</span>
          Education
        </div>
        <button class="edit-toggle" id="edit-education-btn">Edit</button>
      </div>
      <div id="education-container"></div>
    </div>

    <!-- Contact Section -->
    <div class="section-card owner-controls" id="contact-section">
      <div class="section-header">
        <div class="section-title">
          <span class="material-icons">mail</span>
          Contact
        </div>
        <button class="edit-toggle" id="edit-contact-btn">Edit</button>
      </div>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <input type="email" class="item-description-input" id="contact-email" placeholder="Professional Email" disabled>
        <input type="tel" class="item-description-input" id="contact-phone" placeholder="Phone Number" disabled>
        <input type="url" class="item-description-input" id="contact-website" placeholder="Portfolio Website" disabled>
      </div>
    </div>

  </div>

  <!-- Download button - ONLY for owners -->
  <button class="download-resume-btn material-icons owner-controls" id="download-btn" title="Download Resume">download</button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, update, set, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let currentUser = null;
    let targetUserId = null;
    let isOwner = false;
    let portfolioData = {};
    let editMode = {}; // Track edit state per section

    const showAlert = (msg) => {
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.cssText = `position:fixed;top:20px;right:20px;background:var(--card-bg);color:var(--text-primary);padding:12px 20px;border-radius:20px;border:1px solid var(--border);z-index:1000;transition:transform 0.3s;transform:translateX(120%);`;
      document.body.appendChild(el);
      setTimeout(() => el.style.transform = 'translateX(0)', 10);
      setTimeout(() => el.remove(), 3000);
    };

    // Check if viewing own profile or someone else's
    const checkOwnership = async (user) => {
      const urlParams = new URLSearchParams(window.location.search);
      const paramUserId = urlParams.get('user');
      
      currentUser = user;
      
      if (paramUserId && paramUserId !== user.uid) {
        // Viewing someone else's profile
        targetUserId = paramUserId;
        isOwner = false;
        document.body.classList.remove('is-owner');
        
        // Hide owner controls
        document.querySelectorAll('.owner-controls').forEach(el => el.style.display = 'none');
        document.getElementById('page-title').textContent = 'Portfolio';
        
        // Show visitor view elements
        document.querySelector('.non-owner-avatar').style.display = 'block';
        document.getElementById('visitor-name').style.display = 'flex';
        document.getElementById('visitor-title').style.display = 'block';
        document.getElementById('visitor-location').style.display = 'block';
        
        // Hide sections for visitors
        ['skills', 'experience', 'projects', 'education', 'contact'].forEach(section => {
          const el = document.getElementById(`${section}-section`);
          if (el) el.style.display = 'none';
        });
      } else {
        // Viewing own profile
        targetUserId = user.uid;
        isOwner = true;
        document.body.classList.add('is-owner');
        
        // Show owner controls
        document.querySelectorAll('.owner-controls').forEach(el => el.style.display = '');
        document.getElementById('page-title').textContent = 'My Portfolio';
        
        // Hide visitor elements
        document.querySelector('.non-owner-avatar').style.display = 'none';
        document.getElementById('visitor-name').style.display = 'none';
        document.getElementById('visitor-title').style.display = 'none';
        document.getElementById('visitor-location').style.display = 'none';
        
        // Show all sections
        ['skills', 'experience', 'projects', 'education', 'contact'].forEach(section => {
          const el = document.getElementById(`${section}-section`);
          if (el) el.style.display = 'block';
        });
      }
      
      // Initialize edit mode states
      ['about', 'skills', 'experience', 'projects', 'education', 'contact'].forEach(section => {
        editMode[section] = false;
      });
      
      // Load the target user's portfolio
      await loadPortfolio(targetUserId);
    };

    // Load portfolio data
    const loadPortfolio = async (userId) => {
      const portfolioRef = ref(db, `portfolios/${userId}`);
      
      // Also load basic user data for avatar and name fallback
      const userRef = ref(db, `users/${userId}`);
      const userSnap = await get(userRef);
      const userData = userSnap.exists() ? userSnap.val() : {};
      
      onValue(portfolioRef, (snap) => {
        let data = {
          name: userData.displayName || '',
          title: '',
          location: '',
          bio: '',
          skills: [],
          experience: [],
          projects: [],
          education: [],
          contact: { email: userData.email || '', phone: '', website: '' },
          social: {
            LinkedIn: '',
            GitHub: '',
            Twitter: '',
            Portfolio: ''
          }
        };
        
        if (snap.exists()) {
          data = { ...data, ...snap.val() };
        } else if (isOwner) {
          // Create default portfolio for owner if it doesn't exist
          set(portfolioRef, data);
        }
        
        // Show verified badge if applicable
        if (userData.verified) {
          if (isOwner) {
            document.getElementById('verified-badge-owner').style.display = 'inline';
          } else {
            document.getElementById('verified-badge-visitor').style.display = 'inline';
          }
        }
        
        portfolioData = data;
        renderPortfolio(data, userData);
      });
    };

    // Render all sections
    const renderPortfolio = (data, userData) => {
      // Update avatar (both owner and visitor)
      const avatarUrl = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.name || 'U')}&background=ff2a6d&color=fff`;
      
      if (isOwner) {
        document.getElementById('profile-avatar').src = avatarUrl;
      } else {
        document.getElementById('visitor-avatar').src = avatarUrl;
      }

      // Update name
      if (isOwner) {
        document.getElementById('name-input').value = data.name;
      } else {
        document.getElementById('visitor-name-text').textContent = data.name || 'User';
      }

      // Update title
      if (isOwner) {
        document.getElementById('title-input').value = data.title || '';
      } else {
        document.getElementById('visitor-title').textContent = data.title || 'No title added';
      }

      // Update location
      if (isOwner) {
        document.getElementById('location-input').value = data.location || '';
      } else {
        const locationEl = document.getElementById('visitor-location');
        locationEl.textContent = data.location || 'No location';
        locationEl.style.display = 'block';
      }

      // Update bio
      document.getElementById('bio-textarea').value = data.bio || '';
      
      // Contact (only for owner)
      if (isOwner) {
        document.getElementById('contact-email').value = data.contact.email || '';
        document.getElementById('contact-phone').value = data.contact.phone || '';
        document.getElementById('contact-website').value = data.contact.website || '';
        
        // Render editable social links with icons
        renderSocialLinks(data.social || {});
        
        // Render skills, experience, etc.
        renderSkills(data.skills || []);
        renderExperience(data.experience || []);
        renderProjects(data.projects || []);
        renderEducation(data.education || []);
      }
    };

    // Skills (owner only)
    const renderSkills = (skills) => {
      const container = document.getElementById('skills-container');
      container.innerHTML = '';
      skills.forEach((skill, index) => {
        const tag = document.createElement('div');
        tag.className = 'skill-tag';
        tag.innerHTML = `
          ${skill}
          <span class="remove" onclick="removeSkill(${index})">&times;</span>
        `;
        container.appendChild(tag);
      });
      // Add input for new skills
      const input = document.createElement('input');
      input.className = 'add-skill-input';
      input.placeholder = '+ Add skill';
      input.onkeypress = (e) => {
        if (e.key === 'Enter' && e.target.value.trim()) {
          addSkill(e.target.value.trim());
          e.target.value = '';
        }
      };
      container.appendChild(input);
    };

    window.addSkill = (skill) => {
      const portfolioRef = ref(db, `portfolios/${targetUserId}`);
      const currentSkills = [...(portfolioData.skills || [])];
      if (!currentSkills.includes(skill)) {
        currentSkills.push(skill);
        update(portfolioRef, { skills: currentSkills });
      }
    };

    window.removeSkill = (index) => {
      const portfolioRef = ref(db, `portfolios/${targetUserId}`);
      const currentSkills = [...(portfolioData.skills || [])];
      currentSkills.splice(index, 1);
      update(portfolioRef, { skills: currentSkills });
    };

    // Experience, Projects, Education (owner only)
    const renderList = (key, containerId, itemTemplate, items) => {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = key === 'projects' ? 'project-item' : 'experience-item';
        div.innerHTML = itemTemplate(item, index, key);
        container.appendChild(div);
      });
      // Add button
      const btn = document.createElement('button');
      btn.className = 'add-item-btn';
      btn.textContent = `+ Add ${key.slice(0, -1)}`;
      btn.onclick = () => addNewItem(key);
      container.appendChild(btn);
    };

    const renderExperience = (experience) => {
      renderList('experience', 'experience-container', (item, index) => `
        <div class="item-header">
          <input type="text" class="item-title-input" value="${item.title || ''}" placeholder="Job Title" data-field="title" data-index="${index}" data-key="experience" disabled>
          <button class="delete-btn owner-controls" onclick="deleteItem('experience', ${index})">×</button>
        </div>
        <input type="text" class="item-company-input" value="${item.company || ''}" placeholder="Company" data-field="company" data-index="${index}" data-key="experience" disabled>
        <input type="text" class="item-date-input" value="${item.duration || ''}" placeholder="Jan 2020 - Present" data-field="duration" data-index="${index}" data-key="experience" disabled>
        <textarea class="item-description-input" data-field="description" data-index="${index}" data-key="experience" placeholder="Describe your role and achievements..." disabled>${item.description || ''}</textarea>
      `, experience);
    };

    const renderProjects = (projects) => {
      renderList('projects', 'projects-container', (item, index) => `
        <div class="item-header">
          <input type="text" class="item-title-input" value="${item.name || ''}" placeholder="Project Name" data-field="name" data-index="${index}" data-key="projects" disabled>
          <button class="delete-btn owner-controls" onclick="deleteItem('projects', ${index})">×</button>
        </div>
        <input type="url" class="item-company-input" value="${item.url || ''}" placeholder="https://project.com" data-field="url" data-index="${index}" data-key="projects" disabled>
        <textarea class="item-description-input" data-field="description" data-index="${index}" data-key="projects" placeholder="Project description and technologies used..." disabled>${item.description || ''}</textarea>
      `, projects);
    };

    const renderEducation = (education) => {
      renderList('education', 'education-container', (item, index) => `
        <div class="item-header">
          <input type="text" class="item-title-input" value="${item.degree || ''}" placeholder="Degree" data-field="degree" data-index="${index}" data-key="education" disabled>
          <button class="delete-btn owner-controls" onclick="deleteItem('education', ${index})">×</button>
        </div>
        <input type="text" class="item-company-input" value="${item.school || ''}" placeholder="School/University" data-field="school" data-index="${index}" data-key="education" disabled>
        <input type="text" class="item-date-input" value="${item.year || ''}" placeholder="2016 - 2020" data-field="year" data-index="${index}" data-key="education" disabled>
      `, education);
    };

    // Social links with icons (owner only)
    const renderSocialLinks = (social) => {
      const container = document.getElementById('social-links');
      container.innerHTML = '';
      const platforms = [
        { name: 'LinkedIn', icon: 'fab fa-linkedin', placeholder: 'linkedin.com/in/username' },
        { name: 'GitHub', icon: 'fab fa-github', placeholder: 'github.com/username' },
        { name: 'Twitter', icon: 'fab fa-twitter', placeholder: 'twitter.com/username' },
        { name: 'Portfolio', icon: 'fas fa-globe', placeholder: 'yourwebsite.com' }
      ];
      
      platforms.forEach(platform => {
        const input = document.createElement('div');
        input.className = 'social-input';
        input.innerHTML = `
          <i class="${platform.icon} social-icon"></i>
          <input type="url" placeholder="${platform.placeholder}" value="${social[platform.name] || ''}" data-platform="${platform.name}">
        `;
        container.appendChild(input);
      });
    };

    // Toggle edit mode for section
    document.querySelectorAll('.edit-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.id.replace('edit-', '').replace('-btn', '');
        editMode[section] = !editMode[section];
        
        // Update button text
        btn.textContent = editMode[section] ? 'Done' : 'Edit';
        btn.classList.toggle('active', editMode[section]);
        
        // Enable/disable inputs in that section
        const container = section === 'about' ? 
          document.getElementById('bio-textarea').parentElement : 
          document.getElementById(`${section}-container`);
        
        container.querySelectorAll('input, textarea').forEach(input => {
          input.disabled = !editMode[section];
        });
        
        // Show/hide add/delete buttons
        container.querySelectorAll('.add-item-btn, .delete-btn').forEach(btn => {
          btn.style.display = editMode[section] ? 'block' : 'none';
        });
        
        // Focus first input
        if (editMode[section]) {
          const firstInput = container.querySelector('input:not([disabled]), textarea:not([disabled])');
          if (firstInput) firstInput.focus();
        }
      });
    });

    // Add new item
    window.addNewItem = (key) => {
      const portfolioRef = ref(db, `portfolios/${targetUserId}`);
      const currentItems = [...(portfolioData[key] || [])];
      const newItem = key === 'experience' ? 
        { title: '', company: '', duration: '', description: '' } :
        key === 'projects' ? 
        { name: '', url: '', description: '' } :
        { degree: '', school: '', year: '' };
      currentItems.push(newItem);
      update(portfolioRef, { [key]: currentItems });
    };

    window.deleteItem = (key, index) => {
      const portfolioRef = ref(db, `portfolios/${targetUserId}`);
      const currentItems = [...(portfolioData[key] || [])];
      currentItems.splice(index, 1);
      update(portfolioRef, { [key]: currentItems });
    };

    // Auto-save functionality
    let saveTimeout;
    document.addEventListener('input', (e) => {
      if (!isOwner) return; // Don't save if not owner
      
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        const portfolioRef = ref(db, `portfolios/${targetUserId}`);
        const updates = {};
        
        if (e.target.dataset.field) {
          const { field, index, key } = e.target.dataset;
          const currentItems = [...(portfolioData[key] || [])];
          currentItems[index][field] = e.target.value;
          updates[key] = currentItems;
        } else if (e.target.id === 'name-input') {
          updates.name = e.target.value;
          // Also update user profile
          update(ref(db, `users/${targetUserId}`), { displayName: e.target.value });
        } else if (e.target.id === 'title-input') {
          updates.title = e.target.value;
        } else if (e.target.id === 'location-input') {
          updates.location = e.target.value;
        } else if (e.target.id === 'bio-textarea') {
          updates.bio = e.target.value;
        } else if (e.target.dataset.platform) {
          updates.social = { ...(portfolioData.social || {}), [e.target.dataset.platform]: e.target.value };
        } else if (e.target.id.startsWith('contact-')) {
          const field = e.target.id.replace('contact-', '');
          updates.contact = { ...(portfolioData.contact || {}), [field]: e.target.value };
        }
        
        if (Object.keys(updates).length > 0) {
          update(portfolioRef, updates);
          showAlert('✓ Saved');
        }
      }, 1000);
    });

    // Avatar upload
    document.getElementById('edit-avatar-btn')?.addEventListener('click', () => {
      if (!isOwner) return;
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const fileRef = storageRef(storage, `profilePictures/${targetUserId}`);
          await uploadBytes(fileRef, file);
          const url = await getDownloadURL(fileRef);
          await update(ref(db, `users/${targetUserId}`), { photoURL: url });
          showAlert('Profile picture updated!');
        } catch (err) {
          console.error(err);
          showAlert('Upload failed');
        }
      };
      input.click();
    });

    // Share button - copies URL directly to clipboard
    document.getElementById('share-btn')?.addEventListener('click', async () => {
      if (!isOwner) return;
      
      const shareUrl = `${window.location.origin}${window.location.pathname}?user=${targetUserId}`;
      
      try {
        await navigator.clipboard.writeText(shareUrl);
        showAlert('✓ Portfolio link copied!');
      } catch (err) {
        console.error('Copy failed:', err);
        showAlert('Failed to copy link');
      }
    });

    // Download resume (owner only)
    document.getElementById('download-btn')?.addEventListener('click', () => {
      if (!isOwner) return;
      showAlert('Resume download feature coming soon!');
      // TODO: Generate PDF from portfolioData
    });

    // Auth state handler
    onAuthStateChanged(auth, async (user) => {
      const urlParams = new URLSearchParams(window.location.search);
      const paramUserId = urlParams.get('user');
      
      if (!user && !paramUserId) {
        location.href = 'login.html';
        return;
      }
      
      if (user) {
        await checkOwnership(user);
      } else {
        // Visitor without auth viewing public profile
        targetUserId = paramUserId;
        isOwner = false;
        document.body.classList.remove('is-owner');
        document.querySelectorAll('.owner-controls').forEach(el => el.style.display = 'none');
        document.getElementById('page-title').textContent = 'Portfolio';
        
        // Show visitor view elements
        document.querySelector('.non-owner-avatar').style.display = 'block';
        document.getElementById('visitor-name').style.display = 'flex';
        document.getElementById('visitor-title').style.display = 'block';
        document.getElementById('visitor-location').style.display = 'block';
        
        // Hide sections for visitors
        ['skills', 'experience', 'projects', 'education', 'contact'].forEach(section => {
          const el = document.getElementById(`${section}-section`);
          if (el) el.style.display = 'none';
        });
        
        await loadPortfolio(targetUserId);
      }
    });
  </script>

</body>
</html>
