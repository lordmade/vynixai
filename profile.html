<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Profile • Vynix</title>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Symbols+Rounded" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff;
      --text:#161823; --text2:#86878b;
      --border:#e3e3e4; --accent:#ff2a6d;
      --btn-bg:#f1f1f2;
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000;
      --text:#ffffff; --text2:#71767b;
      --border:#2f3336; --btn-bg:#2f2f2f;
    }
    *{ -webkit-user-select:none !important; user-select:none !important;
       -webkit-touch-callout:none !important; -webkit-tap-highlight-color:transparent !important; }
    input,textarea,button{ -webkit-user-select:auto !important; user-select:text !important; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg); color:var(--text); padding-bottom:85px; margin:0;}
    .btn-secondary{background:var(--btn-bg); color:var(--text); font-weight:600; transition:0.2s;}
    .btn-secondary:active{transform:scale(0.98); opacity:0.8;}
    ::-webkit-scrollbar{display:none;}
    .toast{position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px);
           background:rgba(0,0,0,0.8); color:#fff; padding:12px 24px; border-radius:999px;
           font-size:14px; opacity:0; transition:all .4s ease; z-index:99;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
    .spinner{border:3px solid rgba(255,255,255,.3); border-top:3px solid var(--accent); border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* PERFECT TWITTER/X FOLLOW BUTTON */
    #followBtn{
      min-width: 120px;
      padding: 10px 24px;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 15px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #followBtn.follow {
      background: var(--accent);
      color: white;
    }
    #followBtn.following {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    #followBtn.following:hover {
      background: rgba(244,33,46,.1);
      border-color: #f4212e;
      color: #f4212e;
    }
    #followBtn.following:hover span {
      display: none;
    }
    #followBtn.following:hover::after {
      content: "Unfollow";
      color: #f4212e;
      font-weight: 700;
    }
    [data-theme="dark"] #followBtn.following:hover {
      background: rgba(244,33,46,.15);
    }

    #global-shimmer{
      position:fixed; inset:0; z-index:100;
      background:var(--bg);
      display:flex; align-items:center; justify-content:center;
      opacity:1; pointer-events:auto; transition:opacity .3s;
    }
    #global-shimmer.hidden{opacity:0; pointer-events:none;}
    .shimmer-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:0.5px; width:100%; max-width:400px;}
    .shimmer-cell{aspect-ratio:3/4; background:linear-gradient(90deg,var(--border)25%,rgba(255,255,255,0.3)50%,var(--border)75%); background-size:200%100%; animation:shimmer 1.2s infinite;}
    [data-theme="dark"] .shimmer-cell{background:linear-gradient(90deg,var(--border)25%,rgba(255,255,255,0.05)50%,var(--border)75%);}
    @keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}
  </style>
</head>
<body>
  <!-- GLOBAL SHIMMER -->
  <div id="global-shimmer">
    <div class="shimmer-grid">
      <div class="shimmer-cell"></div><div class="shimmer-cell"></div><div class="shimmer-cell"></div>
      <div class="shimmer-cell"></div><div class="shimmer-cell"></div><div class="shimmer-cell"></div>
      <div class="shimmer-cell"></div><div class="shimmer-cell"></div><div class="shimmer-cell"></div>
    </div>
  </div>

  <!-- Header -->
  <div class="sticky top-0 z-30 bg-[var(--bg)] border-b border-[var(--border)] h-12 flex items-center justify-between px-4">
    <div class="w-8"></div>
    <div class="font-bold text-lg flex items-center gap-1">
      <span id="navDisplayName">Loading...</span>
    </div>
    <button id="menuBtn" class="w-8 flex justify-end"><span class="material-icons">menu</span></button>
  </div>

  <!-- Profile Info -->
  <div class="pt-6 pb-2 px-4 text-center">
    <div class="relative mx-auto w-24 h-24 mb-3">
      <img id="profileAvatar" class="w-24 h-24 rounded-full object-cover border-2 border-[var(--border)]" src="" alt="avatar">
      <label for="avatarInput" id="avatarChangeBtn" class="absolute bottom-0 right-0 bg-[var(--accent)] text-white w-8 h-8 flex items-center justify-center rounded-full border-4 border-[var(--bg)] cursor-pointer shadow-lg text-lg">
        <span class="material-icons text-sm">add_a_photo</span>
      </label>
      <input type="file" id="avatarInput" accept="image/*" class="hidden">
    </div>

    <h2 id="displayName" class="text-xl font-bold leading-tight">@username</h2>
    <p id="bio" class="text-sm px-4 mb-4 whitespace-pre-wrap text-center leading-relaxed text-[var(--text2)] mt-2">No bio yet.</p>

    <div class="flex justify-center items-center gap-8 mt-5 mb-5">
      <div class="flex flex-col items-center"><span id="followingCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Following</span></div>
      <div class="flex flex-col items-center"><span id="followersCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Followers</span></div>
      <div class="flex flex-col items-center"><span id="likesCount" class="font-bold text-lg">0</span><span class="text-xs text-[var(--text2)]">Likes</span></div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 justify-center px-4 mb-6">
      <button id="editBtn" class="flex-1 btn-secondary py-2.5 rounded text-sm font-bold">Edit profile</button>
      
      <!-- PERFECT FOLLOW BUTTON -->
      <button id="followBtn" class="hidden">
        <span>Follow</span>
      </button>

      <button id="shareBtn" class="w-12 btn-secondary flex items-center justify-center rounded"><span class="material-icons-outlined">share</span></button>
    </div>

    <div class="flex items-center justify-center gap-4 text-xs text-[var(--text2)] mb-4">
      <span class="flex items-center gap-1 hidden" id="locationWrapper">
        <span class="material-icons text-sm">location_on</span> <span id="location">Earth</span>
      </span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="sticky top-12 z-20 bg-[var(--bg)] border-t border-b border-[var(--border)] h-10 flex items-center justify-center">
    <span class="text-xs font-bold uppercase tracking-widest text-[var(--accent)] flex items-center gap-2">
      <span class="material-icons text-base">grid_on</span> Media
    </span>
  </div>

  <!-- Media Grid -->
  <div id="postsGrid" class="grid grid-cols-3 gap-0.5 min-h-[300px] bg-[var(--bg)]"></div>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-[var(--border)] z-40">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <div id="toast" class="toast"></div>
  <div id="overlay" class="overlay hidden"><div class="spinner"></div></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const $ = s => document.querySelector(s);

    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
      document.body.setAttribute('data-theme', 'dark');

    const urlParams = new URLSearchParams(location.search);
    const viewedUid = urlParams.get('uid');
    let currentUid = null;
    let targetUid = null;
    let isOwner = false;
    const followBtn = $('#followBtn');

    function toast(msg) {
      $('#toast').textContent = msg;
      $('#toast').classList.add('show');
      setTimeout(() => $('#toast').classList.remove('show'), 2500);
    }

    // FIXED: Use correct path + set(null) for safe delete
    async function toggleFollow() {
      if (isOwner || !targetUid) return;

      const followingRef = ref(db, `social/${currentUid}/following/${targetUid}`);
      const followersRef = ref(db, `social/${targetUid}/followers/${currentUid}`);

      try {
        const snap = await get(followingRef);
        if (snap.exists()) {
          await set(followingRef, null);
          await set(followersRef, null);
          toast('Unfollowed');
        } else {
          await set(followingRef, true);
          await set(followersRef, true);
          toast('Now following');
        }
      } catch (err) {
        console.error('Follow error:', err);
        toast('Network error');
      }
    }

    function updateFollowButton(isFollowing) {
      followBtn.innerHTML = isFollowing ? '<span>Following</span>' : '<span>Follow</span>';
      followBtn.className = isFollowing ? 'following' : 'follow';
    }

    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }
      currentUid = user.uid;
      targetUid = viewedUid || currentUid;
      isOwner = currentUid === targetUid;

      $('#editBtn').style.display = isOwner ? 'block' : 'none';
      $('#shareBtn').style.display = isOwner ? 'flex' : 'none';
      $('#avatarChangeBtn').style.display = isOwner ? 'flex' : 'none';
      followBtn.classList.toggle('hidden', isOwner);

      loadProfile(targetUid);
      loadCounts(targetUid);
      loadMedia(targetUid);

      if (!isOwner) {
        const followingRef = ref(db, `social/${currentUid}/following/${targetUid}`);
        onValue(followingRef, snap => updateFollowButton(snap.exists()));
        followBtn.onclick = toggleFollow;
      }
    });

    function showGlobalShimmer(show = true) {
      $('#global-shimmer').classList.toggle('hidden', !show);
    }

    async function loadProfile(uid) {
      showGlobalShimmer(true);
      const fallbackName = 'User';
      const fallbackAvatar = `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${fallbackName}`;

      $('#profileAvatar').src = fallbackAvatar;
      $('#displayName').textContent = '@user';
      $('#navDisplayName').textContent = 'User';
      $('#bio').textContent = 'No bio yet.';
      $('#locationWrapper').classList.add('hidden');

      const profileRef = ref(db, `users/${uid}/profile`);
      onValue(profileRef, snap => {
        const p = snap.val() || {};
        const name = p.displayName || fallbackName;
        const avatar = p.avatar || fallbackAvatar;
        const bio = p.bio || 'No bio yet.';
        const location = p.location || '';

        $('#displayName').textContent = '@' + name.replace(/\s/g, '').toLowerCase();
        $('#navDisplayName').textContent = name;
        $('#profileAvatar').src = avatar;
        $('#bio').textContent = bio === '' ? 'No bio yet.' : bio;
        $('#location').textContent = location;
        $('#locationWrapper').classList.toggle('hidden', !location);
        showGlobalShimmer(false);
      });
    }

    function loadCounts(uid) {
      onValue(ref(db, `social/${uid}/following`), s => $('#followingCount').textContent = s.size || 0);
      onValue(ref(db, `social/${uid}/followers`), s => $('#followersCount').textContent = s.size || 0);
      const likesQuery = ref(db, 'likes');
      onValue(likesQuery, s => {
        let count = 0;
        s.forEach(post => {
          if (post.val()?.authorId === uid) count += Object.keys(post.val()).length - 1;
        });
        $('#likesCount').textContent = count;
      });
    }

    function loadMedia(uid) {
      showGlobalShimmer(true);
      const q = ref(db, 'posts');
      onValue(q, snap => {
        $('#postsGrid').innerHTML = '';
        const items = [];
        snap.forEach(child => {
          const p = child.val();
          if (p.authorId === uid && p.image) {
            const isVideo = p.image.includes('/video/upload') || p.image.endsWith('.mp4');
            items.push({ url: p.image, isVideo });
          }
        });
        if (!items.length) {
          $('#postsGrid').innerHTML = `<div class="col-span-3 text-center text-sm text-[var(--text2)] py-12">No posts with media yet</div>`;
        } else {
          items.reverse().forEach(i => {
            const div = document.createElement('div');
            div.className = 'relative aspect-[3/4] bg-black overflow-hidden';
            if (i.isVideo) {
              div.innerHTML = `<video class="w-full h-full object-cover" src="${i.url}" muted loop playsinline preload="metadata"></video>
                <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition"><span class="material-icons text-white text-6xl">play_circle</span></div>`;
            } else {
              div.innerHTML = `<img src="${i.url}" class="w-full h-full object-cover" loading="lazy">`;
            }
            div.onclick = () => i.isVideo ? openVideoModal(i.url) : openImageModal(i.url);
            $('#postsGrid').appendChild(div);
          });
        }
        showGlobalShimmer(false);
      });
    }

    window.openImageModal = src => {
      const wrap = document.createElement('div');
      wrap.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center';
      wrap.innerHTML = `<img src="${src}" class="max-w-[95%] max-h-[95%] object-contain rounded-lg">`;
      wrap.onclick = () => wrap.remove();
      document.body.appendChild(wrap);
    };

    window.openVideoModal = src => {
      const wrap = document.createElement('div');
      wrap.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center';
      wrap.innerHTML = `<video src="${src}" controls autoplay class="max-w-[95%] max-h-[95%] object-contain rounded-lg"></video>
        <span class="absolute top-4 right-4 text-white text-5xl cursor-pointer select-none">×</span>`;
      wrap.onclick = e => e.target.tagName !== 'VIDEO' && wrap.remove();
      document.body.appendChild(wrap);
    };

    // Your edit, avatar, menu code remains perfect
    $('#menuBtn').onclick = () => $('#menuDrawer').classList.remove('hidden');
    $('#closeMenu').onclick = $('#menuBackdrop').onclick = () => $('#menuDrawer').classList.add('hidden');
    $('#logoutBtn').onclick = async () => { await signOut(auth); location.href = 'login.html'; };
  </script>
</body>
</html>
