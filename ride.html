<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vynix Ride</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet">

    <style>
        :root {
            --bolt-green: #2fbb66;
            --venus-pink: #f472b6;
            --premium-gold: #fbbf24;
            --text-main: #111827;
            --text-sub: #6b7280;
            --bg-white: #ffffff;
        }

        /* --- Global Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; height: 100vh; overflow: hidden; }
        input { user-select: text; -webkit-user-select: text; }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }

        /* --- Searching/Waiting Overlay --- */
        #waitingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 1000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .pulse-loader {
            width: 90px; height: 90px; background: var(--bolt-green);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; margin-bottom: 25px;
            animation: pulse 1.5s infinite;
        }
        .pulse-loader span { color: white; font-size: 45px; }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(47, 187, 102, 0.4); }
            70% { transform: scale(1); box-shadow: 0 0 0 30px rgba(47, 187, 102, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(47, 187, 102, 0); }
        }

        /* --- Map Markers --- */
        .driver-marker {
            background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png');
            background-size: cover; width: 34px; height: 34px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .pickup-dot {
            width: 20px; height: 20px; background: #3b82f6;
            border: 4px solid white; border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        /* --- UI Navigation --- */
        .top-nav {
            position: absolute; top: 20px; left: 0; right: 0;
            z-index: 10; padding: 0 20px; display: flex; flex-direction: column; align-items: center;
        }
        .search-pill {
            width: 100%; max-width: 500px; background: white; border-radius: 50px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.12); position: relative;
        }
        .search-input-wrapper { display: flex; align-items: center; padding: 12px 20px; }
        .search-input-wrapper span { color: var(--bolt-green); margin-right: 12px; }
        #dropoffInput { flex: 1; border: none; font-size: 16px; background: transparent; }
        
        .suggestions-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            max-height: 250px; overflow-y: auto; display: none; z-index: 15;
        }
        .suggestion-item { padding: 14px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px; }

        .user-pill {
            align-self: flex-start; margin-top: 15px; background: white;
            padding: 8px 14px; border-radius: 30px; display: flex;
            align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .user-pill img { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }

        /* --- Bottom Ride Sheet --- */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-top-left-radius: 28px; border-top-right-radius: 28px;
            padding: 20px; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); z-index: 20;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }
        .bottom-sheet.active { transform: translateY(0); }

        .ride-option {
            display: flex; align-items: center; padding: 16px;
            border: 2px solid #f3f4f6; border-radius: 18px; margin-bottom: 12px; cursor: pointer;
        }
        .ride-option.selected { border-color: var(--bolt-green); background: #f0fdf4; }
        .ride-option.venus.selected { border-color: var(--venus-pink); background: #fdf2f8; }
        .car-img { width: 60px; margin-right: 15px; }
        .ride-info { flex: 1; }
        .ride-info h4 { font-size: 15px; font-weight: 700; }
        .ride-info p { font-size: 12px; color: var(--text-sub); }
        .price-tag { font-weight: 800; font-size: 16px; }

        .confirm-btn {
            width: 100%; background: var(--bolt-green); color: white; border: none;
            padding: 18px; border-radius: 18px; font-weight: 700; font-size: 17px;
        }
        #toast {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: #111; color: #fff; padding: 12px 24px; border-radius: 30px;
            font-size: 13px; z-index: 9999; display: none;
        }
    </style>
</head>
<body>

    <div id="waitingOverlay">
        <div class="pulse-loader" id="loaderIcon">
            <span class="material-symbols-rounded">directions_car</span>
        </div>
        <h2 id="waitTitle">Searching for Drivers</h2>
        <p id="waitSub" style="color:var(--text-sub); margin-top:10px; padding: 0 40px;">Request sent to global node. Waiting for a driver to accept...</p>
        <button onclick="cancelBooking()" style="margin-top:40px; background:none; border:none; color:var(--text-sub); font-weight:600; text-decoration:underline; cursor:pointer;">Cancel Request</button>
    </div>

    <div id="toast"></div>

    <div class="top-nav">
        <div class="search-pill" id="searchPill">
            <div class="search-input-wrapper">
                <span class="material-symbols-rounded">search</span>
                <input type="text" id="dropoffInput" placeholder="Where to?" autocomplete="off">
            </div>
            <div class="suggestions-dropdown" id="suggestions"></div>
        </div>
        <div class="user-pill">
            <img id="uAvatar" src="https://ui-avatars.com/api/?name=User&background=2fbb66&color=fff">
            <span id="uName">Vynix User</span>
        </div>
    </div>

    <div id="map"></div>

    <div class="bottom-sheet" id="rideSheet">
        <div style="width: 40px; height: 4px; background: #e5e7eb; margin: -10px auto 15px; border-radius: 10px;"></div>
        
        <div class="ride-option selected" id="opt-lite" onclick="selectRide('opt-lite', 7, 'Vynix Lite')">
            <img src="https://cdn-icons-png.flaticon.com/512/3202/3202926.png" class="car-img">
            <div class="ride-info"><h4>Vynix Lite</h4><p>Toyota Corolla • Max 3 People</p></div>
            <div class="price-tag" id="pr-lite">R 0</div>
        </div>

        <div class="ride-option venus" id="opt-venus" onclick="selectRide('opt-venus', 8, 'Vynix Venus')">
            <img src="https://cdn-icons-png.flaticon.com/512/3430/3430485.png" class="car-img">
            <div class="ride-info"><h4>Vynix Venus</h4><p>Female Drivers Only • Safety First</p></div>
            <div class="price-tag" id="pr-venus">R 0</div>
        </div>

        <button class="confirm-btn" id="mainActionBtn" onclick="initiateBooking()">Confirm Vynix Lite</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <script>
        // 1. INITIALIZATION
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';

        let currentUser = null, userProfile = null;
        let pickupCoords = null, dropoffCoords = null, totalKm = 0;
        let selectedRate = 7, selectedName = 'Vynix Lite', activeRideKey = null;
        const driverMarkers = {};

        // 2. MAP & LAYERS
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [28.2293, -25.7479],
            zoom: 12
        });

        map.on('load', () => {
            map.addSource('route-line', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [] }}});
            map.addLayer({
                id: 'route-line', type: 'line', source: 'route-line',
                paint: { 'line-color': '#2fbb66', 'line-width': 5, 'line-opacity': 0.75 }
            });
        });

        const pMarker = new mapboxgl.Marker({ element: createMarkerEl('pickup-dot') });
        const dMarker = new mapboxgl.Marker({ color: '#2fbb66' });

        function createMarkerEl(cls) {
            const el = document.createElement('div'); el.className = cls; return el;
        }

        // 3. AUTH & LIVE DRIVER TRACKING
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadProfile();
                trackDrivers();
                locateUser();
            } else { window.location.href = "login.html"; }
        });

        async function loadProfile() {
            const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            userProfile = snap.val() || { name: 'Vynix Lingua', gender: 'Female' };
            document.getElementById('uName').innerText = userProfile.name;
            document.getElementById('uAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfile.name)}&background=2fbb66&color=fff`;
        }

        function trackDrivers() {
            db.ref('driversAvailable').on('value', snap => {
                const drivers = snap.val();
                if (!drivers) return;
                Object.keys(drivers).forEach(id => {
                    const d = drivers[id];
                    if (driverMarkers[id]) {
                        driverMarkers[id].setLngLat([d.lng, d.lat]);
                    } else {
                        const el = document.createElement('div'); el.className = 'driver-marker';
                        driverMarkers[id] = new mapboxgl.Marker(el).setLngLat([d.lng, d.lat]).addTo(map);
                    }
                });
            });
        }

        function locateUser() {
            navigator.geolocation.getCurrentPosition(pos => {
                pickupCoords = [pos.coords.longitude, pos.coords.latitude];
                map.flyTo({ center: pickupCoords, zoom: 14 });
                pMarker.setLngLat(pickupCoords).addTo(map);
            });
        }

        // 4. SEARCH & ROUTING
        const dropoffInput = document.getElementById('dropoffInput');
        const suggestionsBox = document.getElementById('suggestions');
        const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, marker: false });

        dropoffInput.addEventListener('input', () => {
            const query = dropoffInput.value;
            if (query.length > 2) geocoder.query(query);
            else suggestionsBox.style.display = 'none';
        });

        geocoder.on('results', (e) => {
            suggestionsBox.innerHTML = '';
            if (!e.features.length) return;
            e.features.forEach(f => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = f.place_name;
                item.onclick = () => {
                    dropoffInput.value = f.place_name;
                    suggestionsBox.style.display = 'none';
                    dropoffCoords = f.geometry.coordinates;
                    dMarker.setLngLat(dropoffCoords).addTo(map);
                    getVynixRoute();
                };
                suggestionsBox.appendChild(item);
            });
            suggestionsBox.style.display = 'block';
        });

        async function getVynixRoute() {
            const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${pickupCoords[0]},${pickupCoords[1]};${dropoffCoords[0]},${dropoffCoords[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const data = await res.json();
            const route = data.routes[0];
            totalKm = (route.distance / 1000).toFixed(1);

            map.getSource('route-line').setData(route.geometry);
            const bounds = new mapboxgl.LngLatBounds().extend(pickupCoords).extend(dropoffCoords);
            map.fitBounds(bounds, { padding: 80 });

            document.getElementById('pr-lite').innerText = `R ${(totalKm * 7).toFixed(0)}`;
            document.getElementById('pr-venus').innerText = `R ${(totalKm * 8).toFixed(0)}`;
            document.getElementById('rideSheet').classList.add('active');
        }

        // 5. BOOKING LOGIC
        function selectRide(id, rate, name) {
            if (name === 'Vynix Venus' && userProfile.gender !== 'Female') {
                showToast("Vynix Venus is restricted to female passengers."); return;
            }
            document.querySelectorAll('.ride-option').forEach(o => o.classList.remove('selected'));
            document.getElementById(id).classList.add('selected');
            selectedRate = rate; selectedName = name;
            document.getElementById('mainActionBtn').innerText = `Confirm ${name}`;
        }

        async function initiateBooking() {
            document.getElementById('rideSheet').classList.remove('active');
            document.getElementById('waitingOverlay').style.display = 'flex';

            const request = {
                riderId: currentUser.uid,
                riderName: userProfile.name,
                pickup: { lng: pickupCoords[0], lat: pickupCoords[1] },
                dropoff: { lng: dropoffCoords[0], lat: dropoffCoords[1] },
                fare: (totalKm * selectedRate).toFixed(2),
                status: 'pending',
                ts: Date.now()
            };

            const ref = db.ref('rideRequests').push();
            activeRideKey = ref.key;
            await ref.set(request);

            // Listen for acceptance
            db.ref(`rideRequests/${activeRideKey}`).on('value', snap => {
                const val = snap.val();
                if (val && val.status === 'accepted') {
                    document.getElementById('loaderIcon').style.background = '#3b82f6';
                    document.getElementById('waitTitle').innerText = "Driver Found!";
                    document.getElementById('waitSub').innerText = `${val.driverName} is on the way in a ${val.carModel || 'Vynix Car'}.`;
                }
            });
        }

        async function cancelBooking() {
            if (activeRideKey) {
                await db.ref(`rideRequests/${activeRideKey}`).remove();
                document.getElementById('waitingOverlay').style.display = 'none';
                activeRideKey = null;
            }
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
