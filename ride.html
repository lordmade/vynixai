<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vynix Ride</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet">

    <style>
        :root {
            --bolt-green: #2fbb66;
            --text-main: #111827;
            --text-sub: #6b7280;
            --bg-white: #ffffff;
            --error: #ef4444;
        }

        /* --- Global Reset & Mobile Polish --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none; /* Prevents long-press menu */
            -webkit-user-select: none;   /* Prevents text selection highlight */
            user-select: none;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: #f3f4f6; 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
        }

        /* Allow typing in inputs */
        input, .mapboxgl-ctrl-geocoder--input {
            -webkit-user-select: text;
            user-select: text;
        }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }

        /* Disable clicks on Mapbox watermarks */
        .mapboxgl-ctrl-logo, 
        .mapboxgl-ctrl-attrib {
            pointer-events: none !important;
            cursor: default !important;
        }

        /* --- Top Navigation / Search --- */
        .top-interface {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            padding: 0 20px;
        }

        .search-container {
            width: 100%;
            max-width: 500px;
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            padding: 4px 12px;
        }

        .search-icon { color: var(--bolt-green); margin-right: 8px; font-variation-settings: 'FILL' 1; }

        .mapboxgl-ctrl-geocoder {
            width: 100% !important;
            box-shadow: none !important;
            background: transparent !important;
            max-width: none !important;
            font-family: 'Inter', sans-serif;
        }

        .user-badge {
            align-self: flex-start;
            margin-top: 15px;
            background: var(--bg-white);
            padding: 8px 14px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .user-badge img { width: 24px; height: 24px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .user-badge span { font-size: 13px; font-weight: 600; color: var(--text-main); }

        /* --- Bottom Ride Sheet --- */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border-top-left-radius: 28px;
            border-top-right-radius: 28px;
            padding: 20px 24px 34px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
            z-index: 20;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
        }

        .bottom-sheet.active { transform: translateY(0); }

        .handle {
            width: 40px;
            height: 4px;
            background: #e5e7eb;
            margin: -10px auto 20px;
            border-radius: 10px;
        }

        .ride-card {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #f3f4f6;
            border-radius: 20px;
            margin-bottom: 24px;
            background: #fafafa;
        }

        .ride-card .icon-box {
            font-size: 36px;
            margin-right: 16px;
            color: var(--bolt-green);
        }

        .ride-info { flex: 1; }
        .ride-info h4 { font-size: 17px; font-weight: 700; margin-bottom: 2px; }
        .ride-info p { font-size: 13px; color: var(--text-sub); }

        .price-tag { font-size: 20px; font-weight: 800; color: var(--text-main); }

        .confirm-btn {
            width: 100%;
            background: var(--bolt-green);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 18px;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(47, 187, 102, 0.3);
        }

        .confirm-btn:active { transform: scale(0.98); opacity: 0.9; }

        /* --- Map Markers --- */
        .pickup-dot {
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        #toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: #fff;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="top-interface">
        <div class="search-container">
            <span class="material-symbols-rounded search-icon">search</span>
            <div id="geocoder"></div>
        </div>
        
        <div class="user-badge" id="userPill">
            <img id="userAvatar" src="https://ui-avatars.com/api/?name=Vynix+Lingua&background=2fbb66&color=fff">
            <span id="userName">Vynix Lingua</span>
        </div>
    </div>

    <div id="map"></div>

    <div class="bottom-sheet" id="rideSheet">
        <div class="handle"></div>
        <div class="ride-card">
            <span class="material-symbols-rounded icon-box">directions_car</span>
            <div class="ride-info">
                <h4>Vynix Economy</h4>
                <p id="route-stats">Detecting best route...</p>
            </div>
            <div class="price-tag" id="ridePrice">R 0.00</div>
        </div>
        <button class="confirm-btn" onclick="bookRide()">Confirm Vynix Ride</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const RATE_PER_KM = 10;
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';

        let currentUser = null;
        let pickupCoords = null;
        let dropoffCoords = null;
        let finalDistance = 0;

        // --- 2. MAP INITIALIZATION ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [28.2293, -25.7479], // Default center (Pretoria/Gauteng area)
            zoom: 12,
            pitch: 45
        });

        const pickupMarker = new mapboxgl.Marker(createPickupEl());
        const dropoffMarker = new mapboxgl.Marker({ color: '#2fbb66' });

        function createPickupEl() {
            const el = document.createElement('div');
            el.className = 'pickup-dot';
            return el;
        }

        // --- 3. AUTH & GEOLOCATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUser();
                initLocation();
            } else {
                window.location.href = "login.html";
            }
        });

        async function loadUser() {
            const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            const data = snap.val();
            if (data) {
                document.getElementById('userName').innerText = data.name;
                if(data.photo) document.getElementById('userAvatar').src = data.photo;
            }
        }

        function initLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        pickupCoords = [pos.coords.longitude, pos.coords.latitude];
                        map.flyTo({ center: pickupCoords, zoom: 15 });
                        pickupMarker.setLngLat(pickupCoords).addTo(map);
                    },
                    () => showToast("Please enable location to book a ride.")
                );
            }
        }

        // --- 4. SEARCH & ROUTING ---
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Where to?',
            marker: false,
            proximity: { longitude: 28.2, latitude: -25.7 } // Prioritize local results
        });
        document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

        geocoder.on('result', (e) => {
            dropoffCoords = e.result.geometry.coordinates;
            dropoffMarker.setLngLat(dropoffCoords).addTo(map);
            calculateRoute(dropoffCoords);
        });

        async function calculateRoute(end) {
            if (!pickupCoords) {
                showToast("Detecting your location...");
                return;
            }

            try {
                const query = await fetch(
                    `https://api.mapbox.com/directions/v5/mapbox/driving/${pickupCoords[0]},${pickupCoords[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`
                );
                const json = await query.json();
                const data = json.routes[0];
                
                // Draw Line
                const routeData = {
                    type: 'Feature',
                    geometry: data.geometry
                };

                if (map.getSource('route')) {
                    map.getSource('route').setData(routeData);
                } else {
                    map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: { type: 'geojson', data: routeData },
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#2fbb66', 'line-width': 5, 'line-opacity': 0.8 }
                    });
                }

                // Stats & Pricing
                finalDistance = (data.distance / 1000).toFixed(1);
                const duration = Math.floor(data.duration / 60);
                const price = (finalDistance * RATE_PER_KM).toFixed(2);

                document.getElementById('route-stats').innerText = `${finalDistance} km â€¢ ${duration} min away`;
                document.getElementById('ridePrice').innerText = `R ${price}`;
                
                // UI Show
                document.getElementById('rideSheet').classList.add('active');
                
                // Fit map
                const bounds = new mapboxgl.LngLatBounds().extend(pickupCoords).extend(end);
                map.fitBounds(bounds, { padding: {top: 150, bottom: 300, left: 50, right: 50} });

            } catch (err) {
                showToast("Route calculation failed.");
            }
        }

        // --- 5. BOOKING ---
        async function bookRide() {
            showToast("Connecting to Vynix drivers...");
            
            const rideRequest = {
                riderId: currentUser.uid,
                pickup: { lat: pickupCoords[1], lng: pickupCoords[0] },
                dropoff: { lat: dropoffCoords[1], lng: dropoffCoords[0] },
                distance: finalDistance,
                fare: (finalDistance * RATE_PER_KM).toFixed(2),
                status: 'pending',
                createdAt: Date.now()
            };

            try {
                await db.ref('rideRequests').push(rideRequest);
                document.getElementById('rideSheet').classList.remove('active');
                showToast("Request sent! Waiting for driver...");
            } catch (err) {
                showToast("Error requesting ride.");
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3500);
        }
    </script>
</body>
</html>
