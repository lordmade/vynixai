<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vynix Ride | Master</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet">

    <style>
        :root {
            --bolt-green: #2fbb66;
            --venus-pink: #f472b6;
            --premium-gold: #fbbf24;
            --text-main: #111827;
            --text-sub: #6b7280;
            --bg-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; height: 100vh; overflow: hidden; }
        input { user-select: text; -webkit-user-select: text; }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }

        /* --- UI Overlays --- */
        #waitingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .pulse-loader {
            width: 80px; height: 80px; background: var(--bolt-green); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(47, 187, 102, 0.5); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(47, 187, 102, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(47, 187, 102, 0); }
        }

        /* --- Navigation & Search --- */
        .top-nav {
            position: absolute; top: 20px; left: 0; right: 0; z-index: 10; padding: 0 15px;
            display: flex; flex-direction: column; align-items: center;
        }
        .search-card {
            width: 100%; max-width: 450px; background: white; border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); padding: 5px;
        }
        #geocoder { width: 100%; }
        .mapboxgl-ctrl-geocoder { width: 100% !important; box-shadow: none !important; }

        /* --- Bottom Sheet --- */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0; background: white;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            padding: 20px 20px 40px; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); z-index: 20;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }
        .bottom-sheet.active { transform: translateY(0); }

        .ride-option {
            display: flex; align-items: center; padding: 14px; border: 2px solid #f3f4f6;
            border-radius: 18px; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
        }
        .ride-option.selected { border-color: var(--bolt-green); background: #f0fdf4; }
        .ride-option.venus.selected { border-color: var(--venus-pink); background: #fdf2f8; }
        
        .car-thumb { width: 50px; height: 50px; margin-right: 15px; }
        .ride-meta { flex: 1; }
        .ride-meta h4 { font-size: 15px; font-weight: 700; }
        .ride-meta p { font-size: 12px; color: var(--text-sub); }
        .fare-txt { font-weight: 800; font-size: 17px; }

        .promo-row {
            display: flex; align-items: center; background: #f9fafb;
            padding: 10px 15px; border-radius: 12px; margin-bottom: 15px;
        }
        #promoInput { border: none; background: transparent; flex: 1; font-size: 13px; font-weight: 600; }

        .confirm-btn {
            width: 100%; background: var(--bolt-green); color: white; border: none;
            padding: 18px; border-radius: 18px; font-weight: 700; font-size: 17px;
        }

        #toast {
            position: fixed; top: 110px; left: 50%; transform: translateX(-50%);
            background: #111; color: #fff; padding: 10px 20px; border-radius: 20px;
            font-size: 13px; z-index: 9999; display: none;
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="waitingOverlay">
        <div class="pulse-loader"><span class="material-symbols-rounded" style="color:white; font-size:40px;">local_taxi</span></div>
        <h2 id="waitTitle">Finding your Vynix...</h2>
        <p id="waitSub" style="color:var(--text-sub); margin-top:8px;">Drivers in your area are being notified.</p>
        <button onclick="cancelBooking()" style="margin-top:30px; background:none; border:none; color:var(--text-sub); text-decoration:underline;">Cancel</button>
    </div>

    <div class="top-nav">
        <div class="search-card">
            <div id="geocoder"></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="bottom-sheet" id="rideSheet">
        <div style="width: 40px; height: 4px; background: #eee; margin: -10px auto 15px; border-radius: 10px;"></div>
        
        <div class="ride-option selected" id="opt-lite" onclick="selectRide('opt-lite', 7, 'Vynix Lite')">
            <img src="https://cdn-icons-png.flaticon.com/512/3202/3202926.png" class="car-thumb">
            <div class="ride-meta"><h4>Vynix Lite</h4><p id="eta-lite">Calculating...</p></div>
            <div class="fare-txt" id="pr-lite">R 0</div>
        </div>

        <div class="ride-option venus" id="opt-venus" onclick="selectRide('opt-venus', 8, 'Vynix Venus')">
            <img src="https://cdn-icons-png.flaticon.com/512/3430/3430485.png" class="car-thumb">
            <div class="ride-meta"><h4>Vynix Venus</h4><p id="eta-venus">Female Drivers Only</p></div>
            <div class="fare-txt" id="pr-venus">R 0</div>
        </div>

        <div class="promo-row">
            <span class="material-symbols-rounded" style="font-size:18px; margin-right:8px; color:var(--bolt-green)">sell</span>
            <input type="text" id="promoInput" placeholder="Enter Promo Code">
            <button onclick="applyPromo()" style="background:none; border:none; color:var(--bolt-green); font-weight:700;">Apply</button>
        </div>

        <button class="confirm-btn" id="mainActionBtn" onclick="initiateBooking()">Confirm Vynix Lite</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <script>
        // 1. INITIALIZE
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';

        let pickupCoords = null, dropoffCoords = null;
        let totalKm = 0, selectedRate = 7, selectedName = 'Vynix Lite';
        let discount = 1.0; // 1.0 = no discount

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [28.22, -25.74], zoom: 12
        });

        // 2. MARKERS
        const pMarker = new mapboxgl.Marker({ color: '#3b82f6' });
        const dMarker = new mapboxgl.Marker({ color: '#2fbb66', draggable: true });

        dMarker.on('dragend', () => {
            dropoffCoords = [dMarker.getLngLat().lng, dMarker.getLngLat().lat];
            getVynixRoute();
        });

        // 3. ROUTE ANIMATION SETUP
        map.on('load', () => {
            map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [] }}});
            map.addLayer({
                id: 'route-line', type: 'line', source: 'route',
                paint: { 'line-color': '#2fbb66', 'line-width': 5, 'line-dasharray': [0, 2, 2] }
            });

            let step = 0;
            function animate() {
                step = (step + 0.2) % 4;
                map.setPaintProperty('route-line', 'line-dasharray', [0, step, 2]);
                requestAnimationFrame(animate);
            }
            animate();
        });

        // 4. CORE LOGIC
        auth.onAuthStateChanged(user => {
            if (user) locateUser();
            else window.location.href = "login.html";
        });

        function locateUser() {
            navigator.geolocation.getCurrentPosition(pos => {
                pickupCoords = [pos.coords.longitude, pos.coords.latitude];
                pMarker.setLngLat(pickupCoords).addTo(map);
                map.flyTo({ center: pickupCoords, zoom: 14 });
            });
        }

        const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, marker: false });
        document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

        geocoder.on('result', (e) => {
            dropoffCoords = e.result.geometry.coordinates;
            dMarker.setLngLat(dropoffCoords).addTo(map);
            getVynixRoute();
            showToast("Tip: Drag the green pin to refine dropoff");
        });

        async function getVynixRoute() {
            if (!pickupCoords || !dropoffCoords) return;
            const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${pickupCoords[0]},${pickupCoords[1]};${dropoffCoords[0]},${dropoffCoords[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const data = await res.json();
            const route = data.routes[0];
            totalKm = (route.distance / 1000).toFixed(1);

            map.getSource('route').setData(route.geometry);
            const bounds = new mapboxgl.LngLatBounds().extend(pickupCoords).extend(dropoffCoords);
            map.fitBounds(bounds, { padding: {top: 50, bottom: 350, left: 50, right: 50} });

            updateUI();
        }

        function updateUI() {
            document.getElementById('pr-lite').innerText = `R ${(totalKm * 7 * discount).toFixed(0)}`;
            document.getElementById('pr-venus').innerText = `R ${(totalKm * 8 * discount).toFixed(0)}`;
            document.getElementById('eta-lite').innerText = `${totalKm} km away`;
            document.getElementById('rideSheet').classList.add('active');
        }

        function selectRide(id, rate, name) {
            document.querySelectorAll('.ride-option').forEach(o => o.classList.remove('selected'));
            document.getElementById(id).classList.add('selected');
            selectedRate = rate; selectedName = name;
            document.getElementById('mainActionBtn').innerText = `Confirm ${name}`;
            document.getElementById('mainActionBtn').style.background = (name === 'Vynix Venus') ? 'var(--venus-pink)' : 'var(--bolt-green)';
        }

        function applyPromo() {
            const code = document.getElementById('promoInput').value.toUpperCase();
            if (code === 'VYNIX50') {
                discount = 0.5;
                showToast("50% Discount Applied!");
                updateUI();
            } else {
                showToast("Invalid Promo Code");
            }
        }

        async function initiateBooking() {
            document.getElementById('rideSheet').classList.remove('active');
            document.getElementById('waitingOverlay').style.display = 'flex';
            
            const rideId = db.ref('rideRequests').push().key;
            await db.ref(`rideRequests/${rideId}`).set({
                rider: auth.currentUser.uid,
                pickup: pickupCoords,
                dropoff: dropoffCoords,
                fare: (totalKm * selectedRate * discount).toFixed(2),
                status: 'pending',
                type: selectedName
            });

            // Auto-cancel if no driver for demo
            setTimeout(() => {
                db.ref(`rideRequests/${rideId}`).on('value', snap => {
                    if (snap.val()?.status === 'accepted') {
                        document.getElementById('waitTitle').innerText = "Driver Found!";
                        document.getElementById('waitSub').innerText = "Your Vynix is 3 mins away.";
                    }
                });
            }, 1000);
        }

        function cancelBooking() {
            document.getElementById('waitingOverlay').style.display = 'none';
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
