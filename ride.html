<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vynix Ride</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet">

    <style>
        :root {
            --bolt-green: #2fbb66;
            --venus-pink: #f472b6;
            --premium-gold: #fbbf24;
            --text-main: #111827;
            --text-sub: #6b7280;
            --bg-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; height: 100vh; overflow: hidden; user-select: none; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }

        /* --- Searching/Waiting Overlay --- */
        #waitingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 1000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .pulse-loader {
            width: 80px; height: 80px; background: var(--bolt-green);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        .pulse-loader span { color: white; font-size: 40px; }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(47, 187, 102, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(47, 187, 102, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(47, 187, 102, 0); }
        }

        /* --- Map Markers --- */
        .driver-marker {
            background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png');
            background-size: cover; width: 35px; height: 35px; cursor: pointer;
            transition: all 0.5s ease-out;
        }

        /* --- UI Elements --- */
        .top-nav {
            position: absolute; top: 20px; left: 0; right: 0;
            z-index: 10; padding: 0 20px; display: flex; flex-direction: column; align-items: center;
        }
        .search-bar {
            width: 100%; max-width: 500px; background: white; border-radius: 16px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.12); display: flex; align-items: center; padding: 4px 12px;
        }
        .mapboxgl-ctrl-geocoder { width: 100% !important; box-shadow: none !important; background: transparent !important; }

        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-top-left-radius: 28px; border-top-right-radius: 28px;
            padding: 20px 20px 34px; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); z-index: 20;
        }
        .bottom-sheet.active { transform: translateY(0); }
        .ride-option {
            display: flex; align-items: center; padding: 12px 16px;
            border: 2px solid #f3f4f6; border-radius: 18px; margin-bottom: 10px; cursor: pointer;
        }
        .ride-option.selected { border-color: var(--bolt-green); background: #f0fdf4; }
        .confirm-btn {
            width: 100%; background: var(--bolt-green); color: white; border: none;
            padding: 18px; border-radius: 18px; font-weight: 700; font-size: 18px; margin-top: 10px;
        }

        #toast {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: #111; color: #fff; padding: 12px 24px; border-radius: 30px;
            font-size: 13px; z-index: 9999; display: none;
        }
    </style>
</head>
<body>

    <div id="waitingOverlay">
        <div class="pulse-loader">
            <span class="material-symbols-rounded">directions_car</span>
        </div>
        <h2 id="waitStatus">Searching for Driver...</h2>
        <p style="color:var(--text-sub); margin-top:10px;">Finding you the best ride at the best price.</p>
        <button onclick="cancelRide()" style="margin-top:40px; background:none; border:none; color:var(--text-sub); font-weight:600; text-decoration:underline;">Cancel Request</button>
    </div>

    <div id="toast"></div>

    <div class="top-nav">
        <div class="search-bar">
            <span class="material-symbols-rounded" style="color:var(--bolt-green)">search</span>
            <div id="geocoder"></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="bottom-sheet" id="rideSheet">
        <div style="width: 40px; height: 4px; background: #e5e7eb; margin: -10px auto 15px; border-radius: 10px;"></div>
        <div id="rideOptionsList">
            <div class="ride-option selected" id="opt-lite" onclick="selectRide('opt-lite', 7, 'Vynix Lite')">
                <span class="material-symbols-rounded" style="font-size:32px; margin-right:15px;">bolt</span>
                <div style="flex:1"><h4>Vynix Lite</h4><p>Max 2 People</p></div>
                <div class="price" id="p-lite">R 0</div>
            </div>
            </div>
        <button class="confirm-btn" id="confirmBtn" onclick="confirmBooking()">Confirm Vynix Lite</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <script>
        // --- 1. CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';

        let currentUser = null, userProfile = null;
        let pickupCoords = null, dropoffCoords = null, currentDist = 0;
        let activeRideId = null;
        const driverMarkers = {}; // Keep track of moving drivers

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [28.2293, -25.7479],
            zoom: 12
        });

        const pickupMarker = new mapboxgl.Marker({ color: '#3b82f6' });
        const dropoffMarker = new mapboxgl.Marker({ color: '#2fbb66' });

        // --- 2. LIVE DRIVER TRACKING ---
        function startTrackingDrivers() {
            // Listen to the global available drivers node
            db.ref('driversAvailable').on('value', (snapshot) => {
                const drivers = snapshot.val();
                if (!drivers) return;

                Object.keys(drivers).forEach(id => {
                    const driver = drivers[id];
                    const coords = [driver.lng, driver.lat];

                    if (driverMarkers[id]) {
                        // Move existing marker smoothly
                        driverMarkers[id].setLngLat(coords);
                    } else {
                        // Create new car marker
                        const el = document.createElement('div');
                        el.className = 'driver-marker';
                        driverMarkers[id] = new mapboxgl.Marker(el)
                            .setLngLat(coords)
                            .addTo(map);
                    }
                });
            });

            // Remove drivers who go offline
            db.ref('driversAvailable').on('child_removed', (snapshot) => {
                const id = snapshot.key;
                if (driverMarkers[id]) {
                    driverMarkers[id].remove();
                    delete driverMarkers[id];
                }
            });
        }

        // --- 3. BOOKING LOGIC ---
        auth.onAuthStateChanged(user => {
            if (user) { 
                currentUser = user; 
                startTrackingDrivers(); 
                getUserLoc(); 
            } else { 
                window.location.href = "login.html"; 
            }
        });

        function getUserLoc() {
            navigator.geolocation.getCurrentPosition(p => {
                pickupCoords = [p.coords.longitude, p.coords.latitude];
                map.setCenter(pickupCoords);
                pickupMarker.setLngLat(pickupCoords).addTo(map);
            });
        }

        const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, marker: false });
        document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

        geocoder.on('result', (e) => {
            dropoffCoords = e.result.geometry.coordinates;
            dropoffMarker.setLngLat(dropoffCoords).addTo(map);
            showRidePricing();
        });

        async function showRidePricing() {
            const query = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${pickupCoords[0]},${pickupCoords[1]};${dropoffCoords[0]},${dropoffCoords[1]}?access_token=${mapboxgl.accessToken}`);
            const json = await query.json();
            currentDist = (json.routes[0].distance / 1000).toFixed(1);
            document.getElementById('p-lite').innerText = `R ${(currentDist * 7).toFixed(0)}`;
            document.getElementById('rideSheet').classList.add('active');
        }

        async function confirmBooking() {
            document.getElementById('rideSheet').classList.remove('active');
            document.getElementById('waitingOverlay').style.display = 'flex';

            const rideRequest = {
                riderId: currentUser.uid,
                pickup: { lng: pickupCoords[0], lat: pickupCoords[1] },
                dropoff: { lng: dropoffCoords[0], lat: dropoffCoords[1] },
                fare: (currentDist * 7).toFixed(2),
                status: 'pending', // Waiting for driver to accept
                ts: Date.now()
            };

            const ref = db.ref('rideRequests').push();
            activeRideId = ref.key;
            await ref.set(rideRequest);

            // LISTEN FOR DRIVER ACCEPTANCE
            db.ref(`rideRequests/${activeRideId}`).on('value', (snap) => {
                const ride = snap.val();
                if (ride && ride.status === 'accepted') {
                    document.getElementById('waitStatus').innerText = "Driver Found! On the way.";
                    document.querySelector('.pulse-loader').style.background = "#3b82f6";
                    setTimeout(() => {
                        // Transition to active ride UI (e.g. driver profile)
                        alert("Your Vynix driver has accepted the ride!");
                    }, 2000);
                }
            });
        }

        async function cancelRide() {
            if (activeRideId) {
                await db.ref(`rideRequests/${activeRideId}`).remove();
                document.getElementById('waitingOverlay').style.display = 'none';
                activeRideId = null;
            }
        }
    </script>
</body>
</html>
