<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Video Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --card-bg: #f9fafb;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border: #e5e7eb;
      --accent: #7c3aed;
      --gradient: linear-gradient(45deg, #3b82f6, #a855f7);
      --progress-bar: #3b82f6;
      --progress-bg: rgba(255, 255, 255, 0.3);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --subscribed-bg: #d1d5db;
      --unsubscribed-bg: #000000;
    }

    [data-theme="dark"] {
      --bg: #1f2937;
      --card-bg: #374151;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --border: #4b5563;
      --progress-bar: #60a5fa;
      --progress-bg: rgba(0, 0, 0, 0.3);
      --subscribed-bg: #6b7280;
      --unsubscribed-bg: #000000;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
      overscroll-behavior: none;
    }

    .video-player {
      max-width: 1440px;
      margin: 0 auto;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding-bottom: 50vh;
    }

    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 8px;
      background-color: #000;
      user-select: none;
      -webkit-user-select: none;
    }

    .video-container video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 8px;
    }

    .custom-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      padding: 1rem 1rem 0.5rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .video-container:hover .custom-controls,
    .video-container.touched .custom-controls {
      opacity: 1;
    }

    .control-top {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: space-between;
    }

    .control-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .play-pause-btn, .fullscreen-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .play-pause-btn:hover, .fullscreen-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .progress-container {
      position: relative;
      height: 4px;
      background-color: var(--progress-bg);
      border-radius: 2px;
      margin: 0.5rem 0;
      cursor: pointer;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--progress-bar);
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s ease;
    }

    .progress-handle {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background-color: var(--progress-bar);
      border-radius: 50%;
      right: 0;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .progress-container:hover .progress-handle,
    .progress-container.dragging .progress-handle {
      opacity: 1;
    }

    .time-display {
      display: flex;
      justify-content: space-between;
      color: white;
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
    }

    #thumbnail-preview {
      position: absolute;
      z-index: 15;
      display: none;
      pointer-events: none;
      bottom: 3rem;
      border: 1px solid rgba(255,255,255,0.8);
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      background: black;
      transform: translateX(-50%);
    }

    #preview-img {
      display: block;
      width: 160px;
      height: 90px;
      object-fit: cover;
    }

    .video-info {
      padding: 0.5rem 0;
    }

    .video-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .suggested-videos {
      padding: 0.5rem 0;
      display: none;
    }

    .suggested-videos.active {
      display: block;
    }

    .suggested-video-card {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: 8px;
      background-color: var(--card-bg);
      margin-bottom: 0.5rem;
      transition: transform 0.2s;
    }

    .suggested-video-card:hover {
      transform: translateY(-2px);
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50vh;
      background-color: var(--bg);
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 20;
      transition: transform 0.3s ease;
    }

    .sheet-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    #comments-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .sheet-footer {
      padding: 1rem;
      border-top: 1px solid var(--border);
      background-color: var(--bg);
      flex-shrink: 0;
    }

    .comment-card {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s;
    }

    .comment-card:hover {
      background-color: var(--card-bg);
    }

    .comment-form {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 9999px;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }

    .comment-input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 0.5rem;
      color: var(--text-primary);
      font-size: 0.875rem;
      outline: none;
      resize: none;
      line-height: 1.25;
    }

    .comment-input::placeholder {
      color: var(--text-secondary);
    }

    .comment-submit {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient);
      color: #ffffff;
      border-radius: 50%;
      width: 2rem;
      height: 2rem;
      transition: transform 0.2s;
    }

    .comment-submit:hover {
      transform: scale(1.1);
    }

    .avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient);
      color: #ffffff;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 50%;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
    }

    .action-btn:hover {
      background-color: var(--border);
      transform: translateY(-1px);
    }

    .subscribe-btn.subscribed {
      background-color: var(--subscribed-bg);
    }

    .subscribe-btn:not(.subscribed) {
      background-color: var(--unsubscribed-bg);
      color: #ffffff;
    }

    .like-btn.liked {
      background-color: var(--subscribed-bg);
    }

    .like-btn.liked .material-icons {
      content: 'thumb_up';
    }

    .theme-toggle {
      position: fixed;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--card-bg);
      border-radius: 50%;
      padding: 0.5rem;
      cursor: pointer;
      z-index: 70;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 2rem;
      height: 2rem;
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .custom-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      color: var(--text-primary);
      font-size: 1rem;
      z-index: 100;
      display: none;
      max-width: 90%;
      text-align: center;
      box-shadow: var(--shadow);
      max-height: 80vh;
      overflow-y: auto;
    }

    .custom-alert.active {
      display: block;
    }

    .custom-alert .alert-content {
      margin-bottom: 1rem;
    }

    .custom-alert .alert-actions {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }

    .alert-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .alert-btn.primary {
      background: var(--gradient);
      color: white;
    }

    .alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
      display: none;
    }

    .alert-overlay.active {
      display: block;
    }

    @media (min-width: 1024px) {
      .video-player {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 1rem;
        padding: 1rem;
        padding-bottom: 40vh;
      }
      .suggested-videos {
        display: block;
      }
      .bottom-sheet {
        height: 40vh;
      }
      .video-container {
        border-radius: 12px;
      }
      .action-btn, .comment-input {
        font-size: 0.875rem;
      }
      .avatar {
        font-size: 0.875rem;
      }
      .spinner {
        width: 2.5rem;
        height: 2.5rem;
      }
    }

    @media (max-width: 640px) {
      .video-info {
        padding: 0.25rem 0;
      }
      .video-title {
        font-size: 1rem;
      }
      .video-meta, .channel-name {
        font-size: 0.75rem;
      }
      .comment-card {
        padding: 0.25rem 0;
      }
      .comment-card p {
        font-size: 0.75rem;
      }
      .bottom-sheet {
        height: 60vh;
      }
      .video-player {
        padding-bottom: 60vh;
      }
      .custom-controls {
        padding: 0.5rem 0.5rem 0.25rem;
      }
      .time-display {
        font-size: 0.7rem;
      }
      #thumbnail-preview {
        bottom: 2.5rem;
      }
      #preview-img {
        width: 120px;
        height: 68px;
      }
      .play-pause-btn, .fullscreen-btn {
        width: 2.5rem;
        height: 2.5rem;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle material-icons" title="Toggle Theme">brightness_6</button>
  <main class="video-player">
    <div class="main-content">
      <div class="video-container">
        <video id="video-player" autoplay aria-label="Video player"></video>
        <div class="custom-controls">
          <div class="control-top">
            <div class="control-left">
              <button id="play-pause-btn" class="play-pause-btn material-icons" title="Play/Pause">play_arrow</button>
            </div>
            <button id="fullscreen-btn" class="fullscreen-btn material-icons" title="Fullscreen">fullscreen</button>
          </div>
          <div class="time-display">
            <span id="current-time">0:00</span>
            <span id="duration">0:00</span>
          </div>
          <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
            <div class="progress-handle" id="progress-handle"></div>
          </div>
        </div>
        <video id="preview-video" style="display:none;" muted></video>
        <canvas id="preview-canvas" style="display:none;"></canvas>
        <div id="thumbnail-preview">
          <img id="preview-img">
        </div>
      </div>
      <div class="video-info">
        <h1 id="video-title" class="video-title text-xl font-bold"></h1>
        <div class="flex items-center mt-2 gap-2">
          <div id="channel-avatar" class="h-8 w-8 rounded-full"></div>
          <div>
            <p id="channel-name" class="channel-name text-sm font-semibold"></p>
            <p id="video-meta" class="video-meta text-xs text-[var(--text-secondary)]"></p>
          </div>
        </div>
        <div class="video-actions">
          <button id="subscribe-btn" class="action-btn subscribe-btn" title="Subscribe to Channel">Subscribe</button>
          <button id="save-btn" class="action-btn" title="Save to Library">
            <span class="material-icons text-sm">bookmark_add</span> Save
          </button>
          <button id="like-btn" class="action-btn like-btn" title="Like Video">
            <span class="material-icons text-sm">thumb_up</span> Like <span id="like-count">0</span>
          </button>
          <button id="share-btn" class="action-btn" title="Share Video">
            <span class="material-icons text-sm">share</span> Share
          </button>
        </div>
      </div>
    </div>
    <div class="suggested-videos">
      <h2 class="text-base font-semibold mb-3">Suggested Videos</h2>
      <div class="suggested-video-card">
        <div class="w-1/3 bg-gray-200 rounded-md"></div>
        <div class="flex-1">
          <p class="text-sm font-medium">Video Title</p>
          <p class="text-xs text-[var(--text-secondary)]">Channel Name • 1M views • 2 days ago</p>
        </div>
      </div>
    </div>
  </main>

  <div class="bottom-sheet">
    <div class="sheet-header">
      <h2 class="text-base font-semibold mb-3">Comments</h2>
    </div>
    <div id="comments-list" class="flex flex-col gap-2"></div>
    <div class="sheet-footer">
      <form id="comment-form" class="comment-form">
        <textarea id="comment-input" class="comment-input" placeholder="Add a comment..." aria-label="Comment input"></textarea>
        <button type="submit" class="comment-submit" title="Post comment">
          <span class="material-icons text-sm">send</span>
        </button>
      </form>
    </div>
  </div>

  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>

  <div id="alert-overlay" class="alert-overlay"></div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-content" id="alert-content"></div>
    <div class="alert-actions">
      <button id="alert-ok" class="alert-btn primary">OK</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, push } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    let app, auth, db, currentUser, videoId;

    const showSpinner = () => {
      document.getElementById('spinner-overlay').classList.add('active');
    };

    const hideSpinner = () => {
      document.getElementById('spinner-overlay').classList.remove('active');
    };

    const showAlert = (message, options = {}) => {
      const { title, type = 'info', showCancel = false, onOk, onCancel } = options;
      const alert = document.getElementById('custom-alert');
      const content = document.getElementById('alert-content');
      const overlay = document.getElementById('alert-overlay');
      const okBtn = document.getElementById('alert-ok');

      content.innerHTML = `<h3>${title || 'Alert'}</h3><p>${message}</p>`;

      if (showCancel) {
        const actions = alert.querySelector('.alert-actions');
        actions.innerHTML = `
          <button class="alert-btn" id="alert-cancel">Cancel</button>
          <button class="alert-btn primary" id="alert-ok">OK</button>
        `;
        document.getElementById('alert-cancel').addEventListener('click', () => {
          hideCustomAlert();
          if (onCancel) onCancel();
        });
      } else {
        actions.innerHTML = `<button id="alert-ok" class="alert-btn primary">OK</button>`;
      }

      okBtn.addEventListener('click', () => {
        hideCustomAlert();
        if (onOk) onOk();
      });

      alert.classList.add('active');
      overlay.classList.add('active');
    };

    const hideCustomAlert = () => {
      const alert = document.getElementById('custom-alert');
      const overlay = document.getElementById('alert-overlay');
      alert.classList.remove('active');
      overlay.classList.remove('active');
    };

    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      body.setAttribute('data-theme', currentTheme);
      localStorage.setItem('theme', currentTheme);
    }

    function formatNumber(count) {
      if (count >= 1_000_000) return `${(count / 1_000_000).toFixed(1)}M`;
      if (count >= 1_000) return `${(count / 1_000).toFixed(1)}K`;
      return count.toString();
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getDatabase(app);
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            loadVideo();
            loadComments();
          } else {
            showAlert('Please log in to view this video.', { onOk: () => window.location.href = 'signup.html' });
          }
        }, (error) => {
          console.error('Auth state error:', error);
          showAlert('Authentication error. Please try again.');
        });
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showAlert('Failed to initialize Firebase. Please check your connection.');
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHr = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHr / 24);
      if (diffSec < 60) return `${diffSec} second${diffSec === 1 ? '' : 's'} ago`;
      if (diffMin < 60) return `${diffMin} minute${diffMin === 1 ? '' : 's'} ago`;
      if (diffHr < 24) return `${diffHr} hour${diffHr === 1 ? '' : 's'} ago`;
      return `${diffDay} day${diffDay === 1 ? '' : 's'} ago`;
    }

    async function saveToLibrary(videoId) {
      if (!currentUser) {
        showAlert('Please log in to save videos.', { onOk: () => {} });
        return;
      }
      try {
        const libraryRef = ref(db, `users/${currentUser.uid}/library/${videoId}`);
        await set(libraryRef, true);
        showAlert('Video saved to library!');
      } catch (error) {
        console.error('Error saving video to library:', error);
        showAlert('Failed to save video. Please try again.');
      }
    }

    async function likeVideo(videoId, likeBtn, likeCountEl) {
      if (!currentUser) {
        showAlert('Please log in to like videos.', { onOk: () => {} });
        return;
      }
      try {
        const likeRef = ref(db, `shorts/${videoId}/likes/${currentUser.uid}`);
        const snapshot = await new Promise((resolve) => onValue(likeRef, resolve, { onlyOnce: true }));
        const isLiked = snapshot.exists();
        if (isLiked) {
          await set(likeRef, null); // Unlike
          likeBtn.classList.remove('liked');
          likeBtn.querySelector('.material-icons').textContent = 'thumb_up';
          showAlert('Video unliked.');
        } else {
          await set(likeRef, true); // Like
          likeBtn.classList.add('liked');
          likeBtn.querySelector('.material-icons').textContent = 'thumb_up';
          showAlert('Video liked!');
        }
        // Update like count
        const likesRef = ref(db, `shorts/${videoId}/likes`);
        onValue(likesRef, (snapshot) => {
          const likes = snapshot.val() || {};
          likeCountEl.textContent = formatNumber(Object.keys(likes).length);
        }, { onlyOnce: true });
      } catch (error) {
        console.error('Error liking/unliking video:', error);
        showAlert('Failed to update like status. Please try again.');
      }
    }

    async function shareVideo() {
      try {
        await navigator.clipboard.writeText(window.location.href);
        showAlert('Link copied to clipboard!');
      } catch (error) {
        console.error('Error sharing video:', error);
        showAlert('Failed to copy link. Please try again.');
      }
    }

    async function subscribeToChannel(channelId, subscribeBtn) {
      if (!currentUser) {
        showAlert('Please log in to subscribe.', { onOk: () => {} });
        return;
      }
      try {
        const subscriptionRef = ref(db, `users/${currentUser.uid}/subscriptions/${channelId}`);
        const snapshot = await new Promise((resolve) => onValue(subscriptionRef, resolve, { onlyOnce: true }));
        const isSubscribed = snapshot.exists();
        if (isSubscribed) {
          await set(subscriptionRef, null); // Unsubscribe
          subscribeBtn.classList.remove('subscribed');
          subscribeBtn.textContent = 'Subscribe';
          showAlert('Unsubscribed successfully!');
        } else {
          await set(subscriptionRef, true); // Subscribe
          subscribeBtn.classList.add('subscribed');
          subscribeBtn.textContent = 'Subscribed';
          showAlert('Subscribed successfully!');
        }
        // Update subscriber count
        const subscribersRef = ref(db, `users/${channelId}/subscribers`);
        onValue(subscribersRef, (snapshot) => {
          const subscribers = snapshot.val() || {};
          document.getElementById('channel-name').textContent = `${channelData?.displayName || 'Unknown Channel'} • ${formatNumber(Object.keys(subscribers).length)} subscribers`;
        }, { onlyOnce: true });
      } catch (error) {
        console.error('Error subscribing/unsubscribing:', error);
        showAlert('Failed to update subscription. Please try again.');
      }
    }

    let channelData; // Store channel data for subscriber count updates

    async function loadVideo() {
      showSpinner();
      const urlParams = new URLSearchParams(window.location.search);
      videoId = urlParams.get('videoId');
      if (!videoId) {
        showAlert('No video ID provided.', { onOk: () => window.location.href = 'index.html' });
        return;
      }
      const videoRef = ref(db, `shorts/${videoId}`);
      try {
        onValue(videoRef, async (snapshot) => {
          if (!snapshot.exists()) {
            showAlert('Video not found.', { onOk: () => window.location.href = 'index.html' });
            return;
          }
          const videoData = snapshot.val();
          const userRef = ref(db, `users/${videoData.userId}`);
          const subscribeBtn = document.getElementById('subscribe-btn');
          const likeBtn = document.getElementById('like-btn');
          const likeCountEl = document.getElementById('like-count');
          const video = document.getElementById('video-player');
          const previewVideo = document.getElementById('preview-video');
          await new Promise((resolve) => {
            onValue(userRef, (userSnapshot) => {
              channelData = userSnapshot.val();
              video.src = videoData.mediaURL;
              previewVideo.src = videoData.mediaURL;
              previewVideo.muted = true;
              document.getElementById('video-title').textContent = videoData.caption || 'Untitled Video';
              document.getElementById('video-meta').textContent = `${formatNumber(Object.keys(videoData.views || {}).length)} views • ${formatTimestamp(videoData.timestamp)}`;
              const channelAvatar = document.getElementById('channel-avatar');
              if (channelData?.photoURL) {
                channelAvatar.style.background = 'none';
                channelAvatar.innerHTML = `<img src="${channelData.photoURL}" alt="${channelData.displayName || 'User'} avatar" class="h-8 w-8 rounded-full">`;
              } else {
                const initial = channelData?.displayName ? channelData.displayName[0].toUpperCase() : 'U';
                channelAvatar.textContent = initial;
                channelAvatar.classList.add('avatar');
              }
              // Set data attributes
              document.getElementById('save-btn').setAttribute('data-video-id', videoId);
              subscribeBtn.setAttribute('data-channel-id', videoData.userId);
              likeBtn.setAttribute('data-video-id', videoId);
              // Update subscriber count
              const subscribersRef = ref(db, `users/${videoData.userId}/subscribers`);
              onValue(subscribersRef, (snapshot) => {
                const subscribers = snapshot.val() || {};
                document.getElementById('channel-name').textContent = `${channelData?.displayName || 'Unknown Channel'} • ${formatNumber(Object.keys(subscribers).length)} subscribers`;
              }, { onlyOnce: true });
              // Check subscription status
              if (currentUser) {
                const subscriptionRef = ref(db, `users/${currentUser.uid}/subscriptions/${videoData.userId}`);
                onValue(subscriptionRef, (snapshot) => {
                  if (snapshot.exists()) {
                    subscribeBtn.classList.add('subscribed');
                    subscribeBtn.textContent = 'Subscribed';
                  } else {
                    subscribeBtn.classList.remove('subscribed');
                    subscribeBtn.textContent = 'Subscribe';
                  }
                }, { onlyOnce: true });
              }
              // Update like count and status
              const likesRef = ref(db, `shorts/${videoId}/likes`);
              onValue(likesRef, (snapshot) => {
                const likes = snapshot.val() || {};
                likeCountEl.textContent = formatNumber(Object.keys(likes).length);
                if (currentUser) {
                  const userLikeRef = ref(db, `shorts/${videoId}/likes/${currentUser.uid}`);
                  onValue(userLikeRef, (userSnapshot) => {
                    if (userSnapshot.exists()) {
                      likeBtn.classList.add('liked');
                      likeBtn.querySelector('.material-icons').textContent = 'thumb_up';
                    } else {
                      likeBtn.classList.remove('liked');
                      likeBtn.querySelector('.material-icons').textContent = 'thumb_up';
                    }
                  }, { onlyOnce: true });
                }
              }, { onlyOnce: true });
              resolve();
            }, { onlyOnce: true });
          });
          // Update view count
          const viewsRef = ref(db, `shorts/${videoId}/views/${currentUser.uid}`);
          await set(viewsRef, true);
          hideSpinner();
        }, (error) => {
          console.error('Error loading video:', error);
          showAlert('Failed to load video. Please try again.');
          hideSpinner();
        });
      } catch (error) {
        console.error('Error fetching video:', error);
        showAlert('Failed to load video. Please check your connection.');
        hideSpinner();
      }
    }

    async function loadComments() {
      const commentsRef = ref(db, `shorts/${videoId}/comments`);
      const commentsList = document.getElementById('comments-list');
      try {
        onValue(commentsRef, async (snapshot) => {
          commentsList.innerHTML = '';
          if (!snapshot.exists()) {
            commentsList.innerHTML = '<p class="text-[var(--text-secondary)] text-sm">No comments yet.</p>';
            return;
          }
          const comments = snapshot.val();
          const commentArray = Object.entries(comments)
            .map(([commentId, commentData]) => ({ commentId, ...commentData }))
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          for (const comment of commentArray) {
            const userRef = ref(db, `users/${comment.userId}`);
            await new Promise((resolve) => {
              onValue(userRef, (userSnapshot) => {
                const userData = userSnapshot.val();
                const commentCard = document.createElement('div');
                commentCard.className = 'comment-card';
                commentCard.innerHTML = `
                  <div class="flex">
                    ${userData?.photoURL
                      ? `<img src="${userData.photoURL}" alt="${userData.displayName || 'User'} avatar" class="h-6 w-6 rounded-full mr-2">`
                      : `<div class="h-6 w-6 rounded-full mr-2 avatar">${userData?.displayName ? userData.displayName[0].toUpperCase() : 'U'}</div>`}
                    <div class="flex-1">
                      <p class="text-sm font-semibold">${userData?.displayName || 'Unknown User'} • <span class="text-xs text-[var(--text-secondary)]">${formatTimestamp(comment.timestamp)}</span></p>
                      <p class="text-sm mt-1">${comment.text}</p>
                    </div>
                  </div>
                `;
                commentsList.appendChild(commentCard);
                resolve();
              }, { onlyOnce: true });
            });
          }
        }, (error) => {
          console.error('Error loading comments:', error);
          showAlert('Failed to load comments. Please try again.');
        });
      } catch (error) {
        console.error('Error fetching comments:', error);
        showAlert('Failed to load comments. Please check your connection.');
      }
    }

    async function handleCommentSubmit(e) {
      e.preventDefault();
      if (!currentUser) {
        showAlert('Please log in to post comments.', { onOk: () => {} });
        return;
      }
      const commentText = document.getElementById('comment-input').value.trim();
      if (!commentText) {
        showAlert('Please enter a comment.');
        return;
      }
      showSpinner();
      try {
        const commentsRef = ref(db, `shorts/${videoId}/comments`);
        const newCommentRef = push(commentsRef);
        await set(newCommentRef, {
          text: commentText,
          userId: currentUser.uid,
          timestamp: new Date().toISOString()
        });
        document.getElementById('comment-form').reset();
        showAlert('Comment posted successfully!');
      } catch (error) {
        console.error('Error posting comment:', error);
        showAlert('Failed to post comment. Please try again.');
      } finally {
        hideSpinner();
      }
    }

    document.getElementById('save-btn').addEventListener('click', () => {
      saveToLibrary(videoId);
    });

    document.getElementById('subscribe-btn').addEventListener('click', () => {
      const channelId = document.getElementById('subscribe-btn').getAttribute('data-channel-id');
      const subscribeBtn = document.getElementById('subscribe-btn');
      subscribeToChannel(channelId, subscribeBtn);
    });

    document.getElementById('like-btn').addEventListener('click', () => {
      const likeBtn = document.getElementById('like-btn');
      const likeCountEl = document.getElementById('like-count');
      likeVideo(videoId, likeBtn, likeCountEl);
    });

    document.getElementById('share-btn').addEventListener('click', () => {
      shareVideo();
    });

    document.querySelector('.theme-toggle').addEventListener('click', toggleTheme);

    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      initializeFirebase();
      document.getElementById('comment-form').addEventListener('submit', handleCommentSubmit);

      // Custom controls: play/pause
      const video = document.getElementById('video-player');
      const playPauseBtn = document.getElementById('play-pause-btn');
      playPauseBtn.addEventListener('click', () => {
        if (video.paused) {
          video.play();
          playPauseBtn.textContent = 'pause';
        } else {
          video.pause();
          playPauseBtn.textContent = 'play_arrow';
        }
      });

      video.addEventListener('play', () => playPauseBtn.textContent = 'pause');
      video.addEventListener('pause', () => playPauseBtn.textContent = 'play_arrow');

      // Fullscreen functionality
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      const videoContainer = document.querySelector('.video-container');

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          videoContainer.requestFullscreen().catch(err => {
            console.error('Error entering fullscreen:', err);
          });
        } else {
          document.exitFullscreen();
        }
      }

      fullscreenBtn.addEventListener('click', toggleFullscreen);

      document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
          fullscreenBtn.textContent = 'fullscreen_exit';
          fullscreenBtn.title = 'Exit Fullscreen';
        } else {
          fullscreenBtn.textContent = 'fullscreen';
          fullscreenBtn.title = 'Fullscreen';
        }
      });

      // Custom seek bar functionality
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressHandle = document.getElementById('progress-handle');
      const currentTimeEl = document.getElementById('current-time');
      const durationEl = document.getElementById('duration');
      const previewVideo = document.getElementById('preview-video');
      const previewCanvas = document.getElementById('preview-canvas');
      const thumbnailPreview = document.getElementById('thumbnail-preview');
      const previewImg = document.getElementById('preview-img');

      previewCanvas.width = 160;
      previewCanvas.height = 90;

      previewVideo.addEventListener('seeked', () => {
        const ctx = previewCanvas.getContext('2d');
        ctx.drawImage(previewVideo, 0, 0, 160, 90);
        previewImg.src = previewCanvas.toDataURL('image/jpeg', 0.8);
        thumbnailPreview.style.display = 'block';
      });

      let isDragging = false;

      function updateProgress() {
        if (video.duration) {
          const progress = (video.currentTime / video.duration) * 100;
          progressBar.style.width = `${progress}%`;
          progressHandle.style.left = `${progress}%`;
          currentTimeEl.textContent = formatTime(video.currentTime);
          if (durationEl.textContent === '0:00') {
            durationEl.textContent = formatTime(video.duration);
          }
        }
      }

      function setVideoTime(e) {
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        if (!clientX) return;
        const rect = progressContainer.getBoundingClientRect();
        const pos = clientX - rect.left;
        const width = rect.width;
        const time = (pos / width) * video.duration;
        video.currentTime = Math.max(0, Math.min(time, video.duration));
      }

      function updatePreviewPosition(clientX) {
        const rect = progressContainer.getBoundingClientRect();
        const pos = clientX - rect.left;
        const percent = Math.max(0, Math.min(1, pos / rect.width));
        thumbnailPreview.style.left = `${percent * 100}%`;
        thumbnailPreview.style.transform = 'translateX(-50%)';
      }

      function handlePreviewMove(e) {
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        if (!clientX) return;
        const rect = progressContainer.getBoundingClientRect();
        const pos = clientX - rect.left;
        if (pos < 0 || pos > rect.width) return;
        const percent = pos / rect.width;
        const time = percent * video.duration;
        if (video.duration > 0 && time >= 0 && time <= video.duration) {
          previewVideo.currentTime = time;
          updatePreviewPosition(clientX);
        }
      }

      video.addEventListener('loadedmetadata', updateProgress);
      video.addEventListener('timeupdate', updateProgress);
      video.addEventListener('durationchange', updateProgress);

      // Mouse events for desktop
      progressContainer.addEventListener('mousedown', (e) => {
        isDragging = true;
        progressContainer.classList.add('dragging');
        setVideoTime(e);
        updatePreviewPosition(e.clientX);
        e.preventDefault();
      });

      progressContainer.addEventListener('mousemove', handlePreviewMove);

      progressContainer.addEventListener('mouseleave', () => {
        thumbnailPreview.style.display = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          setVideoTime(e);
          updatePreviewPosition(e.clientX);
        }
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          progressContainer.classList.remove('dragging');
          thumbnailPreview.style.display = 'none';
        }
      });

      // Touch events for mobile
      progressContainer.addEventListener('touchstart', (e) => {
        isDragging = true;
        progressContainer.classList.add('dragging');
        document.body.classList.add('touched');
        setVideoTime(e);
        updatePreviewPosition(e.touches[0].clientX);
        e.preventDefault();
      }, { passive: false });

      progressContainer.addEventListener('touchmove', handlePreviewMove, { passive: false });

      progressContainer.addEventListener('touchend', () => {
        thumbnailPreview.style.display = 'none';
      });

      progressContainer.addEventListener('touchcancel', () => {
        thumbnailPreview.style.display = 'none';
      });

      document.addEventListener('touchmove', (e) => {
        if (isDragging) {
          setVideoTime(e);
          updatePreviewPosition(e.touches[0].clientX);
          e.preventDefault();
        }
      }, { passive: false });

      document.addEventListener('touchend', () => {
        if (isDragging) {
          isDragging = false;
          progressContainer.classList.remove('dragging');
          setTimeout(() => document.body.classList.remove('touched'), 3000);
          thumbnailPreview.style.display = 'none';
        }
      });

      // Long press handling for fast forward
      let pressTimer;
      let isPressing = false;

      const startPress = (e) => {
        if (e.type === 'touchstart') e.preventDefault();
        isPressing = true;
        pressTimer = setTimeout(() => {
          if (isPressing && !video.paused && video.currentTime < video.duration) {
            video.currentTime += 2;
          }
          isPressing = false;
        }, 500);
      };

      const endPress = (e) => {
        if (e.type === 'touchend') e.preventDefault();
        isPressing = false;
        clearTimeout(pressTimer);
      };

      video.addEventListener('mousedown', startPress);
      video.addEventListener('mouseup', endPress);
      video.addEventListener('mouseleave', endPress);
      video.addEventListener('touchstart', startPress, { passive: false });
      video.addEventListener('touchend', endPress, { passive: false });
      video.addEventListener('touchcancel', endPress);
      video.addEventListener('contextmenu', (e) => e.preventDefault());

      // Overlay click to play/pause
      videoContainer.addEventListener('click', (e) => {
        if (e.target === videoContainer) {
          playPauseBtn.click();
        }
      });
    });
  </script>
</body>
</html>
