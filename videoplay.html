<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Video Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://vjs.zencdn.net/8.16.2/video-js.css" rel="stylesheet" />
  <style>
    :root {
      --bg: #ffffff;
      --card-bg: #f9f9f9;
      --text-primary: #1a1a1a;
      --text-secondary: #606060;
      --border: #e0e0e0;
      --accent: #6200ea;
      --gradient: linear-gradient(45deg, #3b82f6, #a855f7);
      --progress-bar: #3b82f6; /* Blue for progress bar */
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .video-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .video-container {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
      background-color: #000;
    }
    .video-container .video-js {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .vjs-control-bar {
      background: var(--gradient) !important;
    }
    .vjs-progress-control .vjs-progress-holder {
      background: #ccc !important;
    }
    .vjs-play-progress, .vjs-volume-level {
      background: var(--progress-bar) !important;
    }
    .video-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .video-title {
      font-size: 1.25rem;
      font-weight: 700;
      line-height: 1.5;
    }
    .channel-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .channel-details {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .subscribe-btn {
      background-color: #000000;
      color: #ffffff;
      border-radius: 9999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .subscribe-btn:hover {
      background-color: #333333;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    .suggested-videos {
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) var(--border);
      padding-bottom: 8px;
    }
    .suggested-videos::-webkit-scrollbar {
      height: 8px;
    }
    .suggested-videos::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }
    .suggested-videos::-webkit-scrollbar-track {
      background: var(--border);
    }
    .video-card {
      display: inline-block;
      width: 200px;
      margin-right: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .video-card:hover {
      transform: scale(1.05);
    }
    .video-card img {
      width: 100%;
      height: 112px;
      object-fit: cover;
      background: #000;
    }
    .video-card p {
      padding: 8px;
      margin: 0;
      font-size: 14px;
      font-weight: 500;
      white-space: normal;
    }
    .comments-section {
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }
    .comment-form {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .comment-input {
      background: var(--gradient);
      color: #ffffff;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 500;
      text-align: center;
    }
    .comment-input:hover {
      transform: scale(1.05);
    }
    .comment-card {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient);
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 50%;
      width: 32px;
      height: 32px;
    }
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .spinner-overlay.active {
      display: flex;
    }
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .alert {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 14px;
      z-index: 1001;
      display: none;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .alert.active {
      display: block;
    }
    @media (max-width: 768px) {
      .container {
        padding: 8px;
      }
      .video-title {
        font-size: 1rem;
      }
      .video-card {
        width: 160px;
      }
      .action-buttons {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="video-section">
      <div class="video-container">
        <video id="video-player" class="video-js vjs-default-skin" controls autoplay preload="auto" muted>
          <source src="" type="video/mp4">
        </video>
      </div>
      <div class="video-info">
        <h1 id="video-title" class="video-title"></h1>
        <div class="channel-info">
          <div class="channel-details">
            <div id="channel-avatar" class="avatar"></div>
            <div>
              <p id="channel-name" class="text-sm font-medium"></p>
              <p id="video-meta" class="text-xs text-[var(--text-secondary)]"></p>
            </div>
          </div>
          <div class="action-buttons">
            <button id="subscribe-btn" class="subscribe-btn" title="Subscribe to Channel">Subscribe</button>
            <button id="save-btn" class="text-[var(--text-secondary)] hover:text-[var(--accent)] material-icons" title="Save to Library">bookmark_add</button>
          </div>
        </div>
      </div>
      <div class="suggested-videos" id="suggested-videos"></div>
    </div>
    <div class="comments-section">
      <h2 class="text-lg font-medium mb-4">Comments</h2>
      <form id="comment-form" class="comment-form">
        <textarea id="comment-input" rows="2" class="w-full p-2 border border-[var(--border)] rounded-md" placeholder="Add a public comment..."></textarea>
        <button type="submit" class="comment-input">Comment</button>
      </form>
      <div id="comments-list" class="flex flex-col gap-4"></div>
    </div>
  </div>

  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <div id="alert-message" class="alert"></div>

  <script src="https://vjs.zencdn.net/8.16.2/video.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, push } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    let app, auth, db, currentUser, videoId;

    const showSpinner = () => {
      document.getElementById('spinner-overlay').classList.add('active');
    };

    const hideSpinner = () => {
      document.getElementById('spinner-overlay').classList.remove('active');
    };

    const showAlert = (message) => {
      const alert = document.getElementById('alert-message');
      alert.textContent = message;
      alert.classList.add('active');
      setTimeout(() => alert.classList.remove('active'), 3000);
    };

    function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getDatabase(app);
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            loadVideo();
            loadComments();
            loadSuggestedVideos();
          } else {
            showAlert('Please log in to view this video.');
            window.location.href = 'signup.html';
          }
        }, (error) => {
          console.error('Auth state error:', error);
          showAlert('Authentication error. Please try again.');
        });
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showAlert('Failed to initialize Firebase. Please check your connection.');
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHr = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHr / 24);
      if (diffSec < 60) return `${diffSec} second${diffSec === 1 ? '' : 's'} ago`;
      if (diffMin < 60) return `${diffMin} minute${diffMin === 1 ? '' : 's'} ago`;
      if (diffHr < 24) return `${diffHr} hour${diffHr === 1 ? '' : 's'} ago`;
      return `${diffDay} day${diffDay === 1 ? '' : 's'} ago`;
    }

    async function saveToLibrary(videoId) {
      if (!currentUser) {
        showAlert('Please log in to save videos.');
        return;
      }
      try {
        const libraryRef = ref(db, `users/${currentUser.uid}/library/${videoId}`);
        await set(libraryRef, true);
        showAlert('Video saved to library!');
      } catch (error) {
        console.error('Error saving video to library:', error);
        showAlert('Failed to save video. Please try again.');
      }
    }

    async function subscribeToChannel(channelId) {
      if (!currentUser) {
        showAlert('Please log in to subscribe.');
        return;
      }
      try {
        const subscriptionRef = ref(db, `users/${currentUser.uid}/subscriptions/${channelId}`);
        await set(subscriptionRef, true);
        showAlert('Subscribed successfully!');
      } catch (error) {
        console.error('Error subscribing to channel:', error);
        showAlert('Failed to subscribe. Please try again.');
      }
    }

    async function loadVideo() {
      showSpinner();
      const urlParams = new URLSearchParams(window.location.search);
      videoId = urlParams.get('videoId');
      if (!videoId) {
        showAlert('No video ID provided.');
        window.location.href = 'index.html';
        return;
      }
      const videoRef = ref(db, `shorts/${videoId}`);
      try {
        onValue(videoRef, async (snapshot) => {
          if (!snapshot.exists()) {
            showAlert('Video not found.');
            window.location.href = 'index.html';
            return;
          }
          const videoData = snapshot.val();
          const userRef = ref(db, `users/${videoData.userId}`);
          await new Promise((resolve) => {
            onValue(userRef, (userSnapshot) => {
              const userData = userSnapshot.val();
              const player = videojs('video-player');
              player.src({ src: videoData.mediaURL, type: 'video/mp4' });
              document.getElementById('video-title').textContent = videoData.caption || 'Untitled Video';
              document.getElementById('channel-name').textContent = userData?.displayName || 'Unknown Channel';
              document.getElementById('video-meta').textContent = `${Object.keys(videoData.views || {}).length} views • ${formatTimestamp(videoData.timestamp)}`;
              const channelAvatar = document.getElementById('channel-avatar');
              if (userData?.photoURL) {
                channelAvatar.style.background = 'none';
                channelAvatar.innerHTML = `<img src="${userData.photoURL}" alt="${userData.displayName || 'User'}" class="h-8 w-8 rounded-full">`;
              } else {
                const initial = userData?.displayName ? userData.displayName[0].toUpperCase() : 'U';
                channelAvatar.textContent = initial;
              }
              document.getElementById('save-btn').setAttribute('data-video-id', videoId);
              document.getElementById('subscribe-btn').setAttribute('data-channel-id', videoData.userId);
              resolve();
            }, { onlyOnce: true });
          });
          const viewsRef = ref(db, `shorts/${videoId}/views/${currentUser.uid}`);
          await set(viewsRef, true);
          hideSpinner();
        }, (error) => {
          console.error('Error loading video:', error);
          showAlert('Failed to load video. Please try again.');
          hideSpinner();
        });
      } catch (error) {
        console.error('Error fetching video:', error);
        showAlert('Failed to load video. Please check your connection.');
        hideSpinner();
      }
    }

    async function loadSuggestedVideos() {
      const suggestedVideosContainer = document.getElementById('suggested-videos');
      const shortsRef = ref(db, 'shorts');
      try {
        onValue(shortsRef, (snapshot) => {
          suggestedVideosContainer.innerHTML = '';
          if (!snapshot.exists()) {
            suggestedVideosContainer.innerHTML = '<p class="text-[var(--text-secondary)] px-4">No suggested videos available.</p>';
            return;
          }
          const shorts = snapshot.val();
          const videoArray = Object.entries(shorts)
            .map(([id, data]) => ({ id, ...data }))
            .filter(video => video.id !== videoId)
            .slice(0, 10);
          videoArray.forEach(video => {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            videoCard.innerHTML = `
              <img src="${video.thumbnail || 'https://via.placeholder.com/200x112'}" alt="${video.caption || 'Video'}">
              <p>${video.caption || 'Untitled Video'}</p>
            `;
            videoCard.addEventListener('click', () => {
              window.location.href = `video.html?videoId=${video.id}`;
            });
            suggestedVideosContainer.appendChild(videoCard);
          });
        }, { onlyOnce: true });
      } catch (error) {
        console.error('Error loading suggested videos:', error);
        showAlert('Failed to load suggested videos.');
      }
    }

    async function loadComments() {
      const commentsRef = ref(db, `shorts/${videoId}/comments`);
      const commentsList = document.getElementById('comments-list');
      try {
        onValue(commentsRef, async (snapshot) => {
          commentsList.innerHTML = '';
          if (!snapshot.exists()) {
            commentsList.innerHTML = '<p class="text-[var(--text-secondary)]">No comments yet.</p>';
            return;
          }
          const comments = snapshot.val();
          const commentArray = Object.entries(comments)
            .map(([commentId, commentData]) => ({ commentId, ...commentData }))
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          for (const comment of commentArray) {
            const userRef = ref(db, `users/${comment.userId}`);
            await new Promise((resolve) => {
              onValue(userRef, (userSnapshot) => {
                const userData = userSnapshot.val();
                const commentCard = document.createElement('div');
                commentCard.className = 'comment-card';
                commentCard.innerHTML = `
                  <div class="avatar">
                    ${userData?.photoURL
                      ? `<img src="${userData.photoURL}" alt="${userData.displayName || 'User'}" class="h-8 w-8 rounded-full">`
                      : (userData?.displayName ? userData.displayName[0].toUpperCase() : 'U')}
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-medium">${userData?.displayName || 'Unknown User'} <span class="text-xs text-[var(--text-secondary)]">${formatTimestamp(comment.timestamp)}</span></p>
                    <p class="text-sm mt-1">${comment.text}</p>
                  </div>
                `;
                commentsList.appendChild(commentCard);
                resolve();
              }, { onlyOnce: true });
            });
          }
        }, (error) => {
          console.error('Error loading comments:', error);
          showAlert('Failed to load comments. Please try again.');
        });
      } catch (error) {
        console.error('Error fetching comments:', error);
        showAlert('Failed to load comments. Please check your connection.');
      }
    }

    async function handleCommentSubmit(e) {
      e.preventDefault();
      if (!currentUser) {
        showAlert('Please log in to post comments.');
        return;
      }
      const commentText = document.getElementById('comment-input').value.trim();
      if (!commentText) {
        showAlert('Please enter a comment.');
        return;
      }
      showSpinner();
      try {
        const commentsRef = ref(db, `shorts/${videoId}/comments`);
        const newCommentRef = push(commentsRef);
        await set(newCommentRef, {
          text: commentText,
          userId: currentUser.uid,
          timestamp: new Date().toISOString()
        });
        document.getElementById('comment-form').reset();
        showAlert('Comment posted successfully!');
      } catch (error) {
        console.error('Error posting comment:', error);
        showAlert('Failed to post comment. Please try again.');
      } finally {
        hideSpinner();
      }
    }

    document.getElementById('save-btn').addEventListener('click', () => {
      saveToLibrary(videoId);
    });

    document.getElementById('subscribe-btn').addEventListener('click', () => {
      const channelId = document.getElementById('subscribe-btn').getAttribute('data-channel-id');
      subscribeToChannel(channelId);
    });

    document.getElementById('comment-form').addEventListener('submit', handleCommentSubmit);

    document.addEventListener('DOMContentLoaded', () => {
      initializeFirebase();
    });
  </script>
</body>
</html>
