<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Search â€¢ Vynix</title>

  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --accent: #ff2a6d; --bg: #ffffff; --text: #0f1419; --text2: #536471; --border: #eff3f4; }
    [data-theme="dark"] { --bg: #000000; --text: #e7e9ea; --text2: #71767b; --border: #2f3336; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 80px; -webkit-user-select: none; user-select: none; }
    .search-bar { position: sticky; top: 0; background: var(--bg); padding: 12px 16px; border-bottom: 1px solid var(--border); z-index: 10; }
    .search-input { width: 100%; padding: 12px 44px; background: rgba(128,128,128,0.1); border: none; border-radius: 999px; font-size: 17px; outline: none; -webkit-user-select: auto; user-select: auto; }
    .results { padding: 8px; }
    .result-card { display: flex; gap: 12px; padding: 12px; border-radius: 12px; transition: background .2s; cursor: pointer; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
    .result-card:hover { background: rgba(255,42,109,.08); }
    .avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .name { font-weight: 700; }
    .handle { color: var(--text2); font-size: 14px; }
    .post-snippet { font-size: 15px; line-height: 1.4; margin-top: 4px; word-break: break-word; }
    .highlight { color: var(--accent); font-weight: 600; }
    .empty { text-align: center; padding: 60px 20px; color: var(--text2); font-size: 16px; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Follow Button Styles */
    .follow-btn {
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .follow-btn.follow {
      background: var(--accent);
      color: white;
    }
    .follow-btn.follow:active {
      transform: scale(0.95);
      opacity: 0.8;
    }
    .follow-btn.following {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .follow-btn.following:hover {
      background: rgba(244,33,46,.08);
      color: #f4212e;
      border-color: #f4212e;
    }
    .follow-btn.following:hover .follow-text { display: none; }
    .follow-btn.following:hover::after { content: 'Unfollow'; }
    .follow-btn.me {
      background: var(--border);
      color: var(--text2);
      cursor: default;
      pointer-events: none;
    }
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 12px 24px;
      border-radius: 999px;
      font-size: 14px;
      opacity: 0;
      transition: all .4s ease;
      z-index: 99;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- Search Bar -->
  <div class="search-bar">
    <div class="relative">
      <span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">search</span>
      <input id="searchInput" type="text" class="search-input" placeholder="Search posts, #hashtags or authors" autocomplete="off">
      <span id="clearBtn" class="material-icons absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 cursor-pointer hidden">close</span>
    </div>
  </div>

  <!-- Results -->
  <div id="results" class="results">
    <div class="empty">Start typing to search Vynix</div>
  </div>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 z-40">
    <div class="h-full flex items-center justify-around text-gray-500">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">home</span>
        <span class="text-xs mt-0.5">Home</span>
      </a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">chat_bubble_outline</span>
        <span class="text-xs mt-0.5">Chat</span>
      </a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full text-[#ff2a6d]">
        <span class="material-icons text-24">search</span>
        <span class="text-xs mt-0.5 font-bold">Search</span>
      </a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">auto_awesome</span>
        <span class="text-xs mt-0.5">AI</span>
      </a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">person</span>
        <span class="text-xs mt-0.5">Profile</span>
      </a>
    </div>
  </nav>

  <div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, get, set, query, orderByChild, limitToFirst, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const input = document.getElementById('searchInput');
const clearBtn = document.getElementById('clearBtn');
const results = document.getElementById('results');

let currentUid = null;
let followStates = {}; // Track follow states for each user

// Toast notification
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Auth state
onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = 'login.html';
    return;
  }
  currentUid = user.uid;
});

let timer;
input.addEventListener('input', () => {
  clearTimeout(timer);
  const q = input.value.trim();
  clearBtn.classList.toggle('hidden', !q);
  if (!q) return results.innerHTML = '<div class="empty">Start typing to search Vynix</div>';
  timer = setTimeout(() => runSearch(q), 300);
});

clearBtn.onclick = () => {
  input.value = ''; 
  input.focus(); 
  clearBtn.classList.add('hidden');
  results.innerHTML = '<div class="empty">Start typing to search Vynix</div>';
};

/* ---------- go-to-post helper ---------- */
window.goToPost = postId => {
  const hash = 'post-' + postId;
  const feedUrl = 'index.html#' + hash;
  if (location.pathname.includes('index.html')) {
    location.hash = hash;
  } else {
    location.assign(feedUrl);
  }
};

/* ---------- search ---------- */
async function runSearch(raw) {
  results.innerHTML = '<div class="loader"></div>';
  const low = raw.toLowerCase();
  const isTag = low.startsWith('#');
  const key = isTag ? low.slice(1) : low;

  const snap = await get(query(ref(db, 'posts'), orderByChild('timestamp'), limitToFirst(200)));
  const matches = [];
  const uniqueAuthors = new Set();
  
  snap.forEach(c => {
    const p = c.val();
    const text = (p.text || '').toLowerCase();
    const name = (p.authorName || '').toLowerCase();
    if (isTag ? text.includes('#' + key) : (text.includes(key) || name.includes(key))) {
      matches.push({ key: c.key, ...p });
      if (p.authorId) uniqueAuthors.add(p.authorId);
    }
  });

  if (!matches.length) {
    results.innerHTML = `<div class="empty">No results for "${raw}"</div>`; 
    return;
  }

  // Load follow states for all unique authors
  await loadFollowStates(Array.from(uniqueAuthors));

  // Render results
  results.innerHTML = matches.slice(0, 30).map(p => {
    const isMe = p.authorId === currentUid;
    const followBtnHtml = renderFollowButton(p.authorId, isMe);
    
    return `
    <div class="result-card" data-pid="${p.key}" data-author-id="${p.authorId}">
      <img src="${p.authorAvatar}" class="avatar">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <div class="name">${esc(p.authorName)}</div>
          ${followBtnHtml}
        </div>
        <div class="handle">@${esc(p.authorName.replace(/\s/g, '').toLowerCase())}</div>
        <div class="post-snippet">${highlight(esc(p.text || ''), raw)}</div>
      </div>
    </div>`;
  }).join('');

  // Setup follow button listeners
  setupFollowButtons();
}

/* ---------- load follow states ---------- */
async function loadFollowStates(authorIds) {
  if (!currentUid) return;
  
  const promises = authorIds.map(async authorId => {
    const followingRef = ref(db, `social/${currentUid}/following/${authorId}`);
    const snap = await get(followingRef);
    followStates[authorId] = snap.exists();
  });
  
  await Promise.all(promises);
}

/* ---------- render follow button ---------- */
function renderFollowButton(authorId, isMe) {
  if (isMe) {
    return '<button class="follow-btn me">You</button>';
  }
  
  const isFollowing = followStates[authorId];
  if (isFollowing) {
    return `<button class="follow-btn following" data-author-id="${authorId}"><span class="follow-text">Following</span></button>`;
  } else {
    return `<button class="follow-btn follow" data-author-id="${authorId}"><span class="follow-text">Follow</span></button>`;
  }
}

/* ---------- setup follow button listeners ---------- */
function setupFollowButtons() {
  const buttons = results.querySelectorAll('.follow-btn:not(.me)');
  buttons.forEach(btn => {
    btn.onclick = async (e) => {
      e.stopPropagation();
      const targetUid = btn.dataset.authorId;
      await toggleFollow(targetUid, btn);
    };
  });
}

/* ---------- toggle follow ---------- */
async function toggleFollow(targetUid, btnElement) {
  if (!currentUid || !targetUid) return;

  const followingPath = `social/${currentUid}/following/${targetUid}`;
  const followersPath = `social/${targetUid}/followers/${currentUid}`;

  try {
    const snap = await get(ref(db, followingPath));
    const isCurrentlyFollowing = snap.exists();

    if (isCurrentlyFollowing) {
      // Unfollow
      const updates = {};
      updates[followingPath] = null;
      updates[followersPath] = null;
      await set(ref(db), updates);
      
      followStates[targetUid] = false;
      btnElement.className = 'follow-btn follow';
      btnElement.innerHTML = '<span class="follow-text">Follow</span>';
      toast('Unfollowed');
    } else {
      // Follow
      await set(ref(db, followingPath), true);
      await set(ref(db, followersPath), true);
      
      followStates[targetUid] = true;
      btnElement.className = 'follow-btn following';
      btnElement.innerHTML = '<span class="follow-text">Following</span>';
      toast('Following');
    }
  } catch (err) {
    console.error('Follow toggle error:', err);
    toast('Error: ' + err.message);
  }
}

/* ---------- intercept card taps ---------- */
results.addEventListener('click', e => {
  // Don't navigate if clicking follow button
  if (e.target.closest('.follow-btn')) return;
  
  const card = e.target.closest('.result-card');
  if (!card) return;
  e.preventDefault();
  goToPost(card.dataset.pid);
});

/* ---------- utilities ---------- */
function esc(str) {
  return str.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

function highlight(text, query) {
  const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
  return text.replace(re, '<span class="highlight">$1</span>');
}

/* ---------- theme ---------- */
if (matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.setAttribute('data-theme', 'dark');
}

input.focus();
</script>

</body>
</html>
