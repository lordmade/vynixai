<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy ‚Äì CAPS AI Tutor</title>

  <!-- PWA -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"Vynix Buddy","short_name":"Vynix","description":"Your CAPS AI Tutor for South African Education","start_url":"/","display":"standalone","background_color":"#ffffff","theme_color":"#8b5cf6","orientation":"portrait","icons":[{"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192","sizes":"192x192","type":"image/svg+xml"},{"src":"https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512","sizes":"512x512","type":"image/svg+xml"}]}'>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vynix Buddy">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    textarea,input,.content,.selectable{-webkit-user-select:text;user-select:text}
    body{font-family:'Inter',sans-serif;background:#faf8ff;color:#1f1f1f;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .token-bar{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;padding:0.75rem 1rem;padding-top:calc(0.75rem + env(safe-area-inset-top));font-size:0.95rem;z-index:50;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(139,92,246,0.25)}
    #upgradePill{margin-left:12px;padding:6px 16px;background:#fff3;border:1px solid #fff4;border-radius:50px;font-weight:600;transition:all .2s;cursor:pointer}
    #upgradePill:active{transform:scale(0.94)}
    #profileBtn{display:flex;align-items:center;gap:10px;padding:4px 8px 4px 4px;border-radius:50px;transition:all .2s;cursor:pointer}
    #profileBtn:hover{background:#fff2}
    #profileDropdown{position:absolute;right:8px;top:100%;margin-top:8px;width:280px;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.18);overflow:hidden;opacity:0;pointer-events:none;transform:translateY(-12px);transition:all .25s cubic-bezier(0.32,0.72,0,1);z-index:999}
    #profileDropdown.show{opacity:1;pointer-events:auto;transform:translateY(0)}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 160px;-webkit-overflow-scrolling:touch}
    .message{margin:1.2rem 0;display:flex;flex-direction:column;align-items:flex-start;animation:fadeIn 0.4s ease-out forwards;width:100%}
    .message.user{align-items:flex-end}
    .message .content{max-width:100%;width:auto;padding:14px 18px;border-radius:24px;line-height:1.55;font-size:1.02rem;word-wrap:break-word;box-shadow:0 3px 10px rgba(0,0,0,0.09)}
    .message.ai .content{background:linear-gradient(135deg,#f8f6ff 0%,#f0e8ff 100%);border:1px solid #e0d6ff;border-bottom-left-radius:6px;color:#312e69}
    .message.user .content{background:#fff;border:1.8px solid #c4b5fd;border-bottom-right-radius:6px;color:#1f1f1f;font-weight:500}
    .timestamp{font-size:0.75rem;color:#9ca3af;margin-top:4px;opacity:0.85}
    .message.ai .timestamp{margin-left:18px}.message.user .timestamp{margin-right:18px;text-align:right}
    .ai-actions{display:flex;gap:12px;padding:8px 18px 0 18px;justify-content:flex-start}
    .action-btn{width:40px;height:40px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.14);transition:all .22s ease;cursor:pointer}
    .action-btn:hover{transform:translateY(-4px) scale(1.1);box-shadow:0 10px 25px rgba(139,92,246,0.3)}
    .input-bar{position:fixed;bottom:0;left:0;right:0;padding:0.75rem;padding-bottom:calc(0.75rem + env(safe-area-inset-bottom));background:#fff;border-top:1px solid #e2e8f0;box-shadow:0 -6px 30px rgba(0,0,0,0.1);z-index:100;display:flex;justify-content:center;align-items:center}
    .input-container{background:#f8fafc;border:2px solid #e2e8f0;border-radius:28px;padding:10px 16px;display:flex;align-items:center;gap:12px;transition:all .2s;width:100%;max-width:780px;box-sizing:border-box}
    .input-container:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 4px rgba(139,92,246,0.18);background:#fff}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1.05rem;resize:none;max-height:140px;line-height:1.5}
    .send-btn,.upload-btn{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s;cursor:pointer}
    .send-btn{background:#8b5cf6;color:#fff;box-shadow:0 4px 15px rgba(139,92,246,0.4)}
    .send-btn:disabled{background:#cbd5e1;cursor:not-allowed;opacity:0.7}
    .upload-btn{background:#e2e8f0}
    .bottom-sheet{position:fixed;bottom:-100%;left:0;right:0;background:#fff;border-radius:24px 24px 0 0;padding:1.5rem;box-shadow:0 -10px 40px rgba(0,0,0,0.25);transition:bottom .4s cubic-bezier(.32,.72,0,1);z-index:200;max-height:92dvh;overflow-y:auto}
    .bottom-sheet.active{bottom:0}
    .sheet-handle{width:40px;height:5px;background:#ddd;border-radius:3px;margin:0 auto 1rem}
    .plan-card{border:2px solid #e2e8f0;border-radius:20px;padding:24px;transition:all .25s ease;cursor:pointer;position:relative}
    .plan-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.12)}
    .plan-card .badge{position:absolute;top:16px;right:16px;background:#8b5cf6;color:#fff;font-size:0.75rem;padding:4px 10px;border-radius:9999px;font-weight:600}
    .td-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    #installBanner{position:fixed;bottom:90px;left:4px;right:4px;background:#8b5cf6;color:#fff;padding:12px 16px;border-radius:16px;box-shadow:0 8px 30px rgba(139,92,246,0.4);z-index:40;display:none;align-items:center;justify-content:space-between;animation:fadeIn 0.4s}
    #customAlert{position:fixed;top:6rem;left:50%;transform:translateX(-50%) translateY(-120%);background:linear-gradient(to right,#8b5cf6,#ec4899);color:#fff;padding:12px 32px;border-radius:50px;font-weight:bold;box-shadow:0 10px 30px rgba(139,92,246,0.4);z-index:999;transition:transform 0.4s ease}
    #customAlert.show{transform:translateX(-50%) translateY(0)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .thinking{display:flex;gap:9px;padding:16px 20px}
    .dot{width:11px;height:11px;background:#a78bfa;border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}

    /* Voice Note Specific Styles */
    #voiceRipple { animation: ripple 1.5s infinite; pointer-events: none; }
    @keyframes ripple { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(2.2); opacity: 0; } }
    .recording-pulse { animation: pulseGlow 1.5s infinite; }
    @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); } 70% { box-shadow: 0 0 0 16px rgba(139, 92, 246, 0); } }
  </style>
</head>
<body>

  <!-- TOKEN BAR + PROFILE -->
  <div class="token-bar">
    <div class="flex items-center gap-2">
      <span id="tokenCount">15,000</span> tokens left today
      <button id="upgradePill">Upgrade</button>
    </div>
    <div class="relative">
      <button id="profileBtn" class="flex items-center gap-3 px-3 py-1.5 rounded-full hover:bg-white/10 transition">
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-sm" id="userInitial">U</div>
        <div class="text-left hidden sm:block">
          <div id="userName" class="text-white font-medium text-sm">Loading...</div>
          <div id="userGrade" class="text-white/70 text-xs">Grade ‚Äî</div>
        </div>
        <i data-lucide="chevron-down" class="w-4 h-4 text-white/70"></i>
      </button>
      <div id="profileDropdown">
        <div class="p-4 border-b border-gray-100">
          <div class="font-bold text-gray-900" id="dropdownName">User</div>
          <div class="text-sm text-gray-500" id="dropdownGrade">Grade ‚Äî</div>
        </div>
        <button id="teacherDashboardBtn" class="w-full px-5 py-3 text-left text-purple-600 font-medium hover:bg-purple-50 transition flex items-center gap-3 hidden">
          <i data-lucide="users" class="w-5 h-5"></i> Teacher Dashboard
        </button>
        <button id="signOutBtn" class="w-full px-5 py-3 text-left text-red-600 font-medium hover:bg-red-50 transition flex items-center gap-3">
          <i data-lucide="log-out" class="w-5 h-5"></i> Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- CHAT AREA -->
  <section id="chatPane">
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor ‚Ä¢ Grades 1‚Äì12 ‚Ä¢ South Africa</p>
    </div>
  </section>

  <!-- INPUT BAR WITH VOICE NOTES -->
  <div class="input-bar">
    <div class="input-container items-center">
      <button class="upload-btn" id="uploadBtn"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*,.pdf,.doc,.docx" hidden>

      <!-- Audio Preview (after recording) -->
      <div id="audioPreview" class="hidden mx-2 flex-1 flex items-center gap-3 bg-white rounded-2xl px-4 py-2 border border-purple-200 shadow-sm">
        <button id="playPreviewBtn" class="text-purple-600"><i data-lucide="play"></i></button>
        <div class="flex-1 h-8 bg-purple-100 rounded-full overflow-hidden">
          <div id="audioWave" class="h-full bg-gradient-to-r from-purple-500 to-pink-500" style="width:100%"></div>
        </div>
        <span id="audioTime" class="text-sm text-gray-600">0:00</span>
        <button id="cancelAudioBtn" class="text-red-500"><i data-lucide="x"></i></button>
      </div>

      <!-- Main Input Row -->
      <div id="inputRow" class="flex-1 flex items-center gap-3">
        <textarea id="chatInput" placeholder="Ask me anything... or hold the mic üé§" rows="1" class="flex-1"></textarea>
        
        <button id="voiceBtn" class="upload-btn relative">
          <i data-lucide="mic" id="micIcon"></i>
          <i data-lucide="mic-off" id="micOffIcon" class="hidden"></i>
          <div id="voiceRipple" class="absolute inset-0 rounded-full border-4 border-purple-400 opacity-75 hidden"></div>
        </button>
      </div>

      <button id="sendBtn" class="send-btn" disabled><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <!-- UPGRADE SHEET -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">√ó</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-2">Never Run Out of Help Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to unlimited and study without limits</p>
      <div class="grid grid-cols-1 gap-4 mb-6">
        <label class="plan-card block"><input type="radio" name="plan" value="student" class="absolute opacity-0" checked><div class="badge">Popular</div><div class="text-left"><div class="text-2xl font-extrabold">R29<span class="text-base font-medium text-gray-500">/mo</span></div><div class="text-gray-700 font-semibold mt-1">Student Plan</div><ul class="mt-3 space-y-1 text-sm text-gray-600"><li>Unlimited messages</li><li>All subjects & grades</li><li>Practice papers</li><li class="line-through text-gray-400">Voice</li><li class="line-through text-gray-400">PDF</li><li class="line-through text-gray-400">Mark work</li></ul></div></label>
        <label class="plan-card block"><input type="radio" name="plan" value="unlimited" class="absolute opacity-0"><div class="badge bg-green-600">Best value</div><div class="text-left"><div class="text-2xl font-extrabold">R79<span class="text-base font-medium text-gray-500">/mo</span></div><div class="text-gray-700 font-semibold mt-1">Unlimited Plan</div><ul class="mt-3 space-y-1 text-sm text-gray-600"><li>Everything in Student</li><li>Premium voice</li><li>Download PDF</li><li>Mark work</li><li>Faster responses</li><li>5% donated</li></ul></div></label>
        <label class="plan-card block"><input type="radio" name="plan" value="teacher" class="absolute opacity-0"><div class="badge bg-indigo-600">Teacher</div><div class="text-left"><div class="text-2xl font-extrabold">R199<span class="text-base font-medium text-gray-500">/mo</span></div><div class="text-gray-700 font-semibold mt-1">Teacher Plan</div><ul class="mt-3 space-y-1 text-sm text-gray-600"><li>Up to 50 learners</li><li>All get Student features</li><li>Bulk CSV upload</li><li>Class analytics</li><li>One class code</li></ul></div></label>
      </div>
      <button id="proceedPaymentBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-xl py-4 rounded-2xl shadow-2xl hover:scale-105 active:scale-95">Proceed to Payment</button>
      <p class="text-xs text-gray-500 mt-3">Secure payments by Yoco ‚Ä¢ Cancel anytime</p>
    </div>
  </div>

  <!-- ALERT & INSTALL BANNER -->
  <div id="customAlert" role="alert"></div>
  <div id="installBanner" class="hidden">
    <div class="flex items-center gap-3"><span>Install Vynix Buddy ‚Äì tap ‚ÄúAdd to Home Screen‚Äù</span><button id="installBtn" class="bg-white text-purple-600 px-3 py-1 rounded-full text-sm font-semibold">Install</button></div>
  </div>

  <!-- FIREBASE + FULL APP LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let userProfile = null, xaiKey = null, elevenlabsKey = "sk_ad2f4d587897946bd44f877611980f4a601b46e5d8c1437a";
    let yocoPublicKey = null, yocoEnabled = false, history = [], currentImage = null;
    let dailyTokens = 15000, isPremium = false, userPlan = 'free', teacherCode = null, deferredPrompt = null;

    // Voice recording state
    let recorder = null;
    let audioBlob = null;
    let audioUrl = null;
    let chunks = [];
    let recordingStartTime = 0;
    let timerInterval = null;

    const els = {
      chatPane: document.getElementById('chatPane'), chatInput: document.getElementById('chatInput'), sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'), hiddenFile: document.getElementById('hiddenFile'), tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'), upgradePill: document.getElementById('upgradePill'),
      voiceBtn: document.getElementById('voiceBtn'), micIcon: document.getElementById('micIcon'), micOffIcon: document.getElementById('micOffIcon'),
      voiceRipple: document.getElementById('voiceRipple'), audioPreview: document.getElementById('audioPreview'), inputRow: document.getElementById('inputRow'),
      playPreviewBtn: document.getElementById('playPreviewBtn'), cancelAudioBtn: document.getElementById('cancelAudioBtn'), audioTime: document.getElementById('audioTime'),
      profileBtn: document.getElementById('profileBtn'), profileDropdown: document.getElementById('profileDropdown'), userInitial: document.getElementById('userInitial'),
      userName: document.getElementById('userName'), userGrade: document.getElementById('userGrade'), dropdownName: document.getElementById('dropdownName'),
      dropdownGrade: document.getElementById('dropdownGrade'), signOutBtn: document.getElementById('signOutBtn'), installBanner: document.getElementById('installBanner'),
      installBtn: document.getElementById('installBtn'), proceedPaymentBtn: document.getElementById('proceedPaymentBtn')
    };

    function customAlert(msg, duration = 2800) {
      const box = document.getElementById('customAlert');
      box.textContent = msg; box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }
    function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }
    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { els.upgradeSheet.classList.add('active'); return false; }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const userData = userSnap.val();
        if (userData?.premium) {
          isPremium = true; dailyTokens = 999999; userPlan = userData.plan || 'unlimited';
          document.querySelector('.token-bar > div:first-child').innerHTML = `<span>Unlimited ‚Ä¢ ${userPlan.charAt(0).toUpperCase() + userPlan.slice(1)}</span>`;
          if (userPlan === 'teacher') document.getElementById('teacherDashboardBtn')?.classList.remove('hidden');
          return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val(); const now = Date.now(); const oneDay = 24*60*60*1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000;
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { dailyTokens = 15000; els.tokenCount.textContent = dailyTokens.toLocaleString(); }
    }

    async function loadYocoScript() {
      if (window.YocoSDK) return;
      return new Promise((res) => {
        const s = document.createElement('script');
        s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
        s.onload = res;
        document.head.appendChild(s);
      });
    }

    async function startYocoPayment(plan) {
      await loadYocoScript();
      const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
      const amount = plan === 'student' ? 2900 : plan === 'teacher' ? 19900 : 7900;
      const result = await yoco.showPopup({
        amountInCents: amount, currency: 'ZAR',
        name: `Vynix Buddy ${plan.charAt(0).toUpperCase() + plan.slice(1)}`,
        description: `R${amount/100}/month`,
        metadata: { userId: auth.currentUser.uid, plan },
        callbackUrl: location.href
      });
      if (result?.paymentResult?.status === 'successful') {
        await update(ref(db, `users/${auth.currentUser.uid}`), { premium: true, plan, premiumSince: new Date().toISOString() });
        isPremium = true; userPlan = plan; await loadTokens(); els.upgradeSheet.classList.remove('active');
        customAlert(`Welcome to ${plan.charAt(0).toUpperCase() + plan.slice(1)} plan!`);
      }
    }

    els.proceedPaymentBtn.onclick = () => {
      const plan = document.querySelector('input[name="plan"]:checked').value;
      yocoEnabled ? startYocoPayment(plan) : customAlert("Payments coming soon!");
    };

    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');
    els.upgradeSheet.onclick = (e) => { if (e.target === els.upgradeSheet) els.upgradeSheet.classList.remove('active'); };

    function addThinking() {
      const d = document.createElement('div'); d.id = 'thinking'; d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d); els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div'); div.className = `message ${sender}`;
      const time = formatTime();

      if (sender === 'ai') {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="timestamp">${time}</div>`;
      } else {
        div.innerHTML = `<div class="content">\( {content}</div><div class="timestamp"> \){time}</div>`;
      }

      els.chatPane.appendChild(div); els.chatPane.scrollTop = els.chatPane.scrollHeight; lucide.createIcons();
    }

    // === VOICE NOTE RECORDING ===
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          audioBlob = new Blob(chunks, { type: 'audio/webm' });
          audioUrl = URL.createObjectURL(audioBlob);
          showAudioPreview();
          stream.getTracks().forEach(t => t.stop());
        };

        recorder.start();
        recordingStartTime = Date.now();
        els.voiceBtn.classList.add('recording-pulse', 'bg-red-500');
        els.micIcon.classList.add('hidden');
        els.micOffIcon.classList.remove('hidden');
        els.voiceRipple.classList.remove('hidden');

        timerInterval = setInterval(() => {
          const secs = Math.floor((Date.now() - recordingStartTime) / 1000);
          els.audioTime.textContent = `0:${secs.toString().padStart(2, '0')}`;
        }, 500);

      } catch (err) {
        customAlert("Microphone access denied");
      }
    }

    function stopRecording() {
      if (recorder && recorder.state === 'recording') recorder.stop();
      clearInterval(timerInterval);
      els.voiceBtn.classList.remove('recording-pulse', 'bg-red-500');
      els.micIcon.classList.remove('hidden');
      els.micOffIcon.classList.add('hidden');
      els.voiceRipple.classList.add('hidden');
    }

    function showAudioPreview() {
      els.inputRow.classList.add('hidden');
      els.audioPreview.classList.remove('hidden');
      els.sendBtn.disabled = false;
    }

    function cancelRecording() {
      audioBlob = null; audioUrl = null;
      els.audioPreview.classList.add('hidden');
      els.inputRow.classList.remove('hidden');
      els.sendBtn.disabled = !els.chatInput.value.trim();
    }

    els.cancelAudioBtn.onclick = cancelRecording;
    els.playPreviewBtn.onclick = () => new Audio(audioUrl).play();

    els.voiceBtn.addEventListener('pointerdown', e => { e.preventDefault(); startRecording(); });
    els.voiceBtn.addEventListener('pointerup', e => { e.preventDefault(); stopRecording(); });
    els.voiceBtn.addEventListener('pointercancel', stopRecording);
    els.voiceBtn.addEventListener('pointerleave', stopRecording);

    // === SEND MESSAGE (TEXT OR VOICE) ===
    async function send() {
      let text = els.chatInput.value.trim();

      // Voice note
      if (audioBlob) {
        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
        addMessage(`
          <div class="bg-white p-3 rounded-2xl rounded-br-md shadow-md max-w-xs">
            <audio controls src="${audioUrl}" class="w-full"></audio>
            <div class="text-xs text-gray-500 text-right mt-1">${duration}s</div>
          </div>
        `, 'user');

        customAlert("Uploading voice note...");
        const fd = new FormData();
        fd.append('file', audioBlob, 'voice.webm');
        fd.append('upload_preset', 'vynix_public');

        const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/video/upload", { method: "POST", body: fd });
        const data = await res.json();

        if (data.secure_url) {
          history.push({ role: "user", content: `[Voice note: ${data.secure_url}]` });
          cancelRecording();
          addThinking();
          const reply = await getReply(`[Voice message attached: ${data.secure_url}]`);
          removeThinking();
          await replyWithVoiceNote(reply);
          history.push({ role: "assistant", content: reply });
        }
        return;
      }

      // Text message
      if (!text && !currentImage) return;
      const cost = currentImage ? 1500 : estimateTokens(text);
      if (!(await deductTokens(cost))) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="Upload">`, 'user');
        history.push({ role: "user", content: `[Image: ${currentImage}]` });
        if (!text) text = "Explain this";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null; els.chatInput.style.height = 'auto';
      addThinking();
      const reply = await getReply(text);
      removeThinking();
      await replyWithVoiceNote(reply);
      history.push({ role: "assistant", content: reply });
    }

    // === AI REPLIES WITH VOICE NOTE ===
    async function replyWithVoiceNote(text) {
      if (!isPremium && userPlan !== 'unlimited') {
        addMessage(text, 'ai', text);
        return;
      }

      addMessage(`
        <div class="content bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-2xl rounded-tl-md shadow-lg max-w-xs">
          <div class="flex items-center gap-3 mb-2">
            <i data-lucide="volume-2" class="text-purple-600"></i>
            <span class="text-sm font-medium text-purple-700">Voice reply</span>
          </div>
          <audio controls class="w-full" id="aiVoiceAudio"></audio>
          <div class="text-xs text-gray-600 mt-2">${marked.parse(text)}</div>
        </div>
        <div class="timestamp">${formatTime()}</div>
      `, 'ai', text);

      lucide.createIcons();

      try {
        const res = await fetch("https://api.elevenlabs.io/v1/text-to-speech/ErXwobaYiN019PkySvjV/stream", {
          method: "POST",
          headers: { "Accept": "audio/mpeg", "Content-Type": "application/json", "xi-api-key": elevenlabsKey },
          body: JSON.stringify({
            text: text.replace(/[#*`>~\[\]]/g, ''),
            model_id: "eleven_turbo_v2",
            voice_settings: { stability: 0.7, similarity_boost: 0.8 }
          })
        });

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        document.getElementById('aiVoiceAudio').src = url;
      } catch (e) {
        console.error(e);
      }
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting...";
      const system = `You are Vynix Buddy, a warm, encouraging CAPS tutor for South Africa. Speak naturally like a friend.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [{ role: "system", content: system }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "Thinking...";
      } catch { return "No connection"; }
    }

    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto'; els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      els.sendBtn.disabled = !els.chatInput.value.trim() && !audioBlob;
    });

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', 'vynix_public');
      try {
        customAlert("Uploading...");
        const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/upload", { method: "POST", body: fd });
        const data = await res.json();
        if (data.secure_url) { currentImage = data.secure_url; els.sendBtn.disabled = false; customAlert("Uploaded!"); }
      } catch { customAlert("Upload error"); }
    };

    // PWA Install
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; els.installBanner.classList.remove('hidden'); });
    els.installBtn.onclick = async () => {
      if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') els.installBanner.classList.add('hidden'); deferredPrompt = null; }
    };

    // Auth
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      await init(); await loadTokens();
      userProfile = (await get(child(ref(db), `users/${user.uid}/profile`))).val() || {};
      const name = userProfile?.name || "Student";
      els.userInitial.textContent = name.charAt(0).toUpperCase();
      els.userName.textContent = name;
      els.dropdownName.textContent = name;
      addMessage(`Welcome back${userProfile.name ? ", " + userProfile.name : ""}! Ready to study?`, 'ai');
    });

    async function init() {
      const rc = getRemoteConfig(app);
      rc.settings.minimumFetchIntervalMillis = 3600000;
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      yocoPublicKey = getString(rc, 'yoco_public_key')?.trim();
      yocoEnabled = getBoolean(rc, 'yoco_enabled');
    }
  </script>
</body>
</html>
