<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>StudyBuddy – Your Child’s Private Tutor (Grade 1–12)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Prism + Marked -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    * { -webkit-touch-callout: none !important; -webkit-user-select: none !important; user-select: none !important; }
    input, textarea, .content { user-select: text !important; }
    html, body { overscroll-behavior: none; height: 100vh; margin: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-secondary); display: flex; flex-direction: column; }

    .top-bar { height: 64px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; z-index: 10; }
    .v-logo { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .v-logo svg { width: 22px; height: 22px; fill: white; }
    #api-status { width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s; }
    #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }

    .chat-area { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 6rem; display: flex; flex-direction: column; gap: 0.6rem; }
    .message { display: flex; width: 100%; }
    .message.user { align-items: flex-end; }
    .message.ai { align-items: flex-start; }
    .message .content { max-width: 75%; padding: 0.75rem 1.1rem; border-radius: 1.1rem; box-shadow: 0 2px 8px rgba(0,0,0,.18); line-height: 1.5; }
    .message.user .content { background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE); color: #1E1E1E; }
    .message.ai .content { background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748); color: var(--text-primary); }
    .message-time { font-size: 0.65rem; opacity: 0.6; margin-top: 0.25rem; padding: 0 0.4rem; }
    .message-time.ai { align-self: flex-start; }
    .message-time.user { align-self: flex-end; }

    .input-bar { position: fixed; left: 0; right: 0; bottom: 0; padding: 0.75rem 1rem; border-top: 1px solid var(--border); background: var(--bg); z-index: 20; }
    .input-wrapper { display: flex; align-items: center; gap: 0.5rem; background: var(--card-bg); border-radius: 9999px; padding: 0.5rem 1rem; }
    #chatInput { flex: 1; background: transparent; border: none; outline: none; color: var(--text-primary); font-size: 1rem; }
    #sendBtn { background: none; border: none; cursor: pointer; }
    #sendBtn svg { width: 1.5rem; height: 1.5rem; stroke: var(--text-primary); }

    .sidebar { position: fixed; inset: 0; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,.1); transform: translateX(-100%); transition: transform .3s ease; z-index: 40; display: flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { background: #000; color: white; padding: 1.5rem; text-align: center; }
    #convList { flex: 1; overflow-y: auto; }
    .conv-item { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .conv-item:hover { background: #f0f0f0; }
    .conv-item.active { background: #e0e7ff; font-weight: 600; }
    .delete-conv { color: #ef4444; opacity: .7; cursor: pointer; }
    #userPlanBadge { margin: 1rem; padding: .6rem 1rem; border-radius: 9999px; background: linear-gradient(135deg, var(--highlight), #4ADEDE); color: white; font-weight: 700; font-size: .8rem; text-align: center; }

    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); opacity: 0; visibility: hidden; transition: all .3s; z-index: 35; }
    #overlay.on { opacity: 1; visibility: visible; }

    #toast { position: fixed; bottom: 5.5rem; left: 50%; transform: translateX(-50%); background: var(--card-bg); color: white; padding: .5rem 1rem; border-radius: 9999px; box-shadow: 0 4px 14px rgba(0,0,0,.25); opacity: 0; pointer-events: none; transition: opacity .3s; z-index: 25; }
    #toast.show { opacity: 1; }

    #upgradeModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; }
    #upgradeModal.show { display: flex; }
    .modal-content { background: white; border-radius: 1.5rem; padding: 2rem; max-width: 400px; width: 90%; text-align: center; }
    .modal-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; }
    .mock-checkout { width: 100%; background: linear-gradient(135deg, #10B981, #34D399); color: white; border: none; padding: 1rem; border-radius: 0.75rem; font-weight: bold; cursor: pointer; }

    #tokenBar { height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden; margin-top: 0.5rem; }
    #tokenFill { height: 100%; background: linear-gradient(90deg, #10B981, #34D399); transition: width 0.6s ease; }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <header class="top-bar">
    <button id="menuBtn" class="flex items-center gap-2 text-sm text-white bg-[var(--card-bg)] border border-[var(--border)] px-3 py-2 rounded-full">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      Menu
    </button>
    <div class="v-logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
    <div id="api-status"></div>
  </header>

  <!-- CHAT -->
  <section id="chatPane" class="chat-area">
    <div id="welcome" class="text-center m-auto">
      <h1 class="text-lg font-semibold text-black">Hey! I'm StudyBuddy</h1>
      <p class="text-sm text-gray-600 mt-1">Your personal tutor for Grades 1–12 · Paste homework photos!</p>
    </div>
  </section>

  <!-- INPUT -->
  <div class="input-bar" id="inputBar">
    <div class="input-wrapper">
      <input id="chatInput" type="text" placeholder="Ask about school or paste a photo..." autocomplete="off">
      <button id="sendBtn">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M5 12l6-6m-6 12l6 6"/></svg>
      </button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="v-logo mx-auto"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
      <div class="mt-3">
        <div id="slideProfile" class="w-18 h-18 rounded-full bg-[var(--highlight)] mx-auto flex items-center justify-center text-white text-2xl font-bold">U</div>
        <div id="slideName" class="mt-2 font-semibold text-white">Loading...</div>
      </div>
    </div>
    <button id="newConvBtn" class="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-semibold">+ New Session</button>
    <div class="p-4 border-b bg-gray-50">
      <div class="flex justify-between text-sm mb-2">
        <span>Tokens today</span>
        <span id="tokenCount">0 / 15,000</span>
      </div>
      <div id="tokenBar"><div id="tokenFill" class="w-0"></div></div>
    </div>
    <div id="convList" class="flex-1 overflow-y-auto"></div>
    <div id="userPlanBadge">Free Plan • 15,000 tokens/day</div>
  </aside>

  <!-- OVERLAY & TOAST -->
  <div id="overlay" class=""></div>
  <div id="toast"></div>

  <!-- UPGRADE MODAL -->
  <div id="upgradeModal">
    <div class="modal-content">
      <h2 class="modal-title">Upgrade to Pro</h2>
      <p class="text-lg mb-6">Unlimited tutoring · Homework photos · All subjects</p>
      <button id="mockCheckout" class="mock-checkout">Start Free Trial → R799/month</button>
      <button id="closeModal" class="close-modal mt-4 text-gray-500">Maybe later</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Elements
    const chatPane = document.getElementById('chatPane');
    const welcome = document.getElementById('welcome');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const convList = document.getElementById('convList');
    const newConvBtn = document.getElementById('newConvBtn');
    const slideProfile = document.getElementById('slideProfile');
    const slideName = document.getElementById('slideName');
    const userPlanBadge = document.getElementById('userPlanBadge');
    const tokenCount = document.getElementById('tokenCount');
    const tokenFill = document.getElementById('tokenFill');
    const upgradeModal = document.getElementById('upgradeModal');
    const mockCheckout = document.getElementById('mockCheckout');
    const closeModal = document.getElementById('closeModal');

    let xaiApiKey = null;
    let userId = null;
    let currentConvId = null;
    let conversations = {};
    let history = [];
    let todayTokensUsed = 0;
    let isPro = false;
    let currentImage = null;

    const DAILY_LIMIT = 15000;
    const PRO_LIMIT = 1000000;

    const SYSTEM_PROMPT = `You are StudyBuddy — the kindest, smartest tutor for Grades 1–12 in South Africa.
You help with homework, explain concepts, and make learning fun.
- Auto-detect grade level from question
- Use simple language for younger kids, deeper for teens
- Always ask: "Got it? Want another example?"
- Celebrate wins with emojis
- For photos: solve step-by-step like a real teacher
You are warm, patient, and never boring.`;

    marked.setOptions({ breaks: true, gfm: true, highlight: (code, lang) => Prism.highlight(code, Prism.languages[lang] || Prism.languages.markup, lang) });

    function renderMarkdown(text) {
      let html = marked.parse(text);
      return html.replace(/<pre><code class="language-([^"]+)">([\s\S]*?)<\/code><\/pre>/g,
        '<pre><code class="language-$1">$2</code><button class="code-copy-btn">Copy</button></pre>');
    }

    async function initRemote() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiApiKey = getString(rc, 'xai_api_key').trim();
      if (xaiApiKey) document.getElementById('api-status').classList.add('connected');
    }

    async function loadUsage() {
      const today = new Date().toISOString().slice(0,10);
      const snap = await get(ref(db, `usage/\( {userId}/ \){today}`));
      todayTokensUsed = snap.val() || 0;
      updateTokenUI();
    }

    function updateTokenUI() {
      const limit = isPro ? PRO_LIMIT : DAILY_LIMIT;
      tokenCount.textContent = `\( {todayTokensUsed.toLocaleString()} / \){limit.toLocaleString()}`;
      tokenFill.style.width = `${(todayTokensUsed / limit) * 100}%`;
      userPlanBadge.textContent = isPro ? 'Pro • 1M tokens/mo' : 'Free • 15K tokens/day';
    }

    async function addUsage(input, output) {
      todayTokensUsed += input + output;
      const today = new Date().toISOString().slice(0,10);
      await set(ref(db, `usage/\( {userId}/ \){today}`), todayTokensUsed);
      updateTokenUI();
      if (!isPro && todayTokensUsed >= DAILY_LIMIT) upgradeModal.classList.add('show');
    }

    function estimateTokens(str) { return Math.ceil(str.length / 3.8); }

    async function getReply(userMsg) {
      const messages = [
        { role: "system", content: SYSTEM_PROMPT },
        ...history.slice(-20).map(m => ({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text })),
        { role: "user", content: userMsg }
      ];

      if (currentImage) {
        const base64 = await fetch(currentImage).then(r => r.blob()).then(b => new Promise(res => {
          const reader = new FileReader(); reader.onloadend = () => res(reader.result.split(',')[1]); reader.readAsDataURL(b);
        }));
        messages[messages.length-1].content = [
          { type: "text", text: userMsg || "Explain this homework photo" },
          { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
        ];
      }

      const inputTokens = estimateTokens(JSON.stringify(messages));
      if (!isPro && todayTokensUsed + inputTokens > DAILY_LIMIT) {
        upgradeModal.classList.add('show');
        return "Daily limit reached! Upgrade to Pro for unlimited access.";
      }

      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({ model: "grok-3", messages, temperature: 0.7 })
      }).then(r => r.json());

      const reply = res.choices?.[0]?.message?.content || "I'm thinking... try again!";
      await addUsage(inputTokens, estimateTokens(reply));
      return reply;
    }

    function addMessage(text, sender, timestamp = Date.now(), typing = false) {
      const msg = document.createElement('div');
      msg.className = `message ${sender}`;
      msg.innerHTML = `
        <div class="content"></div>
        <div class="message-time \( {sender}"> \){new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
      `;
      if (sender === 'ai') {
        const btn = document.createElement('button');
        btn.innerHTML = 'Copy';
        btn.style.cssText = 'position: absolute; top: 8px; right: 8px; opacity: 0.6;';
        btn.onclick = () => { navigator.clipboard.writeText(text); btn.textContent = 'Copied'; setTimeout(() => btn.textContent = 'Copy', 1500); };
        msg.querySelector('.content').appendChild(btn);
      }
      chatPane.appendChild(msg);
      chatPane.scrollTop = chatPane.scrollHeight;

      const content = msg.querySelector('.content');
      if (typing) {
        content.textContent = 'Typing...';
        setTimeout(() => typeText(text, content), 500);
      } else {
        typeText(text, content);
      }
    }

    async function typeText(text, el) {
      el.innerHTML = '';
      for (let i = 0; i < text.length; i += 7) {
        el.textContent += text.slice(i, i+7);
        await new Promise(r => setTimeout(r, 20));
        el.scrollIntoView({behavior: 'smooth', block: 'nearest'});
      }
      el.innerHTML = renderMarkdown(text);
      Prism.highlightAllUnder(el);
    }

    async function send() {
      const text = chatInput.value.trim();
      if (!text && !currentImage) return;
      if (!currentConvId) startNewConversation();

      if (currentImage) addMessage(`<img src="${currentImage}" class="rounded-lg max-w-xs">`, 'user');
      else addMessage(text, 'user');

      saveMessage(text || "[Photo]", 'user');
      history.push({ sender: 'user', text: text || "[Photo]" });
      chatInput.value = '';
      currentImage = null;

      addMessage('', 'ai', Date.now(), true);
      const reply = await getReply(text || "Explain this homework");
      document.querySelector('.message.ai:last-child .content').parentElement.remove();
      addMessage(reply, 'ai');
      history.push({ sender: 'ai', text: reply });
      saveMessage(reply, 'ai');
    }

    // All missing functions — FULLY ADDED
    function startNewConversation() {
      history = [];
      chatPane.innerHTML = '';
      welcome.classList.remove('hidden');
      const newRef = push(ref(db, `users/${userId}/conversations`));
      currentConvId = newRef.key;
      set(newRef, { createdAt: Date.now(), title: 'New Tutoring Session' });
    }

    function loadConversation(id, data) {
      currentConvId = id;
      history = [];
      chatPane.innerHTML = '';
      welcome.classList.add('hidden');
      const msgs = data.messages || {};
      Object.entries(msgs).sort((a, b) => a[1].timestamp - b[1].timestamp).forEach(([_, m]) => {
        addMessage(m.text, m.sender, m.timestamp);
        if (m.sender !== 'system') history.push({ sender: m.sender, text: m.text });
      });
      document.querySelectorAll('.conv-item').forEach(el => el.classList.toggle('active', el.dataset.id === id));
    }

    function deleteConversation(id) {
      remove(ref(db, `users/\( {userId}/conversations/ \){id}`));
      if (id === currentConvId) startNewConversation();
    }

    function renderSidebar() {
      convList.innerHTML = '';
      Object.entries(conversations)
        .sort((a, b) => b[1].createdAt - a[1].createdAt)
        .forEach(([id, conv]) => {
          const div = document.createElement('div');
          div.className = `conv-item ${id === currentConvId ? 'active' : ''}`;
          div.dataset.id = id;
          div.innerHTML = `<span>${conv.title || 'Chat'}</span><span class="delete-conv">Delete</span>`;
          div.onclick = () => loadConversation(id, conv);
          div.querySelector('.delete-conv').onclick = e => { e.stopPropagation(); deleteConversation(id); };
          convList.appendChild(div);
        });
    }

    function saveMessage(text, sender) {
      if (!currentConvId) return;
      push(ref(db, `users/\( {userId}/conversations/ \){currentConvId}/messages`), {
        text, sender, timestamp: Date.now()
      });
    }

    async function loadProfile() {
      const snap = await get(ref(db, `users/${userId}`));
      const data = snap.val() || {};
      slideName.textContent = data.displayName || 'Student';
      slideProfile.textContent = (data.displayName || 'S')[0].toUpperCase();
      isPro = data.plan === 'pro';
      updateTokenUI();
    }

    // Image paste
    document.addEventListener('paste', e => {
      const file = e.clipboardData?.files[0];
      if (file?.type.startsWith('image/')) {
        currentImage = URL.createObjectURL(file);
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-xs">`, 'user');
        send();
      }
    });

    // Events
    sendBtn.onclick = send;
    chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
    menuBtn.onclick = () => { sidebar.classList.add('open'); overlay.classList.add('on'); };
    overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('on'); };
    newConvBtn.onclick = () => { overlay.click(); startNewConversation(); };
    mockCheckout.onclick = () => { isPro = true; alert("Pro unlocked! Unlimited access"); upgradeModal.classList.remove('show'); loadProfile(); };
    closeModal.onclick = () => upgradeModal.classList.remove('show');

    // Auth
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      userId = user.uid;
      await initRemote();
      await loadUsage();
      await loadProfile();
      onValue(ref(db, `users/${userId}/conversations`), snap => {
        conversations = snap.val() || {};
        renderSidebar();
      });
    });
  </script>
</body>
</html>
