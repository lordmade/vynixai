<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Vynix%20Buddy%22,%22short_name%22:%22Vynix%22,%22description%22:%22Your%20CAPS%20AI%20Tutor%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512%22,%22sizes%22:%22512x512%22}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      color: #0f172a;
      margin: 0;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid #e2e8f0;
      z-index: 100;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .token-display {
      font-size: 0.875rem;
      background: #f1f5f9;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      font-weight: 600;
      color: #475569;
    }
    .upgrade-btn {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
    }

    /* Tabs */
    .tabs {
      position: fixed;
      top: 68px;
      left: 50%;
      transform: translateX(-50%);
      background: #f8fafc;
      border-radius: 999px;
      padding: 6px;
      display: flex;
      gap: 6px;
      z-index: 90;
      border: 1px solid #e2e8f0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }
    .tab {
      padding: 10px 28px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab:not(.active) { color: #64748b; }
    .tab.active {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
    }

    /* Messages */
    .message {
      margin: 16px 0;
      max-width: 88%;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    .message.ai { align-self: flex-start; }
    .message.user { align-self: flex-end; }
    .message.ai .content {
      background: #f8fafc;
      color: #0f172a;
      border-radius: 18px 18px 18px 4px;
      padding: 14px 18px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .message.user .content {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      border-radius: 18px 18px 4px 18px;
      padding: 14px 18px;
    }
    .timestamp {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 4px;
      text-align: right;
    }
    .ai-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      opacity: 0.9;
    }
    .action-btn {
      width: 36px; height: 36px;
      background: #f1f5f9;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover { background: #e2e8f0; transform: scale(1.1); }
    .whatsapp-btn { background: #25d366 !important; color: white !important; }

    /* Thinking Dots */
    .thinking {
      display: flex;
      gap: 8px;
      padding: 14px 18px;
      background: #f8fafc;
      border-radius: 18px 18px 18px 4px;
      border: 1px solid #e2e8f0;
      width: fit-content;
    }
    .dot {
      width: 10px; height: 10px;
      background: #8b5cf6;
      border-radius: 50%;
      animation: pulse 1.4s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%,100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }

    /* Voice Mode */
    .voice-avatar {
      width: 180px; height: 180px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(139,92,246,0.3);
      border: 6px solid white;
    }
    .voice-wave { position: absolute; inset: 0; background: conic-gradient(from 0deg at 50% 50%, transparent 0deg, rgba(255,255,255,0.3) 90deg, transparent 180deg); animation: spin 8s linear infinite; opacity: 0; }
    .voice-listening .voice-wave, .voice-speaking .voice-wave { opacity: 0.8; animation-duration: 2s; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .ring { position: absolute; inset: 0; border: 4px solid #8b5cf6; border-radius: 50%; opacity: 0; animation: pulseRing 2s infinite; }
    .ring:nth-child(2) { animation-delay: 0.3s; }
    .ring:nth-child(3) { animation-delay: 0.6s; }
    @keyframes pulseRing { 0% { transform: scale(0.8); opacity: 0.6; } 100% { transform: scale(1.8); opacity: 0; } }
    .voice-status { font-size: 1.5rem; font-weight: 700; color: #1e293b; }
    .voice-hint { color: #64748b; font-size: 1rem; text-align: center; max-width: 80%; }
    .mic-button {
      width: 84px; height: 84px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 12px 40px rgba(139,92,246,0.4);
      transition: all 0.3s;
      cursor: pointer;
    }
    .mic-button.recording { background: #ef4444; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { box-shadow: 0 12px 40px rgba(239,68,68,0.5); } 50% { box-shadow: 0 12px 60px rgba(239,68,68,0.8); } }

    /* Input Bar */
    .input-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      border-top: 1px solid #e2e8f0;
      z-index: 80;
    }
    .input-container {
      background: #f1f5f9;
      border-radius: 999px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid #cbd5e1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    #chatInput { flex: 1; background: transparent; border: none; outline: none; color: #0f172a; font-size: 1.1rem; }
    .send-btn {
      width: 44px; height: 44px;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }

    /* Bottom Sheet */
    .bottom-sheet {
      position: fixed; bottom: -100%; left: 0; right: 0;
      background: white; border-radius: 1.5rem 1.5rem 0 0;
      padding: 1.5rem; box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      transition: bottom 0.4s cubic-bezier(0.32,0.72,0,1); z-index: 200;
      max-height: 92dvh; overflow-y: auto;
    }
    .bottom-sheet.active { bottom: 0; }
    .sheet-handle { width: 40px; height: 5px; background: #ddd; border-radius: 3px; margin: 0 auto 1rem; }

    /* Toast */
    #customAlert {
      position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%) translateY(-120%);
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white; padding: 12px 24px;
      border-radius: 999px; font-weight: 700;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 9999; transition: transform 0.4s cubic-bezier(0.68,-0.55,0.27,1.55);
    }
    #customAlert.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body class="bg-white">

  <!-- Header -->
  <div class="header">
    <div class="logo">Vynix</div>
    <div class="flex items-center gap-3">
      <div class="token-display"><span id="tokenCount">15,000</span> tokens left</div>
      <button id="upgradePill" class="upgrade-btn">Upgrade</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="chat"><i data-lucide="message-square"></i> Chat</button>
    <button class="tab" data-tab="voice"><i data-lucide="mic"></i> Voice</button>
  </div>

  <!-- Chat Pane -->
  <section id="chatPane" class="flex flex-col"></section>

  <!-- Voice Pane -->
  <section id="voicePane">
    <p class="voice-hint">Tap the mic and speak • I’ll reply out loud</p>
    <div class="voice-status" id="voiceStatus">Ready to help</div>
    <div class="voice-avatar" id="voiceAvatar">
      <div class="voice-wave"></div>
      <div class="ring"></div><div class="ring"></div><div class="ring"></div>
      <i data-lucide="brain" class="text-white w-20 h-20 absolute inset-0 m-auto opacity-90"></i>
    </div>
    <button class="mic-button" id="voiceMicBtn"><i data-lucide="mic" class="w-12 h-12"></i></button>
  </section>

  <!-- Input Bar -->
  <div class="input-bar" id="chatInputBar">
    <div class="input-container">
      <button id="uploadBtn"><i data-lucide="paperclip" class="w-6 h-6 text-gray-500"></i></button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn"><i data-lucide="send" class="w-5 h-5 text-white"></i></button>
    </div>
  </div>

  <!-- Upgrade Bottom Sheet -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div class="text-center px-6">
      <h2 class="text-3xl font-black mb-3">Never Run Out Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <strong>Unlimited</strong> — just <strong>R79/month</strong></p>
      <div class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl mb-8">
        <div class="text-6xl font-black">R79</div>
        <div class="text-xl opacity-90">per month</div>
      </div>
      <button id="mockUpgrade" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">
        Yes! Upgrade Me Now – R79/month
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="customAlert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let history = [];
    let currentImage = null;
    let dailyTokens = 15000;
    let isPremium = false;
    let recognition = null;
    let isRecording = false;
    let thinkingMessage = null;

    const els = {
      chatPane: document.getElementById('chatPane'),
      voicePane: document.getElementById('voicePane'),
      chatInputBar: document.getElementById('chatInputBar'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      upgradePill: document.getElementById('upgradePill'),
      voiceStatus: document.getElementById('voiceStatus'),
      voiceMicBtn: document.getElementById('voiceMicBtn'),
      voiceAvatar: document.getElementById('voiceAvatar'),
      tabs: document.querySelectorAll('.tab')
    };

    function customAlert(msg) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), 2800);
    }

    function formatTime() {
      return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
    }

    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) {
        els.upgradeSheet.classList.add('active');
        return false;
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val() || {};
        const now = Date.now();
        if (!data.lastReset || now - data.lastReset > 86400000) {
          dailyTokens = 15000;
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { }
    }

    // WhatsApp Share
    function shareToWhatsApp(text, imageUrl = null) {
      let message = "Vynix Buddy Answer:\n\n" + text.replace(/<[^>]*>/g, '').trim();
      if (imageUrl) message += `\n\nImage: ${imageUrl}`;
      const encoded = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encoded}`, '_blank');
      customAlert("Opening WhatsApp...");
    }

    // Show Thinking Dots
    function showThinking() {
      if (thinkingMessage) thinkingMessage.remove();
      thinkingMessage = document.createElement('div');
      thinkingMessage.className = 'message ai flex flex-col';
      thinkingMessage.innerHTML = `
        <div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      `;
      els.chatPane.appendChild(thinkingMessage);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    function hideThinking() {
      if (thinkingMessage) {
        thinkingMessage.remove();
        thinkingMessage = null;
      }
    }

    // Tab Switching
    els.tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        els.tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const isVoice = tab.dataset.tab === 'voice';
        els.chatPane.style.display = isVoice ? 'none' : 'flex';
        els.voicePane.classList.toggle('active', isVoice);
        els.chatInputBar.style.display = isVoice ? 'none' : 'block';
        if (isVoice && !recognition) initSpeechRecognition();
      });
    });

    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        customAlert("Voice not supported on this browser");
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-ZA';
      recognition.continuous = false;

      recognition.onstart = () => {
        isRecording = true;
        els.voiceStatus.textContent = "Listening...";
        els.voiceAvatar.classList.add('voice-listening');
        els.voiceMicBtn.innerHTML = `<i data-lucide="square" class="w-12 h-12"></i>`;
        lucide.createIcons();
      };

      recognition.onresult = async e => {
        const text = e.results[0][0].transcript;
        await processVoiceInput(text);
      };

      recognition.onerror = () => customAlert("Couldn't hear you — try again");
      recognition.onend = () => {
        isRecording = false;
        els.voiceStatus.textContent = "Ready to help";
        els.voiceAvatar.classList.remove('voice-listening', 'voice-speaking');
        els.voiceMicBtn.innerHTML = `<i data-lucide="mic" class="w-12 h-12"></i>`;
        lucide.createIcons();
      };
    }

    els.voiceMicBtn.onclick = () => isRecording ? recognition.stop() : recognition.start();

    async function processVoiceInput(text) {
      if (!(await deductTokens(estimateTokens(text)))) return;
      showThinking();
      const reply = await getReply(text);
      hideThinking();
      addMessage(reply, 'ai', reply);
      els.voiceStatus.textContent = "Speaking...";
      els.voiceAvatar.classList.add('voice-speaking');
      await playVoiceResponse(reply);
    }

    async function getReply(msg) {
      const name = userProfile?.name ? `, ${userProfile.name}` : "";
      const system = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. Use the student's name naturally${name}. Be encouraging and explain step-by-step.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4",
            messages: [{ role: "system", content: system }, ...history.slice(-10), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch { return "No internet connection."; }
    }

    async function playVoiceResponse(text) {
      if (!elevenlabsKey) return;
      try {
        const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB`, {
          method: 'POST',
          headers: { 'xi-api-key': elevenlabsKey, 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, model_id: 'eleven_turbo_v2_5' })
        });
        const blob = await res.blob();
        const audio = new Audio(URL.createObjectURL(blob));
        await audio.play();
      } catch { }
    }

    function addMessage(content, sender, plainText = '', imageUrl = null) {
      const div = document.createElement('div');
      div.className = `message ${sender} flex flex-col`;
      const time = formatTime();
      const hasImage = content.includes('<img');
      const actions = sender === 'ai' ? `
        <div class="ai-actions">
          <button class="action-btn copy-btn"><i data-lucide="copy"></i></button>
          <button class="action-btn voice-btn"><i data-lucide="volume-2"></i></button>
          <button class="action-btn pdf-btn"><i data-lucide="download"></i></button>
          <button class="action-btn whatsapp-btn"><i data-lucide="share-2"></i></button>
          <button class="action-btn like-btn"><i data-lucide="thumbs-up"></i></button>
          <button class="action-btn dislike-btn"><i data-lucide="thumbs-down"></i></button>
        </div>` : '';
      div.innerHTML = `
        <div class="content">${sender === 'ai' ? marked.parse(content) : content.replace(/\n/g, '<br>')}</div>
        ${actions}
        <div class="timestamp">${time}</div>`;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();

      if (sender === 'ai') {
        div.querySelector('.copy-btn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plainText || content);
          customAlert("Copied!");
        });
        div.querySelector('.voice-btn')?.addEventListener('click', () => playVoiceResponse(plainText || content));
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11); doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_${new Date().toISOString().slice(0,10)}.pdf`);
        });
        div.querySelector('.whatsapp-btn')?.addEventListener('click', () => {
          shareToWhatsApp(plainText || content, hasImage ? imageUrl : null);
        });
        div.querySelector('.like-btn')?.addEventListener('click', () => customAlert("Thanks!"));
        div.querySelector('.dislike-btn')?.addEventListener('click', () => customAlert("We'll improve!"));
      }
    }

    els.sendBtn.onclick = async () => {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      if (!(await deductTokens(estimateTokens(text)))) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="Homework">`, 'user', '', currentImage);
        history.push({ role: "user", content: currentImage });
        text = "Explain this homework step by step";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null;
      showThinking();
      const reply = await getReply(text);
      hideThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    };

    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
    });

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'studybuddy');
      const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.secure_url) {
        currentImage = data.secure_url;
        customAlert("Image ready! Tap send");
      }
    };

    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
      await loadTokens();

      const snap = await get(child(ref(db), `users/${user.uid}/profile`));
      userProfile = snap.val();
      if (!userProfile) {
        addMessage(`Sawubona! I'm Vynix Buddy, your personal CAPS tutor.\n\nWhat's your name?`, 'ai');
      } else {
        addMessage(`Welcome back, ${userProfile.name}! Ready for Grade ${userProfile.grade} today?`, 'ai');
      }
    });
  </script>
</body>
</html>
