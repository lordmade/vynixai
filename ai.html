<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Vynix ‚Äì Posts</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #ffffff; --card: #f7f9fa; --text: #0f1419;
      --text2: #536471; --border: #e1e8ed; --accent: #ff2a6d;
    }
    [data-theme="dark"] {
      --bg: #0f1419; --card: #1a1f25; --text: #ffffff;
      --text2: #8b98a5; --border: #2f3336;
    }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg); color: var(--text);
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
      margin: 0; padding: 0;
    }
    .composer {
      display: flex; gap: 12px; padding: 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .composer img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea {
      flex: 1; resize: none; background: transparent; color: var(--text);
      border: none; outline: none; font-size: 18px; min-height: 50px;
    }
    .media-preview { max-width: 100%; border-radius: 12px; margin-top: 8px; }
    .composer-actions {
      display: flex; align-items: center; justify-content: space-between; margin-top: 8px;
    }
    .icon-btn {
      background: none; border: none; color: var(--text2);
      cursor: pointer; padding: 8px; border-radius: 50%; font-size: 22px;
      transition: all .2s;
    }
    .icon-btn:hover { background: rgba(255,42,109,.1); color: var(--accent); }
    .post-btn {
      background: var(--accent); color: #fff;
      border: none; border-radius: 999px; padding: 10px 24px;
      font-weight: 600; font-size: 15px; cursor: pointer;
      display: flex; align-items: center; gap: 8px;
    }
    .post-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .spinner {
      width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff; border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .feed { padding-bottom: 100px; }
    .post-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; margin: 12px 16px; padding: 16px;
    }
    .post-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
    }
    .post-header img { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }
    .post-header .name { font-weight: 700; font-size: 15px; }
    .post-header .handle { color: var(--text2); font-size: 14px; }
    .post-header .time { margin-left: auto; color: var(--text2); font-size: 13px; }
    .post-body { margin-top: 8px; white-space: pre-wrap; font-size: 15px; line-height: 1.5; }
    .post-image { max-width: 100%; border-radius: 12px; margin-top: 12px; }
    .post-footer {
      display: flex; justify-content: space-between; margin-top: 16px;
      color: var(--text2); font-size: 14px;
    }
    .post-footer span {
      cursor: pointer; display: flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px; transition: all .2s;
    }
    .post-footer span:hover { background: rgba(255,42,109,.08); color: var(--accent); }
  </style>
</head>
<body>

  <!-- Composer -->
  <div class="composer">
    <img id="my-avatar" src="https://ui-avatars.com/api/?background=05d9e8&color=fff&name=U" />
    <div style="flex:1">
      <textarea id="post-text" rows="3" placeholder="What's happening?"></textarea>
      <img id="media-preview" class="media-preview hidden" alt="Preview" />
      <div class="composer-actions">
        <div>
          <input type="file" id="file-input" accept="image/*,video/*" class="hidden" />
          <label for="file-input" class="icon-btn material-icons">image</label>
        </div>
        <button id="post-btn" class="post-btn" disabled>
          <span id="btn-text">Post</span>
          <span id="btn-spinner" class="spinner hidden"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Feed -->
  <main id="feed" class="feed"></main>

  <!-- Firebase SDK + App Script -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { 
      getDatabase, 
      ref, 
      push, 
      set, 
      onValue, 
      serverTimestamp,
      query,
      orderByChild
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM Elements
    const postBtn     = document.getElementById('post-btn');
    const textEl      = document.getElementById('post-text');
    const previewEl   = document.getElementById('media-preview');
    const fileInput   = document.getElementById('file-input');
    const avatarEl    = document.getElementById('my-avatar');
    const btnText     = document.getElementById('btn-text');
    const btnSpinner  = document.getElementById('btn-spinner');
    const feed        = document.getElementById('feed');

    let currentUser = null;
    let mediaUrl = '';
    let isUploading = false;

    // Apply saved theme
    const applyTheme = () => {
      const saved = localStorage.getItem('vynix-settings');
      if (!saved) return;
      const { darkMode } = JSON.parse(saved);
      if (darkMode) document.body.setAttribute('data-theme', 'dark');
    };
    applyTheme();

    // Auth State
    onAuthStateChanged(auth, user => {
      if (!user) {
        location.href = 'login.html';
        return;
      }

      currentUser = user;
      const name = user.displayName || user.email.split('@')[0];
      const photo = user.photoURL || `https://ui-avatars.com/api/?background=05d9e8&color=fff&name=${encodeURIComponent(name)}`;

      avatarEl.src = photo;
      loadFeed();
    });

    // Enable/Disable Post Button
    const updatePostButton = () => {
      const hasText = textEl.value.trim().length > 0;
      const hasMedia = !!mediaUrl;
      postBtn.disabled = isUploading || (!hasText && !hasMedia);
    };

    textEl.addEventListener('input', updatePostButton);

    // Media Upload to Cloudinary
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        previewEl.src = reader.result;
        previewEl.classList.remove('hidden');
      };
      reader.readAsDataURL(file);

      uploadMedia(file);
    });

    const uploadMedia = (file) => {
      isUploading = true;
      btnText.classList.add('hidden');
      btnSpinner.classList.remove('hidden');
      updatePostButton();

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'vynix_posts');

      fetch('https://api.cloudinary.com/v1_1/dk5d7xkhz/upload', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.secure_url) {
          mediaUrl = data.secure_url;
          toast('Media ready!');
        } else {
          throw new Error('Upload failed');
        }
      })
      .catch(err => {
        console.error(err);
        toast('Upload failed');
        previewEl.classList.add('hidden');
        fileInput.value = '';
      })
      .finally(() => {
        isUploading = false;
        btnText.classList.remove('hidden');
        btnSpinner.classList.add('hidden');
        updatePostButton();
      });
    };

    // Post to Firebase
    postBtn.addEventListener('click', async () => {
      if (postBtn.disabled) return;

      const text = textEl.value.trim();
      if (!text && !mediaUrl) return toast('Say something or add media');

      const postRef = push(ref(db, 'posts'));

      try {
        await set(postRef, {
          authorId: currentUser.uid,
          authorName: currentUser.displayName || currentUser.email.split('@')[0],
          authorAvatar: currentUser.photoURL || avatarEl.src,
          text: text,
          image: mediaUrl || '',
          likes: 0,
          replies: 0,
          reposts: 0,
          timestamp: serverTimestamp()
        });

        // Reset form
        textEl.value = '';
        mediaUrl = '';
        previewEl.classList.add('hidden');
        previewEl.src = '';
        fileInput.value = '';
        updatePostButton();
        toast('Posted!');
      } catch (err) {
        console.error(err);
        toast('Failed to post');
      }
    });

    // Load Feed
    const loadFeed = () => {
      const postsQuery = query(ref(db, 'posts'), orderByChild('timestamp'));

      onValue(postsQuery, snapshot => {
        const posts = [];
        snapshot.forEach(child => {
          const post = child.val();
          if (post.timestamp) {
            posts.push({
              id: child.key,
              ...post
            });
          }
        });

        // Sort newest first
        posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        feed.innerHTML = '';
        posts.forEach(post => feed.appendChild(createPostCard(post)));
      });
    };

    // Create Post Card
    const createPostCard = (post) => {
      const card = document.createElement('div');
      card.className = 'post-card';

      const time = post.timestamp ? timeAgo(post.timestamp) : 'Just now';

      card.innerHTML = `
        <div class="post-header">
          <img src="${post.authorAvatar || 'https://ui-avatars.com/api/?background=05d9e8&color=fff&name=U'}" alt="avatar" />
          <div style="flex:1">
            <div class="name">${escapeHtml(post.authorName || 'User')}</div>
            <div class="handle">@\( {(post.authorName || 'user').replace(/\s/g,'').toLowerCase()} ¬∑ \){time}</div>
          </div>
        </div>
        <div class="post-body">${escapeHtml(post.text || '')}</div>
        \( {post.image ? `<img class="post-image" src=" \){post.image}" loading="lazy" />` : ''}
        <div class="post-footer">
          <span>üí¨ ${post.replies || 0}</span>
          <span>üîÅ ${post.reposts || 0}</span>
          <span>‚ù§Ô∏è ${post.likes || 0}</span>
          <span>üì§</span>
        </div>
      `;

      return card;
    };

    // Toast Notification
    const toast = (msg) => {
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = `
        position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
        background:#ff2a6d; color:white; padding:14px 28px; border-radius:50px;
        font-size:15px; z-index:10000; animation:toast 3s forwards;
      `;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    };

    // Helpers
    const escapeHtml = (text) => {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };

    const timeAgo = (timestamp) => {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
      return `${Math.floor(seconds / 86400)}d`;
    };

    // Toast animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes toast {
        0%, 100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        15%, 85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
