<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <title>Vynix Lingua â€“ Multilingual African AI</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  <style>
    /* ---------- Design Tokens (matched to WhatsApp clone style) ---------- */
    :root{
      --primary-black: #000;
      --primary-white: #fff;
      --gray-light: #f5f5f5;
      --gray-mid: #9e9e9e;
      --bubble-own: #e0e0e0;
      --bubble-other: #fff;
      --header-height: 60px;
      --tabbar-height: 70px;
      --pill-radius: 25px;
      --verified-blue: #1DA1F2;
      --accent-blue: #2563eb;
      --logo-gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 50%, #10b981 100%);
      --bg-color: #ffffff;
      --surface-color: #f3f6fc;
      --text-primary: #1e1e1e;
      --text-secondary: #444746;
      --text-muted: #9aa0a6;
      --shadow-soft: 0 8px 32px rgba(0,0,0,.06);
      --font-main: 'Noto Sans', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:var(--font-main);background:var(--gray-light);color:var(--text-primary);
         height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none;
         -webkit-font-smoothing:antialiased}
    .app-container{position:relative;width:100%;height:100%;display:flex;flex-direction:column;background:var(--primary-white)}
    @media (min-width:768px){.app-container{max-width:450px;margin:0 auto;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}}

    /* Header - Black like WhatsApp */
    .whatsapp-header{height:var(--header-height);background:var(--primary-black);display:flex;align-items:center;justify-content:space-between;
                     padding:0 16px;z-index:100;transition:transform .3s}
    .header-title{font-family:var(--font-head);font-weight:600;font-size:18px;color:var(--primary-white);display:flex;align-items:center;gap:8px}
    .header-actions{display:flex;gap:16px}
    .header-icon{color:var(--primary-white);font-size:24px;cursor:pointer}

    /* Tabbar - Pill style like WhatsApp */
    .whatsapp-tabbar{position:fixed;bottom:0;left:0;right:0;height:var(--tabbar-height);display:flex;justify-content:center;
                      padding-top:10px;z-index:1000;pointer-events:none;transition:transform .3s ease}
    @media (min-width:768px){.whatsapp-tabbar{left:50%;transform:translateX(-50%);max-width:450px}}
    .pill-tabs{background:var(--primary-white);border-radius:var(--pill-radius);box-shadow:0 4px 20px rgba(0,0,0,.15);
               display:flex;padding:6px;gap:4px;pointer-events:all}
    .pill-tab{display:flex;align-items:center;gap:8px;padding:10px 20px;border-radius:20px;color:var(--gray-mid);
              font-size:14px;font-weight:500;cursor:pointer;min-width:80px;justify-content:center}
    .pill-tab.active{background:var(--primary-black);color:var(--primary-white);transform:scale(1.05)}

    /* Chat container */
    .chat-container{flex:1;overflow-y:auto;padding:20px 0 160px;display:flex;flex-direction:column;scroll-behavior:smooth;background:var(--gray-light)}

    /* Messages - WhatsApp bubble style */
    .message-row{display:flex;margin-bottom:4px;max-width:70%;position:relative}
    .message-row.user{margin-left:auto;align-items:flex-end;flex-direction:column}
    .message-row.ai{margin-right:auto;align-items:flex-start;flex-direction:column;padding-left:50px}
    .message-content{padding:8px 12px;border-radius:8px;line-height:1.3;font-size:14px;word-wrap:break-word;
                     position:relative;box-shadow:0 1px .5px rgba(0,0,0,.13)}
    .message-row.user .message-content{background:var(--bubble-own);color:#000;border-radius:8px 8px 0 8px}
    .message-row.ai .message-content{background:var(--bubble-other);color:#000;border-radius:8px 8px 8px 0;box-shadow:0 1px .5px rgba(0,0,0,.13)}
    .bubble-time{font-size:11px;color:rgba(0,0,0,.5);margin-top:4px;text-align:right}
    .avatar{width:40px;height:40px;border-radius:50%;background:var(--logo-gradient);color:#fff;display:flex;align-items:center;justify-content:center;
            position:absolute;left:0;top:0;font-size:20px}
    .typing-indicator{padding:8px 12px;background:var(--bubble-other);border-radius:8px 8px 8px 0;margin-bottom:4px}
    .typing-dots{display:flex;gap:3px}
    .typing-dot{width:6px;height:6px;background:#9aa0a6;border-radius:50%;animation:typingBounce 1.2s infinite}
    .typing-dot:nth-child(2){animation-delay:.1s}
    .typing-dot:nth-child(3){animation-delay:.2s}
    @keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

    /* Input bar - WhatsApp style */
    .input-wrapper-fixed{position:fixed;bottom:0;left:0;right:0;background:var(--primary-white);padding:8px 16px;
                         display:flex;align-items:flex-end;gap:8px;border-top:1px solid rgba(0,0,0,.05);z-index:300}
    @media (min-width:768px){.input-wrapper-fixed{left:50%;transform:translateX(-50%);max-width:450px}}
    .input-wrapper{flex:1;background:var(--gray-light);border-radius:24px;padding:8px 16px;display:flex;align-items:center;gap:8px;min-height:44px}
    .whatsapp-input{flex:1;border:none;background:transparent;font-size:15px;outline:none;resize:none;max-height:100px}
    .send-btn{width:44px;height:44px;border-radius:50%;background:var(--primary-black);color:#fff;border:none;
              display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
    .mic-btn{width:44px;height:44px;border-radius:50%;background:transparent;color:var(--gray-mid);border:none;
             display:flex;align-items:center;justify-content:center;cursor:pointer}

    /* Token counter */
    .token-counter{position:absolute;top:-40px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.95);
                   padding:6px 16px;border-radius:20px;font-size:12px;font-weight:500;color:var(--text-secondary);
                   box-shadow:0 2px 8px rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.06);white-space:nowrap}

    /* Snackbar */
    #customSnackbar{visibility:hidden;min-width:250px;background:#333;color:#fff;text-align:center;
                     border-radius:8px;padding:12px;position:fixed;z-index:1000;left:50%;bottom:100px;
                     transform:translateX(-50%);box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;
                     transition:opacity .3s,bottom .3s;font-size:14px;font-weight:500}
    #customSnackbar.show{visibility:visible;opacity:1;bottom:80px}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="whatsapp-header">
      <div class="header-title">
        <span class="material-symbols-rounded" style="background:var(--logo-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent">auto_awesome</span>
        Vynix Lingua
      </div>
      <div class="header-actions">
        <span class="material-symbols-rounded header-icon">search</span>
        <span class="material-symbols-rounded header-icon">more_vert</span>
      </div>
    </header>

    <!-- Chat messages -->
    <main class="chat-container" id="chatContainer">
      <div id="messagesList"></div>
    </main>

    <!-- Input bar -->
    <div class="input-wrapper-fixed">
      <div class="token-counter" id="tokenCounter">
        <span class="token-count" id="tokenCount">0</span> / 10,000 tokens
      </div>
      <div class="input-wrapper">
        <button class="mic-btn" id="micBtn"><span class="material-symbols-rounded">mic</span></button>
        <textarea class="whatsapp-input" id="input" placeholder="Type a message..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn"><span class="material-symbols-rounded">send</span></button>
      </div>
    </div>
  </div>

  <div id="customSnackbar"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const db = getFirestore(app);

    const DAILY_TOKEN_LIMIT = 10000;
    const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";

    let historyStack = [];

    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn');
    const $list = $('#messagesList');
    const $customSnackbar = $('#customSnackbar');
    const $tokenCounter = $('#tokenCounter');
    const $tokenCount = $('#tokenCount');

    function showCustomSnackbar(msg) {
      $customSnackbar.textContent = msg;
      $customSnackbar.classList.add('show');
      setTimeout(() => $customSnackbar.classList.remove('show'), 3000);
    }

    function updateTokenCounter(used, limit = DAILY_TOKEN_LIMIT) {
      $tokenCount.textContent = used.toLocaleString();
      const percentage = (used / limit) * 100;
      $tokenCounter.classList.remove('warning', 'danger');
      if (percentage >= 90) $tokenCounter.classList.add('danger');
      else if (percentage >= 75) $tokenCounter.classList.add('warning');
    }

    async function getCurrentTokenUsage() {
      const user = auth.currentUser;
      if (!user) return 0;
      const uid = user.uid;
      const today = new Date().toISOString().slice(0, 10);
      const usageRef = doc(db, 'tokenUsage', uid);
      const usageSnap = await getDoc(usageRef);
      const data = usageSnap.data() || {};
      return data.date === today ? (data.used || 0) : 0;
    }

    async function initializeTokenCounter() {
      const usage = await getCurrentTokenUsage();
      updateTokenCounter(usage);
    }

    async function checkAndUpdateTokenUsage(estimatedTokens) {
      const user = auth.currentUser;
      if (!user) return true;
      const uid = user.uid;
      const today = new Date().toISOString().slice(0, 10);
      const usageRef = doc(db, 'tokenUsage', uid);
      const usageSnap = await getDoc(usageRef);
      const data = usageSnap.data() || {};
      if (data.date !== today) {
        await setDoc(usageRef, { date: today, used: estimatedTokens, timestamp: serverTimestamp() });
        return true;
      }
      const newTotal = data.used + estimatedTokens;
      if (newTotal > DAILY_TOKEN_LIMIT) {
        showCustomSnackbar(`Daily limit reached (${DAILY_TOKEN_LIMIT.toLocaleString()} tokens). Try again tomorrow.`);
        return false;
      }
      await setDoc(usageRef, { used: newTotal, timestamp: serverTimestamp() }, { merge: true });
      return true;
    }

    function addMessage(text, type) {
      const row = document.createElement('div');
      row.className = `message-row ${type}`;
      const bubble = document.createElement('div');
      bubble.className = 'message-content';
      bubble.innerHTML = text.replace(/\n/g, '<br>');
      const time = document.createElement('div');
      time.className = 'bubble-time';
      time.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      bubble.appendChild(time);

      if (type === 'ai') {
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
        row.append(avatar, bubble);
      } else {
        row.appendChild(bubble);
      }
      $list.appendChild(row);
      $list.scrollTop = $list.scrollHeight;
    }

    function addLoading() {
      const row = document.createElement('div');
      row.id = 'loading';
      row.className = 'message-row ai';
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
      const typing = document.createElement('div');
      typing.className = 'typing-indicator';
      typing.innerHTML = '<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
      row.append(avatar, typing);
      $list.appendChild(row);
      $list.scrollTop = $list.scrollHeight;
    }

    function removeLoading() {
      const loading = $('#loading');
      if (loading) loading.remove();
    }

    window.sendMessage = async () => {
      const msg = $i.value.trim();
      if (!msg) return;
      if (!auth.currentUser) {
        showCustomSnackbar('Please sign in to chat.');
        return;
      }
      $i.value = '';
      $i.style.height = 'auto';
      addMessage(msg, 'user');

      const estimatedInputTokens = Math.ceil(msg.length / 4) + 200;
      const allowed = await checkAndUpdateTokenUsage(estimatedInputTokens);
      if (!allowed) {
        addMessage('You have reached your daily token limit.', 'ai');
        return;
      }

      addLoading();
      try {
        const messages = [...historyStack, { role: 'user', content: msg }];
        const res = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: { Authorization: `Bearer ${XAI_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'grok-4',
            messages,
            temperature: 0.7,
            max_tokens: 1500
          })
        });
        removeLoading();
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || 'No response.';
        const outputTokens = Math.ceil(reply.length / 4);
        await checkAndUpdateTokenUsage(outputTokens);
        addMessage(reply, 'ai');
        historyStack.push({ role: 'user', content: msg }, { role: 'assistant', content: reply });
        await initializeTokenCounter();
      } catch (e) {
        removeLoading();
        addMessage('Connection error. Please try again.', 'ai');
        console.error(e);
      }
    };

    $i.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      $send.style.display = this.value.trim() ? 'flex' : 'none';
    });

    $i.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    $send.addEventListener('click', sendMessage);

    onAuthStateChanged(auth, async user => {
      if (user) {
        await initializeTokenCounter();
      }
    });

    // Initial system prompt
    historyStack = [{ role: 'system', content: 'You are Vynix Lingua, a helpful multilingual African AI assistant.' }];
  </script>
</body>
</html>
