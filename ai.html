<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyBuddy – Your Child’s Private Tutor (Grade 1–12)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #F8FAFC; margin: 0; }
    .message { max-width: 85%; margin: 8px 0; }
    .message.user { margin-left: auto; }
    .message.ai { margin-right: auto; }
    .message.user .content { background: linear-gradient(135deg, #DBEAFE, #C7D2FE); color: #1E1E1E; }
    .message.ai .content { background: linear-gradient(135deg, #1E293B, #334155); color: white; }
    #api-status { width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s; }
    #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }
    #tokenFill { height: 100%; background: linear-gradient(90deg, #10B981, #34D399); transition: width 0.6s ease; }
    .upgrade-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; }
    .upgrade-modal.show { display: flex; }
    .typing::after { content: "..."; animation: dots 1.5s infinite; }
    @keyframes dots { 0%, 20% { content: "."; } 40% { content: ".."; } 60% { content: "..."; } }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Top Bar -->
  <header class="flex items-center justify-between p-4 bg-white border-b border-gray-200 shadow-sm">
    <button id="menuBtn" class="p-2 rounded-lg hover:bg-gray-100">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <h1 class="text-xl font-bold text-gray-800">StudyBuddy</h1>
    <div id="api-status"></div>
  </header>

  <!-- Chat Area -->
  <section id="chatPane" class="flex-1 overflow-y-auto p-4 space-y-4 pb-32">
    <div id="welcome" class="text-center my-20">
      <h2 class="text-3xl font-bold text-gray-800 mb-3">Hey there! Ready to crush school?</h2>
      <p class="text-lg text-gray-600">Ask anything • Paste homework photos • I’ll explain step-by-step</p>
    </div>
  </section>

  <!-- Input Bar -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg">
    <div class="flex gap-3 items-center bg-gray-100 rounded-full px-5 py-3">
      <input id="chatInput" type="text" placeholder="Ask me anything or paste a photo..." class="flex-1 bg-transparent outline-none text-lg">
      <button id="sendBtn" class="text-emerald-600">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
      </button>
    </div>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-white shadow-2xl transform -translate-x-full transition z-40 flex flex-col">
    <div class="p-6 border-b bg-gradient-to-br from-emerald-500 to-teal-600 text-white">
      <div class="flex items-center gap-4">
        <div id="userLetter" class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold">U</div>
        <div>
          <div id="userName" class="text-xl font-bold">Loading...</div>
          <div class="text-sm opacity-90">Grade 1–12 Tutor</div>
        </div>
      </div>
    </div>

    <div class="p-6 border-b">
      <div class="flex justify-between text-sm mb-2">
        <span>Tokens today</span>
        <span id="tokenCount">0 / 15,000</span>
      </div>
      <div class="h-3 bg-gray-200 rounded-full overflow-hidden"><div id="tokenFill" class="w-0"></div></div>
    </div>

    <div class="flex-1 overflow-y-auto p-4" id="convList"></div>

    <div class="p-6 space-y-4 border-t">
      <button id="upgradeBtn" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold py-4 rounded-xl text-lg shadow-lg hover:shadow-xl transition">
        Upgrade to Pro • R799/month
      </button>
      <div class="text-center text-sm text-gray-500">Free • 15,000 tokens/day</div>
    </div>
  </aside>

  <!-- Upgrade Modal (Rands) -->
  <div id="upgradeModal" class="upgrade-modal">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
      <h2 class="text-3xl font-bold mb-6">Go Unlimited!</h2>
      <div class="space-y-5 mb-8 text-lg">
        <div>Unlimited messages & homework photos</div>
        <div>All subjects Grade 1–12</div>
        <div>Parent progress reports</div>
        <div>Cancel anytime</div>
      </div>
      <button id="mockCheckout" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold py-5 rounded-2xl text-xl shadow-lg">
        Start Free Trial → R799/month
      </button>
      <button id="closeModal" class="mt-4 text-gray-500 w-full">Maybe later</button>
    </div>
  </div>

  <div id="overlay" class="fixed inset-0 bg-black/60 z-30 hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const elements = {
      chatPane: document.getElementById('chatPane'),
      welcome: document.getElementById('welcome'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      menuBtn: document.getElementById('menuBtn'),
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('overlay'),
      tokenCount: document.getElementById('tokenCount'),
      tokenFill: document.getElementById('tokenFill'),
      userName: document.getElementById('userName'),
      userLetter: document.getElementById('userLetter'),
      upgradeModal: document.getElementById('upgradeModal'),
      mockCheckout: document.getElementById('mockCheckout'),
      closeModal: document.getElementById('closeModal'),
      upgradeBtn: document.getElementById('upgradeBtn')
    };

    let xaiApiKey = null;
    let userId = null;
    let todayTokens = 0;
    let isPro = false;
    const FREE_LIMIT = 15000;
    const PRO_LIMIT = 1000000;
    let history = [];
    let currentImage = null;

    const TUTOR_PROMPT = `You are StudyBuddy, the most patient and fun personal tutor for students Grade 1–12.

Student: Grade 1–12 (auto-detect from question)
Rules:
- Match vocabulary and depth to exact grade
- Grade 1–3 → short sentences, emojis, stories
- Grade 4–8 → clear steps, analogies, humor
- Grade 9–12 → rigorous but warm
- Always ask “Got it?” or “Want a quiz?”
- Celebrate wins with confetti and fun facts
- Never shame mistakes
- Analyze uploaded homework photos
- Remember everything forever`;

    // Redirect if not logged in
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        userId = user.uid;
        elements.userName.textContent = user.displayName || user.email.split('@')[0];
        elements.userLetter.textContent = (user.displayName || user.email)[0].toUpperCase();
        initApp();
      }
    });

    async function initApp() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiApiKey = getString(rc, 'xai_api_key')?.trim();
      if (xaiApiKey && xaiApiKey.length > 10) document.getElementById('api-status').classList.add('connected');
      await loadUsage();
    }

    async function loadUsage() {
      const today = new Date().toISOString().slice(0,10);
      const snap = await get(ref(db, `usage/\( {userId}/ \){today}`));
      todayTokens = snap.val() || 0;
      updateTokenUI();
    }

    function updateTokenUI() {
      const limit = isPro ? PRO_LIMIT : FREE_LIMIT;
      elements.tokenCount.textContent = `\( {todayTokens.toLocaleString()} / \){limit.toLocaleString()}`;
      elements.tokenFill.style.width = `${Math.min(100, (todayTokens / limit) * 100)}%`;
    }

    async function addTokens(n) {
      todayTokens += n;
      const today = new Date().toISOString().slice(0,10);
      await set(ref(db, `usage/\( {userId}/ \){today}`), todayTokens);
      updateTokenUI();
      if (!isPro && todayTokens >= FREE_LIMIT) elements.upgradeModal.classList.add('show');
    }

    function estimateTokens(text) { return Math.ceil(text.length / 3.8); }

    async function callGrok(messages, imageUrl = null) {
      const payload = { model: "grok-3", messages, temperature: 0.7, max_tokens: 1500 };
      if (imageUrl) {
        messages[messages.length-1].content = [
          { type: "text", text: messages[messages.length-1].content || "Explain this homework" },
          { type: "image_url", image_url: { url: imageUrl } }
        ];
      }
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      return await res.json();
    }

    async function getReply(userMsg) {
      const msgs = [{ role: "system", content: TUTOR_PROMPT }];
      history.slice(-30).forEach(m => msgs.push({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.content }));
      msgs.push({ role: "user", content: userMsg });

      const inputTokens = estimateTokens(JSON.stringify(msgs));
      if (!isPro && todayTokens + inputTokens > FREE_LIMIT) {
        elements.upgradeModal.classList.add('show');
        return "You've reached your daily limit! Upgrade to Pro for unlimited tutoring.";
      }

      const data = await callGrok(msgs, currentImage);
      const reply = data.choices?.[0]?.message?.content || "I'm having trouble thinking. Try again!";
      const outputTokens = estimateTokens(reply);
      await addTokens(inputTokens + outputTokens);
      return reply;
    }

    function addMessage(text, sender, isTyping = false) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const content = document.createElement('div');
      content.className = 'content rounded-2xl px-5 py-3 shadow-md';
      content.innerHTML = isTyping ? '<span class="typing"></span>' : marked.parse(text);
      div.appendChild(content);
      elements.chatPane.appendChild(div);
      elements.chatPane.scrollTop = elements.chatPane.scrollHeight;
      return content;
    }

    async function send() {
      let text = elements.chatInput.value.trim();
      if (!text && !currentImage) return;
      elements.welcome.classList.add('hidden');

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full">`, 'user');
      } else {
        addMessage(text, 'user');
      }

      elements.chatInput.value = ''; currentImage = null;
      const typingEl = addMessage('', 'ai', true);
      history.push({ sender: 'user', content: text || "[Photo]" });

      const reply = await getReply(text || "Explain this homework");
      typingEl.parentElement.remove();
      addMessage(reply, 'ai');
      history.push({ sender: 'ai', content: reply });
    }

    // Paste image support
    document.addEventListener('paste', e => {
      const file = e.clipboardData?.files[0];
      if (file?.type.startsWith('image/')) {
        currentImage = URL.createObjectURL(file);
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full">`, 'user');
      }
    });

    // Events
    elements.sendBtn.onclick = send;
    elements.chatInput.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });
    elements.menuBtn.onclick = () => { elements.sidebar.classList.add('open'); elements.overlay.classList.remove('hidden'); };
    elements.overlay.onclick = () => { elements.sidebar.classList.remove('open'); elements.overlay.classList.add('hidden'); };
    elements.upgradeBtn.onclick = () => elements.upgradeModal.classList.add('show');
    elements.closeModal.onclick = () => elements.upgradeModal.classList.remove('show');
    elements.mockCheckout.onclick = () => {
      isPro = true;
      alert("Welcome to StudyBuddy Pro! You now have 1,000,000 tokens/month");
      elements.upgradeModal.classList.remove('show');
      updateTokenUI();
    };
  </script>
</body>
</html>
