<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy - CAPS AI Tutor</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vynix Buddy">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">
  
  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  
  <style>
    * { box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    textarea, input, .content, .selectable { -webkit-user-select: text; user-select: text; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #faf8ff;
      color: #1f1f1f;
      margin: 0;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding-bottom: env(safe-area-inset-bottom); /* iOS safe area */
    }

    /* Token Bar + Profile */
    .token-bar {
      position: fixed; top: 0; left: 0; right: 0;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: #fff;
      padding: 0.75rem 1rem;
      padding-top: calc(0.75rem + env(safe-area-inset-top));
      font-size: 0.95rem;
      text-align: center;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.25);
    }
    
    #upgradePill {
      margin-left: 12px;
      padding: 6px 16px;
      background: #fff3;
      border: 1px solid #fff4;
      border-radius: 50px;
      font-weight: 600;
      transition: all .2s;
      cursor: pointer;
    }
    #upgradePill:active { transform: scale(0.94); }

    /* Desktop Hover Trigger */
    #desktopHoverTrigger {
      display: none;
    }
    @media (min-width: 768px) {
      #menuBtn { display: none !important; }
      #desktopHoverTrigger {
        display: flex !important;
        position: fixed;
        left: 0; top: 50%;
        transform: translateY(-50%);
        height: 120px; width: 48px;
        background: #8b5cf6;
        border-radius: 0 25px 25px 0;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        z-index: 40;
        align-items: center; justify-content: center;
        cursor: pointer;
        transition: width 0.3s ease;
      }
      #desktopHoverTrigger:hover { width: 56px; }
      
      /* Hover intent for sidebar */
      #desktopHoverTrigger:hover ~ #convoSidebar,
      #convoSidebar:hover {
        transform: translateX(0);
      }
    }

    /* Profile Dropdown */
    #profileDropdown {
      position: absolute; right: 8px; top: 100%;
      margin-top: 8px; width: 280px;
      background: #fff; border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.18);
      opacity: 0; pointer-events: none;
      transform: translateY(-12px);
      transition: all .25s cubic-bezier(0.32,0.72,0,1);
      z-index: 999;
    }
    #profileDropdown.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

    /* Chat Messages */
    #chatPane {
      flex: 1; overflow-y: auto;
      padding: 80px 1rem 160px;
      -webkit-overflow-scrolling: touch;
    }
    
    .message {
      margin: 1.2rem 0; display: flex; flex-direction: column;
      align-items: flex-start; animation: fadeIn 0.4s ease-out forwards; width: 100%;
    }
    .message.ai { align-items: flex-start; }
    .message.user { align-items: flex-end; }
    
    .message .content {
      max-width: 100%; width: 100%;
      padding: 14px 18px; border-radius: 24px;
      line-height: 1.55; font-size: 1.02rem;
      position: relative; word-wrap: break-word;
      box-shadow: 0 3px 10px rgba(0,0,0,0.09);
    }
    
    .message.ai .content {
      background: linear-gradient(135deg, #f8f6ff 0%, #f0e8ff 100%);
      border: 1px solid #e0d6ff; border-bottom-left-radius: 6px;
      color: #312069;
    }
    .message.user .content {
      background: #fff; border: 1.8px solid #c4b5fd;
      border-bottom-right-radius: 6px; color: #1f1f1f; font-weight: 500;
    }
    
    /* Action Buttons */
    .ai-actions {
      display: flex; gap: 12px; padding: 8px 18px 0 18px;
    }
    .action-btn {
      width: 40px; height: 40px; background: #fff; border: none;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.14); transition: all .22s ease;
      cursor: pointer;
    }
    .action-btn:hover { transform: translateY(-4px) scale(1.1); }

    /* Thinking Dots */
    .thinking { display: flex; gap: 9px; padding: 16px 20px; }
    .dot { width: 11px; height: 11px; background: #a78bfa; border-radius: 50%; animation: pulse 1.5s infinite; }
    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }
    @keyframes pulse { 0%,100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }
    
    /* Input Bar */
    .input-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      padding: 0.75rem;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
      background: #fff; border-top: 1px solid #e2e8f0;
      box-shadow: 0 -6px 30px rgba(0,0,0,0.1); z-index: 100;
    }
    
    .input-container {
      background: #f8fafc; border: 2px solid #e2e8f0;
      border-radius: 28px; padding: 10px 16px;
      display: flex; align-items: center; gap: 12px;
      transition: all .2s;
    }
    .input-container:focus-within {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.18);
      background: #fff;
    }
    
    #chatInput {
      flex: 1; background: transparent; border: none; outline: none;
      font-size: 1.05rem; resize: none; max-height: 140px; line-height: 1.5;
    }
    
    .send-btn, .upload-btn {
      width: 48px; height: 48px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      transition: all .2s;
    }
    .send-btn {
      background: #8b5cf6; color: #fff;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    .send-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
    .upload-btn { background: #e2e8f0; }
    
    /* Bottom Sheets */
    .bottom-sheet {
      position: fixed; bottom: -100%; left: 0; right: 0;
      background: #fff; border-radius: 24px 24px 0 0;
      padding: 1.5rem; box-shadow: 0 -10px 40px rgba(0,0,0,0.25);
      transition: bottom .4s cubic-bezier(.32,.72,0,1); z-index: 200;
      max-height: 92dvh; overflow-y: auto;
    }
    .bottom-sheet.active { bottom: 0; }
    .sheet-handle { width: 40px; height: 5px; background: #ddd; border-radius: 3px; margin: 0 auto 1rem; }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    
    /* PWA Adjustments */
    @media (display-mode: standalone) {
      .token-bar { padding-top: calc(0.75rem + env(safe-area-inset-top)); }
      .input-bar { padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); }
    }
    
    /* Sidebar */
    #convoSidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
    #convoSidebar.translate-x-0 { transform: translateX(0); }
    #sidebarOverlay { display: none; }
    #sidebarOverlay.active { display: block !important; }
    
    .convo-item {
      padding: 1rem 1.25rem; border-bottom: 1px solid #f1f5f9;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; gap: 12px;
    }
    .convo-item:hover { background: #f8f6ff; }
    .convo-item.active {
      background: linear-gradient(135deg, #f3e8ff, #e0d6ff);
      font-weight: 600;
    }
    .convo-item .title { flex: 1; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .convo-item .timestamp { font-size: 0.75rem; color: #94a3b8; opacity: 0; transition: opacity 0.2s; }
    .convo-item:hover .timestamp { opacity: 1; }
    .convo-item .delete-btn { opacity: 0; transition: opacity 0.2s; }
    .convo-item:hover .delete-btn { opacity: 1; color: #ef4444; }
    
    /* Custom Alert */
    #customAlert {
      position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%) translateY(-120%);
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: #fff; padding: 14px 28px; border-radius: 9999px;
      font-weight: 700; box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      z-index: 9999; transition: transform .35s ease;
      display: none;
    }
    #customAlert.show { display: block; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <!-- TODO: Create manifest.json file -->
  <!-- TODO: Create sw.js service worker file -->
  
  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

  <!-- Desktop Hover Trigger -->
  <div id="desktopHoverTrigger" class="hidden md:flex fixed left-0 top-1/2 -translate-y-1/2 h-28 w-12 bg-purple-600 rounded-r-3xl shadow-lg z-40 items-center justify-center cursor-pointer">
    <i data-lucide="message-square" class="w-6 h-6 text-white"></i>
  </div>

  <!-- Conversations Sidebar -->
  <aside id="convoSidebar" class="fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 transform -translate-x-full">
    <div class="flex items-center justify-between p-5 border-b border-gray-200">
      <h2 class="text-xl font-bold text-purple-600 flex items-center gap-2">
        <i data-lucide="message-square"></i> Your Chats
      </h2>
      <button id="closeSidebar" class="text-gray-500 hover:text-gray-700 transition">
        <i data-lucide="x" class="w-7 h-7"></i>
      </button>
    </div>
    <div class="p-4 border-b border-gray-100">
      <button id="newChatBtn" class="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold py-3 rounded-xl hover:scale-105 active:scale-95 transition">
        <i data-lucide="plus" class="w-5 h-5"></i> New Chat
      </button>
    </div>
    <div id="conversationsList" class="flex-1 overflow-y-auto">
      <!-- Conversations injected by JS -->
    </div>
  </aside>

  <!-- Token Bar -->
  <div class="token-bar">
    <button id="menuBtn" class="md:hidden w-10 h-10 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 transition">
      <i data-lucide="menu" class="w-6 h-6"></i>
    </button>
    <div class="hidden md:block w-12"></div>
    
    <div class="flex items-center gap-2 flex-1 justify-center">
      <span id="tokenCount">15,000</span> tokens left today
      <button id="upgradePill" class="ml-3 px-4 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold text-sm rounded-full border border-white/40 transition active:scale-95">
        Upgrade
      </button>
    </div>

    <!-- Profile Dropdown -->
    <div class="relative ml-auto">
      <button id="profileBtn" class="flex items-center gap-3 px-3 py-1.5 rounded-full hover:bg-white/10 transition">
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-sm">
          <span id="userInitial">U</span>
        </div>
        <div class="text-left hidden sm:block">
          <div id="userName" class="text-white font-medium text-sm">Loading...</div>
          <div id="userGrade" class="text-white/70 text-xs">Grade —</div>
        </div>
        <i data-lucide="chevron-down" class="w-4 h-4 text-white/70"></i>
      </button>

      <div id="profileDropdown" class="absolute right-0 top-full mt-2 w-56 bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-4 border-b border-gray-100">
          <div class="font-bold text-gray-900" id="dropdownName">User</div>
          <div class="text-sm text-gray-500" id="dropdownGrade">Grade —</div>
        </div>
        <button id="signOutBtn" class="w-full px-5 py-3.5 text-left text-red-600 font-medium hover:bg-red-50 transition flex items-center gap-3">
          <i data-lucide="log-out" class="w-5 h-5"></i> Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Pane -->
  <section id="chatPane">
    <!-- Welcome message -->
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <!-- Input Bar -->
  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn" aria-label="Attach file">
        <i data-lucide="paperclip"></i>
      </button>
      <input type="file" id="hiddenFile" accept="image/*,.pdf,.doc,.docx" hidden>
      <img id="filePreview" class="rounded-lg" alt="File preview">
      <div class="doc-preview" id="docPreview">
        <i data-lucide="file-text" width="20" height="20"></i>
      </div>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1" aria-label="Chat input"></textarea>
      <button id="sendBtn" class="send-btn" disabled aria-label="Send">
        <i data-lucide="send" class="text-white"></i>
      </button>
    </div>
  </div>

  <!-- Upgrade Sheet -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-3">Never Run Out of Help Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <span class="text-purple-600 font-bold">Unlimited</span> and study without limits</p>
      <div class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl transform -rotate-2 mb-10">
        <div class="text-6xl font-black">R79</div>
        <div class="text-xl opacity-90">per month</div>
      </div>
      <div class="space-y-6 text-left bg-gray-50 rounded-3xl p-8 mb-8 text-lg font-medium">
        <div class="flex items-center gap-4">✓ Unlimited AI messages</div>
        <div class="flex items-center gap-4">✓ Premium ElevenLabs voice</div>
        <div class="flex items-center gap-4">✓ Download answers as PDF</div>
        <div class="flex items-center gap-4">✓ Faster responses</div>
        <div class="flex items-center gap-4">✓ Support SA education (5% donated)</div>
      </div>
      <button id="mockUpgrade" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">
        Yes! Upgrade Me Now – R79/month
      </button>
    </div>
  </div>

  <!-- Past Papers Sheet -->
  <div id="papersSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('papersSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div id="papersContent" class="px-2"></div>
  </div>

  <!-- Custom Alert -->
  <div id="customAlert" role="alert"></div>

  <script type="module">
    // ==================== FIREBASE INITIALIZATION ====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
    
    lucide.createIcons();
    const { jsPDF } = window.jspdf;
    
    // TODO: Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      appId: "1:YOUR_APP_ID"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    // ==================== GLOBAL STATE ====================
    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let yocoPublicKey = null;
    let yocoEnabled = false;
    let history = [];
    let currentImage = null;
    let currentFile = null;
    let waitingForProfile = false;
    let dailyTokens = 15000;
    let isPremium = false;
    let conversations = [];
    let currentConvoId = null;
    
    // ==================== DOM ELEMENTS (CACHED) ====================
    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      filePreview: document.getElementById('filePreview'),
      docPreview: document.getElementById('docPreview'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      mockUpgrade: document.getElementById('mockUpgrade'),
      upgradePill: document.getElementById('upgradePill'),
      papersSheet: document.getElementById('papersSheet'),
      papersContent: document.getElementById('papersContent'),
      sidebar: document.getElementById('convoSidebar'),
      overlay: document.getElementById('sidebarOverlay'),
      convoList: document.getElementById('conversationsList'),
      profileDropdown: document.getElementById('profileDropdown'),
      profileBtn: document.getElementById('profileBtn'),
      menuBtn: document.getElementById('menuBtn'),
      closeSidebar: document.getElementById('closeSidebar'),
      newChatBtn: document.getElementById('newChatBtn'),
      customAlert: document.getElementById('customAlert'),
      desktopHoverTrigger: document.getElementById('desktopHoverTrigger')
    };
    
    // ==================== UTILITY FUNCTIONS ====================
    function customAlert(msg, duration = 2500) {
      const box = els.customAlert;
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }
    
    function formatTime() { 
      return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); 
    }
    
    function estimateTokens(t) { 
      return Math.ceil((t?.length || 0) / 4) + 150; 
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function getCurrentTerm() {
      const month = new Date().getMonth();
      if (month >= 1 && month <= 3) return 1;   // Feb-Apr
      if (month >= 4 && month <= 6) return 2;   // May-Jul
      if (month >= 7 && month <= 9) return 3;   // Aug-Oct
      return 4; // Nov-Jan
    }
    
    // ==================== TOKEN MANAGEMENT (CLIENT-SIDE - TO BE SECURED) ====================
    // ⚠️ SECURITY WARNING: Move this to Firebase Cloud Functions in production
    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { 
        els.upgradeSheet.classList.add('active'); 
        return false; 
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      // TODO: Use Cloud Function: httpsCallable('deductTokens')({ amount })
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { 
        daily: dailyTokens, 
        lastReset: Date.now() 
      });
      return true;
    }
    
    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const userData = userSnap.val();
        if (userData?.premium) {
          isPremium = true; 
          dailyTokens = 999999;
          document.querySelector('.token-bar').innerHTML = 
            `<div class="flex items-center justify-center gap-3">
               <span>Unlimited access • Premium</span>
             </div>`;
          els.tokenCount.textContent = 'Unlimited'; 
          return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val(); 
        const now = Date.now(); 
        const oneDay = 24 * 60 * 60 * 1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000; 
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else {
          dailyTokens = data.daily || 15000;
        }
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { 
        dailyTokens = 15000; 
        els.tokenCount.textContent = dailyTokens.toLocaleString(); 
      }
    }
    
    // ==================== PAYMENT SYSTEM ====================
    async function loadYocoScript() {
      if (window.YocoSDK) return Promise.resolve();
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }
    
    async function startYocoPayment() {
      try {
        await loadYocoScript();
        const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
        const result = await yoco.showPopup({
          amountInCents: 7900,
          currency: 'ZAR',
          name: 'Vynix Buddy Unlimited',
          description: 'R79/month – Unlimited AI tutoring',
          metadata: { userId: auth.currentUser.uid },
          callbackUrl: location.href
        });
       
        if (result?.paymentResult?.status === 'successful') {
          await update(ref(db, `users/${auth.currentUser.uid}`), { 
            premium: true, 
            premiumSince: new Date().toISOString() 
          });
          isPremium = true; 
          await loadTokens(); 
          els.upgradeSheet.classList.remove('active');
          customAlert("Payment successful! You're now on Unlimited!");
        }
      } catch (e) { 
        customAlert("Payment cancelled or failed."); 
      }
    }
    
    els.mockUpgrade.onclick = () => yocoEnabled ? startYocoPayment() : customAlert("Upgrade coming soon!");
    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');
    
    // ==================== EXAM PAPER GENERATION ====================
    async function generateExamPaper(subject, grade, topic) {
      const term = getCurrentTerm();
      const prompt = `Generate a CAPS ${subject} Grade ${grade} exam paper on "${topic}".

**CAPS REQUIREMENTS (Term ${term} ATP):**
- Reference specific **Assessment Standards (AS)** e.g., AS 12.1.2
- Include **cognitive levels**: 30% Lower, 50% Middle, 20% Higher Order
- Use **SAGA marking guidelines**: method (M), accuracy (A), units (U)
- Format per DBE exemplar papers
- Provide detailed memorandum with alternative methods

**STRUCTURE:**
NATIONAL SENIOR CERTIFICATE
GRADE ${grade}
${subject.toUpperCase()}
TERM ${term} PRACTICE PAPER

INSTRUCTIONS
QUESTION 1 (10 marks): [Lower-order, AS 12.1.1]
QUESTION 2 (10 marks): [Middle-order, AS 12.1.2]
QUESTION 3 (10 marks): [Higher-order, AS 12.2.1]
QUESTION 4 (10 marks): [Problem-solving]
QUESTION 5 (10 marks): [Application]

---MEMO---
MARKS: [M/A/U breakdown]
COMMON ERRORS: [DBE examiner notes]`;
     
      addThinking();
      const cost = 2500;
      if (!(await deductTokens(cost))) { removeThinking(); return null; }
      
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ 
            model: "grok-4-1-fast-non-reasoning", 
            messages: [{role:"user",content:prompt}], 
            max_tokens: 8000, 
            temperature: 0.7 
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || null;
      } catch (e) {
        console.error(e);
        return null;
      } finally {
        removeThinking();
      }
    }
    
    function showPastPapersSheet() {
      const grade = userProfile?.grade || "12";
      const name = userProfile?.name || "learner";
     
      els.papersContent.innerHTML = `
        <h3 class="text-xl font-bold mb-4">Generate CAPS Practice Paper</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Subject</label>
            <select id="subjectSelect" class="w-full border rounded-lg p-2 bg-white">
              <option value="Mathematics">Mathematics</option>
              <option value="Physical Sciences">Physical Sciences</option>
              <option value="Life Sciences">Life Sciences</option>
              <option value="Accounting">Accounting</option>
              <option value="Business Studies">Business Studies</option>
              <option value="Geography">Geography</option>
              <option value="History">History</option>
              <option value="English HL">English HL</option>
              <option value="Afrikaans HL">Afrikaans HL</option>
              <option value="isiZulu HL">isiZulu HL</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Topic (e.g., Calculus)</label>
            <input type="text" id="topicInput" class="w-full border rounded-lg p-2" placeholder="Enter specific topic">
          </div>
          <button id="generatePaperBtn" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">
            Generate 5 Tough Questions + Memo
          </button>
        </div>`;
     
      els.papersSheet.classList.add('active');
     
      document.getElementById('generatePaperBtn').addEventListener('click', async () => {
        const subject = document.getElementById('subjectSelect').value;
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) { customAlert("Please enter a topic"); return; }
       
        els.papersSheet.classList.remove('active');
        const examText = await generateExamPaper(subject, grade, topic);
        if (!examText) { 
          customAlert("Failed to generate paper. Check tokens."); 
          return; 
        }
       
        // Generate PDF
        const [qp, memo] = examText.split("---MEMO---");
        const doc = new jsPDF();
        
        // Cover page
        doc.setFontSize(22); doc.setTextColor(139, 92, 246);
        doc.text("VYNIX BUDDY", 105, 30, { align: "center" });
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(18); doc.text("CAPS PRACTICE PAPER", 105, 45, { align: "center" });
        doc.setFontSize(14); doc.text(`${subject} - Grade ${grade}`, 105, 60, { align: "center" });
        doc.text(`Topic: ${topic}`, 105, 75, { align: "center" });
        doc.setFontSize(12); doc.text(`Term ${getCurrentTerm()} • ${new Date().getFullYear()}`, 105, 90, { align: "center" });
        doc.text(`Generated: ${new Date().toLocaleDateString('en-ZA')}`, 105, 105, { align: "center" });
        doc.text(`Good luck, ${name}!`, 105, 120, { align: "center" });
       
        // Question paper
        doc.addPage(); doc.setFontSize(16); doc.text("QUESTION PAPER", 105, 20, { align: "center" });
        doc.setFontSize(12); doc.text(`Subject: ${subject} | Grade: ${grade} | Topic: ${topic}`, 15, 35);
        doc.text(`Time: 1 hour | Marks: 50`, 15, 45);
        doc.text("Instructions: Answer ALL questions. Show ALL working.", 15, 55);
       
        let yPos = 70; let qNum = 1;
        const questions = (qp || examText).split(/QUESTION \d+:/gi).filter(q => q.trim());
       
        questions.slice(0, 5).forEach(q => {
          if (yPos > 240) { doc.addPage(); yPos = 20; }
         
          doc.setFontSize(12); doc.setFont(undefined, "bold");
          doc.text(`Question ${qNum} (10 marks)`, 15, yPos);
          doc.setFont(undefined, "normal"); yPos += 8;
         
          const cleanQ = q.trim()
            .replace(/\*\*/g, '').replace(/\*/g, '')
            .replace(/\$\$(.*?)\$\$/g, '$1') // LaTeX cleanup
            .replace(/\^(\d+)/g, 'to the power of $1')
            .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1 over $2');
         
          const lines = doc.splitTextToSize(cleanQ, 170);
          lines.forEach(line => {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.text(line, 20, yPos); yPos += 6;
          });
          yPos += 8; qNum++;
        });
       
        // Memorandum
        doc.addPage(); doc.setFontSize(16); doc.text("MEMORANDUM", 105, 20, { align: "center" });
        doc.setFontSize(12);
       
        const cleanMemo = (memo || "No memorandum generated.")
          .replace(/\*\*/g, '').replace(/\*/g, '').replace(/\$/g, '');
       
        const memoLines = doc.splitTextToSize(cleanMemo, 180); let memoY = 35;
        memoLines.forEach(line => {
          if (memoY > 270) { doc.addPage(); memoY = 20; }
          doc.text(line, 15, memoY); memoY += 6;
        });
       
        doc.save(`CAPS_${subject.replace(/\s/g,"_")}_Grade${grade}_${topic.replace(/\s/g,"_")}.pdf`);
        customAlert("Practice paper downloaded!");
      });
    }
    
    // ==================== VISION MARKING ====================
    async function markStudentWork(studentImageUrl, subject, grade, questionContext) {
      const prompt = `You are a strict DBE examiner marking CAPS ${subject} Grade ${grade} work.

STUDENT WORK: Analyse the handwritten answer in the image.
QUESTION: ${questionContext}

**MARKING TASK:**
1. Follow SAGA guidelines strictly
2. Allocate marks: M (method), A (accuracy), U (units)
3. Place virtual ticks (√) where earned
4. Identify CAPS-specific errors SA learners make
5. Provide DBE-style examiner comments

**OUTPUT:**
MARKS: X/10 [M/A/U breakdown]
EXAMINER COMMENTS:
- √ [M1] Correct formula
- ✗ [LOST] SI units not converted (CAPS requirement)
- √ [A2] Substitution correct
- ✗ [LOST] Rounding error

FEEDBACK: [Specific improvement advice]
CAPS ALIGNMENT: [Assessment Standard reference]`;
     
      addThinking();
      const cost = 3000;
      if (!(await deductTokens(cost))) { removeThinking(); return null; }
      
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${xaiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "grok-2-vision-1212",
            messages: [{
              role: "user",
              content: [
                { type: "text", text: prompt },
                { type: "image_url", image_url: { url: studentImageUrl } }
              ]
            }],
            max_tokens: 4000,
            temperature: 0.3
          })
        });
       
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "Could not mark this paper.";
      } catch (e) {
        console.error("Vision marking failed:", e);
        return "Marking error. Please ensure image is clear and well-lit.";
      } finally {
        removeThinking();
      }
    }
    
    // ==================== INPUT HANDLING ====================
    const viewport = window.visualViewport || window;
    function handleKeyboard() {
      const kh = window.innerHeight - (viewport.height || window.innerHeight);
      document.querySelector('.input-bar').style.transform = kh > 100 ? `translateY(-${kh}px)` : 'translateY(0)';
    }
    
    viewport.addEventListener('resize', handleKeyboard);
    viewport.addEventListener('scroll', handleKeyboard);
    
    els.chatInput.addEventListener('focus', () => setTimeout(handleKeyboard, 300));
    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      updateSendButton();
    });
    
    function updateSendButton() {
      const hasText = els.chatInput.value.trim().length > 0;
      const hasFile = currentImage !== null || currentFile !== null;
      els.sendBtn.disabled = !hasText && !hasFile;
    }
    
    // ==================== FILE UPLOAD ====================
    els.uploadBtn.onclick = () => els.hiddenFile.click();
    
    els.hiddenFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
     
      const isImage = file.type.startsWith('image/');
      if (isImage) {
        els.filePreview.src = URL.createObjectURL(file);
        els.filePreview.style.display = 'block';
        els.docPreview.style.display = 'none';
      } else {
        els.filePreview.style.display = 'none';
        els.docPreview.style.display = 'flex';
      }
     
      // TODO: Use signed Cloudinary preset for security
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'banter_box'); // ⚠️ Change to signed preset
      fd.append('resource_type', 'auto');
     
      try {
        customAlert("Uploading file...", 2000);
        const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/upload", {
          method: "POST",
          body: fd
        });
        const data = await res.json();
       
        if (data.secure_url) {
          currentImage = data.secure_url;
          currentFile = file;
          updateSendButton();
          customAlert("File uploaded successfully!");
        } else {
          throw new Error("Upload failed");
        }
      } catch (e) {
        console.error("Cloudinary upload error:", e);
        customAlert("Upload error. Check your connection.");
        hidePreview();
      }
    };
    
    function hidePreview() {
      els.filePreview.style.display = 'none';
      els.docPreview.style.display = 'none';
      currentImage = null;
      currentFile = null;
      updateSendButton();
    }
    
    // ==================== MESSAGE RENDERING ====================
    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      const time = formatTime();
     
      if (sender === 'ai' && !isImage) {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions" data-message-id="${Date.now()}">
            <button class="action-btn copy-btn" aria-label="Copy"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn" aria-label="Listen"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn" aria-label="Download PDF"><i data-lucide="download"></i></button>
            <button class="action-btn papers-btn" aria-label="Past Papers"><i data-lucide="file-text" class="text-purple-700"></i></button>
            <button class="action-btn mark-btn" aria-label="Mark My Work"><i data-lucide="check-square" class="text-green-600"></i></button>
          </div>
          <div class="timestamp">${time}</div>`;
      } else {
        const userText = isImage ? content : escapeHtml(content).replace(/\n/g, '<br>');
        div.innerHTML = `<div class="content">${userText}</div><div class="timestamp">${time}</div>`;
      }
     
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons({ attrs: { width: 18, height: 18 } });
    }
    
    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    
    function removeThinking() { 
      document.getElementById('thinking')?.remove(); 
    }
    
    // ==================== MAIN SEND FUNCTION (FIXED) ====================
    // ─────── MAIN SEND FUNCTION ───────
async function send() {
  if (waitingForProfile) return;
  let text = els.chatInput.value.trim();
  if (!text && !currentImage) return;
  const cost = currentImage ? 1500 : estimateTokens(text);
  if (!(await deductTokens(cost))) {
    addMessage("You've run out of tokens today! Upgrade to unlimited for just R79/month.", 'ai');
    return;
  }

  // ─────── ADD & SAVE USER MESSAGE (TEXT OR IMAGE) ───────
  const userMessageContent = currentImage ? currentImage : text;
  const displayContent = currentImage 
    ? `<img src="${currentImage}" class="rounded-lg max-w-full" alt="Uploaded image">` 
    : text;

  addMessage(displayContent, 'user');
  history.push({ role: "user", content: userMessageContent });

  if (currentImage && !text.trim()) {
    text = "Explain what's in this image";
  }

  await saveMessage(userMessageContent);   // ✅ Saves user message ONCE

  els.chatInput.value = '';
  hidePreview();
  els.chatInput.style.height = 'auto';
  addThinking();

  const reply = await getReply(text);
  removeThinking();
  addMessage(reply, 'ai', reply);
  history.push({ role: "assistant", content: reply });
  await saveMessage(null, reply); // ✅ FIXED: Only save AI reply now
}
    
    els.sendBtn.onclick = send;
    
    // ==================== AI RESPONSE ====================
    async function getReply(msg) {
      if (!xaiKey) return "Connecting to Grok...";
      
      const lang = userProfile?.language || 'English';
      const roleText = userProfile ? `${userProfile.role} (Grade ${userProfile.grade})` : "learner";
      
      const systemPrompt = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa.
You are helping ${userProfile?.name || "a student"} who is a ${roleText}.
Respond in ${lang}. Always use their name naturally. Be encouraging and explain step-by-step.
Reference CAPS Assessment Standards where relevant.`;
      
      try {
        // TODO: Proxy through Cloud Function for key security
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [{ role: "system", content: systemPrompt }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        console.error(e);
        return "No internet connection. Please check your network.";
      }
    }
    
    // ==================== PROFILE SETUP ====================
    async function checkAndAskProfile() {
      const authUser = auth.currentUser;
      const authName = authUser?.displayName?.trim();
      const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/profile`));
      const dbProfile = snap.val();
      
      userProfile = dbProfile || {};
      if (!userProfile.name && authName) {
        userProfile.name = authName;
        await set(ref(db, `users/${auth.currentUser.uid}/profile/name`), authName);
      }

      if (!userProfile.name || !userProfile.grade || !userProfile.role) {
        waitingForProfile = true;
        addMessage("Sawubona! I'm Vynix Buddy, your personal CAPS tutor.\n\nMay I know your name?", 'ai');
      } else {
        addMessage(`Welcome back, ${userProfile.name}! Ready for Grade ${userProfile.grade} today?`, 'ai');
        waitingForProfile = false;
      }
      updateProfileDisplay();
    }
    
    els.chatInput.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!waitingForProfile) return send();
        
        const text = els.chatInput.value.trim();
        if (!text) return;
        els.chatInput.value = '';
        
        if (!userProfile?.name) {
          userProfile.name = text;
          addMessage(`Nice to meet you, ${text}! Which grade are you in? (e.g., 12)`, 'ai');
        } else if (!userProfile?.grade) {
          userProfile.grade = text;
          addMessage(`Got it! Grade ${text}. Are you a **student**, **teacher**, or **parent**?`, 'ai');
        } else if (!userProfile?.role) {
          userProfile.role = text.toLowerCase();
          // TODO: Add language selection
          await set(ref(db, `users/${auth.currentUser.uid}/profile`), userProfile);
          waitingForProfile = false;
          addMessage(`Perfect, ${userProfile.name}! I'm now your personal CAPS tutor. Ask me anything!`, 'ai');
        }
      }
    });
    
    // ==================== PROFILE DISPLAY ====================
    function updateProfileDisplay() {
      if (!userProfile?.name) {
        document.getElementById('userInitial').textContent = '?';
        document.getElementById('userName').textContent = 'Student';
        document.getElementById('userGrade').textContent = '—';
        document.getElementById('dropdownName').textContent = 'Student';
        document.getElementById('dropdownGrade').textContent = '—';
        return;
      }
      const name = userProfile.name.trim();
      const initial = name.charAt(0).toUpperCase();
      const grade = userProfile.grade ? `Grade ${userProfile.grade}` : 'Not set';

      document.getElementById('userInitial').textContent = initial;
      document.getElementById('userName').textContent = name;
      document.getElementById('userGrade').textContent = grade;
      document.getElementById('dropdownName').textContent = name;
      document.getElementById('dropdownGrade').textContent = grade;
    }
    
    // Event delegation for profile dropdown
    els.profileBtn.onclick = (e) => {
      e.stopPropagation();
      els.profileDropdown.classList.toggle('show');
    };
    
    document.addEventListener('click', (e) => {
      if (!els.profileBtn.contains(e.target) && !els.profileDropdown.contains(e.target)) {
        els.profileDropdown.classList.remove('show');
      }
    });
    
    document.getElementById('signOutBtn').onclick = async () => {
      if (confirm('Sign out of Vynix Buddy?')) {
        await auth.signOut();
        customAlert('Signed out');
        setTimeout(() => location.href = 'login.html', 800);
      }
    };
    
    // ==================== CONVERSATIONS ====================
    function loadConversations() {
      if (!auth.currentUser) return;
      const convosRef = ref(db, `users/${auth.currentUser.uid}/conversations`);
      onValue(convosRef, (snapshot) => {
        const data = snapshot.val();
        conversations = data ? Object.keys(data).map(key => ({
          id: key,
          ...data[key],
          time: new Date(data[key].lastMessageAt || data[key].createdAt).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })
        })).sort((a, b) => (b.lastMessageAt || b.createdAt) - (a.lastMessageAt || a.createdAt)) : [];
        renderConversations();
      });
    }
    
    function renderConversations() {
      if (conversations.length === 0) {
        els.convoList.innerHTML = `<div class="p-8 text-center text-gray-500">No chats yet. Start a new one!</div>`;
        return;
      }

      els.convoList.innerHTML = conversations.map(c => `
        <div class="convo-item ${c.id === currentConvoId ? 'active' : ''}" data-id="${c.id}">
          <i data-lucide="message-square" class="w-5 h-5 text-purple-500"></i>
          <div class="title">${escapeHtml(c.title || 'New Chat')}</div>
          <div class="timestamp">${c.time}</div>
          <button class="delete-btn">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
          </button>
        </div>
      `).join('');

      lucide.createIcons();
    }
    
    async function startNewChat() {
      els.chatPane.innerHTML = `<div class="text-center mt-28 text-gray-600 px-4">
        <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
        <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
      </div>`;
      history = [];
      currentConvoId = null;
      customAlert("New chat started!");
    }
    
    async function loadConversationHistory(convoId) {
      const snap = await get(ref(db, `users/${auth.currentUser.uid}/conversations/${convoId}/messages`));
      const messages = snap.val();

      els.chatPane.innerHTML = '';
      history = [];

      if (!messages) {
        startNewChat();
        return;
      }

      // ✅ Deduplication safety net
      const uniqueMessages = Object.values(messages).reduce((acc, msg) => {
        const key = `${msg.timestamp}-${msg.role}-${msg.content.substring(0, 50)}`;
        if (!acc.some(m => `${m.timestamp}-${m.role}-${m.content.substring(0, 50)}` === key)) {
          acc.push(msg);
        }
        return acc;
      }, []);

      const messageArray = uniqueMessages.sort((a, b) => a.timestamp - b.timestamp);

      messageArray.forEach(msg => {
        const isUser = msg.role === 'user';
        let content = isUser ? escapeHtml(msg.content) : marked.parse(msg.content || '');
        
        if (isUser && msg.content.startsWith('http') && /\\.(jpg|png|jpeg|webp)/i.test(msg.content)) {
          content = `<img src="${msg.content}" class="rounded-lg max-w-full" alt="Uploaded image">`;
        }

        const time = new Date(msg.timestamp).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
        const div = document.createElement('div');
        div.className = `message ${isUser ? 'user' : 'ai'}`;
        div.innerHTML = `<div class="content">${content}</div><div class="timestamp">${time}</div>`;
        
        els.chatPane.appendChild(div);
        history.push(msg);
      });

      lucide.createIcons();
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    
    async function saveMessage(userMsg, aiReply = null) {
  if (!auth.currentUser) return;

  let convoRef;
  if (!currentConvoId) {
    // Use whichever message is available for the title
    const titleSource = userMsg || aiReply || '';
    convoRef = push(ref(db, `users/${auth.currentUser.uid}/conversations`));
    currentConvoId = convoRef.key;
    await set(convoRef, {
      title: titleSource.slice(0, 40) + (titleSource.length > 40 ? '...' : ''),
      createdAt: Date.now(),
      lastMessageAt: Date.now()
    });
  } else {
    convoRef = ref(db, `users/${auth.currentUser.uid}/conversations/${currentConvoId}`);
    await update(convoRef, { lastMessageAt: Date.now() });
  }

  const messagesRef = child(convoRef, 'messages');
  
  // ✅ Only save user message if provided
  if (userMsg) {
    await push(messagesRef, { role: 'user', content: userMsg, timestamp: Date.now() });
  }
  
  // ✅ Only save AI reply if provided
  if (aiReply) {
    await push(messagesRef, { role: 'assistant', content: aiReply, timestamp: Date.now() });
  }
}
    
    // ==================== SIDEBAR CONTROLS ====================
    function openSidebar() {
      els.sidebar.classList.add('translate-x-0');
      els.overlay.classList.remove('hidden');
      setTimeout(() => els.overlay.classList.add('active'), 10);
    }
    
    function closeSidebar() {
      els.sidebar.classList.remove('translate-x-0');
      els.overlay.classList.remove('active');
      setTimeout(() => els.overlay.classList.add('hidden'), 300);
    }
    
    // Event delegation for sidebar actions
    els.menuBtn.onclick = openSidebar;
    els.closeSidebar.onclick = closeSidebar;
    els.overlay.onclick = closeSidebar;
    els.newChatBtn.onclick = () => { startNewChat(); closeSidebar(); };
    
    // Desktop hover intent with delay
    let hoverTimer;
    els.desktopHoverTrigger.onmouseenter = () => {
      hoverTimer = setTimeout(() => openSidebar(), 200);
    };
    els.desktopHoverTrigger.onmouseleave = () => clearTimeout(hoverTimer);
    
    // Conversation item clicks (delegated)
    els.convoList.addEventListener('click', async (e) => {
      const item = e.target.closest('.convo-item');
      const deleteBtn = e.target.closest('.delete-btn');
      
      if (deleteBtn) {
        e.stopPropagation();
        const id = item.dataset.id;
        if (confirm('Delete this chat permanently?')) {
          await remove(ref(db, `users/${auth.currentUser.uid}/conversations/${id}`));
          if (currentConvoId === id) {
            currentConvoId = null;
            startNewChat();
          }
        }
        return;
      }
      
      if (item) {
        const id = item.dataset.id;
        currentConvoId = id;
        await loadConversationHistory(id);
        document.querySelectorAll('.convo-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        closeSidebar();
      }
    });
    
    // ==================== ACTION BUTTONS (DELEGATED) ====================
    // ✅ Performance fix: Single event listener for all action buttons
    els.chatPane.addEventListener('click', async (e) => {
      const btn = e.target.closest('.action-btn');
      if (!btn) return;
      
      const messageEl = btn.closest('.message');
      const content = messageEl.querySelector('.content').innerText;
      
      // Copy button
      if (btn.classList.contains('copy-btn')) {
        try {
          await navigator.clipboard.writeText(content);
          const icon = btn.querySelector('i');
          icon.setAttribute('data-lucide', 'check'); 
          lucide.createIcons();
          setTimeout(() => { 
            icon.setAttribute('data-lucide', 'copy'); 
            lucide.createIcons(); 
          }, 2000);
        } catch {
          customAlert('Copy failed');
        }
      }
      
      // Voice button
      if (btn.classList.contains('voice-btn')) {
        const icon = btn.querySelector('i');
        icon.setAttribute('data-lucide', 'loader-2');
        lucide.createIcons();
        btn.disabled = true;
        
        try {
          if (!elevenlabsKey) throw new Error('Voice not configured');
          const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB`, {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': elevenlabsKey
            },
            body: JSON.stringify({
              text: content,
              model_id: 'eleven_monolingual_v1',
              voice_settings: { stability: 0.5, similarity_boost: 0.5 }
            })
          });
         
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
         
          audio.onended = () => {
            URL.revokeObjectURL(audioUrl);
            icon.setAttribute('data-lucide', 'volume-2');
            lucide.createIcons();
            btn.disabled = false;
          };
         
          await audio.play();
        } catch {
          customAlert('Voice temporarily unavailable');
          icon.setAttribute('data-lucide', 'volume-2');
          lucide.createIcons();
          btn.disabled = false;
        }
      }
      
      // PDF button
      if (btn.classList.contains('pdf-btn')) {
        const doc = new jsPDF();
        doc.setFontSize(16); 
        doc.text("Vynix Buddy Answer", 20, 20);
        doc.setFontSize(11); 
        doc.text(doc.splitTextToSize(content.replace(/[#*`>]/g, ''), 170), 20, 35);
        doc.save(`Vynix_Answer_${new Date().toISOString().slice(0,10)}.pdf`);
      }
      
      // Past papers button
      if (btn.classList.contains('papers-btn')) {
        showPastPapersSheet();
      }
      
      // Mark button
      if (btn.classList.contains('mark-btn')) {
        if (!currentImage) {
          customAlert("Upload your answer sheet first!");
          return;
        }
        const subject = userProfile?.favoriteSubject || "Mathematics";
        const grade = userProfile?.grade || "12";
        const markingResult = await markStudentWork(currentImage, subject, grade, content);
        if (markingResult) {
          addMessage(markingResult, 'ai', markingResult);
        }
      }
    });
    
    // ==================== INITIALIZATION ====================
    async function init() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
      yocoPublicKey = getString(rc, 'yoco_public_key')?.trim();
      yocoEnabled = getBoolean(rc, 'yoco_enabled');
    }
    
    // ✅ Single auth listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) { 
        location.href = "login.html"; 
        return; 
      }
      await init();
      await loadTokens();
      await checkAndAskProfile();
      loadConversations();
    });
    
    // PWA Service Worker Registration (TODO: Create sw.js)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(reg => {
        console.log('PWA ServiceWorker registered:', reg.scope);
      }).catch(err => console.error('SW registration failed:', err));
    }
  </script>
</body>
</html>
