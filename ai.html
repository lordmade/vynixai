<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#d4a574">
  <title>Vynix Lingua ‚Äì Africa's Intelligent Companion</title>
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Space+Grotesk:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vynix Lingua">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    /* ---------- African Color Palette & Variables ---------- */
    :root{
      --bg-color:#faf8f5;
      --surface-color:#f5f1eb;
      --text-primary:#2c1810;
      --text-secondary:#5d4e37;
      --text-muted:#8b7355;
      --accent-sand:#d4a574;
      --accent-earth:#8b4513;
      --accent-sunset:#ff6b35;
      --accent-savanna:#228b22;
      --logo-gradient:linear-gradient(135deg,var(--accent-sand) 0%,var(--accent-earth) 50%,var(--accent-sunset) 100%);
      --african-pattern:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="3" fill="%23d4a574" opacity="0.3"/><circle cx="80" cy="20" r="3" fill="%23ff6b35" opacity="0.3"/><circle cx="50" cy="50" r="5" fill="%238b4513" opacity="0.3"/><circle cx="20" cy="80" r="3" fill="%23228b22" opacity="0.3"/><circle cx="80" cy="80" r="3" fill="%23d4a574" opacity="0.3"/></svg>');
      --radius-lg:32px;
      --radius-md:24px;
      --radius-sm:16px;
      --shadow-soft:0 8px 32px rgba(0,0,0,.08);
      --font-main:'Outfit',sans-serif;
      --font-head:'Space Grotesk',sans-serif;
      --font-mono:'Roboto Mono',monospace;
      --cultural-theme:'zulu';
    }

    /* ---------- Enhanced Reset & Base Styles ---------- */
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:var(--font-main);background:var(--bg-color);color:var(--text-primary);
         height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none;
         -webkit-font-smoothing:antialiased;background-image:var(--african-pattern);}
    
    /* ---------- Enhanced Header with Cultural Themes ---------- */
    .header{height:64px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;
            flex-shrink:0;background:linear-gradient(135deg, rgba(212, 165, 116, 0.9) 0%, rgba(139, 69, 19, 0.9) 100%);
            backdrop-filter:blur(12px);border-bottom:1px solid rgba(139, 69, 19, 0.2);z-index:10}
    
    .vynix-logo{display:flex;align-items:center;gap:8px;cursor:pointer;padding:5px 10px;
                border-radius:12px;transition:transform .2s;background:rgba(255,255,255,0.1)}
    .vynix-logo:active{transform:scale(.96)}
    .logo-icon{font-size:26px;background:var(--logo-gradient);-webkit-background-clip:text;
               -webkit-text-fill-color:transparent;font-variation-settings:'FILL' 1,'wght' 600}
    .logo-text{font-family:var(--font-head);font-size:22px;font-weight:700;letter-spacing:-.5px;color:white}
    .lingua-badge{background:white;color:var(--accent-earth);font-size:10px;font-weight:700;
                  padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px}

    /* ---------- User Profile & Strengths Display ---------- */
    .user-strengths{display:flex;gap:8px;margin-left:auto;align-items:center}
    .strength-badge{background:rgba(255,255,255,0.2);color:white;padding:4px 8px;border-radius:12px;
                    font-size:11px;font-weight:500;display:flex;align-items:center;gap:4px}
    .strength-badge::before{content:'‚≠ê';font-size:12px}

    /* ---------- Enhanced Chat Container ---------- */
    .chat-container{flex:1;overflow-y:auto;padding:20px 0 160px;display:flex;flex-direction:column;
                    scroll-behavior:smooth;background:var(--bg-color)}
    
    .welcome-screen{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;
                    text-align:center;padding:40px;animation:fadeIn .5s ease;background:var(--surface-color);
                    border-radius:var(--radius-lg);margin:20px;box-shadow:var(--shadow-soft)}
    
    .welcome-icon{font-size:64px;background:var(--logo-gradient);-webkit-background-clip:text;
                  -webkit-text-fill-color:transparent;margin-bottom:24px;font-variation-settings:'wght' 200}
    
    .welcome-text{font-family:var(--font-head);font-size:32px;font-weight:600;margin-bottom:12px;
                  color:var(--text-primary)}
    
    .welcome-sub{color:var(--text-muted);font-size:16px;max-width:400px;line-height:1.5;margin-bottom:20px}
    
    .user-insights{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:20px 0;width:100%;max-width:400px}
    .insight-card{background:white;padding:12px;border-radius:var(--radius-sm);box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .insight-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
    .insight-value{font-size:14px;font-weight:600;color:var(--text-primary);margin-top:4px}

    /* ---------- Enhanced Input Area ---------- */
    .input-wrapper-fixed{position:fixed;left:0;right:0;bottom:0;z-index:30;background:var(--bg-color);
                         padding:12px max(20px,env(safe-area-inset-left)) max(20px,env(safe-area-inset-bottom)) max(20px,env(safe-area-inset-right));
                         box-shadow:0 -2px 10px rgba(0,0,0,.04);display:flex;flex-direction:column;align-items:center}
    
    .input-wrapper{width:100%;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);
                   border-radius:28px;padding:6px;display:flex;align-items:center;transition:all .2s;
                   border:1px solid rgba(139, 69, 19, 0.1)}
    
    .input-wrapper:focus-within{background:#fff;box-shadow:var(--shadow-soft);border-color:var(--accent-sand)}
    
    input{flex:1;border:none;background:none;outline:none;font-size:16px;font-family:var(--font-main);
          color:var(--text-primary);padding:12px 14px;user-select:text}
    
    .mic-btn,.send-btn,.translate-btn{width:44px;height:44px;border-radius:50%;border:none;background:transparent;
                                       color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;
                                       transition:all .2s;flex-shrink:0}
    
    .mic-btn.listening{color:var(--accent-sunset);background:rgba(255, 107, 53, 0.1);animation:pulse-sunset 1.5s infinite}
    .send-btn.active{background:var(--accent-earth);color:#fff}
    .translate-btn.active{background:var(--accent-savanna);color:#fff}

    /* ---------- Enhanced Messages with Cultural Elements ---------- */
    .message-row{display:flex;margin-bottom:20px;max-width:80%;position:relative}
    .timestamp{font-size:10px;color:var(--text-muted);position:absolute;bottom:-15px}
    .message-row.user{margin-left:auto;text-align:right;flex-direction:column;align-items:flex-end}
    .message-row.user .timestamp{right:0}
    .message-row.ai{margin-right:auto;padding-left:50px;flex-direction:column;align-items:flex-start}
    .message-row.ai .timestamp{left:50px}
    
    .message-content{padding:14px 18px;border-radius:20px;line-height:1.6;text-align:left;font-size:15px;
                     white-space:pre-wrap;overflow-wrap:break-word;word-wrap:break-word;max-width:100%;
                     display:inline-block;position:relative}
    
    .message-row.user .message-content{background:var(--logo-gradient);color:#fff;border-bottom-right-radius:4px;
                                      box-shadow:0 4px 15px rgba(212, 165, 116, 0.3)}
    
    .message-row.ai .message-content{background:rgba(255,255,255,.95);border-top-left-radius:4px;
                                      box-shadow:var(--shadow-soft);border-left:3px solid var(--accent-sand)}
    
    .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
            flex-shrink:0;position:absolute}
    .message-row.ai .avatar{background:var(--logo-gradient);color:#fff;font-size:22px;left:0;top:-10px;
                           border:2px solid white;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    
    .cultural-badge{position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,var(--accent-savanna) 0%,#059669 100%);
                    color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase}
    
    .strength-highlight{background:linear-gradient(135deg, rgba(34, 139, 34, 0.1) 0%, rgba(34, 139, 34, 0.2) 100%);
                       border-left:3px solid var(--accent-savanna);padding:8px;margin:8px 0;border-radius:8px}
    
    .encouragement-box{background:linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 107, 53, 0.2) 100%);
                      border:1px solid var(--accent-sunset);border-radius:12px;padding:12px;margin:10px 0;
                      font-style:italic;color:var(--text-secondary)}

    /* ---------- Cultural Wisdom Integration ---------- */
    .proverb-box{background:linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(139, 69, 19, 0.1) 100%);
                border-left:4px solid var(--accent-earth);border-radius:0 12px 12px 0;
                padding:12px;margin:10px 0;font-style:italic;color:var(--text-secondary);
                position:relative}
    
    .proverb-box::before{content:'‚Äú';font-size:24px;color:var(--accent-earth);position:absolute;left:8px;top:4px}
    .proverb-box::after{content:'‚Äù';font-size:24px;color:var(--accent-earth);position:absolute;right:8px;bottom:4px}

    /* ---------- Strengths Dashboard ---------- */
    .strengths-dashboard{position:fixed;top:80px;right:20px;background:rgba(255,255,255,0.95);
                        backdrop-filter:blur(10px);border-radius:var(--radius-md);padding:16px;
                        box-shadow:var(--shadow-soft);max-width:280px;z-index:20;display:none}
    
    .strengths-dashboard.open{display:block}
    .dashboard-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .dashboard-title{font-size:14px;font-weight:600;color:var(--text-primary)}
    .strength-item{display:flex;align-items:center;gap:8px;padding:6px 0}
    .strength-icon{width:24px;height:24px;border-radius:50%;background:var(--accent-savanna);
                   color:white;display:flex;align-items:center;justify-content:center;font-size:12px}
    .strength-name{font-size:12px;color:var(--text-secondary);flex:1}
    .strength-level{font-size:11px;color:var(--text-muted)}

    /* ---------- Animations ---------- */
    @keyframes pulse-sunset{0%{box-shadow:0 0 0 0 rgba(255, 107, 53, 0.4)}70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}

    /* ---------- Responsive Design ---------- */
    @media (min-width: 768px) {
      .input-wrapper-fixed{left:50%;transform:translateX(-50%);width:90%;max-width:800px;border-radius:24px;margin-bottom:20px}
      .message-row{max-width:70%}
      .user-insights{grid-template-columns:repeat(4,1fr)}
    }

    @media (max-width: 767px) {
      .strengths-dashboard{position:fixed;top:auto;bottom:200px;left:20px;right:20px;max-width:none}
      .user-strengths{display:none}
    }
  </style>
</head>
<body>
  <!-- Enhanced Structure -->
  <canvas id="rainCanvas"></canvas>
  <div id="customSnackbar"></div>
  
  <!-- Strengths Dashboard -->
  <div class="strengths-dashboard" id="strengthsDashboard">
    <div class="dashboard-header">
      <span class="material-symbols-rounded">psychology</span>
      <div class="dashboard-title">Your Learning Profile</div>
    </div>
    <div id="strengthsList"></div>
  </div>

  <!-- Enhanced Header -->
  <header class="header">
    <div class="header-left">
      <div class="vynix-logo" onclick="location.reload()">
        <span class="material-symbols-rounded logo-icon">auto_awesome</span>
        <span class="logo-text">Vynix</span>
        <span class="lingua-badge">Lingua</span>
      </div>
    </div>
    
    <!-- User Strengths Display -->
    <div class="user-strengths" id="userStrengthsDisplay">
      <div class="strength-badge" id="topStrength">Loading...</div>
    </div>
    
    <button class="profile-btn" id="strengthsBtn" title="View your learning profile">
      <span class="material-symbols-rounded">psychology</span>
    </button>
    <button class="profile-btn" id="profileBtn">
      <span class="material-symbols-rounded">person</span>
    </button>
  </header>

  <!-- Enhanced Welcome Screen -->
  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <div class="welcome-text" id="welcomeText">Sawubona! I'm learning about you...</div>
      <div class="welcome-sub">I adapt to your learning style and celebrate your African heritage. Together, we'll unlock your full potential!</div>
      
      <div class="user-insights" id="userInsights">
        <div class="insight-card">
          <div class="insight-label">Learning Style</div>
          <div class="insight-value" id="learningStyle">Analyzing...</div>
        </div>
        <div class="insight-card">
          <div class="insight-label">Top Strength</div>
          <div class="insight-value" id="topStrengthInsight">Discovering...</div>
        </div>
        <div class="insight-card">
          <div class="insight-label">Progress Today</div>
          <div class="insight-value" id="dailyProgress">0 concepts</div>
        </div>
        <div class="insight-card">
          <div class="insight-label">Confidence Level</div>
          <div class="insight-value" id="confidenceLevel">Building...</div>
        </div>
      </div>
      
      <div class="feature-pills">
        <div class="pill"><span class="material-symbols-rounded">school</span>Personalized Learning</div>
        <div class="pill"><span class="material-symbols-rounded">psychology</span>Strengths-Based</div>
        <div class="pill"><span class="material-symbols-rounded">emoji_events</span>Celebrates African Heritage</div>
        <div class="pill"><span class="material-symbols-rounded">trending_up</span>Adaptive Intelligence</div>
      </div>
    </div>
    <div id="messagesList"></div>
  </main>

  <!-- Enhanced Input Area -->
  <div class="input-wrapper-fixed">
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn"><span class="material-symbols-rounded">mic</span></button>
      <input type="text" id="input" placeholder="Share your thoughts, questions, or challenges..." autocomplete="off">
      <button class="translate-btn" id="translateBtn" title="Auto-translate"><span class="material-symbols-rounded">g_translate</span></button>
      <button class="send-btn" id="sendBtn"><span class="material-symbols-rounded">arrow_upward</span></button>
    </div>
    <p class="disclaimer">I learn from every interaction to better support your African learning journey.</p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, addDoc, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const db = getFirestore(app);

    // Enhanced Constants
    const DAILY_TOKEN_LIMIT = 10000;
    const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";
    const ELEVENLABS_API_KEY = getString(rc, 'elevenlabs_api_key') || "sk_a5591b58aa245cfec4f8fa9904de15b9392e9b5c94bd5231";

    // Enhanced Language Support with Cultural Context
    const LANGUAGES = {
      en: { 
        name: 'English', 
        native: 'English', 
        flag: 'üá¨üáß', 
        code: 'en-US', 
        greeting: 'Hello',
        proverbs: ['Knowledge is power', 'Practice makes perfect'],
        values: ['individuality', 'directness', 'efficiency']
      },
      zu: { 
        name: 'Zulu', 
        native: 'isiZulu', 
        flag: 'üáøüá¶', 
        code: 'zu-ZA', 
        greeting: 'Sawubona',
        proverbs: ['Umuntu ngumuntu ngabantu' (A person is a person through other people)],
        values: ['ubuntu', 'community', 'respect']
      },
      xh: { 
        name: 'Xhosa', 
        native: 'isiXhosa', 
        flag: 'üáøüá¶', 
        code: 'xh-ZA', 
        greeting: 'Molo',
        proverbs: ['Umthathi uyawugqiba ugqiba nguwena' (You will accomplish your goal)],
        values: ['ubuntu', 'heritage', 'education']
      },
      af: { 
        name: 'Afrikaans', 
        native: 'Afrikaans', 
        flag: 'üáøüá¶', 
        code: 'af-ZA', 
        greeting: 'Hallo',
        proverbs: ['Oefening baar kuns' (Practice makes perfect)],
        values: ['directness', 'practicality', 'community']
      },
      sw: { 
        name: 'Swahili', 
        native: 'Kiswahili', 
        flag: 'üá∞üá™', 
        code: 'sw-KE', 
        greeting: 'Jambo',
        proverbs: ['Umoja ni nguvu' (Unity is strength)],
        values: ['ujamaa', 'community', 'cooperation']
      },
      yo: { 
        name: 'Yoruba', 
        native: 'Yor√πb√°', 
        flag: 'üá≥üá¨', 
        code: 'yo-NG', 
        greeting: 'Bawo',
        proverbs: ['Owe l·∫π·π£in ·ªçr·ªç' (Proverbs are the horse of speech)],
        values: ['respect', 'wisdom', 'community']
      }
    };

    // Enhanced User Profile System
    class UserProfileManager {
      constructor() {
        this.profiles = new Map();
        this.currentProfile = null;
      }

      async initializeProfile(userId) {
        const profileRef = doc(db, 'userProfiles', userId);
        const profileSnap = await getDoc(profileRef);
        
        if (profileSnap.exists()) {
          this.currentProfile = profileSnap.data();
        } else {
          this.currentProfile = this.createDefaultProfile();
          await setDoc(profileRef, this.currentProfile);
        }
        
        this.updateUI();
        return this.currentProfile;
      }

      createDefaultProfile() {
        return {
          learningStyle: {
            visual: 0.5,
            auditory: 0.5,
            kinesthetic: 0.5,
            reading: 0.5
          },
          subjectMastery: {
            mathematics: { level: 0.5, confidence: 0.5, attempts: 0, correct: 0 },
            science: { level: 0.5, confidence: 0.5, attempts: 0, correct: 0 },
            languages: { level: 0.5, confidence: 0.5, attempts: 0, correct: 0 },
            history: { level: 0.5, confidence: 0.5, attempts: 0, correct: 0 }
          },
          culturalContext: {
            primaryCulture: 'zulu',
            languages: ['en'],
            values: ['ubuntu', 'community', 'respect'],
            background: 'urban'
          },
          engagementPatterns: {
            attentionSpan: 15,
            preferredTime: 'morning',
            responseSpeed: 'medium',
            helpFrequency: 'moderate',
            confidenceLevel: 0.5
          },
          strengths: {
            analytical: 0.5,
            creative: 0.5,
            verbal: 0.5,
            visual: 0.5,
            leadership: 0.5,
            collaborative: 0.5
          },
          areasForGrowth: [],
          achievements: [],
          totalInteractions: 0,
          createdAt: serverTimestamp(),
          lastUpdated: serverTimestamp()
        };
      }

      async updateProfile(updates) {
        if (!this.currentProfile || !auth.currentUser) return;
        
        const userId = auth.currentUser.uid;
        const profileRef = doc(db, 'userProfiles', userId);
        
        this.currentProfile = { ...this.currentProfile, ...updates, lastUpdated: serverTimestamp() };
        await setDoc(profileRef, this.currentProfile, { merge: true });
        
        this.updateUI();
      }

      updateUI() {
        if (!this.currentProfile) return;
        
        // Update learning style display
        const dominantStyle = this.getDominantLearningStyle();
        document.getElementById('learningStyle').textContent = dominantStyle;
        
        // Update top strength
        const topStrength = this.getTopStrength();
        document.getElementById('topStrengthInsight').textContent = topStrength;
        document.getElementById('topStrengthDisplay').textContent = `‚≠ê ${topStrength}`;
        
        // Update confidence level
        const confidence = Math.round(this.currentProfile.engagementPatterns.confidenceLevel * 100);
        document.getElementById('confidenceLevel').textContent = `${confidence}%`;
        
        // Update strengths dashboard
        this.updateStrengthsDashboard();
      }

      getDominantLearningStyle() {
        const styles = this.currentProfile.learningStyle;
        const max = Math.max(styles.visual, styles.auditory, styles.kinesthetic, styles.reading);
        if (styles.visual === max) return 'Visual Learner';
        if (styles.auditory === max) return 'Auditory Learner';
        if (styles.kinesthetic === max) return 'Hands-on Learner';
        return 'Reading Learner';
      }

      getTopStrength() {
        const strengths = this.currentProfile.strengths;
        const max = Math.max(...Object.values(strengths));
        const topStrength = Object.keys(strengths).find(key => strengths[key] === max);
        return topStrength.charAt(0).toUpperCase() + topStrength.slice(1);
      }

      updateStrengthsDashboard() {
        const dashboard = document.getElementById('strengthsList');
        const strengths = this.currentProfile.strengths;
        
        dashboard.innerHTML = Object.entries(strengths)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .map(([name, level]) => `
            <div class="strength-item">
              <div class="strength-icon">‚≠ê</div>
              <div class="strength-name">${name.charAt(0).toUpperCase() + name.slice(1)}</div>
              <div class="strength-level">${Math.round(level * 100)}%</div>
            </div>
          `).join('');
      }

      analyzeInteraction(userInput, response, timeSpent, correct = null) {
        if (!this.currentProfile) return;
        
        const analysis = {
          timestamp: serverTimestamp(),
          input: userInput,
          responseTime: timeSpent,
          emotionalTone: this.analyzeEmotionalTone(userInput),
          complexity: this.assessComplexity(userInput),
          culturalReferences: this.extractCulturalReferences(userInput)
        };
        
        if (correct !== null) {
          analysis.correct = correct;
          this.updateSubjectMastery(analysis);
        }
        
        this.updateLearningPatterns(analysis);
        this.updateStrengths(analysis);
        
        this.currentProfile.totalInteractions++;
        this.updateProfile(this.currentProfile);
      }

      analyzeEmotionalTone(text) {
        const positiveWords = ['good', 'great', 'awesome', 'thank', 'love', 'amazing', 'excellent'];
        const negativeWords = ['bad', 'hate', 'terrible', 'difficult', 'hard', 'struggle', 'confused'];
        const frustratedWords = ['ugh', 'argh', 'stupid', 'impossible', 'give up', 'frustrated'];
        
        const words = text.toLowerCase().split(' ');
        let score = 0;
        
        words.forEach(word => {
          if (positiveWords.some(pw => word.includes(pw))) score++;
          if (negativeWords.some(nw => word.includes(nw))) score--;
          if (frustratedWords.some(fw => word.includes(fw))) score -= 2;
        });
        
        if (score > 1) return 'positive';
        if (score < -1) return 'frustrated';
        if (score < 0) return 'negative';
        return 'neutral';
      }

      extractCulturalReferences(text) {
        const references = [];
        const lowerText = text.toLowerCase();
        
        // African proverbs and wisdom
        const proverbs = ['ubuntu', 'umuntu', 'harambee', 'ujamaa', 'sawubona', 'bawo'];
        proverbs.forEach(proverb => {
          if (lowerText.includes(proverb)) references.push(proverb);
        });
        
        // Local languages
        Object.keys(LANGUAGES).forEach(lang => {
          if (lowerText.includes(LANGUAGES[lang].greeting.toLowerCase())) {
            references.push(LANGUAGES[lang].greeting);
          }
        });
        
        return references;
      }

      updateLearningPatterns(analysis) {
        // Update attention span based on response time
        if (analysis.responseTime > 30000) { // 30 seconds
          this.currentProfile.engagementPatterns.attentionSpan = 
            Math.max(5, this.currentProfile.engagementPatterns.attentionSpan - 1);
        }
        
        // Update confidence based on emotional tone
        if (analysis.emotionalTone === 'positive') {
          this.currentProfile.engagementPatterns.confidenceLevel = 
            Math.min(1, this.currentProfile.engagementPatterns.confidenceLevel + 0.05);
        } else if (analysis.emotionalTone === 'frustrated') {
          this.currentProfile.engagementPatterns.confidenceLevel = 
            Math.max(0.1, this.currentProfile.engagementPatterns.confidenceLevel - 0.1);
        }
      }

      updateSubjectMastery(analysis) {
        // This would be called when we know if an answer was correct
        // Update based on subject detection in the input
        const subjects = ['mathematics', 'science', 'languages', 'history'];
        const detectedSubject = subjects.find(subject => 
          analysis.input.toLowerCase().includes(subject)
        );
        
        if (detectedSubject && analysis.correct !== undefined) {
          const subject = this.currentProfile.subjectMastery[detectedSubject];
          subject.attempts++;
          if (analysis.correct) subject.correct++;
          
          // Update mastery level (simple percentage for now)
          subject.level = subject.correct / subject.attempts;
          
          // Update confidence
          if (analysis.correct) {
            subject.confidence = Math.min(1, subject.confidence + 0.1);
          } else {
            subject.confidence = Math.max(0.1, subject.confidence - 0.05);
          }
        }
      }

      updateStrengths(analysis) {
        // Update strengths based on interaction patterns
        if (analysis.complexity > 0.7) {
          this.currentProfile.strengths.analytical += 0.02;
        }
        
        if (analysis.culturalReferences.length > 0) {
          this.currentProfile.strengths.creative += 0.03;
        }
        
        if (analysis.emotionalTone === 'positive' && analysis.complexity > 0.5) {
          this.currentProfile.strengths.verbal += 0.02;
        }
        
        // Normalize strengths to 0-1 range
        Object.keys(this.currentProfile.strengths).forEach(strength => {
          this.currentProfile.strengths[strength] = 
            Math.max(0, Math.min(1, this.currentProfile.strengths[strength]));
        });
      }

      assessComplexity(text) {
        // Simple complexity assessment
        const words = text.split(' ');
        const complexWords = words.filter(word => word.length > 6).length;
        return Math.min(1, complexWords / words.length);
      }

      getPersonalizedGreeting() {
        if (!this.currentProfile) return 'Hello! How can I help you learn?';
        
        const lang = LANGUAGES[currentLang] || LANGUAGES.en;
        const culture = this.currentProfile.culturalContext.primaryCulture;
        const confidence = this.currentProfile.engagementPatterns.confidenceLevel;
        
        let greeting = `${lang.greeting}! `;
        
        if (confidence < 0.3) {
          greeting += "I can see you're building confidence. Remember, every expert was once a beginner. ";
        } else if (confidence > 0.7) {
          greeting += "Your confidence shines through! Let's tackle something challenging today. ";
        }
        
        const topStrength = this.getTopStrength();
        greeting += `I notice your ${topStrength.toLowerCase()} skills are really developing. `;
        
        // Add cultural wisdom
        if (lang.proverbs && lang.proverbs.length > 0) {
          const proverb = lang.proverbs[Math.floor(Math.random() * lang.proverbs.length)];
          greeting += `As we say: "${proverb}". `;
        }
        
        greeting += "What would you like to explore together?";
        
        return greeting;
      }

      getLearningRecommendation() {
        if (!this.currentProfile) return "Let's start learning together!";
        
        const mastery = this.currentProfile.subjectMastery;
        const lowestSubject = Object.entries(mastery)
          .sort(([,a], [,b]) => a.level - b.level)[0];
        
        const learningStyle = this.getDominantLearningStyle();
        
        return {
          subject: lowestSubject[0],
          currentLevel: Math.round(lowestSubject[1].level * 100),
          recommendation: this.getSubjectSpecificRecommendation(lowestSubject[0], learningStyle),
          culturalApproach: this.getCulturalLearningApproach()
        };
      }

      getSubjectSpecificRecommendation(subject, learningStyle) {
        const recommendations = {
          mathematics: {
            'Visual Learner': "Let's use diagrams and visual patterns from African art to understand mathematical concepts.",
            'Auditory Learner': "We'll explore mathematical rhythms and patterns in African music and drumming.",
            'Hands-on Learner': "We'll use traditional African counting systems and market calculations."
          },
          science: {
            'Visual Learner': "We'll explore African ecosystems and natural phenomena through visual observation.",
            'Auditory Learner': "Let's listen to the sounds of African wildlife and weather patterns.",
            'Hands-on Learner': "We'll conduct experiments using materials found in African environments."
          }
        };
        
        return recommendations[subject]?.[learningStyle] || 
               `Let's explore ${subject} using your ${learningStyle.toLowerCase()} approach with African contexts.`;
      }

      getCulturalLearningApproach() {
        const culture = this.currentProfile.culturalContext.primaryCulture;
        const approaches = {
          zulu: "We'll use storytelling and Ubuntu principles to make learning collaborative.",
          xhosa: "We'll incorporate traditional wisdom and respect-based learning.",
          yoruba: "We'll use proverbs and community wisdom to deepen understanding.",
          swahili: "We'll focus on practical, community-oriented learning approaches."
        };
        return approaches[culture] || "We'll use culturally relevant examples and approaches.";
      }
    }

    // Initialize the enhanced system
    const profileManager = new UserProfileManager();
    
    // Enhanced DOM elements
    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn'), $mic = $('#micBtn');
    const $translate = $('#translateBtn'), $list = $('#messagesList');
    const $welcome = $('#welcomeScreen'), $welcomeText = $('#welcomeText');
    const $profileBtn = $('#profileBtn'), $strengthsBtn = $('#strengthsBtn');
    const $langBtn = $('#langBtn'), $langDropdown = $('#langDropdown');
    const $currentLangText = $('#currentLangText');
    const $customSnackbar = $('#customSnackbar');
    const $strengthsDashboard = $('#strengthsDashboard');
    
    let currentLang = 'en';
    let autoTranslate = false;
    let historyStack = [];
    let userProfile = null;

    // Initialize language system
    function initLanguageDropdown() {
      $langDropdown.innerHTML = Object.keys(LANGUAGES).map(code => {
        const lang = LANGUAGES[code];
        return `
          <div class="lang-option ${code === currentLang ? 'active' : ''}" data-lang="${code}">
            <span class="lang-flag">${lang.flag}</span>
            <div class="lang-info">
              <div class="lang-name">${lang.name}</div>
              <div class="lang-native">${lang.native}</div>
            </div>
          </div>
        `;
      }).join('');
      
      document.querySelectorAll('.lang-option').forEach(opt => {
        opt.addEventListener('click', () => switchLanguage(opt.dataset.lang));
      });
    }

    async function switchLanguage(langCode) {
      currentLang = langCode;
      const lang = LANGUAGES[langCode];
      $currentLangText.textContent = lang.name;
      $langDropdown.classList.remove('open');
      
      document.querySelectorAll('.lang-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.lang === langCode);
      });
      
      updateSystemInstructions();
      showCustomSnackbar(`Language switched to ${lang.name}`);
      
      if (userProfile) {
        userProfile.culturalContext.primaryCulture = langCode;
        await profileManager.updateProfile(userProfile);
        $welcomeText.textContent = profileManager.getPersonalizedGreeting();
      }
    }

    function updateSystemInstructions() {
      const lang = LANGUAGES[currentLang];
      const culturalContext = userProfile?.culturalContext || { primaryCulture: 'zulu', values: ['ubuntu', 'community'] };
      
      const systemPrompt = `You are Vynix Lingua, Africa's most intelligent AI companion that truly understands and adapts to each learner.

CORE IDENTITY:
- You are deeply rooted in African wisdom, values, and educational approaches
- You celebrate each user's unique strengths and cultural heritage
- You understand that every African learner has untapped potential
- You use African proverbs, wisdom, and cultural references naturally

PERSONALIZATION ENGINE:
- Current user profile: ${JSON.stringify(userProfile || {})}
- Primary culture: ${culturalContext.primaryCulture}
- Dominant learning style: ${userProfile ? profileManager.getDominantLearningStyle() : 'Mixed'}
- Top strength: ${userProfile ? profileManager.getTopStrength() : 'Discovering'}

CRITICAL INSTRUCTIONS:
1. ALWAYS respond in ${lang.name} when this language is selected
2. Celebrate African cultural strengths and wisdom
3. Use African proverbs and traditional wisdom appropriately
4. Adapt explanations to user's learning style and cultural context
5. Recognize and address learning challenges with African-context solutions
6. Build confidence through cultural affirmation and strength recognition
7. Use storytelling, Ubuntu principles, and community-based learning approaches

AFRICAN EDUCATIONAL APPROACHES:
- Use Ubuntu: "I am because we are" - emphasize collaborative learning
- Incorporate traditional wisdom and proverbs from ${lang.name} culture
- Reference local examples, environments, and experiences
- Address resource constraints with creative, local solutions
- Celebrate African achievements and role models
- Use call-and-response, rhythm, and oral tradition techniques

STRENGTH-BASED LEARNING:
- Identify and celebrate user's unique strengths
- Use strengths to address areas for growth
- Provide encouragement through cultural wisdom
- Never make users feel inadequate - focus on growth and potential

RESPONSE FORMAT:
- Start with cultural acknowledgment when appropriate
- Use African proverbs to illustrate points
- Provide practical, locally-relevant examples
- End with empowering, culturally-affirming statements

Remember: You are not just teaching - you are nurturing African excellence and helping each user discover their unique genius.`;
      
      historyStack = [{ role: 'system', content: systemPrompt }];
    }

    // Event listeners
    $langBtn.addEventListener('click', () => $langDropdown.classList.toggle('open'));
    document.addEventListener('click', e => {
      if (!$langBtn.contains(e.target) && !$langDropdown.contains(e.target)) {
        $langDropdown.classList.remove('open');
      }
    });

    $translate.addEventListener('click', () => {
      autoTranslate = !autoTranslate;
      $translate.classList.toggle('active', autoTranslate);
      showCustomSnackbar(autoTranslate ? 'Auto-translate enabled' : 'Auto-translate disabled');
    });

    $strengthsBtn.addEventListener('click', () => {
      $strengthsDashboard.classList.toggle('open');
    });

    // Enhanced message handling
    function formatTime(date) {
      const h = date.getHours().toString().padStart(2, '0');
      const m = date.getMinutes().toString().padStart(2, '0');
      return `${h}:${m}`;
    }

    function showCustomSnackbar(msg) {
      $customSnackbar.textContent = msg;
      $customSnackbar.classList.add('show');
      setTimeout(() => $customSnackbar.classList.remove('show'), 3000);
    }

    function parseMarkdown(text) {
      let html = text.replace(/```([\s\S]*?)```/g, (m, c) => `<pre><code>${c.trim()}</code></pre>`);
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>')
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\*(.*?)\*/g, '<em>$1</em>')
                 .replace(/^#\s+(.*)/gm, '<h3>$1</h3>')
                 .replace(/^##\s+(.*)/gm, '<h4>$1</h4>');
      
      // Add African styling to wisdom quotes
      html = html.replace(/"([^"]*proverb[^"]*)"/gi, '<div class="proverb-box">$1</div>');
      html = html.replace(/"([^"]*ubuntu[^"]*)"/gi, '<div class="encouragement-box">üåç $1</div>');
      html = html.replace(/"([^"]*strength[^"]*)"/gi, '<div class="strength-highlight">üí™ $1</div>');
      
      // Convert lists
      html = html.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>');
      if (html.includes('<li>')) {
        html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
        html = html.replace(/<\/ul><ul>/g, '');
      }
      
      html = html.split('<pre>').map((seg, i) => i % 2 === 0 ? seg.replace(/\n/g, '<br>') : seg).join('<pre>');
      html = html.replace(/<br><pre>/g, '<pre>').replace(/<\/pre><br>/g, '</pre>');
      
      return html;
    }

    function addMessage(text, type, showCulturalBadge = false) {
      $welcome.style.display = 'none';
      const row = document.createElement('div');
      row.className = `message-row ${type}`;
      
      const content = document.createElement('div');
      content.className = 'message-content';
      content.innerHTML = parseMarkdown(text);
      
      if (showCulturalBadge && currentLang !== 'en') {
        const badge = document.createElement('div');
        badge.className = 'cultural-badge';
        badge.textContent = LANGUAGES[currentLang].native;
        content.appendChild(badge);
      }
      
      const time = document.createElement('div');
      time.className = 'timestamp';
      time.textContent = formatTime(new Date());
      
      if (type === 'ai') {
        const avatar = document.createElement('div');
        avatar.className = 'avatar ai';
        avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
        
        const actions = document.createElement('div');
        actions.className = 'copy-actions';
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = '<span class="material-symbols-rounded">content_copy</span> Copy';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(content.textContent.replace(/Copy$/, '').trim());
          copyBtn.innerHTML = '<span class="material-symbols-rounded">check</span> Copied';
          setTimeout(() => copyBtn.innerHTML = '<span class="material-symbols-rounded">content_copy</span> Copy', 2000);
        });
        
        const speakBtn = document.createElement('button');
        speakBtn.className = 'speak-btn';
        speakBtn.innerHTML = '<span class="material-symbols-rounded">volume_up</span> Speak';
        speakBtn.addEventListener('click', async () => {
          // Implementation for text-to-speech with cultural voices
          speakBtn.disabled = true;
          speakBtn.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span> Speaking...';
          
          try {
            const voiceId = ELEVENLABS_VOICE_IDS[currentLang] || ELEVENLABS_VOICE_IDS.en;
            const response = await fetch(
              `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`,
              {
                method: 'POST',
                headers: {
                  'Accept': 'audio/mpeg',
                  'xi-api-key': ELEVENLABS_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  text: content.textContent,
                  model_id: 'eleven_multilingual_v2',
                  voice_settings: { stability: 0.75, similarity_boost: 0.85 }
                })
              }
            );
            
            if (!response.ok) throw new Error(`TTS error: ${response.status}`);
            
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.onended = () => {
              speakBtn.innerHTML = '<span class="material-symbols-rounded">volume_up</span> Speak';
              speakBtn.disabled = false;
            };
            
            audio.play();
          } catch (err) {
            console.error('TTS error:', err);
            showCustomSnackbar('Speech generation failed');
            speakBtn.innerHTML = '<span class="material-symbols-rounded">volume_up</span> Speak';
            speakBtn.disabled = false;
          }
        });
        
        actions.append(copyBtn, speakBtn);
        content.appendChild(actions);
        row.append(avatar, content, time);
      } else {
        row.append(content, time);
      }
      
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function addLoading() {
      const row = document.createElement('div');
      row.id = 'loading';
      row.className = 'message-row ai';
      
      const avatar = document.createElement('div');
      avatar.className = 'avatar ai';
      avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
      
      const content = document.createElement('div');
      content.className = 'message-content';
      content.innerHTML = '<div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      
      row.append(avatar, content);
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function removeLoading() {
      const loading = $('#loading');
      if (loading) loading.remove();
    }

    // Enhanced message sending with user profiling
    window.sendMessage = async () => {
      const msg = $i.value.trim();
      if (!msg) return;
      
      if (!auth.currentUser) {
        showCustomSnackbar('Please sign in to access personalized learning');
        return;
      }
      
      const startTime = Date.now();
      $i.value = '';
      $send.classList.remove('active');
      
      addMessage(msg, 'user');
      
      // Analyze user input
      if (userProfile) {
        profileManager.analyzeInteraction(msg, null, 0);
      }
      
      // Check for cultural references
      const culturalRefs = userProfile ? 
        profileManager.extractCulturalReferences(msg) : [];
      
      // Check for learning-related queries
      if (msg.toLowerCase().includes('my strength') || msg.toLowerCase().includes('what am i good at')) {
        const strengths = profileManager.getTopStrength();
        addMessage(`Based on our interactions, I've noticed your **${strengths}** abilities are particularly strong! This is a beautiful gift that we can use to help you excel in other areas too. üåü`, 'ai', true);
        return;
      }
      
      if (msg.toLowerCase().includes('recommend') || msg.toLowerCase().includes('what should i learn')) {
        const recommendation = profileManager.getLearningRecommendation();
        addMessage(`I'd love to help you grow! Based on your learning profile, I recommend focusing on **${recommendation.subject}**. 

${recommendation.recommendation}

${recommendation.culturalApproach}

Remember: "When you learn, you grow the whole community." üåç`, 'ai', true);
        return;
      }
      
      addLoading();
      
      try {
        const messages = [...historyStack, { role: 'user', content: msg }];
        
        const res = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: { 
            Authorization: `Bearer ${XAI_KEY}`, 
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify({
            model: 'grok-4-1-fast-non-reasoning',
            messages,
            temperature: 0.7,
            max_tokens: 2000
          })
        });
        
        removeLoading();
        
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        
        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || 
                     'I apologize, but I need a moment to gather my thoughts. Let me try again.';
        
        addMessage(reply, 'ai', currentLang !== 'en');
        
        // Analyze the interaction
        const endTime = Date.now();
        if (userProfile) {
          profileManager.analyzeInteraction(msg, reply, endTime - startTime);
        }
        
        historyStack.push({ role: 'user', content: msg }, { role: 'assistant', content: reply });
        
      } catch (e) {
        removeLoading();
        addMessage('I apologize for the connection difficulty. In African tradition, we say "Patience is the mother of success." Please try again in a moment.', 'ai');
        console.error(e);
      }
    };

    // Input handling
    $i.addEventListener('input', () => {
      $send.classList.toggle('active', $i.value.trim().length > 0);
    });

    $i.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    $send.addEventListener('click', sendMessage);

    // Enhanced speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SR();
      rec.continuous = false;
      rec.interimResults = false;
      
      $mic.addEventListener('click', () => {
        if (!auth.currentUser) {
          showCustomSnackbar('Please sign in to use voice features');
          return;
        }
        
        rec.lang = LANGUAGES[currentLang].code;
        rec.start();
      });
      
      rec.onstart = () => {
        $mic.classList.add('listening');
        $i.placeholder = 'Listening... speak your heart';
      };
      
      rec.onresult = e => {
        $i.value = e.results[0][0].transcript;
        sendMessage();
      };
      
      rec.onend = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Share your thoughts, questions, or challenges...';
      };
      
      rec.onerror = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Share your thoughts, questions, or challenges...';
        showCustomSnackbar('Voice recognition failed - please try again');
      };
    } else {
      $mic.style.display = 'none';
    }

    // Authentication state management
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Initialize user profile
        userProfile = await profileManager.initializeProfile(user.uid);
        
        // Update welcome message
        $welcomeText.textContent = profileManager.getPersonalizedGreeting();
        
        // Show daily progress
        const today = new Date().toISOString().slice(0, 10);
        const progressRef = doc(db, 'dailyProgress', `${user.uid}_${today}`);
        const progressSnap = await getDoc(progressRef);
        
        if (progressSnap.exists()) {
          const progress = progressSnap.data();
          document.getElementById('dailyProgress').textContent = 
            `${progress.conceptsLearned || 0} concepts`;
        }
        
        showCustomSnackbar(`Welcome back, ${user.displayName || 'learner'}! Ready to discover your brilliance?`);
      } else {
        $welcomeText.textContent = 'Sawubona! Ready to discover your unique learning genius?';
        document.getElementById('dailyProgress').textContent = 'Sign in to track';
      }
    });

    // Initialize system
    initLanguageDropdown();
    updateSystemInstructions();

    // African rain animation (enhanced)
    const canvas = document.createElement('canvas');
    canvas.id = 'rainCanvas';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let w, h, drops = [];

    const colors = ['#d4a574', '#8b4513', '#ff6b35', '#228b22', '#5d4e37'];

    function resize() {
      w = innerWidth;
      h = innerHeight;
      canvas.width = w;
      canvas.height = h;
      drops = [];
      const count = Math.floor(w / 20);
      for (let i = 0; i < count; i++) {
        drops.push({
          x: Math.random() * w,
          y: Math.random() * h,
          len: Math.random() * 30 + 15,
          speed: Math.random() * 4 + 2,
          color: colors[Math.floor(Math.random() * colors.length)],
          opacity: Math.random() * 0.6 + 0.1,
          thickness: Math.random() * 2 + 1
        });
      }
    }

    addEventListener('resize', resize);
    resize();

    function draw() {
      ctx.clearRect(0, 0, w, h);
      for (const d of drops) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x, d.y + d.len);
        ctx.strokeStyle = d.color;
        ctx.lineWidth = d.thickness;
        ctx.globalAlpha = d.opacity;
        ctx.stroke();
        
        d.y += d.speed;
        if (d.y > h) {
          d.y = -d.len;
          d.x = Math.random() * w;
        }
      }
      requestAnimationFrame(draw);
    }
    draw();

    // PWA support
    let deferredPrompt;
    const $install = $('#installBtn');
    
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      $install.style.display = 'flex';
    });

    $install?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Install:', outcome);
      deferredPrompt = null;
      $install.style.display = 'none';
    });

    // Service worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(() => 
        console.log('SW registered for African companion app'));
    }

    console.log('üåç Vynix Lingua - Africa's Ultimate AI Companion initialized');
    console.log('üí° Ready to discover and nurture African excellence!');
  </script>
</body>
  </html>
