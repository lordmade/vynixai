<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Vynix Buddy&quot;,
    &quot;short_name&quot;:&quot;Vynix&quot;,
    &quot;description&quot;:&quot;Your CAPS AI Tutor for South African Education&quot;,
    &quot;start_url&quot;:&quot;/&quot;,
    &quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#ffffff&quot;,
    &quot;theme_color&quot;:&quot;#8b5cf6&quot;,
    &quot;orientation&quot;:&quot;portrait&quot;,
    &quot;scope&quot;:&quot;/&quot;,
    &quot;categories&quot;:[&quot;education&quot;,&quot;productivity&quot;],
    &quot;icons&quot;:[
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=72&quot;,&quot;sizes&quot;:&quot;72x72&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=96&quot;,&quot;sizes&quot;:&quot;96x96&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=128&quot;,&quot;sizes&quot;:&quot;128x128&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=144&quot;,&quot;sizes&quot;:&quot;144x144&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=152&quot;,&quot;sizes&quot;:&quot;152x152&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=384&quot;,&quot;sizes&quot;:&quot;384x384&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}
    ]
  }">

  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vynix Buddy">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <!-- KaTeX - Beautiful Math Rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"
    onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '\\[', right: '\\]', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\(', right: '\\)', display: false}
      ],
      throwOnError: false,
      errorColor: '#cc0000'
    });"></script>

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    textarea,input,.content,.katex-display,.katex{-webkit-user-select:text;user-select:text}
    body{font-family:'Inter',sans-serif;background:#fff;color:#111827;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 140px;-webkit-overflow-scrolling:touch}
    .message{margin:1.5rem 0;position:relative}
    .message.ai .content{background:#f8f9fa;border:1px solid #e9ecef;border-radius:1rem;padding:1rem 1.2rem;max-width:88%;line-height:1.7}
    .message.user .content{background:#9ca3af;color:#111827;border-radius:1rem;padding:1rem 1.2rem;margin-left:auto;max-width:85%;white-space:pre-wrap;word-break:break-word}
    .timestamp{font-size:.75rem;color:#6b7280;margin-top:4px}
    .message.ai .timestamp{margin-left:8px}
    .message.user .timestamp{margin-right:8px;text-align:right}
    .ai-actions{display:flex;gap:12px;margin-top:8px;margin-left:8px;opacity:.8}
    .action-btn{width:36px;height:36px;background:#f1f3f4;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
    .action-btn:hover{background:#e0e0e0;transform:scale(1.1)}
    .thinking{display:flex;gap:8px;padding:1rem 1.2rem}
    .dot{width:10px;height:10px;background:#8b5cf6;border-radius:50%;animation:pulse 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;padding:.75rem;padding-bottom:calc(.75rem + env(safe-area-inset-bottom));background:#fff;border-top:1px solid #e5e7eb;box-shadow:0 -4px 20px rgba(0,0,0,.08);z-index:100}
    .input-container{background:#f9fafb;border:1px solid #d1d5db;border-radius:1.5rem;padding:.75rem 1rem;display:flex;align-items:center;gap:.5rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .input-container:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.15)}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1rem;resize:none;max-height:120px;line-height:1.5}
    .send-btn{width:44px;height:44px;border-radius:50%;background:#8b5cf6;display:flex;align-items:center;justify-content:center}
    .send-btn:disabled{background:#9ca3af;cursor:not-allowed}
    .upload-btn{width:44px;height:44px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
    #filePreview{width:40px;height:40px;border-radius:.5rem;object-fit:cover;margin-right:.5rem;display:none;flex-shrink:0}
    .doc-preview{width:40px;height:40px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:.5rem;display:none;align-items:center;justify-content:center;flex-shrink:0}
    .token-bar{position:fixed;top:0;left:0;right:0;background:#8b5cf6;color:#fff;padding:.6rem 1rem;font-size:.9rem;text-align:center;z-index:50;display:flex;align-items:center;justify-content:center;gap:.5rem}
    .bottom-sheet{position:fixed;bottom:-100%;left:0;right:0;background:#fff;border-radius:1.5rem 1.5rem 0 0;padding:1.5rem;box-shadow:0 -10px 40px rgba(0,0,0,.25);transition:bottom .4s cubic-bezier(.32,.72,0,1);z-index:200;max-height:92dvh;overflow-y:auto}
    .bottom-sheet.active{bottom:0}
    .sheet-handle{width:40px;height:5px;background:#ddd;border-radius:3px;margin:0 auto 1rem}
    #customAlert{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-150%);background:linear-gradient(135deg,#8b5cf6 0%,#ec4899 100%);color:#fff;padding:1rem 1.5rem;border-radius:9999px;font-weight:600;box-shadow:0 10px 25px rgba(0,0,0,.25);z-index:9999;transition:transform .3s ease}
    #customAlert.show{transform:translateX(-50%) translateY(0)}
    .katex-display { margin: 1em 0 !important; }
    .katex { font-size: 1.1em !important; }
  </style>
</head>
<body>
  <div class="token-bar">
    <span id="tokenCount">15,000</span> tokens left today
    <button id="upgradePill" class="ml-3 px-4 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold text-sm rounded-full border border-white/40 transition active:scale-95">Upgrade</button>
  </div>

  <section id="chatPane">
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn" aria-label="Attach file"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*,.pdf,.doc,.docx" hidden>
      <img id="filePreview" alt="File preview">
      <div class="doc-preview" id="docPreview"><i data-lucide="file-text" width="20" height="20"></i></div>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1" aria-label="Chat input"></textarea>
      <button id="sendBtn" class="send-btn" disabled aria-label="Send"><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <!-- Upgrade & Papers Sheets -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-3">Never Run Out of Help Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <span class="text-purple-600 font-bold">Unlimited</span> and study without limits</p>
      <div class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl transform -rotate-2 mb-10">
        <div class="text-6xl font-black">R79</div>
        <div class="text-xl opacity-90">per month</div>
      </div>
      <button id="mockUpgrade" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">Yes! Upgrade Me Now – R79/month</button>
    </div>
  </div>

  <div id="papersSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('papersSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div id="papersContent" class="px-2"></div>
  </div>

  <div id="customAlert" role="alert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let yocoPublicKey = null;
    let yocoEnabled = false;
    let history = [];
    let currentImage = null;
    let currentFile = null;
    let waitingForProfile = false;
    let dailyTokens = 15000;
    let isPremium = false;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      filePreview: document.getElementById('filePreview'),
      docPreview: document.getElementById('docPreview'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      mockUpgrade: document.getElementById('mockUpgrade'),
      upgradePill: document.getElementById('upgradePill'),
      papersSheet: document.getElementById('papersSheet'),
      papersContent: document.getElementById('papersContent')
    };

    // Allow LaTeX in Markdown
    marked.setOptions({ sanitize: false, gfm: true, breaks: false });

    function customAlert(msg, duration = 2500) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }

    function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }
    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { els.upgradeSheet.classList.add('active'); return false; }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const userData = userSnap.val();
        if (userData?.premium) {
          isPremium = true; dailyTokens = 999999;
          document.querySelector('.token-bar').innerHTML = `<div class="flex items-center justify-center gap-3"><span>Unlimited access • Premium</span></div>`;
          return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val(); const now = Date.now(); const oneDay = 24*60*60*1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000; await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { dailyTokens = 15000; els.tokenCount.textContent = dailyTokens.toLocaleString(); }
    }

    async function generateExamPaper(subject, grade, topic) {
      const prompt = `Generate a CAPS-aligned exam paper for ${subject} Grade ${grade} on "${topic}".

Use proper LaTeX math: $$...$$ for display equations, $...$ for inline.

REQUIREMENTS:
- Exactly 5 tough questions (10 marks each, total 50)
- Clear sub-parts (a), (b), etc.
- Include diagrams where relevant
- Provide FULL detailed memorandum
- Separate with "---MEMO---"

FORMAT:
Subject: ${subject} | Grade ${grade} | Topic: ${topic}
Time: 1 hour | Marks: 50

QUESTION 1 (10 marks):
...
---MEMO---
MEMORANDUM...`;

      addThinking();
      if (!(await deductTokens(2500))) { removeThinking(); return null; }

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [{role:"user",content:prompt}],
            max_tokens: 8000,
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || null;
      } catch (e) {
        console.error(e);
        return null;
      } finally {
        removeThinking();
      }
    }

    function showPastPapersSheet() {
      const grade = userProfile?.grade || "12";
      els.papersContent.innerHTML = `
        <h3 class="text-xl font-bold mb-4">Generate CAPS Practice Paper</h3>
        <div class="space-y-4">
          <div><label class="block text-sm font-medium mb-1">Subject</label>
            <select id="subjectSelect" class="w-full border rounded-lg p-2 bg-white">
              <option>Mathematics</option><option>Physical Sciences</option><option>Life Sciences</option>
              <option>Accounting</option><option>Business Studies</option><option>Geography</option>
              <option>History</option><option>English HL</option>
            </select>
          </div>
          <div><label class="block text-sm font-medium mb-1">Topic</label>
            <input type="text" id="topicInput" class="w-full border rounded-lg p-2" placeholder="e.g. Calculus, Chemical Equilibrium">
          </div>
          <button id="generatePaperBtn" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">
            Generate 5 Tough Questions + Memo
          </button>
        </div>`;

      els.papersSheet.classList.add('active');

      document.getElementById('generatePaperBtn').onclick = async () => {
        const subject = document.getElementById('subjectSelect').value;
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) { customAlert("Please enter a topic"); return; }
        els.papersSheet.classList.remove('active');

        const examText = await generateExamPaper(subject, grade, topic);
        if (!examText) { customAlert("Failed to generate paper"); return; }

        const [qp, memo] = examText.split("---MEMO---");
        const container = document.createElement('div');
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        container.style.width = '800px';
        container.style.padding = '40px';
        container.style.background = 'white';
        container.style.fontFamily = 'Inter, sans-serif';
        container.innerHTML = `
          <h1 style="text-align:center;color:#8b5cf6;font-size:28px;">Vynix Buddy</h1>
          <h2 style="text-align:center;font-size:22px;">CAPS Practice Paper</h2>
          <p style="text-align:center;font-size:16px;">${subject} • Grade ${grade} • ${topic}</p>
          <p style="text-align:center;margin:20px 0;">Generated: ${new Date().toLocaleDateString('en-ZA')}</p>
          <div style="margin-top:40px;">${marked.parse(qp.trim())}</div>
          <div style="page-break-before:always;margin-top:60px;">
            <h2 style="text-align:center;font-size:22px;">MEMORANDUM</h2>
            ${marked.parse(memo?.trim() || "No memo generated")}
          </div>
        `;
        document.body.appendChild(container);
        renderMathInElement(container);

        setTimeout(() => {
          html2canvas(container, { scale: 2 }).then(canvas => {
            const img = canvas.toDataURL('image/png');
            const doc = new jsPDF('p', 'mm', 'a4');
            const width = doc.internal.pageSize.getWidth();
            const height = (canvas.height * width) / canvas.width;
            doc.addImage(img, 'PNG', 0, 0, width, height);
            doc.save(`CAPS_${subject.replace(/\s/g,"_")}_Grade${grade}_${topic.replace(/\s/g,"_")}.pdf`);
            document.body.removeChild(container);
            customAlert("Practice paper downloaded!");
          });
        }, 800);
      };
    }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const time = formatTime();

      if (sender === 'ai') {
        const rendered = marked.parse(content);
        div.innerHTML = `
          <div class="content">${rendered}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn" aria-label="Copy"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn" aria-label="Listen"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn" aria-label="PDF"><i data-lucide="download"></i></button>
            <button class="action-btn papers-btn" aria-label="Past Papers"><i data-lucide="file-text" class="text-purple-700"></i></button>
          </div>
          <div class="timestamp">${time}</div>`;
      } else {
        const userText = content.includes('<img') ? content : content.replace(/\n/g, '<br>');
        div.innerHTML = `<div class="content">${userText}</div><div class="timestamp">${time}</div>`;
      }

      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();
      renderMathInElement(div);

      if (sender === 'ai') {
        div.querySelector('.copy-btn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plainText || content);
          customAlert("Copied!");
        });

        div.querySelector('.voice-btn')?.addEventListener('click', async () => {
          if (!elevenlabsKey) return customAlert("Voice not available");
          const voiceId = 'pNInz6obpgDQGcFmaJgB';
          const btn = div.querySelector('.voice-btn');
          btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
          lucide.createIcons();
          try {
            const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
              method: 'POST',
              headers: { 'xi-api-key': elevenlabsKey, 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: plainText || content, model_id: 'eleven_monolingual_v1' })
            });
            const audio = new Audio(URL.createObjectURL(await res.blob()));
            audio.play();
            audio.onended = () => { btn.innerHTML = '<i data-lucide="volume-2"></i>'; lucide.createIcons(); };
          } catch { customAlert("Voice failed"); }
        });

        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11);
          doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_Answer_${new Date().toISOString().slice(0,10)}.pdf`);
        });

        div.querySelector('.papers-btn')?.addEventListener('click', showPastPapersSheet);
      }
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    function removeThinking() { document.getElementById('thinking')?.remove(); }

    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;

      const cost = currentImage ? 1500 : estimateTokens(text);
      if (!(await deductTokens(cost))) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="Uploaded work">`, 'user');
        history.push({ role: "user", content: `[Image: ${currentImage}]` });
        if (!text) text = "Explain this image";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; hidePreview(); addThinking();
      const reply = await getReply(text);
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting to Grok...";
      const system = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. Always use $...$ for inline math and $$...$$ for display math. Be encouraging and explain step-by-step.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [{ role: "system", content: system }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch { return "No internet connection."; }
    }

    function hidePreview() {
      els.filePreview.style.display = 'none';
      els.docPreview.style.display = 'none';
      currentImage = null;
      currentFile = null;
      updateSendButton();
    }

    function updateSendButton() {
      const hasText = els.chatInput.value.trim().length > 0;
      const hasFile = currentImage !== null;
      els.sendBtn.disabled = !hasText && !hasFile;
    }

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const isImage = file.type.startsWith('image/');
      if (isImage) {
        els.filePreview.src = URL.createObjectURL(file);
        els.filePreview.style.display = 'block';
        els.docPreview.style.display = 'none';
      } else {
        els.docPreview.style.display = 'flex';
        els.filePreview.style.display = 'none';
      }

      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'banter_box');
      try {
        customAlert("Uploading...");
        const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/upload", { method: "POST", body: fd });
        const data = await res.json();
        if (data.secure_url) {
          currentImage = data.secure_url;
          currentFile = file;
          updateSendButton();
          customAlert("Uploaded!");
        }
      } catch { customAlert("Upload failed"); hidePreview(); }
    };

    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');
    els.mockUpgrade.onclick = () => customAlert("Upgrade coming soon!");

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
      await loadTokens();
      userProfile = (await get(child(ref(db), `users/${user.uid}/profile`))).val() || {};
      addMessage(`Sawubona ${userProfile.name || "learner"}! Ready for Grade ${userProfile.grade || "?"}?`, 'ai');
    });
  </script>
</body>
</html>
