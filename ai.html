<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <!-- keyboard-safe viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>StudyBuddy – AI Tutor (Grade 1-12)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --bg: #F7F7F8; --card-bg: #1C2526; --highlight: #38B2AC; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    .top-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 30; height: 64px; background: var(--bg); border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; }
    .v-logo { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    #api-status { width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s; }
    #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }

    /* ---------- chat area ---------- */
    .chat-area { flex: 1; overflow-y: auto; padding: 1rem; padding-top: 74px; padding-bottom: 9rem; display: flex; flex-direction: column; gap: 0.8rem; }
    .message { display: flex; flex-direction: column; max-width: 78%; }
    .message.user { align-self: flex-end; }
    .message.ai { align-self: flex-start; }
    .message .content { padding: 1rem 1.2rem; border-radius: 1.2rem; box-shadow: 0 3px 12px rgba(0,0,0,0.15); position: relative; line-height: 1.6; padding-right: 3.5rem; word-wrap: break-word; }
    .message.user .content { background: linear-gradient(135deg, #E0E7FF, #C7D2FE); color: #1E1E1E; }
    .message.ai .content { background: linear-gradient(135deg, #1C2526, #2D3748); color: white; }

    /* icons inside bubble */
    .msg-icon-group { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; flex-direction: column; gap: 0.4rem; opacity: 0; transition: opacity 0.2s; }
    .message.ai:hover .msg-icon-group { opacity: 1; }
    .msg-icon { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .msg-icon:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); }

    /* ---------- keyboard-safe input bar ---------- */
    .input-wrapper { position: fixed; bottom: 0; left: 0; right: 0; z-index: 20; background: var(--bg); border-top: 1px solid #ddd; }
    /* suggestions strip */
    #suggestions { display: flex; gap: 0.5rem; padding: 0.5rem 1rem; overflow-x: auto; }
    .suggestion-chip { background: #e5e7eb; color: #111; white-space: nowrap; padding: 0.4rem 0.9rem; border-radius: 9999px; font-size: 0.8rem; cursor: pointer; transition: background 0.2s; }
    .suggestion-chip:hover { background: #d1d5db; }
    /* input row */
    .input-bar-inner { display: flex; align-items: flex-end; gap: 0.5rem; padding: 0.75rem 1rem; padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); }
    .input-container { flex: 1; background: var(--card-bg); border-radius: 1.5rem; padding: 0.5rem 1rem; display: flex; align-items: flex-end; gap: 0.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    #chatInput { flex: 1; background: transparent; border: none; outline: none; color: white; font-size: 1rem; max-height: 120px; resize: none; }
    .send-btn { background: var(--highlight); width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    /* circular upload */
    #uploadBtnCircle { width: 46px; height: 46px; border-radius: 50%; background: var(--card-bg); display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.15); cursor: pointer; }

    /* ---------- thinking dots ---------- */
    .thinking-dots { display: flex; gap: 6px; padding: 1rem 1.2rem; background: linear-gradient(135deg, #1C2526, #2D3748); border-radius: 1.2rem; width: fit-content; }
    .thinking-dots span { width: 8px; height: 8px; background: #fff; border-radius: 50%; animation: pulse 1.2s infinite; }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%, 80%, 100% { transform: scale(0.7); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

    /* ---------- sidebar ---------- */
    .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 15px rgba(0,0,0,0.1); transform: translateX(-100%); transition: 0.3s; z-index: 40; display: flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { background: #000; color: white; padding: 2rem 1.5rem; text-align: center; }
    #slideProfile { width: 80px; height: 80px; border-radius: 50%; background: var(--highlight); margin: 0 auto 0.8rem; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; color: white; }
    #slideName { font-size: 1.3rem; font-weight: 700; }
    #slideGrade { font-size: 0.95rem; opacity: 0.9; margin-top: 0.4rem; }
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); opacity: 0; visibility: hidden; transition: 0.3s; z-index: 35; }
    #overlay.on { opacity: 1; visibility: visible; }

    /* ---------- onboarding ---------- */
    #onboardingModal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 60; display: none; align-items: center; justify-content: center; }
    #onboardingModal.show { display: flex; }
    .onboarding-content { background: white; border-radius: 1.5rem; padding: 2rem; width: 90%; max-width: 400px; text-align: center; }
    #saveProfileBtn { background: linear-gradient(135deg, var(--highlight), #4ADEDE); color: white; border: none; padding: 1rem; border-radius: 1rem; font-weight: bold; width: 100%; margin-top: 1rem; cursor: pointer; }
  </style>
</head>
<body>

  <!-- ---------- ONBOARDING ---------- -->
  <div id="onboardingModal">
    <div class="onboarding-content">
      <h2 class="text-2xl font-bold mb-2">Welcome to StudyBuddy!</h2>
      <p class="text-gray-600 mb-6">Let me know you so I can teach you perfectly</p>
      <input type="text" id="onboardingName" placeholder="Your Name" class="w-full p-3 border rounded-lg mb-4">
      <select id="onboardingGrade" class="w-full p-3 border rounded-lg mb-4">
        <option value="">Select Grade</option>
        <option value="1">Grade 1</option><option value="2">Grade 2</option><option value="3">Grade 3</option>
        <option value="4">Grade 4</option><option value="5">Grade 5</option><option value="6">Grade 6</option>
        <option value="7">Grade 7</option><option value="8">Grade 8</option><option value="9">Grade 9</option>
        <option value="10">Grade 10</option><option value="11">Grade 11</option><option value="12">Grade 12</option>
      </select>
      <select id="onboardingRole" class="w-full p-3 border rounded-lg mb-6">
        <option value="">I am a...</option>
        <option value="student">Student</option>
        <option value="teacher">Teacher</option>
        <option value="parent">Parent</option>
      </select>
      <button id="saveProfileBtn">Start Learning!</button>
    </div>
  </div>

  <!-- ---------- TOP BAR ---------- -->
  <header class="top-bar">
    <button id="menuBtn" class="bg-gray-800 text-white px-4 py-2 rounded-full text-sm">Menu</button>
    <div class="v-logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
    <div id="api-status"></div>
  </header>

  <!-- ---------- CHAT AREA ---------- -->
  <section id="chatPane" class="chat-area">
    <div id="welcome" class="text-center text-gray-700">
      <h1 class="text-xl font-bold">Hey! I'm StudyBuddy</h1>
      <p class="text-sm mt-1">Ask anything or upload homework</p>
    </div>
  </section>

  <!-- ---------- INPUT BAR (KEYBOARD-SAFE) ---------- -->
  <div class="input-wrapper">
    <!-- suggestions -->
    <div id="suggestions" class="hidden"></div>

    <div class="input-bar-inner">
      <!-- circular upload -->
      <button id="uploadBtnCircle" title="Upload photo">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
      </button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>

      <div class="input-container">
        <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
        <button id="sendBtn" class="send-btn" disabled>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22,2 15,22 11,13 2,9 22,2"></polygon></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- ---------- SIDEBAR ---------- -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="v-logo mx-auto"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
      <div id="slideProfile">S</div>
      <div id="slideName" class="mt-2">Loading...</div>
      <div id="slideGrade">Grade ? • Role ?</div>
    </div>
    <button id="newConvBtn" class="mx-4 mt-4 bg-gradient-to-r from-teal-500 to-emerald-600 text-white py-3 rounded-xl font-bold">+ New Session</button>
    <div id="convList" class="flex-1 overflow-y-auto px-4 mt-4"></div>
    <div class="p-4 border-t border-gray-200 text-sm">
      <div class="flex justify-between mb-2"><span>Tokens today</span><span id="tokenCount">0 / 15,000</span></div>
      <div class="h-2 bg-gray-200 rounded-full overflow-hidden"><div id="tokenFill" class="h-full bg-gradient-to-r from-teal-500 to-emerald-600" style="width:0%"></div></div>
    </div>
  </aside>

  <div id="overlay"></div>

  <!-- ---------- FIREBASE ---------- -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, push, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let userId, userProfile, xaiApiKey, currentImage, history = [], currentConvId = null, todayTokens = 0;
    const ENC_KEY = "studybuddy2025sa";
    const DAILY_LIMIT = 15000;

    const els = {
      chatPane: document.getElementById('chatPane'),
      welcome: document.getElementById('welcome'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      menuBtn: document.getElementById('menuBtn'),
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('overlay'),
      newConvBtn: document.getElementById('newConvBtn'),
      slideName: document.getElementById('slideName'),
      slideGrade: document.getElementById('slideGrade'),
      slideProfile: document.getElementById('slideProfile'),
      tokenCount: document.getElementById('tokenCount'),
      tokenFill: document.getElementById('tokenFill'),
      uploadBtnCircle: document.getElementById('uploadBtnCircle'),
      hiddenFile: document.getElementById('hiddenFile'),
      fileName: document.getElementById('fileName'),
      onboardingModal: document.getElementById('onboardingModal'),
      saveProfileBtn: document.getElementById('saveProfileBtn'),
      suggestions: document.getElementById('suggestions'),
      convList: document.getElementById('convList')
    };

    /* ---------- crypto helpers ---------- */
    async function encrypt(text) {
      const enc = new TextEncoder();
      const keyData = enc.encode(ENC_KEY.padEnd(32, "0").slice(0, 32));
      const key = await crypto.subtle.importKey("raw", keyData, "AES-GCM", false, ["encrypt"]);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, enc.encode(text));
      const combined = new Uint8Array(iv.length + encrypted.byteLength);
      combined.set(iv); combined.set(new Uint8Array(encrypted), iv.length);
      return btoa(String.fromCharCode(...combined));
    }
    async function decrypt(b64) {
      try {
        const data = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
        const iv = data.slice(0, 12); const ciphertext = data.slice(12);
        const keyData = new TextEncoder().encode(ENC_KEY.padEnd(32, "0").slice(0, 32));
        const key = await crypto.subtle.importKey("raw", keyData, "AES-GCM", false, ["decrypt"]);
        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, ciphertext);
        return new TextDecoder().decode(decrypted);
      } catch (e) { return "[Failed to decrypt]"; }
    }

    /* ---------- token helpers ---------- */
    function estimateTokens(n) { return Math.ceil((n / 4) * 1.3); }
    async function loadTokens() {
      const today = new Date().toISOString().slice(0, 10);
      const snap = await get(ref(db, `tokenUsage/${userId}/${today}`));
      todayTokens = snap.val() || 0;
      els.tokenCount.textContent = `${todayTokens.toLocaleString()} / 15,000`;
      els.tokenFill.style.width = `${Math.min(100, (todayTokens / DAILY_LIMIT) * 100)}%`;
    }
    async function addTokens(n) {
      const today = new Date().toISOString().slice(0, 10);
      await set(ref(db, `tokenUsage/${userId}/${today}`), increment(n));
      todayTokens += n;
      loadTokens();
    }

    /* ---------- remote config ---------- */
    async function initRemote() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiApiKey = getString(rc, 'xai_api_key').trim();
      if (xaiApiKey) document.getElementById('api-status').classList.add('connected');
    }

    /* ---------- UI helpers ---------- */
    function copyIcon() { return `<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 00-2 2v14h2V3h12V1zm3 4H8a2 2 0 00-2 2v14a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2zm0 16H8V7h11v14z"/></svg>`; }
    function speakerIcon() { return `<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3a4.5 4.5 0 000-3v3zM16 4.5a7.5 7.5 0 000 15v-1.5a6 6 0 000-12V4.5z"/></svg>`; }

    /* ---------- speech ---------- */
    function speakHuman(text) {
      const utter = new SpeechSynthesisUtterance();
      utter.text = text.split('.').join('. ');
      utter.lang = 'en-ZA';
      utter.rate = 0.92;
      utter.pitch = 0.96;
      const voices = speechSynthesis.getVoices();
      const v = voices.find(v => v.lang === 'en-ZA');
      if (v) utter.voice = v;
      speechSynthesis.speak(utter);
    }

    /* ---------- vibration ---------- */
    function doneVibrate() {
      if ('vibrate' in navigator) navigator.vibrate(200);
      else { document.body.style.background = '#ddd'; setTimeout(() => document.body.style.background = '', 200); }
    }

    /* ---------- add message ---------- */
    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      div.innerHTML = `
        <div class="content">
          ${isImage ? content : marked.parse(content)}
          ${sender === 'ai' && !isImage ? `
          <div class="msg-icon-group">
            <button class="msg-icon copy-btn" title="Copy">${copyIcon()}</button>
            <button class="msg-icon voice-btn" title="Read aloud">${speakerIcon()}</button>
          </div>` : ''}
        </div>
      `;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      els.welcome.classList.add('hidden');

      if (sender === 'ai' && !isImage) {
        const text = plainText || content;
        div.querySelector('.copy-btn').onclick = () => { navigator.clipboard.writeText(text); };
        div.querySelector('.voice-btn').onclick = () => speakHuman(text);
      }
    }

    /* ---------- thinking ---------- */
    let thinkingEl = null;
    function showThinking() {
      thinkingEl = document.createElement('div');
      thinkingEl.id = 'typingBubble';
      thinkingEl.className = 'message ai';
      thinkingEl.innerHTML = `<div class="content"><div class="thinking-dots"><span></span><span></span><span></span></div></div>`;
      els.chatPane.appendChild(thinkingEl);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { if (thinkingEl) thinkingEl.remove(); thinkingEl = null; }

    /* ---------- suggestions ---------- */
    const quickSuggestions = [
      "Explain photosynthesis simply",
      "Grade 10 trigonometry basics",
      "How to write an essay",
      "What is a prime number?",
      "Help with fractions",
      "Newton's laws summary",
      "Tips for exams",
      "What causes lightning?"
    ];
    function updateSuggestions() {
      const val = els.chatInput.value.trim().toLowerCase();
      if (!val) { els.suggestions.classList.add('hidden'); return; }
      const filtered = quickSuggestions.filter(s => s.toLowerCase().includes(val)).slice(0, 3);
      if (filtered.length === 0) { els.suggestions.classList.add('hidden'); return; }
      els.suggestions.innerHTML = '';
      filtered.forEach(text => {
        const chip = document.createElement('div');
        chip.className = 'suggestion-chip';
        chip.textContent = text;
        chip.onclick = () => { els.chatInput.value = text; els.suggestions.classList.add('hidden'); sendMessage(); };
        els.suggestions.appendChild(chip);
      });
      els.suggestions.classList.remove('hidden');
    }
    els.chatInput.addEventListener('input', updateSuggestions);

    /* ---------- send ---------- */
    async function sendMessage() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      if (!currentConvId) { const r = push(ref(db, `users/${userId}/conversations`)); currentConvId = r.key; }

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full">`, 'user');
        history.push({ role: "user", content: currentImage });
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null; els.suggestions.classList.add('hidden');
      els.sendBtn.disabled = true;

      showThinking();
      const reply = await getReply(text || "Explain this homework image");
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
      await addTokens(estimateTokens(reply));
      doneVibrate();

      // save conversation
      const convoData = {
        title: history.find(m => m.role === "user" && typeof m.content === "string")?.content.slice(0, 50) || "New Chat",
        historyEncrypted: await encrypt(JSON.stringify(history)),
        lastMessage: serverTimestamp(),
        preview: reply.slice(0, 80) + (reply.length > 80 ? "..." : "")
      };
      await set(ref(db, `users/${userId}/conversations/${currentConvId}`), convoData);
      loadConversations();
    }

    async function getReply(userMsg) {
      const system = `You are StudyBuddy, a kind and clear AI tutor helping ${userProfile?.name || "a student"} (Grade ${userProfile?.grade || "?"} in South Africa). Always explain step-by-step and be encouraging.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-beta", messages: [{ role: "system", content: system }, ...history.slice(-10), { role: "user", content: userMsg }], temperature: 0.7 })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm having trouble thinking right now. Try again!";
      } catch (e) { return "Sorry, I can't connect right now. Please check your internet."; }
    }

    /* ---------- upload ---------- */
    els.uploadBtnCircle.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async () => {
      const file = els.hiddenFile.files[0];
      if (!file) return;
      els.fileName.textContent = file.name;
      const form = new FormData(); form.append('file', file); form.append('upload_preset', 'studybuddy');
      try {
        const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: form });
        const data = await res.json();
        if (data.secure_url) { currentImage = data.secure_url; els.sendBtn.disabled = false; }
      } catch (e) { alert("Upload failed"); }
    };

    els.sendBtn.onclick = sendMessage;
    els.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    els.chatInput.addEventListener('input', () => { els.sendBtn.disabled = !els.chatInput.value.trim() && !currentImage; });

    /* ---------- menu ---------- */
    els.menuBtn.onclick = () => { els.sidebar.classList.add('open'); els.overlay.classList.add('on'); };
    els.overlay.onclick = () => { els.sidebar.classList.remove('open'); els.overlay.classList.remove('on'); };
    els.newConvBtn.onclick = async () => {
      currentConvId = null; history = []; els.chatPane.innerHTML = ''; els.welcome.classList.remove('hidden');
      els.overlay.click(); loadConversations();
    };

    /* ---------- profile ---------- */
    els.saveProfileBtn.onclick = async () => {
      const name = document.getElementById('onboardingName').value.trim();
      const grade = document.getElementById('onboardingGrade').value;
      const role = document.getElementById('onboardingRole').value;
      if (!name || !grade || !role) return alert("Please fill all fields");
      userProfile = { name, grade, role };
      await set(ref(db, `users/${userId}/profile`), userProfile);
      els.onboardingModal.classList.remove('show');
      loadProfile();
    };

    async function loadProfile() {
      const snap = await get(ref(db, `users/${userId}/profile`));
      userProfile = snap.val();
      if (!userProfile?.name) { els.onboardingModal.classList.add('show'); return; }
      els.slideName.textContent = userProfile.name;
      els.slideProfile.textContent = userProfile.name[0].toUpperCase();
      els.slideGrade.textContent = `Grade ${userProfile.grade} • ${userProfile.role.charAt(0).toUpperCase() + userProfile.role.slice(1)}`;
    }

    async function loadConversations() {
      els.convList.innerHTML = '<p class="text-gray-500 text-center text-sm py-8">Loading...</p>';
      const snap = await get(ref(db, `users/${userId}/conversations`));
      els.convList.innerHTML = '';
      if (!snap.exists()) { els.convList.innerHTML = '<p class="text-gray-500 text-center text-sm py-8">No chats yet</p>'; return; }
      const convs = Object.entries(snap.val()).sort(([, a], [, b]) => (b.lastMessage || 0) - (a.lastMessage || 0));
      for (const [id, c] of convs) {
        const div = document.createElement('div');
        div.className = 'p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition mb-2';
        if (id === currentConvId) div.classList.add('bg-teal-50', 'border', 'border-teal-300');
        div.innerHTML = `<div class="font-medium text-sm truncate">${c.title || "Chat"}</div><div class="text-xs text-gray-500 truncate mt-1">${c.preview || ""}</div>`;
        div.onclick = async () => {
          currentConvId = id; history = JSON.parse(await decrypt(c.historyEncrypted));
          els.chatPane.innerHTML = ''; els.welcome.classList.add('hidden');
          history.forEach(msg => {
            if (msg.role === "user") addMessage(msg.content, 'user');
            else if (msg.role === "assistant") addMessage(msg.content, 'ai', msg.content);
          });
          els.chatPane.scrollTop = els.chatPane.scrollHeight; els.overlay.click();
        };
        els.convList.appendChild(div);
      }
    }

    /* ---------- auth ---------- */
    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = "login.html"; return; }
      userId = user.uid;
      await initRemote();
      await loadProfile();
      await loadTokens();
      await loadConversations();
    });
  </script>
</body>
</html>
