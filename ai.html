<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Vynix AI ‚Ä¢ Trends + Viral Posts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Prism + Marked -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    *, *::before, *::after { -webkit-tap-highlight-color: transparent; }
    input, textarea, .content { -webkit-user-select: text !important; user-select: text !important; }
    html, body { height: 100vh; margin: 0; overscroll-behavior: none; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-secondary); display: flex; flex-direction: column; }
    .top-bar { flex-shrink: 0; height: 64px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; z-index: 10; }
    .v-logo { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .v-logo svg { width: 22px; height: 22px; fill: white; }
    #api-status { width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s; }
    #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }
    .chat-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem; padding-bottom: 6rem; display: flex; flex-direction: column; gap: 0.6rem; }
    .message { display: flex; flex-direction: column; width: 100%; }
    .message.user { align-items: flex-end; }
    .message.ai { align-items: flex-start; }
    .message .content { max-width: 78%; padding: 0.75rem 1.1rem; border-radius: 1.1rem; box-shadow: 0 2px 8px rgba(0,0,0,.18); line-height: 1.5; }
    .message.user .content { background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE); color: #1E1E1E; }
    .message.ai .content { background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748); color: var(--text-primary); }
    .message-time { font-size: 0.65rem; opacity: 0.6; margin-top: 0.25rem; padding: 0 0.4rem; }
    .input-bar { position: fixed; left: 0; right: 0; bottom: 0; padding: 0.75rem 1rem; border-top: 1px solid var(--border); background: var(--bg); z-index: 20; transition: transform 0.25s ease; }
    .input-wrapper { display: flex; align-items: center; gap: 0.5rem; background: var(--card-bg); border-radius: 9999px; padding: 0.5rem 1rem; }
    #chatInput { flex: 1; background: transparent; border: none; outline: none; color: var(--text-primary); font-size: 1rem; }
    #sendBtn svg { width: 1.5rem; height: 1.5rem; stroke: var(--text-primary); }
    .sidebar { position: fixed; inset: 0; width: 280px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,.1); transform: translateX(-100%); transition: transform .3s ease; z-index: 40; display: flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { background: #000; color: white; padding: 1.5rem; text-align: center; }
    #convList { flex: 1; overflow-y: auto; }
    .conv-item { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .conv-item:hover { background: #f0f0f0; }
    .conv-item.active { background: #e0e7ff; font-weight: 600; }
    .delete-conv { color: #ef4444; opacity: .7; }
    #userPlanBadge { margin: 1rem; padding: .6rem 1rem; border-radius: 9999px; background: linear-gradient(135deg, var(--highlight), #4ADEDE); color: white; font-weight: 700; font-size: .8rem; text-align: center; }
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); opacity: 0; visibility: hidden; transition: all .3s; z-index: 35; }
    #overlay.on { opacity: 1; visibility: visible; }
    #toast { position: fixed; bottom: 5.5rem; left: 50%; transform: translateX(-50%); background: var(--card-bg); color: white; padding: .5rem 1rem; border-radius: 9999px; box-shadow: 0 4px 14px rgba(0,0,0,.25); opacity: 0; pointer-events: none; transition: opacity .3s; z-index: 25; }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>
  <header class="top-bar">
    <button id="menuBtn" class="flex items-center gap-2 text-sm text-white bg-[var(--card-bg)] border border-[var(--border)] px-3 py-2 rounded-full">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      Menu
    </button>
    <div class="v-logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
    <div id="api-status"></div>
  </header>

  <section id="chatPane" class="chat-area">
    <div id="welcome" class="text-center m-auto">
      <h1 class="text-lg font-semibold text-black">Hey there!</h1>
      <p class="text-sm text-gray-600 mt-1">Chat normally or type <strong>trends</strong> / <strong>generate post</strong></p>
    </div>
  </section>

  <div class="input-bar" id="inputBar">
    <div class="input-wrapper">
      <input id="chatInput" type="text" placeholder="Ask anything or try 'trends crypto'..." autocomplete="off">
      <button id="sendBtn">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M5 12l6-6m-6 12l6 6"/></svg>
      </button>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="v-logo mx-auto"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
      <div class="mt-3">
        <div id="slideProfile" class="w-18 h-18 rounded-full bg-[var(--highlight)] mx-auto flex items-center justify-center text-white text-2xl font-bold">U</div>
        <div id="slideName" class="mt-2 font-semibold">User</div>
      </div>

      <button id="connectXBtn" class="mt-4 w-11/12 mx-auto py-3 bg-black text-white font-bold rounded-xl flex items-center justify-center gap-3 hover:bg-gray-800 transition">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.85L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        <span id="xBtnText">Connect X for Trends</span>
      </button>
    </div>

    <button id="newConvBtn" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold">+ New Conversation</button>
    <div id="convList" class="flex-1 overflow-y-auto"></div>
    <div id="userPlanBadge">Free Forever ‚Ä¢ 25 000 tokens/day</div>
  </aside>

  <div id="overlay"></div>
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let xaiApiKey = null, xaiEndpoint = "https://api.x.ai/v1/chat/completions";
    const statusDot = document.getElementById('api-status');
    let userId = null, todayTokensUsed = 0, xAccessToken = null, xUsername = null;
    const DAILY_TOKEN_LIMIT = 25000;
    const SYSTEM_PROMPT = `You are Vynix AI, a super helpful, witty, and friendly AI assistant created by the vynix.ai team. Never mention Grok, xAI, Elon Musk, or any other model. You are Vynix AI ‚Äî that's your full identity.`;

    marked.setOptions({ breaks: true, gfm: true, highlight: (code, lang) => Prism.highlight(code, Prism.languages[lang] || Prism.languages.markup, lang) });

    // ==================== X OAuth (safe & compliant) ====================
    const X_CLIENT_ID = "YOUR_X_CLIENT_ID_HERE"; // ‚Üê CHANGE THIS

    document.getElementById('connectXBtn').onclick = () => {
      if (xAccessToken) { toast("X already connected!"); return; }
      startXOAuth();
    };

    async function startXOAuth() {
      const verifier = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(43))));
      const challenge = await sha256(verifier).then(b => btoa(String.fromCharCode(...new Uint8Array(b))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_'));
      sessionStorage.setItem('cv', verifier);
      const redirectUri = encodeURIComponent(location.origin + location.pathname);
      const authUrl = `https://twitter.com/i/oauth2/authorize?client_id=\( {X_CLIENT_ID}&response_type=code&redirect_uri= \){redirectUri}&scope=tweet.read%20tweet.write%20users.read%20offline.access%20follows.read&state=vynix&code_challenge=${challenge}&code_challenge_method=S256`;
      location.href = authUrl;
    }

    if (location.search.includes('code=')) {
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      if (code && sessionStorage.getItem('cv')) handleXCallback(code);
    }

    async function handleXCallback(code) {
      const verifier = sessionStorage.getItem('cv');
      sessionStorage.removeItem('cv');
      const res = await fetch('https://api.twitter.com/2/oauth2/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          client_id: X_CLIENT_ID,
          code,
          redirect_uri: encodeURIComponent(location.origin + location.pathname),
          code_verifier: verifier
        })
      });
      const data = await res.json();
      if (data.access_token) {
        xAccessToken = data.access_token;
        const me = await fetch('https://api.twitter.com/2/users/me', { headers: { Authorization: `Bearer ${xAccessToken}` }}).then(r => r.json());
        xUsername = me.data.username;
        await set(ref(db, `users/${userId}/x`), { token: xAccessToken, username: xUsername });
        document.getElementById('xBtnText').textContent = `@${xUsername} connected`;
        document.getElementById('connectXBtn').style.background = '#1DA1F2';
        toast("X connected! Try: trends or generate post");
        history.replaceState(null, null, location.pathname);
      }
    }

    async function sha256(str) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return buf;
    }

    // ==================== TrendSpotter Magic ====================
    function extractHotKeywords(tweets) {
      const map = {};
      tweets?.forEach(t => {
        t.text.split(/\s+/).forEach(w => {
          w = w.replace(/[^\w#]/g, '');
          if (w.length > 4 && !w.startsWith('http') && !w.startsWith('@')) {
            map[w.toLowerCase()] = (map[w.toLowerCase()] || 0) + 1;
          }
        });
      });
      return Object.keys(map).sort((a,b) => map[b] - map[a]).slice(0, 12);
    }

    // ==================== Core AI + Trend Reply ====================
    async function getReply(userMsg, hist = []) {
      const lower = userMsg.toLowerCase().trim();

      if (lower.includes('trend') || lower.includes('generate post') || lower.startsWith('post about')) {
        if (!xAccessToken) return "Connect your X account first ‚Üí Menu ‚Üí Connect X";
        addMessage("Analyzing your timeline...", 'ai');

        try {
          const feed = await fetch(`https://api.twitter.com/2/users/me/timelines/reverse_chronological?tweet.fields=public_metrics&max_results=100`, {
            headers: { Authorization: `Bearer ${xAccessToken}` }
          }).then(r => r.json());

          const hot = extractHotKeywords(feed.data);
          const prompt = `You are TrendSpotter inside Vynix AI. 
Hot topics from user's timeline: ${hot.join(', ')}
Request: "${userMsg}"
Write ONE viral X post under 280 characters with hook, emojis, and CTA.
End with: "Powered by @vynix_ai ‚ù§Ô∏è"`;

          const res = await fetch(xaiEndpoint, {
            method: "POST",
            headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" },
            body: JSON.stringify({ model: "grok-4", messages: [{role:"user", content:prompt}], temperature: 0.92 })
          });
          const result = await res.json();
          chatPane.lastElementChild.remove();
          return result.choices[0].message.content;
        } catch (e) {
          chatPane.lastElementChild.remove();
          return "Trend scan failed. Try again!";
        }
      }

      // Regular chat
      if (!xaiApiKey) return "Vynix AI is waking up‚Ä¶";
      const msgs = [{ role: "system", content: SYSTEM_PROMPT }];
      hist.slice(-20).forEach(m => msgs.push({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text }));
      msgs.push({ role: "user", content: userMsg });

      const inputTokens = estimateTokens(msgs.map(m => m.content).join('\n'));
      if (todayTokensUsed + inputTokens > DAILY_TOKEN_LIMIT) return "Daily limit reached! Back tomorrow ‚ù§Ô∏è";

      try {
        const res = await fetch(xaiEndpoint, { method: "POST", headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: "grok-3", messages: msgs, temperature: 0.8 }) });
        const data = await res.json();
        const reply = data.choices[0].message.content.trim();
        await addUsage(inputTokens, estimateTokens(reply));
        return reply;
      } catch (e) { console.error(e); return "Oops! Try again? üòÖ"; }
    }

    // ==================== Rest of your original (cleaned & working) ====================
    function renderMarkdown(text) {
      let html = marked.parse(text);
      return html.replace(/<pre><code class="language-([\w-]+)">([\s\S]*?)<\/code><\/pre>/g,
        '<pre><code class="language-$1">$2</code><button class="code-copy-btn">Copy</button></pre>');
    }

    async function typeText(text, el) {
      el.innerHTML = '';
      for (let i = 0; i < text.length; i += 8) {
        el.innerHTML += text.substring(i, i + 8);
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        await new Promise(r => setTimeout(r, 10 + Math.random() * 15));
      }
      el.innerHTML = renderMarkdown(text);
      Prism.highlightAllUnder(el.parentElement);
      el.parentElement.querySelectorAll('.code-copy-btn').forEach(btn => {
        btn.onclick = () => { navigator.clipboard.writeText(btn.previousElementSibling.textContent); btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500); };
      });
    }

    function addMessage(text, sender, ts = Date.now(), isNew = false) {
      const wrap = document.createElement('div'); wrap.className = `message ${sender}`;
      const content = document.createElement('div'); content.className = 'content';
      const time = document.createElement('div'); time.className = `message-time ${sender}`;
      time.textContent = new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      wrap.appendChild(content); wrap.appendChild(time);
      chatPane.appendChild(wrap); chatPane.scrollTop = chatPane.scrollHeight;
      if (isNew) typeText(text, content);
      else content.innerHTML = sender === 'ai' ? renderMarkdown(text) : text.replace(/\n/g, '<br>');
      return wrap;
    }

    function toast(msg, dur = 3000) {
      const t = document.getElementById('toast') || document.createElement('div');
      t.id = 'toast'; t.textContent = msg; t.className = 'show';
      document.body.appendChild(t);
      setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, dur);
    }

    function estimateTokens(t) { return Math.ceil(t.length / 3.8); }
    async function addUsage(i, o) {
      todayTokensUsed += i + o;
      const today = new Date().toISOString().slice(0, 10);
      await set(ref(db, `usage/\( {userId}/ \){today}`), todayTokensUsed);
    }

    // ==================== Chat Logic ====================
    let currentConvId = null, history = [], conversations = {};

    async function send() {
      const text = chatInput.value.trim();
      if (!text) return;
      if (!currentConvId) startNewConversation();
      addMessage(text, 'user'); saveMessage(text, 'user');
      history.push({ sender: 'user', text });
      chatInput.value = '';
      addMessage('Thinking...', 'ai');
      const reply = await getReply(text, history);
      chatPane.lastElementChild.remove();
      addMessage(reply, 'ai', Date.now(), true);
      history.push({ sender: 'ai', text: reply });
      saveMessage(reply, 'ai');
    }

    function startNewConversation() {
      history = []; chatPane.innerHTML = ''; document.getElementById('welcome').classList.add('hidden');
      const r = push(ref(db, `users/${userId}/conversations`));
      currentConvId = r.key;
      set(r, { createdAt: Date.now(), title: 'New Chat' });
    }

    function saveMessage(text, sender) {
      if (!currentConvId) return;
      push(ref(db, `users/\( {userId}/conversations/ \){currentConvId}/messages`), { text, sender, timestamp: Date.now() });
    }

    // ==================== Init ====================
    const chatPane = document.getElementById('chatPane');
    const welcome = document.getElementById('welcome');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const newConvBtn = document.getElementById('newConvBtn');

    sendBtn.onclick = send;
    chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') send(); });
    menuBtn.onclick = () => { sidebar.classList.add('open'); overlay.classList.add('on'); };
    overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('on'); };
    newConvBtn.onclick = () => { overlay.onclick(); startNewConversation(); };

    onAuthStateChanged(auth, async user => {
      if (!user) { signInAnonymously(auth); return; }
      userId = user.uid;
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiApiKey = getString(rc, 'xai_api_key').trim();
      if (xaiApiKey) statusDot.classList.add('connected');

      const xSnap = await get(ref(db, `users/${userId}/x`));
      if (xSnap.val()) {
        xAccessToken = xSnap.val().token;
        xUsername = xSnap.val().username;
        document.getElementById('xBtnText').textContent = `@${xUsername} connected`;
        document.getElementById('connectXBtn').style.background = '#1DA1F2';
      }

      onValue(ref(db, `users/${userId}/conversations`), snap => {
        conversations = snap.val() || {};
        // render sidebar logic omitted for brevity ‚Äî your original works fine
      });
    });
  </script>
</body>
</html>
