<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Vynix%20Buddy%22,%22short_name%22:%22Vynix%22,%22description%22:%22Your%20CAPS%20AI%20Tutor%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512%22,%22sizes%22:%22512x512%22}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    textarea,input,.content{-webkit-user-select:text;user-select:text}
    body{font-family:'Inter',sans-serif;background:#fff;color:#111827;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 140px;-webkit-overflow-scrolling:touch}
    .message{margin:1.5rem 0;position:relative}
    .message.ai .content{background:#f8f9fa;border:1px solid #e9ecef;border-radius:1rem;padding:1rem 1.2rem;max-width:88%}
    .message.user .content{background:#9ca3af;color:#111827;border-radius:1rem;padding:1rem 1.2rem;margin-left:auto;max-width:85%;white-space:pre-wrap;word-break:break-word}
    .timestamp{font-size:.75rem;color:#6b7280;margin-top:4px}
    .message.ai .timestamp{margin-left:8px}
    .message.user .timestamp{margin-right:8px;text-align:right}
    .ai-actions{display:flex;gap:10px;margin-top:8px;margin-left:8px;opacity:.9;flex-wrap:wrap}
    .action-btn{width:38px;height:38px;background:#f1f3f4;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
    .action-btn:hover{background:#e0e0e0;transform:scale(1.12)}
    .thinking{display:flex;gap:8px;padding:1rem 1.2rem}
    .dot{width:10px;height:10px;background:#8b5cf6;border-radius:50%;animation:pulse 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;padding:.75rem;padding-bottom:calc(.75rem + env(safe-area-inset-bottom));background:#fff;border-top:1px solid #e5e7eb;box-shadow:0 -4px 20px rgba(0,0,0,.08);z-index:z-index:100}
    .input-container{background:#f9fafb;border:1px solid #d1d5db;border-radius:1.5rem;padding:.75rem 1rem;display:flex;align-items:flex-end;gap:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .input-container:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.15)}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1rem;resize:none;max-height:120px;line-height:1.5}
    .send-btn{width:44px;height:44px;border-radius:50%;background:#8b5cf6;display:flex;align-items:center;justify-content:center}
    .send-btn:disabled{background:#9ca3af}
    .upload-btn{width:44px;height:44px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
    .token-bar{position:fixed;top:0;left:0;right:0;background:#8b5cf6;color:#fff;padding:.6rem 1rem;font-size:.9rem;text-align:center;z-index:50;display:flex;align-items:center;justify-content:center;gap:.5rem}
    #customAlert{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-150%);background:linear-gradient(135deg,#8b5cf6 0%,#ec4899 100%);color:#fff;padding:1rem 1.5rem;border-radius:9999px;font-weight:600;box-shadow:0 10px 25px rgba(0,0,0,.25);z-index:9999;transition:transform .3s ease}
    #customAlert.show{transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>

  <div class="token-bar">
    <span id="tokenCount">15,000</span> tokens left today
    <button id="upgradePill" class="ml-3 px-4 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold text-sm rounded-full border border-white/40 transition active:scale-95">Upgrade</button>
  </div>

  <section id="chatPane">
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" disabled><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <div id="customAlert" role="alert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    let userProfile = null;
    let xaiKey = null;
    let history = [];
    let currentImage = null;
    let dailyTokens = 15000;
    let isPremium = false;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradePill: document.getElementById('upgradePill')
    };

    function customAlert(msg, duration = 2800) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }

    function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }
    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { 
        document.getElementById('upgradeSheet')?.classList.add('active');
        return false;
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        if (userSnap.val()?.premium) {
          isPremium = true; dailyTokens = 999999;
          document.querySelector('.token-bar').innerHTML = `Unlimited • Premium`;
          return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val(); const now = Date.now(); const oneDay = 24*60*60*1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000;
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { els.tokenCount.textContent = dailyTokens.toLocaleString(); }
    }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      const time = formatTime();

      if (sender === 'ai' && !isImage) {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn"><i data-lucide="download"></i></button>
            <button class="action-btn exam-btn"><i data-lucide="file-text" class="text-purple-700"></i></button>
          </div>
          <div class="timestamp">${time}</div>`;
      } else {
        div.innerHTML = `<div class="content">\( {isImage ? content : content.replace(/\n/g, '<br>')}</div><div class="timestamp"> \){time}</div>`;
      }

      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons({ attrs: { width: 19, height: 19 } });

      if (sender === 'ai' && !isImage) {
        // Copy
        div.querySelector('.copy-btn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plainText || content.replace(/[#*`>]/g,''));
          const i = div.querySelector('.copy-btn i');
          i.setAttribute('data-lucide', 'check'); lucide.createIcons();
          setTimeout(() => { i.setAttribute('data-lucide', 'copy'); lucide.createIcons(); }, 2000);
        });

        // Voice (unchanged for brevity)
        div.querySelector('.voice-btn')?.addEventListener('click', () => customAlert("Voice coming soon!"));

        // Download current answer as PDF
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy", 20, 20);
          doc.setFontSize(11);
          doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_Answer_${new Date().toISOString().slice(0,10)}.pdf`);
        });

        // MAIN FEATURE: Past Papers + AI Exam Generator
        div.querySelector('.exam-btn')?.addEventListener('click', async () => {
          const btn = div.querySelector('.exam-btn i');
          const original = btn.getAttribute('data-lucide');
          btn.setAttribute('data-lucide', 'loader-2');
          lucide.createIcons();

          const grade = userProfile?.grade || "12";
          const name = userProfile?.name || "champ";

          // Smart subject from recent chat
          let subject = "";
          const recent = history.slice(-10).map(m => m.content.toLowerCase()).join(" ");
          const map = {
            "math|wisk": "Mathematics", "physical|physics|chem": "Physical Sciences",
            "life|bio": "Life Sciences", "account": "Accounting", "business": "Business Studies",
            "econ": "Economics", "geog": "Geography", "hist": "History", "english": "English HL",
            "afri": "Afrikaans HL", "zul": "isiZulu HL", "cat": "CAT", "it ": "IT"
          };
          for (const [k, v] of Object.entries(map)) if (new RegExp(k).test(recent)) { subject = v; break; }

          if (!subject) subject = prompt(`Sawubona \( {name}! Which Grade \){grade} subject?`, "Mathematics");

          const pastPapersDB = {
            "Mathematics": { "P1": ["https://www.education.gov.za/Portals/0/CD/National%20Curriculum%20Statements%20and%20Vocational/2024%20Nov%20NSC%20Exams/Mathematics%20P1%20Eng.pdf?ver=...", "https://www.education.gov.za/Portals/0/CD/.../Mathematics%20P1%20Memo.pdf"], "P2": ["...P2%20Eng.pdf", "...P2%20Memo.pdf"] },
            "Physical Sciences": { "P1": ["https://www.education.gov.za/.../Physical%20Sciences%20P1%20Eng.pdf", "memo"], "P2": ["P2", "memo"] },
            "Life Sciences": { "P1": ["https://www.education.gov.za/.../Life%20Sciences%20P1%20Eng.pdf", "memo"], "P2": ["P2", "memo"] },
            "Accounting": { "": ["https://www.education.gov.za/.../Accounting%20Eng.pdf", "memo"] }
            // Add more anytime
          };

          if (pastPapersDB[subject]) {
            let msg = `**\( {subject} Grade \){grade} Official NSC Past Papers**\n\n`;
            Object.keys(pastPapersDB[subject]).forEach((p, i) => {
              const [qp, memo] = pastPapersDB[subject][p];
              const n = p ? \`Paper ${p}\` : "Paper";
              msg += \`\( {i+1}. \){n}\n   [Question Paper](\( {qp})\n   [Memorandum]( \){memo})\n\n\`;
            });
            msg += `_Click links to download real Matric finals!_`;
            addMessage(msg, 'ai');
            customAlert("Real past papers ready!");
          } else {
            // Generate full AI exam instead
            const marks = subject.includes("Math") || subject.includes("Physical") ? 150 : 100;
            const paper = subject.includes("Math") || subject.includes("Physical") ? confirm("Paper 1 or 2? Cancel = P1") ? "2" : "1" : "";
            const prompt = `Generate a COMPLETE full-length CAPS \( {subject} Grade \){grade} \( {paper ? "Paper "+paper : ""} exam worth \){marks} marks with FULL memorandum. Never shorten. Use ---MEMO--- to separate. Clean Markdown.`;
            addThinking();
            const res = await fetch("https://api.x.ai/v1/chat/completions", { method: "POST", headers: { "Authorization": \`Bearer ${xaiKey}\`, "Content-Type": "application/json" }, body: JSON.stringify({ model: "grok-3", messages: [{role:"user",content:prompt}], temperature: 0.8, max_tokens: 8000 })});
            const data = await res.json();
            const full = data.choices[0].message.content;
            const [qp, memo] = full.split('---MEMO---');
            const doc = new jsPDF();
            doc.text(\`\( {subject} Grade \){grade} Exam\`, 105, 20, {align:"center"});
            doc.setFontSize(11); doc.text(doc.splitTextToSize(qp||full, 180), 15, 40);
            doc.addPage(); doc.text("MEMORANDUM", 105, 20, {align:"center"}); doc.text(doc.splitTextToSize(memo||"", 180), 15, 40);
            doc.save(\`CAPS_\( {subject.replace(/ /g,"_")}_Gr \){grade}\${paper?"_P"+paper:""}.pdf\`);
            removeThinking();
            customAlert("Full exam paper downloaded!");
          }

          btn.setAttribute('data-lucide', original);
          lucide.createIcons();
        });
      }
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking'; d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d); els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      if (!(await deductTokens(estimateTokens(text)))) return addMessage("Out of tokens! Upgrade for unlimited", 'ai');

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full">`, 'user');
        history.push({ role: "user", content: currentImage });
        text = "Explain this image";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null; els.sendBtn.disabled = true;
      addThinking();
      const reply = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": \`Bearer ${xaiKey}\`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "grok-3",
          messages: [{ role: "system", content: \`You are Vynix Buddy, a warm CAPS tutor for \( {userProfile?.name || "a learner"} in Grade \){userProfile?.grade}\` }, ...history.slice(-15), { role: "user", content: text }],
          temperature: 0.7
        })
      }).then(r => r.json()).then(d => d.choices?.[0]?.message?.content || "Thinking...");
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }});

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = "login.html";
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      await loadTokens();
      const snap = await get(child(ref(db), \`users/${user.uid}/profile\`));
      userProfile = snap.val() || {};
      if (!userProfile.name) addMessage("Sawubona! I'm Vynix Buddy. What's your name?", 'ai');
      else addMessage(\`Welcome back, \( {userProfile.name || "champ"}! Ready for Grade \){userProfile.grade}?\`, 'ai');
    });
  </script>
</body>
</html>
