<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Vynix Buddy&quot;,&quot;short_name&quot;:&quot;Vynix&quot;,&quot;description&quot;:&quot;Your CAPS AI Tutor&quot;,
    &quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#8b5cf6&quot;,
    &quot;icons&quot;:[ {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;} ]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    textarea,input,.content,.selectable{-webkit-user-select:text;user-select:text}
    body{font-family:'Inter',sans-serif;background:#faf8ff;color:#1f1f1f;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

    .token-bar{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;padding:0.75rem 1rem;padding-top:calc(0.75rem + env(safe-area-inset-top));font-size:0.95rem;z-index:50;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(139,92,246,0.25);}
    #upgradePill{margin-left:12px;padding:6px 16px;background:#fff3;border:1px solid #fff4;border-radius:50px;font-weight:600;transition:all .2s;}
    #upgradePill:active{transform:scale(0.94)}

    #profileBtn{display:flex;align-items:center;gap:10px;padding:4px 8px 4px 4px;border-radius:50px;transition:all .2s;}
    #profileBtn:hover{background:#fff2}
    #profileDropdown{position:absolute;right:8px;top:100%;margin-top:8px;width:280px;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.18);overflow:hidden;opacity:0;pointer-events:none;transform:translateY(-12px);transition:all .25s cubic-bezier(0.32,0.72,0,1);z-index:999;}
    #profileDropdown.show{opacity:1;pointer-events:auto;transform:translateY(0);}

    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 160px;-webkit-overflow-scrolling:touch;}
    .message{margin:1.2rem 0;display:flex;flex-direction:column;align-items:flex-start;animation:fadeIn 0.4s ease-out forwards;width:100%;}
    .message.user{align-items:flex-end;}
    .message .content{max-width:100%;width:100%;padding:14px 18px;border-radius:24px;line-height:1.55;font-size:1.02rem;position:relative;word-wrap:break-word;box-shadow:0 3px 10px rgba(0,0,0,0.09);}
    .message.ai .content{background:linear-gradient(135deg,#f8f6ff 0%,#f0e8ff 100%);border:1px solid #e0d6ff;border-bottom-left-radius:6px;color:#312069;}
    .message.user .content{background:#fff;border:1.8px solid #c4b5fd;border-bottom-right-radius:6px;color:#1f1f1f;font-weight:500;}
    .message.ai .content::before,.message.user .content::before{content:'';position:absolute;bottom:0;width:0;height:0;border:11px solid transparent;}
    .message.ai .content::before{left:-11px;border-right-color:#e0d6ff;}
    .message.user .content::before{right:-11px;border-left-color:#c4b5fd;}
    .timestamp{font-size:0.75rem;color:#9ca3af;margin-top:6px;opacity:0.85;}
    .message.ai .timestamp{margin-left:18px;}
    .message.user .timestamp{margin-right:18px;text-align:right;}

    .ai-actions{display:flex;gap:12px;padding:8px 18px 0 18px;justify-content:flex-start;}
    .action-btn{width:40px;height:40px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.14);transition:all .22s;cursor:pointer;}
    .action-btn:hover{transform:translateY(-4px) scale(1.1);box-shadow:0 10px 25px rgba(139,92,246,0.3);}

    .thinking{display:flex;gap:9px;padding:16px 20px;}
    .dot{width:11px;height:11px;background:#a78bfa;border-radius:50%;animation:pulse 1.5s infinite;}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}

    .input-bar{position:fixed;bottom:0;left:0;right:0;padding:0.75rem;padding-bottom:calc(0.75rem + env(safe-area-inset-bottom));background:#fff;border-top:1px solid #e2e8f0;box-shadow:0 -6px 30px rgba(0,0,0,0.1);z-index:100;}
    .input-container{background:#f8fafc;border:2px solid #e2e8f0;border-radius:28px;padding:10px 16px;display:flex;align-items:center;gap:12px;transition:all .2s;}
    .input-container:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 4px rgba(139,92,246,0.18);background:#fff;}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1.05rem;resize:none;max-height:140px;line-height:1.5;}
    .send-btn,.upload-btn,.voice-btn{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s;cursor:pointer;}
    .send-btn{background:#8b5cf6;color:#fff;box-shadow:0 4px 15px rgba(139,92,246,0.4);}
    .send-btn:disabled{background:#cbd5e1;cursor:not-allowed;}
    .upload-btn,.voice-btn{background:#e2e8f0;}
    .voice-btn.recording{background:#ef4444;animation:pulseRed 1.5s infinite;}
    @keyframes pulseRed{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.7)}70%{box-shadow:0 0 0 10px rgba(239,68,68,0)}}

    #convoSidebar{position:fixed;left:0;top:0;height:100%;width:320px;background:#fff;box-shadow:2px 0 20px rgba(0,0,0,0.15);z-index:50;transform:translateX(-100%);transition:transform .3s ease;}
    #convoSidebar.open{transform:translateX(0);}
    #sidebarOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;}
    #sidebarOverlay.active{opacity:1;pointer-events:auto;}
    .convo-item{padding:1rem 1.25rem;border-bottom:1px solid #f1f5f9;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;}
    .convo-item:hover{background:#f8f6ff;}
    .convo-item.active{background:linear-gradient(135deg,#f3e8ff,#e0d6ff);font-weight:600;}
    .convo-item .title{flex:1;font-size:0.95rem;color:#1f1f1f;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .convo-item .timestamp{font-size:0.75rem;color:#94a3b8;opacity:0;transition:opacity .2s;}
    .convo-item:hover .timestamp,.convo-item:hover .delete-btn{opacity:1;}
    .convo-item .delete-btn{opacity:0;transition:opacity .2s;}
    .convo-item .delete-btn:hover{color:#ef4444;}

    #customAlert{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120%);background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;padding:14px 28px;border-radius:9999px;font-weight:700;box-shadow:0 12px 30px rgba(0,0,0,0.25);z-index:9999;transition:transform .35s ease;}
    #customAlert.show{transform:translateX(-50%) translateY(0);}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay"></div>

  <!-- Conversations Sidebar -->
  <aside id="convoSidebar">
    <div class="flex items-center justify-between p-5 border-b border-gray-200">
      <h2 class="text-xl font-bold text-purple-600">Your Chats</h2>
      <button id="closeSidebar"><i data-lucide="x" class="w-7 h-7"></i></button>
    </div>
    <div class="p-4 border-b border-gray-100">
      <button id="newChatBtn" class="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold py-3 rounded-xl hover:scale-105 active:scale-95 transition">
        <i data-lucide="plus"></i> New Chat
      </button>
    </div>
    <div id="conversationsList" class="overflow-y-auto h-full pb-20">
      <div class="p-8 text-center text-gray-500">Loading chats...</div>
    </div>
  </aside>

  <!-- Mobile Menu Button -->
  <button id="openSidebarMobile" class="fixed bottom-20 left-4 bg-purple-600 text-white p-4 rounded-full shadow-2xl z-40 hover:bg-purple-700 md:hidden">
    <i data-lucide="menu" class="w-6 h-6"></i>
  </button>

  <!-- Desktop Toggle -->
  <div class="hidden md:flex fixed left-0 top-1/2 -translate-y-1/2 bg-white rounded-r-2xl shadow-2xl p-3 z-40 transition-all" id="desktopSidebarToggle">
    <button class="text-purple-600"><i data-lucide="messages-square" class="w-8 h-8"></i></button>
  </div>

  <!-- Token Bar -->
  <div class="token-bar">
    <div class="flex items-center gap-2">
      <span id="tokenCount">15,000</span> tokens left
      <button id="upgradePill">Upgrade</button>
    </div>
    <div class="relative">
      <button id="profileBtn" class="flex items-center gap-3 px-3 py-1.5 rounded-full hover:bg-white/10 transition">
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-sm">
          <span id="userInitial">U</span>
        </div>
        <div class="text-left hidden sm:block">
          <div id="userName" class="text-white font-medium text-sm">Loading...</div>
          <div id="userGrade" class="text-white/70 text-xs">Grade —</div>
        </div>
        <i data-lucide="chevron-down" class="w-4 h-4 text-white/70"></i>
      </button>
      <div id="profileDropdown">
        <div class="p-4 border-b border-gray-100">
          <div class="font-bold text-gray-900" id="dropdownName">User</div>
          <div class="text-sm text-gray-500" id="dropdownGrade">Grade —</div>
        </div>
        <button id="signOutBtn" class="w-full px-5 py-3.5 text-left text-red-600 font-medium hover:bg-red-50 transition flex items-center gap-3">
          <i data-lucide="log-out"></i> Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <section id="chatPane">
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <!-- Input Bar -->
  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*,.pdf" hidden>
      <img id="filePreview" alt="Preview" style="display:none;width:42px;height:42px;border-radius:12px;">
      <button class="voice-btn" id="voiceBtn"><i data-lucide="mic" class="w-6 h-6"></i></button>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" disabled><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <div id="customAlert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let history = [];
    let currentImage = null;
    let currentConvoId = null;
    let recognition = null;
    let isRecording = false;
    let dailyTokens = 15000;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      voiceBtn: document.getElementById('voiceBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      filePreview: document.getElementById('filePreview'),
      tokenCount: document.getElementById('tokenCount'),
      conversationsList: document.getElementById('conversationsList')
    };

    // === VOICE INPUT ===
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.lang = 'en-ZA';

      recognition.onresult = (e) => {
        const transcript = Array.from(e.results)
          .map(r => r[0].transcript)
          .join('');
        els.chatInput.value = transcript;
      };

      recognition.onerror = () => {
        isRecording = false;
        els.voiceBtn.classList.remove('recording');
        customAlert("Voice input failed. Try again.");
      };

      recognition.onend = () => {
        isRecording = false;
        els.voiceBtn.classList.remove('recording');
      };
    }

    els.voiceBtn.onclick = () => {
      if (!recognition) {
        customAlert("Voice input not supported");
        return;
      }
      if (isRecording) {
        recognition.stop();
      } else {
        recognition.start();
        isRecording = true;
        els.voiceBtn.classList.add('recording');
        customAlert("Listening...");
      }
    };

    // === VOICE OUTPUT ===
    async function speakText(text) {
      if (!elevenlabsKey || !text.trim()) return;
      try {
        const res = await fetch("https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB", {
          method: "POST",
          headers: { "xi-api-key": elevenlabsKey, "Content-Type": "application/json" },
          body: JSON.stringify({ text, model_id: "eleven_monolingual_v1" })
        });
        if (res.ok) {
          const blob = await res.blob();
          const audio = new Audio(URL.createObjectURL(blob));
          audio.play();
        }
      } catch (e) { console.log("Voice failed"); }
    }

    // === CORE FUNCTIONS ===
    function customAlert(msg, duration = 2500) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const time = new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });

      if (sender === 'ai') {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn"><i data-lucide="download"></i></button>
          </div>
          <div class="timestamp">${time}</div>`;
        div.querySelector('.voice-btn').onclick = () => speakText(plainText || content);
        div.querySelector('.copy-btn').onclick = () => {
          navigator.clipboard.writeText(plainText || content);
          customAlert("Copied!");
        };
        div.querySelector('.pdf-btn').onclick = () => {
          const doc = new jsPDF();
          doc.text("Vynix Buddy Answer", 20, 20);
          doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save("answer.pdf");
        };
      } else {
        div.innerHTML = `<div class="content">${content.replace(/\n/g, '<br>')}</div><div class="timestamp">${time}</div>`;
      }

      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    function removeThinking() {
      document.getElementById('thinking')?.remove();
    }

    async function deductTokens(cost) {
      if (dailyTokens < cost) {
        customAlert("Out of tokens! Upgrade for unlimited.");
        return false;
      }
      dailyTokens -= cost;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      return true;
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting...";
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [{ role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        return "No internet connection.";
      }
    }

    async function saveMessage(userMsg, aiReply = null) {
      if (!auth.currentUser) return;
      let convoRef;
      if (!currentConvoId) {
        convoRef = push(ref(db, `users/${auth.currentUser.uid}/conversations`));
        currentConvoId = convoRef.key;
        await set(convoRef, {
          title: userMsg.slice(0, 40) + (userMsg.length > 40 ? '...' : ''),
          createdAt: Date.now(),
          lastMessageAt: Date.now()
        });
      } else {
        convoRef = ref(db, `users/${auth.currentUser.uid}/conversations/${currentConvoId}`);
        await set(child(convoRef, 'lastMessageAt'), Date.now());
      }
      const messagesRef = child(convoRef, 'messages');
      await push(messagesRef, { role: 'user', content: userMsg, timestamp: Date.now() });
      if (aiReply) await push(messagesRef, { role: 'assistant', content: aiReply, timestamp: Date.now() });
    }

    async function loadConversationHistory(convoId) {
      const snap = await get(ref(db, `users/${auth.currentUser.uid}/conversations/${convoId}/messages`));
      const messages = snap.val();
      els.chatPane.innerHTML = '';
      history = messages ? Object.values(messages) : [];
      history.forEach(msg => {
        const isUser = msg.role === 'user';
        addMessage(isUser ? msg.content : marked.parse(msg.content), isUser ? 'user' : 'ai', isUser ? '' : msg.content);
      });
    }

    function loadConversations() {
      if (!auth.currentUser) return;
      const convosRef = ref(db, `users/${auth.currentUser.uid}/conversations`);
      onValue(convosRef, (snapshot) => {
        const data = snapshot.val() || {};
        const convos = Object.keys(data).map(key => ({
          id: key,
          ...data[key],
          time: new Date(data[key].lastMessageAt || data[key].createdAt).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })
        })).sort((a, b) => (b.lastMessageAt || b.createdAt) - (a.lastMessageAt || a.createdAt));

        if (convos.length === 0) {
          els.conversationsList.innerHTML = `<div class="p-8 text-center text-gray-500">No chats yet. Start a new one!</div>`;
          return;
        }

        els.conversationsList.innerHTML = convos.map(c => `
          <div class="convo-item ${c.id === currentConvoId ? 'active' : ''}" data-id="${c.id}">
            <i data-lucide="message-square" class="w-5 h-5 text-purple-500"></i>
            <div class="title">${c.title || 'New Chat'}</div>
            <div class="timestamp">${c.time}</div>
            <button class="delete-btn"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
          </div>
        `).join('');

        lucide.createIcons();

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.onclick = async (e) => {
            e.stopPropagation();
            const id = btn.closest('.convo-item').dataset.id;
            if (confirm('Delete this chat permanently?')) {
              await remove(ref(db, `users/${auth.currentUser.uid}/conversations/${id}`));
              if (currentConvoId === id) startNewChat();
            }
          };
        });

        document.querySelectorAll('.convo-item').forEach(item => {
          item.onclick = async (e) => {
            if (e.target.closest('.delete-btn')) return;
            currentConvoId = item.dataset.id;
            await loadConversationHistory(currentConvoId);
            document.querySelectorAll('.convo-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            closeSidebar();
          };
        });
      });
    }

    function startNewChat() {
      els.chatPane.innerHTML = `<div class="text-center mt-28 text-gray-600 px-4">
        <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
        <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
      </div>`;
      history = [];
      currentConvoId = null;
      customAlert("New chat started!");
    }
    document.getElementById('newChatBtn').onclick = () => { startNewChat(); closeSidebar(); };

    // === SEND MESSAGE ===
    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;

      const cost = currentImage ? 1500 : Math.ceil(text.length / 4) + 150;
      if (!(await deductTokens(cost))) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full">`, 'user');
        text = text || "Explain this image";
      } else {
        addMessage(text, 'user');
      }

      await saveMessage(text);
      els.chatInput.value = '';
      currentImage = null;
      els.filePreview.style.display = 'none';
      addThinking();

      const reply = await getReply(text);
      removeThinking();
      addMessage(reply, 'ai', reply);
      await saveMessage(text, reply);
      speakText(reply);
    }

    // === SIDEBAR ===
    const sidebar = document.getElementById('convoSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const openMobile = document.getElementById('openSidebarMobile');
    const closeBtn = document.getElementById('closeSidebar');
    const desktopToggle = document.getElementById('desktopSidebarToggle');

    function openSidebar() { sidebar.classList.add('open'); overlay.classList.add('active'); }
    function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('active'); }
    openMobile.onclick = openSidebar;
    closeBtn.onclick = overlay.onclick = closeSidebar;
    desktopToggle.onclick = () => sidebar.classList.toggle('open');

    // === PROFILE DROPDOWN ===
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    profileBtn.onclick = e => { e.stopPropagation(); profileDropdown.classList.toggle('show'); };
    document.addEventListener('click', e => {
      if (!profileBtn.contains(e.target)) profileDropdown.classList.remove('show');
    });
    document.getElementById('signOutBtn').onclick = () => confirm('Sign out?') && signOut(auth);

    // === INIT ===
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key');
      elevenlabsKey = getString(rc, 'elevenlabs_api_key');
      loadConversations();
    });

    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
