<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: var(--bg); 
      color: var(--text-secondary); 
      min-height: 100vh; 
      margin: 0; 
    }
    .tab-container { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      padding: 0.75rem 1rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 0.5rem; 
      z-index: 10; 
      background: var(--bg); 
      border-bottom: 1px solid var(--border); 
    }
    .tab { 
      background: var(--card-bg); 
      color: var(--text-primary); 
      border: 1px solid var(--border); 
      padding: 0.5rem 1rem; 
      border-radius: 9999px; 
      cursor: pointer; 
      transition: background 0.3s; 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      font-size: 0.875rem; 
      text-decoration: none; 
    }
    .tab:hover, .tab.active { background: var(--highlight); }
    .tab svg { width: 1rem; height: 1rem; stroke: var(--text-primary); }
    .welcome-container { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      text-align: center; 
      margin-top: 3rem; 
    }
    .welcome-container h1 { font-size: 1.25rem; font-weight: 600; color: #1E1E1E; }
    .hidden { display: none; }
    .chat-input-container { 
      position: fixed; 
      bottom: 1rem; 
      left: 50%; 
      transform: translateX(-50%); 
      display: flex; 
      align-items: flex-start; 
      width: 90%; 
      max-width: 600px; 
      background: var(--card-bg); 
      border-radius: 1.5rem; 
      padding: 0.5rem 0.75rem; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
      gap: 0.5rem; 
    }
    .input-wrapper { flex: 1; display: flex; flex-direction: column; gap: 0.25rem; }
    #chat-input { 
      background: transparent; 
      color: var(--text-primary); 
      border: none; 
      padding: 0.75rem 0.5rem; 
      outline: none; 
      font-size: 1rem; 
    }
    #input-model-info { 
      color: rgba(255, 255, 255, 0.6); 
      font-size: 0.75rem; 
      text-align: center; 
      min-height: 1rem; 
    }
    #send-button { 
      background: transparent; 
      border: none; 
      padding: 0.5rem; 
      cursor: pointer; 
      border-radius: 0.5rem; 
      transition: background 0.2s; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    #send-button:hover { background: rgba(255, 255, 255, 0.1); }
    #send-button svg { width: 1.5rem; height: 1.5rem; stroke: var(--text-primary); }
    #chat-messages { 
      margin: 5rem 1rem 6rem 1rem; 
      padding: 1rem; 
      overflow-y: auto; 
      max-height: calc(100vh - 11rem); 
      -webkit-overflow-scrolling: touch; 
    }
    .message { 
      max-width: 70%; 
      padding: 0.75rem 1.25rem; 
      border-radius: 1.5rem; 
      margin: 0.5rem 1rem; 
      word-wrap: break-word; 
      box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
      animation: slideIn 0.3s ease-out; 
      position: relative; 
      display: inline-block; 
    }
    .message.user { 
      background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE); 
      color: #1E1E1E; 
      margin-left: auto; 
      border-bottom-right-radius: 0.25rem; 
    }
    .message.ai { 
      background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748); 
      color: var(--text-primary); 
      margin-right: auto; 
      border-bottom-left-radius: 0.25rem; 
    }
    .message-time { 
      font-size: 0.65rem; 
      opacity: 0.6; 
      margin-top: 0.35rem; 
      text-align: right; 
    }
    .message-time.ai { text-align: left; }
    .sidebar { 
      position: fixed; 
      top: 0; 
      left: -100%; 
      width: 280px; 
      height: 100vh; 
      background: white; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
      transition: left 0.3s ease; 
      z-index: 40; 
      overflow-y: auto; 
    }
    .sidebar.open { left: 0; }
    .sidebar-header { 
      padding: 1.5rem; 
      background: #1C2526; 
      color: white; 
      text-align: center; 
    }
    .conv-item { 
      padding: 1rem 1.5rem; 
      border-bottom: 1px solid #eee; 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    .conv-item:hover { background: #f0f0f0; }
    .conv-item.active { background: #e0e7ff; font-weight: 600; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <main class="flex flex-col h-screen">
    <div class="tab-container">
      <button id="menu-btn" class="tab">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>Menu</span>
      </button>
      <div>Vynix AI • Pure Brain</div>
    </div>

    <div class="welcome-container" id="welcome-container">
      <h1>Hey there!</h1>
      <p class="mt-4 text-gray-600">Start chatting — replies are instant</p>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto"></div>

    <div class="chat-input-container">
      <div class="input-wrapper">
        <input type="text" id="chat-input" placeholder="Type a message..." autofocus>
        <div id="input-model-info"><span id="pair-count">Loading...</span> responses</div>
      </div>
      <button id="send-button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M5 12l6-6m-6 6l6 6"/>
        </svg>
      </button>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <h2 class="text-xl font-bold">Conversations</h2>
      </div>
      <button id="new-conv-sidebar" class="w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold">
        + New Conversation
      </button>
      <div id="conv-list" class="mt-4"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const el = {
      messages: document.getElementById('chat-messages'),
      input: document.getElementById('chat-input'),
      send: document.getElementById('send-button'),
      welcome: document.getElementById('welcome-container'),
      menuBtn: document.getElementById('menu-btn'),
      sidebar: document.getElementById('sidebar'),
      convList: document.getElementById('conv-list'),
      newConvSidebar: document.getElementById('new-conv-sidebar'),
      pairCount: document.getElementById('pair-count')
    };

    let pairs = [];
    let conversations = {};
    let currentConvId = null;
    let userId = null;

    // Close sidebar when clicking outside
    document.addEventListener('click', (e) => {
      if (!el.sidebar.contains(e.target) && !el.menuBtn.contains(e.target)) {
        el.sidebar.classList.remove('open');
      }
    });

    el.menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      el.sidebar.classList.toggle('open');
    });

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function addMessage(text, sender, timestamp = Date.now()) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.innerHTML = text.replace(/\n/g, '<br>');
      
      const time = document.createElement('div');
      time.className = `message-time ${sender}`;
      time.textContent = formatTime(timestamp);
      
      div.appendChild(time);
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;
    }

    // Advanced fuzzy matching (Jaro-Winkler)
    function jaroWinkler(a, b) {
      a = a.toLowerCase(); b = b.toLowerCase();
      if (a === b) return 1;
      const lenA = a.length, lenB = b.length;
      if (!lenA || !lenB) return 0;
      const matchWindow = Math.max(0, Math.floor(Math.max(lenA, lenB) / 2) - 1);
      const aMatches = Array(lenA).fill(false);
      const bMatches = Array(lenB).fill(false);
      let matches = 0, transpositions = 0;

      for (let i = 0; i < lenA; i++) {
        const start = Math.max(0, i - matchWindow);
        const end = Math.min(i + matchWindow + 1, lenB);
        for (let j = start; j < end; j++) {
          if (bMatches[j] || a[i] !== b[j]) continue;
          aMatches[i] = bMatches[j] = true;
          matches++; break;
        }
      }
      if (!matches) return 0;
      let k = 0;
      for (let i = 0; i < lenA; i++) if (aMatches[i]) {
        while (!bMatches[k]) k++;
        if (a[i] !== b[k++]) transpositions++;
      }
      const jaro = (matches/lenA + matches/lenB + (matches - transpositions/2)/matches) / 3;
      let prefix = 0;
      for (let i = 0; i < Math.min(4, lenA, lenB); i++) if (a[i] === b[i]) prefix++; else break;
      return jaro + prefix * 0.1 * (1 - jaro);
    }

    function getReply(message) {
      const msg = message.toLowerCase().trim();
      let best = null;
      let bestScore = 0;

      for (const p of pairs) {
        const score = jaroWinkler(msg, p.trigger.toLowerCase().trim());
        if (score > bestScore) {
          bestScore = score;
          best = p.reply;
        }
      }

      if (bestScore >= 0.92) return { reply: best, confidence: Math.round(bestScore * 100), type: "Very Close Match" };
      if (bestScore >= 0.85) return { reply: best, confidence: Math.round(bestScore * 100), type: "Close Match" };
      if (pairs.some(p => msg.includes(p.trigger.toLowerCase().trim()) || p.trigger.toLowerCase().trim().includes(msg))) {
        const partial = pairs.find(p => msg.includes(p.trigger.toLowerCase().trim()) || p.trigger.toLowerCase().trim().includes(msg));
        return { reply: partial.reply, confidence: 75, type: "Partial Match" };
      }

      return { reply: "I don't have a response for that yet.", confidence: 0, type: "No Match" };
    }

    function saveMessage(text, sender) {
      if (!currentConvId) return;
      const convRef = ref(db, `users/${userId}/conversations/${currentConvId}/messages`);
      push(convRef, { text, sender, timestamp: Date.now() });
    }

    function send() {
      const text = el.input.value.trim();
      if (!text) return;

      if (!currentConvId) startNewConversation();

      addMessage(text, 'user');
      saveMessage(text, 'user');
      el.input.value = '';

      setTimeout(() => {
        const result = getReply(text);
        addMessage(result.reply + (result.confidence > 0 ? `\n\n${result.type} • ${result.confidence}%` : ''), 'ai');
        saveMessage(result.reply, 'ai');
      }, 400 + Math.random() * 400);
    }

    function startNewConversation() {
      el.messages.innerHTML = '';
      el.welcome.classList.add('hidden');
      const convRef = push(ref(db, `users/${userId}/conversations`));
      currentConvId = convRef.key;
      set(convRef, { createdAt: Date.now(), title: "New Chat" });
      renderSidebar();
    }

    function loadConversation(id, data) {
      currentConvId = id;
      el.messages.innerHTML = '';
      el.welcome.classList.add('hidden');
      if (data.messages) {
        Object.entries(data.messages)
          .sort(([,a], [,b]) => a.timestamp - b.timestamp)
          .forEach(([, m]) => {
            addMessage(m.text, m.sender === 'user' ? 'user' : 'ai', m.timestamp);
          });
      }
      renderSidebar();
    }

    function renderSidebar() {
      el.convList.innerHTML = '';
      Object.entries(conversations)
        .sort(([,a], [,b]) => b.createdAt - a.createdAt)
        .forEach(([id, conv]) => {
          const div = document.createElement('div');
          div.className = `conv-item ${id === currentConvId ? 'active' : ''}`;
          div.textContent = conv.title || "New Chat";
          div.onclick = () => loadConversation(id, conv);
          el.convList.appendChild(div);
        });
    }

    // Load pairs
    onValue(ref(db, 'pairs'), snap => {
      pairs = [];
      const data = snap.val() || {};
      Object.values(data).forEach(p => {
        if (p.trigger && p.reply) pairs.push({ trigger: p.trigger.trim(), reply: p.reply.trim() });
      });
      el.pairCount.textContent = pairs.length.toLocaleString();
    });

    // Load user conversations
    function loadUserData(uid) {
      userId = uid;
      onValue(ref(db, `users/${uid}/conversations`), snap => {
        conversations = snap.val() || {};
        renderSidebar();
        if (!currentConvId && Object.keys(conversations).length > 0) {
          const latest = Object.entries(conversations)
            .sort(([,a], [,b]) => b.createdAt - a.createdAt)[0];
          loadConversation(latest[0], latest[1]);
        }
      });
    }

    el.newConvSidebar.addEventListener('click', startNewConversation);

    el.send.addEventListener('click', send);
    el.input.addEventListener('keypress', e => e.key === 'Enter' && send());

    onAuthStateChanged(auth, user => {
      if (user) loadUserData(user.uid);
      else signInAnonymously(auth);
    });
  </script>
</body>
</html>
