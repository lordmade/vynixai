<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-secondary); min-height: 100vh; margin: 0; }
    .tab-container { position: fixed; top: 0; left: 0; right: 0; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; z-index: 10; background: var(--bg); border-bottom: 1px solid var(--border); }
    .tab { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 9999px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; text-decoration: none; }
    .tab:hover, .tab.active { background: var(--highlight); }
    .tab svg { width: 1rem; height: 1rem; stroke: var(--text-primary); }
    .welcome-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; margin-top: 3rem; }
    .welcome-container h1 { font-size: 1.25rem; font-weight: 600; color: #1E1E1E; }
    .hidden { display: none; }
    .chat-input-container { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); display: flex; align-items: flex-start; width: 90%; max-width: 600px; background: var(--card-bg); border-radius: 1.5rem; padding: 0.5rem 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 0.5rem; }
    .input-wrapper { flex: 1; display: flex; flex-direction: column; gap: 0.25rem; }
    #chat-input { background: transparent; color: var(--text-primary); border: none; padding: 0.75rem 0.5rem; outline: none; font-size: 1rem; }
    #input-model-info { color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; text-align: center; min-height: 1rem; }
    #send-button { background: transparent; border: none; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem; transition: background 0.2s; display: flex; align-items: center; justify-content: center; }
    #send-button:hover { background: rgba(255, 255, 255, 0.1); }
    #send-button svg { width: 1.5rem; height: 1.5rem; stroke: var(--text-primary); }
    #chat-messages { margin: 5rem 1rem 6rem 1rem; padding: 1rem; overflow-y: auto; max-height: calc(100vh - 11rem); -webkit-overflow-scrolling: touch; }
    .message { max-width: 70%; padding: 0.75rem 1.25rem; border-radius: 1.5rem; margin: 0.5rem 1rem; word-wrap: break-word; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; position: relative; display: inline-block; }
    .message.user { background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE); color: #1E1E1E; margin-left: auto; border-bottom-right-radius: 0.25rem; }
    .message.ai { background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748); color: var(--text-primary); margin-right: auto; border-bottom-left-radius: 0.25rem; }
    .message.processing { background: var(--ai-msg-bg); color: var(--text-primary); font-style: italic; opacity: 0.7; }
    .typing-indicator { display: inline-flex; gap: 0.25rem; align-items: center; }
    .typing-dot { width: 0.5rem; height: 0.5rem; background: var(--text-primary); border-radius: 50%; animation: typing 1.2s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-3px); } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .confidence { font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem; }
    .confidence-exact { color: #10b981; }
    .confidence-fuzzy { color: #8b5cf6; }
    .confidence-partial { color: #f59e0b; }
    .confidence-none { color: #ef4444; }
  </style>
</head>
<body>
  <main class="flex flex-col h-screen">
    <div class="tab-container">
      <div class="flex items-center gap-2">
        <button id="new-conversation-button" class="tab">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 4v8m0 0v8m8-8H4"/></svg>
          <span>New Chat</span>
        </button>
      </div>
      <div class="text-sm font-medium text-gray-600">Vynix AI • Pure Matching Brain</div>
    </div>

    <div class="welcome-container" id="welcome-container">
      <h1>Hey there, friend!</h1>
      <p class="mt-4 text-gray-600">Say anything — I’ll respond instantly using the global community brain!</p>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto"></div>

    <div class="chat-input-container">
      <div class="input-wrapper">
        <input type="text" id="chat-input" placeholder="What's on your mind?" aria-label="Type your message">
        <div id="input-model-info">Global brain: <span id="pair-count">Loading...</span> responses</div>
      </div>
      <button id="send-button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M5 12l6-6m-6 6l6 6"/></svg>
      </button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const elements = {
      chatMessages: document.getElementById('chat-messages'),
      chatInput: document.getElementById('chat-input'),
      sendButton: document.getElementById('send-button'),
      welcomeContainer: document.getElementById('welcome-container'),
      newConversationButton: document.getElementById('new-conversation-button'),
      pairCount: document.getElementById('pair-count')
    };

    let allPairs = [];
    let hasChatted = false;

    // Jaro-Winkler similarity
    function similarity(a, b) {
      a = a.toLowerCase(); b = b.toLowerCase();
      if (a === b) return 1;
      const lenA = a.length, lenB = b.length;
      if (lenA === 0 || lenB === 0) return 0;
      const matchWindow = Math.floor(Math.max(lenA, lenB) / 2) - 1;
      const aMatches = new Array(lenA).fill(false);
      const bMatches = new Array(lenB).fill(false);
      let matches = 0, transpositions = 0;

      for (let i = 0; i < lenA; i++) {
        const start = Math.max(0, i - matchWindow);
        const end = Math.min(i + matchWindow + 1, lenB);
        for (let j = start; j < end; j++) {
          if (bMatches[j] || a[i] !== b[j]) continue;
          aMatches[i] = bMatches[j] = true;
          matches++; break;
        }
      }
      if (matches === 0) return 0;
      let k = 0;
      for (let i = 0; i < lenA; i++) if (aMatches[i]) {
        while (!bMatches[k]) k++;
        if (a[i] !== b[k++]) transpositions++;
      }
      const jaro = (matches/lenA + matches/lenB + (matches - transpositions/2)/matches) / 3;
      let prefix = 0;
      for (let i = 0; i < Math.min(4, lenA, lenB); i++) if (a[i] === b[i]) prefix++; else break;
      return jaro + prefix * 0.1 * (1 - jaro);
    }

    function findResponse(message) {
      const msg = message.toLowerCase().trim();
      if (!msg) return null;

      // 1. Exact match
      const exact = allPairs.find(p => p.trigger === msg);
      if (exact) return { reply: exact.reply, confidence: 100, type: "EXACT MATCH", color: "confidence-exact" };

      // 2. Fuzzy match (88%+ similarity)
      let bestScore = 0, bestReply = null;
      for (const p of allPairs) {
        const score = similarity(msg, p.trigger);
        if (score > bestScore) { bestScore = score; bestReply = p.reply; }
      }
      if (bestScore >= 0.88) return { reply: bestReply, confidence: Math.round(bestScore * 100), type: "FUZZY MATCH", color: "confidence-fuzzy" };

      // 3. Partial contains
      const partial = allPairs.find(p => msg.includes(p.trigger) || p.trigger.includes(msg));
      if (partial) return { reply: partial.reply, confidence: 70, type: "PARTIAL MATCH", color: "confidence-partial" };

      return { reply: "I'm not sure how to reply to that yet! Teach me on the dashboard ❤️", confidence: 0, type: "NO MATCH", color: "confidence-none" };
    }

    function appendMessage(content, sender, extra = "") {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.innerHTML = content + (extra ? `<div class="confidence ${extra.color}">${extra.type} • ${extra.confidence}% confidence</div>` : '');
      elements.chatMessages.appendChild(div);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

      if (sender === 'ai') {
        div.classList.add('vibrate');
        if ('vibrate' in navigator) navigator.vibrate(100);
      }
      return div;
    }

    function sendMessage() {
      const input = elements.chatInput.value.trim();
      if (!input) return;

      if (!hasChatted) {
        hasChatted = true;
        elements.welcomeContainer.classList.add('hidden');
      }

      appendMessage(input, 'user');
      elements.chatInput.value = '';

      setTimeout(() => {
        const result = findResponse(input);
        appendMessage(result.reply, 'ai', result);
      }, 400 + Math.random() * 400);
    }

    // Load all pairs in real-time
    onValue(ref(db, 'pairs'), (snap) => {
      allPairs = [];
      const data = snap.val() || {};
      Object.values(data).forEach(p => {
        if (p.trigger && p.reply) {
          allPairs.push({ trigger: p.trigger.toLowerCase().trim(), reply: p.reply.trim() });
        }
      });
      elements.pairCount.textContent = allPairs.length.toLocaleString();
    });

    elements.sendButton.addEventListener('click', sendMessage);
    elements.chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());
    elements.newConversationButton.addEventListener('click', () => {
      elements.chatMessages.innerHTML = '';
      elements.welcomeContainer.classList.remove('hidden');
      hasChatted = false;
    });

    onAuthStateChanged(auth, user => {
      if (!user) signInAnonymously(auth);
    });
  </script>
</body>
</html>
