<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#f8fafc">
  <title>Vynix AI – Image Reels</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f8fafc; color:#1e293b; overflow:hidden; height:100vh; font-family:'Inter',sans-serif; }
    .glass { background:rgba(255,255,255,0.9); backdrop-filter:blur(12px); border:1px solid rgba(0,0,0,0.05); }
    .bg-grid { background-image:linear-gradient(to right,rgba(0,0,0,0.03) 1px,transparent 1px),linear-gradient(to bottom,rgba(0,0,0,0.03) 1px,transparent 1px); background-size:40px 40px; }
    .reels { height:100vh; overflow-y:scroll; scroll-snap-type:y mandatory; }
    .reel { height:100vh; scroll-snap-align:start; position:relative; background:#000; }
    .reel img { width:100%; height:100%; object-fit:contain; }
    .overlay { background:linear-gradient(transparent 50%, rgba(0,0,0,0.9)); }
    .like-btn.liked { color:#ef4444; }
    .daily-limit { position:fixed; top:70px; left:50%; transform:translateX(-50%); background:#7C3AED; color:white; padding:8px 16px; border-radius:20px; font-size:12px; z-index:99; display:none; }
    .daily-limit.show { display:block; }
  </style>
</head>
<body class="antialiased">

  <div class="fixed inset-0 bg-grid opacity-50 pointer-events-none z-[-1]"></div>
  <div class="fixed top-[-10%] left-[-10%] w-96 h-96 bg-purple-300/20 rounded-full blur-3xl animate-pulse"></div>
  <div class="fixed bottom-[-10%] right-[-10%] w-96 h-96 bg-pink-300/20 rounded-full blur-3xl animate-pulse"></div>

  <header class="glass fixed top-0 w-full h-16 z-50 flex items-center justify-between px-5">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center text-white font-bold text-xl shadow-lg">V</div>
      <h1 class="font-bold text-xl">Vynix AI</h1>
    </div>
    <div id="status" class="text-sm text-slate-600">Loading...</div>
  </header>

  <div id="daily-limit" class="daily-limit"><span id="limit-text"></span></div>

  <main id="feed" class="reels pt-16"></main>

  <button onclick="openSheet()" class="fixed bottom-24 right-5 w-16 h-16 rounded-full bg-gradient-to-br from-purple-600 to-pink-500 text-white text-4xl shadow-2xl z-40 flex items-center justify-center hover:scale-110 transition">
    <span class="material-icons">add</span>
  </button>

  <div id="overlay" class="fixed inset-0 bg-black/50 z-50 hidden" onclick="closeSheet()"></div>
  <div id="sheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 transform translate-y-full transition-transform duration-300">
    <div class="p-5">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Create AI Art</h2>
        <button onclick="closeSheet()" class="p-2 rounded-full hover:bg-gray-100"><span class="material-icons">close</span></button>
      </div>

      <div class="relative aspect-square bg-gray-100 rounded-2xl overflow-hidden mb-5">
        <img id="preview" class="w-full h-full object-cover hidden" />
        <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
          <span class="material-icons text-6xl mb-2">image</span>
          <p>Art will appear here</p>
        </div>
        <div id="loading" class="hidden absolute inset-0 bg-white/90 flex items-center justify-center">
          <div class="flex gap-2">
            <div class="w-3 h-3 bg-purple-600 rounded-full animate-bounce"></div>
            <div class="w-3 h-3 bg-pink-500 rounded-full animate-bounce delay-100"></div>
            <div class="w-3 h-3 bg-gray-400 rounded-full animate-bounce delay-200"></div>
          </div>
        </div>
      </div>

      <textarea id="prompt" rows="3" class="w-full p-4 border border-gray-300 rounded-2xl resize-none focus:outline-none focus:border-purple-500" placeholder="Describe your vision..."></textarea>

      <button id="gen-btn" onclick="generate()" class="mt-4 w-full py-4 bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold rounded-2xl shadow-lg hover:scale-105 active:scale-95 transition flex items-center justify-center gap-2">
        <span class="material-icons">auto_awesome</span> Generate Image
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    let user = null;
    let verified = false;
    let todayCount = 0;

    // HARDCODED CLOUDINARY (just replace these two lines)
    const CLOUDINARY_CLOUD_NAME = "dxxxxxxxx";     // ← Your Cloudinary cloud name
    const CLOUDINARY_UPLOAD_PRESET = "vynix_preset"; // ← Your unsigned upload preset

    // Get xAI key from Remote Config (still safe)
    await fetchAndActivate(rc);
    const XAI_API_KEY = getString(rc, 'xai_api_key');

    if (!XAI_API_KEY) {
      document.getElementById('status').innerHTML = '<span class="text-red-500">xAI key missing!</span>';
    }

    window.openSheet = () => {
      if (!verified && todayCount >= 2) {
        alert("2 free generations used today!\nVerified users get unlimited.");
        return;
      }
      document.getElementById('overlay').classList.remove('hidden');
      document.getElementById('sheet').classList.remove('translate-y-full');
    };

    window.closeSheet = () => {
      document.getElementById('overlay').classList.add('hidden');
      document.getElementById('sheet').classList.add('translate-y-full');
      document.getElementById('prompt').value = '';
      document.getElementById('preview').classList.add('hidden');
      document.getElementById('placeholder').classList.remove('hidden');
    };

    window.generate = async () => {
      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) return alert("Enter a prompt!");

      document.getElementById('gen-btn').disabled = true;
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('placeholder').classList.add('hidden');

      try {
        // 1. Generate with xAI
        const res = await fetch("https://api.x.ai/v1/images/generations", {
          method: "POST",
          headers: { Authorization: `Bearer ${XAI_API_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-2-image-1212-preview", prompt, n: 1, response_format: "url" })
        });

        if (!res.ok) throw new Error("xAI API failed");

        const { data } = await res.json();
        const aiImageUrl = data[0].url;

        // 2. Upload to Cloudinary (hardcoded)
        const form = new FormData();
        form.append("file", aiImageUrl);
        form.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        const uploadRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: "POST",
          body: form
        });
        const uploaded = await uploadRes.json();

        // 3. Save to Firebase
        const newRef = push(ref(db, 'images'));
        await set(newRef, {
          url: uploaded.secure_url,
          prompt,
          userId: user.uid,
          userName: user.displayName || "Anonymous",
          userPhoto: user.photoURL || "",
          timestamp: serverTimestamp(),
          likes: {}
        });

        // 4. Update daily usage
        const today = new Date().toISOString().slice(0,10);
        await set(ref(db, `usage/\( {user.uid}/ \){today}`), { count: todayCount + 1 });

        // Show result
        document.getElementById('preview').src = uploaded.secure_url;
        document.getElementById('preview').classList.remove('hidden');
        document.getElementById('loading').classList.add('hidden');

        setTimeout(() => { closeSheet(); loadFeed(); }, 2000);

      } catch (e) {
        console.error(e);
        alert("Generation failed – check console");
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('placeholder').classList.remove('hidden');
      } finally {
        document.getElementById('gen-btn').disabled = false;
      }
    };

    function loadFeed() {
      const feed = document.getElementById('feed');
      onValue(query(ref(db, 'images'), orderByChild('timestamp'), limitToLast(100)), (snap) => {
        const imgs = [];
        snap.forEach(c => imgs.unshift({ id: c.key, ...c.val() }));

        feed.innerHTML = imgs.length === 0
          ? `<div class="reel flex items-center justify-center text-white/70 text-center"><span class="material-icons text-8xl mb-4">image</span><p class="text-2xl">No art yet</p></div>`
          : imgs.map(i => `
            <div class="reel">
              <img src="\( {i.url}" alt=" \){i.prompt}">
              <div class="overlay absolute inset-0 flex flex-col justify-end p-6 text-white">
                <div class="flex items-center gap-3 mb-2">
                  <img src="${i.userPhoto || 'https://ui-avatars.com/api/?name='+encodeURIComponent(i.userName)}" class="w-10 h-10 rounded-full border-2 border-white">
                  <p class="font-bold">${i.userName}</p>
                </div>
                <p class="text-lg mb-4">${i.prompt}</p>
                <button onclick="like('\( {i.id}', this)" class="like-btn text-3xl \){i.likes?.[user?.uid] ? 'liked' : ''}">
                  <span class="material-icons">${i.likes?.[user?.uid] ? 'favorite' : 'favorite_border'}</span>
                  <span class="text-sm ml-1">${Object.keys(i.likes || {}).length}</span>
                </button>
              </div>
            </div>
          `).join('');
      });
    }

    window.like = async (id, btn) => {
      const r = ref(db, `images/\( {id}/likes/ \){user.uid}`);
      const s = await get(r);
      await set(r, s.exists() ? null : true);
    };

    onAuthStateChanged(auth, async (u) => {
      if (!u) { location.href = "login.html"; return; }
      user = u;

      const userSnap = await get(ref(db, `users/${u.uid}`));
      verified = userSnap.val()?.verified || false;

      const today = new Date().toISOString().slice(0,10);
      const usageSnap = await get(ref(db, `usage/\( {u.uid}/ \){today}`));
      todayCount = usageSnap.val()?.count || 0;

      document.getElementById('status').textContent = verified ? "Verified • Unlimited" : `Today: ${todayCount}/2 free`;
      if (!verified && todayCount >= 2) {
        document.getElementById('limit-text').textContent = "Daily limit reached";
        document.getElementById('daily-limit').classList.add('show');
      }

      loadFeed();
    });
  </script>
</body>
</html>
