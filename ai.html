<!-- chat.html: Chat Interface for Loaded Models -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix AI - Chat Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/brain.js@2.0.0-beta.2/dist/brain-browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    #chat-messages { height: 500px; overflow-y: auto; }
    .message { margin-bottom: 1rem; }
    .user-message { text-align: right; }
    .ai-message { text-align: left; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
  <div class="max-w-4xl mx-auto px-4">
    <h1 class="text-3xl font-bold text-center mb-8">Vynix AI Chat</h1>
    
    <!-- Models Selection -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Select a Trained Model</h2>
      <div id="models-list" class="space-y-2 max-h-40 overflow-y-auto">
        <p class="text-gray-500">Loading models...</p>
      </div>
      <div id="model-status" class="mt-4 text-sm text-gray-600 hidden"></div>
    </div>

    <!-- Chat Interface -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6" id="chat-container" style="display: none;">
      <h2 class="text-xl font-semibold mb-4" id="chat-title">Chat with Loaded Model</h2>
      <div id="chat-messages" class="bg-gray-100 rounded p-4 mb-4 space-y-4"></div>
      <div class="flex gap-2">
        <input type="text" id="chat-input" placeholder="Type your message..." class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
        <button id="send-message-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50" disabled>Send</button>
        <button id="clear-chat-btn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Clear Chat</button>
      </div>
      <div id="chat-status" class="mt-2 text-sm text-gray-600 hidden"></div>
    </div>

    <!-- No Model Prompt -->
    <div id="no-model-prompt" class="bg-white rounded-lg shadow-md p-6 mb-6 text-center">
      <p class="text-gray-600 mb-4">No model loaded. Please select a model from above to start chatting.</p>
      <a href="train.html" class="text-blue-500 underline">Go to Training Dashboard</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    let app, auth, db;
    let net = new brain.recurrent.LSTM();
    let userModels = {};
    let currentModelVersion = null;
    let chatHistory = []; // Array of {role: 'user'|'ai', message: string}

    const elements = {
      modelsList: document.getElementById('models-list'),
      modelStatus: document.getElementById('model-status'),
      chatContainer: document.getElementById('chat-container'),
      chatTitle: document.getElementById('chat-title'),
      chatMessages: document.getElementById('chat-messages'),
      chatInput: document.getElementById('chat-input'),
      sendMessageBtn: document.getElementById('send-message-btn'),
      clearChatBtn: document.getElementById('clear-chat-btn'),
      chatStatus: document.getElementById('chat-status'),
      noModelPrompt: document.getElementById('no-model-prompt')
    };

    function normalizeText(text) {
      return text.toLowerCase().trim();
    }

    async function loadModels() {
      const user = auth.currentUser;
      if (!user) return;
      try {
        elements.modelsList.innerHTML = '<p class="text-gray-500">Loading...</p>';
        const snapshot = await get(ref(db, `users/${user.uid}/models`));
        userModels = snapshot.val() || {};
        renderModels();
      } catch (error) {
        console.error('Error loading models:', error);
        elements.modelsList.innerHTML = '<p class="text-red-500">Error loading models.</p>';
      }
    }

    function renderModels() {
      if (Object.keys(userModels).length === 0) {
        elements.modelsList.innerHTML = '<p class="text-gray-500">No models available. <a href="train.html" class="text-blue-500 underline">Train one first</a>.</p>';
        return;
      }
      elements.modelsList.innerHTML = Object.entries(userModels)
        .sort(([a], [b]) => parseInt(b) - parseInt(a)) // Newest first
        .map(([version, data]) => `
          <div class="flex justify-between items-center p-3 bg-gray-100 rounded border">
            <div>
              <div class="font-medium">Version ${version}</div>
              <div class="text-sm text-gray-600">Accuracy: ${(data.accuracy || 0).toFixed(2)}% | ${new Date(data.timestamp).toLocaleString()}</div>
            </div>
            <button onclick="loadModel(${version})" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">Load & Chat</button>
          </div>
        `).join('');
    }

    window.loadModel = async function(version) {
      try {
        elements.modelStatus.classList.remove('hidden');
        elements.modelStatus.textContent = 'Loading model...';
        elements.modelStatus.classList.add('text-blue-600');

        const modelData = userModels[version];
        if (!modelData || !modelData.model) {
          throw new Error('Invalid model data.');
        }

        // Deserialize model
        net.fromJSON(modelData.model);
        currentModelVersion = version;
        elements.chatTitle.textContent = `Chat with Model Version ${version}`;
        elements.chatContainer.style.display = 'block';
        elements.noModelPrompt.style.display = 'none';
        elements.chatInput.disabled = false;
        elements.sendMessageBtn.disabled = false;

        // Clear previous chat
        clearChat();

        elements.modelStatus.textContent = `Model Version ${version} loaded!`;
        elements.modelStatus.classList.remove('text-blue-600');
        elements.modelStatus.classList.add('text-green-600');
        setTimeout(() => elements.modelStatus.classList.add('hidden'), 3000);
      } catch (error) {
        console.error('Error loading model:', error);
        elements.modelStatus.textContent = 'Error: ' + error.message;
        elements.modelStatus.classList.remove('text-blue-600');
        elements.modelStatus.classList.add('text-red-600');
      }
    };

    function addMessage(role, message) {
      chatHistory.push({ role, message });
      const messageEl = document.createElement('div');
      messageEl.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
      messageEl.innerHTML = `
        <div class="inline-block max-w-xs lg:max-w-md p-3 rounded-lg ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-white text-gray-800 border'}">
          <p>${message}</p>
        </div>
      `;
      elements.chatMessages.appendChild(messageEl);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function clearChat() {
      chatHistory = [];
      elements.chatMessages.innerHTML = '';
    }

    async function sendMessage() {
      const input = elements.chatInput.value.trim();
      if (!input || !currentModelVersion) return;

      elements.sendMessageBtn.disabled = true;
      elements.chatInput.disabled = true;
      elements.chatStatus.classList.remove('hidden');
      elements.chatStatus.textContent = 'Generating response...';
      elements.chatStatus.classList.add('text-blue-600');

      try {
        addMessage('user', input);
        elements.chatInput.value = '';

        // Generate response using loaded model
        const normalizedInput = normalizeText(input);
        const response = net.run(normalizedInput);

        // Simulate typing delay
        await new Promise(resolve => setTimeout(resolve, 500));

        addMessage('ai', response);
      } catch (error) {
        console.error('Error generating response:', error);
        addMessage('ai', 'Sorry, I encountered an error generating a response.');
      } finally {
        elements.sendMessageBtn.disabled = false;
        elements.chatInput.disabled = false;
        elements.chatStatus.classList.add('hidden');
      }
    }

    function handleClearChat() {
      if (confirm('Clear the chat history?')) {
        clearChat();
      }
    }

    // Event Listeners
    elements.sendMessageBtn.addEventListener('click', sendMessage);

    elements.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    elements.clearChatBtn.addEventListener('click', handleClearChat);

    // Global loadModel for onclick
    window.loadModel = loadModel;

    async function initializeFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log('Logged in as:', user.displayName);
          await loadModels();
        } else {
          window.location.href = 'signup.html'; // Redirect if needed
        }
      });
    }

    document.addEventListener('DOMContentLoaded', initializeFirebase);
  </script>
</body>
</html>
