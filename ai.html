<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Vynix AI – Chat, Create & Voice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff; --card-bg: #f7f9fa; --text-primary: #0f1419; --text-secondary: #536471;
      --border: #e1e8ed; --accent: #ff2a6d; --header-bg: #ffffff;
      --chat-bubble-sent: #ff2a6d; --chat-bubble-received: #f7f9fa; --status-online: #128c7e;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --glow: 0 0 10px rgba(255,42,109,.35);
    }
    body.dark { --bg:#000; --card-bg:#16181c; --text-primary:#fff; --text-secondary:#71767b; --border:#2f3336; --header-bg:#000; --chat-bubble-received:#16181c; }
    body { font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text-primary); margin:0; padding:0; overflow:hidden; height:100vh; }
    .message-bubble, textarea { user-select:text; -webkit-user-select:text; }

    /* Tab Bar */
    .tab-bar { position:fixed; top:0; left:0; right:0; height:64px; background:var(--bg); border-bottom:1px solid var(--border); display:flex; z-index:1000; box-shadow:var(--shadow-sm); }
    .tab { flex:1; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:600; font-size:15px; cursor:pointer; transition:all .2s; border-bottom:3px solid transparent; }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .tab:hover:not(.active) { background:rgba(255,42,109,.1); }

    /* Chat Tab */
    .chat-header { position:fixed; top:64px; left:0; right:0; height:64px; background:var(--header-bg); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 16px; z-index:99; box-shadow:var(--shadow-sm); }
    .header-left { display:flex; align-items:center; gap:16px; flex:1; }
    .back-btn { background:none; border:none; color:var(--text-primary); font-size:28px; cursor:pointer; padding:8px; border-radius:50%; transition:background .2s; }
    .back-btn:hover { background:rgba(255,42,109,.1); }
    .profile-pic-header { width:40px; height:40px; border-radius:50%; background:var(--accent); color:white; font-weight:bold; font-size:18px; display:flex; align-items:center; justify-content:center; }
    .status-dot-header { position:absolute; bottom:2px; right:2px; width:12px; height:12px; background:var(--status-online); border:2px solid var(--header-bg); border-radius:50%; }

    .main-content { position:fixed; top:128px; left:0; right:0; bottom:140px; overflow-y:auto; padding:16px 20px 40px; max-width:600px; margin:0 auto; }
    .message-item { display:flex; margin-bottom:16px; animation:fadeIn .3s ease; }
    .message-received { justify-content:flex-start; }
    .message-sent { justify-content:flex-end; }
    .message-avatar { width:40px; height:40px; border-radius:50%; background:var(--accent); color:white; font-weight:bold; font-size:18px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .message-bubble { max-width:75%; padding:12px 16px; border-radius:20px; word-wrap:break-word; line-height:1.4; }
    .message-received .message-bubble { background:var(--chat-bubble-received); color:var(--text-primary); border-bottom-left-radius:4px; margin-left:12px; border:1px solid var(--border); }
    .message-sent .message-bubble { background:var(--chat-bubble-sent); color:white; border-bottom-right-radius:4px; margin-right:12px; box-shadow:var(--glow); }
    .message-time { font-size:11px; margin-top:6px; text-align:right; color:inherit; opacity:0.7; }

    .thinking-dots { display:inline-flex; gap:4px; }
    .dot { width:8px; height:8px; border-radius:50%; background:currentColor; animation:bounce 1.4s infinite; }
    .dot:nth-child(1) { animation-delay:0s; } .dot:nth-child(2) { animation-delay:0.2s; } .dot:nth-child(3) { animation-delay:0.4s; }
    @keyframes bounce { 0%,80%,100% { transform:scale(0.8); opacity:0.5; } 40% { transform:scale(1.2); opacity:1; } }

    #suggested-prompts { position:fixed; bottom:78px; left:0; right:0; height:62px; padding:12px 20px; background:var(--bg); z-index:9; overflow-x:auto; white-space:nowrap; border-top:1px solid var(--border); transition:all .4s ease; scrollbar-width:none; }
    #suggested-prompts.hidden { opacity:0; transform:translateY(20px); pointer-events:none; }
    #prompts-container { display:inline-flex; gap:10px; align-items:center; height:100%; }
    .prompt-btn { background:var(--card-bg); color:var(--text-primary); border:1.5px solid var(--border); padding:10px 18px; border-radius:30px; font-size:14px; font-weight:500; cursor:pointer; transition:all .25s ease; box-shadow:var(--shadow-sm); white-space:nowrap; flex-shrink:0; }
    .prompt-btn:hover { background:var(--accent); color:white; }

    .input-bar { position:fixed; bottom:0; left:0; right:0; background:var(--card-bg); border-top:1px solid var(--border); padding:12px 20px; display:flex; align-items:flex-end; gap:12px; z-index:10; box-shadow:var(--shadow-sm); max-width:600px; margin:0 auto; left:50%; transform:translateX(-50%); width:100%; }
    .input-group { flex:1; background:var(--card-bg); border:1px solid var(--border); border-radius:24px; overflow:hidden; display:flex; align-items:center; }
    .input-group textarea { flex:1; background:none; border:none; outline:none; padding:12px 16px; color:var(--text-primary); font-size:16px; resize:none; max-height:120px; min-height:48px; font-family:inherit; }
    .send-btn { background:var(--accent); color:white; border:none; border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px; font-weight:bold; box-shadow:var(--glow); flex-shrink:0; }
    .send-btn:disabled { opacity:0.5; cursor:not-allowed; }

    /* Create Tab */
    .create-content { position:fixed; top:64px; left:0; right:0; bottom:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; overflow-y:auto; }
    .generated-image { max-width:100%; max-height:75vh; border-radius:16px; box-shadow:var(--shadow-md); margin:20px 0; }
    .download-btn {
      background:var(--accent); color:white; border:none; padding:12px 24px;
      border-radius:50px; font-weight:700; cursor:pointer; box-shadow:var(--glow);
      transition:all .2s; margin-top:10px;
    }
    .download-btn:hover { transform:scale(1.05); }

    .create-input-bar { position:fixed; bottom:0; left:0; right:0; background:var(--card-bg); border-top:1px solid var(--border); padding:12px 20px; display:flex; gap:12px; z-index:10; box-shadow:var(--shadow-sm); max-width:600px; margin:0 auto; left:50%; transform:translateX(-50%); width:100%; }
    .create-textarea { flex:1; background:var(--bg); border:1px solid var(--border); border-radius:24px; padding:12px 16px; font-size:16px; resize:none; outline:none; min-height:48px; max-height:120px; }
    .generate-btn { background:var(--accent); color:white; border:none; border-radius:50px; padding:12px 24px; font-weight:700; cursor:pointer; box-shadow:var(--glow); transition:all .2s; }
    .generate-btn:hover { transform:scale(1.05); }
    .generate-btn:disabled { opacity:0.6; cursor:not-allowed; }

    /* Voice Tab */
    .voice-content { position:fixed; top:64px; left:0; right:0; bottom:0; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; }
    .voice-visualization { height:200px; display:flex; align-items:center; justify-content:center; gap:4px; }
    .sound-wave { width:6px; background:var(--accent); border-radius:3px; animation:wave 1.5s ease-in-out infinite; }
    .sound-wave:nth-child(odd) { animation-delay:0.1s; }
    .sound-wave:nth-child(even) { animation-delay:0.2s; }
    @keyframes wave { 0%,100% { height:20px; opacity:0.5; } 50% { height:80px; opacity:1; } }
    .voice-status { text-align:center; font-size:18px; margin:20px 0; color:var(--text-secondary); }
    .mic-btn { background:var(--accent); color:white; border:none; border-radius:50%; width:80px; height:80px; font-size:40px; cursor:pointer; box-shadow:var(--glow); transition:all .3s; }
    .mic-btn.active { background:#e91e63; transform:scale(1.1); }

    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  </style>
</head>
<body class="light">

  <!-- Tab Bar -->
  <div class="tab-bar">
    <div class="tab active" data-tab="chat"><span class="material-icons">chat_bubble</span> Chat</div>
    <div class="tab" data-tab="create"><span class="material-icons">auto_awesome</span> Create</div>
    <div class="tab" data-tab="voice"><span class="material-icons">mic</span> Voice</div>
  </div>

  <!-- Chat Tab -->
  <div id="chat-tab" class="tab-content">
    <header class="chat-header">
      <div class="header-left">
        <button class="back-btn material-icons" onclick="history.back()">arrow_back</button>
        <div style="display:flex;align-items:center;gap:12px;flex:1;">
          <div style="position:relative;"><div class="profile-pic-header">AI</div><span class="status-dot-header"></span></div>
          <div class="profile-details">
            <div class="profile-name-header">Vynix AI</div>
            <div class="profile-timestamp-header" id="user-status">Assistant • Always online</div>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content" id="messages-container"></main>

    <div id="suggested-prompts">
      <div id="prompts-container">
        <button class="prompt-btn" onclick="usePrompt('A dragon over Table Mountain')">Dragon & Table Mountain</button>
        <button class="prompt-btn" onclick="usePrompt('Cape Town sunset')">Cape Town sunset</button>
        <button class="prompt-btn" onclick="usePrompt('A lion with sunglasses')">Cool lion</button>
      </div>
    </div>

    <div class="input-bar">
      <div class="input-group">
        <textarea id="message-input" placeholder="Ask anything..." rows="1"></textarea>
      </div>
      <button class="send-btn material-icons" id="send-btn" disabled onclick="sendMessage()">send</button>
    </div>
  </div>

  <!-- Create Tab -->
  <div id="create-tab" class="tab-content hidden">
    <div class="create-content">
      <div id="thinking-animation" class="hidden">
        <div class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <img id="generated-image" class="generated-image hidden" />
      <button id="download-btn" class="download-btn hidden" onclick="downloadImage()">
        <span class="material-icons">download</span> Download Image
      </button>
    </div>
    <div class="create-input-bar">
      <textarea id="image-prompt" class="create-textarea" placeholder="Describe your image..."></textarea>
      <button id="generate-btn" class="generate-btn">Generate</button>
    </div>
  </div>

  <!-- Voice Tab -->
  <div id="voice-tab" class="tab-content hidden">
    <div class="voice-content">
      <div class="voice-visualization" id="voice-visualization">
        <div style="color:var(--text-secondary);">Tap to speak</div>
      </div>
      <div class="voice-status" id="voice-status">Ready</div>
      <button id="mic-btn" class="mic-btn material-icons">mic</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const xaiKey = getString(rc, 'xai_api_key');

    let currentUser = null;
    let isVerified = false;
    let monthlyTokens = 15000;
    let currentImageUrl = '';

    // Token System
    async function loadTokens() {
      if (!currentUser) return;
      const snap = await get(ref(db, `users/${currentUser.uid}`));
      const data = snap.val() || {};
      isVerified = data.verified || false;

      const now = Date.now();
      const oneMonth = 30 * 24 * 60 * 60 * 1000;
      const lastReset = data.tokenReset || 0;

      if (now - lastReset > oneMonth || !data.tokens) {
        monthlyTokens = 15000;
        await set(ref(db, `users/${currentUser.uid}`), { ...data, tokens: { used: 0 }, tokenReset: now });
      } else {
        monthlyTokens = 15000 - (data.tokens?.used || 0);
      }

      if (isVerified) monthlyTokens = Infinity;
      document.getElementById('user-status').textContent = isVerified ? 'Verified • Unlimited' : `Tokens: ${monthlyTokens.toLocaleString()}`;
    }

    async function deductTokens(amount) {
      if (isVerified) return true;
      if (monthlyTokens < amount) {
        alert("Out of tokens! Verified users get unlimited.");
        return false;
      }
      monthlyTokens -= amount;
      const used = 15000 - monthlyTokens;
      await set(ref(db, `users/${currentUser.uid}/tokens`), { used });
      document.getElementById('user-status').textContent = `Tokens: ${monthlyTokens.toLocaleString()}`;
      return true;
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.remove('hidden');
      });
    });

    // Chat
    function addMessage(content, sender, isThinking = false) {
      const container = document.getElementById('messages-container');
      const div = document.createElement('div');
      div.className = `message-item ${sender === 'user' ? 'message-sent' : 'message-received'}`;
      const bubble = isThinking
        ? `<div class="message-bubble"><div class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`
        : `<div class="message-bubble">${content.replace(/\n/g, '<br>')}<div class="message-time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div></div>`;
      div.innerHTML = `<div class="message-avatar">${sender === 'user' ? 'Y' : 'AI'}</div>${bubble}`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    let thinkingBubble = null;
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const msg = input.value.trim();
      if (!msg || !(await deductTokens(50))) return;
      addMessage(msg, 'user');
      input.value = ''; document.getElementById('send-btn').disabled = true;
      thinkingBubble = addMessage('', 'ai', true);

      const reply = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({ model: "grok-4-1-fast-non-reasoning", messages: [{ role: "user", content: msg }], temperature: 0.8 })
      }).then(r => r.json()).then(d => d.choices?.[0]?.message?.content || "Thinking...");

      thinkingBubble.remove();
      addMessage(reply, 'ai');
      document.getElementById('send-btn').disabled = false;
    }
    window.sendMessage = sendMessage;

    // Create Tab + Download Button
    async function generateImage() {
      const prompt = document.getElementById('image-prompt').value.trim();
      if (!prompt || !(await deductTokens(100))) return;

      document.getElementById('thinking-animation').classList.remove('hidden');
      document.getElementById('generated-image').classList.add('hidden');
      document.getElementById('download-btn').classList.add('hidden');
      document.getElementById('generate-btn').disabled = true;

      try {
        const res = await fetch("https://api.x.ai/v1/images/generations", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-2-image-1212", prompt, n: 1, response_format: "url" })
        });
        const data = await res.json();
        currentImageUrl = data.data[0].url;

        const img = document.getElementById('generated-image');
        img.src = currentImageUrl;
        img.classList.remove('hidden');
        document.getElementById('download-btn').classList.remove('hidden');
      } catch (e) {
        alert("Failed to generate image");
      }

      document.getElementById('thinking-animation').classList.add('hidden');
      document.getElementById('generate-btn').disabled = false;
      document.getElementById('image-prompt').value = '';
    }

    function downloadImage() {
      if (!currentImageUrl) return;
      const a = document.createElement('a');
      a.href = currentImageUrl;
      a.download = `vynix-ai-${Date.now()}.png`;
      a.click();
    }
    window.downloadImage = downloadImage;

    document.getElementById('generate-btn').addEventListener('click', generateImage);
    document.getElementById('image-prompt').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateImage(); }
    });

    // Input auto-resize
    document.getElementById('message-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      document.getElementById('send-btn').disabled = !this.value.trim();
    });

    // Auth
    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = 'login.html'; return; }
      currentUser = user;
      await loadTokens();
      addMessage("Hello! You have " + (isVerified ? "unlimited" : monthlyTokens.toLocaleString()) + " tokens this month.", 'ai');
    });

    function hideSuggestedPrompts() { document.getElementById('suggested-prompts').classList.add('hidden'); }
    window.usePrompt = text => { document.getElementById('message-input').value = text; hideSuggestedPrompts(); sendMessage(); };
  </script>
</body>
</html>
