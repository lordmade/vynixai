<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Vynix Reels – Create</title>

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
          colors: { brand: { bg: '#f8fafc', purple: '#7C3AED', pink: '#DB2777' } },
          animation: { 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
        }
      }
    }
  </script>

  <style>
    body { background: #000; color: #fff; overflow: hidden; height: 100vh; }
    .reel-container { scroll-snap-type: y mandatory; height: 100vh; overflow-y: scroll; }
    .reel-item { scroll-snap-align: start; height: 100vh; position: relative; display: flex; align-items: flex-end; }
    .like-btn.liked { color: #DB2777; transform: scale(1.25); }
    .bottom-sheet { transform: translateY(100%); transition: transform .3s ease; }
    .bottom-sheet.open { transform: translateY(0); }
  </style>
</head>

<body class="antialiased">
  <!-- REEL FEED -->
  <div id="reels" class="reel-container"></div>

  <!-- FLOATING CREATE BUTTON -->
  <button id="addBtn" class="fixed bottom-20 right-4 w-14 h-14 rounded-full bg-gradient-to-br from-purple-600 to-pink-500 text-white shadow-xl z-40">
    <span class="material-icons">add</span>
  </button>

  <!-- BOTTOM SHEET -->
  <div id="sheet" class="bottom-sheet fixed inset-x-0 bottom-0 bg-white text-slate-800 rounded-t-3xl p-6 z-50">
    <div class="w-12 h-1.5 bg-slate-300 rounded-full mx-auto mb-4"></div>
    <h2 class="font-display text-xl mb-3">Describe your image</h2>
    <textarea id="promptInput" class="w-full border border-slate-200 rounded-xl p-3 text-sm h-24 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="A dreamy cyber-punk city..."></textarea>
    <button id="genBtn" class="w-full mt-4 py-3 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-xl font-semibold shadow-lg">Generate</button>
  </div>

  <!-- OVERLAY TO CLOSE SHEET -->
  <div id="overlay" class="fixed inset-0 bg-black/60 z-40 hidden"></div>

  <!-- FIREBASE + CLOUDINARY -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, increment, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const xaiKey = getString(rc, 'xai_api_key');

    /* ==========  CLOUDINARY CONFIG  ========== */
    const CLOUD_NAME = 'YOUR_CLOUD_NAME';        // ← change
    const UPLOAD_PRESET = 'YOUR_UPLOAD_PRESET';  // ← change

    /* ==========  STATE  ========== */
    let currentUser = null;
    let isVerified = false;
    let monthlyTokens = 15000;

    /* ==========  AUTH & TOKEN LOGIC  ========== */
    async function loadTokens() {
      if (!currentUser) return;
      const snap = await get(ref(db, `users/${currentUser.uid}`));
      const data = snap.val();
      isVerified = data?.verified || false;
      monthlyTokens = isVerified ? Infinity : (15000 - (data?.tokens?.used || 0));
    }
    async function deductTokens(amount) {
      if (isVerified) return true;
      if (monthlyTokens < amount) { alert('Out of tokens!'); return false; }
      monthlyTokens -= amount;
      await push(ref(db, `users/${currentUser.uid}/tokens`), { used: 15000 - monthlyTokens });
      return true;
    }

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      await loadTokens();
      loadReels();
    });

    /* ==========  UI HELPERS  ========== */
    const sheet = document.getElementById('sheet');
    const overlay = document.getElementById('overlay');
    function openSheet() { sheet.classList.add('open'); overlay.classList.remove('hidden'); }
    function closeSheet() { sheet.classList.remove('open'); overlay.classList.add('hidden'); }
    document.getElementById('addBtn').onclick = openSheet;
    overlay.onclick = closeSheet;

    /* ==========  GENERATE IMAGE  ========== */
    document.getElementById('genBtn').onclick = async () => {
      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt || !(await deductTokens(100))) return;
      closeSheet();
      const reels = document.getElementById('reels');
      reels.scrollTop = 0; // jump to top while generating

      const tempId = Date.now();
      const tempRef = push(ref(db, 'reels'), { url: 'generating', prompt, likes: 0, by: currentUser.uid, ts: tempId });
      const tempKey = tempRef.key;

      try {
        // 1. Call xAI image
        const xRes = await fetch("https://api.x.ai/v1/images/generations", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-2-image-1212", prompt, n: 1, response_format: "url" })
        });
        const { data } = await xRes.json();
        const imageUrl = data[0].url;

        // 2. Upload to Cloudinary (so we have a permanent URL)
        const form = new FormData();
        form.append('file', imageUrl);
        form.append('upload_preset', UPLOAD_PRESET);
        const cRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: form });
        const cData = await cRes.json();
        const permanentUrl = cData.secure_url;

        // 3. Replace temp entry
        await push(ref(db, 'reels'), { url: permanentUrl, prompt, likes: 0, by: currentUser.uid, ts: Date.now() });
        await fetch(`${db.app.options.databaseURL}/reels/${tempKey}.json`, { method: "DELETE" });
      } catch (e) {
        alert("Generation failed");
        await fetch(`${db.app.options.databaseURL}/reels/${tempKey}.json`, { method: "DELETE" });
      }
    };

    /* ==========  LOAD & RENDER REELS  ========== */
    function loadReels() {
      const reels = document.getElementById('reels');
      onValue(ref(db, 'reels'), snap => {
        reels.innerHTML = '';
        const list = Object.values(snap.val() || {}).sort((a, b) => b.ts - a.ts);
        list.forEach(item => renderReel(item));
      }, { onlyOnce: false });
    }

    function renderReel(item) {
      const div = document.createElement('div');
      div.className = 'reel-item';
      div.innerHTML = `
        <img src="${item.url}" class="absolute inset-0 w-full h-full object-cover" />
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/20"></div>
        <div class="relative z-10 w-full p-6 flex items-end justify-between">
          <div class="flex-1">
            <p class="text-sm opacity-80 mb-2">@${item.by.slice(0, 8)}</p>
            <p class="text-base">${item.prompt}</p>
          </div>
          <div class="flex flex-col items-center gap-4 ml-4">
            <button class="like-btn text-white" data-key="${item.ts}">
              <span class="material-icons text-3xl">favorite_border</span>
              <span class="text-xs">${item.likes || 0}</span>
            </button>
          </div>
        </div>
      `;
      document.getElementById('reels').appendChild(div);

      // double-tap to like
      let last = 0;
      div.addEventListener('click', e => {
        const now = Date.now();
        if (now - last < 300) likePost(item.ts);
        last = now;
      });
    }

    /* ==========  LIKE FUNCTION  ========== */
    window.likePost = ts => {
      const likesRef = ref(db, `reels/${ts}/likes`);
      push(ref(db, `likes/${currentUser.uid}/${ts}`), true);      // user record
      onValue(likesRef, s => {                                   // update count
        const current = s.val() || 0;
        likesRef.set(current + 1);
      }, { onlyOnce: true });
    };
  </script>
</body>
</html>
