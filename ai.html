<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="white-translucent">
  <meta name="theme-color" content="#ffffff">
  <title>Vynix AI – Chat</title>

  <!-- PWA manifest -->
  <link rel="manifest" href='data:application/manifest+json,{
    "name":"Vynix AI",
    "short_name":"Vynix",
    "start_url":"/",
    "display":"standalone",
    "background_color":"#ffffff",
    "theme_color":"#2563eb",
    "orientation":"portrait-primary",
    "icons":[
      {"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg ' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%23d946ef'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext y='80' font-size='70' font-weight='bold' fill='url(%23g)' text-anchor='middle' x='50'%3ENE%3C/text%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml"},
      {"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg ' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%23d946ef'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext y='80' font-size='70' font-weight='bold' fill='url(%23g)' text-anchor='middle' x='50'%3ENE%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}
    ]
  }'>

  <link rel="preconnect" href="https://fonts.googleapis.com ">
  <link rel="preconnect" href="https://fonts.gstatic.com " crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300 ;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded " rel="stylesheet">

  <style>
    :root {
      --bg-color: #ffffff;
      --surface-color: #f4f6f8;
      --text-primary: #1a1a1a;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --accent-gradient: linear-gradient(135deg, #2563eb, #9333ea);
      --logo-gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 100%);
      --input-bg: #f0f2f5;
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.06);
      --font-main: 'Outfit', sans-serif;
      --font-mono: 'Roboto Mono', monospace;

      /* AI-coloured PWA banner tokens */
      --ai-gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 100%);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--bg-color);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }
    .header {
      height: 64px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      z-index: 10;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .vynix-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 12px;
      transition: transform 0.2s;
    }
    .vynix-logo:active { transform: scale(0.96); }
    .logo-icon {
      font-size: 26px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-variation-settings: 'FILL' 1, 'wght' 600;
    }
    .logo-text {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #1a1a1a;
    }
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0 160px 0;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
    }
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px;
      opacity: 1;
      transition: opacity 0.5s;
    }
    .welcome-icon {
      font-size: 64px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 20px;
      font-variation-settings: 'wght' 200;
    }
    .welcome-text {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .welcome-sub {
      color: var(--text-muted);
      font-size: 16px;
      max-width: 300px;
      line-height: 1.5;
    }
    .message-row {
      display: flex;
      flex-direction: column;
      padding: 10px 20px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      animation: fadeIn 0.3s ease forwards;
    }
    .message-bubble-container {
      display: flex;
      gap: 12px;
    }
    .message-row.user .message-bubble-container { justify-content: flex-end; }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
    }
    .avatar.ai {
      background: white;
      border: 1px solid #e0e0e0;
    }
    .avatar.ai span {
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 20px;
      font-variation-settings: 'FILL' 1;
    }
    .message-content {
      max-width: 85%;
      line-height: 1.6;
      font-size: 16px;
      word-wrap: break-word;
    }
    .message-row.ai .message-content { color: var(--text-primary); padding-top: 6px; }
    .message-row.user .message-content {
      background: var(--surface-color);
      color: var(--text-primary);
      padding: 12px 18px;
      border-radius: 20px 20px 4px 20px;
    }
    .message-content strong { font-weight: 600; }
    .message-content code {
      background: #e8ebed;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.9em;
      color: #c026d3;
    }
    .message-content pre {
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 15px;
      border-radius: 12px;
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 13px;
      margin-top: 10px;
    }
    .copy-actions {
      display: flex;
      margin-left: 44px;
      margin-top: 4px;
    }
    .copy-btn {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px 4px 0;
      transition: color 0.2s;
    }
    .copy-btn:active { opacity: 0.6; }
    .copy-btn span { font-size: 16px; }

    /* ---------- Input Area ---------- */
    .input-wrapper-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      background: var(--bg-color);
      padding: 12px max(20px, env(safe-area-inset-left)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-right));
      box-shadow: 0 -2px 10px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .input-wrapper {
      width: 100%;
      background: var(--input-bg);
      border-radius: 28px;
      padding: 6px;
      display: flex;
      align-items: center;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .input-wrapper:focus-within {
      background: white;
      box-shadow: var(--shadow-soft);
      outline: 1px solid #e0e0e0;
    }
    input {
      flex: 1;
      border: none;
      background: none;
      outline: none;
      font-size: 16px;
      font-family: var(--font-main);
      color: var(--text-primary);
      padding: 12px 14px;
      -webkit-user-select: text;
      user-select: text;
    }
    .mic-btn, .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .mic-btn:hover, .send-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-primary); }
    .mic-btn.listening {
      color: #dc2626;
      background: rgba(220, 38, 38, 0.1);
      animation: pulse-red 1.5s infinite;
    }
    .send-btn.active {
      background: var(--text-primary);
      color: white;
    }
    .send-btn span { font-size: 22px; margin-left: 2px; }
    .disclaimer {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
      text-align: center;
      opacity: 0.8;
    }

    /* ---------- AI-coloured PWA banner (same as feed) ---------- */
    .ai-banner {
      background: var(--ai-gradient);
      color: #fff;
    }
    .ai-banner-btn {
      background: rgba(255,255,255,.15);
      backdrop-filter: blur(10px);
      color: #fff;
      border: 1px solid rgba(255,255,255,.25);
    }
    .ai-banner-btn:hover { background: rgba(255,255,255,.25); }

    /* ---------- Animations ---------- */
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <!-- ====== AI-COLOURED PWA BANNER (same as feed) ====== -->
  <div id="pwa-install-banner" class="ai-banner fixed top-0 left-0 right-0 px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix AI for the best experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="ai-banner-btn px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-symbols-rounded text-xl">close</span>
      </button>
    </div>
  </div>

  <header class="header">
    <div class="vynix-logo" onclick="location.reload()">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <span class="logo-text">Vynix</span>
    </div>
  </header>

  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="material-symbols-rounded welcome-icon">neurology</div>
      <div class="welcome-text">How can I help?</div>
      <div class="welcome-sub">I'm Vynix, an AI expert in <strong>SA Education</strong>, <strong>Coding</strong>, and <strong>Storytelling</strong>. Try asking me to <strong>generate an image</strong>!</div>
    </div>
    <div id="messagesList"></div>
  </main>

  <div class="input-wrapper-fixed">
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn">
        <span class="material-symbols-rounded">mic</span>
      </button>
      <input type="text" id="input" placeholder="Message Vynix..." autocomplete="off">
      <button class="send-btn" id="sendBtn">
        <span class="material-symbols-rounded">arrow_upward</span>
      </button>
    </div>
    <p class="disclaimer">Vynix can make mistakes. Check important info.</p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js ';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js ';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);

    const XAI_KEY = getString(rc, 'xai_api_key') || "sk-YOUR-REAL-KEY";
    const systemInstructions = `
      You are Vynix, a helpful and general-purpose AI assistant.
      1. Coding Expert: Provide clean, modern, bug-free code with clear explanations.
      2. SA Education Specialist: Expert in South African CAPS curriculum (Grades R-12).
      3. Master Storyteller: Be vivid, creative, and engaging.
      4. General: Be concise, accurate, and use Markdown.
    `;
    let historyStack = [{ role: "system", content: systemInstructions }];

    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn'), $mic = $('#micBtn'), $list = $('#messagesList'), $welcome = $('#welcomeScreen');

    /* ---------- PWA banner (same as feed) ---------- */
    let deferredPrompt = null;
    const banner = $('#pwa-install-banner');
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      banner.classList.remove('-translate-y-full');
    });
    $('#pwa-install-btn').onclick = async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      banner.classList.add('-translate-y-full');
    };
    $('#pwa-install-close').onclick = () => banner.classList.add('-translate-y-full');

    /* ---------- speech ---------- */
    let recognition;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-ZA';
      recognition.interimResults = false;
      recognition.onstart = () => { $mic.classList.add('listening'); $i.placeholder = "Listening..."; };
      recognition.onresult = e => { $i.value = e.results[0][0].transcript; sendMessage(); };
      recognition.onend = () => { $mic.classList.remove('listening'); $i.placeholder = "Message Vynix..."; };
      recognition.onerror = () => { $mic.classList.remove('listening'); $i.placeholder = "Message Vynix..."; };
      $mic.onclick = () => recognition.start();
    } else { $mic.style.display = 'none'; }

    /* ---------- chat helpers ---------- */
    function parseMarkdown(text) {
      return text
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\s*-\s+(.*)/gm, '• $1<br>')
        .replace(/\n/g, '<br>');
    }
    function addMessage(text, type) {
      $welcome.style.display = 'none';
      const div = document.createElement('div');
      div.className = `message-row ${type}`;
      const avatarHTML = type === 'ai'
        ? `<div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div>` : '';
      let html = `<div class="message-bubble-container">${avatarHTML}
        <div class="message-content">${parseMarkdown(text)}</div></div>`;
      if (type === 'ai') {
        const id = 'copy-' + Date.now();
        html += `<div class="copy-actions"><button class="copy-btn" id="${id}">
          <span class="material-symbols-rounded">content_copy</span> Copy</button></div>`;
        div.innerHTML = html; $list.appendChild(div);
        $(`#${id}`).onclick = () => copyToClipboard(text, $(`#${id}`));
      } else { div.innerHTML = html; $list.appendChild(div); }
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }
    function addImage(url, prompt) {
      $welcome.style.display = 'none';
      const div = document.createElement('div');
      div.className = 'message-row ai';
      div.innerHTML = `
        <div class="message-bubble-container">
          <div class="avatar ai"><span class="material-symbols-rounded">brush</span></div>
          <div class="message-content">
            <p style="margin:0"><strong>Image Generated!</strong></p>
            <p style="font-size:14px;margin-top:4px;color:var(--text-muted)">Prompt: ${prompt}</p>
            <img src="${url}" style="max-width:100%;border-radius:12px;margin-top:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1)" alt="Generated image" onload="this.scrollIntoView({behavior:'smooth'})">
          </div>
        </div>`;
      $list.appendChild(div);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }
    function copyToClipboard(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const icon = btn.querySelector('span');
        icon.textContent = 'check'; btn.style.color = '#2563eb';
        setTimeout(() => { icon.textContent = 'content_copy'; btn.style.color = ''; }, 2000);
      });
    }
    function addLoading() {
      const div = document.createElement('div');
      div.id = 'loadingIndicator'; div.className = 'message-row ai';
      div.innerHTML = `<div class="message-bubble-container">
        <div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div>
        <div class="message-content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>`;
      $list.appendChild(div);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }
    function removeLoading() { const el = $('#loadingIndicator'); if (el) el.remove(); }

    /* ---------- send ---------- */
    window.sendMessage = async () => {
      const msg = $i.value.trim(); if (!msg) return;
      $i.value = ''; $send.classList.remove('active');
      addMessage(msg, 'user');

      const lower = msg.toLowerCase();
      if (lower.includes('generate image') || lower.includes('create an image') || lower.includes('draw')) {
        addLoading();
        const seed = Math.floor(Math.random() * 10000);
        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(msg)}?seed=${seed}&nologo=true&width=768&height=768`;
        setTimeout(() => {
          removeLoading(); addImage(url, msg);
          historyStack.push({ role: "user", content: msg }, { role: "assistant", content: `[Image: ${msg}]` });
        }, 1800);
        return;
      }

      addLoading();
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions ", {
          method: "POST",
          headers: { "Authorization": `Bearer ${XAI_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-fast",
            messages: [...historyStack, { role: "user", content: msg }],
            temperature: 0.7,
            max_tokens: 1000
          })
        });
        removeLoading();
        if (!res.ok) throw new Error("API Error");
        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || "No response.";
        addMessage(reply, 'ai');
        historyStack.push({ role: "user", content: msg }, { role: "assistant", content: reply });
      } catch (e) {
        removeLoading(); addMessage("Connection error. Please try again.", 'ai');
      }
    };

    /* ---------- input handlers ---------- */
    $i.addEventListener('input', () => $send.classList.toggle('active', $i.value.trim().length > 0));
    $i.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    $send.addEventListener('click', sendMessage);
    $send.classList.toggle('active', $i.value.trim().length > 0);
  </script>
</body>
</html>
