<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Vynix%20Buddy%22,%22short_name%22:%22Vynix%22,%22description%22:%22Your%20CAPS%20AI%20Tutor%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512%22,%22sizes%22:%22512x512%22}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    textarea,input,.content{-webkit-user-select:text;user-select:text}
    body{font-family:'Inter',sans-serif;background:#fff;color:#111827;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    /*  FIXED HEADER  */
    #tabHeader{position:fixed;top:0;left:0;right:0;height:72px;background:#fff;border-bottom:1px solid #e5e7eb;z-index:50}
    /*  TOKEN BAR  */
    #tokenBar{position:fixed;top:72px;left:0;right:0;height:40px;background:#8b5cf6;color:#fff;display:flex;align-items:center;justify-content:center;font-size:.9rem;z-index:50}
    /*  SCROLLABLE CHAT  */
    #chatPane{flex:1;margin-top:112px;margin-bottom:80px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:1rem}
    .message{margin:1.5rem 0;position:relative}
    .message.ai .content{background:#f8f9fa;border:1px solid #e9ecef;border-radius:1rem;padding:1rem 1.2rem;max-width:88%}
    .message.user .content{background:#9ca3af;color:#111827;border-radius:1rem;padding:1rem 1.2rem;margin-left:auto;max-width:85%;white-space:pre-wrap;word-break:break-word}
    .timestamp{font-size:.75rem;color:#6b7280;margin-top:4px}
    .message.ai .timestamp{margin-left:8px}
    .message.user .timestamp{margin-right:8px;text-align:right}
    .ai-actions{display:flex;gap:12px;margin-top:8px;margin-left:8px;opacity:.8}
    .action-btn{width:36px;height:36px;background:#f1f3f4;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
    .action-btn:hover{background:#e0e0e0;transform:scale(1.1)}
    .thinking{display:flex;gap:8px;padding:1rem 1.2rem}
    .dot{width:10px;height:10px;background:#8b5cf6;border-radius:50%;animation:pulse 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
    /*  INPUT BAR  */
    .input-bar{position:fixed;bottom:0;left:0;right:0;height:80px;background:#fff;border-top:1px solid #e5e7eb;box-shadow:0 -4px 20px rgba(0,0,0,.08);z-index:100;display:flex;align-items:center;padding:0 .75rem}
    .input-container{width:100%;background:#f9fafb;border:1px solid #d1d5db;border-radius:1.5rem;padding:.5rem .75rem;display:flex;align-items:flex-end;gap:.5rem}
    .input-container:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.15)}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1rem;resize:none;max-height:120px;line-height:1.5}
    .send-btn{width:44px;height:44px;border-radius:50%;background:#8b5cf6;display:flex;align-items:center;justify-content:center}
    .send-btn:disabled{background:#9ca3af}
    .upload-btn{width:44px;height:44px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
    /*  UPGRADE SHEET  */
    .bottom-sheet{position:fixed;bottom:-100%;left:0;right:0;background:#fff;border-radius:1.5rem 1.5rem 0 0;padding:1.5rem;box-shadow:0 -10px 40px rgba(0,0,0,.25);transition:bottom .4s cubic-bezier(.32,.72,0,1);z-index:200;max-height:92dvh;overflow-y:auto}
    .bottom-sheet.active{bottom:0}
    .sheet-handle{width:40px;height:5px;background:#ddd;border-radius:3px;margin:0 auto 1rem}
  </style>
</head>
<body>

  <!-- FIXED HEADER -->
  <header id="tabHeader" class="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-200 shadow-sm">
    <div class="flex items-center gap-3">
      <img src="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=40" alt="Vynix" class="rounded-lg">
      <div>
        <h1 class="text-xl font-black text-purple-600">Vynix Buddy</h1>
        <p class="text-xs text-gray-500">Your CAPS AI Tutor</p>
      </div>
    </div>
    <div class="flex bg-gray-100 rounded-full p-1">
      <button id="tabChat" class="tab-btn active px-5 py-2 rounded-full text-sm font-semibold">Chat</button>
      <button id="tabLive" class="tab-btn px-5 py-2 rounded-full text-sm font-semibold">Live Class</button>
    </div>
  </header>

  <!-- TOKEN BAR -->
  <div id="tokenBar">
    <span id="tokenCount">15,000</span> tokens left today •
    <button id="upgradeTrigger" class="bg-transparent border-0 text-white underline cursor-pointer font-semibold">Upgrade to Unlimited</button>
  </div>

  <!-- CHAT PANE (scrolls naturally) -->
  <section id="chatPane">
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <!-- INPUT BAR -->
  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn" aria-label="Attach image"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1" aria-label="Chat input"></textarea>
      <button id="sendBtn" class="send-btn" disabled aria-label="Send"><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <!-- UPGRADE SHEET -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-3">Never Run Out of Help Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <span class="text-purple-600 font-bold">Unlimited</span> and study without limits</p>
      <div class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl transform -rotate-2 mb-10">
        <div class="text-6xl font-black">R79</div>
        <div class="text-xl opacity-90">per month</div>
      </div>
      <div class="space-y-6 text-left bg-gray-50 rounded-3xl p-8 mb-8 text-lg font-medium">
        <div class="flex items-center gap-4">Unlimited AI messages</div>
        <div class="flex items-center gap-4">Premium ElevenLabs voice</div>
        <div class="flex items-center gap-4">Download answers as PDF</div>
        <div class="flex items-center gap-4">Faster responses</div>
        <div class="flex items-center gap-4">Support SA education (5% donated)</div>
      </div>
      <button id="mockUpgrade" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">Yes! Upgrade Me Now – R79/month</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });
    const auth = getAuth(app);
    const db = getDatabase(app);

    let userProfile = null;
    let xaiKey = null;
    let elevenKey = null;
    let history = [];
    let currentImage = null;
    let waitingForProfile = false;
    let dailyTokens = 15000;
    let isPremium = false;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeTrigger: document.getElementById('upgradeTrigger'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      mockUpgrade: document.getElementById('mockUpgrade'),
      tabChat: document.getElementById('tabChat'),
      tabLive: document.getElementById('tabLive'),
      chatView: document.getElementById('chatView'),
      liveView: document.getElementById('liveView'),
      startVoiceBtn: document.getElementById('startVoiceBtn'),
      voiceTranscript: document.getElementById('voiceTranscript'),
      aiSpeaking: document.getElementById('aiSpeaking'),
      micStatus: document.getElementById('micStatus')
    };

    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    xaiKey = getString(rc, 'xai_api_key').trim();
    elevenKey = getString(rc, 'elevenlabs_key')?.trim();

    async function loadPremiumStatus() {
      if (!auth.currentUser) return;
      const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/premium`));
      isPremium = snap.val() === true;
      els.tokenCount.parentElement.style.display = isPremium ? 'none' : 'flex';
    }

    async function speakWithElevenLabs(text) {
      if (!isPremium || !elevenKey) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-ZA';
        speechSynthesis.speak(utter);
        return;
      }
      els.aiSpeaking.classList.remove('hidden');
      try {
        const voiceId = "21m00Tcm4TlvDq8ikWAM";
        const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`, {
          method: "POST",
          headers: {
            "Accept": "audio/mpeg",
            "xi-api-key": elevenKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            text,
            model_id: "eleven_turbo_v2_5",
            voice_settings: { stability: 0.75, similarity_boost: 0.9 }
          })
        });
        const audio = new Audio(URL.createObjectURL(await res.blob()));
        audio.play();
        audio.onended = () => els.aiSpeaking.classList.add('hidden');
      } catch (e) {
        console.warn("ElevenLabs fallback", e);
        speechSynthesis.speak(new SpeechSynthesisUtterance(text));
      }
    }

    els.tabChat.onclick = () => {
      els.tabChat.classList.add('active'); els.tabLive.classList.remove('active');
      els.chatView.classList.remove('hidden'); els.liveView.classList.add('hidden');
      document.querySelector('.input-bar').style.display = 'flex';
    };
    els.tabLive.onclick = () => {
      els.tabLive.classList.add('active'); els.tabChat.classList.remove('active');
      els.liveView.classList.remove('hidden'); els.chatView.classList.add('hidden');
      document.querySelector('.input-bar').style.display = 'none';
      els.micStatus.classList.remove('hidden');
    };

    let recognition = null;
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-ZA';
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.onresult = e => {
        const text = Array.from(e.results).map(r => r[0].transcript).join('');
        els.voiceTranscript.textContent = text || "Listening...";
      };
      recognition.onend = () => {
        els.startVoiceBtn.innerHTML = `<i data-lucide="mic" class="w-8 h-8"></i> Hold to Talk`;
        els.micStatus.classList.add('hidden');
      };
    }

    els.startVoiceBtn.addEventListener('pointerdown', () => {
      if (!recognition) return els.voiceTranscript.textContent = "Voice not supported";
      recognition.start();
      els.voiceTranscript.textContent = "Listening...";
      els.startVoiceBtn.innerHTML = `<i data-lucide="mic-off" class="w-8 h-8"></i> Release to Send`;
      els.micStatus.classList.remove('hidden');
    });

    els.startVoiceBtn.addEventListener('pointerup', async () => {
      if (!recognition) return;
      recognition.stop();
      const userText = els.voiceTranscript.textContent.trim();
      if (!userText || userText === "Listening...") return;
      els.voiceTranscript.innerHTML = `<strong>You:</strong> ${userText}<br><br><strong>Vynix:</strong> `;
      const reply = await getReply(userText);
      els.voiceTranscript.innerHTML += reply;
      await speakWithElevenLabs(reply);
    });

    function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }
    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { els.upgradeSheet.classList.add('active'); return false; }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    function addMessage(content, sender, plain = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const time = formatTime();
      if (sender === 'ai') {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn"><i data-lucide="download"></i></button>
          </div>
          <div class="timestamp">${time}</div>`;
      } else {
        div.innerHTML = `<div class="content">${content.replace(/\n/g, '<br>')}</div><div class="timestamp">${time}</div>`;
      }
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();

      if (sender === 'ai') {
        div.querySelector('.voice-btn')?.addEventListener('click', () => speakWithElevenLabs(plain || content));
        div.querySelector('.copy-btn')?.addEventListener('click', () => navigator.clipboard.writeText(plain || content));
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11); doc.text(doc.splitTextToSize((plain || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_${new Date().toISOString().slice(0, 10)}.pdf`);
        });
      }
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting...";
      const prompt = `You are Vynix Buddy, a warm CAPS tutor. Help ${userProfile?.name || "this student"} (Grade ${userProfile?.grade || "?"})`. Be encouraging.";
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-3",
            messages: [{ role: "system", content: prompt }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "Thinking...";
      } catch { return "No internet. Try again."; }
    }

    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      const cost = estimateTokens(text);
      if (!(await deductTokens(cost))) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="User upload">`, 'user');
        history.push({ role: "user", content: currentImage });
        text = "Explain this homework";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null; els.sendBtn.disabled = true;
      addMessage("Thinking...", 'ai');
      const reply = await getReply(text);
      els.chatPane.lastChild.remove();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      els.sendBtn.disabled = !els.chatInput.value.trim() && !currentImage;
    });

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'studybuddy');
      const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.secure_url) { currentImage = data.secure_url; els.sendBtn.disabled = false; }
    };

    els.sendBtn.onclick = send;
    els.upgradeTrigger.onclick = () => els.upgradeSheet.classList.add('active');
    els.mockUpgrade.onclick = () => alert("Upgrade coming soon!");

    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = "login.html"; return; }
      await loadPremiumStatus();
    });

    lucide.createIcons();
  </script>
</body>
</html>
