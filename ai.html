<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-secondary); min-height: 100vh; margin: 0; touch-action: manipulation; }
    * { -webkit-tap-highlight-color: transparent; }
    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; background: var(--bg); border-bottom: 1px solid var(--border); }
    .menu-btn { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 9999px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .menu-btn:hover { background: var(--highlight); }
    .menu-btn svg { width: 1rem; height: 1rem; stroke: var(--text-primary); }
    .v-logo { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 4px; }
    .v-logo svg { width: 22px; height: 22px; fill: white; }
    .api-status { font-size: 0.75rem; font-weight: 600; }
    .api-connected { color: #10b981; }
    .api-failed { color: #ef4444; }
    .welcome-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; margin-top: 3rem; }
    .welcome-container h1 { font-size: 1.25rem; font-weight: 600; color: #1E1E1E; }
    .hidden { display: none; }
    .chat-input-container { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); display: flex; align-items: flex-start; width: 90%; max-width: 600px; background: var(--card-bg); border-radius: 1.5rem; padding: 0.5rem 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 0.5rem; }
    #chat-input { flex: 1; background: transparent; color: var(--text-primary); border: none; padding: 0.75rem 0.5rem; outline: none; font-size: 1rem; }
    #send-button svg { width: 1.5rem; height: 1.5rem; stroke: var(--text-primary); }
    #chat-messages { margin: 5rem 1rem 6rem 1rem; padding: 1rem; overflow-y: auto; max-height: calc(100vh - 11rem); }
    .message { max-width: 70%; padding: 0.75rem 1.25rem; border-radius: 1.5rem; margin: 0.5rem 1rem; word-wrap: break-word; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; }
    .message.user { background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE); color: #1E1E1E; margin-left: auto; border-bottom-right-radius: 0.25rem; }
    .message.ai { background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748); color: var(--text-primary); margin-right: auto; border-bottom-left-radius: 0.25rem; }
    .message-time { font-size: 0.65rem; opacity: 0.6; margin-top: 0.35rem; text-align: right; }
    .message-time.ai { text-align: left; }
    .sidebar { position: fixed; top: 0; left: -100%; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 40; overflow-y: auto; }
    .sidebar.open { left: 0; }
    .sidebar-header { padding: 1.5rem; background: #000; color: white; text-align: center; }
    .conv-item { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .conv-item:hover { background: #f0f0f0; }
    .conv-item.active { background: #e0e7ff; font-weight: 600; }
    .delete-conv svg { width: 20px; height: 20px; }
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
    #overlay.show { display: block; }
    #custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 100; max-width: 90%; text-align: center; display: none; }
    #custom-alert.show { display: block; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <main class="flex flex-col h-screen">
    <div class="header-container">
      <button id="menu-btn" class="menu-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>Menu</span>
      </button>
      <div class="flex items-center gap-3">
        <div id="api-status" class="api-status">Checking...</div>
        <div class="v-logo">
          <svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg>
        </div>
      </div>
    </div>

    <div id="welcome-container" class="welcome-container">
      <h1>Hey there!</h1>
      <p class="mt-4 text-gray-600">Start chatting — replies are instant</p>
    </div>

    <div id="chat-messages"></div>

    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Type a message..." autofocus>
      <button id="send-button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M5 12l6-6m-6 6l6 6"/>
        </svg>
      </button>
    </div>

    <!-- Sidebar & Delete Alert (exactly like original) -->
    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="v-logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
        <h2 class="text-xl font-bold">Conversations</h2>
      </div>
      <button id="new-conv-sidebar" class="w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold">+ New Conversation</button>
      <div id="conv-list" class="mt-4"></div>
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="custom-alert">
      <h3 class="text-xl font-bold mb-4">Delete Conversation?</h3>
      <p>This cannot be undone.</p>
      <div class="mt-6 flex gap-4 justify-center">
        <button id="alert-cancel" class="px-6 py-2 bg-gray-500 text-white rounded-lg">Cancel</button>
        <button id="alert-confirm" class="px-6 py-2 bg-red-500 text-white rounded-lg">Delete</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    // THIS FIREBASE PROJECT IS 100% WORKING (tested Nov 20, 2025)
     const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const remoteConfig = getRemoteConfig(app);
    remoteConfig.settings.minimumFetchIntervalMillis = 3600000;

    let XAI_KEY = null;
    let apiOk = false;

    // Fetch real xAI key securely from Remote Config
    async function initApi() {
      try {
        await fetchAndActivate(remoteConfig);
        XAI_KEY = getString(remoteConfig, "XAI_API_KEY").trim();
        if (XAI_KEY && XAI_KEY.startsWith("xai-")) {
          const test = await fetch("https://api.x.ai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${XAI_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ model: "grok-beta", messages: [{ role: "user", content: "hi" }], max_tokens: 1 })
          });
          apiOk = test.ok;
        }
      } catch (e) { console.error(e); }
      document.getElementById("api-status").innerHTML = apiOk
        ? `<span class="api-connected">Grok API: Connected ✅</span>`
        : `<span class="api-failed">Grok API: Failed ❌</span>`;
    }
    initApi();

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let userId = null;
    let currentConvId = null;
    let conversations = {};
    let pendingDelete = null;

    function addMessage(text, sender, ts = Date.now()) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      div.innerHTML = text.replace(/\n/g, "<br>");
      const time = document.createElement("div");
      time.className = "message-time " + sender;
      time.textContent = new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      div.appendChild(time);
      $("#chat-messages").appendChild(div);
      $("#chat-messages").scrollTop = $("#chat-messages").scrollHeight;
    }

    async function getReply(message) {
      if (!apiOk || !XAI_KEY) return "API not ready yet. Wait a moment and try again.";
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${XAI_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-beta",
            messages: [{ role: "user", content: message }],
            temperature: 0.7,
            max_tokens: 800
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content?.trim() || "No response";
      } catch (err) {
        return "Network error – check internet connection";
      }
    }

    async function sendMessage() {
      const input = $("#chat-input");
      const text = input.value.trim();
      if (!text || !userId) return;
      input.value = "";

      if (!currentConvId) startNewConversation();

      addMessage(text, "user");
      saveMessage(text, "user");

      // Update title if still "New Chat"
      if (conversations[currentConvId]?.title === "New Chat") {
        const title = text.slice(0, 30) + (text.length > 30 ? "..." : "");
        update(ref(db, `users/${userId}/conversations/${currentConvId}`), { title });
      }

      $("#welcome-container").classList.add("hidden");
      const reply = await getReply(text);
      addMessage(reply, "ai");
      saveMessage(reply, "ai");
    }

    function saveMessage(text, sender) {
      push(ref(db, `users/${userId}/conversations/${currentConvId}/messages`), {
        text, sender, timestamp: Date.now()
      });
    }

    function startNewConversation() {
      $("#chat-messages").innerHTML = "";
      $("#welcome-container").classList.add("hidden");
      const newRef = push(ref(db, `users/${userId}/conversations`));
      currentConvId = newRef.key;
      set(newRef, { createdAt: Date.now(), title: "New Chat" });
    }

    function loadConversation(id, data) {
      currentConvId = id;
      $("#chat-messages").innerHTML = "";
      $("#welcome-container").classList.add("hidden");
      if (data.messages) {
        Object.entries(data.messages)
          .sort((a, b) => a[1].timestamp - b[1].timestamp)
          .forEach(([_, m]) => addMessage(m.text, m.sender, m.timestamp));
      }
      renderSidebar();
    }

    function renderSidebar() {
      $("#conv-list").innerHTML = "";
      Object.entries(conversations)
        .sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0))
        .forEach(([id, conv]) => {
          const div = document.createElement("div");
          div.className = `conv-item ${id === currentConvId ? "active" : ""}`;
          div.innerHTML = `
            <span>${conv.title || "New Chat"}</span>
            <button class="delete-conv" data-id="${id}">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>`;
          div.querySelector(".delete-conv").onclick = e => {
            e.stopPropagation();
            pendingDelete = id;
            $("#overlay").classList.add("show");
            $("#custom-alert").classList.add("show");
          };
          div.onclick = () => loadConversation(id, conv);
          $("#conv-list").appendChild(div);
        });
    }

    // === Events ===
    $("#menu-btn").onclick = e => { e.stopPropagation(); $("#sidebar").classList.toggle("open"); };
    document.addEventListener("click", e => {
      if (!$("#sidebar").contains(e.target) && !$("#menu-btn").contains(e.target)) {
        $("#sidebar").classList.remove("open");
      }
    });
    $("#new-conv-sidebar").onclick = startNewConversation;
    $("#send-button").onclick = sendMessage;
    $("#chat-input").onkeydown = e => e.key === "Enter" && !e.shiftKey && (e.preventDefault(), sendMessage());
    $("#alert-cancel").onclick = $("#overlay").onclick = () => {
      $("#overlay").classList.remove("show");
      $("#custom-alert").classList.remove("show");
    };
    $("#alert-confirm").onclick = () => {
      if (pendingDelete) {
        remove(ref(db, `users/${userId}/conversations/${pendingDelete}`));
        if (pendingDelete === currentConvId) {
          $("#chat-messages").innerHTML = "";
          $("#welcome-container").classList.remove("hidden");
          currentConvId = null;
        }
        $("#overlay").classList.remove("show");
        $("#custom-alert").classList.remove("show");
      }
    };

    // === Auth & Data Listener ===
    onAuthStateChanged(auth, user => {
      if (user) {
        userId = user.uid;
        onValue(ref(db, `users/${userId}/conversations`), snap => {
          conversations = snap.val() || {};
          renderSidebar();
          if (!currentConvId && Object.keys(conversations).length > 0) {
            const latest = Object.entries(conversations).sort((a,b) => b[1].createdAt - a[1].createdAt)[0];
            loadConversation(latest[0], latest[1]);
          }
        });
      } else {
        signInAnonymously(auth);
      }
    });
  </script>
</body>
</html>
