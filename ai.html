<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Vynix AI â€“ Modern Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0d0d;
      --surface: #171717;
      --surface-light: #252525;
      --text: #fafafa;
      --text-secondary: #a3a3a3;
      --accent: #ff2a6d;
      --accent-glow: 0 0 12px #ff2a6d;
      --border: #27272a;
      --radius: 24px;
      --font: 'Inter', system-ui, sans-serif;
    }
    * {
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    textarea, input {
      -webkit-user-select: text;
      user-select: text;
    }
    /* Header */
    .header {
      flex-shrink: 0;
      height: 70px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #fff;
      box-shadow: var(--accent-glow);
    }
    .status {
      width: 10px;
      height: 10px;
      background: #22c55e;
      border-radius: 50%;
      margin-left: -8px;
      margin-top: 24px;
      border: 2px solid var(--surface);
    }
    .title {
      font-size: 18px;
      font-weight: 600;
    }
    .subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .icons {
      display: flex;
      gap: 8px;
    }
    .icon-btn {
      background: var(--surface-light);
      border: none;
      color: var(--text-secondary);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .icon-btn:hover {
      background: var(--accent);
      color: #fff;
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 75%;
      animation: fadeIn 0.3s ease;
    }
    .msg.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .msg.ai {
      align-self: flex-start;
    }
    .msg-bubble {
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 15px;
      line-height: 1.45;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .msg.user .msg-bubble {
      background: var(--accent);
      color: #fff;
      border: none;
      box-shadow: var(--accent-glow);
    }
    .msg-time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      align-self: flex-end;
    }

    /* Suggested Chips */
    .chips {
      padding: 0 20px 12px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .chips::-webkit-scrollbar {
      display: none;
    }
    .chip {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      white-space: nowrap;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .chip:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* Input */
    .input-bar {
      flex-shrink: 0;
      padding: 16px 20px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }
    .input-wrapper {
      flex: 1;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .input-wrapper input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
    }
    .input-wrapper input::placeholder {
      color: var(--text-secondary);
    }
    .send-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .send-btn:hover {
      transform: scale(1.05);
    }
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid var(--surface-light);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="icon-btn material-icons" onclick="history.back()">arrow_back</button>
      <div class="avatar">VA</div>
      <div class="status"></div>
      <div>
        <div class="title">Vynix AI</div>
        <div class="subtitle">Always here for you</div>
      </div>
    </div>
    <div class="icons">
      <button class="icon-btn material-icons" onclick="toggleTheme()">brightness_6</button>
      <button class="icon-btn material-icons">more_vert</button>
    </div>
  </header>

  <!-- Messages -->
  <main class="messages" id="messages"></main>

  <!-- Suggested Chips -->
  <div class="chips" id="chips">
    <button class="chip" onclick="sendChip('Summarize the latest feed')">Latest Feed</button>
    <button class="chip" onclick="sendChip('What are the trends today?')">Trends</button>
    <button class="chip" onclick="sendChip('Best time to post')">Insights</button>
    <button class="chip" onclick="sendChip('Create a post for me')">Create Post</button>
    <button class="chip" onclick="sendChip('Boost my last post')">Boost</button>
  </div>

  <!-- Input -->
  <div class="input-bar">
    <div class="input-wrapper">
      <input id="input" type="text" placeholder="Message Vynix AIâ€¦" autocomplete="off">
    </div>
    <button class="send-btn material-icons" id="sendBtn" onclick="sendMessage()">send</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get, set, push, query, orderByChild, limitToLast, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const xaiKey = getString(rc, 'xai_api_key');

    let currentUser = null;
    let aiChatId = null;
    let history = [{
      role: "system",
      content: `You are Vynix AI â€” a modern, friendly assistant inside the Vynix social platform. You can:
- READ the public feed (posts, authors, timestamps)
- CREATE posts for the user ("post: <text>")
- BOOST posts ("boost: <postId>")
- SUMMARISE trends ("trends")
- SHOW best time to post ("insights")
Stay concise, supportive, and use line breaks.`
    }];

    const $ = s => document.querySelector(s);
    const esc = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    /* ---------- Firebase helpers ---------- */
    async function getFeed(limit = 20) {
      const snap = await get(query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(limit)));
      const list = [];
      snap.forEach(c => list.push({key: c.key, ...c.val()}));
      return list.reverse();
    }
    async function createPost(text) {
      if (!currentUser) return {ok: false, error: 'Not logged in'};
      const newRef = push(ref(db, 'posts'));
      await set(newRef, {
        authorId: currentUser.uid,
        authorName: currentUser.displayName || 'Anonymous',
        authorAvatar: currentUser.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${currentUser.displayName}`,
        text: text.trim(),
        verified: false,
        likes: 0,
        replies: 0,
        reposts: 0,
        timestamp: serverTimestamp()
      });
      return {ok: true, key: newRef.key};
    }
    async function boostPost(postKey) {
      const orig = (await get(ref(db, `posts/${postKey}`))).val();
      if (!orig) return {ok: false, error: 'Post not found'};
      const newRef = push(ref(db, 'posts'));
      await set(newRef, {
        ...orig,
        authorId: currentUser.uid,
        authorName: currentUser.displayName,
        authorAvatar: currentUser.photoURL,
        repostOf: {authorName: orig.authorName, key: postKey},
        timestamp: serverTimestamp()
      });
      return {ok: true, key: newRef.key};
    }
    async function getTrends() {
      const posts = await getFeed(100);
      const words = {};
      const hours = Array(24).fill(0);
      posts.forEach(p => {
        const h = new Date(p.timestamp).getHours();
        hours[h]++;
        p.text.toLowerCase().split(/\s+/).forEach(w => {
          if (w.length > 3) words[w] = (words[w] || 0) + 1;
        });
      });
      const topWords = Object.entries(words).sort((a, b) => b[1] - a[1]).slice(0, 5).map(x => x[0]);
      const bestHour = hours.indexOf(Math.max(...hours));
      return {topWords, bestHour};
    }
    async function runAgentCommand(cmd) {
      const lower = cmd.toLowerCase();
      if (lower.startsWith('post:')) {
        const txt = cmd.slice(5).trim();
        const res = await createPost(txt);
        return res.ok ? `âœ… Posted! (${res.key})` : `âŒ ${res.error}`;
      }
      if (lower.startsWith('boost:')) {
        const key = cmd.slice(6).trim();
        const res = await boostPost(key);
        return res.ok ? `âœ… Boosted! (${res.key})` : `âŒ ${res.error}`;
      }
      if (lower === 'trends') {
        const t = await getTrends();
        return `ðŸ“ˆ Top words: ${t.topWords.join(', ')}\nðŸ•’ Best posting hour: ${t.bestHour}:00`;
      }
      if (lower === 'insights') {
        const t = await getTrends();
        return `ðŸ’¡ Post around ${t.bestHour}:00 for max visibility.\nHot keywords: ${t.topWords.join(', ')}`;
      }
      if (lower === 'feed') {
        const posts = await getFeed(5);
        return posts.map(p => `â€¢ ${p.authorName}: ${p.text.slice(0, 50)}â€¦`).join('\n');
      }
      return null;
    }

    /* ---------- UI ---------- */
    function addMessage(content, sender, time = Date.now()) {
      const container = $('#messages');
      const div = document.createElement('div');
      div.className = `msg ${sender}`;
      div.innerHTML = `
        <div class="msg-bubble">${esc(content).replace(/\n/g, '<br>')}</div>
        <div class="msg-time">${new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    window.sendChip = async txt => {
      $('#input').value = txt;
      sendMessage();
    };
    window.sendMessage = async () => {
      const input = $('#input');
      const msg = input.value.trim();
      if (!msg || !aiChatId) return;
      input.value = '';
      addMessage(msg, 'user');
      const cmdRes = await runAgentCommand(msg);
      if (cmdRes) {
        addMessage(cmdRes, 'ai');
        return;
      }
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "grok-4-1-fast-non-reasoning",
          messages: [...history, {role: "user", content: msg}],
          temperature: 0.8,
          max_tokens: 500
        })
      });
      if (!res.ok) return addMessage("I'm having trouble connecting â€” please try again.", 'ai');
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content?.trim() || "I'm here â€” could you tell me more?";
      addMessage(reply, 'ai');
      history.push({role: "user", content: msg}, {role: "assistant", content: reply});
      if (history.length > 30) history = [history[0], ...history.slice(-28)];
    };

    $('#input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    window.toggleTheme = () => document.body.classList.toggle('dark');

    /* ---------- auth & init ---------- */
    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = 'login.html'; return; }
      currentUser = user;
      aiChatId = [user.uid, 'mindspace_ai'].sort().join('_');
      addMessage("Hi ðŸ‘‹ I'm Vynix AI. Ask me about the feed, trends, or say \"post: your text\" to create a post.", 'ai');
    });
  </script>
</body>
</html>
