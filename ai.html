<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }

    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); height: 100dvh; overflow: hidden; margin: 0; }
    #chat-messages { height: calc(100dvh - 140px); overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1.5rem 1rem 7rem; }

    .message {
      max-width: 88%; width: fit-content; padding: 0.9rem 1.3rem; border-radius: 1.6rem;
      margin: 0.5rem 0; position: relative; animation: slideIn 0.35s ease-out;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); word-wrap: break-word;
    }
    .message.user { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; margin-left: auto; border-bottom-right-radius: 0.4rem; margin-right: 0.8rem; }
    .message.ai { background: white; color: #000; margin-right: auto; border-bottom-left-radius: 0.4rem; margin-left: 0.8rem; border: 1px solid #e5e7eb; }

    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 0.75rem 1rem; background: var(--bg); border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
    .chat-input-container { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); width: 92%; max-width: 600px; background: white; border-radius: 1.6rem; padding: 0.9rem 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; gap: 0.75rem; z-index: 20; border: 1px solid #e5e7eb; }

    /* SIDEBAR */
    #sidebar {
      position: fixed; top: 0; left: -100%; width: 300px; height: 100dvh; background: white; box-shadow: 2px 0 20px rgba(0,0,0,0.15);
      transition: left 0.3s ease; z-index: 50; overflow-y: auto; padding-bottom: 100px;
    }
    #sidebar.open { left: 0; }
    .sidebar-header { padding: 2rem 1.5rem 1rem; text-align: center; background: #000; color: white; }
    #new-conv-sidebar {
      margin: 1.5rem 1rem 1rem; background: #f3f4f6; color: #374151; padding: 1rem;
      border-radius: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      border: none; cursor: pointer; font-size: 1rem;
    }
    .conv-item {
      padding: 1rem 1.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; transition: background 0.2s;
    }
    .conv-item:hover { background: #f9fafb; }
    .conv-item.active { background: #eef2ff; font-weight: 600; }
    .conv-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.95rem; }
    .delete-conv {
      color: #ef4444; opacity: 0.7; padding: 0.5rem; border-radius: 8px;
    }
    .delete-conv:hover { background: #fee2e2; opacity: 1; }

    *, .message, .content, pre, button { touch-action: pan-y !important; -webkit-user-select: text !important; user-select: text !important; }
    button { touch-action: manipulation !important; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: none; } }
  </style>
</head>
<body>

  <div class="header-container">
    <button id="menu-btn" style="background:#000;color:white;padding:0.6rem 1.2rem;border-radius:999px;display:flex;align-items:center;gap:0.5rem;font-size:0.9rem;">
      <svg width="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      Menu
    </button>
    <div style="width:36px;height:36px;background:#000;border-radius:10px;display:flex;align-items:center;justify-content:center;">
      <svg viewBox="0 0 24 24" width="22" fill="white"><path d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg>
    </div>
  </div>

  <div id="welcome-container" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#000;">
    <h1 style="font-size:1.8rem;font-weight:700;">Hey there!</h1>
    <p style="margin-top:1rem;color:#666;font-size:1.1rem;">Start chatting — replies are instant</p>
  </div>

  <div id="chat-messages"></div>

  <div class="chat-input-container">
    <input type="text" id="chat-input" placeholder="Type a message..." autofocus>
    <button id="send-button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="26" height="26">
        <path d="M5 12h14M13 6l6 6-6 6"/>
      </svg>
    </button>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div style="width:72px;height:72px;background:#38B2AC;border-radius:50%;margin:0 auto 1rem;display:flex;align-items:center;justify-content:center;color:white;font-size:2rem;font-weight:bold;">V</div>
      <h2 style="font-size:1.4rem;font-weight:700;">Vynix AI</h2>
    </div>
    <button id="new-conv-sidebar">
      <svg width="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
      New Conversation
    </button>
    <div id="conv-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, push, set, remove, onValue, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = { apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc", authDomain: "fire-b-a8878.firebaseapp.com", databaseURL: "https://fire-b-a8878.firebaseio.com", projectId: "fire-b-a8878", appId: "1:658673187627:web:6e4c29af661785f0afa36e" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let userId = null;
    let currentConvId = null;
    let conversations = {};
    let xaiApiKey = null;
    let xaiEndpoint = "https://api.x.ai/v1/chat/completions";

    const SYSTEM_PROMPT = `You are Vynix AI, a super helpful, witty, and friendly AI assistant created by the vynix.ai team. Never mention Grok, xAI, or Elon Musk. If asked who you are, say: "I'm Vynix AI, proudly built by the vynix.ai team ❤️".`;

    const el = {
      messages: document.getElementById('chat-messages'),
      input: document.getElementById('chat-input'),
      send: document.getElementById('send-button'),
      welcome: document.getElementById('welcome-container'),
      sidebar: document.getElementById('sidebar'),
      convList: document.getElementById('conv-list'),
      menuBtn: document.getElementById('menu-btn'),
      newConvBtn: document.getElementById('new-conv-sidebar')
    };

    // Toggle sidebar
    el.menuBtn.onclick = () => el.sidebar.classList.toggle('open');
    document.addEventListener('click', e => { if (!el.sidebar.contains(e.target) && !el.menuBtn.contains(e.target)) el.sidebar.classList.remove('open'); });

    async function initXai() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiApiKey = getString(rc, 'xai_api_key').trim();
    }

    function generateTitle(text) {
      return text.trim().split('\n')[0].substring(0, 40) + (text.length > 40 ? '...' : '');
    }

    function addMessage(text, sender, timestamp = Date.now(), isNew = false) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;

      if (sender === 'ai') {
        const copy = document.createElement('button');
        copy.className = 'copy-reply-btn';
        copy.innerHTML = `<svg width="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`;
        copy.onclick = e => { e.stopPropagation(); navigator.clipboard.writeText(text); copy.innerHTML = '✓'; setTimeout(() => copy.innerHTML = copy.innerHTML, 1500); };
        div.appendChild(copy);
      }

      const content = document.createElement('div');
      content.className = 'content';
      content.innerHTML = sender === 'ai' ? marked.parse(text) : text.replace(/\n/g, '<br>');
      if (sender === 'ai') Prism.highlightAllUnder(content);

      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = new Date(timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      div.appendChild(content);
      div.appendChild(time);
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;
    }

    async function getReply(message) {
      if (!xaiApiKey) return "Waking up...";
      const res = await fetch(xaiEndpoint, {
        method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${xaiApiKey}` },
        body: JSON.stringify({ model: "grok-3", messages: [{role:"system",content:SYSTEM_PROMPT},{role:"user",content:message}], temperature: 0.8 })
      });
      const data = await res.json();
      return data.choices[0].message.content.trim();
    }

    async function send() {
      const text = el.input.value.trim();
      if (!text) return;
      if (!currentConvId) await startNewConversation(text);
      addMessage(text, 'user');
      saveMessage(text, 'user');
      el.input.value = '';
      addMessage('Typing...', 'ai');
      const reply = await getReply(text);
      el.messages.removeChild(el.messages.lastChild);
      addMessage(reply, 'ai', Date.now(), true);
      saveMessage(reply, 'ai');
    }

    function saveMessage(text, sender) {
      if (!currentConvId) return;
      push(ref(db, `users/\( {userId}/conversations/ \){currentConvId}/messages`), { text, sender, timestamp: Date.now() });
    }

    async function startNewConversation(firstMessage = null) {
      el.messages.innerHTML = '';
      el.welcome.classList.add('hidden');
      const convRef = push(ref(db, `users/${userId}/conversations`));
      currentConvId = convRef.key;
      const title = firstMessage ? generateTitle(firstMessage) : "New Chat";
      await set(convRef, { title, createdAt: Date.now() });
      renderSidebar();
    }

    async function loadConversation(id, data) {
      currentConvId = id;
      el.messages.innerHTML = '';
      el.welcome.classList.add('hidden');
      if (data.messages) {
        Object.entries(data.messages).sort((a,b) => a[1].timestamp - b[1].timestamp).forEach(([_, m]) => {
          addMessage(m.text, m.sender, m.timestamp);
        });
      }
      renderSidebar();
      el.messages.scrollTop = el.messages.scrollHeight;
    }

    async function deleteConversation(id) {
      if (confirm("Delete this conversation?")) {
        await remove(ref(db, `users/\( {userId}/conversations/ \){id}`));
        if (id === currentConvId) {
          currentConvId = null;
          el.messages.innerHTML = '';
          el.welcome.classList.remove('hidden');
        }
        renderSidebar();
      }
    }

    function renderSidebar() {
      el.convList.innerHTML = '';
      Object.entries(conversations)
        .sort((a,b) => b[1].createdAt - a[1].createdAt)
        .forEach(([id, conv]) => {
          const item = document.createElement('div');
          item.className = `conv-item ${id === currentConvId ? 'active' : ''}`;
          item.innerHTML = `
            <div class="conv-title">${conv.title || "New Chat"}</div>
            <button class="delete-conv">
              <svg width="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          `;
          item.onclick = (e) => { if (!e.target.closest('.delete-conv')) loadConversation(id, conv); };
          item.querySelector('.delete-conv').onclick = (e) => { e.stopPropagation(); deleteConversation(id); };
          el.convList.appendChild(item);
        });
    }

    // Load conversations
    function loadUserData(uid) {
      userId = uid;
      onValue(ref(db, `users/${uid}/conversations`), snap => {
        conversations = snap.val() || {};
        renderSidebar();
        if (!currentConvId && Object.keys(conversations).length) {
          const latest = Object.entries(conversations).sort((a,b) => b[1].createdAt - a[1].createdAt)[0];
          loadConversation(latest[0], latest[1]);
        }
      });
    }

    el.send.onclick = send;
    el.input.addEventListener('keypress', e => e.key === 'Enter' && send());
    el.newConvBtn.onclick = () => startNewConversation();

    onAuthStateChanged(auth, user => {
      if (user) { loadUserData(user.uid); initXai(); }
      else signInAnonymously(auth);
    });
  </script>
</body>
</html>
