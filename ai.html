<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <title>Vynix Lingua â€“ Multilingual African AI</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Space+Grotesk:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <style>
    /* ---------- 1.  Design-tokens (landing-page palette) ---------- */
    :root{
      --bg-color:#ffffff;
      --surface-color:#f3f6fc;
      --text-primary:#1e1e1e;
      --text-secondary:#444746;
      --text-muted:#9aa0a6;
      --accent-blue:#2563eb;
      --accent-purple:#d946ef;
      --accent-green:#10b981;
      --logo-gradient:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 50%,var(--accent-green) 100%);
      --radius-lg:32px;
      --radius-md:24px;
      --radius-sm:16px;
      --shadow-soft:0 8px 32px rgba(0,0,0,.06);
      --font-main:'Outfit',sans-serif;
      --font-head:'Space Grotesk',sans-serif;
      --font-mono:'Roboto Mono',monospace;
    }

    /* ---------- 2.  Reset & helpers -------------------------------- */
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:var(--font-main);background:transparent;color:var(--text-primary);
         height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none;
         -webkit-font-smoothing:antialiased}
    #rainCanvas{position:fixed;inset:0;z-index:-1;background:#ffffff}

    /* ---------- 3.  Header (glass-morphism) ------------------------ */
    .header{height:64px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;
            flex-shrink:0;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);
            border-bottom:1px solid rgba(0,0,0,.05);z-index:10}
    .header-left{display:flex;align-items:center;gap:12px}
    .vynix-logo{display:flex;align-items:center;gap:8px;cursor:pointer;padding:5px 10px;
                border-radius:12px;transition:transform .2s}
    .vynix-logo:active{transform:scale(.96)}
    .logo-icon{font-size:26px;background:var(--logo-gradient);-webkit-background-clip:text;
               -webkit-text-fill-color:transparent;font-variation-settings:'FILL' 1,'wght' 600}
    .logo-text{font-family:var(--font-head);font-size:22px;font-weight:700;letter-spacing:-.5px}
    .lingua-badge{background:var(--logo-gradient);color:#fff;font-size:10px;font-weight:700;
                  padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px}
    .lang-selector{position:relative;margin-left:auto;margin-right:12px}
    .lang-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface-color);
              border:none;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;
              color:var(--text-primary);transition:background .2s}
    .lang-btn:hover{background:#e0e0e0}
    .lang-dropdown{position:absolute;top:48px;right:0;background:#fff;border-radius:12px;
                   box-shadow:0 8px 24px rgba(0,0,0,.12);padding:8px;min-width:240px;
                   max-height:400px;overflow-y:auto;display:none;z-index:100}
    .lang-dropdown.open{display:block}
    .lang-option{padding:10px 14px;border-radius:8px;cursor:pointer;transition:background .2s;
                 display:flex;align-items:center;gap:10px;font-size:14px}
    .lang-option:hover{background:var(--surface-color)}
    .lang-option.active{background:var(--accent-blue);color:#fff}
    .lang-flag{font-size:20px}
    .lang-name{font-weight:600}
    .lang-native{font-size:12px;color:var(--text-muted)}
    .lang-option.active .lang-native{color:rgba(255,255,255,.8)}
    .profile-btn{width:40px;height:40px;border-radius:50%;border:none;background:var(--surface-color);
                 color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;
                 flex-shrink:0;transition:background .2s}
    .profile-btn:active{background:#e0e0e0}
    .profile-btn span{font-size:24px}

    /* ---------- 4.  Chat area -------------------------------------- */
    .chat-container{flex:1;overflow-y:auto;padding:20px 0 160px;display:flex;flex-direction:column;
                    scroll-behavior:smooth}
    .welcome-screen{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;
                    text-align:center;padding:40px;animation:fadeIn .5s ease}
    .welcome-icon{font-size:64px;background:var(--logo-gradient);-webkit-background-clip:text;
                  -webkit-text-fill-color:transparent;margin-bottom:24px;font-variation-settings:'wght' 200}
    .welcome-text{font-family:var(--font-head);font-size:32px;font-weight:600;margin-bottom:12px}
    .welcome-sub{color:var(--text-muted);font-size:16px;max-width:400px;line-height:1.5;margin-bottom:20px}
    .feature-pills{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap;justify-content:center}
    .pill{background:var(--surface-color);padding:8px 16px;border-radius:20px;font-size:13px;
          font-weight:500;color:var(--text-secondary);display:flex;align-items:center;gap:5px}
    .pill span{font-size:16px}

    /* ---------- 5.  Input bar -------------------------------------- */
    .input-wrapper-fixed{position:fixed;left:0;right:0;bottom:0;z-index:30;background:var(--bg-color);
                         padding:12px max(20px,env(safe-area-inset-left)) max(20px,env(safe-area-inset-bottom)) max(20px,env(safe-area-inset-right));
                         box-shadow:0 -2px 10px rgba(0,0,0,.04);display:flex;flex-direction:column;align-items:center}
    .input-wrapper{width:100%;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);
                   border-radius:28px;padding:6px;display:flex;align-items:center;transition:background .2s,box-shadow .2s;
                   border:1px solid rgba(0,0,0,.06)}
    .input-wrapper:focus-within{background:#fff;box-shadow:var(--shadow-soft);border-color:var(--accent-blue)}
    input{flex:1;border:none;background:none;outline:none;font-size:16px;font-family:var(--font-main);
          color:var(--text-primary);padding:12px 14px;user-select:text}
    .mic-btn,.send-btn,.translate-btn{width:44px;height:44px;border-radius:50%;border:none;background:transparent;
                                       color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;
                                       transition:all .2s;flex-shrink:0}
    .mic-btn.listening{color:#dc2626;background:rgba(220,38,38,.1);animation:pulse-red 1.5s infinite}
    .send-btn.active{background:#1e1e1e;color:#fff}
    .translate-btn.active{background:var(--accent-green);color:#fff}
    .send-btn span,.translate-btn span{font-size:22px}
    .disclaimer{font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center;opacity:.8}

    /* ---------- 6.  Messages --------------------------------------- */
    .message-row{display:flex;margin-bottom:20px;max-width:80%;position:relative}
    .timestamp{font-size:10px;color:var(--text-muted);position:absolute;bottom:-15px}
    .message-row.user{margin-left:auto;text-align:right;flex-direction:column;align-items:flex-end}
    .message-row.user .timestamp{right:0}
    .message-row.ai{margin-right:auto;padding-left:50px;flex-direction:column;align-items:flex-start}
    .message-row.ai .timestamp{left:50px}
    .message-content{padding:14px 18px;border-radius:20px;line-height:1.6;text-align:left;font-size:15px;
                     white-space:pre-wrap;overflow-wrap:break-word;word-wrap:break-word;max-width:100%;
                     display:inline-block}
    .message-row.user .message-content{background:var(--logo-gradient);color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 5px rgba(37,99,235,.2)}
    .message-row.ai  .message-content{background:rgba(255,255,255,.95);border-top-left-radius:4px;
                                      box-shadow:var(--shadow-soft)}
    .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
            flex-shrink:0;position:absolute}
    .message-row.ai .avatar{background:var(--logo-gradient);color:#fff;font-size:22px;left:0;top:-10px}
    .lang-badge-msg{position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,var(--accent-green) 0%,#059669 100%);
                    color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase}
    .copy-actions{position:absolute;top:0;right:0;z-index:2;margin-top:-10px;margin-right:-10px;opacity:0;transition:opacity .3s;display:flex;gap:5px}
    .message-row.ai:hover .copy-actions{opacity:1}
    .copy-btn,.speak-btn{background:rgba(0,0,0,.7);color:#fff;border:none;padding:5px 12px;border-radius:50px;
                         font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:4px;
                         backdrop-filter:blur(5px)}
    .copy-btn span,.speak-btn span{font-size:16px;transition:transform .1s}
    .copy-btn:active span,.speak-btn:active span{transform:scale(.9)}
    .message-content pre{background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:8px;overflow-x:auto;
                         font-family:var(--font-mono);font-size:13px;margin:10px -18px}
    .message-content code{background:rgba(0,0,0,.05);padding:2px 4px;border-radius:4px;font-family:var(--font-mono)}
    .message-content pre code{background:none;padding:0}
    .thinking{display:flex;gap:5px;padding:10px 0}
    .dot{width:5px;height:5px;background:#9aa0a6;border-radius:50%;animation:pulse 1s infinite alternate}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}

    /* ---------- 7.  Bottom-sheet ----------------------------------- */
    .bottom-sheet{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.98);
                  backdrop-filter:blur(20px);border-top:1px solid rgba(0,0,0,.05);
                  border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;z-index:50;
                  box-shadow:0 -5px 20px rgba(0,0,0,.1);transform:translateY(100%);
                  transition:transform .3s ease-out;max-height:90vh;overflow-y:auto}
    .bottom-sheet.open{transform:translateY(0)}
    .sheet-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);
                   z-index:40;opacity:0;pointer-events:none;transition:opacity .3s}
    .sheet-overlay.open{opacity:1;pointer-events:all}
    .sheet-header{font-size:20px;font-weight:700;margin-bottom:20px;text-align:center;position:relative}
    .sheet-close-btn{position:absolute;right:0;top:0;background:none;border:none;cursor:pointer;
                     color:var(--text-muted);padding:4px}
    .sheet-tab-bar{display:flex;border-bottom:1px solid var(--surface-color);margin-bottom:20px}
    .sheet-tab{flex:1;text-align:center;padding:10px 0;cursor:pointer;font-weight:500;
               color:var(--text-muted);border-bottom:2px solid transparent;
               transition:color .2s,border-color .2s}
    .sheet-tab.active{color:var(--accent-blue);border-bottom-color:var(--accent-blue)}
    .sheet-tab-content{padding:10px 0}
    .sheet-input{width:100%;padding:12px;margin-bottom:15px;border:1px solid var(--surface-color);
                 border-radius:10px;font-family:var(--font-main);font-size:16px;background:var(--input-bg)}
    .sheet-btn{width:100%;padding:14px;border:none;border-radius:50px;font-weight:700;font-size:16px;
               cursor:pointer;transition:opacity .2s,transform .2s;margin-top:10px;
               display:flex;align-items:center;justify-content:center;gap:10px}
    .sheet-btn:active{transform:scale(.98)}
    .sheet-btn-primary{background:var(--logo-gradient);color:#fff;box-shadow:0 4px 15px rgba(37,99,235,.3)}
    .sheet-btn-google{background:#fff;color:var(--text-primary);border:1px solid #ccc;margin-bottom:15px}
    .sheet-btn-google img{width:20px;height:20px}
    .sheet-btn-logout{background:#dc2626;color:#fff;margin-top:20px}
    .user-avatar-large{width:80px;height:80px;border-radius:50%;background:var(--logo-gradient);
                       margin:0 auto 15px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:40px}
    .user-email-text{text-align:center;color:var(--text-muted);font-size:14px;margin-top:-10px;margin-bottom:20px}
    .user-info-group{margin-bottom:20px;padding:15px;background:var(--surface-color);border-radius:12px}
    .user-info-group label{display:block;font-size:12px;font-weight:500;color:var(--text-secondary);margin-bottom:5px}

    /* ---------- 8.  Snackbar --------------------------------------- */
    #customSnackbar{visibility:hidden;min-width:250px;background:#333;color:#fff;text-align:center;
                     border-radius:8px;padding:12px;position:fixed;z-index:1000;left:50%;bottom:100px;
                     transform:translateX(-50%);box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;
                     transition:opacity .3s,bottom .3s;font-size:14px;font-weight:500}
    #customSnackbar.show{visibility:visible;opacity:1;bottom:80px}

    /* ---------- 9.  Animations ------------------------------------- */
    @keyframes pulse-red{0%{box-shadow:0 0 0 0 rgba(220,38,38,.4)}70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{to{opacity:.3;transform:translateY(-2px)}}

    /* ---------- 10. Scroll-bar ------------------------------------- */
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-thumb{background:rgba(0,0,0,.15);border-radius:3px}
    .tokens-remaining {
  width: 100%;
  padding: 8px 14px 4px;
  font-size: 12px;
  color: var(--text-muted);
  text-align: left;
  opacity: 0.9;
  transition: color 0.3s;
}

.tokens-remaining.low {
  color: #dc2626;
}

#remainingCount {
  font-weight: 600;
  color: var(--text-secondary);
}

.tokens-remaining.low #remainingCount {
  color: #dc2626;
}
  </style>
</head>

<body>
  <!-- Rain canvas (same as landing page) -->
  <canvas id="rainCanvas"></canvas>

  <!-- Snackbar -->
  <div id="customSnackbar"></div>

  <!-- Overlays / sheets -->
  <div class="sheet-overlay" id="sheetOverlay"></div>
  <div class="bottom-sheet" id="userSheet">
    <div class="sheet-header">
      Account Settings
      <button class="sheet-close-btn" onclick="closeSheet('user')"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="user-avatar-large"><span class="material-symbols-rounded">person</span></div>
    <div class="user-email-text" id="userEmail">example@email.com</div>
    <div class="user-info-group">
      <label for="userNameInput">Display Name</label>
      <input type="text" id="userNameInput" class="sheet-input" placeholder="Enter your name">
      <button class="sheet-btn sheet-btn-primary" onclick="updateDisplayName()">Save Name</button>
    </div>
    <button class="sheet-btn sheet-btn-logout" onclick="logout()">
      <span class="material-symbols-rounded" style="font-size:18px">logout</span> Logout
    </button>
  </div>

  <div class="bottom-sheet" id="authSheet">
    <div class="sheet-header">
      Welcome to Vynix Lingua
      <!--  official â€œSign in with Googleâ€ button â€“ light theme  -->
<button class="sheet-btn sheet-btn-google" onclick="signInWithGoogle()" aria-label="Sign in with Google">
  <!--  Google-supplied colour icon (SVG, 18Ã—18)  -->
  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd"
          d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
          fill="#4285F4"/>
    <path fill-rule="evenodd" clip-rule="evenodd"
          d="M9 18c3.24 0 5.97-1.075 7.956-2.92l-2.908-2.26c-1.075.72-2.456 1.155-4.048 1.155-3.097 0-5.716-2.092-6.655-4.906H.89v2.332A8.997 8.997 0 0 0 9 18z"
          fill="#34A853"/>
    <path fill-rule="evenodd" clip-rule="evenodd"
          d="M2.345 10.064A5.367 5.367 0 0 1 2.345 7.94V5.608H.89a8.997 8.997 0 0 0 0 8.088l1.455-1.332z"
          fill="#FBBC05"/>
    <path fill-rule="evenodd" clip-rule="evenodd"
          d="M9 3.58c1.592 0 3.022.546 4.14 1.61l3.067-3.067C14.97.84 12.24 0 9 0 5.49 0 2.276 1.917.89 4.876l2.455 1.884C3.748 4.67 6.167 3.58 9 3.58z"
          fill="#EA4335"/>
  </svg>
  <span style="font-family:'Roboto',sans-serif;font-weight:500;font-size:14px;color:#1F1F1F">Sign in with Google</span>
</button>
    </div>
  
    <div class="sheet-tab-bar" id="authTabs">
      <div class="sheet-tab active" data-tab="signin">Sign In</div>
      <div class="sheet-tab" data-tab="signup">Sign Up</div>
    </div>
    <div id="signin-content" class="sheet-tab-content">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signInEmail">
      <input type="password" placeholder="Password" class="sheet-input" id="signInPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignIn()">Sign In</button>
    </div>
    <div id="signup-content" class="sheet-tab-content" style="display:none">
      <input type="text" placeholder="Display Name" class="sheet-input" id="signUpName">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signUpEmail">
      <input type="password" placeholder="Password (min 6 chars)" class="sheet-input" id="signUpPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignUp()">Sign Up</button>
    </div>
  </div>

  <!-- ---------- Header ------------------------------------------ -->
  <header class="header">
    <div class="header-left">
      <div class="vynix-logo" onclick="location.reload()">
        <span class="material-symbols-rounded logo-icon">auto_awesome</span>
        <span class="logo-text">Vynix</span>
        <span class="lingua-badge">Lingua</span>
      </div>
    </div>

    <div class="lang-selector">
      <button class="lang-btn" id="langBtn">
        <span class="material-symbols-rounded">translate</span>
        <span id="currentLangText">English</span>
      </button>
      <div class="lang-dropdown" id="langDropdown"></div>
    </div>

    <button class="profile-btn" id="profileBtn">
      <span class="material-symbols-rounded">person</span>
    </button>
  </header>

  <!-- ---------- Chat area --------------------------------------- -->
  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <div class="welcome-text" id="welcomeText">Sawubona! How can I help?</div>
      <div class="welcome-sub">I'm Vynix Lingua â€“ your multilingual African AI assistant. I speak 11 African languages and understand local slang!</div>
      <div class="feature-pills">
        <div class="pill"><span class="material-symbols-rounded">school</span>Education</div>
        <div class="pill"><span class="material-symbols-rounded">code</span>Coding</div>
        <div class="pill"><span class="material-symbols-rounded">auto_stories</span>Stories</div>
        <div class="pill"><span class="material-symbols-rounded">translate</span>11 Languages</div>
      </div>
    </div>
    <div id="messagesList"></div>
  </main>

  <!-- ---------- Input bar --------------------------------------- -->
  <div class="input-wrapper-fixed">
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn"><span class="material-symbols-rounded">mic</span></button>
      <input type="text" id="input" placeholder="Message Vynix Lingua..." autocomplete="off">
      <div id="tokensRemaining" class="tokens-remaining">
  <span>Daily tokens remaining: </span>
  <span id="remainingCount">Loading...</span>
</div>
      <button class="translate-btn" id="translateBtn" title="Auto-translate"><span class="material-symbols-rounded">g_translate</span></button>
      <button class="send-btn" id="sendBtn"><span class="material-symbols-rounded">arrow_upward</span></button>
    </div>
    <p class="disclaimer">Vynix Lingua speaks 11 African languages. Responses may vary.</p>
  </div>

  <!-- ---------- Scripts ----------------------------------------- -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    const db = getFirestore(app);
const DAILY_TOKEN_LIMIT = 10000; // Adjust this number to your desired daily token limit per user
    await fetchAndActivate(rc);
    const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";

    const LANGUAGES = {
      en: { name: 'English', native: 'English', flag: 'ðŸ‡¬ðŸ‡§', code: 'en-US', greeting: 'Hello' },
      zu: { name: 'Zulu', native: 'isiZulu', flag: 'ðŸ‡¿ðŸ‡¦', code: 'zu-ZA', greeting: 'Sawubona' },
      xh: { name: 'Xhosa', native: 'isiXhosa', flag: 'ðŸ‡¿ðŸ‡¦', code: 'xh-ZA', greeting: 'Molo' },
      af: { name: 'Afrikaans', native: 'Afrikaans', flag: 'ðŸ‡¿ðŸ‡¦', code: 'af-ZA', greeting: 'Hallo' },
      st: { name: 'Sotho', native: 'Sesotho', flag: 'ðŸ‡¿ðŸ‡¦', code: 'st-ZA', greeting: 'Lumela' },
      tn: { name: 'Tswana', native: 'Setswana', flag: 'ðŸ‡§ðŸ‡¼', code: 'tn-ZA', greeting: 'Dumela' },
      sw: { name: 'Swahili', native: 'Kiswahili', flag: 'ðŸ‡°ðŸ‡ª', code: 'sw-KE', greeting: 'Jambo' },
      yo: { name: 'Yoruba', native: 'YorÃ¹bÃ¡', flag: 'ðŸ‡³ðŸ‡¬', code: 'yo-NG', greeting: 'Bawo' },
      ig: { name: 'Igbo', native: 'Asá»¥sá»¥ Igbo', flag: 'ðŸ‡³ðŸ‡¬', code: 'ig-NG', greeting: 'Ndewo' },
      ha: { name: 'Hausa', native: 'Hausa', flag: 'ðŸ‡³ðŸ‡¬', code: 'ha-NG', greeting: 'Sannu' },
      am: { name: 'Amharic', native: 'áŠ áˆ›áˆ­áŠ›', flag: 'ðŸ‡ªðŸ‡¹', code: 'am-ET', greeting: 'áˆ°áˆ‹áˆ' }
    };

    const SLANG_DICTIONARY = {
      eish: { lang: 'zu', meaning: 'Expression of surprise or sympathy', translation: 'Oh my!' },
      yebo: { lang: 'zu', meaning: 'Yes', translation: 'Yes' },
      cha: { lang: 'zu', meaning: 'No', translation: 'No' },
      howzit: { lang: 'af', meaning: 'How are you?', translation: 'How are you?' },
      lekker: { lang: 'af', meaning: 'Nice/good', translation: 'Nice' },
      braai: { lang: 'af', meaning: 'Barbecue', translation: 'Barbecue' },
      molo: { lang: 'xh', meaning: 'Hello (singular)', translation: 'Hello' },
      molweni: { lang: 'xh', meaning: 'Hello (plural)', translation: 'Hello everyone' },
      sharp: { lang: 'multi', meaning: 'OK/bye', translation: 'OK' },
      ja: { lang: 'af', meaning: 'Yes', translation: 'Yes' },
      nee: { lang: 'af', meaning: 'No', translation: 'No' },
      ayoba: { lang: 'multi', meaning: 'Awesome/cool', translation: 'Awesome!' },
      'shap shap': { lang: 'multi', meaning: 'Quickly/hurry', translation: 'Hurry up' },
      'now now': { lang: 'multi', meaning: 'Soon', translation: 'In a moment' },
      'just now': { lang: 'multi', meaning: 'Later', translation: 'Later' }
    };

    let currentLang = 'en';
    let autoTranslate = false;
    let historyStack = [];

    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn'), $mic = $('#micBtn');
    const $translate = $('#translateBtn'), $list = $('#messagesList');
    const $welcome = $('#welcomeScreen'), $welcomeText = $('#welcomeText');
    const $profileBtn = $('#profileBtn'), $userSheet = $('#userSheet');
    const $authSheet = $('#authSheet'), $sheetOverlay = $('#sheetOverlay');
    const $langBtn = $('#langBtn'), $langDropdown = $('#langDropdown');
    const $currentLangText = $('#currentLangText');
    const $customSnackbar = $('#customSnackbar');

    function initLanguageDropdown() {
      $langDropdown.innerHTML = Object.keys(LANGUAGES).map(code => {
        const lang = LANGUAGES[code];
        return `
          <div class="lang-option ${code === currentLang ? 'active' : ''}" data-lang="${code}">
            <span class="lang-flag">${lang.flag}</span>
            <div class="lang-info">
              <div class="lang-name">${lang.name}</div>
              <div class="lang-native">${lang.native}</div>
            </div>
          </div>
        `;
      }).join('');
      document.querySelectorAll('.lang-option').forEach(opt => {
        opt.addEventListener('click', () => switchLanguage(opt.dataset.lang));
      });
    }

    function switchLanguage(langCode) {
      currentLang = langCode;
      const lang = LANGUAGES[langCode];
      $currentLangText.textContent = lang.name;
      $langDropdown.classList.remove('open');
      document.querySelectorAll('.lang-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.lang === langCode);
      });
      updateSystemInstructions();
      showCustomSnackbar(`Language switched to ${lang.name}`);
      const user = auth.currentUser;
      if (user && user.displayName) {
        const firstName = user.displayName.split(' ')[0];
        $welcomeText.textContent = `${lang.greeting} ${firstName}! How can I help?`;
      } else {
        $welcomeText.textContent = `${lang.greeting}! How can I help?`;
      }
    }

    function updateSystemInstructions() {
      const lang = LANGUAGES[currentLang];
      const systemPrompt = `You are Vynix Lingua, a multilingual African AI assistant fluent in ${lang.name} (${lang.native}).
CRITICAL INSTRUCTIONS:
1. ALWAYS respond in ${lang.name} when the user's selected language is ${lang.name}.
2. Understand and interpret African slang from all South African languages.
3. Be culturally aware and sensitive to African contexts.
4. For education: Expert in South African CAPS curriculum (Grades R-12).
5. For coding: Provide clean, modern code with clear explanations.
6. For storytelling: Be creative and engaging.
SLANG INTERPRETATION:
- Recognize common slang like "eish", "yebo", "howzit", "lekker", "braai", "sharp", "ayoba"
- Explain slang meanings when asked
- Use appropriate slang naturally in responses when suitable
TRANSLATION MODE:
- When asked to translate, provide accurate translations
- Explain cultural context when relevant
- Help with pronunciation when needed
Keep responses conversational, accurate, and culturally relevant. Use ${lang.name} as the primary response language unless the user specifically asks for English or another language.`;
      historyStack = [{ role: 'system', content: systemPrompt }];
    }

    $langBtn.addEventListener('click', () => $langDropdown.classList.toggle('open'));
    document.addEventListener('click', e => {
      if (!$langBtn.contains(e.target) && !$langDropdown.contains(e.target)) $langDropdown.classList.remove('open');
    });

    $translate.addEventListener('click', () => {
      autoTranslate = !autoTranslate;
      $translate.classList.toggle('active', autoTranslate);
      showCustomSnackbar(autoTranslate ? 'Auto-translate enabled' : 'Auto-translate disabled');
    });

    function formatTime(date) {
      const h = date.getHours().toString().padStart(2, '0');
      const m = date.getMinutes().toString().padStart(2, '0');
      return `${h}:${m}`;
    }

    function showCustomSnackbar(msg) {
      $customSnackbar.textContent = msg;
      $customSnackbar.classList.add('show');
      setTimeout(() => $customSnackbar.classList.remove('show'), 3000);
    }

async function checkAndUpdateTokenUsage(tokensToAdd) {
  const user = auth.currentUser;
  if (!user) return true;

  const uid = user.uid;
  const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD format
  const usageRef = doc(db, 'tokenUsage', uid);

  try {
    const snap = await getDoc(usageRef);
    const data = snap.data() || {};

    if (data.date !== today) {
      // New day â†’ reset counter
      await setDoc(usageRef, {
        date: today,
        used: tokensToAdd,
        timestamp: serverTimestamp()
      });
      return true;
    }

    const newTotal = data.used + tokensToAdd;
    if (newTotal > DAILY_TOKEN_LIMIT) {
      showCustomSnackbar(`Daily limit reached (${DAILY_TOKEN_LIMIT.toLocaleString()} tokens). Reset tomorrow.`);
      return false;
    }

    // Update used tokens
    await setDoc(usageRef, { used: newTotal, timestamp: serverTimestamp() }, { merge: true });
    return true;
  } catch (error) {
    console.error('Token usage update failed:', error);
    showCustomSnackbar('Error checking limit. Try again.');
    return false;
  }
            }



    async function updateRemainingTokensDisplay() {
  const user = auth.currentUser;
  const \( tokensEl = \)('#tokensRemaining');
  const \( countEl = \)('#remainingCount');

  if (!user || !$tokensEl) {
    if ($tokensEl) $tokensEl.style.display = 'none';
    return;
  }

  $tokensEl.style.display = 'block';

  try {
    const uid = user.uid;
    const today = new Date().toISOString().slice(0, 10);
    const usageRef = doc(db, 'tokenUsage', uid);
    const snap = await getDoc(usageRef);
    const data = snap.data();

    let remaining;
    if (!data || data.date !== today) {
      remaining = DAILY_TOKEN_LIMIT;
    } else {
      remaining = DAILY_TOKEN_LIMIT - data.used;
    }

    $countEl.textContent = remaining.toLocaleString();

    // Visual warning when low
    if (remaining < 1000) {
      $tokensEl.classList.add('low');
    } else {
      $tokensEl.classList.remove('low');
    }

    // Hide completely if limit is effectively unlimited (e.g., very high)
    // Remove this block if you always want to show it
    if (remaining >= DAILY_TOKEN_LIMIT) {
      $countEl.textContent = 'Unlimited';
    }
  } catch (error) {
    console.error('Failed to fetch remaining tokens:', error);
    $countEl.textContent = 'Error';
  }
}
    

    window.closeSheet = type => {
      $sheetOverlay.classList.remove('open');
      type === 'user' ? $userSheet.classList.remove('open') : $authSheet.classList.remove('open');
    };
    $sheetOverlay.addEventListener('click', () => closeSheet('user') || closeSheet('auth'));

    $profileBtn.addEventListener('click', () => {
      const user = auth.currentUser;
      user ? (document.getElementById('userNameInput').value = user.displayName || '', document.getElementById('userEmail').textContent = user.email || 'No email', openSheet('user')) : openSheet('auth');
    });

    /* ----------  bottom-sheet helpers  ---------- */
window.openSheet = type => {
  $sheetOverlay.classList.add('open');
  type === 'user' ? $userSheet.classList.add('open') : $authSheet.classList.add('open');
};

    document.getElementById('authTabs').addEventListener('click', e => {
      const tab = e.target.closest('.sheet-tab');
      if (!tab) return;
      const target = tab.dataset.tab;
      document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sheet-tab-content').forEach(c => c.style.display = 'none');
      tab.classList.add('active');
      document.getElementById(`${target}-content`).style.display = 'block';
    });

    window.updateDisplayName = async () => {
      const name = document.getElementById('userNameInput').value.trim();
      const user = auth.currentUser;
      if (!user || name === user.displayName) return;
      try {
        await updateProfile(user, { displayName: name });
        showCustomSnackbar('Display name updated!');
        const lang = LANGUAGES[currentLang];
        $welcomeText.textContent = `${lang.greeting} ${name.split(' ')[0]}! How can I help?`;
        closeSheet('user');
      } catch (e) {
        showCustomSnackbar('Failed to update name: ' + e.message);
      }
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        showCustomSnackbar('Logged out successfully.');
        closeSheet('user');
      } catch (e) {
        showCustomSnackbar('Logout failed.');
      }
    };

    window.signInWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        showCustomSnackbar('Google Sign-In failed: ' + e.message);
      }
    };

    window.handleSignIn = async () => {
      const email = document.getElementById('signInEmail').value.trim();
      const password = document.getElementById('signInPassword').value;
      if (!email || !password) return showCustomSnackbar('Please enter both email and password.');
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        let msg = 'Sign-In failed.';
        if (e.code === 'auth/user-not-found') msg = 'No user found with this email.';
        else if (e.code === 'auth/wrong-password') msg = 'Incorrect password.';
        showCustomSnackbar(msg);
      }
    };

    window.handleSignUp = async () => {
      const name = document.getElementById('signUpName').value.trim();
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value;
      if (!name || !email || password.length < 6) return showCustomSnackbar('Please enter valid details (password min 6 chars).');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: name });
      } catch (e) {
        let msg = 'Sign-Up failed.';
        if (e.code === 'auth/email-already-in-use') msg = 'Email already in use.';
        showCustomSnackbar(msg);
      }
    };

    onAuthStateChanged(auth, user => {
      const lang = LANGUAGES[currentLang];
      if (user) {
        if (user.displayName) {
          const firstName = user.displayName.split(' ')[0];
          $welcomeText.textContent = `${lang.greeting} ${firstName}! How can I help?`;
        } else {
          $welcomeText.textContent = `${lang.greeting}! How can I help?`;
        }
        closeSheet('auth');
      } else {
        $welcomeText.textContent = `${lang.greeting}! How can I help?`;
      }
      updateRemainingTokensDisplay();
    });

    function parseMarkdown(text) {
      let html = text.replace(/```([\s\S]*?)```/g, (m, c) => `<pre><code>${c.trim()}</code></pre>`);
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>')
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\*(.*?)\*/g, '<em>$1</em>');
      html = html.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>');
      if (html.includes('<li>')) {
        html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
        html = html.replace(/<\/ul><ul>/g, '');
      }
      html = html.split('<pre>').map((seg, i) => i % 2 === 0 ? seg.replace(/\n/g, '<br>') : seg).join('<pre>');
      html = html.replace(/<br><pre>/g, '<pre>').replace(/<\/pre><br>/g, '</pre>');
      return html;
    }

    function detectSlang(text) {
      const words = text.toLowerCase().split(/\s+/);
      const detected = [];
      for (const w of words) if (SLANG_DICTIONARY[w]) detected.push({ word: w, ...SLANG_DICTIONARY[w] });
      return detected;
    }

    function addMessage(text, type, showLangBadge = false) {
      $welcome.style.display = 'none';
      const row = document.createElement('div');
      row.className = `message-row ${type}`;
      const content = document.createElement('div');
      content.className = 'message-content';
      content.innerHTML = parseMarkdown(text);
      if (showLangBadge && currentLang !== 'en') {
        const badge = document.createElement('div');
        badge.className = 'lang-badge-msg';
        badge.textContent = LANGUAGES[currentLang].native;
        content.appendChild(badge);
      }
      const time = document.createElement('div');
      time.className = 'timestamp';
      time.textContent = formatTime(new Date());
      if (type === 'ai') {
        const avatar = document.createElement('div');
        avatar.className = 'avatar ai';
        avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
        const actions = document.createElement('div');
        actions.className = 'copy-actions';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = '<span class="material-symbols-rounded">content_copy</span> Copy';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(content.textContent.replace(/Copy$/, '').trim());
          copyBtn.innerHTML = '<span class="material-symbols-rounded">check</span> Copied';
          setTimeout(() => copyBtn.innerHTML = '<span class="material-symbols-rounded">content_copy</span> Copy', 2000);
        });
        const speakBtn = document.createElement('button');
        speakBtn.className = 'speak-btn';
        speakBtn.innerHTML = '<span class="material-symbols-rounded">volume_up</span> Speak';
        speakBtn.addEventListener('click', () => {
          if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(content.textContent);
            utterance.lang = LANGUAGES[currentLang].code;
            speechSynthesis.speak(utterance);
          }
        });
        actions.append(copyBtn, speakBtn);
        content.appendChild(actions);
        row.append(avatar, content, time);
      } else {
        row.append(content, time);
      }
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function addLoading() {
      const row = document.createElement('div');
      row.id = 'loading';
      row.className = 'message-row ai';
      const avatar = document.createElement('div');
      avatar.className = 'avatar ai';
      avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
      const content = document.createElement('div');
      content.className = 'message-content';
      content.innerHTML = '<div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      row.append(avatar, content);
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function removeLoading() {
      const loading = $('#loading');
      if (loading) loading.remove();
    }

    window.sendMessage = async () => {
  const msg = $i.value.trim();
  if (!msg) return;

  if (!auth.currentUser) {
    showCustomSnackbar('You must be logged in to chat.');
    openSheet('auth');
    return;
  }

  $i.value = '';
  $send.classList.remove('active');
  addMessage(msg, 'user');

  const slang = detectSlang(msg);
  if (slang.length > 0 && (msg.toLowerCase().includes('what does') || msg.toLowerCase().includes('meaning'))) {
    const expl = slang.map(s => `**\( {s.word}** ( \){LANGUAGES[s.lang].name}): \( {s.meaning} â€“ â€œ \){s.translation}â€`).join('\n\n');
    addMessage(`Here are the slang terms I found:\n\n${expl}`, 'ai', true);
    return;
  }

  // Rough token estimation: ~4 chars per token + overhead
  const estimatedInputTokens = Math.ceil(msg.length / 4) + 200; // +200 for system prompt/history overhead

  const allowed = await checkAndUpdateTokenUsage(estimatedInputTokens);
  if (!allowed) {
    addMessage('You have reached your daily token limit. Please try again tomorrow.', 'ai');
    updateRemainingTokensDisplay();
    return;
  }

  addLoading();

  try {
    const messages = [...historyStack, { role: 'user', content: msg }];
    const res = await fetch('https://api.x.ai/v1/chat/completions', {
      method: 'POST',
      headers: { Authorization: `Bearer ${XAI_KEY}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'grok-4-1-fast-non-reasoning',
        messages,
        temperature: 0.7,
        max_tokens: 1500
      })
    });

    removeLoading();

    if (!res.ok) {
      // Refund input tokens on error
      await checkAndUpdateTokenUsage(-estimatedInputTokens);
      throw new Error(`API error: ${res.status}`);
    }

    const data = await res.json();
    const reply = data.choices[0]?.message?.content?.trim() || 'No response.';

    // Estimate output tokens and charge them
    const outputTokens = Math.ceil(reply.length / 4);
    await checkAndUpdateTokenUsage(outputTokens);

    addMessage(reply, 'ai', currentLang !== 'en');
    historyStack.push({ role: 'user', content: msg }, { role: 'assistant', content: reply });
    updateRemainingTokensDisplay();
  } catch (e) {
    removeLoading();
    addMessage('Connection error. Please try again later.', 'ai');
    console.error(e);
  }
};
    $i.addEventListener('input', () => $send.classList.toggle('active', $i.value.trim().length > 0));
    $i.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    $send.addEventListener('click', sendMessage);

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SR();
      rec.continuous = false;
      rec.interimResults = false;
      $mic.addEventListener('click', () => {
        if (!auth.currentUser) {
          showCustomSnackbar('You must be logged in to use voice.');
          openSheet('auth');
          return;
        }
        rec.lang = LANGUAGES[currentLang].code;
        rec.start();
      });
      rec.onstart = () => {
        $mic.classList.add('listening');
        $i.placeholder = 'Listening...';
      };
      rec.onresult = e => {
        $i.value = e.results[0][0].transcript;
        sendMessage();
      };
      rec.onend = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Message Vynix Lingua...';
      };
      rec.onerror = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Message Vynix Lingua...';
      };
    } else {
      $mic.style.display = 'none';
    }

    initLanguageDropdown();
    // Add this:
updateRemainingTokensDisplay();
    updateSystemInstructions();

    /* ---------- Rain animation (same as landing page) ------------- */
    const canvas = document.createElement('canvas');
    canvas.id = 'rainCanvas';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let w, h, drops = [];
    const colors = ['#2563eb', '#d946ef', '#10b981', '#cbd5e1'];

    function resize() {
      w = innerWidth;
      h = innerHeight;
      canvas.width = w;
      canvas.height = h;
      drops = [];
      const count = Math.floor(w / 15);
      for (let i = 0; i < count; i++) drops.push({ x: Math.random() * w, y: Math.random() * h, len: Math.random() * 20 + 10, speed: Math.random() * 3 + 2, color: colors[Math.floor(Math.random() * colors.length)], opacity: Math.random() * 0.5 + 0.1 });
    }
    addEventListener('resize', resize);
    resize();

    function draw() {
      ctx.clearRect(0, 0, w, h);
      for (const d of drops) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x, d.y + d.len);
        ctx.strokeStyle = d.color;
        ctx.lineWidth = 1;
        ctx.globalAlpha = d.opacity;
        ctx.stroke();
        d.y += d.speed;
        if (d.y > h) {
          d.y = -d.len;
          d.x = Math.random() * w;
        }
      }
      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>
