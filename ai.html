<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyBuddy ‚Äì AI Tutor Grade 1-12</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    .top-bar { height: 64px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; }
    .logo { width: 42px; height: 42px; background: black; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .logo svg { width: 28px; height: 28px; fill: white; }

    .chat-area { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 160px; display: flex; flex-direction: column; gap: 1rem; -webkit-overflow-scrolling: touch; }
    .message { max-width: 82%; padding: 1rem 1.3rem; border-radius: 20px; line-height: 1.6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message.user { align-self: flex-end; background: #6366f1; color: white; }
    .message.ai { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #1f2937; }

    .input-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; padding: 1rem; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 20; }
    .input-box { background: #f1f5f9; border-radius: 28px; padding: 0.9rem 1.2rem; display: flex; align-items: center; gap: 12px; }
    #chatInput { flex: 1; border: none; outline: none; background: none; font-size: 1.05rem; }
    .send-btn { width: 52px; height: 52px; background: #6366f1; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 24px; padding: 2rem; width: 90%; max-width: 420px; text-align: center; }
    .role-btn { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 18px; padding: 1.8rem; margin: 1rem 0; cursor: pointer; transition: 0.3s; font-weight: 600; }
    .role-btn:hover { border-color: #6366f1; background: #eef2ff; }

    #userPlanBadge { margin: 1rem; padding: 0.8rem 1.4rem; border-radius: 9999px; background: #6366f1; color: white; font-weight: 700; font-size: 0.95rem; text-align: center; }
    #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 0.8rem 1.6rem; border-radius: 9999px; opacity: 0; transition: opacity 0.3s; z-index: 50; }
    #toast.show { opacity: 1; }
    #api-status { width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 10px red; transition: 0.4s; }
    #api-status.connected { background: lime; box-shadow: 0 0 20px lime; }
  </style>
</head>
<body>

  <header class="top-bar">
    <button id="menuBtn" class="text-2xl">‚ò∞</button>
    <div class="logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
    <div id="api-status"></div>
  </header>

  <section id="chatPane" class="chat-area">
    <div id="welcome" class="text-center mt-24">
      <h1 class="text-3xl font-bold text-gray-800">Hey! I'm StudyBuddy üëã</h1>
      <p class="text-gray-600 mt-3 text-lg">Your personal AI tutor for Grade 1‚Äì12 (CAPS)</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-box">
      <input id="chatInput" type="text" placeholder="Ask anything or upload homework photo..." autocomplete="off">
      <button id="sendBtn" class="send-btn" disabled>‚úà</button>
    </div>
    <div class="mt-3 flex items-center gap-3 text-sm text-gray-600">
      <button id="uploadBtnInner">üì∏ Upload photo</button>
      <span id="fileName" class="truncate max-w-xs"></span>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
    </div>
  </div>

  <!-- First-Time Role Modal -->
  <div id="roleModal" class="modal">
    <div class="modal-content">
      <h2 class="text-3xl font-bold mb-6">Welcome to StudyBuddy! üéâ</h2>
      <p class="text-lg mb-8">Are you a <strong>Student</strong> or <strong>Teacher</strong>?</p>
      <div id="studentBtn" class="role-btn">
        <div class="text-2xl mb-2">üë©‚Äçüéì I'm a Student</div>
        <div class="text-3xl font-bold text-indigo-600">R29/month</div>
      </div>
      <div id="teacherBtn" class="role-btn">
        <div class="text-2xl mb-2">üë®‚Äçüè´ I'm a Teacher</div>
        <div class="text-3xl font-bold text-purple-600">R299/month</div>
        <div class="text-sm text-gray-600 mt-1">Unlimited students</div>
      </div>
    </div>
  </div>

  <!-- Upgrade Modal -->
  <div id="upgradeModal" class="modal">
    <div class="modal-content">
      <h2 class="text-3xl font-bold mb-4">Daily Limit Reached!</h2>
      <p class="text-lg mb-8">Upgrade for unlimited AI tutoring</p>
      <button id="upgradeStudent" class="w-full bg-indigo-600 text-white py-5 rounded-2xl text-xl font-bold mb-4">Student Plan ‚Äì R29/month</button>
      <button id="upgradeTeacher" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-5 rounded-2xl text-xl font-bold">Teacher Plan ‚Äì R299/month</button>
      <button id="closeUpgrade" class="mt-6 text-gray-500 text-lg">Maybe later</button>
    </div>
  </div>

  <aside id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-white shadow-2xl transform -translate-x-full transition z-50 overflow-y-auto">
    <div class="p-6 bg-gradient-to-br from-indigo-600 to-purple-700 text-white text-center">
      <div class="logo mx-auto mb-4"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
      <div id="slideName" class="text-xl font-bold">Loading...</div>
    </div>
    <button id="newConvBtn" class="w-full py-5 bg-indigo-600 text-white font-bold text-lg">+ New Session</button>
    <div id="userPlanBadge">Free Plan ‚Ä¢ 15,000 tokens/day</div>
    <div id="convList" class="flex-1"></div>
  </aside>

  <div id="overlay" class="fixed inset-0 bg-black/60 hidden z-40"></div>
  <div id="toast">Message</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const remoteConfig = getRemoteConfig(app);
    remoteConfig.settings.minimumFetchIntervalMillis = 3600000;

    // ====== YOUR CLOUDINARY DETAILS (CHANGE THESE!) ======
    const CLOUDINARY_CLOUD = "your_cloud_name_here";     // ‚Üê CHANGE THIS
    const CLOUDINARY_PRESET = "your_upload_preset_here"; // ‚Üê CHANGE THIS

    let xaiApiKey = null;
    let userId = null;
    let userRole = null;
    let isPro = false;
    let currentConvId = null;
    let history = [];
    let currentImage = null;
    let conversations = {};
    let todayTokensUsed = 0;
    const DAILY_LIMIT = 15000;

    const els = {
      chatPane: document.getElementById('chatPane'),
      welcome: document.getElementById('welcome'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtnInner: document.getElementById('uploadBtnInner'),
      hiddenFile: document.getElementById('hiddenFile'),
      fileName: document.getElementById('fileName'),
      menuBtn: document.getElementById('menuBtn'),
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('overlay'),
      newConvBtn: document.getElementById('newConvBtn'),
      convList: document.getElementById('convList'),
      slideName: document.getElementById('slideName'),
      userPlanBadge: document.getElementById('userPlanBadge'),
      toast: document.getElementById('toast'),
      roleModal: document.getElementById('roleModal'),
      upgradeModal: document.getElementById('upgradeModal'),
      apiStatus: document.getElementById('api-status')
    };

    async function initRemoteConfig() {
      await fetchAndActivate(remoteConfig);
      xaiApiKey = getString(remoteConfig, 'xai_api_key').trim();
      if (xaiApiKey && xaiApiKey.length > 10) {
        els.apiStatus.classList.add('connected');
      }
    }

    function toast(msg, time = 3000) {
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), time);
    }

    function estimateTokens(text) {
      return Math.ceil((text || '').length / 3.8);
    }

    async function addUsage(input, output) {
      todayTokensUsed += input + output;
      const today = new Date().toISOString().slice(0,10);
      await set(ref(db, `usage/\( {userId}/ \){today}`), todayTokensUsed);
      if (!isPro && todayTokensUsed >= DAILY_LIMIT) {
        els.upgradeModal.classList.add('show');
      }
    }

    async function loadTodayUsage() {
      const today = new Date().toISOString().slice(0,10);
      const snap = await get(ref(db, `usage/\( {userId}/ \){today}`));
      todayTokensUsed = snap.val() || 0;
    }

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.innerHTML = `<div class="content">${marked.parse(text)}</div>`;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    async function sendMessage() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      if (!currentConvId) startNewConversation();

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full mt-2">`, 'user');
      } else {
        addMessage(text, 'user');
      }

      saveMessage(text || "[Photo]", 'user');
      history.push({ sender: 'user', text: text || "[Photo]" });
      els.chatInput.value = ''; currentImage = null; els.fileName.textContent = '';
      updateSendBtn();

      addMessage('Typing...', 'ai');
      const reply = await getAIResponse(text || "Explain this homework photo step by step");
      document.querySelector('.message.ai:last-child').remove();
      addMessage(reply, 'ai');
      history.push({ sender: 'ai', text: reply });
      saveMessage(reply, 'ai');
    }

    async function getAIResponse(msg) {
      if (!xaiApiKey) return "API key not loaded yet...";

      const messages = [
        { role: "system", content: `You are StudyBuddy, the kindest and smartest AI tutor for South African learners (Grade 1‚Äì12, CAPS curriculum). Be warm, patient, and fun! Use simple language for younger kids.` },
        ...history.slice(-20).map(m => ({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text })),
        { role: "user", content: msg }
      ];

      if (currentImage) {
        const base64 = await fetch(currentImage).then(r => r.blob()).then(b => new Promise(res => {
          const reader = new FileReader();
          reader.onloadend = () => res(reader.result.split(',')[1]);
          reader.readAsDataURL(b);
        }));
        messages[messages.length-1].content = [
          { type: "text", text: msg || "Explain this homework" },
          { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
        ];
      }

      const inputTokens = estimateTokens(JSON.stringify(messages));
      if (!isPro && todayTokensUsed + inputTokens > DAILY_LIMIT) {
        els.upgradeModal.classList.add('show');
        return "You've reached your daily limit! Upgrade to continue.";
      }

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-beta", messages, temperature: 0.7 })
        });
        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "Sorry, I couldn't reply.";
        await addUsage(inputTokens, estimateTokens(reply));
        return reply;
      } catch (e) {
        return "Network error. Please try again.";
      }
    }

    function updateSendBtn() {
      const has = els.chatInput.value.trim() || currentImage;
      els.sendBtn.disabled = !has;
    }

    function updatePlanBadge() {
      if (!userRole) {
        els.userPlanBadge.textContent = "Free Plan ‚Ä¢ 15,000 tokens/day";
      } else if (isPro) {
        els.userPlanBadge.textContent = userRole === 'teacher' ? "Teacher Pro ‚Ä¢ R299/month" : "Student Pro ‚Ä¢ R29/month";
      } else {
        els.userPlanBadge.textContent = "Free Plan ‚Ä¢ 15,000 tokens/day";
      }
    }

    function startNewConversation() {
      history = [];
      els.chatPane.innerHTML = '';
      els.welcome.style.display = 'block';
      const newRef = push(ref(db, `users/${userId}/conversations`));
      currentConvId = newRef.key;
      set(newRef, { title: "New Session", createdAt: Date.now() });
    }

    function saveMessage(text, sender) {
      if (!currentConvId) return;
      push(ref(db, `users/\( {userId}/conversations/ \){currentConvId}/messages`), { text, sender, timestamp: Date.now() });
    }

    function renderConvs() {
      els.convList.innerHTML = '';
      Object.entries(conversations || {})
        .sort((a, b) => b[1].createdAt - a[1].createdAt)
        .forEach(([id, c]) => {
          const d = document.createElement('div');
          d.className = `p-4 border-b hover:bg-gray-100 cursor-pointer ${id === currentConvId ? 'bg-indigo-50' : ''}`;
          d.innerHTML = `<div class="font-medium">${c.title || 'New Session'}</div><small class="text-red-500 float-right">Delete</small>`;
          d.onclick = e => {
            if (e.target.tagName === 'SMALL') {
              remove(ref(db, `users/\( {userId}/conversations/ \){id}`));
              if (id === currentConvId) startNewConversation();
            }
          };
          els.convList.appendChild(d);
        });
    }

    // ====== AUTH & SETUP ======
    onAuthStateChanged(auth, async user => {
      if (!user) { window.location = "login.html"; return; }
      userId = user.uid;

      await initRemoteConfig();
      await loadTodayUsage();

      const snap = await get(ref(db, `users/${userId}`));
      const data = snap.val() || {};
      userRole = data.role;
      isPro = data.plan === 'pro';
      els.slideName.textContent = data.displayName || user.email.split('@')[0];
      updatePlanBadge();

      if (!userRole) els.roleModal.classList.add('show');

      onValue(ref(db, `users/${userId}/conversations`), s => {
        conversations = s.val() || {};
        renderConvs();
      });
    });

    // Role & Upgrade
    document.getElementById('studentBtn').onclick = async () => {
      await set(ref(db, `users/${userId}/role`), 'student');
      userRole = 'student'; updatePlanBadge();
      els.roleModal.classList.remove('show');
      toast("Welcome, learner! üéâ");
    };
    document.getElementById('teacherBtn').onclick = async () => {
      await set(ref(db, `users/${userId}/role`), 'teacher');
      userRole = 'teacher'; updatePlanBadge();
      els.roleModal.classList.remove('show');
      toast("Welcome, educator! üë®‚Äçüè´");
    };

    document.getElementById('upgradeStudent').onclick = async () => {
      await set(ref(db, `users/${userId}`), { role: 'student', plan: 'pro' });
      isPro = true; userRole = 'student'; updatePlanBadge();
      els.upgradeModal.classList.remove('show');
      toast("Student Pro activated! R29/month üöÄ");
    };
    document.getElementById('upgradeTeacher').onclick = async () => {
      await set(ref(db, `users/${userId}`), { role: 'teacher', plan: 'pro' });
      isPro = true; userRole = 'teacher'; updatePlanBadge();
      els.upgradeModal.classList.remove('show');
      toast("Teacher Pro activated! R299/month üè´");
    };
    document.getElementById('closeUpgrade').onclick = () => els.upgradeModal.classList.remove('show');

    // Events
    els.sendBtn.onclick = sendMessage;
    els.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    els.chatInput.addEventListener('input', updateSendBtn);

    els.uploadBtnInner.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async () => {
      const file = els.hiddenFile.files[0];
      if (!file) return;
      els.fileName.textContent = file.name;
      toast("Uploading photo...");

      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', CLOUDINARY_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`, { method: 'POST', body: form });
        const data = await res.json();
        if (data.secure_url) {
          currentImage = data.secure_url;
          toast("Photo ready! Hit send ‚úà");
        } else {
          toast("Upload failed");
          els.fileName.textContent = '';
        }
      } catch {
        toast("Upload error");
        els.fileName.textContent = '';
      }
      updateSendBtn();
    };

    els.menuBtn.onclick = () => { els.sidebar.classList.toggle('-translate-x-full'); els.overlay.classList.toggle('hidden'); };
    els.overlay.onclick = () => { els.sidebar.classList.add('-translate-x-full'); els.overlay.classList.add('hidden'); };
    els.newConvBtn.onclick = () => { els.overlay.click(); startNewConversation(); els.welcome.style.display = 'block'; };
  </script>
</body>
</html>
