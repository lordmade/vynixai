<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Vynix Buddy&quot;,
    &quot;short_name&quot;:&quot;Vynix&quot;,
    &quot;description&quot;:&quot;Your CAPS AI Tutor for South African Education&quot;,
    &quot;start_url&quot;:&quot;/&quot;,
    &quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#ffffff&quot;,
    &quot;theme_color&quot;:&quot;#8b5cf6&quot;,
    &quot;orientation&quot;:&quot;portrait&quot;,
    &quot;scope&quot;:&quot;/&quot;,
    &quot;categories&quot;:[&quot;education&quot;,&quot;productivity&quot;],
    &quot;icons&quot;:[
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=72&quot;,
        &quot;sizes&quot;:&quot;72x72&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      },
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=96&quot;,
        &quot;sizes&quot;:&quot;96x96&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      },
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=128&quot;,
        &quot;sizes&quot;:&quot;128x128&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      },
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=144&quot;,
        &quot;sizes&quot;:&quot;144x144&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      },
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=152&quot;,
        &quot;sizes&quot;:&quot;152x152&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      },
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192&quot;,
        &quot;sizes&quot;:&quot;192x192&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      },
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=384&quot;,
        &quot;sizes&quot;:&quot;384x384&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      },
      {
        &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512&quot;,
        &quot;sizes&quot;:&quot;512x512&quot;,
        &quot;type&quot;:&quot;image/svg+xml&quot;
      }
    ],
    &quot;shortcuts&quot;:[
      {
        &quot;name&quot;:&quot;Ask Question&quot;,
        &quot;url&quot;:&quot;/&quot;,
        &quot;description&quot;:&quot;Ask Vynix Buddy a question&quot;
      },
      {
        &quot;name&quot;:&quot;Practice Papers&quot;,
        &quot;url&quot;:&quot;/&quot;,
        &quot;description&quot;:&quot;Generate practice exam papers&quot;
      }
    ]
  }">
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vynix Buddy">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">
  <link rel="apple-touch-icon" sizes="152x152" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=152">
  <link rel="apple-touch-icon" sizes="180x180" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">
  <link rel="apple-touch-icon" sizes="167x167" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=167">
  <!-- PWA Installation Prompt -->
  <script>
    // PWA Installation Handler
    let deferredPrompt;
    let installButton = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallButton();
    });
    function showInstallButton() {
      if (installButton) return;
     
      installButton = document.createElement('button');
      installButton.innerHTML = 'ðŸ“± Install Vynix Buddy';
      installButton.className = 'fixed bottom-24 right-4 bg-purple-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-purple-700 transition-all duration-300 z-50 animate-bounce';
      installButton.onclick = installPWA;
      document.body.appendChild(installButton);
    }
    async function installPWA() {
      if (!deferredPrompt) return;
     
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
     
      if (outcome === 'accepted') {
        console.log('User accepted PWA installation');
        if (installButton) {
          installButton.remove();
          installButton = null;
        }
      }
      deferredPrompt = null;
    }
    // Handle iOS PWA installation
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    if (isIOS()) {
      window.addEventListener('load', () => {
        if (!window.matchMedia('(display-mode: standalone)').matches) {
          setTimeout(() => {
            const iosPrompt = document.createElement('div');
            iosPrompt.innerHTML = `
              <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 text-center">
                  <div class="text-4xl mb-4">ðŸ“±</div>
                  <h3 class="text-xl font-bold mb-2">Install Vynix Buddy</h3>
                  <p class="text-gray-600 mb-4">Tap the share button and select "Add to Home Screen" to install this app.</p>
                  <button onclick="this.closest('.fixed').remove()" class="bg-purple-600 text-white px-6 py-2 rounded-full">
                    Got it!
                  </button>
                </div>
              </div>
            `;
            document.body.appendChild(iosPrompt);
          }, 3000);
        }
      });
    }
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:text/javascript,console.log("Vynix Buddy PWA Ready");')
          .then((registration) => {
            console.log('PWA ServiceWorker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('PWA ServiceWorker registration failed:', error);
          });
      });
    }
    // PWA Update Handler
    window.addEventListener('appinstalled', () => {
      console.log('Vynix Buddy PWA installed successfully');
      customAlert('Vynix Buddy installed! ðŸŽ‰', 3000);
    });
  </script>
  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
 <style>
  *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
  textarea,input,.content,.selectable{-webkit-user-select:text;user-select:text}
  body{
    font-family:'Inter',sans-serif;
    background:#faf8ff;
    color:#1f1f1f;
    margin:0;
    height:100dvh;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  /* â”€â”€â”€â”€â”€â”€â”€ TOKEN BAR + PROFILE â”€â”€â”€â”€â”€â”€â”€ */
  .token-bar{
    position:fixed;top:0;left:0;right:0;
    background:linear-gradient(135deg,#8b5cf6,#ec4899);
    color:#fff;
    padding:0.75rem 1rem;
    padding-top:calc(0.75rem + env(safe-area-inset-top));
    font-size:0.95rem;
    text-align:center;
    z-index:50;
    display:flex;
    align-items:center;
    justify-content:space-between;
    box-shadow:0 4px 20px rgba(139,92,246,0.25);
  }
  #upgradePill{
    margin-left:12px;
    padding:6px 16px;
    background:#fff3;
    border:1px solid #fff4;
    border-radius:50px;
    font-weight:600;
    transition:all .2s;
  }
  #upgradePill:active{transform:scale(0.94)}

  /* Menu Button in Header */
  #menuBtn {
    display:flex;
    align-items:center;
    justify-content:center;
    width:38px;
    height:38px;
    border-radius:50%;
    background:#fff3;
    border:none;
    color:#fff;
    margin-right:12px;
    transition:all .2s;
  }
  #menuBtn:hover{background:#fff4}
  #menuBtn:active{transform:scale(0.94)}

  /* Profile Button in Header */
  #profileBtn{
    display:flex;
    align-items:center;
    gap:10px;
    padding:4px 8px 4px 4px;
    border-radius:50px;
    transition:all .2s;
  }
  #profileBtn:hover{background:#fff2}

  /* Profile Dropdown */
  #profileDropdown {
    position: absolute;
    right: 8px;
    top: 100%;
    margin-top: 8px;
    width: 280px;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.18);
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
    transform: translateY(-12px);
    transition: all .25s cubic-bezier(0.32,0.72,0,1);
    z-index: 999;
  }

  #profileDropdown.show {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  /* â”€â”€â”€â”€â”€â”€â”€ CHAT MESSAGES â”€â”€â”€â”€â”€â”€â”€ */
  #chatPane{
    flex:1;
    overflow-y:auto;
    padding:1rem 1rem 160px;
    -webkit-overflow-scrolling:touch;
  }

  .message{
    margin:1.2rem 0;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    animation:fadeIn 0.4s ease-out forwards;
    width:100%;
  }
  .message.ai  { justify-content:flex-start; }
  .message.user{
    align-items:flex-end;
  }

  .message .content{
    max-width:100%;
    width:100%;
    padding:14px 18px;
    border-radius:24px;
    line-height:1.55;
    font-size:1.02rem;
    position:relative;
    word-wrap:break-word;
    box-shadow:0 3px 10px rgba(0,0,0,0.09);
  }

  /* AI Bubbles â€“ Premium Purple Gradient */
  .message.ai .content{
    background:linear-gradient(135deg,#f8f6ff 0%,#f0e8ff 100%);
    border:1px solid #e0d6ff;
    border-bottom-left-radius:6px;
    color:#312069;
  }
  /* User Bubbles â€“ Crisp White */
  .message.user .content{
    background:#fff;
    border:1.8px solid #c4b5fd;
    border-bottom-right-radius:6px;
    color:#1f1f1f;
    font-weight:500;
  }

  /* Speech Bubble Tails */
  .message.ai .content::before,
  .message.user .content::before{
    content:'';
    position:absolute;
    bottom:0;
    width:0;height:0;
    border:11px solid transparent;
  }
  .message.ai .content::before{
    left:-11px;
    border-right-color:#e0d6ff;
    border-left:0;
  }
  .message.user .content::before{
    right:-11px;
    border-left-color:#c4b5fd;
    border-right:0;
  }

  /* Timestamps */
  .timestamp{
    font-size:0.75rem;
    color:#9ca3af;
    margin-top:6px;
    opacity:0.85;
  }
  .message.ai .timestamp{
    margin-left:18px;
    margin-top:4px;
  }
  .message.user .timestamp{
    margin-right:18px;
    text-align:right;
    margin-top:4px;
  }
  /* AI Action Buttons */
  .ai-actions{
    display:flex;
    gap:12px;
    padding:8px 18px 0 18px;
    justify-content:flex-start;
  }
  .action-btn{
    width:40px;
    height:40px;
    background:#fff;
    border:none;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 4px 16px rgba(0,0,0,0.14);
    transition:all .22s ease;
    cursor:pointer;
  }
  .action-btn:hover{
    transform:translateY(-4px) scale(1.1);
    box-shadow:0 10px 25px rgba(139,92,246,0.3);
  }

  /* Thinking Dots */
  .thinking{
    display:flex;
    gap:9px;
    padding:16px 20px;
  }
  .dot{
    width:11px;
    height:11px;
    background:#a78bfa;
    border-radius:50%;
    animation:pulse 1.5s infinite;
  }
  .dot:nth-child(2){animation-delay:.2s}
  .dot:nth-child(3){animation-delay:.4s}
  @keyframes pulse{
    0%,100%{opacity:0.4;transform:scale(0.8)}
    50%{opacity:1;transform:scale(1)}
  }

  /* â”€â”€â”€â”€â”€â”€â”€ INPUT BAR â”€â”€â”€â”€â”€â”€â”€ */
  .input-bar{
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    padding:0.75rem;
    padding-bottom:calc(0.75rem + env(safe-area-inset-bottom));
    background:#fff;
    border-top:1px solid #e2e8f0;
    box-shadow:0 -6px 30px rgba(0,0,0,0.1);
    z-index:100;
  }
  .input-container{
    background:#f8fafc;
    border:2px solid #e2e8f0;
    border-radius:28px;
    padding:10px 16px;
    display:flex;
    align-items:center;
    gap:12px;
    transition:all .2s;
  }
  .input-container:focus-within{
    border-color:#8b5cf6;
    box-shadow:0 0 0 4px rgba(139,92,246,0.18);
    background:#fff;
  }
  #chatInput{
    flex:1;
    background:transparent;
    border:none;
    outline:none;
    font-size:1.05rem;
    resize:none;
    max-height:140px;
    line-height:1.5;
  }
  .send-btn,.upload-btn{
    width:48px;
    height:48px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
  }
  .send-btn{
    background:#8b5cf6;
    color:#fff;
    box-shadow:0 4px 15px rgba(139,92,246,0.4);
  }
  .send-btn:disabled{
    background:#cbd5e1;
    cursor:not-allowed;
  }
  .upload-btn{background:#e2e8f0}

  /* File Previews */
  #filePreview, #docPreview{
    width:42px;
    height:42px;
    border-radius:12px;
    object-fit:cover;
    display:none;
  }
  #docPreview{
    background:#f1f5f9;
    border:1px dashed #94a3b8;
    display:none;
    align-items:center;
    justify-content:center;
  }

  /* Bottom Sheets */
  .bottom-sheet{
    position:fixed;
    bottom:-100%;
    left:0;
    right:0;
    background:#fff;
    border-radius:24px 24px 0 0;
    padding:1.5rem;
    box-shadow:0 -10px 40px rgba(0,0,0,0.25);
    transition:bottom .4s cubic-bezier(.32,.72,0,1);
    z-index:200;
    max-height:92dvh;
    overflow-y:auto;
  }
  .bottom-sheet.active{bottom:0}
  .sheet-handle{
    width:40px;
    height:5px;
    background:#ddd;
    border-radius:3px;
    margin:0 auto 1rem;
  }

  /* Custom Alert */
  #customAlert{
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%) translateY(-120%);
    background:linear-gradient(135deg,#8b5cf6,#ec4899);
    color:#fff;
    padding:14px 28px;
    border-radius:9999px;
    font-weight:700;
    box-shadow:0 12px 30px rgba(0,0,0,0.25);
    z-index:9999;
    transition:transform .35s ease;
    display:none;
  }
  #customAlert.show{
    transform:translateX(-50%) translateY(0);
    display:block;
  }

  /* Animations */
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(12px)}
    to{opacity:1;transform:translateY(0)}
  }

  /* PWA Adjustments */
  @media (display-mode: standalone){
    .token-bar{padding-top:calc(0.75rem + env(safe-area-inset-top))}
    .input-bar{padding-bottom:calc(0.75rem + env(safe-area-inset-bottom))}
  }

  /* Sidebar Styles */
  #convoSidebar.translate-x-0 { transform: translateX(0); }
  #sidebarOverlay.active { display: block !important; }

  /* Desktop Sidebar - Hidden by default */
  @media (min-width: 768px) {
    #convoSidebar {
      transform: translateX(-100%);
    }
    #convoSidebar.translate-x-0 {
      transform: translateX(0);
    }
  }

  /* Conversation Item */
  .convo-item {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f1f5f9;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .convo-item:hover {
    background: #f8f6ff;
  }
  .convo-item.active {
    background: linear-gradient(135deg, #f3e8ff, #e0d6ff);
    font-weight: 600;
  }
  .convo-item .title {
    flex: 1;
    font-size: 0.95rem;
    color: #1f1f1f;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .convo-item .timestamp {
    font-size: 0.75rem;
    color: #94a3b8;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .convo-item:hover .timestamp { opacity: 1; }
  .convo-item .delete-btn {
    opacity: 0;
    transition: opacity 0.2s;
  }
  .convo-item:hover .delete-btn {
    opacity: 1;
  }
  .convo-item .delete-btn:hover {
    color: #ef4444;
  }
</style>
</head>
<body>
  <!-- Sidebar Overlay (mobile) -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

  <!-- Conversations Sidebar -->
  <aside id="convoSidebar" class="fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 transform -translate-x-full transition-transform duration-300">
    <div class="flex items-center justify-between p-5 border-b border-gray-200">
      <h2 class="text-xl font-bold text-purple-600">Your Chats</h2>
      <button id="closeSidebar" class="text-gray-500 hover:text-gray-700">
        <i data-lucide="x" class="w-7 h-7"></i>
      </button>
    </div>

    <!-- New Chat Button -->
    <div class="p-4 border-b border-gray-100">
      <button id="newChatBtn" class="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold py-3 rounded-xl hover:scale-105 active:scale-95 transition">
        <i data-lucide="plus" class="w-5 h-5"></i>
        New Chat
      </button>
    </div>

    <!-- Conversations List -->
    <div id="conversationsList" class="flex-1 overflow-y-auto">
      <!-- Conversations will be injected here by JS -->
    </div>
  </aside>

  <!-- Token Bar with Menu Button -->
  <div class="token-bar">
    <!-- Menu Button (Mobile) -->
    <button id="menuBtn" class="md:hidden">
      <i data-lucide="menu" class="w-6 h-6"></i>
    </button>
    
    <!-- Desktop Menu Button -->
    <button id="desktopMenuBtn" class="hidden md:flex items-center justify-center w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 transition">
      <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Token Count -->
    <div class="flex items-center gap-2 flex-1 justify-center">
      <span id="tokenCount">15,000</span> tokens left today
      <button id="upgradePill" class="ml-3 px-4 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold text-sm rounded-full border border-white/40 transition active:scale-95">
        Upgrade
      </button>
    </div>

    <!-- User Profile Dropdown -->
    <div class="relative ml-auto">
      <button id="profileBtn" class="flex items-center gap-3 px-3 py-1.5 rounded-full hover:bg-white/10 transition">
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-sm">
          <span id="userInitial">U</span>
        </div>
        <div class="text-left hidden sm:block">
          <div id="userName" class="text-white font-medium text-sm">Loading...</div>
          <div id="userGrade" class="text-white/70 text-xs">Grade â€”</div>
        </div>
        <i data-lucide="chevron-down" class="w-4 h-4 text-white/70"></i>
      </button>

      <!-- Dropdown Menu -->
      <div id="profileDropdown" class="absolute right-0 top-full mt-2 w-56 bg-white rounded-2xl shadow-2xl overflow-hidden opacity-0 pointer-events-none transition-all duration-200 transform translate-y-[-10px] z-50">
        <div class="p-4 border-b border-gray-100">
          <div class="font-bold text-gray-900" id="dropdownName">User</div>
          <div class="text-sm text-gray-500" id="dropdownGrade">Grade â€”</div>
        </div>
        <button id="signOutBtn" class="w-full px-5 py-3.5 text-left text-red-600 font-medium hover:bg-red-50 transition flex items-center gap-3">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Pane -->
  <section id="chatPane">
    <!-- Welcome message removed - chats start here -->
  </section>

  <!-- Input Bar -->
  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn" aria-label="Attach file"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*,.pdf,.doc,.docx" hidden>
      <img id="filePreview" alt="File preview">
      <div class="doc-preview" id="docPreview"><i data-lucide="file-text" width="20" height="20"></i></div>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1" aria-label="Chat input"></textarea>
      <button id="sendBtn" class="send-btn" disabled aria-label="Send"><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <!-- Upgrade Sheet -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">Ã—</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-3">Never Run Out of Help Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <span class="text-purple-600 font-bold">Unlimited</span> and study without limits</p>
      <div class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl transform -rotate-2 mb-10">
        <div class="text-6xl font-black">R79</div>
        <div class="text-xl opacity-90">per month</div>
      </div>
      <div class="space-y-6 text-left bg-gray-50 rounded-3xl p-8 mb-8 text-lg font-medium">
        <div class="flex items-center gap-4">Unlimited AI messages</div>
        <div class="flex items-center gap-4">Premium ElevenLabs voice</div>
        <div class="flex items-center gap-4">Download answers as PDF</div>
        <div class="flex items-center gap-4">Faster responses</div>
        <div class="flex items-center gap-4">Support SA education (5% donated)</div>
      </div>
      <button id="mockUpgrade" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">Yes! Upgrade Me Now â€“ R79/month</button>
    </div>
  </div>

  <!-- Past Papers Sheet -->
  <div id="papersSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('papersSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">Ã—</button>
    <div id="papersContent" class="px-2"></div>
  </div>

  <!-- Custom Alert Container -->
  <div id="customAlert" role="alert"></div>

  <script type="module">
    // â”€â”€â”€â”€â”€â”€â”€ FIXED IMPORTS â”€â”€â”€â”€â”€â”€â”€
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
    
    lucide.createIcons();
    const { jsPDF } = window.jspdf;
    
    // â”€â”€â”€â”€â”€â”€â”€ FIREBASE INITIALIZATION â”€â”€â”€â”€â”€â”€â”€
    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    // â”€â”€â”€â”€â”€â”€â”€ GLOBAL STATE â”€â”€â”€â”€â”€â”€â”€
    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let yocoPublicKey = null;
    let yocoEnabled = false;
    let history = [];
    let currentImage = null;
    let currentFile = null;
    let waitingForProfile = false;
    let dailyTokens = 15000;
    let isPremium = false;
    let conversations = [];
    let currentConvoId = null;
    
    // â”€â”€â”€â”€â”€â”€â”€ DOM ELEMENTS â”€â”€â”€â”€â”€â”€â”€
    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      filePreview: document.getElementById('filePreview'),
      docPreview: document.getElementById('docPreview'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      mockUpgrade: document.getElementById('mockUpgrade'),
      upgradePill: document.getElementById('upgradePill'),
      papersSheet: document.getElementById('papersSheet'),
      papersContent: document.getElementById('papersContent'),
      sidebar: document.getElementById('convoSidebar'),
      overlay: document.getElementById('sidebarOverlay'),
      convoList: document.getElementById('conversationsList'),
      profileDropdown: document.getElementById('profileDropdown')
    };
    
    // â”€â”€â”€â”€â”€â”€â”€ UTILITY FUNCTIONS â”€â”€â”€â”€â”€â”€â”€
    function customAlert(msg, duration = 2500) {
      const box = document.getElementById('customAlert');
      if (!box) return;
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }
    
    function formatTime() { 
      return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); 
    }
    
    function estimateTokens(t) { 
      return Math.ceil((t?.length || 0) / 4) + 150; 
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ TOKEN MANAGEMENT â”€â”€â”€â”€â”€â”€â”€
    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { 
        els.upgradeSheet.classList.add('active'); 
        return false; 
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { 
        daily: dailyTokens, 
        lastReset: Date.now() 
      });
      return true;
    }
    
    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const userData = userSnap.val();
        if (userData?.premium) {
          isPremium = true; 
          dailyTokens = 999999;
          document.querySelector('.token-bar').innerHTML = `<div class="flex items-center justify-center gap-3"><span>Unlimited access â€¢ Premium</span></div>`;
          els.tokenCount.textContent = 'Unlimited'; 
          return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val(); 
        const now = Date.now(); 
        const oneDay = 24 * 60 * 60 * 1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000; 
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else {
          dailyTokens = data.daily || 15000;
        }
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { 
        dailyTokens = 15000; 
        els.tokenCount.textContent = dailyTokens.toLocaleString(); 
      }
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ PAYMENT SYSTEM â”€â”€â”€â”€â”€â”€â”€
    function loadYocoScript() {
      if (window.YocoSDK) return Promise.resolve();
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
        s.onload = res; 
        s.onerror = rej;
        document.head.appendChild(s);
      });
    }
    
    async function startYocoPayment() {
      try {
        await loadYocoScript();
        const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
        const result = await yoco.showPopup({
          amountInCents: 7900,
          currency: 'ZAR',
          name: 'Vynix Buddy Unlimited',
          description: 'R79/month â€“ Unlimited AI tutoring',
          metadata: { userId: auth.currentUser.uid },
          callbackUrl: location.href
        });
       
        if (result?.paymentResult?.status === 'successful') {
          await update(ref(db, `users/${auth.currentUser.uid}`), { 
            premium: true, 
            premiumSince: new Date().toISOString() 
          });
          isPremium = true; 
          await loadTokens(); 
          els.upgradeSheet.classList.remove('active');
          customAlert("Payment successful! You're now on Unlimited!");
        }
      } catch (e) { 
        customAlert("Payment cancelled or failed."); 
      }
    }
    
    els.mockUpgrade.onclick = () => yocoEnabled ? startYocoPayment() : customAlert("Upgrade coming soon!");
    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');
    
    // â”€â”€â”€â”€â”€â”€â”€ EXAM PAPER GENERATION â”€â”€â”€â”€â”€â”€â”€
    async function generateExamPaper(subject, grade, topic) {
      const marks = 50;
      const prompt = `Generate a CAPS exam paper for ${subject} Grade ${grade} on the topic: "${topic}".
     
      REQUIREMENTS:
      - Exactly 5 TOUGH questions testing deep understanding
      - Total marks: ${marks} (10 marks per question)
      - Each question must have clear sub-parts (a), (b), (c) where relevant
      - Use proper mathematical notation (write formulas clearly)
      - Include diagrams or descriptions where needed
      - Provide detailed memorandum with FULL solutions
      - Separate question paper and memorandum with "---MEMO---"
      - Format clearly with spacing between questions
     
      FORMAT:
      COVER: Subject, Grade, Topic, Time, Marks
      INSTRUCTIONS
      QUESTION 1 (10 marks): [Tough question on ${topic}]
      QUESTION 2 (10 marks): [Tough question on ${topic}]
      QUESTION 3 (10 marks): [Tough question on ${topic}]
      QUESTION 4 (10 marks): [Tough question on ${topic}]
      QUESTION 5 (10 marks): [Tough question on ${topic}]
      ---MEMO---
      MEMORANDUM with detailed solutions for all 5 questions.`;
     
      addThinking();
      const cost = 2500;
      if (!(await deductTokens(cost))) { removeThinking(); return null; }
      
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ 
            model: "grok-4-1-fast-non-reasoning", 
            messages: [{role:"user",content:prompt}], 
            max_tokens: 8000, 
            temperature: 0.7 
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || null;
      } catch (e) {
        console.error(e);
        return null;
      } finally {
        removeThinking();
      }
    }
    
    function showPastPapersSheet() {
      const grade = userProfile?.grade || "12";
      const name = userProfile?.name || "learner";
     
      els.papersContent.innerHTML = `
        <h3 class="text-xl font-bold mb-4">Generate CAPS Practice Paper</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Subject</label>
            <select id="subjectSelect" class="w-full border rounded-lg p-2 bg-white">
              <option value="Mathematics">Mathematics</option>
              <option value="Physical Sciences">Physical Sciences</option>
              <option value="Life Sciences">Life Sciences</option>
              <option value="Accounting">Accounting</option>
              <option value="Business Studies">Business Studies</option>
              <option value="Geography">Geography</option>
              <option value="History">History</option>
              <option value="English HL">English HL</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Topic (e.g., Calculus, Chemical Equilibrium)</label>
            <input type="text" id="topicInput" class="w-full border rounded-lg p-2" placeholder="Enter specific topic">
          </div>
          <button id="generatePaperBtn" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">Generate 5 Tough Questions + Memo</button>
        </div>`;
     
      els.papersSheet.classList.add('active');
     
      document.getElementById('generatePaperBtn').addEventListener('click', async () => {
        const subject = document.getElementById('subjectSelect').value;
        const topic = document.getElementById('topicInput').value.trim();
       
        if (!topic) { customAlert("Please enter a topic"); return; }
       
        els.papersSheet.classList.remove('active');
        const examText = await generateExamPaper(subject, grade, topic);
       
        if (!examText) { 
          customAlert("Failed to generate paper. Check your internet or tokens."); 
          return; 
        }
       
        // PDF Generation
        const [qp, memo] = examText.split("---MEMO---");
        const doc = new jsPDF();
       
        doc.setFontSize(22); doc.setTextColor(139, 92, 246); doc.text("VYNIX BUDDY", 105, 30, {align:"center"}); doc.setTextColor(0, 0, 0);
        doc.setFontSize(18); doc.text("CAPS PRACTICE PAPER", 105, 45, {align:"center"});
        doc.setFontSize(14); doc.text(`${subject} - Grade ${grade}`, 105, 60, {align:"center"});
        doc.text(`Topic: ${topic}`, 105, 75, {align:"center"});
        doc.setFontSize(12); doc.text(`Generated on ${new Date().toLocaleDateString('en-ZA')}`, 105, 90, {align:"center"});
        doc.text(`Good luck, ${name}!`, 105, 105, {align:"center"});
       
        doc.addPage(); doc.setFontSize(16); doc.text("QUESTION PAPER", 105, 20, {align:"center"});
        doc.setFontSize(12); doc.text(`Subject: ${subject} | Grade: ${grade} | Topic: ${topic}`, 15, 35);
        doc.text(`Time: 1 hour | Marks: 50`, 15, 45);
        doc.text("Instructions: Answer all questions. Show all working.", 15, 55);
       
        let yPos = 70; let qNum = 1;
        const questions = (qp || examText).split(/QUESTION \d+:/gi).filter(q => q.trim());
       
        questions.slice(0, 5).forEach(q => {
          if (yPos > 240) { doc.addPage(); yPos = 20; }
         
          doc.setFontSize(12); doc.setFont(undefined, "bold");
          const marks = 10; doc.text(`Question ${qNum} (${marks} marks)`, 15, yPos);
          doc.setFont(undefined, "normal"); yPos += 8;
         
          let cleanQ = q.trim()
            .replace(/\*\*/g, '').replace(/\*/g, '').replace(/\$/g, '')
            .replace(/\^(\d+)/g, 'to the power of $1')
            .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1 over $2')
            .replace(/\\sqrt\{([^}]+)\}/g, 'square root of $1')
            .replace(/\\int/g, 'integral of').replace(/\\sum/g, 'sum of')
            .replace(/\\theta/g, 'theta').replace(/\\pi/g, 'pi')
            .replace(/\\div/g, 'divided by').replace(/\\times/g, 'times')
            .replace(/\(([a-z])\)/g, ' ($1)');
         
          const lines = doc.splitTextToSize(cleanQ, 170);
          lines.forEach(line => {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.text(line, 20, yPos); yPos += 6;
          });
          yPos += 8; qNum++;
        });
       
        doc.addPage(); doc.setFontSize(16); doc.text("MEMORANDUM", 105, 20, {align:"center"});
        doc.setFontSize(12);
       
        const cleanMemo = (memo || "No memorandum generated.")
          .replace(/\*\*/g, '').replace(/\*/g, '').replace(/\$/g, '')
          .replace(/\^(\d+)/g, 'to the power of $1')
          .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1 over $2')
          .replace(/\\sqrt\{([^}]+)\}/g, 'square root of $1')
          .replace(/\\int/g, 'integral of').replace(/\\sum/g, 'sum of')
          .replace(/\\theta/g, 'theta').replace(/\\pi/g, 'pi')
          .replace(/\\div/g, 'divided by').replace(/\\times/g, 'times');
       
        const memoLines = doc.splitTextToSize(cleanMemo, 180); let memoY = 35;
        memoLines.forEach(line => {
          if (memoY > 270) { doc.addPage(); memoY = 20; }
          doc.text(line, 15, memoY); memoY += 6;
        });
       
        doc.save(`CAPS_${subject.replace(/\s/g,"_")}_Grade${grade}_${topic.replace(/\s/g,"_")}.pdf`);
        customAlert("Practice paper downloaded!");
      });
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ VISION MARKING â”€â”€â”€â”€â”€â”€â”€
    async function markStudentWork(studentImageUrl, subject, grade, questionContext) {
      const prompt = `You are a strict South African DBE examiner marking CAPS ${subject} Grade ${grade} work.
STUDENT WORK: Analyze the handwritten answer in the attached image.
QUESTION CONTEXT: ${questionContext}
MARKING TASK:
1. Mark the work according to SAGA (South African General Assessment) guidelines
2. Allocate marks out of 10 using official CAPS marking principles
3. Place virtual ticks (âˆš) where marks are earned
4. Identify CAPS-specific errors SA learners commonly make
5. Provide examiner-style comments with mark deductions
OUTPUT FORMAT:
MARKS: X/10
EXAMINER COMMENTS:
- âˆš [1 mark] Correct formula identified
- âœ— [LOST] Did not convert to SI units (CAPS requirement)
- âˆš [2 marks] Substitution correct
- âœ— [LOST] Final answer not rounded to 2 decimal places
FEEDBACK: [Specific advice for improvement]
CAPS ALIGNMENT: [Reference to assessment standard]`;
     
      addThinking();
      const cost = 3000;
      if (!(await deductTokens(cost))) { removeThinking(); return null; }
      
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${xaiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "grok-2-vision-1212",
            messages: [{
              role: "user",
              content: [
                { type: "text", text: prompt },
                { type: "image_url", image_url: { url: studentImageUrl } }
              ]
            }],
            max_tokens: 4000,
            temperature: 0.3
          })
        });
       
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "Could not mark this paper.";
      } catch (e) {
        console.error("Vision marking failed:", e);
        return "Marking error. Please ensure image is clear and well-lit.";
      } finally {
        removeThinking();
      }
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ KEYBOARD & INPUT HANDLING â”€â”€â”€â”€â”€â”€â”€
    const viewport = window.visualViewport || window;
    function handleKeyboard() {
      const kh = window.innerHeight - (viewport.height || window.innerHeight);
      document.querySelector('.input-bar').style.transform = kh > 100 ? `translateY(-${kh}px)` : 'translateY(0)';
    }
    
    viewport.addEventListener('resize', handleKeyboard);
    viewport.addEventListener('scroll', handleKeyboard);
    
    els.chatInput.addEventListener('focus', () => setTimeout(handleKeyboard, 300));
    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      updateSendButton();
    });
    
    function updateSendButton() {
      const hasText = els.chatInput.value.trim().length > 0;
      const hasFile = currentImage !== null || currentFile !== null;
      els.sendBtn.disabled = !hasText && !hasFile;
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€
    els.uploadBtn.onclick = () => els.hiddenFile.click();
    
    els.hiddenFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
     
      const isImage = file.type.startsWith('image/');
      if (isImage) {
        els.filePreview.src = URL.createObjectURL(file);
        els.filePreview.style.display = 'block';
        els.docPreview.style.display = 'none';
      } else {
        els.docPreview.style.display = 'flex';
        els.filePreview.style.display = 'none';
      }
     
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'banter_box');
      fd.append('resource_type', 'auto');
     
      try {
        customAlert("Uploading file...", 2000);
        const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/upload", {
          method: "POST",
          body: fd
        });
        const data = await res.json();
       
        if (data.secure_url) {
          currentImage = data.secure_url;
          currentFile = file;
          updateSendButton();
          customAlert("File uploaded successfully!");
        } else {
          throw new Error("Upload failed");
        }
      } catch (e) {
        console.error("Cloudinary upload error:", e);
        customAlert("Upload error. Check your connection.");
        hidePreview();
      }
    };
    
    function hidePreview() {
      els.filePreview.style.display = 'none';
      els.docPreview.style.display = 'none';
      currentImage = null;
      currentFile = null;
      updateSendButton();
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ MESSAGE RENDERING â”€â”€â”€â”€â”€â”€â”€
    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      const time = formatTime();
     
      if (sender === 'ai' && !isImage) {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn" aria-label="Copy"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn" aria-label="Listen"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn" aria-label="Download PDF"><i data-lucide="download"></i></button>
            <button class="action-btn papers-btn" aria-label="Past Papers"><i data-lucide="file-text" class="text-purple-700"></i></button>
            <button class="action-btn mark-btn" aria-label="Mark My Work"><i data-lucide="check-square" class="text-green-600"></i></button>
          </div>
          <div class="timestamp">${time}</div>`;
      } else {
        const userText = isImage ? content : content.replace(/\n/g, '<br>');
        div.innerHTML = `<div class="content">${userText}</div><div class="timestamp">${time}</div>`;
      }
     
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons({ attrs: { width: 18, height: 18 } });
     
      // Add action listeners
      if (sender === 'ai' && !isImage) {
        // Copy button
        div.querySelector('.copy-btn')?.addEventListener('click', async () => {
          const text = plainText || content;
          try {
            await navigator.clipboard.writeText(text);
            const i = div.querySelector('.copy-btn i');
            i.setAttribute('data-lucide', 'check'); 
            lucide.createIcons();
            setTimeout(() => { 
              i.setAttribute('data-lucide', 'copy'); 
              lucide.createIcons(); 
            }, 2000);
          } catch (e) {
            customAlert('Copy failed. Please copy manually.');
          }
        });
       
        // Voice button
        div.querySelector('.voice-btn')?.addEventListener('click', async () => {
          const text = plainText || content;
          if (!text) return;
          const btn = div.querySelector('.voice-btn');
          const icon = btn.querySelector('i');
          const originalIcon = 'volume-2';
         
          icon.setAttribute('data-lucide', 'loader-2');
          lucide.createIcons();
          btn.disabled = true;
         
          try {
            if (!elevenlabsKey) throw new Error('Voice not configured');
            const voiceId = 'pNInz6obpgDQGcFmaJgB';
           
            const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
              method: 'POST',
              headers: {
                'Accept': 'audio/mpeg',
                'Content-Type': 'application/json',
                'xi-api-key': elevenlabsKey
              },
              body: JSON.stringify({
                text: text,
                model_id: 'eleven_monolingual_v1',
                voice_settings: { stability: 0.5, similarity_boost: 0.5 }
              })
            });
           
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
           
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
           
            audio.onended = () => {
              URL.revokeObjectURL(audioUrl);
              icon.setAttribute('data-lucide', originalIcon);
              lucide.createIcons();
              btn.disabled = false;
            };
           
            audio.onerror = () => {
              URL.revokeObjectURL(audioUrl);
              icon.setAttribute('data-lucide', originalIcon);
              lucide.createIcons();
              btn.disabled = false;
              customAlert('Playback failed');
            };
           
            await audio.play();
          } catch (err) {
            console.error(err);
            customAlert('Voice temporarily unavailable');
            icon.setAttribute('data-lucide', originalIcon);
            lucide.createIcons();
            btn.disabled = false;
          }
        });
       
        // PDF button
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); 
          doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11); 
          doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_Answer_${new Date().toISOString().slice(0,10)}.pdf`);
        });
       
        // Past papers button
        div.querySelector('.papers-btn')?.addEventListener('click', showPastPapersSheet);
       
        // Mark button
        div.querySelector('.mark-btn')?.addEventListener('click', async () => {
          if (!currentImage) {
            customAlert("Upload your answer sheet first!");
            return;
          }
         
          const subject = userProfile?.favoriteSubject || "Mathematics";
          const grade = userProfile?.grade || "12";
          const markingResult = await markStudentWork(currentImage, subject, grade, plainText);
          if (markingResult) {
            addMessage(markingResult, 'ai', markingResult);
          }
        });
      }
    }
    
    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    
    function removeThinking() { 
      document.getElementById('thinking')?.remove(); 
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ MAIN SEND FUNCTION â”€â”€â”€â”€â”€â”€â”€
    async function send() {
      if (waitingForProfile) return;
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;

      const cost = currentImage ? 1500 : estimateTokens(text);
      if (!(await deductTokens(cost))) {
        addMessage("You've run out of tokens today! Upgrade to unlimited for just R79/month.", 'ai');
        return;
      }

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="User upload">`, 'user');
        history.push({ role: "user", content: `[Image: ${currentImage}]` });
        if (!text) text = "Explain what's in this image";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      await saveMessage(text); // Save user message

      els.chatInput.value = '';
      hidePreview();
      els.chatInput.style.height = 'auto';
      addThinking();

      const reply = await getReply(text);
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });

      await saveMessage(text, reply); // Save AI reply
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ AI RESPONSE â”€â”€â”€â”€â”€â”€â”€
    async function getReply(msg) {
      if (!xaiKey) return "Connecting to Grok...";
      const roleText = userProfile ? `${userProfile.role} (Grade ${userProfile.grade})` : "learner";
      const systemPrompt = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. You are helping ${userProfile?.name || "a student"} who is a ${roleText}. Always use their name naturally. Be encouraging and explain step-by-step.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [{ role: "system", content: systemPrompt }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        console.error(e);
        return "No internet connection. Please check your network.";
      }
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ PROFILE SETUP â”€â”€â”€â”€â”€â”€â”€
    async function checkAndAskProfile() {
      const authUser = auth.currentUser;
      const authName = authUser?.displayName?.trim();
      const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/profile`));
      const dbProfile = snap.val();
      
      userProfile = dbProfile || {};
      if (!userProfile.name && authName) {
        userProfile.name = authName;
        await set(ref(db, `users/${auth.currentUser.uid}/profile/name`), authName);
      }

      if (!userProfile.name || !userProfile.grade || !userProfile.role) {
        waitingForProfile = true;
        addMessage("Sawubona! I'm Vynix Buddy, your personal CAPS tutor.\n\nMay I know your name?", 'ai');
      } else {
        addMessage(`Welcome back, ${userProfile.name}! Ready for Grade ${userProfile.grade} today?`, 'ai');
        waitingForProfile = false;
      }
      updateProfileDisplay();
    }
    
    els.chatInput.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!waitingForProfile) return send();
        const text = els.chatInput.value.trim();
        if (!text) return;
        els.chatInput.value = '';
        if (!userProfile?.name) {
          userProfile = { name: text };
          addMessage(`Nice to meet you, ${text}! Which grade are you in?`, 'ai');
        } else if (!userProfile?.grade) {
          userProfile.grade = text;
          addMessage(`Got it! Grade ${text}. Are you a **student**, **teacher**, or **parent**?`, 'ai');
        } else if (!userProfile?.role) {
          userProfile.role = text.toLowerCase();
          await set(ref(db, `users/${auth.currentUser.uid}/profile`), userProfile);
          waitingForProfile = false;
          addMessage(`Perfect, ${userProfile.name}! I'm now your personal CAPS tutor. Ask me anything!`, 'ai');
        }
      }
    });
    
    async function init() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
      yocoPublicKey = getString(rc, 'yoco_public_key')?.trim();
      yocoEnabled = getBoolean(rc, 'yoco_enabled');
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ PROFILE DROPDOWN â”€â”€â”€â”€â”€â”€â”€
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    
    function updateProfileDisplay() {
      if (!userProfile?.name) {
        document.getElementById('userInitial').textContent = '?';
        document.getElementById('userName').textContent = 'Student';
        document.getElementById('userGrade').textContent = 'â€”';
        document.getElementById('dropdownName').textContent = 'Student';
        document.getElementById('dropdownGrade').textContent = 'â€”';
        return;
      }
      const name = userProfile.name.trim();
      const initial = name.charAt(0).toUpperCase();
      const grade = userProfile.grade ? `Grade ${userProfile.grade}` : 'Not set';

      document.getElementById('userInitial').textContent = initial;
      document.getElementById('userName').textContent = name;
      document.getElementById('userGrade').textContent = grade;
      document.getElementById('dropdownName').textContent = name;
      document.getElementById('dropdownGrade').textContent = grade;
    }
    
    profileBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      profileDropdown.classList.toggle('show');
    });
    
    document.addEventListener('click', (e) => {
      if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
        profileDropdown.classList.remove('show');
      }
    });
    
    document.getElementById('signOutBtn')?.addEventListener('click', async () => {
      if (confirm('Sign out of Vynix Buddy?')) {
        await auth.signOut();
        customAlert('Signed out');
        setTimeout(() => location.href = 'login.html', 800);
      }
    });
    
    // â”€â”€â”€â”€â”€â”€â”€ CONVERSATIONS SIDEBAR â”€â”€â”€â”€â”€â”€â”€
    function loadConversations() {
      if (!auth.currentUser) return;
      const convosRef = ref(db, `users/${auth.currentUser.uid}/conversations`);
      onValue(convosRef, (snapshot) => {
        const data = snapshot.val();
        conversations = data ? Object.keys(data).map(key => ({
          id: key,
          ...data[key],
          time: new Date(data[key].lastMessageAt || data[key].createdAt).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })
        })).sort((a, b) => (b.lastMessageAt || b.createdAt) - (a.lastMessageAt || a.createdAt)) : [];
        renderConversations();
      });
    }
    
    function renderConversations() {
      if (conversations.length === 0) {
        els.convoList.innerHTML = `<div class="p-8 text-center text-gray-500">No chats yet. Start a new one!</div>`;
        return;
      }

      els.convoList.innerHTML = conversations.map(c => `
        <div class="convo-item ${c.id === currentConvoId ? 'active' : ''}" data-id="${c.id}">
          <i data-lucide="message-square" class="w-5 h-5 text-purple-500"></i>
          <div class="title">${escapeHtml(c.title || 'New Chat')}</div>
          <div class="timestamp">${c.time}</div>
          <button class="delete-btn">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
          </button>
        </div>
      `).join('');

      lucide.createIcons();

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async (e) => {
          e.stopPropagation();
          const item = btn.closest('.convo-item');
          const id = item.dataset.id;
          if (confirm('Delete this chat permanently?')) {
            await remove(ref(db, `users/${auth.currentUser.uid}/conversations/${id}`));
            if (currentConvoId === id) {
              currentConvoId = null;
              startNewChat();
            }
          }
        };
      });

      document.querySelectorAll('.convo-item').forEach(item => {
        item.onclick = async (e) => {
          if (e.target.closest('.delete-btn')) return;
          const id = item.dataset.id;
          currentConvoId = id;
          await loadConversationHistory(id);
          document.querySelectorAll('.convo-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          closeSidebar();
        };
      });
    }
    
    async function startNewChat() {
      els.chatPane.innerHTML = `<div class="text-center mt-28 text-gray-600 px-4">
        <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
        <p class="text-lg">Your CAPS AI Tutor â€¢ Grades 1â€“12 â€¢ South Africa</p>
      </div>`;
      history = [];
      currentConvoId = null;
      customAlert("New chat started!");
    }
    
    async function loadConversationHistory(convoId) {
      const snap = await get(ref(db, `users/${auth.currentUser.uid}/conversations/${convoId}/messages`));
      const messages = snap.val();
      els.chatPane.innerHTML = `<div class="text-center mt-28 text-gray-600 px-4">
        <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
        <p class="text-lg">Loading your chat...</p>
      </div>`;

      if (!messages) {
        history = [];
        return;
      }

      history = Object.values(messages);
      els.chatPane.innerHTML = '';
      history.forEach(msg => {
        const isUser = msg.role === 'user';
        const content = isUser ? msg.content : marked.parse(msg.content);
        addMessage(content, isUser ? 'user' : 'ai', isUser ? '' : msg.content);
      });
    }
    
    async function saveMessage(userMsg, aiReply = null) {
      if (!auth.currentUser) return;

      let convoRef;
      if (!currentConvoId) {
        convoRef = push(ref(db, `users/${auth.currentUser.uid}/conversations`));
        currentConvoId = convoRef.key;
        await set(convoRef, {
          title: userMsg.slice(0, 40) + (userMsg.length > 40 ? '...' : ''),
          createdAt: Date.now(),
          lastMessageAt: Date.now()
        });
      } else {
        convoRef = ref(db, `users/${auth.currentUser.uid}/conversations/${currentConvoId}`);
        await update(convoRef, { lastMessageAt: Date.now() }); // FIXED: use update()
      }

      const messagesRef = child(convoRef, 'messages');
      await push(messagesRef, { role: 'user', content: userMsg, timestamp: Date.now() });
      if (aiReply) {
        await push(messagesRef, { role: 'assistant', content: aiReply, timestamp: Date.now() });
      }
    }
    
    // â”€â”€â”€â”€â”€â”€â”€ SIDEBAR CONTROLS â”€â”€â”€â”€â”€â”€â”€
    function openSidebar() {
      els.sidebar.classList.add('translate-x-0');
      els.overlay.classList.remove('hidden');
      setTimeout(() => els.overlay.classList.add('active'), 10);
    }
    
    function closeSidebar() {
      els.sidebar.classList.remove('translate-x-0');
      els.overlay.classList.remove('active');
      setTimeout(() => els.overlay.classList.add('hidden'), 300);
    }
    
    // Menu button event listeners
    document.getElementById('menuBtn').onclick = openSidebar;
    document.getElementById('desktopMenuBtn').onclick = () => els.sidebar.classList.toggle('translate-x-0');
    document.getElementById('closeSidebar').onclick = closeSidebar;
    document.getElementById('sidebarOverlay').onclick = closeSidebar;
    document.getElementById('newChatBtn').onclick = () => {
      startNewChat();
      closeSidebar();
    };
    
    // â”€â”€â”€â”€â”€â”€â”€ INITIALIZATION â”€â”€â”€â”€â”€â”€â”€
    els.sendBtn.onclick = send;
    
    // âŒ REMOVED duplicate onAuthStateChanged
    
    // âœ… SINGLE AUTH LISTENER
    onAuthStateChanged(auth, async (user) => {
      if (!user) { 
        location.href = "login.html"; 
        return; 
      }
      await init();
      await loadTokens();
      await checkAndAskProfile();
      loadConversations(); // Start loading conversations
    });
  </script>
</body>
</html>
