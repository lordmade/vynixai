<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Prism.js -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
   
    <style>
  :root {
    --bg: #F7F7F8;
    --card-bg: #1C2526;
    --text-primary: #FFFFFF;
    --text-secondary: #4B5EAA;
    --border: #4A5568;
    --highlight: #38B2AC;
    --user-msg-bg: #E0E7FF;
    --ai-msg-bg: #1C2526;
  }

  /* === REMOVE THE GLOBAL TOUCH/SELECT KILLERS === */
  /* We no longer disable everything globally ‚Äì only allow selection where we actually want it */

  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text-secondary);
    min-height: 100vh;
    margin: 0;
    overflow: hidden;
    touch-action: pan-y; /* crucial: allows normal vertical scrolling on the whole page */
  }

  /* Only allow text selection in inputs and message content (the only places users need it) */
  input, textarea, [contenteditable], .content {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
  }

  /* Explicitly re-enable touch scrolling inside the chat area and messages */
  #chat-messages,
  .message,
  .message * {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Re-enable text selection inside AI replies (for copy-paste) */
  .content {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
  }

  html, body {
    overscroll-behavior: none;
  }

  /* Hide scrollbars but keep scrolling */
  ::-webkit-scrollbar { display: none; }
  * { scrollbar-width: none; -ms-overflow-style: none; }

  .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; background: var(--bg); border-bottom: 1px solid var(--border); }
  .menu-btn { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 9999px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
  .menu-btn:hover { background: var(--highlight); }
  .v-logo { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 4px; }
  .v-logo svg { width: 22px; height: 22px; fill: white; }
  .welcome-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; margin-top: 3rem; }
  .welcome-container h1 { font-size: 1.25rem; font-weight: 600; color: #1E1E1E; }
  .hidden { display: none; }
  .chat-input-container { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); display: flex; align-items: flex-start; width: 90%; max-width: 600px; background: var(--card-bg); border-radius: 1.5rem; padding: 0.5rem 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 0.5rem; z-index: 20; }
  #chat-input { background: transparent; color: var(--text-primary); border: none; padding: 0.75rem 0.5rem; outline: none; font-size: 1rem; flex: 1; }
  #send-button { background: transparent; border: none; padding: 0.5rem; cursor: pointer; }
  #send-button svg { width: 1.5rem; height: 1.5rem; stroke: var(--text-primary); }
  #chat-messages { margin: 5rem 1rem 6rem 1rem; padding: 1rem; overflow-y: auto; max-height: calc(100vh - 11rem); -webkit-overflow-scrolling: touch; }

  .message {
    max-width: 70%;
    padding: 0.75rem 1.25rem;
    border-radius: 1.5rem;
    margin: 0.5rem 1rem;
    word-wrap: break-word;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
    position: relative;
    display: inline-block;
  }
  .message.user {
    background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE);
    color: #1E1E1E;
    margin-left: auto;
    border-bottom-right-radius: 0.25rem;
  }
  .message.ai {
    background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748);
    color: var(--text-primary);
    margin-right: auto;
    border-bottom-left-radius: 0.25rem;
  }
  .message-time { font-size: 0.65rem; opacity: 0.6; margin-top: 0.35rem; text-align: right; }
  .message-time.ai { text-align: left; }

  .copy-reply-btn {
    position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.15); border: none;
    border-radius: 8px; padding: 6px; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10;
  }
  .message.ai:hover .copy-reply-btn { opacity: 1; }
  .copy-reply-btn svg { width: 18px; height: 18px; stroke: white; }

  .content { user-select: text; line-height: 1.6; }
  .content h1, .content h2, .content h3, .content h4 { margin: 1.2em 0 0.6em; font-weight: 600; }
  .content h1 { font-size: 1.5em; } .content h2 { font-size: 1.35em; } .content h3 { font-size: 1.2em; }
  .content ul, .content ol { padding-left: 1.8em; margin: 0.8em 0; }
  .content li { margin: 0.4em 0; }
  .content blockquote { border-left: 4px solid var(--highlight); padding-left: 1em; margin: 1em 0; opacity: 0.9; font-style: italic; }
  .content table { width: 100%; border-collapse: collapse; margin: 1em 0; }
  .content th, .content td { border: 1px solid rgba(255,255,255,0.2); padding: 0.6em; text-align: left; }
  .content th { background: rgba(255,255,255,0.1); }
  .content hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 1.5em 0; }
  .content code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; }
  .content pre {
    position: relative; background: #2d2d2d !important; border-radius: 12px !important;
    padding: 20px !important; margin: 16px 0 !important; overflow-x: auto; border: 1px solid #444;
  }
  .content pre .code-copy-btn {
    position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.15);
    border: none; border-radius: 8px; padding: 6px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;
  }
  .content pre:hover .code-copy-btn { opacity: 1; }
  .content pre .code-copy-btn svg { width: 16px; height: 16px; stroke: white; }

  .sidebar { position: fixed; top: 0; left: -100%; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 40; overflow-y: auto; }
  .sidebar.open { left: 0; }
  .sidebar-header { padding: 1.5rem; background: #000; color: white; text-align: center; }
  .conv-item { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .conv-item:hover { background: #f0f0f0; }
  .conv-item.active { background: #e0e7ff; font-weight: 600; }
  .delete-conv { color: #ef4444; opacity: 0.7; cursor: pointer; }
  #api-status { position: absolute; right: 16px; top: 16px; width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s; }
  #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }
  #upgrade-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.4s; }
  #upgrade-modal-overlay.show { opacity: 1; visibility: visible; }
  #upgrade-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: linear-gradient(135deg, #0f172a, #1e293b); color: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 25px 80px rgba(0,0,0,0.6); max-width: 90%; width: 420px; text-align: center; z-index: 1000; opacity: 0; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
  #upgrade-modal.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  #user-plan-badge { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #38B2AC, #4ADEDE); color: white; padding: 10px 20px; border-radius: 9999px; font-weight: 700; font-size: 0.9rem; box-shadow: 0 4px 20px rgba(56,178,172,0.4); z-index: 50; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
  
  </style>
</head>
<body>
  <main class="flex flex-col h-screen">
    <div class="header-container">
      <button id="menu-btn" class="menu-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>Menu</span>
      </button>
      <div class="v-logo">
        <svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg>
      </div>
      <div id="api-status"></div>
    </div>

    <div class="welcome-container" id="welcome-container">
      <h1>Hey there!</h1>
      <p class="mt-4 text-gray-600">Start chatting ‚Äî replies are instant</p>
    </div>

    <div id="chat-messages"></div>

    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Type a message..." autofocus>
      <button id="send-button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M5 12l6-6m-6 6l6 6"/>
        </svg>
      </button>
    </div>

    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="v-logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
        <div style="margin-top: 1rem; text-align: center;">
          <div id="slide-profile-pic" style="width: 72px; height: 72px; border-radius: 50%; background: #38B2AC; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">U</div>
          <h2 id="slide-username" style="font-size: 1.25rem; font-weight: 700;">User</h2>
        </div>
      </div>
      <button id="new-conv-sidebar" class="w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold">+ New Conversation</button>
      <div id="conv-list" class="mt-4"></div>
      <div id="user-plan-badge">Free Plan ‚Ä¢ 25,000 tokens/day</div>
    </div>

    <div id="upgrade-modal-overlay"></div>
    <div id="upgrade-modal">
      <h2>Upgrade Vynix AI</h2>
      <p>You've reached today's free limit. Unlock more with a plan!</p>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
        <div style="border: 1px solid #444; border-radius: 1rem; padding: 1rem; text-align: center;">
          <h3>Free</h3><div style="font-size: 1.5rem; font-weight: bold;">R0</div><div>25,000 tokens/day</div><button style="margin-top: 1rem; opacity: 0.5;">Current Plan</button>
        </div>
        <div style="border: 2px solid #38B2AC; border-radius: 1rem; padding: 1rem; text-align: center;">
          <h3>Pro</h3><div style="font-size: 1.5rem; font-weight: bold;">R99<span style="font-size:0.8rem;">/month</span></div>
          <div>1,000,000 tokens/month<br><small>~33,000/day ‚Ä¢ Unlimited chats</small></div>
          <button style="margin-top: 1rem; background: #38B2AC; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem;">Upgrade to Pro (Coming Soon)</button>
        </div>
      </div>
      <button id="upgrade-close" style="margin-top: 1rem; opacity: 0.7;">Maybe later</button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let xaiApiKey = null;
    let xaiEndpoint = "https://api.x.ai/v1/chat/completions";
    const statusDot = document.getElementById('api-status');
    let userId = null;
    let todayTokensUsed = 0;
    const DAILY_TOKEN_LIMIT = 25000;

    const SYSTEM_PROMPT = `You are Vynix AI, a super helpful, witty, and friendly AI assistant created by the vynix.ai team.
Never mention Grok, xAI, Elon Musk, or any other model. You are Vynix AI ‚Äî that's your full identity.
If asked who you are, say: "I'm Vynix AI, proudly built by the vynix.ai team ‚ù§Ô∏è".`;

    marked.setOptions({
      highlight: function(code, lang) {
        if (Prism.languages[lang]) return Prism.highlight(code, Prism.languages[lang], lang);
        return code;
      },
      breaks: true,
      gfm: true
    });

    function renderMarkdown(text) {
      let html = marked.parse(text);
      html = html.replace(/<pre><code class="language-([\w-]+)">([\s\S]*?)<\/code><\/pre>/g,
        '<pre><code class="language-$1">$2</code><button class="code-copy-btn"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button></pre>'
      );
      return html;
    }

    async function initXaiConfig() {
      const remoteConfig = getRemoteConfig(app);
      remoteConfig.settings.minimumFetchIntervalMillis = 3600000;
      await fetchAndActivate(remoteConfig);
      xaiApiKey = getString(remoteConfig, 'xai_api_key').trim();
      const ep = getString(remoteConfig, 'xai_endpoint').trim();
      if (ep) xaiEndpoint = ep;
      if (xaiApiKey && xaiApiKey.length > 10) statusDot.classList.add('connected');
    }

    async function loadDailyUsage() {
      if (!userId) return;
      const today = new Date().toISOString().slice(0,10);
      const snap = await get(ref(db, `usage/${userId}/${today}`));
      todayTokensUsed = snap.val() || 0;
    }

    async function addTokensUsed(inputTokens, outputTokens) {
      if (!userId) return;
      todayTokensUsed += inputTokens + outputTokens;
      const today = new Date().toISOString().slice(0,10);
      await set(ref(db, `usage/${userId}/${today}`), todayTokensUsed);
    }

    function estimateTokens(text) { return Math.ceil(text.length / 3.8); }

    async function getReplyFromXai(userMessage, history = []) {
      if (!xaiApiKey) return "Vynix AI is waking up‚Ä¶";
      const messages = [{ role: "system", content: SYSTEM_PROMPT }];
      history.slice(-20).forEach(m => messages.push({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text }));
      messages.push({ role: "user", content: userMessage });

      const inputTokens = estimateTokens(messages.map(m => m.content).join('\n'));
      if (todayTokensUsed + inputTokens > DAILY_TOKEN_LIMIT) {
        document.getElementById('upgrade-modal-overlay').classList.add('show');
        document.getElementById('upgrade-modal').classList.add('show');
        return "You've reached today's free limit! Upgrade for unlimited access ‚ù§Ô∏è";
      }

      try {
        const res = await fetch(xaiEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${xaiApiKey}` },
          body: JSON.stringify({ model: "grok-3", messages, temperature: 0.8, stream: false })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const reply = data.choices[0].message.content.trim();
        await addTokensUsed(inputTokens, estimateTokens(reply));
        return reply;
      } catch (err) {
        console.error(err);
        return "Oops! My brain had a hiccup. Try again? üòÖ";
      }
    }

    async function startTypingEffect(text, contentDiv) {
      contentDiv.innerHTML = '';
      let i = 0;
      while (i < text.length) {
        const chunk = text.substring(i, i + 8);
        contentDiv.innerHTML += chunk.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]) || c);
        contentDiv.scrollIntoView({behavior:"smooth", block:"nearest"});
        await new Promise(r => setTimeout(r, 10 + Math.random()*15));
        i += 8;
      }
      contentDiv.innerHTML = renderMarkdown(text);
      Prism.highlightAllUnder(contentDiv);
      attachCodeCopyButtons();
    }

    function attachCodeCopyButtons() {
      document.querySelectorAll('pre .code-copy-btn').forEach(btn => {
        btn.onclick = e => {
          e.stopPropagation();
          const code = btn.previousElementSibling.textContent;
          navigator.clipboard.writeText(code);
          btn.innerHTML = '‚úì';
          setTimeout(() => btn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`, 1500);
        };
      });
    }

    function copyFullReply(text, btn) {
      navigator.clipboard.writeText(text);
      btn.innerHTML = '‚úì';
      setTimeout(() => btn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`, 1500);
    }

    function addMessage(text, sender, timestamp = Date.now(), isNewReply = false) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;

      if (sender === 'ai') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-reply-btn';
        copyBtn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`;
        copyBtn.onclick = e => { e.stopPropagation(); copyFullReply(text, copyBtn); };
        div.appendChild(copyBtn);
      }

      const content = document.createElement('div');
      content.className = 'content';

      const time = document.createElement('div');
      time.className = `message-time ${sender}`;
      time.textContent = new Date(timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      div.appendChild(content);
      div.appendChild(time);
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;

      if (sender === 'ai' && isNewReply) {
        startTypingEffect(text, content);
      } else {
        content.innerHTML = sender === 'ai' ? renderMarkdown(text) : text.replace(/\n/g, '<br>');
        if (sender === 'ai') { Prism.highlightAllUnder(content); attachCodeCopyButtons(); }
      }
    }

    const el = {
      messages: document.getElementById('chat-messages'),
      input: document.getElementById('chat-input'),
      send: document.getElementById('send-button'),
      welcome: document.getElementById('welcome-container'),
      menuBtn: document.getElementById('menu-btn'),
      sidebar: document.getElementById('sidebar'),
      convList: document.getElementById('conv-list'),
      newConvSidebar: document.getElementById('new-conv-sidebar'),
      overlay: document.getElementById('upgrade-modal-overlay'),
      modal: document.getElementById('upgrade-modal'),
      modalClose: document.getElementById('upgrade-close'),
      slideProfilePic: document.getElementById('slide-profile-pic'),
      slideUsername: document.getElementById('slide-username'),
      userPlanBadge: document.getElementById('user-plan-badge')
    };

    let conversations = {}, currentConvId = null, messageHistory = [];

    document.addEventListener('click', e => {
      if (!el.sidebar.contains(e.target) && !el.menuBtn.contains(e.target)) el.sidebar.classList.remove('open');
    });
    el.menuBtn.onclick = e => { e.stopPropagation(); el.sidebar.classList.toggle('open'); };

    function saveMessage(text, sender) {
      if (!currentConvId) return;
      push(ref(db, `users/${userId}/conversations/${currentConvId}/messages`), { text, sender, timestamp: Date.now() });
    }

    async function send() {
      const text = el.input.value.trim();
      if (!text) return;
      if (!currentConvId) startNewConversation();
      addMessage(text, 'user');
      saveMessage(text, 'user');
      messageHistory.push({ sender: 'user', text });
      el.input.value = '';
      addMessage("Typing...", 'ai');
      await loadDailyUsage();
      const reply = await getReplyFromXai(text, messageHistory);
      el.messages.lastElementChild.remove();
      addMessage(reply, 'ai', Date.now(), true);
      messageHistory.push({ sender: 'ai', text: reply });
      saveMessage(reply, 'ai');
    }

    function startNewConversation() {
      messageHistory = [];
      el.messages.innerHTML = '';
      el.welcome.classList.add('hidden');
      const convRef = push(ref(db, `users/${userId}/conversations`));
      currentConvId = convRef.key;
      set(convRef, { createdAt: Date.now(), title: "New Chat" });
      renderSidebar();
    }

    function loadConversation(id, data) {
      currentConvId = id;
      messageHistory = [];
      el.messages.innerHTML = '';
      el.welcome.classList.add('hidden');
      if (data.messages) {
        Object.entries(data.messages).sort(([,a],[,b]) => a.timestamp - b.timestamp)
          .forEach(([, m]) => {
            addMessage(m.text, m.sender, m.timestamp, false);
            if (m.sender !== 'system') messageHistory.push({ sender: m.sender, text: m.text });
          });
      }
      renderSidebar();
    }

    function deleteConversation(id) {
      remove(ref(db, `users/${userId}/conversations/${id}`));
      if (id === currentConvId) {
        el.messages.innerHTML = '';
        el.welcome.classList.remove('hidden');
        currentConvId = null;
        messageHistory = [];
      }
      renderSidebar();
    }

    function renderSidebar() {
      el.convList.innerHTML = '';
      Object.entries(conversations)
        .sort(([,a],[,b]) => b.createdAt - a.createdAt)
        .forEach(([id, conv]) => {
          const div = document.createElement('div');
          div.className = `conv-item ${id === currentConvId ? 'active' : ''}`;
          div.innerHTML = `<span>${conv.title || "New Chat"}</span>
            <button class="delete-conv"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`;
          div.querySelector('.delete-conv').onclick = e => { e.stopPropagation(); deleteConversation(id); };
          div.onclick = () => loadConversation(id, conv);
          el.convList.appendChild(div);
        });
    }

    async function loadUserProfileAndPlan() {
      if (!userId) return;
      const snap = await get(ref(db, `users/${userId}`));
      const user = snap.val() || {};
      const initial = (user.displayName || 'U')[0].toUpperCase();
      el.slideProfilePic.textContent = user.photoURL ? '' : initial;
      if (user.photoURL) el.slideProfilePic.innerHTML = `<img src="${user.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
      el.slideUsername.textContent = user.displayName || 'User';
      const plan = user.plan || 'free';
      el.userPlanBadge.textContent = plan === 'free' ? 'Free Plan ‚Ä¢ 25,000 tokens/day' : 'Pro Plan ‚Ä¢ 1,000,000 tokens/month';
      if (plan === 'pro') el.userPlanBadge.style.background = 'linear-gradient(135deg, #f59e0b, #f97316)';
    }

    function loadUserData(uid) {
      userId = uid;
      onValue(ref(db, `users/${uid}/conversations`), snap => {
        conversations = snap.val() || {};
        renderSidebar();
        if (!currentConvId && Object.keys(conversations).length) {
          const latest = Object.entries(conversations).sort(([,a],[,b]) => b.createdAt - a.createdAt)[0];
          loadConversation(latest[0], latest[1]);
        }
      });
    }

    el.newConvSidebar.onclick = startNewConversation;
    el.send.onclick = send;
    el.input.addEventListener('keypress', e => { if (e.key === 'Enter') send(); });
    el.modalClose.onclick = () => { el.overlay.classList.remove('show'); el.modal.classList.remove('show'); };
    el.overlay.onclick = () => { el.overlay.classList.remove('show'); el.modal.classList.remove('show'); };

    onAuthStateChanged(auth, async user => {
      if (user) {
        userId = user.uid;
        await loadDailyUsage();
        await loadUserProfileAndPlan();
        loadUserData(user.uid);
        initXaiConfig();
      } else {
        signInAnonymously(auth);
      }
    });
  </script>
</body>
</html>
