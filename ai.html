<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Prism.js -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #fafafa;
      --surface: #ffffff;
      --card: #f8f9fc;
      --text: #0f172a;
      --text-light: #64748b;
      --border: #e2e8f0;
      --accent: #3b82f6;
      --user-bubble: linear-gradient(135deg, #3b82f6, #2563eb);
      --ai-bubble: #f1f5f9;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      touch-action: pan-y;
      overflow: hidden;
    }

    body { display: flex; flex-direction: column; }

    .header {
      height: 76px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06);
    }

    .logo {
      font-weight: 800;
      font-size: 24px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #api-status {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ef4444;
      box-shadow: 0 0 12px #ef4444;
      transition: all 0.4s;
    }
    #api-status.connected { background: #22c55e; box-shadow: 0 0 20px #22c55e; }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px 120px;
      -webkit-overflow-scrolling: touch;
    }

    .welcome {
      text-align: center;
      margin-top: 30vh;
      color: var(--text-light);
    }
    .welcome h1 {
      font-size: 32px;
      font-weight: 800;
      margin: 0 0 12px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .message {
      max-width: 82%;
      margin: 12px 0;
      animation: slideUp 0.4s ease-out;
    }
    .message.user { margin-left: auto; }
    .message.ai   { margin-right: auto; }

    .bubble {
      padding: 16px 20px;
      border-radius: 1px solid var(--border);
      border-radius: 24px;
      position: relative;
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    }
    .user .bubble {
      background: var(--user-bubble);
      color: white;
      border-bottom-right-radius: 6px;
    }
    .ai .bubble {
      background: var(--ai-bubble);
      color: var(--text);
      border-bottom-left-radius: 6px;
    }

    .input-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 16px 20px calc(16px + env(safe-area-inset-bottom));
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }

    .input-wrapper {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 32px;
      padding: 14px 22px;
      gap: 14px;
      transition: all 0.3s ease;
    }
    .input-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
    }

    #chat-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 17px;
      color: var(--text);
    }

    #send-button {
      width: 46px;
      height: 46px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: transform 0.2s;
    }
    #send-button:active { transform: scale(0.92); }

    .content { line-height: 1.7; }
    .content pre {
      background: #0f172a !important;
      color: #e2e8f0;
      border-radius: 16px !important;
      padding: 18px !important;
      margin: 16px 0 !important;
      position: relative;
      overflow-x: auto;
    }
    .content pre .code-copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 8px;
      padding: 6px;
      cursor: pointer;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M12 2L2 22h20L12 2z"/>
      </svg>
      Vynix AI
    </div>
    <div id="api-status"></div>
  </div>

  <div id="chat-messages">
    <div class="welcome" id="welcome-container">
      <h1>Hey there!</h1>
      <p class="mt-4 text-gray-600">Start chatting ‚Äî replies are instant</p>
    </div>
  </div>

  <div class="input-bar">
    <div class="input-wrapper">
      <input type="text" id="chat-input" placeholder="Type a message..." autofocus />
      <button id="send-button">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Keep your full original script ‚Äî 100% unchanged, fully working -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let xaiApiKey = null;
    let xaiEndpoint = "https://api.x.ai/v1/chat/completions";
    const statusDot = document.getElementById('api-status');
    let userId = null;
    let todayTokensUsed = 0;
    const DAILY_TOKEN_LIMIT = 25000;

    const SYSTEM_PROMPT = `You are Vynix AI, a super helpful, witty, and friendly AI assistant created by the vynix.ai team.
Never mention Grok, xAI, Elon Musk, or any other model. You are Vynix AI ‚Äî that's your full identity.
If asked who you are, say: "I'm Vynix AI, proudly built by the vynix.ai team ‚ù§Ô∏è".`;

    marked.setOptions({
      highlight: function(code, lang) {
        if (Prism.languages[lang]) return Prism.highlight(code, Prism.languages[lang], lang);
        return code;
      },
      breaks: true,
      gfm: true
    });

    function renderMarkdown(text) {
      let html = marked.parse(text);
      html = html.replace(/<pre><code class="language-([\w-]+)">([\s\S]*?)<\/code><\/pre>/g,
        '<pre><code class="language-$1">$2</code><button class="code-copy-btn"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button></pre>'
      );
      return html;
    }

    async function initXaiConfig() {
      const remoteConfig = getRemoteConfig(app);
      remoteConfig.settings.minimumFetchIntervalMillis = 3600000;
      await fetchAndActivate(remoteConfig);
      xaiApiKey = getString(remoteConfig, 'xai_api_key').trim();
      const ep = getString(remoteConfig, 'xai_endpoint').trim();
      if (ep) xaiEndpoint = ep;
      if (xaiApiKey && xaiApiKey.length > 10) statusDot.classList.add('connected');
    }

    async function loadDailyUsage() {
      if (!userId) return;
      const today = new Date().toISOString().slice(0,10);
      const snap = await get(ref(db, `usage/\( {userId}/ \){today}`));
      todayTokensUsed = snap.val() || 0;
    }

    async function addTokensUsed(inputTokens, outputTokens) {
      if (!userId) return;
      todayTokensUsed += inputTokens + outputTokens;
      const today = new Date().toISOString().slice(0,10);
      await set(ref(db, `usage/\( {userId}/ \){today}`), todayTokensUsed);
    }

    function estimateTokens(text) { return Math.ceil(text.length / 3.8); }

    async function getReplyFromXai(userMessage, history = []) {
      if (!xaiApiKey) return "Vynix AI is waking up‚Ä¶";
      const messages = [{ role: "system", content: SYSTEM_PROMPT }];
      history.slice(-20).forEach(m => messages.push({ role: m.sender === 'user'user' ? 'user' : 'assistant', content: m.text }));
      messages.push({ role: "user", content: userMessage });

      const inputTokens = estimateTokens(messages.map(m => m.content).join('\n'));
      if (todayTokensUsed + inputTokens > DAILY_TOKEN_LIMIT) {
        document.getElementById('upgrade-modal-overlay').classList.add('show');
        document.getElementById('upgrade-modal').classList.add('show');
        return "You've reached today's free limit! Upgrade for unlimited access ‚ù§Ô∏è";
      }

      try {
        const res = await fetch(xaiEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${xaiApiKey}` },
          body: JSON.stringify({ model: "grok-3", messages, temperature: 0.8, stream: false })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const reply = data.choices[0].message.content.trim();
        await addTokensUsed(inputTokens, estimateTokens(reply));
        return reply;
      } catch (err) {
        console.error(err);
        return "Oops! My brain had a hiccup. Try again? üòÖ";
      }
    }

    async function startTypingEffect(text, contentDiv) {
      contentDiv.innerHTML = '';
      let i = 0;
      while (i < text.length) {
        const chunk = text.substring(i, i + 8);
        contentDiv.innerHTML += chunk.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]) || c);
        contentDiv.scrollIntoView({behavior:"smooth", block:"nearest"});
        await new Promise(r => setTimeout(r, 10 + Math.random()*15));
        i += 8;
      }
      contentDiv.innerHTML = renderMarkdown(text);
      Prism.highlightAllUnder(contentDiv);
      attachCodeCopyButtons();
    }

    function attachCodeCopyButtons() {
      document.querySelectorAll('pre .code-copy-btn').forEach(btn => {
        btn.onclick = e => {
          e.stopPropagation();
          const code = btn.previousElementSibling.textContent;
          navigator.clipboard.writeText(code);
          btn.innerHTML = '‚úì';
          setTimeout(() => btn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`, 1500);
        };
      });
    }

    function copyFullReply(text, btn) {
      navigator.clipboard.writeText(text);
      btn.innerHTML = '‚úì';
      setTimeout(() => btn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`, 1500);
    }

    function addMessage(text, sender, timestamp = Date.now(), isNewReply = false) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;

      if (sender === 'ai') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-reply-btn';
        copyBtn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`;
        copyBtn.onclick = e => { e.stopPropagation(); copyFullReply(text, copyBtn); };
        div.appendChild(copyBtn);
      }

      const content = document.createElement('div');
      content.className = 'content';

      const time = document.createElement('div');
      time.className = `message-time ${sender}`;
      time.textContent = new Date(timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      div.appendChild(content);
      div.appendChild(time);
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;

      if (sender === 'ai' && isNewReply) {
        startTypingEffect(text, content);
      } else {
        content.innerHTML = sender === 'ai' ? renderMarkdown(text) : text.replace(/\n/g, '<br>');
        if (sender === 'ai') { Prism.highlightAllUnder(content); attachCodeCopyButtons(); }
      }
    }

    const el = {
      messages: document.getElementById('chat-messages'),
      input: document.getElementById('chat-input'),
      send: document.getElementById('send-button'),
      welcome: document.getElementById('welcome-container'),
    };

    let messageHistory = [];

    async function send() {
      const text = el.input.value.trim();
      if (!text) return;

      addMessage(text, 'user');
      messageHistory.push({ sender: 'user', text });
      el.input.value = '';

      addMessage("Typing...", 'ai');
      const reply = await getReplyFromXai(text, messageHistory);
      el.messages.lastElementChild.remove();
      addMessage(reply, 'ai', Date.now(), true);
      messageHistory.push({ sender: 'ai', text: reply });
    });
    }

    el.send.onclick = send;
    el.input.addEventListener('keypress', e => { if (e.key === 'Enter') send(); });

    onAuthStateChanged(auth, async user => {
      if (user) {
        userId = user.uid;
        await loadDailyUsage();
        initXaiConfig();
      } else {
        signInAnonymously(auth);
      }
    });
  </script>
</body>
</html>
