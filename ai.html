<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Vynix%20Buddy%22,%22short_name%22:%22Vynix%22,%22description%22:%22Your%20CAPS%20AI%20Tutor%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%22},{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%22}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Yoco SDK -->
  <script src="https://js.yoco.com/sdk/v1/yoco.min.js"></script>

  <style>
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#fff;color:#0f172a;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .header{position:fixed;top:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border-bottom:1px solid #e2e8f0;z-index:100;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .logo{font-size:1.5rem;font-weight:900;background:linear-gradient(135deg,#8b5cf6,#ec4899);-webkit-background-clip:text;background-clip:text;color:transparent}
    .token-display{font-size:.875rem;background:#f1f5f9;padding:6px 12px;border-radius:999px;border:1px solid #cbd5e1;font-weight:600;color:#475569}
    .upgrade-btn{background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;padding:8px 16px;border-radius:999px;font-weight:600;font-size:.875rem;border:none;cursor:pointer;transition:all .2s}
    .upgrade-btn:active{transform:scale(.95)}
    .tabs{position:fixed;top:68px;left:50%;transform:translateX(-50%);background:#f8fafc;border-radius:999px;padding:6px;display:flex;gap:6px;z-index:90;border:1px solid #e2e8f0;box-shadow:0 8px 32px rgba(0,0,0,.08)}
    .tab{padding:10px 28px;border-radius:999px;font-weight:600;font-size:.95rem;transition:all .3s;display:flex;align-items:center;gap:8px;color:#64748b}
    .tab.active{background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff}
    .message{margin:16px 0;max-width:88%;animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
    .message.ai{align-self:flex-start}
    .message.user{align-self:flex-end}
    .message.ai .content{background:#f8fafc;color:#0f172a;border-radius:18px 18px 18px 4px;padding:14px 18px;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .message.user .content{background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;border-radius:18px 18px 4px 18px;padding:14px 18px}
    .timestamp{font-size:.75rem;color:#94a3b8;margin-top:4px;text-align:right}
    .ai-actions{display:flex;gap:10px;margin-top:8px;opacity:.9}
    .action-btn{width:36px;height:36px;background:#f1f5f9;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
    .action-btn:hover{background:#e2e8f0;transform:scale(1.1)}
    .whatsapp-btn{background:#25d366!important;color:#fff!important}
    .thinking{display:flex;gap:8px;padding:14px 18px;background:#f8fafc;border-radius:18px 18px 18px 4px;border:1px solid #e2e8f0;width:fit-content}
    .dot{width:10px;height:10px;background:#8b5cf6;border-radius:50%;animation:pulse 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
    .voice-avatar{width:180px;height:180px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#ec4899);position:relative;overflow:hidden;box-shadow:0 20px 50px rgba(139,92,246,.3);border:6px solid #fff}
    .voice-wave{position:absolute;inset:0;background:conic-gradient(from 0deg at 50% 50%,transparent 0deg,rgba(255,255,255,.3) 90deg,transparent 180deg);animation:spin 8s linear infinite;opacity:0}
    .voice-listening .voice-wave,.voice-speaking .voice-wave{opacity:.8;animation-duration:2s}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .ring{position:absolute;inset:0;border:4px solid #8b5cf6;border-radius:50%;opacity:0;animation:pulseRing 2s infinite}
    .ring:nth-child(2){animation-delay:.3s}
    .ring:nth-child(3){animation-delay:.6s}
    @keyframes pulseRing{0%{transform:scale(.8);opacity:.6}100%{transform:scale(1.8);opacity:0}}
    .voice-status{font-size:1.5rem;font-weight:700;color:#1e293b}
    .voice-hint{color:#64748b;font-size:1rem;text-align:center;max-width:80%}
    .mic-button{width:84px;height:84px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#ec4899);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 40px rgba(139,92,246,.4);transition:all .3s;cursor:pointer;border:none;color:#fff;font-weight:600}
    .mic-button.recording{background:#ef4444;animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 12px 40px rgba(239,68,68,.5)}50%{box-shadow:0 12px 60px rgba(239,68,68,.8)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom));border-top:1px solid #e2e8f0;z-index:80}
    .input-container{background:#f1f5f9;border-radius:999px;padding:12px 16px;display:flex;align-items:center;gap:12px;border:1px solid #cbd5e1;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    #chatInput{flex:1;background:transparent;border:none;outline:none;color:#0f172a;font-size:1.1rem;resize:none}
    .send-btn{width:44px;height:44px;background:linear-gradient(135deg,#8b5cf6,#ec4899);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer}
    .bottom-sheet{position:fixed;bottom:-100%;left:0;right:0;background:#fff;border-radius:1.5rem 1.5rem 0 0;padding:1.5rem;box-shadow:0 -10px 40px rgba(0,0,0,.2);transition:bottom .4s cubic-bezier(.32,.72,0,1);z-index:200;max-height:92dvh;overflow-y:auto}
    .bottom-sheet.active{bottom:0}
    .sheet-handle{width:40px;height:5px;background:#ddd;border-radius:3px;margin:0 auto 1rem}
    #installPopup{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;border-radius:1.5rem;padding:1.5rem;box-shadow:0 20px 50px rgba(0,0,0,.25);z-index:999;max-width:90%;display:none;animation:slideUp .5s ease}
    #installPopup.show{display:block}
    @keyframes slideUp{from{transform:translateX(-50%) translateY(100px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    .install-content{text-align:center}
    .install-title{font-size:1.25rem;font-weight:700;margin-bottom:.5rem}
    .install-text{color:#64748b;margin-bottom:1.5rem}
    .install-buttons{display:flex;gap:12px;justify-content:center}
    .install-btn{padding:12px 24px;border-radius:999px;font-weight:600;cursor:pointer;transition:all .2s;border:none}
    .install-primary{background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff}
    .install-secondary{background:#f1f5f9;color:#475569}
    #customAlert{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120%);background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;padding:12px 24px;border-radius:999px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:9999;transition:transform .4s cubic-bezier(.68,-.55,.27,1.55)}
    #customAlert.show{transform:translateX(-50%) translateY(0)}
    .error-message{background:#fee2e2;border:1px solid #fecaca;color:#dc2626;padding:12px 18px;border-radius:12px;margin:10px 16px;max-width:88%;align-self:center}
    #voicePane{display:none;flex-direction:column;align-items:center;justify-content:center;padding:120px 20px 100px;height:100%;gap:30px}
    #voicePane.active{display:flex}
    #chatPane{flex:1;padding:120px 16px 100px;overflow-y:auto;display:flex;flex-direction:column}
  </style>
</head>
<body class="bg-white">

  <!-- Header -->
  <div class="header">
    <div class="logo">Vynix</div>
    <div class="flex items-center gap-3">
      <div class="token-display"><span id="tokenCount">15,000</span> tokens left</div>
      <button id="upgradePill" class="upgrade-btn">Upgrade</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="chat"><i data-lucide="message-circle" class="w-4 h-4"></i>Chat</button>
    <button class="tab" data-tab="voice"><i data-lucide="mic" class="w-4 h-4"></i>Voice</button>
  </div>

  <!-- Chat Pane -->
  <section id="chatPane" class="flex flex-col"></section>

  <!-- Voice Pane -->
  <section id="voicePane">
    <p class="voice-hint">Tap the mic and speak â€¢ I'll reply out loud</p>
    <div class="voice-status" id="voiceStatus">Ready to help</div>
    <div class="voice-avatar" id="voiceAvatar">
      <div class="voice-wave"></div>
      <div class="ring"></div><div class="ring"></div><div class="ring"></div>
      <i data-lucide="brain" class="text-white w-20 h-20 absolute inset-0 m-auto opacity-90"></i>
    </div>
    <button class="mic-button" id="voiceMicBtn" aria-label="Start / stop microphone">
      <i data-lucide="mic" class="w-7 h-7"></i>
    </button>
  </section>

  <!-- Input Bar -->
  <div class="input-bar" id="chatInputBar">
    <div class="input-container">
      <button id="uploadBtn" aria-label="Attach image">
        <i data-lucide="paperclip" class="w-5 h-5"></i>
      </button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" aria-label="Send">
        <i data-lucide="send" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <!-- Install Popup -->
  <div id="installPopup">
    <div class="install-content">
      <div class="install-title">Install Vynix Buddy</div>
      <p class="install-text">Get faster access â€” add to your home screen!</p>
      <div class="install-buttons">
        <button id="installBtn" class="install-btn install-primary">
          <i data-lucide="download" class="w-4 h-4 mr-2"></i>Install
        </button>
        <button id="dismissInstall" class="install-btn install-secondary">No thanks</button>
      </div>
    </div>
  </div>

  <!-- Upgrade Bottom Sheet -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-gray-400" aria-label="Close">
      <i data-lucide="x" class="w-6 h-6"></i>
    </button>
    <div class="text-center px-6">
      <h2 class="text-3xl font-black mb-3">Never Run Out Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <strong>Unlimited</strong> â€” just <strong>R79/month</strong></p>
      <div class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl mb-8">
        <div class="text-6xl font-black">R79</div>
        <div class="text-xl opacity-90">per month</div>
      </div>
      <button id="yocoPayBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">
        <i data-lucide="credit-card" class="w-6 h-6 inline mr-2"></i>Pay with Yoco
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="customAlert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, push } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let history = [];
    let currentImage = null;
    let dailyTokens = 15000;
    let isPremium = false;
    let recognition = null;
    let isRecording = false;
    let thinkingMessage = null;
    let deferredPrompt;
    let yocoInstance = null; // Yoco SDK instance

    const els = {
      chatPane: document.getElementById('chatPane'),
      voicePane: document.getElementById('voicePane'),
      chatInputBar: document.getElementById('chatInputBar'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      upgradePill: document.getElementById('upgradePill'),
      voiceStatus: document.getElementById('voiceStatus'),
      voiceMicBtn: document.getElementById('voiceMicBtn'),
      voiceAvatar: document.getElementById('voiceAvatar'),
      tabs: document.querySelectorAll('.tab'),
      installPopup: document.getElementById('installPopup'),
      installBtn: document.getElementById('installBtn'),
      dismissInstall: document.getElementById('dismissInstall'),
      yocoPayBtn: document.getElementById('yocoPayBtn')
    };

    // PWA Install Prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (window.innerWidth < 768 && !localStorage.getItem('vynix-installed') && !localStorage.getItem('vynix-dismissed')) {
        setTimeout(() => {
          els.installPopup.classList.add('show');
        }, 3000);
      }
    });

    els.installBtn.onclick = async () => {
      els.installPopup.classList.remove('show');
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        localStorage.setItem('vynix-installed', 'true');
      }
      deferredPrompt = null;
    };

    els.dismissInstall.onclick = () => {
      els.installPopup.classList.remove('show');
      localStorage.setItem('vynix-dismissed', 'true');
    };

    function customAlert(msg) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), 2800);
    }

    function formatTime() {
      return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
    }

    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) {
        els.upgradeSheet.classList.add('active');
        return false;
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val() || {};
        const now = Date.now();
        if (!data.lastReset || now - data.lastReset > 86400000) {
          dailyTokens = 15000;
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { els.tokenCount.textContent = "15,000"; }
    }

    function shareToWhatsApp(text, imageUrl = null) {
      let message = "Vynix Buddy Answer:\n\n" + text.replace(/<[^>]*>/g, '').trim();
      if (imageUrl) message += `\n\nImage: ${imageUrl}`;
      const encoded = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encoded}`, '_blank');
      customAlert("Opening WhatsApp...");
    }

    function showThinking() {
      if (thinkingMessage) thinkingMessage.remove();
      thinkingMessage = document.createElement('div');
      thinkingMessage.className = 'message ai flex flex-col';
      thinkingMessage.innerHTML = `<div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
      els.chatPane.appendChild(thinkingMessage);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    function hideThinking() {
      if (thinkingMessage) {
        thinkingMessage.remove();
        thinkingMessage = null;
      }
    }

    els.tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        els.tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const isVoice = tab.dataset.tab === 'voice';
        els.chatPane.style.display = isVoice ? 'none' : 'flex';
        els.voicePane.classList.toggle('active', isVoice);
        els.chatInputBar.style.display = isVoice ? 'none' : 'block';
        if (isVoice && !recognition) initSpeechRecognition();
      });
    });

    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        els.voiceStatus.textContent = "Voice not supported";
        els.voiceMicBtn.disabled = true;
        els.voiceMicBtn.style.opacity = '0.5';
        customAlert("Voice recognition not supported");
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-ZA';
      recognition.continuous = false;
      recognition.onstart = () => {
        isRecording = true;
        els.voiceStatus.textContent = "Listening...";
        els.voiceAvatar.classList.add('voice-listening');
        els.voiceMicBtn.innerHTML = `<i data-lucide="stop-circle" class="w-7 h-7"></i>`;
        lucide.createIcons();
      };
      recognition.onresult = async e => {
        const text = e.results[0][0].transcript;
        await processVoiceInput(text);
      };
      recognition.onend = () => {
        isRecording = false;
        els.voiceStatus.textContent = "Ready to help";
        els.voiceAvatar.classList.remove('voice-listening', 'voice-speaking');
        els.voiceMicBtn.innerHTML = `<i data-lucide="mic" class="w-7 h-7"></i>`;
        lucide.createIcons();
      };
      recognition.onerror = (e) => {
        console.error("Speech error:", e.error);
        isRecording = false;
        els.voiceStatus.textContent = "Voice error. Tap to try again.";
        els.voiceAvatar.classList.remove('voice-listening', 'voice-speaking');
        els.voiceMicBtn.innerHTML = `<i data-lucide="mic" class="w-7 h-7"></i>`;
        lucide.createIcons();
        customAlert("Voice recognition failed");
      };
    }

    els.voiceMicBtn.onclick = () => {
      if (!recognition) { customAlert("Voice not supported"); return; }
      isRecording ? recognition.stop() : recognition.start();
    };

    async function processVoiceInput(text) {
      if (!(await deductTokens(estimateTokens(text)))) return;
      showThinking();
      const reply = await getReply(text);
      hideThinking();
      addMessage(reply, 'ai', reply);
      els.voiceStatus.textContent = "Speaking...";
      els.voiceAvatar.classList.add('voice-speaking');
      await playVoiceResponse(reply);
    }

    async function getReply(msg) {
      const name = userProfile?.name ? `, ${userProfile.name}` : "";
      const system = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. Use the student's name naturally${name}. Be encouraging and explain step-by-step.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4",
            messages: [{ role: "system", content: system }, ...history.slice(-10), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (error) {
        console.error("API Error:", error);
        hideThinking();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = "Sorry, I'm having trouble connecting. Please check your internet and try again.";
        els.chatPane.appendChild(errorDiv);
        els.chatPane.scrollTop = els.chatPane.scrollHeight;
        return "Connection error. Please try again.";
      }
    }

    async function playVoiceResponse(text) {
      if (!elevenlabsKey) { els.voiceStatus.textContent = "Voice reply disabled"; return; }
      try {
        const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB`, {
          method: 'POST',
          headers: { 'xi-api-key': elevenlabsKey, 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, model_id: 'eleven_turbo_v2_5' })
        });
        const blob = await res.blob();
        const audio = new Audio(URL.createObjectURL(blob));
        await audio.play();
      } catch {
        els.voiceStatus.textContent = "Voice playback failed";
      }
    }

    function addMessage(content, sender, plainText = '', imageUrl = null) {
      const div = document.createElement('div');
      div.className = `message ${sender} flex flex-col`;
      const time = formatTime();
      const hasImage = content.includes('<img');
      const messageId = push(ref(db, `users/${auth.currentUser.uid}/messages`)).key;
      const actions = sender === 'ai' ? `
        <div class="ai-actions">
          <button class="action-btn copy-btn" aria-label="Copy"><i data-lucide="copy" class="w-4 h-4"></i></button>
          <button class="action-btn voice-btn" aria-label="Listen"><i data-lucide="volume-2" class="w-4 h-4"></i></button>
          <button class="action-btn pdf-btn" aria-label="Download PDF"><i data-lucide="file-text" class="w-4 h-4"></i></button>
          <button class="action-btn whatsapp-btn" aria-label="Share on WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></button>
          <button class="action-btn like-btn" aria-label="Like" data-message-id="${messageId}"><i data-lucide="thumbs-up" class="w-4 h-4"></i></button>
          <button class="action-btn dislike-btn" aria-label="Dislike" data-message-id="${messageId}"><i data-lucide="thumbs-down" class="w-4 h-4"></i></button>
        </div>` : '';
      div.innerHTML = `
        <div class="content" id="msg-${messageId}">${sender === 'ai' ? marked.parse(content) : content.replace(/\n/g, '<br>')}</div>
        ${actions}
        <div class="timestamp">${time}</div>`;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();
      if (sender === 'ai') {
        div.querySelector('.copy-btn')?.addEventListener('click', async () => {
          try {
            const text = plainText || content;
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(text);
            } else {
              const textArea = document.createElement('textarea');
              textArea.value = text;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
            }
            customAlert("Copied!");
          } catch {
            customAlert("Copy failed. Please select text manually.");
          }
        });
        div.querySelector('.voice-btn')?.addEventListener('click', () => playVoiceResponse(plainText || content));
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11); doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_${new Date().toISOString().slice(0,10)}.pdf`);
        });
        div.querySelector('.whatsapp-btn')?.addEventListener('click', () => {
          shareToWhatsApp(plainText || content, hasImage ? imageUrl : null);
        });
        div.querySelector('.like-btn')?.addEventListener('click', async (e) => {
          const msgId = e.currentTarget.dataset.messageId;
          await set(ref(db, `users/${auth.currentUser.uid}/feedback/${msgId}`), { type: 'like', timestamp: Date.now() });
          customAlert("Thanks for the like!");
        });
        div.querySelector('.dislike-btn')?.addEventListener('click', async (e) => {
          const msgId = e.currentTarget.dataset.messageId;
          await set(ref(db, `users/${auth.currentUser.uid}/feedback/${msgId}`), { type: 'dislike', timestamp: Date.now() });
          customAlert("We'll improve!");
        });
      }
      return messageId;
    }

    els.sendBtn.onclick = async () => {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      if (!(await deductTokens(estimateTokens(text)))) return;
      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="Homework">`, 'user', '', currentImage);
        history.push({ role: "user", content: currentImage });
        text = "Explain this homework step by step";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }
      els.chatInput.value = ''; currentImage = null;
      els.chatInput.style.height = 'auto';
      showThinking();
      const reply = await getReply(text);
      hideThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    };

    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
    });

    els.chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        els.sendBtn.click();
      }
    });

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'studybuddy');
      const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.secure_url) {
        currentImage = data.secure_url;
        customAlert("Image ready! Tap send");
      } else {
        customAlert("Image upload failed");
      }
    };

    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');

    // Yoco Payment
    async function initYoco() {
      yocoInstance = new YocoSDK({
        publicKey: 'pk_test_8spexN6fvG5BJ1kMuV3l' // Replace with your live public key
      });
    }

    async function handleYocoPayment() {
      if (!yocoInstance) {
        customAlert("Payment system not ready");
        return;
      }

      const result = await yocoInstance.popup({
        amountInCents: 7900, // R79.00
        currency: 'ZAR',
        name: 'Vynix Buddy Premium',
        description: 'Unlimited tokens for 1 month',
        callbackUrl: window.location.href, // Yoco will redirect back here
        metadata: {
          userId: auth.currentUser.uid,
          product: 'premium-monthly'
        }
      });

      if (result.error) {
        customAlert("Payment failed: " + result.error.message);
      } else if (result.redirect) {
        // Redirect to Yoco payment page
        window.location.href = result.redirect;
      } else if (result.success) {
        // Payment successful
        await activatePremium();
      }
    }

    async function activatePremium() {
      await set(ref(db, `users/${auth.currentUser.uid}/premium`), {
        active: true,
        since: Date.now(),
        expires: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days
      });
      isPremium = true;
      dailyTokens = 999999999;
      els.tokenCount.textContent = "âˆž";
      els.upgradeSheet.classList.remove('active');
      customAlert("ðŸŽ‰ Premium activated!");
    }

    // Check for successful payment on page load
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      
      // Initialize Yoco
      await initYoco();
      
      // Check if user just completed payment
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('yocoPaymentSuccess') === 'true') {
        await activatePremium();
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
      await loadTokens();

      // Check premium status
      const premiumSnap = await get(child(ref(db), `users/${user.uid}/premium`));
      if (premiumSnap.exists()) {
        const premiumData = premiumSnap.val();
        if (premiumData.active && premiumData.expires > Date.now()) {
          isPremium = true;
          dailyTokens = 999999999;
          els.tokenCount.textContent = "âˆž";
        }
      }

      const snap = await get(child(ref(db), `users/${user.uid}/profile`));
      userProfile = snap.val();
      if (!userProfile) {
        addMessage(`Sawubona! I'm Vynix Buddy, your personal CAPS tutor.\n\nWhat's your name?`, 'ai');
      } else {
        addMessage(`Welcome back, ${userProfile.name}! Ready for Grade ${userProfile.grade} today?`, 'ai');
      }
    });

    // Yoco Pay Button
    els.yocoPayBtn.addEventListener('click', handleYocoPayment);
  </script>
</body>
</html>
