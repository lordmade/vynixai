<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="white-translucent">
  <meta name="theme-color" content="#ffffff">
  <title>Vynix AI</title>

  <link rel="manifest" href='data:application/manifest+json,{
    "name":"Vynix AI",
    "short_name":"Vynix",
    "start_url":"/",
    "display":"standalone",
    "background_color":"#ffffff",
    "theme_color":"#2563eb",
    "orientation":"portrait-primary",
    "icons":[
      {"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg ' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%23d946ef'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext y='80' font-size='70' font-weight='bold' fill='url(%23g)' text-anchor='middle' x='50'%3ENE%3C/text%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml"},
      {"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg ' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%23d946ef'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext y='80' font-size='70' font-weight='bold' fill='url(%23g)' text-anchor='middle' x='50'%3ENE%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}
    ]
  }'>

  <link rel="preconnect" href="https://fonts.googleapis.com ">
  <link rel="preconnect" href="https://fonts.gstatic.com " crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300 ;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded " rel="stylesheet">

  <style>
    :root {
      --bg-color: #ffffff;
      --surface-color: #f4f6f8;
      --text-primary: #1a1a1a;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --logo-gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 100%);
      --input-bg: #f0f2f5;
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.06);
      --font-main: 'Outfit', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--bg-color);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
    }

    /* Header */
    .header {
      height: 64px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      z-index: 10;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .vynix-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 12px;
    }
    .vynix-logo:active { transform: scale(0.96); }
    .logo-icon {
      font-size: 26px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-variation-settings: 'FILL' 1, 'wght' 600;
    }
    .logo-text {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #1a1a1a;
    }

    /* Chat Area */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0 160px 0;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
    }

    /* Welcome Screen & Install Pill */
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px;
      animation: fadeIn 0.5s ease;
    }
    .welcome-icon {
      font-size: 64px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 24px;
      font-variation-settings: 'wght' 200;
    }
    
    /* --- NEW PILL INSTALL BUTTON --- */
    #install-pill-container {
      margin-bottom: 20px;
      display: none; /* Hidden by default, shown via JS */
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .install-pill-btn {
      background: var(--logo-gradient);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 50px;
      font-family: var(--font-main);
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .install-pill-btn:active { transform: scale(0.95); }
    .install-pill-btn span { font-size: 18px; }

    .welcome-text {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .welcome-sub {
      color: var(--text-muted);
      font-size: 16px;
      max-width: 300px;
      line-height: 1.5;
    }

    /* Messages */
    .message-row {
      display: flex;
      flex-direction: column;
      padding: 10px 20px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      animation: fadeIn 0.3s ease forwards;
    }
    .message-bubble-container { display: flex; gap: 12px; }
    .message-row.user .message-bubble-container { justify-content: flex-end; }
    .avatar {
      width: 32px; height: 32px; border-radius: 50%;
      flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      margin-top: 4px;
    }
    .avatar.ai { background: white; border: 1px solid #e0e0e0; }
    .avatar.ai span {
      background: var(--logo-gradient); -webkit-background-clip: text;
      -webkit-text-fill-color: transparent; font-size: 20px; font-variation-settings: 'FILL' 1;
    }
    .message-content { max-width: 85%; line-height: 1.6; font-size: 16px; word-wrap: break-word; }
    .message-row.ai .message-content { color: var(--text-primary); padding-top: 6px; }
    .message-row.user .message-content {
      background: var(--surface-color); color: var(--text-primary);
      padding: 12px 18px; border-radius: 20px 20px 4px 20px;
    }
    .message-content strong { font-weight: 600; }
    .message-content pre {
      background: #1e1e1e; color: #e0e0e0; padding: 15px;
      border-radius: 12px; overflow-x: auto; font-family: var(--font-mono); font-size: 13px; margin-top: 10px;
    }
    .copy-actions { margin-left: 44px; margin-top: 4px; }
    .copy-btn {
      background: none; border: none; display: flex; align-items: center; gap: 4px;
      color: var(--text-muted); font-size: 12px; cursor: pointer; padding: 4px 0;
    }

    /* Input Area */
    .input-wrapper-fixed {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 30;
      background: var(--bg-color);
      padding: 12px max(20px, env(safe-area-inset-left)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-right));
      box-shadow: 0 -2px 10px rgba(0,0,0,0.04);
      display: flex; flex-direction: column; align-items: center;
    }
    .input-wrapper {
      width: 100%; background: var(--input-bg); border-radius: 28px; padding: 6px;
      display: flex; align-items: center; transition: background 0.2s;
    }
    .input-wrapper:focus-within { background: white; outline: 1px solid #e0e0e0; box-shadow: var(--shadow-soft); }
    input {
      flex: 1; border: none; background: none; outline: none;
      font-size: 16px; font-family: var(--font-main); color: var(--text-primary);
      padding: 12px 14px; user-select: text;
    }
    .mic-btn, .send-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none; background: transparent;
      color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .mic-btn.listening { color: #dc2626; background: rgba(220, 38, 38, 0.1); animation: pulse-red 1.5s infinite; }
    .send-btn.active { background: var(--text-primary); color: white; }
    .send-btn span { font-size: 22px; margin-left: 2px; }

    .disclaimer {
      font-size: 11px; color: var(--text-muted); margin-top: 8px; text-align: center; opacity: 0.8;
    }

    /* iOS Instructions Modal */
    .ios-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); z-index: 200;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .ios-modal.open { opacity: 1; pointer-events: all; }
    .ios-card {
      background: white; width: 85%; max-width: 320px; padding: 24px;
      border-radius: 24px; text-align: center;
      transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .ios-modal.open .ios-card { transform: scale(1); }
    .ios-step { display: flex; align-items: center; gap: 12px; margin: 15px 0; text-align: left; font-size: 14px; color: #333; }
    .ios-icon { color: #007aff; font-size: 24px; }

    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    
    .thinking { display: flex; gap: 5px; padding: 10px 0; }
    .dot { width: 5px; height: 5px; background: #9aa0a6; border-radius: 50%; animation: pulse 1s infinite alternate; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { to { opacity: 0.3; transform: translateY(-2px); } }
  </style>
</head>
<body>

  <!-- ===== PWA INSTALL BANNER ===== -->
  <div id="pwa-install-banner" class="fixed top-0 left-0 right-0 bg-[#2563eb] text-white px-4 py-3 flex items-center justify-between z-50 shadow-lg transform -translate-y-full transition-transform duration-300">
    <div class="font-semibold text-sm">Install Vynix for a better experience</div>
    <div class="flex items-center gap-3">
      <button id="pwa-install-btn" class="bg-white text-[#2563eb] px-5 py-1.5 rounded-full font-bold text-sm hover:scale-105 transition">Install</button>
      <button id="pwa-install-close" class="text-white/80 hover:text-white">
        <span class="material-symbols-rounded text-xl">close</span>
      </button>
    </div>
  </div>

  <div class="ios-modal" id="iosModal" onclick="closeIosModal()">
    <div class="ios-card" onclick="event.stopPropagation()">
      <div class="material-symbols-rounded" style="font-size:40px; color:#000; margin-bottom:10px;">ios_share</div>
      <h3 style="margin:0 0 10px 0; font-size:18px;">Install Vynix</h3>
      <p style="font-size:14px; color:#666; margin-bottom:20px;">Install app to your home screen for the best experience.</p>
      
      <div class="ios-step">
        <span class="material-symbols-rounded ios-icon">ios_share</span>
        <span>1. Tap the <strong>Share</strong> button on the toolbar.</span>
      </div>
      <div class="ios-step">
        <span class="material-symbols-rounded ios-icon" style="color:#000">add_box</span>
        <span>2. Select <strong>Add to Home Screen</strong>.</span>
      </div>

      <button style="margin-top:20px; width:100%; padding:12px; border:none; background:#f0f2f5; color:#007aff; font-weight:600; border-radius:12px; font-size:16px;" onclick="closeIosModal()">Got it</button>
    </div>
  </div>

  <header class="header">
    <div class="vynix-logo" onclick="location.reload()">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <span class="logo-text">Vynix</span>
    </div>
  </header>

  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="material-symbols-rounded welcome-icon">neurology</div>

      <div id="install-pill-container">
        <button id="install-pill-btn" class="install-pill-btn">
          <span class="material-symbols-rounded">download</span>
          Install App
        </button>
      </div>

      <div class="welcome-text">How can I help?</div>
      <div class="welcome-sub">I'm Vynix, an AI expert in <strong>SA Education</strong>, <strong>Coding</strong>, and <strong>Storytelling</strong>. Try asking me to <strong>generate an image</strong>!</div>
    </div>
    <div id="messagesList"></div>
  </main>

  <div class="input-wrapper-fixed">
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn">
        <span class="material-symbols-rounded">mic</span>
      </button>
      <input type="text" id="input" placeholder="Message Vynix..." autocomplete="off">
      <button class="send-btn" id="sendBtn">
        <span class="material-symbols-rounded">arrow_upward</span>
      </button>
    </div>
    <p class="disclaimer">Vynix can make mistakes. Check important info.</p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js ';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js ';

    /* --- Configuration --- */
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";

    const systemInstructions = `
      You are Vynix, a helpful and general-purpose AI assistant.
      1. Coding Expert: Provide clean, modern, bug-free code with clear explanations.
      2. SA Education Specialist: Expert in South African CAPS curriculum (Grades R-12).
      3. Master Storyteller: Be vivid, creative, and engaging.
      4. General: Be concise, accurate, and use Markdown.
    `;
    let historyStack = [{ role: "system", content: systemInstructions }];

    /* --- Selectors --- */
    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn'), $mic = $('#micBtn'), $list = $('#messagesList'), $welcome = $('#welcomeScreen');
    
    /* --- SMART INSTALL LOGIC --- */
    const installContainer = $('#install-pill-container');
    const installBtn = $('#install-pill-btn');
    const iosModal = $('#iosModal');
    let deferredPrompt = null;

    // Detect Platform
    const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    // 1. Android/Desktop (Chrome/Edge)
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installContainer.style.display = 'block'; // Show pill
    });

    // 2. iOS (Show pill if not installed)
    if (isIos && !isStandalone) {
      installContainer.style.display = 'block'; 
    }

    // Handle Click
    installBtn.addEventListener('click', async () => {
      if (isIos) {
        // Show iOS Instructions
        iosModal.classList.add('open');
      } else if (deferredPrompt) {
        // Trigger Android Prompt
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log("User choice:", outcome);
        deferredPrompt = null;
        if (outcome === 'accepted') {
          installContainer.style.display = 'none';
        }
      }
    });

    // iOS Modal Close Helper
    window.closeIosModal = () => iosModal.classList.remove('open');

    /* --- PWA BANNER LOGIC --- */
    const banner = document.getElementById('pwa-install-banner');
    const bannerInstallBtn = document.getElementById('pwa-install-btn');
    const bannerCloseBtn = document.getElementById('pwa-install-close');

    /* show banner on beforeinstallprompt */
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      banner.classList.remove('-translate-y-full');
    });

    /* “Install” button → native prompt */
    bannerInstallBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      banner.classList.add('-translate-y-full');
    });

    /* “✕” button → hide for this session */
    bannerCloseBtn?.addEventListener('click', () => {
      banner.classList.add('-translate-y-full');
      sessionStorage.setItem('pwa-banner-dismissed','1');
    });
    if (sessionStorage.getItem('pwa-banner-dismissed') === '1') banner.style.display = 'none';

    /* --- Chat Logic --- */
    function parseMarkdown(text) {
      return text
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\s*-\s+(.*)/gm, '• $1<br>')
        .replace(/\n/g, '<br>');
    }
    
    function addMessage(text, type) {
      $welcome.style.display = 'none';
      const div = document.createElement('div');
      div.className = `message-row ${type}`;
      const avatarHTML = type === 'ai' ? `<div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div>` : '';
      let html = `<div class="message-bubble-container">${avatarHTML}<div class="message-content">${parseMarkdown(text)}</div></div>`;
      
      if (type === 'ai') {
        const id = 'copy-' + Date.now();
        html += `<div class="copy-actions"><button class="copy-btn" id="${id}"><span class="material-symbols-rounded">content_copy</span> Copy</button></div>`;
        div.innerHTML = html; $list.appendChild(div);
        $(`#${id}`).addEventListener('click', () => {
           navigator.clipboard.writeText(text);
           $(`#${id} span`).innerText = 'check';
           setTimeout(()=> $(`#${id} span`).innerText = 'content_copy', 2000);
        });
      } else { div.innerHTML = html; $list.appendChild(div); }
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function addImage(url, prompt) {
      $welcome.style.display = 'none';
      const div = document.createElement('div'); div.className = 'message-row ai';
      div.innerHTML = `<div class="message-bubble-container"><div class="avatar ai"><span class="material-symbols-rounded">brush</span></div>
        <div class="message-content"><p style="margin:0"><strong>Image Generated!</strong></p><p style="font-size:14px;color:var(--text-muted)">Prompt: ${prompt}</p>
        <img src="${url}" style="max-width:100%;border-radius:12px;margin-top:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1)" onload="this.scrollIntoView({behavior:'smooth'})"></div></div>`;
      $list.appendChild(div);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function addLoading() {
      const div = document.createElement('div'); div.id = 'loading'; div.className = 'message-row ai';
      div.innerHTML = `<div class="message-bubble-container"><div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div><div class="message-content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>`;
      $list.appendChild(div); $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }
    function removeLoading() { if($('#loading')) $('#loading').remove(); }

    window.sendMessage = async () => {
      const msg = $i.value.trim(); if (!msg) return;
      $i.value = ''; $send.classList.remove('active');
      addMessage(msg, 'user');
      
      const lower = msg.toLowerCase();
      if (lower.includes('generate image') || lower.includes('create an image') || lower.includes('draw')) {
        addLoading();
        const seed = Math.floor(Math.random()*10000);
        const url = `https://image.pollinations.ai/prompt/ ${encodeURIComponent(msg)}?seed=${seed}&nologo=true&width=768&height=768`;
        setTimeout(() => { removeLoading(); addImage(url, msg); historyStack.push({role:"user",content:msg}, {role:"assistant",content:`[Image]`}); }, 1800);
        return;
      }

      addLoading();
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions ", {
          method: "POST", headers: { "Authorization": `Bearer ${XAI_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-4-fast", messages: [...historyStack, { role: "user", content: msg }], temperature: 0.7, max_tokens: 1000 })
        });
        removeLoading();
        if (!res.ok) throw new Error("API Error");
        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || "No response.";
        addMessage(reply, 'ai');
        historyStack.push({ role: "user", content: msg }, { role: "assistant", content: reply });
      } catch (e) { removeLoading(); addMessage("Connection error. Please try again.", 'ai'); }
    };

    /* --- Input Handlers --- */
    $i.addEventListener('input', () => $send.classList.toggle('active', $i.value.trim().length > 0));
    $i.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    $send.addEventListener('click', sendMessage);

    /* --- Speech --- */
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const r = new SR(); r.lang = 'en-ZA'; r.interimResults = false;
      r.onstart = () => { $mic.classList.add('listening'); $i.placeholder = "Listening..."; };
      r.onresult = e => { $i.value = e.results[0][0].transcript; sendMessage(); };
      r.onend = () => { $mic.classList.remove('listening'); $i.placeholder = "Message Vynix..."; };
      $mic.onclick = () => r.start();
    } else { $mic.style.display = 'none'; }
  </script>
</body>
</html>
