<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="white-translucent">
  <meta name="theme-color" content="#ffffff">
  <title>Vynix AI - Upgraded</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Vynix AI\",
    \"short_name\": \"Vynix\",
    \"start_url\": \"/\",
    \"display\": \"standalone\",
    \"background_color\": \"#ffffff\",
    \"theme_color\": \"#2563eb\",
    \"orientation\": \"portrait-primary\",
    \"icons\": [
      {\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%23d946ef'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext y='80' font-size='70' font-weight='bold' fill='url(%23g)' text-anchor='middle' x='50'%3ENE%3C/text%3E%3C/svg%3E\", \"sizes\": \"192x192\", \"type\": \"image/svg+xml\"},
      {\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%23d946ef'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext y='80' font-size='70' font-weight='bold' fill='url(%23g)' text-anchor='middle' x='50'%3ENE%3C/text%3E%3C/svg%3E\", \"sizes\": \"512x512\", \"type\": \"image/svg+xml\"}
    ]
  }" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <style>
    :root {
      --bg-color: #ffffff;
      --surface-color: #f4f6f8;
      --text-primary: #1a1a1a;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --accent-gradient: linear-gradient(135deg, #2563eb, #9333ea);
      --logo-gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 100%);
      --input-bg: #f0f2f5;
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.06);
      --font-main: 'Outfit', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--bg-color);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    /* ---------- header ---------- */
    .header {
      height: 64px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      z-index: 10;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .vynix-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 12px;
      transition: transform 0.2s;
    }
    .vynix-logo:active { transform: scale(0.96); }
    .logo-icon {
      font-size: 26px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-variation-settings: 'FILL' 1, 'wght' 600;
    }
    .logo-text {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #1a1a1a;
    }

    /* ---------- chat ---------- */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0 calc(env(safe-area-inset-bottom) + 88px);
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
    }
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px;
      opacity: 1;
      transition: opacity 0.5s;
    }
    .welcome-icon {
      font-size: 64px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 20px;
      font-variation-settings: 'wght' 200;
    }
    .welcome-text {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .welcome-sub {
      color: var(--text-muted);
      font-size: 16px;
      max-width: 300px;
      line-height: 1.5;
    }

    /* ---------- messages ---------- */
    .message-row {
      display: flex;
      flex-direction: column;
      padding: 10px 20px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      animation: fadeIn 0.3s ease forwards;
    }
    .message-bubble-container {
      display: flex;
      gap: 12px;
    }
    .message-row.user .message-bubble-container { justify-content: flex-end; }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
    }
    .avatar.ai {
      background: white;
      border: 1px solid #e0e0e0;
    }
    .avatar.ai span {
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 20px;
      font-variation-settings: 'FILL' 1;
    }

    .message-content {
      max-width: 85%;
      line-height: 1.6;
      font-size: 16px;
      word-wrap: break-word;
    }
    .message-row.ai .message-content { color: var(--text-primary); padding-top: 6px; }
    .message-row.user .message-content {
      background: var(--surface-color);
      color: var(--text-primary);
      padding: 12px 18px;
      border-radius: 20px 20px 4px 20px;
    }
    .message-content strong { font-weight: 600; }
    .message-content code {
      background: #e8ebed;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.9em;
      color: #c026d3;
    }
    .message-content pre {
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 15px;
      border-radius: 12px;
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 13px;
      margin-top: 10px;
    }
    .copy-actions {
      display: flex;
      margin-left: 44px;
      margin-top: 4px;
    }
    .copy-btn {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px 4px 0;
      transition: color 0.2s;
    }
    .copy-btn:active { opacity: 0.6; }
    .copy-btn span { font-size: 16px; }

    /* ---------- FLOATING INPUT BAR ---------- */
    .input-wrapper-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      background: var(--bg-color);
      padding: 12px max(20px, env(safe-area-inset-left)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-right));
      box-shadow: 0 -2px 10px rgba(0,0,0,0.04);
    }
    .input-wrapper {
      background: var(--input-bg);
      border-radius: 28px;
      padding: 6px;
      display: flex;
      align-items: center;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .input-wrapper:focus-within {
      background: white;
      box-shadow: var(--shadow-soft);
      outline: 1px solid #e0e0e0;
    }
    input {
      flex: 1;
      border: none;
      background: none;
      outline: none;
      font-size: 16px;
      font-family: var(--font-main);
      color: var(--text-primary);
      padding: 12px 14px;
      -webkit-user-select: text;
      user-select: text;
    }

    /* Mic & Send Button */
    .mic-btn, .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .mic-btn:hover, .send-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-primary); }
    .mic-btn.listening {
      color: #dc2626;
      background: rgba(220, 38, 38, 0.1);
      animation: pulse-red 1.5s infinite;
    }
    .send-btn.active {
      background: var(--text-primary);
      color: white;
    }
    .send-btn span { font-size: 22px; margin-left: 2px; }

    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }

    /* ---------- Bottom Sheet Login Modal ---------- */
    .login-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-color);
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
      z-index: 100;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
      max-height: 90vh;
      overflow-y: auto;
    }
    .login-sheet.open {
      transform: translateY(0);
    }
    .sheet-header {
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .sheet-handle {
      width: 40px;
      height: 5px;
      background: #ddd;
      border-radius: 3px;
      margin: 0 auto 16px;
    }
    .sheet-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }
    .sheet-content {
      padding: 32px 24px;
    }
    .login-form input {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      font-family: var(--font-main);
    }
    .btn-primary {
      width: 100%;
      padding: 14px;
      background: var(--logo-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .btn-google {
      background: white;
      color: #1a1a1a;
      border: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .overlay.open {
      opacity: 1;
      pointer-events: all;
    }

    /* ---------- loading & animations ---------- */
    .thinking { display: flex; gap: 5px; padding: 10px 0; }
    .dot {
      width: 5px; height: 5px;
      background: #9aa0a6;
      border-radius: 50%;
      animation: pulse 1s infinite alternate;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { to { opacity: 0.3; transform: translateY(-2px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <!-- Login Bottom Sheet -->
  <div class="overlay" id="overlay"></div>
  <div class="login-sheet" id="loginSheet">
    <div class="sheet-header">
      <div class="sheet-handle"></div>
      <h2 class="sheet-title">Welcome to Vynix</h2>
    </div>
    <div class="sheet-content">
      <div class="login-form">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button class="btn-primary" onclick="signInWithEmail()">Sign In</button>
        <button class="btn-primary btn-google" onclick="signInWithGoogle()">
          <span class="material-symbols-rounded">g_translate</span>
          Continue with Google
        </button>
        <p style="text-align:center; margin-top:20px; color:var(--text-muted); font-size:14px;">
          No account? Just sign in with Google!
        </p>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="vynix-logo" onclick="location.reload()">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <span class="logo-text">Vynix</span>
    </div>
  </header>

  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="material-symbols-rounded welcome-icon">neurology</div>
      <div class="welcome-text">How can I help?</div>
      <div class="welcome-sub">I'm Vynix, an AI expert in <strong>SA Education</strong>, <strong>Coding</strong>, and <strong>Storytelling</strong>. Try asking me to <strong>generate an image</strong>!</div>
    </div>
    <div id="messagesList"></div>
  </main>

  <div class="input-wrapper-fixed">
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn">
        <span class="material-symbols-rounded">mic</span>
      </button>
      <input type="text" id="input" placeholder="Message Vynix..." autocomplete="off">
      <button class="send-btn" id="sendBtn">
        <span class="material-symbols-rounded">arrow_upward</span>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const xaiKey = getString(rc, 'xai_api_key');

    const systemInstructions = `
      You are Vynix, a helpful and general-purpose AI assistant.
      1. Coding Expert: Provide clean, modern, bug-free code with clear explanations.
      2. SA Education Specialist: Expert in South African CAPS curriculum (Grades R-12).
      3. Master Storyteller: Be vivid, creative, and engaging.
      4. General: Be concise, accurate, and use Markdown.
    `;

    let historyStack = [{ role: "system", content: systemInstructions }];
    const $ = s => document.querySelector(s);

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // You can show a custom install button if desired
    });

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript,').catch(() => {});
    }

    // Login Sheet Controls
    const loginSheet = $('#loginSheet');
    const overlay = $('#overlay');

    function showLogin() {
      overlay.classList.add('open');
      loginSheet.classList.add('open');
    }
    function hideLogin() {
      overlay.classList.remove('open');
      loginSheet.classList.remove('open');
    }
    overlay.addEventListener('click', hideLogin);

    // Auth Functions
    window.signInWithEmail = async () => {
      const email = $('#email').value.trim();
      const password = $('#password').value;
      if (!email || !password) return alert("Fill in all fields");
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    };

    const googleProvider = new GoogleAuthProvider();
    window.signInWithGoogle = () => {
      signInWithPopup(auth, googleProvider).catch(err => alert("Google sign-in failed: " + err.message));
    };

    // Check Auth State
    onAuthStateChanged(auth, user => {
      if (user) {
        hideLogin();
      } else {
        showLogin();
      }
    });

    // Markdown Parser
    function parseMarkdown(text) {
      return text
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\s*-\s+(.*)/gm, 'â€¢ $1<br>')
        .replace(/\n/g, '<br>');
    }

    function addMessage(text, type) {
      $('#welcomeScreen').style.display = 'none';
      const list = $('#messagesList');
      const div = document.createElement('div');
      div.className = `message-row ${type}`;

      const avatarHTML = type === 'ai'
        ? `<div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div>`
        : '';

      let html = `<div class="message-bubble-container">
        ${avatarHTML}
        <div class="message-content">${parseMarkdown(text)}</div>
      </div>`;

      if (type === 'ai') {
        const id = 'copy-' + Date.now();
        html += `<div class="copy-actions">
          <button class="copy-btn" id="${id}">
            <span class="material-symbols-rounded">content_copy</span> Copy
          </button>
        </div>`;
        div.innerHTML = html;
        list.appendChild(div);
        \( (`# \){id}`).addEventListener('click', () => copyToClipboard(text, \( (`# \){id}`)));
      } else {
        div.innerHTML = html;
        list.appendChild(div);
      }
      \( ('#chatContainer').scrollTop = \)('#chatContainer').scrollHeight;
    }

    function addImage(url, prompt) {
      $('#welcomeScreen').style.display = 'none';
      const list = $('#messagesList');
      const div = document.createElement('div');
      div.className = 'message-row ai';
      div.innerHTML = `
        <div class="message-bubble-container">
          <div class="avatar ai"><span class="material-symbols-rounded">brush</span></div>
          <div class="message-content">
            <p style="margin:0"><strong>Image Generated!</strong></p>
            <p style="font-size:14px;margin-top:4px;color:var(--text-muted)">Prompt: ${prompt}</p>
            <img src="${url}" style="max-width:100%;border-radius:12px;margin-top:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1)" alt="Generated image" onload="this.scrollIntoView({behavior:'smooth'})">
          </div>
        </div>`;
      list.appendChild(div);
      \( ('#chatContainer').scrollTop = \)('#chatContainer').scrollHeight;
    }

    function copyToClipboard(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const icon = btn.querySelector('span');
        icon.textContent = 'check';
        btn.style.color = '#2563eb';
        setTimeout(() => {
          icon.textContent = 'content_copy';
          btn.style.color = '';
        }, 2000);
      });
    }

    function addLoading() {
      const div = document.createElement('div');
      div.id = 'loadingIndicator';
      div.className = 'message-row ai';
      div.innerHTML = `
        <div class="message-bubble-container">
          <div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div>
          <div class="message-content">
            <div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
          </div>
        </div>`;
      $('#messagesList').appendChild(div);
      \( ('#chatContainer').scrollTop = \)('#chatContainer').scrollHeight;
    }

    function removeLoading() {
      const el = $('#loadingIndicator');
      if (el) el.remove();
    }

    function vibrate() {
      if ('vibrate' in navigator) navigator.vibrate(40);
    }

    // Speech Recognition (Auto-send)
    const micBtn = $('#micBtn');
    const inputField = $('#input');
    const sendBtn = $('#sendBtn');
    let recognition;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-ZA';
      recognition.interimResults = false;

      recognition.onstart = () => {
        micBtn.classList.add('listening');
        inputField.placeholder = "Listening...";
      };

      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        inputField.value = text;
        sendMessage(); // Auto-send after speech
      };

      recognition.onend = () => {
        micBtn.classList.remove('listening');
        inputField.placeholder = "Message Vynix...";
      };

      recognition.onerror = () => {
        micBtn.classList.remove('listening');
        inputField.placeholder = "Message Vynix...";
      };

      micBtn.addEventListener('click', () => {
        if (micBtn.classList.contains('listening')) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });
    } else {
      micBtn.style.display = 'none';
    }

    // Send Message Function
    window.sendMessage = async () => {
      const msg = inputField.value.trim();
      if (!msg) return;

      inputField.value = '';
      sendBtn.classList.remove('active');
      addMessage(msg, 'user');

      const lower = msg.toLowerCase();
      if (lower.includes('generate image') || lower.includes('create an image') || lower.includes('draw')) {
        addLoading();
        const seed = Math.floor(Math.random() * 10000);
        const url = `https://image.pollinations.ai/prompt/\( {encodeURIComponent(msg)}?seed= \){seed}&nologo=true&width=768&height=768`;
        setTimeout(() => {
          removeLoading();
          addImage(url, msg);
          historyStack.push({ role: "user", content: msg }, { role: "assistant", content: `[Image: ${msg}]` });
          vibrate();
        }, 1800);
        return;
      }

      addLoading();

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [...historyStack, { role: "user", content: msg }],
            temperature: 0.7,
            max_tokens: 1000
          })
        });

        removeLoading();
        if (!res.ok) throw new Error("API Error");

        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || "No response.";
        addMessage(reply, 'ai');
        historyStack.push({ role: "user", content: msg }, { role: "assistant", content: reply });
        vibrate();
      } catch (e) {
        removeLoading();
        addMessage("Connection error. Please try again.", 'ai');
      }
    };

    inputField.addEventListener('input', () => {
      sendBtn.classList.toggle('active', inputField.value.trim().length > 0);
    });

    inputField.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Initial send button state
    sendBtn.classList.toggle('active', inputField.value.trim().length > 0);
  </script>
</body>
</html>
