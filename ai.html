<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>StudyBuddy â€“ AI Tutor (Grade 1-12)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
      --suggestion-bg: rgba(28, 37, 38, 0.95);
      --suggestion-hover: #38B2AC;
    }
    * { -webkit-touch-callout: none !important; -webkit-user-select: none !important; user-select: none !important; -webkit-tap-highlight-color: transparent !important; }
    input, textarea, .content { -webkit-user-select: text !important; user-select: text !important; }
    html, body { overscroll-behavior: none; height: 100vh; margin: 0; }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-secondary); display: flex; flex-direction: column; }

    .top-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 30; height: 64px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; }
    .v-logo { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 4px; }
    .v-logo svg { width: 22px; height: 22px; fill: white; }
    #api-status { width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s; }
    #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }

    .chat-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; padding: 1rem; padding-top: 74px; padding-bottom: 9rem; display: flex; flex-direction: column; gap: 0.6rem; }
    .message { display: flex; flex-direction: column; width: 100%; }
    .message.user { align-items: flex-end; }
    .message.ai { align-items: flex-start; }
    .message .content { max-width: 75%; padding: 0.75rem 1.1rem; border-radius: 1.1rem; box-shadow: 0 2px 8px rgba(0,0,0,.18); line-height: 1.5; position: relative; }
    .message.user .content { background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE); color: #1E1E1E; }
    .message.ai .content { background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748); color: var(--text-primary); }
    .message-time { font-size: 0.65rem; opacity: 0.6; margin-top: 0.25rem; padding: 0 0.4rem; }

    .input-bar { position: fixed; left: 0; right: 0; bottom: 0; padding: 0.75rem 1rem; border-top: 1px solid var(--border); background: var(--bg); z-index: 20; }
    .input-container { background: var(--card-bg); border-radius: 1.5rem; padding: 0.75rem 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 0.65rem; position: relative; }
    .input-row { display: flex; align-items: center; gap: 0.75rem; }
    #chatInput { flex: 1; background: transparent; border: none; outline: none; color: var(--text-primary); font-size: 1rem; padding: 0.5rem 0; }
    #chatInput::placeholder { color: #888; }

    .send-btn, .mic-btn { width: 46px; height: 46px; border-radius: 50%; background: var(--highlight); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .send-btn:hover, .mic-btn:hover { background: #4ADEDE; transform: scale(1.08); }
    .mic-btn.recording { background: #ef4444; animation: pulse 1.5s infinite; }
    .wave { position: absolute; inset: 0; border-radius: 50%; border: 3px solid rgba(239,68,68,0.4); animation: wave 1.5s infinite; }
    .wave:nth-child(2) { animation-delay: 0.3s; }
    .wave:nth-child(3) { animation-delay: 0.6s; }
    .input-row.has-text .send-btn { display: flex; }
    .input-row.has-text .mic-btn { display: none; }
    .input-row:not(.has-text) .send-btn { display: none; }
    .input-row:notQueryable(.has-text) .mic-btn { display: flex; }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 70% { box-shadow: 0 0 0 12px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
    @keyframes wave { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }

    #suggestions { position: absolute; bottom: 100%; left: 0; right: 0; margin-bottom: 8px; background: var(--suggestion-bg); backdrop-filter: blur(12px); border-radius: 1.2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-height: 320px; overflow-y: auto; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); z-index: 25; padding: 0.5rem; }
    #suggestions.visible { opacity: 1; visibility: visible; transform: translateY(0); }
    .suggestion-item { padding: 0.85rem 1rem; color: #ddd; font-size: 0.95rem; cursor: pointer; border-radius: 0.9rem; transition: all 0.2s; margin: 0.25rem 0.4rem; }
    .suggestion-item:hover { background: var(--suggestion-hover); color: white; transform: translateX(4px); }
    .suggestion-item .grade { font-weight: 600; color: #38B2AC; margin-right: 0.5rem; }

    .speaker-btn { position: absolute; bottom: 8px; right: 8px; width: 36px; height: 36px; border-radius: 50%; background: rgba(56, 178, 172, 0.9); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: all 0.3s; backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .message.ai:hover .speaker-btn { opacity: 1; }
    .speaker-btn.playing { background: #ef4444; animation: pulse 1.5s infinite; }
    .waveform { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 3px; opacity: 0; }
    .waveform span { width: 4px; height: 12px; background: #38B2AC; border-radius: 2px; animation: wave-height 1.2s infinite; }
    .waveform span:nth-child(2) { animation-delay: 0.2s; height: 18px; }
    .waveform span:nth-child(3) { animation-delay: 0.4s; }
    .waveform span:nth-child(4) { animation-delay: 0.6s; height: 16px; }
    .waveform.active { opacity: 1; }
    @keyframes wave-height { 0%, 100% { transform: scaleY(0.4); } 50% { transform: scaleY(1); } }

    .upload-row-inner { display: flex; align-items: center; gap: 0.5rem; padding: 0 0.25rem; opacity: 0.9; }
    #uploadBtnInner { background: rgba(255,255,255,0.15); color: #ccc; border: none; pady: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; border-radius: 9999px; }
    #uploadBtnInner:hover { background: rgba(255,255,255,0.25); }
    #fileName { color: #aaa; font-size: 0.8rem; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #hiddenFile { display: none; }

    #toast { position: fixed; bottom: 5.5rem; left: 50%; transform: translateX(-50%); background: var(--card-bg); color: white; font-size: .875rem; padding: .5rem 1rem; border-radius: 9999px; box-shadow: 0 4px 14px rgba(0,0,0,.25); opacity: 0; pointer-events: none; transition: opacity .3s; z-index: 25; }
    #toast.show { opacity: 1; }

    .sidebar { position: fixed; inset: 0; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,.1); transform: translateX(-100%); transition: transform .3s ease; z-index: 40; display: flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { background: #000; color: white; padding: 1.5rem; text-align: center; }
    #userAvatar { width: 64px; height: 64px; border-radius: 50%; background: var(--highlight); margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; color: white; background-size: cover; background-position: center; }
    #userName { font-weight: 600; }
    #convList { flex: 1; overflow-y: auto; }
    .conv-item { padding: 1rem 1.5rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .conv-item:hover { background: #f0f0f0; }
    .conv-item.active { background: #e0e7ff; font-weight: 600; }
    #newConvBtn { margin: 1rem; padding: 1rem; background: var(--highlight); color: white; border: none; border-radius: 1rem; font-weight: bold; cursor: pointer; }
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); opacity: 0; visibility: hidden; transition: all .3s; z-index: 35; }
    #overlay.on { opacity: 1; visibility: visible; }
  </style>
</head>
<body>

  <header class="top-bar">
    <button id="menuBtn" class="flex items-center gap-2 text-sm text-white bg-[var(--card-bg)] border border-[var(--border)] px-3 py-2 rounded-full">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      Menu
    </button>
    <div class="v-logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
    <div id="api-status"></div>
  </header>

  <section id="chatPane" class="chat-area">
    <div id="welcome" class="text-center m-auto">
      <h1 class="text-lg font-semibold text-black">Hey! I'm StudyBuddy</h1>
      <p class="text-sm text-gray-600 mt-1">Ask me anything â€“ or upload a homework photo ðŸ“¸</p>
    </div>
  </section>

  <div class="input-bar" id="inputBar">
    <div class="input-container">
      <div id="suggestions"></div>
      <div class="input-row" id="inputRow">
        <input id="chatInput" type="text" placeholder="Ask or upload a photo..." autocomplete="off">
        <button id="sendBtn" class="send-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
          </svg>
        </button>
        <button id="voiceBtn" class="mic-btn">
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4z"></path>
            <path d="M19 10v1a7 7 0 0 1-14 0v-1"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </button>
      </div>
      <div class="upload-row-inner">
        <button id="uploadBtnInner">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
          Upload photo
        </button>
        <span id="fileName"></span>
        <input type="file" id="hiddenFile" accept="image/*">
      </div>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div id="userAvatar">U</div>
      <div id="userName">Loading...</div>
    </div>
    <button id="newConvBtn">+ New Session</button>
    <div id="convList"></div>
  </aside>
  <div id="overlay"></div>
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
    import { getDatabase, ref, set, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const remoteConfig = getRemoteConfig(app);
    remoteConfig.settings.minimumFetchIntervalMillis = 3600000;

    let xaiApiKey = null;
    let userId = null;
    let currentConvId = null;
    let conversations = {};
    let history = [];
    let currentImage = null;
    let recognition = null;
    let isRecording = false;
    let speechSynth = window.speechSynthesis;

    const CLOUD_NAME = 'dhvzhirjf';
    const UPLOAD_PRESET = 'studybuddy';

    const SYSTEM_PROMPT = `You are StudyBuddy â€” the kindest, smartest tutor for Grades 1â€“12 in South Africa.
You help with homework, explain concepts, and make learning fun.
- Auto-detect grade level
- Use simple language for younger kids
- Always ask: "Got it? Want another example?"
- Celebrate wins with emojis
- For photos: solve step-by-step like a real teacher`;

    marked.setOptions({ breaks: true, gfm: true });

    const els = {
      chatPane: document.getElementById('chatPane'),
      welcome: document.getElementById('welcome'),
      chatInput: document.getElementById('chatInput');
      sendBtn: document.getElementById('sendBtn'),
      voiceBtn: document.getElementById('voiceBtn'),
      inputRow: document.getElementById('inputRow'),
      uploadBtnInner: document.getElementById('uploadBtnInner'),
      hiddenFile: document.getElementById('hiddenFile'),
      fileName: document.getElementById('fileName'),
      suggestions: document.getElementById('suggestions'),
      toast: document.getElementById('toast'),
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('overlay'),
      menuBtn: document.getElementById('menuBtn'),
      userAvatar: document.getElementById('userAvatar'),
      userName: document.getElementById('userName'),
      convList: document.getElementById('convList'),
      newConvBtn: document.getElementById('newConvBtn')
    };

    // Load API Key
    async function loadApiKey() {
      try {
        await fetchAndActivate(remoteConfig);
        xaiApiKey = getString(remoteConfig, 'xai_api_key').trim();
        if (xaiApiKey) document.getElementById('api-status').classList.add('connected');
      } catch (e) { console.error(e); }
    }
    loadApiKey();

    // Auth
    const provider = new GoogleAuthProvider();
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await signInWithPopup(auth, provider);
        return;
      }
      userId = user.uid;
      els.userName.textContent = user.displayName || "Student";
      els.userAvatar.style.backgroundImage = user.photoURL ? `url(${user.photoURL})` : '';
      els.userAvatar.textContent = user.photoURL ? '' : (user.displayName?.[0] || 'U').toUpperCase();
      loadConversations();
      toast("Welcome back! ðŸŽ‰");
    });

    // Conversations
    function loadConversations() {
      onValue(ref(db, `users/${userId}/conversations`), snap => {
        conversations = snap.val() || {};
        renderConvList();
      });
    }

    function renderConvList() {
      els.convList.innerHTML = '';
      Object.entries(conversations)
        .sort(([,a], [,b]) => (b.createdAt || 0) - (a.createdAt || 0))
        .forEach(([id, conv]) => {
          const div = document.createElement('div');
          div.className = `conv-item ${id === currentConvId ? 'active' : ''}`;
          div.textContent = conv.title || 'New Session';
          div.onclick = () => loadConversation(id);
          els.convList.appendChild(div);
        });
    }

    function startNewConversation() {
      history = [];
      els.chatPane.innerHTML = '';
      els.welcome.classList.remove('hidden');
      const newRef = push(ref(db, `users/${userId}/conversations`));
      currentConvId = newRef.key;
      set(newRef, { createdAt: serverTimestamp(), title: "New Session" });
    }

    function loadConversation(id) {
      currentConvId = id;
      history = [];
      els.chatPane.innerHTML = '';
      els.welcome.classList.add('hidden');
      renderConvList();
    }

    els.newConvBtn.onclick = startNewConversation;
    els.menuBtn.onclick = () => { els.sidebar.classList.add('open'); els.overlay.classList.add('on'); };
    els.overlay.onclick = () => { els.sidebar.classList.remove('open'); els.overlay.classList.remove('on'); };

    // Suggestions
    const suggestions = [
      {text: "Explain fractions like I'm in Grade 4", grade: "Gr 4"},
      {text: "Help me solve quadratic equations", grade: "Gr 10-12"},
      {text: "What are verbs? Give easy examples", grade: "Gr 3"},
      {text: "Teach me about photosynthesis", grade: "Gr 7-9"},
      {text: "I'm stuck on algebra homework", grade: "Gr 8-9"},
      {text: "5 fun ways to remember the planets", grade: "Gr 5-6"},
    ];

    function renderSuggestions(filter = '') {
      const lower = filter.toLowerCase();
      const filtered = filter ? suggestions.filter(s => s.text.toLowerCase().includes(lower)) : suggestions;
      if (!filtered.length) return els.suggestions.classList.remove('visible');

      els.suggestions.innerHTML = filtered.map(s => `
        <div class="suggestion-item">
          <span class="grade">[\( {s.grade}]</span> \){s.text}
        </div>
      `).join('');
      els.suggestions.classList.add('visible');
      els.suggestions.querySelectorAll('.suggestion-item').forEach((item, i) => {
        item.onclick = () => {
          els.chatInput.value = filtered[i].text;
          els.suggestions.classList.remove('visible');
          send();
        };
      });
    }

    els.chatInput.addEventListener('input', () => renderSuggestions(els.chatInput.value));
    els.chatInput.addEventListener('focus', () => { if (!els.chatInput.value) renderSuggestions(); });

    // Voice Input
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'en-ZA';
      recognition.continuous = false;
      recognition.interimResults = true;

      recognition.onresult = e => {
        let final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) final += e.results[i][0].transcript;
        }
        if (final) els.chatInput.value = final.trim();
        updateInputState();
      };

      recognition.onend = () => {
        els.voiceBtn.classList.remove('recording');
        isRecording = false;
      };
    }

    els.voiceBtn.addEventListener('pointerdown', e => {
      e.preventDefault();
      if (recognition && !isRecording) {
        recognition.start();
        els.voiceBtn.classList.add('recording');
        isRecording = true;
        toast('Listening...');
      }
    });
    els.voiceBtn.addEventListener('pointerup', () => { if (recognition && isRecording) recognition.stop(); });
    els.voiceBtn.addEventListener('pointerleave', () => { if (recognition && isRecording) recognition.stop(); });

    // Voice Output
    function speak(text, msgEl) {
      if (!text.trim()) return;
      speechSynth.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      const voice = speechSynth.getVoices().find(v => v.lang.includes('en-ZA')) || speechSynth.getVoices()[0];
      if (voice) utterance.voice = voice;
      utterance.rate = 0.92;

      const speakerBtn = msgEl.querySelector('.speaker-btn');
      const waveform = msgEl.querySelector('.waveform');
      speakerBtn?.classList.add('playing');
      waveform?.classList.add('active');

      utterance.onend = () => {
        speakerBtn?.classList.remove('playing');
        waveform?.classList.remove('active');
      };
      speechSynth.speak(utterance);
    }

    // Messages
    async function typeText(text, el, speakAfter = false) {
      el.innerHTML = '';
      for (let i = 0; i < text.length; i += 7) {
        el.textContent += text.slice(i, i+7);
        await new Promise(r => setTimeout(r, 20));
      }
      el.innerHTML = marked.parse(text);
      Prism.highlightAllUnder(el);
      if (speakAfter) setTimeout(() => speak(el.innerText, el.closest('.message.ai')), 600);
    }

    function addMessage(text, sender, typing = false) {
      const msg = document.createElement('div');
      msg.className = `message ${sender}`;
      msg.innerHTML = `
        <div class="content"></div>
        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
        ${sender === 'ai' ? `
          <button class="speaker-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
            </svg>
          </button>
          <div class="waveform"><span></span><span></span><span></span><span></span></div>
        ` : ''}
      `;
      if (sender === 'ai') msg.querySelector('.speaker-btn').onclick = () => speak(msg.querySelector('.content').innerText, msg);
      els.chatPane.appendChild(msg);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      els.welcome.classList.add('hidden');

      const content = msg.querySelector('.content');
      if (typing) {
        content.textContent = 'Typing...';
        setTimeout(() => typeText(text, content, true), 500);
      } else {
        typeText(text, content, sender === 'ai');
      }
    }

    // Send
    async function send() {
      if (!xaiApiKey) return toast('Loading...');
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;

      if (currentImage) addMessage(`<img src="${currentImage}" class="rounded-lg max-w-xs mt-2">`, 'user');
      else addMessage(text, 'user');

      history.push({ role: "user", content: text || "Explain this homework photo" });
      els.chatInput.value = ''; currentImage = null; els.fileName.textContent = '';
      updateInputState();

      addMessage('', 'ai', true);

      const reply = await getReply(text || "Explain this homework photo");
      document.querySelector('.message.ai:last-child').remove();
      addMessage(reply, 'ai');
      history.push({ role: "assistant", content: reply });
    }

    async function getReply(userMsg) {
      const messages = [{ role: "system", content: SYSTEM_PROMPT }, ...history.slice(-20), { role: "user", content: userMsg }];
      if (currentImage) {
        messages[messages.length-1].content = [
          { type: "text", text: userMsg || "Explain this homework photo" },
          { type: "image_url", image_url: { url: currentImage } }
        ];
      }

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-beta", messages, temperature: 0.7 })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        return "Sorry, connection issue. Try again!";
      }
    }

    // Image Upload
    els.uploadBtnInner.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async () => {
      const file = els.hiddenFile.files[0];
      if (!file) return;
      els.fileName.textContent = file.name;
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', UPLOAD_PRESET);
      toast('Uploading...');
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: form });
      const data = await res.json();
      if (data.secure_url) {
        currentImage = data.secure_url;
        toast('Photo ready â€“ send!');
        updateInputState();
      } else toast('Upload failed');
    };

    function updateInputState() {
      const has = els.chatInput.value.trim() || currentImage;
      els.inputRow.classList.toggle('has-text', has);
      els.sendBtn.disabled = !has;
    }

    function toast(msg, dur = 2500) {
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), dur);
    }

    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
    els.chatInput.addEventListener('input', updateInputState);
    updateInputState();
    renderSuggestions();
    startNewConversation();
  </script>
</body>
</html>
