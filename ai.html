<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Vynix%20Buddy%22,%22short_name%22:%22Vynix%22,%22description%22:%22Your%20CAPS%20AI%20Tutor%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512%22,%22sizes%22:%22512x512%22}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #0f172a; margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    #chatPane, #voicePane { flex: 1; overflow-y: auto; padding: 1.5rem 1rem 130px; -webkit-overflow-scrolling: touch; }

    /* Token Bar */
    .token-bar {
      position: fixed; top: 0; left: 0; right: 0;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: #fff; padding: 0.9rem 1rem; font-size: 0.95rem;
      text-align: center; z-index: 100; display: flex; align-items: center;
      justify-content: center; gap: 0.5rem; box-shadow: 0 4px 20px rgba(139,92,246,0.3);
    }
    .upgrade-pill {
      padding: 0.5rem 1.1rem; background: rgba(255,255,255,0.25);
      border: 1px solid rgba(255,255,255,0.4); border-radius: 999px;
      font-weight: 600; transition: all .2s; backdrop-filter: blur(10px);
    }
    .upgrade-pill:active { transform: scale(0.95); }

    /* GROK-STYLE TOP PILL TABS */
    .grok-tabs {
      position: fixed;
      top: 60px; left: 50%;
      transform: translateX(-50%);
      background: #ffffffee;
      border-radius: 999px;
      padding: 6px;
      display: flex;
      gap: 6px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      z-index: 90;
      backdrop-filter: blur(12px);
      border: 1px solid #e2e8f0;
    }
    .grok-tab {
      padding: 10px 28px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      justify-content: center;
    }
    .grok-tab:not(.active) { color: #64748b; }
    .grok-tab.active {
      background: #8b5cf6;
      color: white;
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
    }
    .grok-tab:hover:not(.active) { background: #f1f5f9; }

    /* Voice Mode */
    #voicePane { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; gap: 1.5rem; }
    #voicePane.active { display: flex; }
    .voice-avatar { width: 200px; height: 200px; border-radius: 50%; background: linear-gradient(135deg, #a78bfa, #f472b6); position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(139,92,246,0.4); border: 8px solid #fff; }
    .voice-wave { position: absolute; inset: 0; background: conic-gradient(from 0deg at 50% 50%, transparent 0deg, rgba(255,255,255,0.3) 90deg, transparent 180deg); animation: spin 10s linear infinite; opacity: 0; transition: opacity .4s; }
    .voice-listening .voice-wave, .voice-speaking .voice-wave { opacity: 0.8; }
    .voice-listening .voice-wave { animation-duration: 2.5s; }
    .voice-speaking .voice-wave { animation-duration: 1.8s; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .voice-rings { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
    .ring { position: absolute; width: 100%; height: 100%; border: 4px solid #8b5cf6; border-radius: 50%; opacity: 0; animation: pulseRing 2s infinite; }
    .ring:nth-child(2) { animation-delay: 0.3s; }
    .ring:nth-child(3) { animation-delay: 0.6s; }
    @keyframes pulseRing { 0% { transform: scale(0.8); opacity: 0.6; } 80%, 100% { transform: scale(1.6); opacity: 0; } }
    .voice-status { font-size: 1.5rem; font-weight: 700; color: #4c1d95; }
    .voice-hint { color: #64748b; font-size: 1.1rem; text-align: center; max-width: 80%; }
    .mic-button { width: 88px; height: 88px; border-radius: 50%; background: #8b5cf6; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 12px 30px rgba(139,92,246,0.5); transition: all .3s; cursor: pointer; }
    .mic-button:hover { transform: scale(1.08); }
    .mic-button:active { transform: scale(0.94); }
    .mic-button.recording { background: #ef4444; animation: micPulse 1.5s infinite; }
    @keyframes micPulse { 0%,100% { box-shadow: 0 12px 30px rgba(239,68,68,0.5); } 50% { box-shadow: 0 12px 50px rgba(239,68,68,0.8); } }

    /* Messages */
    .message { margin: 1.5rem 0; }
    .message.ai .content { background: #f1f5f9; border-radius: 1.2rem 1.2rem 1.2rem 0.3rem; padding: 1rem 1.2rem; max-width: 88%; }
    .message.user .content { background: #e0e7ff; color: #4c1d95; border-radius: 1.2rem 1.2rem 0.3rem 1.2rem; padding: 1rem 1.2rem; margin-left: auto; max-width: 85%; white-space: pre-wrap; word-break: break-word; }
    .ai-actions { display: flex; gap: 12px; margin-top: 8px; margin-left: 8px; opacity: 0.8; }
    .action-btn { width: 36px; height: 36px; background: #f1f3f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .2s; }
    .action-btn:hover { background: #e0e0e0; transform: scale(1.1); }

    /* Input Bar */
    .input-bar { position: fixed; bottom: 0; left: 0; right: 0; padding: 0.75rem; padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); background: #fff; z-index: 80; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); }
    .input-container { background: #f1f5f9; border-radius: 2rem; padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    #chatInput { flex: 1; background: transparent; border: none; outline: none; font-size: 1.05rem; resize: none; max-height: 120px; line-height: 1.5; }

    /* Toast & Sheet */
    #customAlert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-120%); background: linear-gradient(135deg, #8b5cf6, #ec4899); color: #fff; padding: 1rem 1.8rem; border-radius: 999px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999; transition: transform .4s cubic-bezier(0.68,-0.55,0.27,1.55); }
    #customAlert.show { transform: translateX(-50%) translateY(0); }
    .bottom-sheet { position: fixed; bottom: -100%; left: 0; right: 0; background: #fff; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; box-shadow: 0 -10px 40px rgba(0,0,0,.25); transition: bottom .4s cubic-bezier(.32,.72,0,1); z-index: 200; max-height: 92dvh; overflow-y: auto; }
    .bottom-sheet.active { bottom: 0; }
    .sheet-handle { width: 40px; height: 5px; background: #ddd; border-radius: 3px; margin: 0 auto 1rem; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Token Bar -->
  <div class="token-bar">
    <span id="tokenCount">15,000</span> tokens left today
    <button id="upgradePill" class="upgrade-pill">Upgrade</button>
  </div>

  <!-- GROK-STYLE PILL TABS -->
  <div class="grok-tabs">
    <button class="grok-tab active" data-tab="chat">
      <i data-lucide="message-square"></i> Chat
    </button>
    <button class="grok-tab" data-tab="voice">
      <i data-lucide="mic"></i> Voice
    </button>
  </div>

  <!-- Chat Pane -->
  <section id="chatPane">
    <div class="text-center mt-32 px-6">
      <h1 class="text-5xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3">Vynix Buddy</h1>
      <p class="text-lg text-gray-600">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <!-- Voice Pane -->
  <section id="voicePane">
    <p class="voice-hint">Tap the mic and speak • I’ll reply out loud</p>
    <div class="voice-status" id="voiceStatus">Ready to help</div>
    <div class="voice-avatar" id="voiceAvatar">
      <div class="voice-wave"></div>
      <div class="voice-rings">
        <div class="ring"></div>
        <div class="ring"></div>
        <div class="ring"></div>
      </div>
      <i data-lucide="brain" class="text-white w-24 h-24 absolute inset-0 m-auto opacity-90"></i>
    </div>
    <button class="mic-button" id="voiceMicBtn">
      <i data-lucide="mic" class="w-12 h-12"></i>
    </button>
  </section>

  <!-- Input Bar -->
  <div class="input-bar" id="chatInputBar">
    <div class="input-container">
      <button id="uploadBtn"><i data-lucide="paperclip" class="w-6 h-6 text-gray-600"></i></button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="sendBtn" class="w-11 h-11 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full flex items-center justify-center disabled:opacity-50">
        <i data-lucide="send" class="w-5 h-5 text-white"></i>
      </button>
    </div>
  </div>

  <!-- Upgrade Sheet -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-3">Never Run Out Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <span class="text-purple-600 font-bold">Unlimited</span> — just R79/month</p>
      <div class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl transform -rotate-2 mb-10">
        <div class="text-6xl font-black">R79</div>
        <div class="text-xl opacity-90">per month</div>
      </div>
      <button id="mockUpgrade" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">Upgrade Now – R79/month</button>
    </div>
  </div>

  <div id="customAlert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let yocoPublicKey = null;
    let yocoEnabled = false;
    let history = [];
    let currentImage = null;
    let waitingForProfile = false;
    let dailyTokens = 15000;
    let isPremium = false;
    let recognition = null;
    let isRecording = false;
    let currentAudio = null;

    const els = {
      chatPane: document.getElementById('chatPane'),
      voicePane: document.getElementById('voicePane'),
      chatInputBar: document.getElementById('chatInputBar'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      mockUpgrade: document.getElementById('mockUpgrade'),
      upgradePill: document.getElementById('upgradePill'),
      voiceStatus: document.getElementById('voiceStatus'),
      voiceMicBtn: document.getElementById('voiceMicBtn'),
      voiceAvatar: document.getElementById('voiceAvatar'),
      grokTabs: document.querySelectorAll('.grok-tab')
    };

    function customAlert(msg, duration = 2800) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }

    function formatTime() {
      return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
    }

    function estimateTokens(t) {
      return Math.ceil((t?.length || 0) / 4) + 150;
    }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) {
        els.upgradeSheet.classList.add('active');
        return false;
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const userData = userSnap.val();
        if (userData?.premium) {
          isPremium = true; dailyTokens = 999999;
          document.querySelector('.token-bar').innerHTML = `<div class="flex items-center justify-center gap-3"><span>Unlimited • Premium</span></div>`;
          return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val();
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000;
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else {
          dailyTokens = data.daily || 15000;
        }
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch (e) {
        dailyTokens = 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      }
    }

    function loadYocoScript() {
      if (window.YocoSDK) return Promise.resolve();
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }

    async function startYocoPayment() {
      try {
        await loadYocoScript();
        const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
        const result = await yoco.showPopup({
          amountInCents: 7900, currency: 'ZAR', name: 'Vynix Buddy Unlimited',
          description: 'R79/month – Unlimited AI tutoring', metadata: { userId: auth.currentUser.uid },
          callbackUrl: location.href
        });
        if (result?.paymentResult?.status === 'successful') {
          await update(ref(db, `users/${auth.currentUser.uid}`), { premium: true, premiumSince: new Date().toISOString() });
          isPremium = true; await loadTokens(); els.upgradeSheet.classList.remove('active');
          customAlert("Welcome to Unlimited!");
        }
      } catch (e) { customAlert("Payment failed or cancelled."); }
    }

    // GROK-STYLE TAB SWITCHING
    els.grokTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.tab;
        els.grokTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        if (target === 'chat') {
          els.chatPane.style.display = 'block';
          els.voicePane.classList.remove('active');
          els.chatInputBar.style.display = 'flex';
        } else {
          els.chatPane.style.display = 'none';
          els.voicePane.classList.add('active');
          els.chatInputBar.style.display = 'none';
          initSpeechRecognition();
        }
      });
    });

    function initSpeechRecognition() {
      if (recognition || !('webkitSpeechRecognition' in window)) return;
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-ZA';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isRecording = true;
        els.voiceStatus.textContent = "Listening...";
        els.voiceAvatar.classList.add('voice-listening');
        els.voiceMicBtn.classList.add('recording');
        els.voiceMicBtn.innerHTML = `<i data-lucide="square" class="w-12 h-12"></i>`;
        lucide.createIcons();
      };

      recognition.onresult = async (e) => {
        const text = e.results[0][0].transcript;
        await processVoiceInput(text);
      };

      recognition.onerror = () => {
        customAlert("Couldn't hear you — try again");
        stopVoice();
      };

      recognition.onend = stopVoice;
    }

    function stopVoice() {
      isRecording = false;
      els.voiceStatus.textContent = "Ready to help";
      els.voiceAvatar.classList.remove('voice-listening', 'voice-speaking');
      els.voiceMicBtn.classList.remove('recording');
      els.voiceMicBtn.innerHTML = `<i data-lucide="mic" class="w-12 h-12"></i>`;
      lucide.createIcons();
    }

    els.voiceMicBtn.onclick = () => isRecording ? recognition.stop() : recognition.start();

    async function processVoiceInput(text) {
      const cost = estimateTokens(text);
      if (!(await deductTokens(cost))) return;

      els.voiceStatus.textContent = "Thinking...";
      const reply = await getReply(text);
      els.voiceStatus.textContent = "Speaking...";
      els.voiceAvatar.classList.add('voice-speaking');
      await playVoiceResponse(reply);
      stopVoice();
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting...";
      const roleText = userProfile ? `${userProfile.role} (Grade ${userProfile.grade})` : "learner";
      const systemPrompt = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. You are helping ${userProfile?.name || "a student"} who is a ${roleText}. Always use their name naturally. Be encouraging, concise, and speak conversationally.`;

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4",
            messages: [{ role: "system", content: systemPrompt }, ...history.slice(-10), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        console.error(e);
        return "No internet. Please check your connection.";
      }
    }

    async function playVoiceResponse(text) {
      if (!elevenlabsKey) return;
      try {
        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB`, {
          method: 'POST',
          headers: { 'Accept': 'audio/mpeg', 'Content-Type': 'application/json', 'xi-api-key': elevenlabsKey },
          body: JSON.stringify({ text, model_id: 'eleven_turbo_v2_5', voice_settings: { stability: 0.5, similarity_boost: 0.75 } })
        });
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        currentAudio = new Audio(audioUrl);
        await currentAudio.play();
        return new Promise(res => currentAudio.onended = () => { URL.revokeObjectURL(audioUrl); res(); });
      } catch (err) {
        customAlert("Voice not available");
      }
    }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const time = formatTime();
      if (sender === 'ai') {
        div.innerHTML = `<div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn"><i data-lucide="download"></i></button>
          </div>
          <div class="text-xs text-gray-500 mt-1 ml-2">${time}</div>`;
      } else {
        div.innerHTML = `<div class="content">${content.replace(/\n/g, '<br>')}</div><div class="text-xs text-gray-500 mt-1 text-right mr-2">${time}</div>`;
      }
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();

      if (sender === 'ai') {
        div.querySelector('.copy-btn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plainText || content);
          customAlert("Copied!");
        });
        div.querySelector('.voice-btn')?.addEventListener('click', () => playVoiceResponse(plainText || content));
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11); doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_${new Date().toISOString().slice(0,10)}.pdf`);
        });
      }
    }

    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      const cost = estimateTokens(text);
      if (!(await deductTokens(cost))) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="Homework">`, 'user');
        history.push({ role: "user", content: currentImage });
        text = "Explain this homework step by step";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null; els.sendBtn.disabled = true;
      const reply = await getReply(text);
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      els.sendBtn.disabled = !els.chatInput.value.trim() && !currentImage;
    });

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'studybuddy');
      const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.secure_url) {
        currentImage = data.secure_url;
        els.sendBtn.disabled = false;
        customAlert("Image ready! Tap send");
      }
    };

    els.sendBtn.onclick = send;
    els.mockUpgrade.onclick = () => yocoEnabled ? startYocoPayment() : customAlert("Upgrade launching soon!");
    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
      yocoPublicKey = getString(rc, 'yoco_public_key')?.trim();
      yocoEnabled = getBoolean(rc, 'yoco_enabled');
      await loadTokens();

      const snap = await get(child(ref(db), `users/${user.uid}/profile`));
      userProfile = snap.val();
      if (!userProfile) {
        waitingForProfile = true;
        addMessage("Sawubona! I'm Vynix Buddy, your CAPS AI tutor.\n\nWhat's your name?", 'ai');
      } else {
        addMessage(`Welcome back, ${userProfile.name}! Ready to crush Grade ${userProfile.grade}?`, 'ai');
      }
    });
  </script>
</body>
</html>
