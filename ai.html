<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Vynix Buddy</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Vynix Buddy&quot;,&quot;short_name&quot;:&quot;Vynix&quot;,&quot;description&quot;:&quot;Your CAPS AI Tutor&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#8b5cf6&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192&quot;,&quot;sizes&quot;:&quot;192x192&quot;},{&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512&quot;,&quot;sizes&quot;:&quot;512x512&quot;}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #fff; color: #111827; margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    #chatPane { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 130px; -webkit-overflow-scrolling: touch; }

    .message { margin: 1.5rem 0; position: relative; }
    .message.ai .content { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 1rem; padding: 1rem 1.2rem; max-width: 88%; }
    .message.user .content { background: #9ca3af; color: #111827; border-radius: 1rem; padding: 1rem 1.2rem; margin-left: auto; max-width: 85%; }

    .timestamp { font-size: 0.75rem; color: #6b7280; margin-top: 4px; }
    .message.ai .timestamp { text-align: left; margin-left: 8px; }
    .message.user .timestamp { text-align: right; margin-right: 8px; }

    .ai-actions { display: flex; gap: 12px; margin-top: 8px; margin-left: 8px; opacity: 0.8; }
    .action-btn { width: 36px; height: 36px; background: #f1f3f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .action-btn:hover { background: #e0e0e0; transform: scale(1.1); }

    .input-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      padding: 0.75rem; padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
      background: #fff; border-top: 1px solid #e5e7eb;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 1000;
      transition: transform 0.2s ease-out;
    }
    .input-container {
      background: #f9fafb; border: 1px solid #d1d5db; border-radius: 1.5rem;
      padding: 0.75rem 1rem; display: flex; align-items: flex-end; gap: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .input-container:focus-within {
      border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139,92,246,0.15);
    }
    #chatInput { flex: 1; background: transparent; border: none; outline: none; font-size: 1rem; resize: none; max-height: 120px; line-height: 1.5; }
    .send-btn { width: 44px; height: 44px; border-radius: 50%; background: #8b5cf6; display: flex; align-items: center; justify-content: center; }
    .send-btn:disabled { background: #9ca3af; }
    .upload-btn { width: 44px; height: 44px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

  <section id="chatPane">
    <div class="text-center mt-24 text-gray-600">
      <h1 class="text-4xl font-bold mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" disabled><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    let userProfile = null;
    let xaiKey = null;
    let history = [];
    let currentImage = null;
    let waitingForProfile = false;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      inputBar: document.querySelector('.input-bar')
    };

    function formatTime(date = new Date()) {
      return date.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
    }

    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      els.sendBtn.disabled = !els.chatInput.value.trim() && !currentImage;
    });

    // Keyboard stays above on all devices
    const viewport = window.visualViewport || window;
    function handleKeyboard() {
      const keyboardHeight = window.innerHeight - (viewport.height || window.innerHeight);
      if (keyboardHeight > 100) {
        els.inputBar.style.transform = `translateY(-${keyboardHeight}px)`;
      } else {
        els.inputBar.style.transform = 'translateY(0)';
      }
    }
    viewport.addEventListener('resize', handleKeyboard);
    viewport.addEventListener('scroll', handleKeyboard);
    els.chatInput.addEventListener('focus', () => setTimeout(handleKeyboard, 300));

    // Image upload
    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async () => {
      const file = els.hiddenFile.files[0];
      if (!file) return;
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', 'studybuddy');
      const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: form });
      const data = await res.json();
      if (data.secure_url) {
        currentImage = data.secure_url;
        els.sendBtn.disabled = false;
      }
    };

    // PDF download
    function downloadPDF(text, name = "Student") {
      const doc = new jsPDF();
      doc.setFont("helvetica");
      doc.setFontSize(16);
      doc.text("Vynix Buddy - CAPS Tutor", 20, 20);
      doc.setFontSize(12);
      doc.text(`Student: \( {userProfile?.name || name} | Grade \){userProfile?.grade || "?"} | ${new Date().toLocaleDateString('en-ZA')}`, 20, 30);
      doc.setFontSize(11);
      const cleanText = text.replace(/[#*`]/g, '');
      const lines = doc.splitTextToSize(cleanText, 170);
      doc.text(lines, 20, 45);
      doc.save(`Vynix_Buddy_\( {name}_ \){new Date().toISOString().slice(0,10)}.pdf`);
    }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      const time = formatTime();

      if (sender === 'ai' && !isImage) {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn"><i data-lucide="copy"></i></button>
            <button class="action-btn voice-btn"><i data-lucide="volume-2"></i></button>
            <button class="action-btn pdf-btn"><i data-lucide="download"></i></button>
          </div>
          <div class="timestamp">${time}</div>
        `;
      } else {
        div.innerHTML = `
          <div class="content">${isImage ? content : marked.parse(content)}</div>
          <div class="timestamp">${time}</div>
        `;
      }

      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons({ attrs: { width: 18, height: 18 } });

      if (sender === 'ai' && !isImage) {
        div.querySelector('.copy-btn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plainText || content);
          const icon = div.querySelector('.copy-btn i');
          icon.setAttribute('data-lucide', 'check');
          lucide.createIcons();
          setTimeout(() => { icon.setAttribute('data-lucide', 'copy'); lucide.createIcons(); }, 2000);
        });
        div.querySelector('.voice-btn')?.addEventListener('click', () => {
          const utter = new SpeechSynthesisUtterance(plainText || content);
          utter.lang = 'en-ZA';
          speechSynthesis.speak(utter);
        });
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          downloadPDF(plainText || content, userProfile?.name || "Student");
        });
      }
    }

    function addThinking() {
      const div = document.createElement('div');
      div.id = 'thinking';
      div.className = 'message ai';
      div.innerHTML = `<div class="content"><div class="thinking"><span></span><span></span><span></span></div></div>`;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    async function send() {
      if (waitingForProfile) return;
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full">`, 'user');
        history.push({ role: "user", content: currentImage });
        text = "Explain this homework";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null; els.sendBtn.disabled = true;
      els.chatInput.style.height = 'auto';

      addThinking();
      const reply = await getReply(text);
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting...";
      const roleText = userProfile ? `\( {userProfile.role} (Grade \){userProfile.grade})` : "learner";
      const systemPrompt = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. You are helping \( {userProfile?.name || "a student"} who is a \){roleText}. Always use their name naturally. Be encouraging and explain step-by-step.`;

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-3",
            messages: [{ role: "system", content: systemPrompt }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        return "No internet connection.";
      }
    }

    async function checkAndAskProfile() {
      const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/profile`));
      userProfile = snap.val();

      if (!userProfile) {
        waitingForProfile = true;
        addMessage(`Sawubona! I'm Vynix Buddy, your personal CAPS tutor.\n\nMay I know your name?`, 'ai');
      } else {
        addMessage(`Welcome back, \( {userProfile.name}! Ready for Grade \){userProfile.grade} today?`, 'ai');
        waitingForProfile = false;
      }
    }

    els.chatInput.addEventListener('keydown', async e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!waitingForProfile) return send();

        const text = els.chatInput.value.trim();
        if (!text) return;
        els.chatInput.value = '';

        if (!userProfile?.name) {
          userProfile = { name: text };
          addMessage(`Nice to meet you, ${text}! Which grade are you in?`, 'ai');
        }
        else if (!userProfile?.grade) {
          userProfile.grade = text;
          addMessage(`Got it! Grade ${text}. Are you a **student**, **teacher**, or **parent**?`, 'ai');
        }
        else if (!userProfile?.role) {
          userProfile.role = text.toLowerCase();
          await set(ref(db, `users/${auth.currentUser.uid}/profile`), userProfile);
          waitingForProfile = false;
          addMessage(`Perfect, ${userProfile.name}! I'm now your personal CAPS tutor. Ask me anything!`, 'ai');
        }
      }
    });

    async function init() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key').trim();
    }

    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = "login.html"; return; }
      await init();
      await checkAndAskProfile();
    });

    els.sendBtn.onclick = send;
  </script>
</body>
</html>
