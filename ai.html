<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy</title>
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Vynix%20Buddy%22,%22short_name%22:%22Vynix%22,%22description%22:%22Your%20CAPS%20AI%20Tutor%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%230d0d0d%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512%22,%22sizes%22:%22512x512%22}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #0d0d0d;
      color: #e2e8f0;
      margin: 0;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Grok Header + Token Bar */
    .grok-header {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: rgba(13,13,13,0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid #2d2d2d;
      z-index: 100;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      font-size: 1.4rem;
      font-weight: 900;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .token-display {
      font-size: 0.875rem;
      background: #1a1a1a;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #333;
      font-weight: 600;
    }
    .upgrade-btn {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
    }

    /* Grok Pill Tabs */
    .grok-tabs {
      position: fixed;
      top: 68px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26,26,26,0.9);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      padding: 6px;
      display: flex;
      gap: 6px;
      z-index: 90;
      border: 1px solid #333;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .grok-tab {
      padding: 10px 28px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .grok-tab:not(.active) { color: #94a3b8; }
    .grok-tab.active {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      box-shadow: 0 4px 16px rgba(139,92,246,0.5);
    }

    /* Chat & Voice Panes */
    #chatPane, #voicePane {
      flex: 1;
      overflow-y: auto;
      padding: 100px 16px 100px;
      -webkit-overflow-scrolling: touch;
    }
    #voicePane { display: none; flex-direction: column; align-items: center; justify-content: center; gap: 2rem; }
    #voicePane.active { display: flex; }

    /* Grok Message Style */
    .message {
      margin: 16px 0;
      max-width: 92%;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
    .message.ai {
      align-self: flex-start;
    }
    .message.user {
      align-self: flex-end;
    }
    .message.ai .content {
      background: #1a1a1a;
      color: #e2e8f0;
      border-radius: 18px 18px 18px 4px;
      padding: 12px 16px;
      border: 1px solid #2d2d2d;
    }
    .message.user .content {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      border-radius: 18px 18px 4px 18px;
      padding: 12px 16px;
      margin-left: auto;
    }

    /* Voice Mode */
    .voice-avatar {
      width: 180px; height: 180px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(139,92,246,0.4);
      border: 6px solid #1a1a1a;
    }
    .voice-wave {
      position: absolute; inset: 0;
      background: conic-gradient(from 0deg at 50% 50%, transparent 0deg, rgba(255,255,255,0.3) 90deg, transparent 180deg);
      animation: spin 8s linear infinite;
      opacity: 0;
    }
    .voice-listening .voice-wave, .voice-speaking .voice-wave { opacity: 0.8; animation-duration: 2s; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .ring {
      position: absolute; inset: 0;
      border: 4px solid #8b5cf6;
      border-radius: 50%;
      opacity: 0;
      animation: pulseRing 2s infinite;
    }
    .ring:nth-child(2) { animation-delay: 0.3s; }
    .ring:nth-child(3) { animation-delay: 0.6s; }
    @keyframes pulseRing { 0% { transform: scale(0.8); opacity: 0.6; } 100% { transform: scale(1.8); opacity: 0; } }
    .voice-status { font-size: 1.5rem; font-weight: 700; color: #e2e8f0; }
    .voice-hint { color: #64748b; font-size: 1rem; text-align: center; max-width: 80%; }

    .mic-button {
      width: 84px; height: 84px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 12px 40px rgba(139,92,246,0.5);
      transition: all 0.3s;
      cursor: pointer;
    }
    .mic-button.recording {
      background: #ef4444;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%,100% { box-shadow: 0 12px 40px rgba(239,68,68,0.6); } 50% { box-shadow: 0 12px 60px rgba(239,68,68,0.9); } }

    /* Input Bar - Grok Style */
    .input-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: rgba(13,13,13,0.95);
      backdrop-filter: blur(12px);
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      border-top: 1px solid #2d2d2d;
      z-index: 80;
    }
    .input-container {
      background: #1a1a1a;
      border-radius: 999px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid #333;
    }
    #chatInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #e2e8f0;
      font-size: 1.1rem;
    }
    .send-btn {
      width: 44px; height: 44px;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }

    /* Toast */
    #customAlert {
      position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%) translateY(-120%);
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white; padding: 12px 24px;
      border-radius: 999px; font-weight: 700;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 9999; transition: transform 0.4s cubic-bezier(0.68,-0.55,0.27,1.55);
    }
    #customAlert.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body class="bg-black text-gray-200">

  <!-- Grok Header -->
  <div class="grok-header">
    <div class="logo">Vynix</div>
    <div class="flex items-center gap-3">
      <div class="token-display"><span id="tokenCount">15,000</span> tokens</div>
      <button id="upgradePill" class="upgrade-btn">Upgrade</button>
    </div>
  </div>

  <!-- Grok Pill Tabs -->
  <div class="grok-tabs">
    <button class="grok-tab active" data-tab="chat">
      <i data-lucide="message-square"></i> Chat
    </button>
    <button class="grok-tab" data-tab="voice">
      <i data-lucide="mic"></i> Voice
    </button>
  </div>

  <!-- Chat Pane -->
  <section id="chatPane" class="flex flex-col">
    <div class="text-center mt-24 px-6">
      <h1 class="text-5xl font-black bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent mb-2">Vynix Buddy</h1>
      <p class="text-gray-400">Your CAPS AI Tutor • Grades 1–12</p>
    </div>
  </section>

  <!-- Voice Pane -->
  <section id="voicePane">
    <p class="voice-hint">Tap the mic and speak • I’ll reply out loud</p>
    <div class="voice-status" id="voiceStatus">Ready to help</div>
    <div class="voice-avatar" id="voiceAvatar">
      <div class="voice-wave"></div>
      <div class="ring"></div><div class="ring"></div><div class="ring"></div>
      <i data-lucide="brain" class="text-white w-20 h-20 absolute inset-0 m-auto opacity-90"></i>
    </div>
    <button class="mic-button" id="voiceMicBtn">
      <i data-lucide="mic" class="w-12 h-12"></i>
    </button>
  </section>

  <!-- Input Bar -->
  <div class="input-bar" id="chatInputBar">
    <div class="input-container">
      <button id="uploadBtn"><i data-lucide="paperclip" class="w-6 h-6 text-gray-400"></i></button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn">
        <i data-lucide="send" class="w-5 h-5 text-white"></i>
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="customAlert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    const rc = getRemoteConfig(app);

    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let yocoPublicKey = null;
    let yocoEnabled = false;
    let history = [];
    let currentImage = null;
    let waitingForProfile = false;
    let dailyTokens = 15000;
    let isPremium = false;
    let recognition = null;
    let isRecording = false;

    const els = {
      chatPane: document.getElementById('chatPane'),
      voicePane: document.getElementById('voicePane'),
      chatInputBar: document.getElementById('chatInputBar'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradePill: document.getElementById('upgradePill'),
      voiceStatus: document.getElementById('voiceStatus'),
      voiceMicBtn: document.getElementById('voiceMicBtn'),
      voiceAvatar: document.getElementById('voiceAvatar'),
      grokTabs: document.querySelectorAll('.grok-tab')
    };

    function customAlert(msg, duration = 2800) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }

    function formatTime() {
      return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
    }

    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) {
        customAlert("Out of tokens! Upgrade for unlimited");
        return false;
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val();
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000;
          await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { els.tokenCount.textContent = "15,000"; }
    }

    // Tab Switching
    els.grokTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        els.grokTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const isVoice = tab.dataset.tab === 'voice';
        els.chatPane.style.display = isVoice ? 'none' : 'flex';
        els.voicePane.classList.toggle('active', isVoice);
        els.chatInputBar.style.display = isVoice ? 'none' : 'block';
        if (isVoice && !recognition) initSpeechRecognition();
      });
    });

    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) return;
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-ZA';
      recognition.continuous = false;

      recognition.onstart = () => {
        isRecording = true;
        els.voiceStatus.textContent = "Listening...";
        els.voiceAvatar.classList.add('voice-listening');
        els.voiceMicBtn.classList.add('recording');
        els.voiceMicBtn.innerHTML = `<i data-lucide="square" class="w-12 h-12"></i>`;
        lucide.createIcons();
      };

      recognition.onresult = async e => {
        const text = e.results[0][0].transcript;
        await processVoiceInput(text);
      };

      recognition.onend = () => {
        isRecording = false;
        els.voiceStatus.textContent = "Ready to help";
        els.voiceAvatar.classList.remove('voice-listening', 'voice-speaking');
        els.voiceMicBtn.classList.remove('recording');
        els.voiceMicBtn.innerHTML = `<i data-lucide="mic" class="w-12 h-12"></i>`;
        lucide.createIcons();
      };
    }

    els.voiceMicBtn.onclick = () => isRecording ? recognition.stop() : recognition.start();

    async function processVoiceInput(text) {
      if (!(await deductTokens(estimateTokens(text)))) return;
      els.voiceStatus.textContent = "Thinking...";
      const reply = await getReply(text);
      els.voiceStatus.textContent = "Speaking...";
      els.voiceAvatar.classList.add('voice-speaking');
      await playVoiceResponse(reply);
    }

    async function getReply(msg) {
      const system = `You are Vynix Buddy, a warm CAPS tutor. Be encouraging and clear.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4",
            messages: [{ role: "system", content: system }, ...history.slice(-10), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "Hmm...";
      } catch { return "No connection."; }
    }

    async function playVoiceResponse(text) {
      if (!elevenlabsKey) return;
      const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB`, {
        method: 'POST',
        headers: { 'xi-api-key': elevenlabsKey, 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, model_id: 'eleven_turbo_v2_5' })
      });
      const blob = await res.blob();
      const audio = new Audio(URL.createObjectURL(blob));
      await audio.play();
    }

    function addMessage(content, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender} flex`;
      div.innerHTML = `<div class="content">${sender === 'ai' ? marked.parse(content) : content.replace(/\n/g, '<br>')}</div>`;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    els.sendBtn.onclick = async () => {
      const text = els.chatInput.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      els.chatInput.value = '';
      const reply = await getReply(text);
      addMessage(reply, 'ai');
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
      await loadTokens();
      addMessage("Sawubona! I'm Vynix Buddy, your CAPS AI tutor. How can I help today?", 'ai');
    });
  </script>
</body>
</html>
