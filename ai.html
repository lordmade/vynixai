<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@huggingface/transformers@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F9FAFB;
      --card-bg: #FFFFFF;
      --text-primary: #111827;
      --text-secondary: #4B5563;
      --border: #E5E7EB;
      --highlight: #38B2AC;
      --user-msg-bg: #DBEAFE;
      --ai-msg-bg: #F3F4F6;
      --sidebar-bg: #FFFFFF;
    }

    [data-theme="dark"] {
      --bg: #0F172A;
      --card-bg: #1E293B;
      --text-primary: #F8FAFC;
      --text-secondary: #CBD5E1;
      --border: #334155;
      --highlight: #0EA5E9;
      --user-msg-bg: #1E40AF;
      --ai-msg-bg: #334155;
      --sidebar-bg: #1E293B;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
      margin: 0;
      transition: background 0.3s ease, color 0.3s ease;
    }

    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--highlight);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--highlight);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .main-content {
      margin-left: 0;
      transition: margin-left 0.3s ease;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .sidebar.open ~ .main-content {
      margin-left: 280px;
    }

    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card-bg);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .message {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 1.25rem;
      word-wrap: break-word;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .message.user {
      align-self: flex-end;
      background: var(--user-msg-bg);
      color: var(--text-primary);
      border-bottom-right-radius: 0.25rem;
    }

    .message.ai {
      align-self: flex-start;
      background: var(--ai-msg-bg);
      color: var(--text-primary);
      border-bottom-left-radius: 0.25rem;
      flex-direction: row;
      gap: 0.5rem;
    }

    .ai-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--highlight);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      align-self: flex-end;
      opacity: 0.7;
    }

    .message-content {
      flex: 1;
    }

    .message.processing {
      opacity: 0.7;
      font-style: italic;
    }

    .message img {
      max-width: 100%;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    .typing-indicator {
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
    }

    .typing-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typing 1.2s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 100% { opacity: 0.3; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-3px); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-input-container {
      padding: 1rem;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #chat-input {
      flex: 1;
      background: var(--bg);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      padding: 0.75rem 1rem;
      outline: none;
      font-size: 1rem;
    }

    #chat-input:focus {
      border-color: var(--highlight);
    }

    .input-btn {
      background: transparent;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: background 0.2s;
      color: var(--text-secondary);
    }

    .input-btn:hover {
      background: var(--border);
    }

    .input-btn svg {
      width: 1.5rem;
      height: 1.5rem;
    }

    .emoji-panel {
      position: absolute;
      bottom: 100px;
      right: 1rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }

    .emoji-panel.open {
      display: block;
    }

    .emoji {
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
    }

    .emoji:hover {
      background: var(--border);
    }

    .feedback-container {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }

    .feedback-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      transition: all 0.2s;
      opacity: 0.7;
      width: 1.5rem;
      height: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .feedback-btn:hover { opacity: 1; transform: scale(1.05); }
    .feedback-btn.up { color: #10B981; }
    .feedback-btn.down { color: #EF4444; }
    .feedback-btn.voted { transform: scale(1.1); opacity: 1; animation: pulse 0.5s; }
    .feedback-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    @keyframes pulse {
      0% { transform: scale(1.1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1.1); }
    }

    .search-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      background: var(--bg);
      color: var(--text-primary);
    }

    .history-item {
      padding: 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 0.5rem;
    }

    .history-item:hover {
      background: var(--border);
    }

    .mobile-menu-btn {
      display: none;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
      }

      .sidebar.open ~ .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: block;
      }

      .chat-input-container {
        position: sticky;
        bottom: 0;
      }
    }

    @media (min-width: 1024px) {
      .chat-messages {
        padding: 2rem;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="avatar" id="user-avatar">U</div>
      <div>
        <div id="user-name" class="font-semibold">Friend</div>
        <div id="user-email" class="text-sm opacity-70">user@example.com</div>
      </div>
    </div>
    <div class="p-4">
      <input type="text" id="search-input" class="search-input" placeholder="Search messages..." aria-label="Search chat history">
      <div id="history-list" class="space-y-2"></div>
    </div>
    <div class="p-4 border-t border-border mt-auto">
      <button class="w-full p-2 rounded-lg bg-highlight text-white mb-2" onclick="newChat()">New Chat</button>
      <button class="w-full p-2 rounded-lg text-text-secondary hover:bg-border" onclick="toggleTheme()">Toggle Theme</button>
    </div>
  </nav>

  <!-- Overlay for mobile sidebar close -->
  <div class="fixed inset-0 bg-black bg-opacity-50 z-999 hidden sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Main Content -->
  <main class="main-content">
    <header class="chat-header">
      <div class="flex items-center gap-2">
        <button class="mobile-menu-btn input-btn" onclick="toggleSidebar()" aria-label="Open sidebar">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <div class="ai-avatar">🤖</div>
        <div>
          <h2 class="font-semibold">Vynix AI</h2>
          <p class="text-sm opacity-70">Your friendly chat buddy</p>
        </div>
      </div>
      <button class="input-btn" onclick="toggleSidebar()" aria-label="Open menu">⋮</button>
    </header>

    <div class="chat-messages" id="chat-messages"></div>

    <div class="chat-input-container">
      <button id="emoji-button" class="input-btn" onclick="toggleEmoji()" aria-label="Emoji">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </button>
      <div class="emoji-panel" id="emoji-panel">
        <!-- Simple emoji grid; add more as needed -->
        <span class="emoji" onclick="insertEmoji('😊')">😊</span>
        <span class="emoji" onclick="insertEmoji('😂')">😂</span>
        <span class="emoji" onclick="insertEmoji('❤️')">❤️</span>
        <span class="emoji" onclick="insertEmoji('👍')">👍</span>
        <span class="emoji" onclick="insertEmoji('🔥')">🔥</span>
        <!-- Extend with more -->
      </div>
      <button id="image-upload-button" class="input-btn">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
      </button>
      <input type="text" id="chat-input" placeholder="What's on your mind?" aria-label="Type your prompt" disabled>
      <button id="send-button" class="input-btn" disabled>
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 12h14M5 12l6-6m-6 6l6 6"/></svg>
      </button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, push, get, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { pipeline, TextStreamer } from "@huggingface/transformers";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const NEWS_API_KEY = 'YOUR_NEWSAPI_KEY_HERE';

    const state = {
      messages: [],
      hasChatted: false,
      isReady: false,
      generator: null,
      defaultTrainingData: [
        { input: "hello", output: "Hey there!" },
        { input: "how are you", output: "I'm doing great, thanks for asking!" },
        { input: "what's up", output: "Just chilling in the cloud, you?" },
        { input: "tell me a joke", output: "Why did the computer go to art school? It wanted to learn how to draw a better 'byte'!" },
        { input: "goodbye", output: "Catch you later, pal!" },
        { input: "what's your name", output: "I'm Vynix AI, your friendly chat buddy!" },
        { input: "how's the weather", output: "No clue, I'm in the cloud! What's it like where you are?" },
        { input: "who made you", output: "Katlego from Mokopane, South Africa, brought me to life!" },
        { input: "help me", output: "Sure thing! What's on your mind?" },
        { input: "latest news", output: "Stay tuned—I'll fetch some headlines soon!" }
      ],
      currentTheme: 'light',
      feedbackScores: {}  // Track per message
    };

    const elements = {
      loadingOverlay: document.getElementById('loading-overlay'),
      chatMessages: document.getElementById('chat-messages'),
      chatInput: document.getElementById('chat-input'),
      sendButton: document.getElementById('send-button'),
      sidebar: document.getElementById('sidebar'),
      sidebarOverlay: document.getElementById('sidebar-overlay'),
      emojiPanel: document.getElementById('emoji-panel'),
      searchInput: document.getElementById('search-input'),
      historyList: document.getElementById('history-list'),
      userAvatar: document.getElementById('user-avatar'),
      userName: document.getElementById('user-name'),
      userEmail: document.getElementById('user-email'),
      imageUploadButton: document.getElementById('image-upload-button'),
      emojiButton: document.getElementById('emoji-button')
    };

    let app, auth, db;
    let pendingFeedback = [];
    let emojiOpen = false;

    // THUMB SVGs (unchanged)
    const THUMB_UP_SVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M7 10V7C7 5.939 7.403 4.932 8.091 4.151C8.779 3.369 9.671 3 10.6 3H14C15.1046 3 16 3.89543 16 5V15C16 16.1046 15.1046 17 14 17H10.5C9.94768 17 9.40432 16.7373 9.06066 16.2928C8.717 15.8483 8.58152 15.3037 8.67123 14.75L9.17123 12.75C9.26094 12.1967 9.39642 11.6521 9.740 11.2077C10.0837 10.7632 10.627 10.5 11.18 10.5H13C13.5523 10.5 14 10.1046 14 9.5C14 8.89543 13.5523 8.5 13 8.5H10.6C10.268 8.5 9.94 8.589 9.646 8.774C9.352 8.959 9.121 9.23 9.03 9.55L8.53 11.55C8.44029 12.1033 8.30481 12.6479 7.96115 13.0923C7.61749 13.5368 7.07418 13.8 6.52 13.8H2C1.44772 13.8 1 13.4046 1 12.8V10.8C1 10.2046 1.44772 9.8 2 9.8H5V10H7Z" fill="currentColor"/></svg>`;
    const THUMB_DOWN_SVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M17 14V17C17 18.061 16.597 19.068 15.909 19.849C15.221 20.631 14.329 21 13.4 21H9.99999C8.89543 21 8 20.1046 8 19V9C8 7.89543 8.89543 7 9.99999 7H13.4C14.329 7 15.221 6.369 15.909 5.587C16.597 4.805 17 3.798 17 2.757V2.8C17 1.69543 16.1046 1 15 1H10.5C9.94768 1 9.40432 1.26274 9.06066 1.70727C8.717 2.1518 8.58152 2.69635 8.67123 3.24965L9.17123 5.24965C9.26094 5.80295 9.39642 6.3475 9.740 6.79183C10.0837 7.23616 10.627 7.5 11.18 7.5H13C13.5523 7.5 14 7.89543 14 8.5C14 9.10457 13.5523 9.5 13 9.5H10.6C10.268 9.5 9.94 9.411 9.646 9.226C9.352 9.041 9.121 8.77 9.03 8.45L8.53 6.45C8.44029 5.8967 8.30481 5.35215 7.96115 4.90782C7.61749 4.46349 7.07418 4.2 6.52 4.2H2C1.44772 4.2 1 4.59544 1 5.2V7.2C1 7.80457 1.44772 8.2 2 8.2H5V7.2H2V14H7V14.2H17Z" fill="currentColor"/></svg>`;

    function hideLoading() {
      if (!state.isReady) {
        state.isReady = true;
        elements.loadingOverlay.style.display = 'none';
      }
    }

    function toggleSidebar() {
      elements.sidebar.classList.toggle('open');
      elements.sidebarOverlay.classList.toggle('hidden');
    }

    function closeSidebar() {
      elements.sidebar.classList.remove('open');
      elements.sidebarOverlay.classList.add('hidden');
    }

    function toggleTheme() {
      const body = document.body;
      state.currentTheme = state.currentTheme === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', state.currentTheme);
      body.classList.add('theme-transition');
      setTimeout(() => body.classList.remove('theme-transition'), 300);
    }

    function newChat() {
      state.messages = [];
      elements.chatMessages.innerHTML = '';
      closeSidebar();
    }

    function toggleEmoji() {
      emojiOpen = !emojiOpen;
      elements.emojiPanel.classList.toggle('open', emojiOpen);
    }

    function insertEmoji(emoji) {
      elements.chatInput.value += emoji;
      elements.chatInput.focus();
      toggleEmoji();
    }

    function normalizeText(text) {
      text = text.toLowerCase().trim();
      const synonyms = {
        "hi": "hello",
        "hey": "hello",
        "whats up": "what's up",
        "joke": "tell me a joke",
        "news": "latest news"
      };
      return synonyms[text] || text;
    }

    function buildPrompt(userPrompt, extraContext = '') {
      const normalized = normalizeText(userPrompt);
      const relevantExamples = state.defaultTrainingData
        .filter(ex => ex.input.includes(normalized.split(' ')[0]))
        .slice(0, 3)
        .map(ex => `User: ${ex.input}\nVynix: ${ex.output}\n`);

      const systemPrompt = `You are Vynix AI, a friendly chat buddy made by Katlego from Mokopane, South Africa. Keep responses fun, concise (under 150 words), and engaging.`;
      const fullPrompt = [
        systemPrompt,
        ...relevantExamples,
        `User: ${userPrompt}\nVynix:`,
        extraContext ? `\nContext: ${extraContext}` : ''
      ].join('\n');

      return fullPrompt;
    }

    async function initializeGenerator() {
      try {
        console.log('Loading GPT-2 model...');
        state.generator = await pipeline(
          "text-generation",
          "Xenova/gpt2",
          { dtype: "q4" }
        );
        console.log('GPT-2 ready!');
        hideLoading();
      } catch (error) {
        console.error('Failed to load GPT-2:', error);
        state.generator = { async run(prompt) { return 'Sorry, my AI brain is offline—try a greeting!'; } };
        hideLoading();
      }
    }

    function anonymizeContent(content) {
      if (!content) return '';
      const piiPatterns = [
        /\b[A-Z][a-z]+ [A-Z][a-z]+\b/g,
        /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
        /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/g,
        /\b\d{1,2}[/-]\d{1,2}[/-]\d{2,4}\b/g,
        /\b(Street|Rd|Ave|Ln|Dr|Pretoria|Johannesburg|Mokopane)\b/gi
      ];
      let anonymized = content;
      piiPatterns.forEach(pattern => {
        anonymized = anonymized.replace(pattern, '[REDACTED]');
      });
      anonymized = anonymized.replace(/\b(my|our|personal|private)\s+\w+/gi, '[SENSITIVE]');
      return anonymized.trim();
    }

    async function fetchQuickQuote() {
      try {
        const quickQuote = await (await fetch('https://api.quotable.io/random')).json();
        return anonymizeContent(`"${quickQuote.content}" — ${quickQuote.author}`);
      } catch (e) { return ''; }
    }

    async function fetchQuickJoke() {
      try {
        const quickJoke = await (await fetch('https://official-joke-api.appspot.com/jokes/random')).json();
        return anonymizeContent(quickJoke.setup ? `${quickJoke.setup} ${quickJoke.punchline}` : quickJoke.joke);
      } catch (e) { return ''; }
    }

    async function fetchQuickNews() {
      if (NEWS_API_KEY === 'YOUR_NEWSAPI_KEY_HERE') return '';
      try {
        const quickNews = await (await fetch(`https://newsapi.org/v2/top-headlines?country=us&apiKey=${NEWS_API_KEY}`)).json();
        const topArticle = quickNews.articles?.[0];
        if (topArticle) {
          return anonymizeContent(`${topArticle.title} from ${topArticle.source.name}: ${topArticle.description.substring(0, 80)}...`);
        }
      } catch (e) { return ''; }
      return '';
    }

    // Update history list based on search
    function updateHistory() {
      const query = elements.searchInput.value.toLowerCase();
      const filtered = state.messages.filter(m => m.content.toLowerCase().includes(query));
      elements.historyList.innerHTML = filtered.slice(-10).map((m, i) => `
        <div class="history-item ${m.sender === 'user' ? 'text-right' : ''}" onclick="scrollToMessage(${state.messages.indexOf(m)})">
          <div class="text-sm">${m.content.substring(0, 50)}...</div>
          <div class="text-xs opacity-60">${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
      `).join('');
    }

    function scrollToMessage(index) {
      const msgEl = elements.chatMessages.children[index];
      if (msgEl) msgEl.scrollIntoView({ behavior: 'smooth' });
      closeSidebar();
    }

    async function initializeFirebase() {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          elements.chatInput.disabled = false;
          elements.sendButton.disabled = false;
          elements.userName.textContent = user.displayName || 'Friend';
          elements.userEmail.textContent = user.email || '';
          if (user.photoURL) {
            elements.userAvatar.style.backgroundImage = `url(${user.photoURL})`;
            elements.userAvatar.textContent = '';
          } else {
            elements.userAvatar.textContent = user.displayName?.[0]?.toUpperCase() || 'U';
          }
          await initializeGenerator();
          elements.searchInput.addEventListener('input', updateHistory);
        } else {
          setTimeout(() => {
            hideLoading();
            window.location.href = 'signup.html';
          }, 1000);
        }
      });
    }

    function appendMessage(content, sender, isTyping = false, isImage = false, messageId = null) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const div = document.createElement('div');
      div.className = `message ${sender}${isTyping ? ' processing' : ''}`;
      if (messageId) div.dataset.messageId = messageId;

      let html = '';
      if (sender === 'ai' && !isTyping && !isImage) {
        html = `
          <div class="ai-avatar">🤖</div>
          <div class="message-content">${content}</div>
        `;
      } else if (isTyping) {
        html = '<div class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
      } else if (isImage) {
        html = `<img src="${content}" alt="Uploaded image" class="w-full">`;
      } else {
        html = `<div class="message-content">${content}</div>`;
      }

      div.innerHTML = html + `<div class="message-time">${timeStr}</div>`;
      state.messages.push({ content, sender, isImage, timestamp: now.getTime(), messageId });
      elements.chatMessages.appendChild(div);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      updateHistory();
      return div;
    }

    async function handleFeedback(event, messageId, isUp) {
      if (!auth.currentUser) return;
      const userId = auth.currentUser.uid;
      const feedbackRef = ref(db, `feedback/${messageId}`);
      const snapshot = await get(feedbackRef);
      const existing = snapshot.val() || {};
      if (existing[userId]) return;

      await push(ref(db, `userFeedback/${userId}`), { 
        messageId, isUp, 
        prompt: state.messages.find(m => m.messageId === messageId)?.prompt || '',
        response: state.messages.find(m => m.messageId === messageId)?.content || '',
        timestamp: Date.now() 
      });
      existing[userId] = isUp ? 'up' : 'down';
      await set(ref(db, feedbackRef), existing);

      // Update local score
      state.feedbackScores[messageId] = state.feedbackScores[messageId] || { up: 0, down: 0 };
      state.feedbackScores[messageId][isUp ? 'up' : 'down']++;

      const btn = event.target.closest('.feedback-btn');
      btn.classList.add('voted');
      btn.disabled = true;
      const container = btn.closest('.feedback-container');
      const otherBtn = container.querySelector('.feedback-btn:not([disabled])');
      if (otherBtn) otherBtn.disabled = true;

      // Refresh score display
      const scoreEl = container.querySelector('.feedback-score');
      if (!scoreEl) {
        const scoreDiv = document.createElement('div');
        scoreDiv.className = 'feedback-score text-xs opacity-70 ml-2';
        container.appendChild(scoreDiv);
        scoreEl = scoreDiv;
      }
      scoreEl.textContent = `👍 ${state.feedbackScores[messageId].up} / 👎 ${state.feedbackScores[messageId].down}`;

      pendingFeedback.push({ messageId, isUp });
      console.log(`Feedback: ${isUp ? 'Up' : 'Down'} on ${messageId}`);
    }

    async function getAIResponse(prompt) {
      if (!state.hasChatted) {
        state.hasChatted = true;
      }
      const messageId = Date.now() + Math.random().toString(36);
      const tempMsg = appendMessage('', 'ai', true, false, messageId);
      try {
        const normalizedPrompt = normalizeText(prompt);
        state.messages[state.messages.length - 1].prompt = normalizedPrompt;

        let extraContext = '';
        if (normalizedPrompt.includes('quote') && Math.random() < 0.1) {
          extraContext = await fetchQuickQuote();
        } else if (normalizedPrompt.includes('joke') && Math.random() < 0.1) {
          extraContext = await fetchQuickJoke();
        } else if (normalizedPrompt.includes('news') && Math.random() < 0.1) {
          extraContext = await fetchQuickNews();
        }

        const fullPrompt = buildPrompt(prompt, extraContext);

        const streamer = new TextStreamer(state.generator.tokenizer, { skip_prompt: true });
        const result = await state.generator(fullPrompt, { 
          max_new_tokens: 100,
          do_sample: true,
          temperature: 0.7,
          streamer,
          pad_token_id: state.generator.tokenizer.eos_token_id
        });

        let response = result[0].generated_text.split('Vynix:').pop().trim();
        response = response.substring(0, 150);

        if (!response || response.length < 10) {
          response = 'Hmm, that stumped me—tell me more!';
        }

        tempMsg.querySelector('.message-content').textContent = response;
        tempMsg.classList.remove('processing');
        state.messages[state.messages.length - 1].content = response;
      } catch (error) {
        const fallback = 'Whoops, generation hiccup! Try again.';
        tempMsg.querySelector('.message-content').textContent = fallback;
        tempMsg.classList.remove('processing');
        state.messages[state.messages.length - 1].content = fallback;
        console.error('GPT-2 Error:', error);
      }

      // Add feedback
      setTimeout(() => {
        if (tempMsg.querySelector('.feedback-container')) return;
        const feedbackContainer = document.createElement('div');
        feedbackContainer.className = 'feedback-container';

        const upBtn = document.createElement('button');
        upBtn.className = 'feedback-btn up';
        upBtn.innerHTML = THUMB_UP_SVG;
        upBtn.setAttribute('aria-label', 'Helpful');
        upBtn.addEventListener('click', (e) => handleFeedback(e, messageId, true));

        const downBtn = document.createElement('button');
        downBtn.className = 'feedback-btn down';
        downBtn.innerHTML = THUMB_DOWN_SVG;
        downBtn.setAttribute('aria-label', 'Not helpful');
        downBtn.addEventListener('click', (e) => handleFeedback(e, messageId, false));

        feedbackContainer.append(upBtn, downBtn);
        tempMsg.appendChild(feedbackContainer);
      }, 100);
    }

    // Event Listeners
    elements.imageUploadButton.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => appendMessage(ev.target.result, 'user', false, true);
          reader.readAsDataURL(file);
        }
      };
      input.click();
    });

    elements.sendButton.addEventListener('click', async () => {
      const prompt = elements.chatInput.value.trim();
      if (!prompt) return;
      elements.chatInput.value = '';
      appendMessage(prompt, 'user');
      await getAIResponse(prompt);
    });

    elements.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        elements.sendButton.click();
      } else if (e.key === 'Escape') {
        elements.chatInput.value = '';
      }
    });

    // Close panels on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.chat-input-container')) toggleEmoji();
    });

    document.addEventListener('DOMContentLoaded', initializeFirebase);
  </script>
</body>
</html>
