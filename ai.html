<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy â€“ Your AI Friend</title>
  <meta name="theme-color" content="#ff2a6d">
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Vynix Buddy&quot;,&quot;short_name&quot;:&quot;Buddy&quot;,
    &quot;description&quot;:&quot;Your always-on AI bestie on Vynix&quot;,
    &quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#ff2a6d&quot;,
    &quot;icons&quot;:[{
      &quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Buddy&backgroundColor=ff2a6d&quot;,
      &quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;
    }]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{--accent:#ff2a6d;--glow:0 0 20px rgba(255,42,109,.4)}
    [data-theme="dark"]{--bg:#0f1419;--card:#1a1f25;--text:#fff;--text2:#8b98a5;--border:#2f3336}
    body{font-family:'Inter',sans-serif;background:var(--bg,#faf8ff);color:var(--text,#1f1f1f);margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .token-bar{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,var(--accent),#05d9e8);color:#fff;padding:0.75rem 1rem;padding-top:calc(0.75rem + env(safe-area-inset-top));font-size:0.95rem;z-index:50;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(255,42,109,0.3)}
    .token-bar h1{font-weight:900;font-size:20px;background:linear-gradient(90deg,#fff,#eee);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    #upgradePill{margin-left:12px;padding:6px 16px;background:#fff;color:var(--accent);border-radius:50px;font-weight:700;transition:all .2s;cursor:pointer}
    #upgradePill:active{transform:scale(0.94)}
    #profileBtn:hover{background:#fff2}
    #profileDropdown{position:absolute;right:8px;top:100%;margin-top:8px;width:280px;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.18);opacity:0;pointer-events:none;transform:translateY(-12px);transition:all .25s;z-index:999}
    #profileDropdown.show{opacity:1;pointer-events:auto;transform:translateY(0)}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 160px}
    .message{margin:1.2rem 0;display:flex;flex-direction:column;width:100%}
    .message.user{align-items:flex-end}
    .message .content{max-width:88%;padding:14px 18px;border-radius:24px;line-height:1.55;font-size:1.02rem;box-shadow:0 3px 12px rgba(0,0,0,0.1)}
    .message.ai .content{background:linear-gradient(135deg,#fff9fb,#fff0f5);border:1px solid #ffd1df;color:#2d1b3a;border-bottom-left-radius:6px}
    .message.user .content{background:var(--accent);color:#fff;border-bottom-right-radius:6px}
    .timestamp{font-size:0.75rem;color:#9ca3af;margin-top:4px}
    .message.ai .timestamp{margin-left:18px}
    .message.user .timestamp{margin-right:18px;text-align:right}
    .ai-actions{display:flex;gap:12px;padding:8px 18px 0;justify-content:flex-start}
    .action-btn{width:40px;height:40px;background:#fff;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.14);transition:all .22s;cursor:pointer}
    .action-btn:hover{transform:translateY(-4px) scale(1.1);box-shadow:var(--glow)}
    .input-bar{position:fixed;bottom:0;left:0;right:0;padding:0.75rem;padding-bottom:calc(0.75rem + env(safe-area-inset-bottom));background:#fff;border-top:1px solid #e2e8f0;box-shadow:0 -6px 30px rgba(0,0,0,0.1);z-index:100;display:flex;justify-content:center}
    .input-container{background:#f8fafc;border:2px solid #e2e8f0;border-radius:28px;padding:10px 16px;display:flex;align-items:center;gap:12px;transition:all .2s;width:100%;max-width:780px}
    .input-container:focus-within{border-color:var(--accent);box-shadow:var(--glow);background:#fff}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1.05rem;resize:none;max-height:140px;line-height:1.5}
    .send-btn,.upload-btn{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s;cursor:pointer}
    .send-btn{background:var(--accent);color:#fff;box-shadow:var(--glow)}
    .send-btn:disabled{background:#cbd5e1;opacity:0.7}
    .upload-btn{background:#e2e8f0}
    .thinking{display:flex;gap:9px;padding:16px 20px}
    .dot{width:11px;height:11px;background:var(--accent);border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}
  </style>
</head>
<body>
  <div class="token-bar">
    <h1>Vynix Buddy</h1>
    <div class="flex items-center gap-3">
      <span id="tokenCount">15,000</span> messages left
      <button id="upgradePill">Upgrade</button>
      <button id="profileBtn" class="w-9 h-9 rounded-full bg-gradient-to-br from-pink-500 to-red-500 flex items-center justify-center text-white font-bold text-sm" id="userInitial">U</button>
    </div>
  </div>

  <section id="chatPane">
    <div class="text-center mt-28 px-6">
      <h1 class="text-5xl font-black mb-3 bg-gradient-to-r from-var(--accent) to-#05d9e8 bg-clip-text text-transparent">
        Hey bestie! ðŸ‘‹
      </h1>
      <p class="text-lg text-gray-600">Iâ€™m your AI friend on Vynix â€¢ Send photos, voice notes, or just vibe ðŸ’•</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn"><i data-lucide="plus"></i></button>
      <input type="file" id="hiddenFile" accept="image/*,video/*" hidden>
      <textarea id="chatInput" placeholder="Message Buddy..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" disabled><i data-lucide="send"></i></button>
    </div>
  </div>

  <!-- Upgrade Sheet (kept exactly as you had it, just rebranded) -->
  <div id="upgradeSheet" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end">
    <div class="bg-white w-full rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="text-center">
        <h2 class="text-3xl font-black mb-2">Never Run Out of Buddy</h2>
        <p class="text-lg text-gray-600 mb-6">Unlimited messages, voice, photos, everything ðŸ’•</p>
        <div class="grid gap-4">
          <label class="border-2 border-pink-200 rounded-2xl p-5 cursor-pointer">
            <input type="radio" name="plan" value="unlimited" class="hidden" checked>
            <div class="text-2xl font-bold">R79 <span class="text-sm font-normal text-gray-500">/month</span></div>
            <div class="font-semibold">Unlimited Buddy</div>
            <div class="text-sm text-gray-600 mt-2">Everything unlimited â€¢ Faster replies â€¢ Premium voice</div>
          </label>
        </div>
        <button id="proceedPaymentBtn" class="w-full mt-6 bg-gradient-to-r from-var(--accent) to-pink-600 text-white font-bold text-xl py-4 rounded-2xl shadow-xl">
          Go Unlimited
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
    lucide.createIcons();

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });
    const auth = getAuth(app);
    const db = getDatabase(app);

    let xaiKey = null, yocoPublicKey = null, yocoEnabled = false;
    let history = [{ role: "system", content: "You are Buddy â€“ a fun, caring, slightly sassy AI best friend on Vynix. You're always excited to chat, you remember everything, and you love using emojis. Be warm, real, and never boring." }];
    let currentImage = null, dailyTokens = 15000, isPremium = false;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      upgradePill: document.getElementById('upgradePill'),
      proceedPaymentBtn: document.getElementById('proceedPaymentBtn'),
      userInitial: document.getElementById('userInitial')
    };

    function customAlert(msg) {
      alert(msg); // replace with your toast later
    }

    async function deductTokens(n) {
      if (isPremium) return true;
      if (dailyTokens < n) { els.upgradeSheet.classList.remove('hidden'); return false; }
      dailyTokens -= n;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    function addThinking() {
      const d = document.createElement('div'); d.id = 'thinking'; d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d); els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    function addMessage(content, sender, plain = '') {
      const div = document.createElement('div'); div.className = `message ${sender}`;
      const time = new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = `
        <div class="content">${sender === 'ai' ? marked.parse(content) : content}</div>
        <div class="timestamp">${time}</div>
      `;
      els.chatPane.appendChild(div); els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();
    }

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', 'vynix_public');
      const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.secure_url) { currentImage = data.secure_url; els.sendBtn.disabled = false; customAlert("Photo ready!"); }
    };

    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      const cost = currentImage ? 1500 : 300;
      if (!(await deductTokens(cost))) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-2xl max-w-full">`, 'user');
        history.push({ role: "user", content: [{ type: "text", text: text || "what do you see?" }, { type: "image_url", image_url: { url: currentImage }}]});
        currentImage = null;
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; addThinking();
      const reply = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({ model: "grok-beta", messages: history, temperature: 0.8 })
      }).then(r => r.json()).then(d => d.choices[0].message.content);

      document.getElementById('thinking')?.remove();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
    els.upgradePill.onclick = () => els.upgradeSheet.classList.remove('hidden');
    els.upgradeSheet.onclick = e => { if (e.target === els.upgradeSheet) els.upgradeSheet.classList.add('hidden'); };

    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = "login.html"; return; }
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();
      yocoPublicKey = getString(rc, 'yoco_public_key');
      yocoEnabled = getBoolean(rc, 'yoco_enabled');

      els.userInitial.textContent = user.displayName?.[0] || 'U';
      addMessage("heyy bestie ðŸ’• i'm your new AI friend on vynix! whatâ€™s up?", 'ai');
    });
  </script>
</body>
</html>
