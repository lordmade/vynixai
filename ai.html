<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Vynix AI - Upgraded</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <style>
    :root {
      --bg-color: #ffffff;
      --surface-color: #f4f6f8;
      --text-primary: #1a1a1a;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --accent-gradient: linear-gradient(135deg, #2563eb, #9333ea);
      --logo-gradient: linear-gradient(135deg, #2563eb 0%, #d946ef 100%);
      --input-bg: #f0f2f5;
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.06);
      --font-main: 'Outfit', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--bg-color);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* ---------- header ---------- */
    .header {
      height: 64px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      z-index: 10;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .vynix-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 12px;
      transition: transform 0.2s;
    }
    .vynix-logo:active { transform: scale(0.96); }
    .logo-icon {
      font-size: 26px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-variation-settings: 'FILL' 1, 'wght' 600;
    }
    .logo-text {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #1a1a1a;
    }

    /* ---------- chat ---------- */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0 calc(env(safe-area-inset-bottom) + 88px); /* space for floating input */
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
    }
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px;
      opacity: 1;
      transition: opacity 0.5s;
    }
    .welcome-icon {
      font-size: 64px;
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 20px;
      font-variation-settings: 'wght' 200;
    }
    .welcome-text {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    .welcome-sub {
      color: var(--text-muted);
      font-size: 16px;
      max-width: 300px;
      line-height: 1.5;
    }

    /* ---------- messages ---------- */
    .message-row {
      display: flex;
      flex-direction: column;
      padding: 10px 20px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      animation: fadeIn 0.3s ease forwards;
    }
    .message-bubble-container {
      display: flex;
      gap: 12px;
    }
    .message-row.user .message-bubble-container { justify-content: flex-end; }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
    }
    .avatar.ai {
      background: white;
      border: 1px solid #e0e0e0;
    }
    .avatar.ai span {
      background: var(--logo-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 20px;
      font-variation-settings: 'FILL' 1;
    }
    .message-row.ai .avatar span { 
      /* For brush icon */
      font-variation-settings: 'FILL' 1;
    }

    .message-content {
      max-width: 85%;
      line-height: 1.6;
      font-size: 16px;
      word-wrap: break-word;
    }
    .message-row.ai .message-content { color: var(--text-primary); padding-top: 6px; }
    .message-row.user .message-content {
      background: var(--surface-color);
      color: var(--text-primary);
      padding: 12px 18px;
      border-radius: 20px 20px 4px 20px;
    }
    .message-content strong { font-weight: 600; }
    .message-content code {
      background: #e8ebed;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.9em;
      color: #c026d3;
    }
    .message-content pre {
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 15px;
      border-radius: 12px;
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 13px;
      margin-top: 10px;
    }
    .copy-actions {
      display: flex;
      margin-left: 44px;
      margin-top: 4px;
    }
    .copy-btn {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      font-size: 12px;
      font-family: var(--font-main);
      cursor: pointer;
      padding: 4px 8px 4px 0;
      transition: color 0.2s;
    }
    .copy-btn:active { opacity: 0.6; }
    .copy-btn span { font-size: 16px; }

    /* ---------- FLOATING INPUT BAR ---------- */
    .input-wrapper-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      background: var(--bg-color);
      padding: 12px max(20px, env(safe-area-inset-left)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-right));
      box-shadow: 0 -2px 10px rgba(0,0,0,0.04);
    }
    .input-wrapper {
      background: var(--input-bg);
      border-radius: 28px;
      padding: 6px 6px 6px 6px; /* Reduced left padding to include mic button */
      display: flex;
      align-items: center;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .input-wrapper:focus-within {
      background: white;
      box-shadow: var(--shadow-soft);
      outline: 1px solid #e0e0e0;
    }
    input {
      flex: 1;
      border: none;
      background: none;
      outline: none;
      font-size: 16px;
      font-family: var(--font-main);
      color: var(--text-primary);
      padding: 12px 14px; /* Added some padding back to input itself */
      -webkit-user-select: text;
      user-select: text;
    }
    /* Mic Button Styles */
    .mic-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .mic-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-primary); }
    .mic-btn.listening {
      color: #dc2626; /* Red when recording */
      background: rgba(220, 38, 38, 0.1);
      animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }

    .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .send-btn.active {
      background: var(--text-primary);
      color: white;
    }
    .send-btn span { font-size: 22px; margin-left: 2px; }

    /* ---------- loading ---------- */
    .thinking { display: flex; gap: 5px; padding: 10px 0; }
    .dot {
      width: 5px;
      height: 5px;
      background: #9aa0a6;
      border-radius: 50%;
      animation: pulse 1s infinite alternate;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { to { opacity: 0.3; transform: translateY(-2px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <header class="header">
    <div class="vynix-logo" onclick="location.reload()">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <span class="logo-text">Vynix</span>
    </div>
  </header>

  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="material-symbols-rounded welcome-icon">neurology</div>
      <div class="welcome-text">How can I help?</div>
      <div class="welcome-sub">I'm Vynix, an AI expert in **SA Education**, **Coding**, and **Storytelling**. Try asking me to **generate an image**!</div>
    </div>
    <div id="messagesList"></div>
  </main>

  <div class="input-wrapper-fixed">
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn" onclick="toggleSpeech()">
        <span class="material-symbols-rounded">mic</span>
      </button>

      <input type="text" id="input" placeholder="Message Vynix..." autocomplete="off">
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <span class="material-symbols-rounded">arrow_upward</span>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';

    // NOTE: Replace this with your actual Firebase config if deploying.
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const xaiKey = getString(rc, 'xai_api_key');

    // --- UPGRADED SYSTEM PROMPT ---
    const systemInstructions = `
      You are Vynix, a helpful and general-purpose AI assistant.
      1. **Coding Expert:** You provide clean, modern, and bug-free code. Explain logic clearly.
      2. **SA Education Specialist:** You are an expert in the South African CAPS curriculum (Grades R-12). When asked about school subjects (Maths, Physics, Life Sciences, History, etc.), explain concepts using South African terminology, examples, and context appropriate for Matric or lower grades.
      3. **Master Storyteller:** When asked to tell a story, be vivid, creative, and engaging.
      4. **General:** Be concise, accurate, and use Markdown for formatting.
    `;

    let historyStack = [{
      role: "system",
      content: systemInstructions
    }];

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    function parseMarkdown(text) {
      return text
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Basic list parsing (more robust solution needed for complex markdown)
        .replace(/^\s*-\s+(.*)/gm, 'â€¢ $1<br>') 
        .replace(/\n/g, '<br>');
    }

    function addMessage(text, type) {
      $('#welcomeScreen').style.display = 'none';
      const list = $('#messagesList');
      const div = document.createElement('div');
      div.className = `message-row ${type}`;

      const avatarHTML = type === 'ai'
        ? `<div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div>`
        : '';

      let html = `
        <div class="message-bubble-container">
          ${avatarHTML}
          <div class="message-content">${parseMarkdown(text)}</div>
        </div>
      `;

      if (type === 'ai') {
        const uniqueId = 'copy-' + Date.now();
        html += `
          <div class="copy-actions">
            <button class="copy-btn" id="${uniqueId}">
              <span class="material-symbols-rounded">content_copy</span> Copy
            </button>
          </div>
        `;
        div.innerHTML = html;
        list.appendChild(div);
        document.getElementById(uniqueId).addEventListener('click', () => copyToClipboard(text, document.getElementById(uniqueId)));
      } else {
        div.innerHTML = html;
        list.appendChild(div);
      }
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    // --- NEW: FUNCTION TO ADD IMAGE MESSAGE ---
    function addImage(imageUrl, prompt) {
      $('#welcomeScreen').style.display = 'none';
      const list = $('#messagesList');
      const div = document.createElement('div');
      div.className = 'message-row ai';
      
      div.innerHTML = `
        <div class="message-bubble-container">
          <div class="avatar ai"><span class="material-symbols-rounded">brush</span></div>
          <div class="message-content">
            <p style="margin: 0;"><strong>Image Generation Complete!</strong></p>
            <p style="font-size: 14px; margin-top: 4px; color: var(--text-muted);">Prompt: ${prompt}</p>
            <img src="${imageUrl}" style="max-width: 100%; border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" alt="${prompt}" onerror="this.src='https://via.placeholder.com/400?text=Image+Failed+to+Load'" onload="this.scrollIntoView({behavior: 'smooth'})">
          </div>
        </div>
      `;
      list.appendChild(div);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function copyToClipboard(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const icon = btn.querySelector('span');
        icon.textContent = 'check';
        btn.style.color = '#2563eb';
        setTimeout(() => {
          icon.textContent = 'content_copy';
          btn.style.color = '';
        }, 2000);
      });
    }

    function addLoading() {
      const list = $('#messagesList');
      const div = document.createElement('div');
      div.id = 'loadingIndicator';
      div.className = 'message-row ai';
      div.innerHTML = `
        <div class="message-bubble-container">
          <div class="avatar ai"><span class="material-symbols-rounded">auto_awesome</span></div>
          <div class="message-content">
            <div class="thinking">
              <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
          </div>
        </div>
      `;
      list.appendChild(div);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }

    function removeLoading() {
      const el = $('#loadingIndicator');
      if (el) el.remove();
    }

    function vibrate() {
      if ('vibrate' in navigator) navigator.vibrate(40);
    }

    // --- NEW: SPEECH TO TEXT LOGIC ---
    const micBtn = document.getElementById('micBtn');
    const inputField = $('#input');
    let recognition;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-ZA'; // Use South African English
      recognition.interimResults = false;

      recognition.onstart = () => {
        micBtn.classList.add('listening');
        inputField.placeholder = "Listening...";
      };

      recognition.onend = () => {
        micBtn.classList.remove('listening');
        inputField.placeholder = "Message Vynix...";
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        inputField.value = transcript;
        inputField.focus();
        sendBtn.classList.add('active');
        // If you want to auto-send after speaking, uncomment the line below:
        // sendMessage(); 
      };
      
      recognition.onerror = (event) => {
          console.error("Speech Recognition Error:", event.error);
          inputField.placeholder = "Message Vynix... (Mic Error)";
          micBtn.classList.remove('listening');
      };
    } else {
      // Hide button if browser doesn't support the API
      micBtn.style.display = 'none'; 
    }

    window.toggleSpeech = () => {
      if (!recognition) return;
      if (micBtn.classList.contains('listening')) {
        recognition.stop();
      } else {
        recognition.start();
      }
    };
    // ------------------------------------

    window.sendMessage = async () => {
      const btn = $('#sendBtn');
      const msg = inputField.value.trim();
      if (!msg) return;

      inputField.value = '';
      btn.classList.remove('active');
      addMessage(msg, 'user');

      // --- NEW: IMAGE GENERATION INTERCEPTION ---
      const lowerMsg = msg.toLowerCase();
      if (lowerMsg.startsWith('generate image') || lowerMsg.startsWith('create an image') || lowerMsg.startsWith('draw')) {
        addLoading();
        // Using Pollinations.ai (Stable Diffusion) for free, keyless image generation
        const seed = Math.floor(Math.random() * 10000);
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(msg)}?seed=${seed}&nologo=true&width=512&height=512`;
        
        // Simulate network delay for realism
        setTimeout(() => {
          removeLoading();
          addImage(imageUrl, msg);
          // Store a record of the image generation in history
          historyStack.push({ role: "user", content: msg }, { role: "assistant", content: `[Generated an image for: ${msg}]` });
          vibrate();
        }, 1500);
        return; // Stop here, don't call xAI
      }
      // ------------------------------------------

      addLoading();

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [...historyStack, { role: "user", content: msg }],
            temperature: 0.7,
            max_tokens: 1000
          })
        });

        removeLoading();

        if (!res.ok) {
          addMessage("I'm having trouble connecting right now. Check the XAI API key or network.", 'ai');
          return;
        }

        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content?.trim() || "I'm not sure how to respond.";
        addMessage(reply, 'ai');
        historyStack.push({ role: "user", content: msg }, { role: "assistant", content: reply });

        vibrate();
      } catch (e) {
        removeLoading();
        addMessage("Connection error. Please check your internet or API setup.", 'ai');
        console.error("Fetch Error:", e);
      }
    };

    /* ---------- input handling ---------- */
    const sendBtn = $('#sendBtn');

    inputField.addEventListener('input', () => {
      sendBtn.classList.toggle('active', inputField.value.trim().length > 0);
    });
    inputField.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

    /* ---------- auth (as per original code) ---------- */
    onAuthStateChanged(auth, user => {
      // NOTE: You need a login.html for this to work. Comment out for local testing.
      // if (!user) location.href = 'login.html'; 
    });
  </script>
</body>
</html>
