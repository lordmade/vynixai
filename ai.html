<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-touch-fullscreen" content="yes">
  <title>BBM 2025 - Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --card-bg: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --border: #333333;
      --accent: #d40000;
      --bbm-red: #d40000;
      --header-bg: #000000;
      --chat-bubble-sent: #2a2a2a;
      --chat-bubble-received: #1a1a1a;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
      --glow: 0 0 20px rgba(212, 0, 0, 0.5);
    }
    body.light {
      --bg: #f8f8f8;
      --card-bg: #ffffff;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border: #e0e0e0;
      --header-bg: #ffffff;
      --chat-bubble-sent: #e6f3ff;
      --chat-bubble-received: #ffffff;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    * {
      -webkit-touch-callout: none !important;
    }
    .status-post {
      -webkit-touch-callout: none;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--header-bg);
      z-index: 100;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      box-shadow: var(--shadow-sm);
      transition: background-color 0.3s ease;
    }
    body.light .header {
      background: var(--header-bg);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      font-size: 22px;
      color: var(--bbm-red);
      letter-spacing: -0.5px;
      cursor: pointer;
      text-shadow: var(--glow);
    }
    .header-center {
      flex: 1;
      max-width: 420px;
      display: flex;
      justify-content: center;
    }
    .header-right, .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-actions button {
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 50%;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      min-width: 44px;
      box-shadow: var(--shadow-sm);
      position: relative;
      transition: all 0.3s ease;
    }
    .header-actions button:hover {
      border-color: var(--bbm-red);
      box-shadow: var(--glow);
      transform: scale(1.05);
    }
    .profile-container {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .profile-container:hover {
      transform: scale(1.05);
    }
    .header-username {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    .verified-icon-container {
      display: inline-flex;
      align-items: center;
    }
    .main-content {
      padding: 84px 20px 120px;
      min-height: calc(100vh - 84px);
      transition: padding 0.3s ease;
    }
    #messages { 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      padding: 20px 0; 
      max-height: calc(100vh - 200px); 
      overflow-y: auto; 
    }
    .message { 
      display: flex; 
      max-width: 80%; 
      padding: 12px 16px; 
      border-radius: 20px; 
      margin-bottom: 8px; 
    }
    .message.user { 
      align-self: flex-end; 
      background: var(--bbm-red); 
      color: #000; 
    }
    .message.ai { 
      align-self: flex-start; 
      background: var(--card-bg); 
      border: 1px solid var(--border); 
    }
    .input-bar { 
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      background: var(--card-bg); 
      border-top: 1px solid var(--border); 
      padding: 12px 20px; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }
    .input-bar input { 
      flex: 1; 
      background: none; 
      border: none; 
      outline: none; 
      color: var(--text-primary); 
      font-size: 16px; 
      padding: 12px; 
    }
    .send-btn { 
      background: var(--bbm-red); 
      color: #000; 
      border: none; 
      border-radius: 50%; 
      width: 44px; 
      height: 44px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: 700; 
    }
    .status { 
      text-align: center; 
      color: var(--text-secondary); 
      padding: 20px; 
    }
    .spinner { 
      display: flex; 
      gap: 8px; 
      margin: 20px auto; 
    }
    .dot { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      background: var(--bbm-red); 
      animation: bounce 1s infinite; 
    }
    @keyframes bounce { 
      0%, 80%, 100% { transform: scale(0); } 
      40% { transform: scale(1); } 
    }
    .dot:nth-child(1) { animation-delay: -0.32s; } 
    .dot:nth-child(2) { animation-delay: -0.16s; }
    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; z-index: 1000;
      justify-content: center; align-items: center; flex-direction: column;
    }
    #overlay p { color: white; margin-top: 10px; }
    #theme-toggle { 
      background: none; 
      border: none; 
      color: var(--text-secondary); 
      cursor: pointer; 
      font-size: 24px; 
    }
    /* Verified Badge Styles */
    .verified-icon {
      width: 18px;
      height: 18px;
      margin-left: 6px;
      vertical-align: middle;
      filter: drop-shadow(0 0 2px #1d9bf0);
    }
    .verified-badge {
      position: relative;
      width: 18px;
      height: 18px;
      display: inline-block;
    }
    .circle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 10.8px;
      height: 10.8px;
      background: #1DA1F2;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
    .checkmark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      width: 3.6px;
      height: 1.8px;
      border: solid white;
      border-width: 0 0.9px 0.9px 0;
      z-index: 3;
    }
    .checkmark::after {
      content: '';
      position: absolute;
      left: -2.25px;
      top: 0.9px;
      width: 0.9px;
      height: 3.6px;
      border: solid white;
      border-width: 0 0.9px 0.9px 0;
      transform: rotate(-90deg);
    }
    .star-point {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 1.35px solid transparent;
      border-right: 1.35px solid transparent;
      border-bottom: 5.4px solid #1DA1F2;
      transform: translate(-50%, -50%) rotate(0deg);
      z-index: 1;
    }
    .point-0 { transform: translate(-50%, -50%) rotate(0deg); }
    .point-1 { transform: translate(-50%, -50%) rotate(45deg); }
    .point-2 { transform: translate(-50%, -50%) rotate(90deg); }
    .point-3 { transform: translate(-50%, -50%) rotate(135deg); }
    .point-4 { transform: translate(-50%, -50%) rotate(180deg); }
    .point-5 { transform: translate(-50%, -50%) rotate(225deg); }
    .point-6 { transform: translate(-50%, -50%) rotate(270deg); }
    .point-7 { transform: translate(-50%, -50%) rotate(315deg); }
    .profile-pic {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--bbm-red);
      color: #000000;
      font-size: 22px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.3s ease;
    }
    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    @media (min-width: 768px) {
      .main-content {
        padding: 84px 60px 120px;
      }
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8f8f8;
        --card-bg: #ffffff;
        --text-primary: #000000;
        --text-secondary: #666666;
        --border: #e0e0e0;
        --header-bg: #ffffff;
      }
      body {
        background: var(--bg);
      }
      .header {
        background: var(--header-bg);
      }
    }
  </style>
</head>
<body class="dark">
  <header class="header">
    <div class="header-left">
      <div class="profile-container" id="profile-container">
        <div class="profile-pic" id="profile-pic"></div>
        <span id="verified-icon" class="verified-icon-container"></span>
      </div>
    </div>
    <div class="header-center">
      <div class="logo" onclick="window.location.href='index.html'">Vynix AI</div>
    </div>
    <div class="header-right">
      <div class="header-actions">
        <button id="theme-toggle" onclick="toggleTheme()" title="Toggle Theme" aria-label="Toggle Theme">
          <span class="material-icons">bedtime</span>
        </button>
        <button onclick="logout()" title="Logout" aria-label="Logout" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
          <span class="material-icons">logout</span>
        </button>
      </div>
    </div>
  </header>

  <div id="overlay">
    <div class="spinner"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <p id="overlay-text">Loading...</p>
  </div>

  <main class="main-content">
    <div id="status" class="status">Loading AI... Fetching public statuses.</div>
    <div id="messages" style="display: none;"></div>
  </main>

  <div class="input-bar">
    <input type="text" id="user-input" placeholder="Ask about SA trends, reply with some rizz, or chat lekker..." onkeypress="if(event.key==='Enter') sendMessage()">
    <button class="send-btn material-icons" onclick="sendMessage()">send</button>
  </div>

  <script>
    const verifiedIcon = `<div class="verified-badge">
      <div class="circle">
        <div class="checkmark"></div>
      </div>
      <div class="star-point point-0"></div>
      <div class="star-point point-1"></div>
      <div class="star-point point-2"></div>
      <div class="star-point point-3"></div>
      <div class="star-point point-4"></div>
      <div class="star-point point-5"></div>
      <div class="star-point point-6"></div>
      <div class="star-point point-7"></div>
    </div>`;

    function toggleTheme() {
      document.body.classList.toggle('light');
      const isLight = document.body.classList.contains('light');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }

    function initTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') {
        document.body.classList.add('light');
      }
    }

    window.addEventListener('load', initTheme);

    function showOverlay(text = 'Loading...') {
      document.getElementById('overlay').style.display = 'flex';
      document.getElementById('overlay-text').textContent = text;
    }

    function hideOverlay() {
      document.getElementById('overlay').style.display = 'none';
    }

    window.logout = async () => {
      window.location.href = 'login.html';
    };
  </script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    // Gemini API Configuration
    const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE'; // Replace with your actual Gemini API key
    const GEMINI_MODEL = 'gemini-1.5-flash-latest'; // Or 'gemini-pro' for the other variant
    const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

    let app, auth, db, currentUser, statusesData = [];

    // AI Identity and Purpose with SA Context
    const AI_NAME = 'Vynix';
    const AI_CREATOR = 'VynixAI team from South Africa';
    const AI_PURPOSE = `I'm ${AI_NAME}, created by the ${AI_CREATOR}. My purpose is to provide contextual replies infused with South African culture—think braai chats, rugby banter, township vibes, and the latest slang like 'delulu' for wild dreams, 'rizz' for smooth charm, or 'lekker' for that feel-good flow. Trained on public statuses, I help users dive into SA trends, reply with local flair, and keep conversations ubuntu-style.`;

    // SA Cultural Seeds for Prompt Context (to infuse context without training)
    const saCulturalSeeds = [
      "Braai on the weekend in Joburg, feeling lekker with some boerewors and pap.",
      "Rugby fever in Cape Town, Springboks smashing it! Who's got the rizz to predict the score?",
      "Township vibes in Soweto, dancing to amapiano—delulu if you think you can keep up!",
      "Load shedding got me glazing over candles, but sigma mindset keeps it positive.",
      "From the Highveld to the Karoo, SA stories full of ubuntu and that unbreakable spirit.",
      "What's sybau? Just SA slang for 'shut your beak and listen'—chat with some bop energy!"
    ];

    // Simple tokenizer for sentiment scan (retained for optional use)
    function tokenize(text) {
      return text.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .split(/\s+/)
        .filter(w => w.length > 0);
    }

    async function fetchPublicStatuses() {
      showOverlay('Fetching public statuses from Firebase...');
      try {
        const statusesRef = ref(db, 'statuses');
        const snapshot = await get(statusesRef);
        if (snapshot.exists()) {
          statusesData = Object.values(snapshot.val()).filter(s => s.content && s.content.trim()).map(s => s.content);
        }
      } catch (error) {
        console.error('Error fetching statuses:', error);
        document.getElementById('status').innerHTML = `Error fetching data: ${error.message}. Check your Firebase config and rules.`;
      }
      hideOverlay();
      return statusesData;
    }

    // Call Gemini API for response generation
    async function callGemini(prompt, contextStatuses = []) {
      if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
        throw new Error('Gemini API key not configured. Please set GEMINI_API_KEY.');
      }

      // Build system prompt with SA context
      const systemPrompt = `${AI_PURPOSE}

SA Cultural Context: ${saCulturalSeeds.join(' ')}.

Recent Public Statuses for Trends: ${contextStatuses.slice(0, 5).join('. ')}.

You are ${AI_NAME}. Always respond in a fun, engaging SA style: Use slang like 'lekker', 'rizz', 'delulu', 'ubuntu', 'eish'. Keep replies concise (under 150 words), end with a question to continue the chat. Infuse ubuntu warmth and local vibes.`;

      const fullPrompt = `${systemPrompt}

User: ${prompt}

${AI_NAME}: `;

      const requestBody = {
        contents: [{
          parts: [{
            text: fullPrompt
          }]
        }],
        generationConfig: {
          temperature: 0.8, // For creative, SA-flavored responses
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 200
        }
      };

      try {
        const response = await fetch(GEMINI_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error(`Gemini API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const generatedText = data.candidates[0]?.content?.parts[0]?.text || 'Eish, something went wrong—let's try that again!';
        // Trim AI prefix if present
        return generatedText.replace(/^(Vynix|${AI_NAME}):?\s*/i, '').trim();
      } catch (error) {
        console.error('Gemini API call failed:', error);
        throw error;
      }
    }

    function addMessage(sender, text) {
      const messages = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = `message ${sender.toLowerCase()}`;
      msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    // Enhanced sendMessage using Gemini
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const prompt = input.value.trim();
      if (!prompt) return;
      input.value = '';

      addMessage('User', prompt);

      // Add typing indicator
      const typingMsg = document.createElement('div');
      typingMsg.className = 'message ai';
      typingMsg.innerHTML = '<strong>Vynix:</strong> <div class="spinner"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div> Thinking with some SA rizz...';
      document.getElementById('messages').appendChild(typingMsg);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

      try {
        // Check if user is asking about itself
        const lowerPrompt = prompt.toLowerCase();
        const selfQueries = ['who are you', 'what are you', 'explain yourself', 'tell me about yourself', 'your purpose'];
        const isSelfQuery = selfQueries.some(query => lowerPrompt.includes(query));

        let response;
        if (isSelfQuery) {
          response = AI_PURPOSE;
        } else {
          // Use recent statuses as context
          const contextStatuses = statusesData.filter(text => text.length > 50).slice(-10);
          response = await callGemini(prompt, contextStatuses);
        }

        // Remove typing indicator
        document.getElementById('messages').removeChild(typingMsg);
        addMessage('AI', response);

      } catch (error) {
        console.error('Error generating response:', error);
        document.getElementById('messages').removeChild(typingMsg);
        addMessage('AI', `Eish, load shedding on the API side! Try again? Error: ${error.message}`);
      }
    }

    // Init - Simplified without training
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
    } catch (error) {
      console.error('Firebase init error:', error);
      document.getElementById('status').innerHTML = `Firebase initialization failed: ${error.message}. Please check your config.`;
      return;
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        // Fetch user data for profile
        showOverlay('Loading your profile...');
        try {
          const userRef = ref(db, `users/${user.uid}`);
          const userSnap = await get(userRef);
          if (userSnap.exists()) {
            const userData = userSnap.val();
            const profilePic = document.getElementById('profile-pic');
            if (profilePic) {
              if (userData.photoURL) {
                profilePic.innerHTML = `<img src="${userData.photoURL}" alt="Profile" loading="lazy">`;
              } else {
                const initial = userData.displayName ? userData.displayName[0].toUpperCase() : user.displayName?.[0].toUpperCase() || 'U';
                profilePic.innerHTML = initial;
              }
            }
            const verifiedEl = document.getElementById('verified-icon');
            if (verifiedEl) {
              if (userData.verified) {
                verifiedEl.innerHTML = verifiedIcon;
                verifiedEl.style.display = 'inline-flex';
              } else {
                verifiedEl.style.display = 'none';
              }
            }
          } else {
            // Fallback if no user data in DB
            const profilePic = document.getElementById('profile-pic');
            if (profilePic) {
              const initial = user.displayName?.[0].toUpperCase() || 'U';
              profilePic.innerHTML = initial;
            }
          }
        } catch (error) {
          console.error('Error fetching user data:', error);
          // Fallback profile
          const profilePic = document.getElementById('profile-pic');
          if (profilePic) {
            const initial = user.displayName?.[0].toUpperCase() || 'U';
            profilePic.innerHTML = initial;
          }
        }
        hideOverlay();

        showOverlay('Fetching public statuses from Firebase...');
        await fetchPublicStatuses();
        hideOverlay();

        document.getElementById('status').innerHTML = `Powered by Gemini API with SA flair! Ready for contextual replies.`;
        document.getElementById('messages').style.display = 'flex';

        // Introduce AI identity and purpose on first load
        addMessage('AI', AI_PURPOSE);

        // Context if statusId
        const urlParams = new URLSearchParams(window.location.search);
        const statusId = urlParams.get('statusId');
        if (statusId) {
          showOverlay('Loading context...');
          try {
            const statusRef = ref(db, `statuses/${statusId}`);
            const snap = await get(statusRef);
            if (snap.exists()) {
              const status = snap.val().content;
              addMessage('AI', `Context: "${status.substring(0, 100)}..." What would you like to know? Let's chat with some SA rizz!`);
            }
          } catch (error) {
            console.error('Error fetching status:', error);
          }
          hideOverlay();
        }
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
