<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Vynix • Feed</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --text: #0f1419;
      --text2: #536471;
      --border: #e1e8ed;
      --accent: #ff2a6d;
      --glow: 0 0 15px rgba(255, 42, 109, .4);
    }
    [data-theme="dark"] {
      --bg: #000000;
      --card: #16181c;
      --text: #e7e9ea;
      --text2: #71767b;
      --border: #2f3336;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
      backdrop-filter: blur(12px);
    }
    #header img {
      height: 40px;
      width: auto;
      object-fit: contain;
    }
    #header .header-logo {
      cursor: pointer;
    }
    #header #me-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
    }
    .main {
      padding: 64px 0 20px;
      min-height: 100vh;
    }
    .post-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      margin: 16px auto;
      max-width: 470px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    .post-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
    }
    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .post-username {
      font-weight: 600;
      font-size: 14px;
    }
    .post-time {
      font-size: 12px;
      color: var(--text2);
    }
    .post-media {
      background: #000;
      max-height: 600px;
      overflow: hidden;
    }
    .post-media img,
    .post-media video {
      width: 100%;
      height: auto;
      max-height: 600px;
      object-fit: contain;
      display: block;
    }
    .post-actions {
      padding: 8px 16px;
      display: flex;
      gap: 16px;
    }
    .action-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text);
      transition: transform 0.2s;
    }
    .action-btn.liked {
      color: #ed4956;
      animation: pulse 0.6s;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    .post-likes {
      padding: 0 16px 8px;
      font-weight: 600;
      font-size: 14px;
    }
    .post-caption {
      padding: 0 16px 12px;
      font-size: 14px;
      line-height: 1.5;
      word-break: break-word;
    }
    .hashtag {
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
    }
    .hashtag:hover {
      text-decoration: underline;
    }
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      box-shadow: var(--glow);
      font-size: 28px;
      display: grid;
      place-items: center;
      z-index: 20;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .fab:active {
      transform: scale(0.95);
    }
    .search-bar {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      background: var(--card);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      z-index: 9;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: none;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
    }
    .search-input:focus {
      outline: none;
      background: #f0f0f0;
    }
    #hashtag-header {
      position: fixed;
      top: 118px;
      left: 0;
      right: 0;
      background: var(--card);
      padding: 16px;
      text-align: center;
      font-weight: 700;
      font-size: 20px;
      border-bottom: 1px solid var(--border);
      z-index: 8;
      display: none;
    }
    #hashtag-header.show {
      display: block;
    }
    .loader {
      text-align: center;
      padding: 40px;
      color: var(--text2);
    }
    .no-posts {
      text-align: center;
      padding: 80px 20px;
      color: var(--text2);
      font-size: 16px;
    }
    /* ---- create post modal ---- */
    #create-post-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: flex-end;
      z-index: 100;
    }
    #create-post-modal.active {
      display: flex;
    }
    .create-sheet {
      background: var(--card);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .sheet-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .sheet-content {
      padding: 16px;
      height: calc(90vh - 140px);
      overflow-y: auto;
    }
    /* ---- upload progress ---- */
    #upload-progress {
      margin-top: 12px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    #upload-progress-bar {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    #upload-progress-text {
      text-align: center;
      font-size: 13px;
      color: var(--text2);
      margin-top: 6px;
    }
    /* ---- comments sheet ---- */
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-radius: 24px 24px 0 0;
      max-height: 90vh;
      overflow: hidden;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 100;
    }
    .bottom-sheet.open {
      transform: translateY(0);
    }
    .comments-wrapper {
      padding: 16px;
      height: calc(90vh - 140px);
      overflow-y: auto;
    }
    .comment-box {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--card);
    }
    .comment-box input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
    }
  </style>
</head>
<body data-theme="light">

<!-- ===== HEADER (logo + avatar, no text) ===== -->
<header id="header">
  <img src="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png" alt="Vynix" class="header-logo" onclick="location.href='chats.html'">
  <img id="me-avatar" class="w-9 h-9 rounded-full object-cover cursor-pointer">
</header>

<!-- ===== SEARCH ===== -->
<div class="search-bar">
  <input type="text" class="search-input" id="search-input" placeholder="Search hashtags #love, #vynix">
</div>

<!-- ===== HASHTAG TITLE ===== -->
<div id="hashtag-header"></div>

<!-- ===== FEED ===== -->
<main class="main" id="main-content">
  <div id="feed"></div>
  <div id="loader" class="loader hidden">Loading more posts...</div>
  <div id="no-more" class="loader hidden">No more posts yet</div>
</main>

<!-- ===== FAB ===== -->
<button class="fab material-icons" id="create-post-btn">add_box</button>

<!-- ===== CREATE-POST MODAL ===== -->
<div id="create-post-modal">
  <div class="create-sheet">
    <div class="sheet-header">
      <button id="close-modal" class="text-3xl">×</button>
      <h3 class="font-bold text-lg">New Post</h3>
      <button id="post-btn" class="text-[var(--accent)] font-bold">Share</button>
    </div>
    <div class="sheet-content">
      <div class="flex items-center gap-3 mb-4">
        <img id="my-avatar-preview" class="w-10 h-10 rounded-full">
        <strong id="my-username"></strong>
      </div>
      <textarea id="caption" rows="5" placeholder="Write a caption... #hashtag" class="w-full border-none outline-none text-base resize-none"></textarea>
      <div id="media-preview" class="my-4 hidden"></div>
      <label class="block p-4 bg-[#f8f9fa] dark:bg-[#1a1a1a] rounded-2xl text-center cursor-pointer">
        <span class="material-icons text-5xl text-[var(--accent)]">photo_camera</span><br>Add Photo / Video
        <input type="file" id="media-input" accept="image/*,video/*" hidden>
      </label>

      <!-- UPLOAD PROGRESS -->
      <div id="upload-progress" class="hidden">
        <div id="upload-progress-bar"></div>
        <div id="upload-progress-text">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== COMMENTS SHEET ===== -->
<div class="bottom-sheet" id="comments-sheet">
  <div class="sheet-header">
    <button id="close-comments" class="text-3xl">×</button>
    <h3 class="font-bold text-lg">Comments</h3>
  </div>
  <div class="comments-wrapper" id="comments-list">
    <div class="text-center py-10 text-[var(--text2)]">No comments yet</div>
  </div>
  <div class="comment-box">
    <img id="comment-avatar" class="w-9 h-9 rounded-full">
    <input type="text" id="comment-input" placeholder="Add a comment..." class="flex-1">
    <button id="send-comment" class="text-[var(--accent)] font-bold disabled:opacity-50" disabled>Post</button>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, remove, onValue, query, orderByChild, limitToLast, startAfter, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;

// ========== CHANGE HERE ==========
const CLOUDINARY_CLOUD_NAME = 'your-cloud-name';
const CLOUDINARY_UPLOAD_PRESET = 'your-preset';
// =================================

const feedEl = document.getElementById('feed');
const loader = document.getElementById('loader');
const noMore = document.getElementById('no-more');
const searchInput = document.getElementById('search-input');
const hashtagHeader = document.getElementById('hashtag-header');

let lastPostSnapshot = null;
let isLoading = false;
let currentHashtag = null;
const POSTS_PER_LOAD = 10;

/* ------- helpers ------- */
function extractHashtags(text) {
  return (text.match(/#[^\s#]+/g) || []).map(t => t.slice(1).toLowerCase());
}
function makeHashtagsClickable(text) {
  return text.replace(/#[^\s#]+/g, match => `<span class="hashtag" data-tag="\({match.slice(1)}">\){match}</span>`);
}
function formatTime(ts) {
  if (!ts) return '';
  const diff = Date.now() - ts;
  const m = 60000, h = m * 60, d = h * 24;
  if (diff < m) return 'now';
  if (diff < h) return `${Math.floor(diff / m)}m`;
  if (diff < d) return `${Math.floor(diff / h)}h`;
  return `${Math.floor(diff / d)}d`;
}

/* ------- post card html ------- */
function createPostHTML(postSnap) {
  const post = postSnap.val();
  const id = postSnap.key;
  const { username, avatar, caption = '', mediaUrl, mediaType, timestamp, likes = {}, comments = {} } = post;
  const liked = currentUser && likes[currentUser.uid];
  const likesCount = Object.keys(likes).length;
  const commentsCount = Object.keys(comments).length;

  return `
    <div class="post-card" data-post-id="\({id}">
      <div class="post-header">
        <img src="\){avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(username)}" class="post-avatar">
        <div>
          <div class="post-username">\({username}</div>
          <div class="post-time">\){formatTime(timestamp)}</div>
        </div>
      </div>

      \({mediaUrl ? `
        <div class="post-media">
          \){mediaType === 'video'
            ? `<video controls loop><source src="\({mediaUrl}" type="video/mp4"></video>`
            : `<img src="\){mediaUrl}" loading="lazy">`
          }
        </div>
      ` : ''}

      <div class="post-actions">
        <button class="action-btn like-btn \){liked ? 'liked' : ''}">favorite</button>
        <button class="action-btn comment-btn">mode_comment</button>
        <button class="action-btn">send</button>
      </div>

      <div class="post-likes">
        <strong>\({likesCount} likes</strong> • \){commentsCount} comments
      </div>

      \({caption ? `
        <div class="post-caption">
          <strong>\){username}</strong> \({makeHashtagsClickable(caption)}
        </div>
      ` : ''}

      \){commentsCount > 0 ? `
        <button class="view-comments-btn text-sm text-[var(--text2)] px-4 py-2">View all \({commentsCount} comments</button>
      ` : ''}
    </div>
  `;
}

/* ------- infinite scroll ------- */
async function loadMorePosts() {
  if (isLoading) return;
  isLoading = true;
  loader.classList.remove('hidden');

  let postsQuery = query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(POSTS_PER_LOAD + 1));
  if (lastPostSnapshot) postsQuery = query(postsQuery, startAfter(lastPostSnapshot.val().timestamp));

  const snapshot = await get(postsQuery);
  if (snapshot.numChildren() <= 1 && lastPostSnapshot) {
    noMore.classList.remove('hidden');
    loader.classList.add('hidden');
    isLoading = false;
    return;
  }

  const newPosts = [];
  snapshot.forEach(child => {
    if (!lastPostSnapshot || child.key !== lastPostSnapshot.key) newPosts.push(child);
  });
  newPosts.reverse();

  newPosts.forEach(postSnap => {
    feedEl.innerHTML += createPostHTML(postSnap);
    lastPostSnapshot = postSnap;
  });

  attachEventListeners();
  loader.classList.add('hidden');
  isLoading = false;
}

/* ------- hashtag filter ------- */
function loadHashtag(tag) {
  currentHashtag = tag.toLowerCase();
  hashtagHeader.textContent = `#\({tag}`;
  hashtagHeader.classList.add('show');
  feedEl.innerHTML = '';
  lastPostSnapshot = null;
  loadMorePosts();
}

/* ------- main feed ------- */
async function loadFeed() {
  feedEl.innerHTML = '';
  lastPostSnapshot = null;
  noMore.classList.add('hidden');

  let q = query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(POSTS_PER_LOAD + 1));
  const snap = await get(q);
  const posts = [];
  snap.forEach(child => posts.push(child));
  posts.reverse();

  if (currentHashtag) {
    const filtered = posts.filter(p => (p.val().caption || '').toLowerCase().includes(`#\){currentHashtag}`));
    filtered.forEach(p => feedEl.innerHTML += createPostHTML(p));
    lastPostSnapshot = filtered[filtered.length - 1] || null;
  } else {
    posts.forEach(p => feedEl.innerHTML += createPostHTML(p));
    lastPostSnapshot = posts[posts.length - 1] || null;
  }

  attachEventListeners();
}

/* ------- attach listeners ------- */
function attachEventListeners() {
  // likes
  document.querySelectorAll('.like-btn:not([data-bound])').forEach(btn => {
    btn.dataset.bound = 'true';
    btn.onclick = async () => {
      const postId = btn.closest('.post-card').dataset.postId;
      const likeRef = ref(db, `posts/\({postId}/likes/\){currentUser.uid}`);
      const snap = await get(likeRef);
      if (snap.exists()) {
        await remove(likeRef);
        btn.classList.remove('liked');
      } else {
        await set(likeRef, true);
        btn.classList.add('liked');
      }
    };
  });

  // comments
  document.querySelectorAll('.comment-btn, .view-comments-btn').forEach(btn => {
    btn.onclick = () => {
      const postId = btn.closest('.post-card').dataset.postId;
      openComments(postId);
    };
  });

  // hashtags
  document.querySelectorAll('.hashtag').forEach(span => {
    span.onclick = () => {
      const tag = span.dataset.tag;
      searchInput.value = `#\({tag}`;
      loadHashtag(tag);
    };
  });
}

/* ------- search ------- */
searchInput.addEventListener('input', (e) => {
  const val = e.target.value.trim();
  if (val.startsWith('#')) {
    const tag = val.slice(1);
    if (tag) { loadHashtag(tag); return; }
  }
  currentHashtag = null;
  hashtagHeader.classList.remove('show');
  loadFeed();
});

/* ------- scroll ------- */
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
    if (!isLoading && !noMore.classList.contains('hidden') === false) {
      if (!currentHashtag) loadMorePosts();
    }
  }
});

/* ------- comments ------- */
let currentPostId = null;
const commentsSheet = document.getElementById('comments-sheet');
const closeComments = document.getElementById('close-comments');
const commentsList = document.getElementById('comments-list');
const commentInput = document.getElementById('comment-input');
const sendComment = document.getElementById('send-comment');

function openComments(postId) {
  currentPostId = postId;
  commentsSheet.classList.add('open');
  loadComments(postId);
  commentInput.focus();
}
closeComments.onclick = () => {
  commentsSheet.classList.remove('open');
  currentPostId = null;
  commentInput.value = '';
};
commentInput.addEventListener('input', () => {
  sendComment.disabled = !commentInput.value.trim();
});
sendComment.onclick = async () => {
  const text = commentInput.value.trim();
  if (!text || !currentPostId) return;
  await push(ref(db, `posts/\({currentPostId}/comments`), {
    userId: currentUser.uid,
    username: currentUser.displayName || 'User',
    avatar: currentUser.photoURL,
    text,
    timestamp: serverTimestamp()
  });
  commentInput.value = '';
  sendComment.disabled = true;
};
function loadComments(postId) {
  const q = query(ref(db, `posts/\){postId}/comments`), orderByChild('timestamp'));
  onValue(q, snap => {
    commentsList.innerHTML = snap.numChildren() === 0
      ? '<div class="text-center py-10 text-[var(--text2)]">No comments yet</div>'
      : '';
    snap.forEach(c => {
      const cm = c.val();
      commentsList.innerHTML += `
        <div class="flex gap-3 px-4 py-3 border-b border-[var(--border)]">
          <img src="\({cm.avatar || 'https://ui-avatars.com/api/?name=' + cm.username}" class="w-10 h-10 rounded-full">
          <div>
            <div class="font-bold text-sm">\){cm.username}</div>
            <div class="text-sm">\({cm.text}</div>
            <div class="text-xs text-[var(--text2)] mt-1">\){formatTime(cm.timestamp)}</div>
          </div>
        </div>
      `;
    });
  });
}

/* ------- create post ------- */
const modal = document.getElementById('create-post-modal');
const closeModal = document.getElementById('close-modal');
const postBtn = document.getElementById('post-btn');
const captionInput = document.getElementById('caption');
const mediaInput = document.getElementById('media-input');
const mediaPreview = document.getElementById('media-preview');
const uploadProgress = document.getElementById('upload-progress');
const uploadProgressBar = document.getElementById('upload-progress-bar');
const uploadProgressText = document.getElementById('upload-progress-text');

document.getElementById('create-post-btn').onclick = () => modal.classList.add('active');
closeModal.onclick = () => modal.classList.remove('active');

mediaInput.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  mediaPreview.innerHTML = file.type.startsWith('video/')
    ? `<video src="\){url}" controls class="w-full rounded"></video>`
    : `<img src="\({url}" class="w-full rounded">`;
  mediaPreview.classList.remove('hidden');
};

postBtn.onclick = async () => {
  const caption = captionInput.value.trim();
  const file = mediaInput.files[0];
  if (!file && !caption) return alert('Add something!');

  postBtn.disabled = true;
  uploadProgress.classList.remove('hidden');
  uploadProgressBar.style.width = '0%';
  uploadProgressText.textContent = '0%';

  let mediaUrl = null;
  let mediaType = null;

  if (file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', `https://api.cloudinary.com/v1_1/\){CLOUDINARY_CLOUD_NAME}/\({file.type.startsWith('video/') ? 'video' : 'image'}/upload`);
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        uploadProgressBar.style.width = `\){pct}%`;
        uploadProgressText.textContent = `\({pct}%`;
      }
    };
    await new Promise((resolve, reject) => {
      xhr.onload = () => {
        if (xhr.status === 200) {
          const data = JSON.parse(xhr.responseText);
          mediaUrl = data.secure_url;
          mediaType = file.type.startsWith('video/') ? 'video' : 'image';
          resolve();
        } else reject(xhr.responseText);
      };
      xhr.onerror = reject;
      xhr.send(formData);
    });
  }

  await push(ref(db, 'posts'), {
    userId: currentUser.uid,
    username: currentUser.displayName || currentUser.email.split('@')[0],
    avatar: currentUser.photoURL,
    caption,
    mediaUrl,
    mediaType,
    timestamp: serverTimestamp(),
    likes: {},
    comments: {}
  });

  // reset
  captionInput.value = '';
  mediaInput.value = '';
  mediaPreview.innerHTML = '';
  mediaPreview.classList.add('hidden');
  modal.classList.remove('active');
  postBtn.disabled = false;
  uploadProgress.classList.add('hidden');

  // reload feed
  setTimeout(() => {
    lastPostSnapshot = null;
    loadFeed();
  }, 1000);
};

/* ------- auth ------- */
onAuthStateChanged(auth, user => {
  if (!user) return (location.href = 'login.html');
  currentUser = user;

  document.getElementById('me-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=\({user.displayName}&background=ff2a6d&color=fff`;
  document.getElementById('my-avatar-preview').src = user.photoURL || `https://ui-avatars.com/api/?name=\){user.displayName}&background=ff2a6d&color=fff`;
  document.getElementById('my-username').textContent = user.displayName || user.email.split('@')[0];
  document.getElementById('comment-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=\({user.displayName}&background=ff2a6d&color=fff`;

  loadFeed();
});
</script>
</body>
</html>
