<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <title>Vynix Lingua â€“ Multilingual African AI</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Space+Grotesk:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <!-- PWA tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vynix Lingua">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    /* ---------- 1.  Design-tokens ---------- */
    :root{
      --bg-color:#ffffff;
      --surface-color:#f3f6fc;
      --text-primary:#1e1e1e;
      --text-secondary:#444746;
      --text-muted:#9aa0a6;
      --accent-blue:#2563eb;
      --accent-purple:#d946ef;
      --accent-green:#10b981;
      --logo-gradient:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 50%,var(--accent-green) 100%);
      --radius-lg:32px;
      --radius-md:24px;
      --radius-sm:16px;
      --shadow-soft:0 8px 32px rgba(0,0,0,.06);
      --font-main:'Outfit',sans-serif;
      --font-head:'Space Grotesk',sans-serif;
      --font-mono:'Roboto Mono',monospace;
    }
    /* ---------- 2.  Reset & helpers -------------------------------- */
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:var(--font-main);background:transparent;color:var(--text-primary);
         height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none;
         -webkit-font-smoothing:antialiased}
    #rainCanvas{position:fixed;inset:0;z-index:-1;background:#ffffff}
    /* ---------- 3.  Header (glass-morphism) ------------------------ */
    .header{height:64px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;
            flex-shrink:0;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);
            border-bottom:1px solid rgba(0,0,0,.05);z-index:10}
    .header-left{display:flex;align-items:center;gap:12px}
    .vynix-logo{display:flex;align-items:center;gap:8px;cursor:pointer;padding:5px 10px;
                border-radius:12px;transition:transform .2s}
    .vynix-logo:active{transform:scale(.96)}
    .logo-icon{font-size:26px;background:var(--logo-gradient);-webkit-background-clip:text;
               -webkit-text-fill-color:transparent;font-variation-settings:'FILL' 1,'wght' 600}
    .logo-text{font-family:var(--font-head);font-size:22px;font-weight:700;letter-spacing:-.5px}
    .lingua-badge{background:var(--logo-gradient);color:#fff;font-size:10px;font-weight:700;
                  padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px}
    /* hamburger â€“ mobile only */
    .hamburger{display:none;font-size:28px;background:none;border:none;cursor:pointer;color:var(--text-primary)}
    .lang-selector{position:relative;margin-left:auto;margin-right:12px}
    .lang-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface-color);
              border:none;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;
              color:var(--text-primary);transition:background .2s}
    .lang-btn:hover{background:#e0e0e0}
    .lang-dropdown{position:absolute;top:48px;right:0;background:#fff;border-radius:12px;
                   box-shadow:0 8px 24px rgba(0,0,0,.12);padding:8px;min-width:240px;
                   max-height:400px;overflow-y:auto;display:none;z-index:100}
    .lang-dropdown.open{display:block}
    .lang-option{padding:10px 14px;border-radius:8px;cursor:pointer;transition:background .2s;
                 display:flex;align-items:center;gap:10px;font-size:14px}
    .lang-option:hover{background:var(--surface-color)}
    .lang-option.active{background:var(--accent-blue);color:#fff}
    .lang-flag{font-size:20px}
    .lang-name{font-weight:600}
    .lang-native{font-size:12px;color:var(--text-muted)}
    .lang-option.active .lang-native{color:rgba(255,255,255,.8)}
    .profile-btn{width:40px;height:40px;border-radius:50%;border:none;background:var(--surface-color);
                 color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;
                 flex-shrink:0;transition:background .2s}
    .profile-btn:active{background:#e0e0e0}
    .profile-btn span{font-size:24px}
    /* ---------- 4.  Chat area -------------------------------------- */
    .chat-container{flex:1;overflow-y:auto;padding:20px 0 160px;display:flex;flex-direction:column;
                    scroll-behavior:smooth}
    .welcome-screen{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;
                    text-align:center;padding:40px;animation:fadeIn .5s ease}
    .welcome-icon{font-size:64px;background:var(--logo-gradient);-webkit-background-clip:text;
                  -webkit-text-fill-color:transparent;margin-bottom:24px;font-variation-settings:'wght' 200}
    .welcome-text{font-family:var(--font-head);font-size:32px;font-weight:600;margin-bottom:12px}
    .welcome-sub{color:var(--text-muted);font-size:16px;max-width:400px;line-height:1.5;margin-bottom:20px}
    .feature-pills{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap;justify-content:center}
    .pill{background:var(--surface-color);padding:8px 16px;border-radius:20px;font-size:13px;
          font-weight:500;color:var(--text-secondary);display:flex;align-items:center;gap:5px}
    .pill span{font-size:16px}
    /* ---------- 5.  Input bar -------------------------------------- */
    .input-wrapper-fixed{position:fixed;left:0;right:0;bottom:0;z-index:30;background:var(--bg-color);
                         padding:12px max(20px,env(safe-area-inset-left)) max(20px,env(safe-area-inset-bottom)) max(20px,env(safe-area-inset-right));
                         box-shadow:0 -2px 10px rgba(0,0,0,.04);display:flex;flex-direction:column;align-items:center}
    .input-wrapper{width:100%;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);
                   border-radius:28px;padding:6px;display:flex;align-items:center;transition:background .2s,box-shadow .2s;
                   border:1px solid rgba(0,0,0,.06)}
    .input-wrapper:focus-within{background:#fff;box-shadow:var(--shadow-soft);border-color:var(--accent-blue)}
    input{flex:1;border:none;background:none;outline:none;font-size:16px;font-family:var(--font-main);
          color:var(--text-primary);padding:12px 14px;user-select:text}
    .mic-btn,.send-btn,.translate-btn{width:44px;height:44px;border-radius:50%;border:none;background:transparent;
                                       color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;
                                       transition:all .2s;flex-shrink:0}
    .mic-btn.listening{color:#dc2626;background:rgba(220,38,38,.1);animation:pulse-red 1.5s infinite}
    .send-btn.active{background:#1e1e1e;color:#fff}
    .translate-btn.active{background:var(--accent-green);color:#fff}
    .send-btn span,.translate-btn span{font-size:22px}
    .disclaimer{font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center;opacity:.8}
    /* token counter â€“ same as before */
    .token-counter{position:absolute;top:-35px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.95);
                   backdrop-filter:blur(8px);padding:6px 16px;border-radius:20px;font-size:12px;font-weight:500;
                   color:var(--text-secondary);box-shadow:0 2px 8px rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.06);
                   white-space:nowrap;transition:all .2s;pointer-events:none;z-index:31}
    .token-counter.warning{background:rgba(255,193,7,.95);color:#333}
    .token-counter.danger{background:rgba(220,38,38,.95);color:#fff}
    .token-count{font-weight:700;color:var(--accent-blue)}
    .token-counter.warning .token-count{color:#d97706}
    .token-counter.danger .token-count{color:#fff}
    /* ---------- 6.  Messages --------------------------------------- */
    .message-row{display:flex;margin-bottom:20px;max-width:80%;position:relative}
    .timestamp{font-size:10px;color:var(--text-muted);position:absolute;bottom:-15px}
    .message-row.user{margin-left:auto;text-align:right;flex-direction:column;align-items:flex-end}
    .message-row.user .timestamp{right:0}
    .message-row.ai{margin-right:auto;padding-left:50px;flex-direction:column;align-items:flex-start}
    .message-row.ai .timestamp{left:50px}
    .message-content{padding:14px 18px;border-radius:20px;line-height:1.6;text-align:left;font-size:15px;
                     white-space:pre-wrap;overflow-wrap:break-word;word-wrap:break-word;max-width:100%;
                     display:inline-block}
    .message-row.user .message-content{background:var(--logo-gradient);color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 5px rgba(37,99,235,.2)}
    .message-row.ai .message-content{background:rgba(255,255,255,.95);border-top-left-radius:4px;
                                      box-shadow:var(--shadow-soft)}
    .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
            flex-shrink:0;position:absolute}
    .message-row.ai .avatar{background:var(--logo-gradient);color:#fff;font-size:22px;left:0;top:-10px}
    .lang-badge-msg{position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,var(--accent-green) 0%,#059669 100%);
                    color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase}
    /* always-visible strip under ai bubble */
    .message-row.ai{position:relative;padding-bottom:28px}
    .ai-actions{position:absolute;left:50px;bottom:4px;display:flex;gap:6px;opacity:1}
    .ai-actions button{background:rgba(0,0,0,.65);color:#fff;border:none;border-radius:12px;padding:4px 10px;
                       font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:4px;
                       backdrop-filter:blur(4px)}
    .ai-actions button:hover{background:rgba(0,0,0,.8)}
    .ai-actions .material-symbols-rounded{font-size:16px}
    /* inside-bubble actions (kimi style) */
    .bubble-actions{position:absolute;right:8px;bottom:8px;display:flex;gap:6px}
    .bubble-btn{background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.08);border-radius:6px;padding:4px 6px;
                font-size:12px;color:#4b5563;cursor:pointer;display:inline-flex;align-items:center;gap:4px;
                transition:all .2s ease}
    .bubble-btn:hover{background:#e0e7ff;border-color:#c7d2fe;color:#3730a3}
    .bubble-btn:active{transform:scale(.96)}
    .bubble-btn.copied{background:#dbeafe;border-color:#93c5fd;color:#1d4ed8}
    /* ---------- 7.  Bottom-sheet ----------------------------------- */
    .bottom-sheet{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.98);
                  backdrop-filter:blur(20px);border-top:1px solid rgba(0,0,0,.05);
                  border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;z-index:50;
                  box-shadow:0 -5px 20px rgba(0,0,0,.1);transform:translateY(100%);
                  transition:transform .3s ease-out;max-height:90vh;overflow-y:auto}
    .bottom-sheet.open{transform:translateY(0)}
    .sheet-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);
                   z-index:40;opacity:0;pointer-events:none;transition:opacity .3s}
    .sheet-overlay.open{opacity:1;pointer-events:all}
    .sheet-header{font-size:20px;font-weight:700;margin-bottom:20px;text-align:center;position:relative}
    .sheet-close-btn{position:absolute;right:0;top:0;background:none;border:none;cursor:pointer;
                     color:var(--text-muted);padding:4px}
    .sheet-tab-bar{display:flex;border-bottom:1px solid var(--surface-color);margin-bottom:20px}
    .sheet-tab{flex:1;text-align:center;padding:10px 0;cursor:pointer;font-weight:500;
               color:var(--text-muted);border-bottom:2px solid transparent;
               transition:color .2s,border-color .2s}
    .sheet-tab.active{color:var(--accent-blue);border-bottom-color:var(--accent-blue)}
    .sheet-tab-content{padding:10px 0}
    .sheet-input{width:100%;padding:12px;margin-bottom:15px;border:1px solid var(--surface-color);
                 border-radius:10px;font-family:var(--font-main);font-size:16px;background:var(--input-bg)}
    .sheet-btn{width:100%;padding:14px;border:none;border-radius:50px;font-weight:700;font-size:16px;
               cursor:pointer;transition:opacity .2s,transform .2s;margin-top:10px;
               display:flex;align-items:center;justify-content:center;gap:10px}
    .sheet-btn:active{transform:scale(.98)}
    .sheet-btn-primary{background:var(--logo-gradient);color:#fff;box-shadow:0 4px 15px rgba(37,99,235,.3)}
    .sheet-btn-google{background:#fff;color:var(--text-primary);border:1px solid #ccc;margin-bottom:15px}
    .sheet-btn-google img{width:20px;height:20px}
    .sheet-btn-logout{background:#dc2626;color:#fff;margin-top:20px}
    .user-avatar-large{width:80px;height:80px;border-radius:50%;background:var(--logo-gradient);
                       margin:0 auto 15px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:40px}
    .user-email-text{text-align:center;color:var(--text-muted);font-size:14px;margin-top:-10px;margin-bottom:20px}
    .user-info-group{margin-bottom:20px;padding:15px;background:var(--surface-color);border-radius:12px}
    .user-info-group label{display:block;font-size:12px;font-weight:500;color:var(--text-secondary);margin-bottom:5px}
    /* ---------- 8.  Snackbar --------------------------------------- */
    #customSnackbar{visibility:hidden;min-width:250px;background:#333;color:#fff;text-align:center;
                     border-radius:8px;padding:12px;position:fixed;z-index:1000;left:50%;bottom:100px;
                     transform:translateX(-50%);box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;
                     transition:opacity .3s,bottom .3s;font-size:14px;font-weight:500}
    #customSnackbar.show{visibility:visible;opacity:1;bottom:80px}
    /* ---------- 9.  Animations ------------------------------------- */
    @keyframes pulse-red{0%{box-shadow:0 0 0 0 rgba(220,38,38,.4)}70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{to{opacity:.3;transform:translateY(-2px)}}
    /* ---------- 10.  Scroll-bar ------------------------------------ */
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-thumb{background:rgba(0,0,0,.15);border-radius:3px}
    /* ---------- 11.  Desktop centre layout ------------------------- */
    @media (min-width:768px){
      .input-wrapper-fixed{left:50%;transform:translateX(-50%);width:90%;max-width:800px;border-radius:24px;margin-bottom:20px}
      .chat-container{padding:20px 0 180px}
      .message-row{max-width:70%;margin-left:auto;margin-right:auto}
      .welcome-screen{max-width:800px;margin:0 auto;padding:40px 20px}
      #messagesList{max-width:800px;margin:0 auto;width:100%}
    }
    /* ---------- 12.  Mobile hamburger instead of logo -------------- */
    @media (max-width:767px){
      .hamburger{display:block}              /* show hamburger */
      .vynix-logo .logo-text,
      .vynix-logo .lingua-badge{display:none} /* hide text / badge */
    }
    /* ---------- 13.  Conversation drawer â€“ same as before ---------- */
    .history-drawer{position:fixed;top:0;left:-320px;width:320px;height:100vh;background:rgba(255,255,255,.98);
                    backdrop-filter:blur(20px);border-right:1px solid rgba(0,0,0,.08);z-index:100;
                    display:flex;flex-direction:column;transition:left .3s ease}
    .history-drawer.open{left:0}
    .drawer-header{padding:20px;border-bottom:1px solid rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
    .drawer-header h3{margin:0;font-family:var(--font-head);font-size:20px}
    .drawer-close{background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;color:var(--text-muted)}
    .drawer-content{flex:1;overflow-y:auto;padding:0 16px 16px}
    .new-conversation-btn{width:100%;padding:12px 16px;margin-top:16px;background:var(--logo-gradient);color:#fff;border:none;border-radius:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px}
    .conversation-list{flex:1;overflow-y:auto;padding:0 16px}
    .conversation-item{padding:12px 16px;margin-bottom:8px;background:var(--surface-color);border-radius:12px;cursor:pointer;transition:background .2s,border-color .2s;border:1px solid transparent}
    .conversation-item:hover{background:rgba(37,99,235,.08);border-color:var(--accent-blue)}
    .conversation-item.active{background:rgba(37,99,235,.12);border-color:var(--accent-blue)}
    .conversation-title{font-weight:600;font-size:14px;margin-bottom:4px;color:var(--text-primary)}
    .conversation-preview{font-size:12px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .conversation-time{font-size:11px;color:var(--text-muted);margin-top:4px}
    /* ---------- 14.  Desktop collapsible sidebar ------------------- */
    @media(min-width:1024px){
      .history-drawer{left:0;width:80px;background:rgba(255,255,255,.9);transition:width .3s ease}
      .history-drawer:hover{width:320px;background:rgba(255,255,255,.98)}
      .history-drawer .drawer-header h3,
      .history-drawer .new-conversation-btn span,
      .history-drawer .conversation-title,
      .history-drawer .conversation-preview,
      .history-drawer .conversation-time{opacity:0;transition:opacity .3s}
      .history-drawer:hover .drawer-header h3,
      .history-drawer:hover .new-conversation-btn span,
      .history-drawer:hover .conversation-title,
      .history-drawer:hover .conversation-preview,
      .history-drawer:hover .conversation-time{opacity:1}
      .history-drawer .new-conversation-btn{justify-content:center}
      .history-drawer:hover .new-conversation-btn{justify-content:flex-start}
      .header,.chat-container,.input-wrapper-fixed{margin-left:80px} /* content shifted */
    }
    /* ---------- 15.  Mobile full-width drawer ---------------------- */
    @media(max-width:767px){
      .history-drawer{width:100%;left:-100%}
    }
  </style>
</head>
<body>
  <!-- -------- drawer (mobile + desktop) -------- -->
  <div class="history-drawer" id="historyDrawer">
    <div class="drawer-header">
      <h3>Conversations</h3>
      <button class="drawer-close" onclick="toggleDrawer()">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
    <div class="drawer-content">
      <button class="new-conversation-btn" onclick="startNewConversation()">
        <span class="material-symbols-rounded">add</span>
        <span>New Chat</span>
      </button>
      <div class="conversation-list" id="conversationList"></div>
    </div>
  </div>

  <!-- -------- overlays / sheets -------- -->
  <div class="sheet-overlay" id="sheetOverlay"></div>
  <div class="bottom-sheet" id="userSheet"> ... </div>
  <div class="bottom-sheet" id="authSheet"> ... </div>

  <!-- -------- header -------- -->
  <header class="header">
    <button id="installBtn" class="profile-btn" style="display:none" title="Install app">
      <span class="material-symbols-rounded">download</span>
    </button>
    <div class="header-left">
      <!-- hamburger (mobile) -->
      <button class="hamburger" onclick="toggleDrawer()">
        <span class="material-symbols-rounded">menu</span>
      </button>
      <!-- logo (desktop) -->
      <div class="vynix-logo" onclick="location.reload()">
        <span class="material-symbols-rounded logo-icon">auto_awesome</span>
        <span class="logo-text">Vynix</span>
        <span class="lingua-badge">Lingua</span>
      </div>
    </div>
    <div class="lang-selector">
      <button class="lang-btn" id="langBtn">
        <span class="material-symbols-rounded">translate</span>
        <span id="currentLangText">English</span>
      </button>
      <div class="lang-dropdown" id="langDropdown"></div>
    </div>
    <button class="profile-btn" id="profileBtn">
      <span class="material-symbols-rounded">person</span>
    </button>
  </header>

  <!-- -------- chat area -------- -->
  <main class="chat-container" id="chatContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <span class="lingua-badge">Lingua</span>
      <div class="welcome-text" id="welcomeText">Sawubona! How can I help?</div>
      <div class="welcome-sub">I'm Vynix Lingua â€“ your multilingual African AI assistant. I speak 11 African languages and understand local slang!</div>
      <div class="feature-pills">
        <div class="pill"><span class="material-symbols-rounded">school</span>Education</div>
        <div class="pill"><span class="material-symbols-rounded">code</span>Coding</div>
        <div class="pill"><span class="material-symbols-rounded">auto_stories</span>Stories</div>
        <div class="pill"><span class="material-symbols-rounded">translate</span>11 Languages</div>
      </div>
    </div>
    <div id="messagesList"></div>
  </main>

  <!-- -------- input bar -------- -->
  <div class="input-wrapper-fixed">
    <div class="token-counter" id="tokenCounter">
      <span class="token-count" id="tokenCount">0</span> / <span class="token-limit">10,000</span> tokens
    </div>
    <div class="input-wrapper">
      <button class="mic-btn" id="micBtn"><span class="material-symbols-rounded">mic</span></button>
      <input type="text" id="input" placeholder="Message Vynix Lingua..." autocomplete="off">
      <button class="translate-btn" id="translateBtn" title="Auto-translate"><span class="material-symbols-rounded">g_translate</span></button>
      <button class="send-btn" id="sendBtn"><span class="material-symbols-rounded">arrow_upward</span></button>
    </div>
    <p class="disclaimer">Vynix Lingua speaks 11 African languages. Responses may vary.</p>
  </div>

  <!-- -------- scripts (firebase, firestore, logic unchanged) -------- -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const db = getFirestore(app);

    const DAILY_TOKEN_LIMIT = 10000;
    const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";
    const ELEVENLABS_API_KEY = getString(rc, 'elevenlabs_api_key') || "sk_a5591b58aa245cfec4f8fa9904de15b9392e9b5c94bd5231";

    /* ---------- languages, slang, voices â€“ same as before ---------- */
    const LANGUAGES = { en: { name: 'English', native: 'English', flag: 'ðŸ‡¬ðŸ‡§', code: 'en-US', greeting: 'Hello' }, zu: { name: 'Zulu', native: 'isiZulu', flag: 'ðŸ‡¿ðŸ‡¦', code: 'zu-ZA', greeting: 'Sawubona' }, xh: { name: 'Xhosa', native: 'isiXhosa', flag: 'ðŸ‡¿ðŸ‡¦', code: 'xh-ZA', greeting: 'Molo' }, af: { name: 'Afrikaans', native: 'Afrikaans', flag: 'ðŸ‡¿ðŸ‡¦', code: 'af-ZA', greeting: 'Hallo' }, st: { name: 'Sotho', native: 'Sesotho', flag: 'ðŸ‡¿ðŸ‡¦', code: 'st-ZA', greeting: 'Lumela' }, tn: { name: 'Tswana', native: 'Setswana', flag: 'ðŸ‡§ðŸ‡¼', code: 'tn-ZA', greeting: 'Dumela' }, sw: { name: 'Swahili', native: 'Kiswahili', flag: 'ðŸ‡°ðŸ‡ª', code: 'sw-KE', greeting: 'Jambo' }, yo: { name: 'Yoruba', native: 'YorÃ¹bÃ¡', flag: 'ðŸ‡³ðŸ‡¬', code: 'yo-NG', greeting: 'Bawo' }, ig: { name: 'Igbo', native: 'Asá»¥sá»¥ Igbo', flag: 'ðŸ‡³ðŸ‡¬', code: 'ig-NG', greeting: 'Ndewo' }, ha: { name: 'Hausa', native: 'Hausa', flag: 'ðŸ‡³ðŸ‡¬', code: 'ha-NG', greeting: 'Sannu' }, am: { name: 'Amharic', native: 'áŠ áˆ›áˆ­áŠ›', flag: 'ðŸ‡ªðŸ‡¹', code: 'am-ET', greeting: 'áˆ°áˆ‹áˆ' } };
    const SLANG_DICTIONARY = { eish: { lang: 'zu', meaning: 'Expression of surprise', translation: 'Oh my!' }, yebo: { lang: 'zu', meaning: 'Yes', translation: 'Yes' }, cha: { lang: 'zu', meaning: 'No', translation: 'No' }, howzit: { lang: 'af', meaning: 'How are you?', translation: 'How are you?' }, lekker: { lang: 'af', meaning: 'Nice/good', translation: 'Nice' }, braai: { lang: 'af', meaning: 'Barbecue', translation: 'Barbecue' }, molo: { lang: 'xh', meaning: 'Hello (singular)', translation: 'Hello' }, molweni: { lang: 'xh', meaning: 'Hello (plural)', translation: 'Hello everyone' }, sharp: { lang: 'multi', meaning: 'OK/bye', translation: 'OK' }, ja: { lang: 'af', meaning: 'Yes', translation: 'Yes' }, nee: { lang: 'af', meaning: 'No', translation: 'No' }, ayoba: { lang: 'multi', meaning: 'Awesome/cool', translation: 'Awesome!' }, 'shap shap': { lang: 'multi', meaning: 'Quickly/hurry', translation: 'Hurry up' }, 'now now': { lang: 'multi', meaning: 'Soon', translation: 'In a moment' }, 'just now': { lang: 'multi', meaning: 'Later', translation: 'Later' } };
    const ELEVENLABS_VOICE_IDS = { en: '21m00Tcm4TlvDq8ikWAM', zu: '21m00Tcm4TlvDq8ikWAM', xh: '21m00Tcm4TlvDq8ikWAM', af: '21m00Tcm4TlvDq8ikWAM', st: '21m00Tcm4TlvDq8ikWAM', tn: '21m00Tcm4TlvDq8ikWAM', sw: '21m00Tcm4TlvDq8ikWAM', yo: '21m00Tcm4TlvDq8ikWAM', ig: '21m00Tcm4TlvDq8ikWAM', ha: '21m00Tcm4TlvDq8ikWAM', am: '21m00Tcm4TlvDq8ikWAM' };

    let currentLang = 'en';
    let autoTranslate = false;
    let historyStack = [];
    let currentConversationId = null;
    let conversations = [];

    const $ = s => document.querySelector(s);
    const $i = $('#input'), $send = $('#sendBtn'), $mic = $('#micBtn');
    const $translate = $('#translateBtn'), $list = $('#messagesList');
    const $welcome = $('#welcomeScreen'), $welcomeText = $('#welcomeText');
    const $profileBtn = $('#profileBtn'), $userSheet = $('#userSheet');
    const $authSheet = $('#authSheet'), $sheetOverlay = $('#sheetOverlay');
    const $langBtn = $('#langBtn'), $langDropdown = $('#langDropdown');
    const $currentLangText = $('#currentLangText');
    const $customSnackbar = $('#customSnackbar');
    const $tokenCounter = $('#tokenCounter');
    const $tokenCount = $('#tokenCount');

    /* ---------- language dropdown ---------- */
    function initLanguageDropdown() {
      $langDropdown.innerHTML = Object.keys(LANGUAGES).map(code => {
        const lang = LANGUAGES[code];
        return `
          <div class="lang-option ${code === currentLang ? 'active' : ''}" data-lang="${code}">
            <span class="lang-flag">${lang.flag}</span>
            <div class="lang-info">
              <div class="lang-name">${lang.name}</div>
              <div class="lang-native">${lang.native}</div>
            </div>
          </div>
        `;
      }).join('');
      document.querySelectorAll('.lang-option').forEach(opt => {
        opt.addEventListener('click', () => switchLanguage(opt.dataset.lang));
      });
    }
    function switchLanguage(langCode) {
      currentLang = langCode;
      const lang = LANGUAGES[langCode];
      $currentLangText.textContent = lang.name;
      $langDropdown.classList.remove('open');
      document.querySelectorAll('.lang-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.lang === langCode);
      });
      updateSystemInstructions();
      showCustomSnackbar(`Language switched to ${lang.name}`);
      const user = auth.currentUser;
      if (user && user.displayName) {
        const firstName = user.displayName.split(' ')[0];
        $welcomeText.textContent = `${lang.greeting} ${firstName}! How can I help?`;
      } else {
        $welcomeText.textContent = `${lang.greeting}! How can I help?`;
      }
    }
    function updateSystemInstructions() {
      const lang = LANGUAGES[currentLang];
      const systemPrompt = `You are Vynix Lingua, a multilingual African AI assistant fluent in ${lang.name} (${lang.native}). â€¦`;
      historyStack = [{ role: 'system', content: systemPrompt }];
    }
    $langBtn.addEventListener('click', () => $langDropdown.classList.toggle('open'));
    document.addEventListener('click', e => {
      if (!$langBtn.contains(e.target) && !$langDropdown.contains(e.target)) $langDropdown.classList.remove('open');
    });
    $translate.addEventListener('click', () => {
      autoTranslate = !autoTranslate;
      $translate.classList.toggle('active', autoTranslate);
      showCustomSnackbar(autoTranslate ? 'Auto-translate enabled' : 'Auto-translate disabled');
    });
    function formatTime(date) {
      const h = date.getHours().toString().padStart(2, '0');
      const m = date.getMinutes().toString().padStart(2, '0');
      return `${h}:${m}`;
    }
    function showCustomSnackbar(msg) {
      $customSnackbar.textContent = msg;
      $customSnackbar.classList.add('show');
      setTimeout(() => $customSnackbar.classList.remove('show'), 3000);
    }
    /* ---------- token counter helpers ---------- */
    async function getCurrentTokenUsage() {
      const user = auth.currentUser;
      if (!user) return 0;
      const uid = user.uid;
      const today = new Date().toISOString().slice(0, 10);
      const usageRef = doc(db, 'tokenUsage', uid);
      const usageSnap = await getDoc(usageRef);
      const data = usageSnap.data() || {};
      return data.date === today ? (data.used || 0) : 0;
    }
    async function initializeTokenCounter() {
      const usage = await getCurrentTokenUsage();
      updateTokenCounter(usage);
    }
    async function updateTokenCounterAfterMessage() {
      const usage = await getCurrentTokenUsage();
      updateTokenCounter(usage);
    }
    function updateTokenCounter(used, limit = DAILY_TOKEN_LIMIT) {
      $tokenCount.textContent = used.toLocaleString();
      const percentage = (used / limit) * 100;
      $tokenCounter.classList.remove('warning', 'danger');
      if (percentage >= 90) $tokenCounter.classList.add('danger');
      else if (percentage >= 75) $tokenCounter.classList.add('warning');
    }
    async function checkAndUpdateTokenUsage(estimatedTokens) {
      const user = auth.currentUser;
      if (!user) return true;
      const uid = user.uid;
      const today = new Date().toISOString().slice(0, 10);
      const usageRef = doc(db, 'tokenUsage', uid);
      const usageSnap = await getDoc(usageRef);
      const data = usageSnap.data() || {};
      if (data.date !== today) {
        await setDoc(usageRef, { date: today, used: estimatedTokens, timestamp: serverTimestamp() });
        return true;
      }
      const newTotal = data.used + estimatedTokens;
      if (newTotal > DAILY_TOKEN_LIMIT) {
        showCustomSnackbar(`Daily limit reached (${DAILY_TOKEN_LIMIT.toLocaleString()} tokens). Try again tomorrow.`);
        return false;
      }
      await setDoc(usageRef, { used: newTotal, timestamp: serverTimestamp() }, { merge: true });
      return true;
    }
    /* ---------- bottom-sheet helpers ---------- */
    window.closeSheet = type => {
      $sheetOverlay.classList.remove('open');
      type === 'user' ? $userSheet.classList.remove('open') : $authSheet.classList.remove('open');
    };
    $sheetOverlay.addEventListener('click', () => closeSheet('user') || closeSheet('auth'));
    $profileBtn.addEventListener('click', () => {
      const user = auth.currentUser;
      user ? (document.getElementById('userNameInput').value = user.displayName || '', document.getElementById('userEmail').textContent = user.email || 'No email', openSheet('user')) : openSheet('auth');
    });
    window.openSheet = type => {
      $sheetOverlay.classList.add('open');
      type === 'user' ? $userSheet.classList.add('open') : $authSheet.classList.add('open');
    };
    document.getElementById('authTabs').addEventListener('click', e => {
      const tab = e.target.closest('.sheet-tab');
      if (!tab) return;
      const target = tab.dataset.tab;
      document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sheet-tab-content').forEach(c => c.style.display = 'none');
      tab.classList.add('active');
      document.getElementById(`${target}-content`).style.display = 'block';
    });
    window.updateDisplayName = async () => {
      const name = document.getElementById('userNameInput').value.trim();
      const user = auth.currentUser;
      if (!user || name === user.displayName) return;
      try {
        await updateProfile(user, { displayName: name });
        showCustomSnackbar('Display name updated!');
        const lang = LANGUAGES[currentLang];
        $welcomeText.textContent = `${lang.greeting} ${name.split(' ')[0]}! How can I help?`;
        closeSheet('user');
      } catch (e) {
        showCustomSnackbar('Failed to update name: ' + e.message);
      }
    };
    window.logout = async () => {
      try {
        await signOut(auth);
        showCustomSnackbar('Logged out successfully.');
        closeSheet('user');
      } catch (e) {
        showCustomSnackbar('Logout failed.');
      }
    };
    window.signInWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        showCustomSnackbar('Google Sign-In failed: ' + e.message);
      }
    };
    window.handleSignIn = async () => {
      const email = document.getElementById('signInEmail').value.trim();
      const password = document.getElementById('signInPassword').value;
      if (!email || !password) return showCustomSnackbar('Please enter both email and password.');
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        let msg = 'Sign-In failed.';
        if (e.code === 'auth/user-not-found') msg = 'No user found with this email.';
        else if (e.code === 'auth/wrong-password') msg = 'Incorrect password.';
        showCustomSnackbar(msg);
      }
    };
    window.handleSignUp = async () => {
      const name = document.getElementById('signUpName').value.trim();
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value;
      if (!name || !email || password.length < 6) return showCustomSnackbar('Please enter valid details (password min 6 chars).');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: name });
      } catch (e) {
        let msg = 'Sign-Up failed.';
        if (e.code === 'auth/email-already-in-use') msg = 'Email already in use.';
        showCustomSnackbar(msg);
      }
    };
    onAuthStateChanged(auth, async (user) => {
      const lang = LANGUAGES[currentLang];
      if (user) {
        if (user.displayName) {
          const firstName = user.displayName.split(' ')[0];
          $welcomeText.textContent = `${lang.greeting} ${firstName}! How can I help?`;
        } else {
          $welcomeText.textContent = `${lang.greeting}! How can I help?`;
        }
        closeSheet('auth');
        await initializeTokenCounter();
        await initializeConversationHistory();
        if (!currentConversationId) startNewConversation();
      } else {
        $welcomeText.textContent = `${lang.greeting}! How can I help?`;
      }
    });
    /* ---------- markdown / slang helpers ---------- */
    function parseMarkdown(text) {
      let html = text.replace(/```([\s\S]*?)```/g, (m, c) => `<pre><code>${c.trim()}</code></pre>`);
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>')
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\*(.*?)\*/g, '<em>$1</em>');
      html = html.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>');
      if (html.includes('<li>')) {
        html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
        html = html.replace(/<\/ul><ul>/g, '');
      }
      html = html.split('<pre>').map((seg, i) => i % 2 === 0 ? seg.replace(/\n/g, '<br>') : seg).join('<pre>');
      html = html.replace(/<br><pre>/g, '<pre>').replace(/<\/pre><br>/g, '</pre>');
      return html;
    }
    function detectSlang(text) {
      const words = text.toLowerCase().split(/\s+/);
      const detected = [];
      for (const w of words) if (SLANG_DICTIONARY[w]) detected.push({ word: w, ...SLANG_DICTIONARY[w] });
      return detected;
    }
    /* ---------- message builders ---------- */
    function addMessage(text, type, showLangBadge = false) {
      $welcome.style.display = 'none';
      const row = document.createElement('div');
      row.className = `message-row ${type}`;
      const content = document.createElement('div');
      content.className = 'message-content';
      content.innerHTML = parseMarkdown(text);
      if (showLangBadge && currentLang !== 'en') {
        const badge = document.createElement('div');
        badge.className = 'lang-badge-msg';
        badge.textContent = LANGUAGES[currentLang].native;
        content.appendChild(badge);
      }
      const time = document.createElement('div');
      time.className = 'timestamp';
      time.textContent = formatTime(new Date());
      if (type === 'ai') {
        const avatar = document.createElement('div');
        avatar.className = 'avatar ai';
        avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
        const bubble = document.createElement('div');
        bubble.className = 'message-content';
        bubble.innerHTML = parseMarkdown(text);
        const actions = document.createElement('div');
        actions.className = 'bubble-actions';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'bubble-btn';
        copyBtn.innerHTML = `<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="10" height="10" rx="2"/><path d="M6 2v4h4"/></svg>`;
        copyBtn.title = 'Copy';
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText(text);
          copyBtn.classList.add('copied');
          setTimeout(() => copyBtn.classList.remove('copied'), 1500);
        };
        const speakBtn = document.createElement('button');
        speakBtn.className = 'bubble-btn';
        speakBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:16px">volume_up</span>`;
        speakBtn.title = 'Speak';
        speakBtn.onclick = async () => {
          speakBtn.disabled = true;
          speakBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:16px">hourglass_empty</span>`;
          try {
            const voiceId = ELEVENLABS_VOICE_IDS[currentLang] || ELEVENLABS_VOICE_IDS.en;
            const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`, {
              method: 'POST',
              headers: { 'xi-api-key': ELEVENLABS_API_KEY, 'Content-Type': 'application/json' },
              body: JSON.stringify({ text, model_id: 'eleven_multilingual_v2', voice_settings: { stability: .35, similarity_boost: .85 } })
            });
            if (!res.ok) throw new Error('TTS failed');
            new Audio(URL.createObjectURL(await res.blob())).play();
          } catch (e) {
            showCustomSnackbar('Speech failed');
          } finally {
            speakBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:16px">volume_up</span>`;
            speakBtn.disabled = false;
          }
        };
        actions.append(copyBtn, speakBtn);
        bubble.appendChild(actions);
        row.append(avatar, bubble, time);
      } else {
        row.append(content, time);
      }
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }
    function addLoading() {
      const row = document.createElement('div');
      row.id = 'loading';
      row.className = 'message-row ai';
      const avatar = document.createElement('div');
      avatar.className = 'avatar ai';
      avatar.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
      const typing = document.createElement('div');
      typing.className = 'typing-indicator';
      typing.innerHTML = `
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <span style="font-size:14px;color:#666;margin-left:8px">Vynix is thinkingâ€¦</span>
      `;
      row.append(avatar, typing);
      $list.appendChild(row);
      $('#chatContainer').scrollTop = $('#chatContainer').scrollHeight;
    }
    function removeLoading() {
      const loading = $('#loading');
      if (loading) loading.remove();
    }
    /* ---------- conversation history ---------- */
    async function initializeConversationHistory() {
      const user = auth.currentUser;
      if (!user) return;
      try {
        const historyRef = doc(db, 'conversationHistory', user.uid);
        const historySnap = await getDoc(historyRef);
        conversations = historySnap.exists() ? historySnap.data().conversations || [] : [];
        renderConversationList();
      } catch (error) {
        console.error('Error loading conversation history:', error);
      }
    }
    window.toggleDrawer = () => {
      document.getElementById('historyDrawer').classList.toggle('open');
    };
    function startNewConversation() {
      currentConversationId = Date.now().toString();
      historyStack = [{ role: 'system', content: historyStack[0].content }];
      document.getElementById('messagesList').innerHTML = '';
      document.getElementById('welcomeScreen').style.display = 'flex';
      toggleDrawer();
    }
    async function saveConversation(title, messages) {
      const user = auth.currentUser;
      if (!user || !currentConversationId) return;
      try {
        const conversation = {
          id: currentConversationId,
          title: title,
          messages: messages,
          timestamp: serverTimestamp(),
          lastMessage: messages[messages.length - 1]?.content || ''
        };
        const existingIndex = conversations.findIndex(c => c.id === currentConversationId);
        if (existingIndex >= 0) conversations[existingIndex] = conversation;
        else conversations.unshift(conversation);
        conversations = conversations.slice(0, 50);
        const historyRef = doc(db, 'conversationHistory', user.uid);
        await setDoc(historyRef, { conversations }, { merge: true });
        renderConversationList();
      } catch (error) {
        console.error('Error saving conversation:', error);
      }
    }
    async function loadConversation(conversationId) {
      const conversation = conversations.find(c => c.id === conversationId);
      if (!conversation) return;
      currentConversationId = conversationId;
      historyStack = [{ role: 'system', content: historyStack[0].content }];
      document.getElementById('messagesList').innerHTML = '';
      document.getElementById('welcomeScreen').style.display = 'none';
      conversation.messages.forEach(msg => {
        if (msg.role === 'user') {
          addMessage(msg.content, 'user');
        } else if (msg.role === 'assistant') {
          addMessage(msg.content, 'ai', currentLang !== 'en');
        }
        historyStack.push(msg);
      });
      toggleDrawer();
    }
    function renderConversationList() {
      const listContainer = document.getElementById('conversationList');
      listContainer.innerHTML = '';
      conversations.forEach(conversation => {
        const item = document.createElement('div');
        item.className = 'conversation-item';
        if (conversation.id === currentConversationId) item.classList.add('active');
        const date = conversation.timestamp?.toDate ? conversation.timestamp.toDate() : new Date();
        item.innerHTML = `
          <div class="conversation-title">${conversation.title || 'Untitled Chat'}</div>
          <div class="conversation-preview">${conversation.lastMessage}</div>
          <div class="conversation-time">${formatTimeAgo(date)}</div>
        `;
        item.onclick = () => loadConversation(conversation.id);
        listContainer.appendChild(item);
      });
    }
    function formatTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return `${days}d ago`;
    }
    function generateConversationTitle(messages) {
      const userMessages = messages.filter(m => m.role === 'user');
      if (userMessages.length === 0) return 'New Conversation';
      const firstMessage = userMessages[0].content;
      return firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
    }
    /* ---------- send message ---------- */
    window.sendMessage = async () => {
      const msg = $i.value.trim();
      if (!msg) return;
      if (!auth.currentUser) {
        showCustomSnackbar('You must be logged in to chat.');
        openSheet('auth');
        return;
      }
      $i.value = '';
      $send.classList.remove('active');
      addMessage(msg, 'user');
      const slang = detectSlang(msg);
      if (slang.length > 0 && (msg.toLowerCase().includes('what does') || msg.toLowerCase().includes('meaning'))) {
        const expl = slang.map(s => `**${s.word}** (${LANGUAGES[s.lang].name}): ${s.meaning} â€“ "${s.translation}"`).join('\n\n');
        addMessage(`Here are the slang terms I found:\n\n${expl}`, 'ai', true);
        return;
      }
      const estimatedInputTokens = Math.ceil(msg.length / 4) + 200;
      const allowed = await checkAndUpdateTokenUsage(estimatedInputTokens);
      if (!allowed) {
        addMessage('You have reached your daily token limit. Please try again tomorrow.', 'ai');
        return;
      }
      addLoading();
      try {
        const messages = [...historyStack, { role: 'user', content: msg }];
        const res = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: { Authorization: `Bearer ${XAI_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'grok-4-1-fast-non-reasoning',
            messages,
            temperature: 0.7,
            max_tokens: 1500
          })
        });
        removeLoading();
        if (!res.ok) {
          await checkAndUpdateTokenUsage(-estimatedInputTokens);
          throw new Error(`API error: ${res.status}`);
        }
        const data = await res.json();
        const reply = data.choices[0]?.message?.content?.trim() || 'No response.';
        const outputTokens = Math.ceil(reply.length / 4);
        await checkAndUpdateTokenUsage(outputTokens);
        addMessage(reply, 'ai', currentLang !== 'en');
        historyStack.push({ role: 'user', content: msg }, { role: 'assistant', content: reply });
        await updateTokenCounterAfterMessage();
        /* auto-save conversation after each exchange */
        const user = auth.currentUser;
        if (user && currentConversationId) {
          const title = generateConversationTitle(historyStack.slice(1));
          await saveConversation(title, historyStack.slice(1));
        }
      } catch (e) {
        removeLoading();
        addMessage('Connection error. Please try again later.', 'ai');
        console.error(e);
      }
    };
    $i.addEventListener('input', () => $send.classList.toggle('active', $i.value.trim().length > 0));
    $i.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    $send.addEventListener('click', sendMessage);
    /* ---------- voice input ---------- */
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SR();
      rec.continuous = false;
      rec.interimResults = false;
      $mic.addEventListener('click', () => {
        if (!auth.currentUser) {
          showCustomSnackbar('You must be logged in to use voice.');
          openSheet('auth');
          return;
        }
        rec.lang = LANGUAGES[currentLang].code;
        rec.start();
      });
      rec.onstart = () => {
        $mic.classList.add('listening');
        $i.placeholder = 'Listening...';
      };
      rec.onresult = e => {
        $i.value = e.results[0][0].transcript;
        sendMessage();
      };
      rec.onend = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Message Vynix Lingua...';
      };
      rec.onerror = () => {
        $mic.classList.remove('listening');
        $i.placeholder = 'Message Vynix Lingua...';
      };
    } else {
      $mic.style.display = 'none';
    }
    /* ---------- init ---------- */
    initLanguageDropdown();
    updateSystemInstructions();
    /* ---------- rain animation ---------- */
    const canvas = document.createElement('canvas');
    canvas.id = 'rainCanvas';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let w, h, drops = [];
    const colors = ['#2563eb', '#d946ef', '#10b981', '#cbd5e1'];
    function resize() {
      w = innerWidth;
      h = innerHeight;
      canvas.width = w;
      canvas.height = h;
      drops = [];
      const count = Math.floor(w / 15);
      for (let i = 0; i < count; i++) drops.push({ x: Math.random() * w, y: Math.random() * h, len: Math.random() * 20 + 10, speed: Math.random() * 3 + 2, color: colors[Math.floor(Math.random() * colors.length)], opacity: Math.random() * 0.5 + 0.1 });
    }
    addEventListener('resize', resize);
    resize();
    function draw() {
      ctx.clearRect(0, 0, w, h);
      for (const d of drops) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x, d.y + d.len);
        ctx.strokeStyle = d.color;
        ctx.lineWidth = 1;
        ctx.globalAlpha = d.opacity;
        ctx.stroke();
        d.y += d.speed;
        if (d.y > h) {
          d.y = -d.len;
          d.x = Math.random() * w;
        }
      }
      requestAnimationFrame(draw);
    }
    draw();
    /* ---------- PWA install ---------- */
    let deferredPrompt;
    const $install = $('#installBtn');
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      $install.style.display = 'flex';
    });
    $install.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Install:', outcome);
      deferredPrompt = null;
      $install.style.display = 'none';
    });
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS && !window.matchMedia('(display-mode: standalone)').matches) {
      if (+localStorage.iosPrompt||0 < 2) localStorage.iosPrompt = (+localStorage.iosPrompt||0)+1;
      if (+localStorage.iosPrompt === 2) {
        showCustomSnackbar('Tap Share âžœ "Add to Home Screen" to install Vynix Lingua');
      }
    }
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(() => console.log('SW registered'));
    }
  </script>
</body>
</html>
