<script type="module">
  // ─────── FIXED IMPORTS ───────
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getDatabase, ref, set, get, child, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
  import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
  
  lucide.createIcons();
  const { jsPDF } = window.jspdf;
  
  // ─────── FIREBASE INITIALIZATION ───────
  const app = initializeApp({
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  });
  const auth = getAuth(app);
  const db = getDatabase(app);
  
  // ─────── GLOBAL STATE ───────
  let userProfile = null;
  let xaiKey = null;
  let elevenlabsKey = null;
  let yocoPublicKey = null;
  let yocoEnabled = false;
  let history = [];
  let currentImage = null;
  let currentFile = null;
  let waitingForProfile = false;
  let dailyTokens = 15000;
  let isPremium = false;
  let conversations = [];
  let currentConvoId = null;
  
  // ─────── DOM ELEMENTS ───────
  const els = {
    chatPane: document.getElementById('chatPane'),
    chatInput: document.getElementById('chatInput'),
    sendBtn: document.getElementById('sendBtn'),
    uploadBtn: document.getElementById('uploadBtn'),
    hiddenFile: document.getElementById('hiddenFile'),
    filePreview: document.getElementById('filePreview'),
    docPreview: document.getElementById('docPreview'),
    tokenCount: document.getElementById('tokenCount'),
    upgradeSheet: document.getElementById('upgradeSheet'),
    mockUpgrade: document.getElementById('mockUpgrade'),
    upgradePill: document.getElementById('upgradePill'),
    papersSheet: document.getElementById('papersSheet'),
    papersContent: document.getElementById('papersContent'),
    sidebar: document.getElementById('convoSidebar'),
    overlay: document.getElementById('sidebarOverlay'),
    convoList: document.getElementById('conversationsList')
  };
  
  // ─────── UTILITY FUNCTIONS ───────
  function customAlert(msg, duration = 2500) {
    const box = document.getElementById('customAlert');
    if (!box) return;
    box.textContent = msg;
    box.classList.add('show');
    setTimeout(() => box.classList.remove('show'), duration);
  }
  
  function formatTime() { 
    return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); 
  }
  
  function estimateTokens(t) { 
    return Math.ceil((t?.length || 0) / 4) + 150; 
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // ─────── TOKEN MANAGEMENT ───────
  async function deductTokens(amount) {
    if (isPremium) return true;
    if (dailyTokens < amount) { 
      els.upgradeSheet.classList.add('active'); 
      return false; 
    }
    dailyTokens -= amount;
    els.tokenCount.textContent = dailyTokens.toLocaleString();
    await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { 
      daily: dailyTokens, 
      lastReset: Date.now() 
    });
    return true;
  }
  
  async function loadTokens() {
    try {
      const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
      const userData = userSnap.val();
      if (userData?.premium) {
        isPremium = true; 
        dailyTokens = 999999;
        document.querySelector('.token-bar').innerHTML = `<div class="flex items-center justify-center gap-3"><span>Unlimited access • Premium</span></div>`;
        els.tokenCount.textContent = 'Unlimited'; 
        return;
      }
      const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
      const data = snap.val(); 
      const now = Date.now(); 
      const oneDay = 24 * 60 * 60 * 1000;
      if (!data || (now - (data.lastReset || 0) > oneDay)) {
        dailyTokens = 15000; 
        await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
      } else {
        dailyTokens = data.daily || 15000;
      }
      els.tokenCount.textContent = dailyTokens.toLocaleString();
    } catch { 
      dailyTokens = 15000; 
      els.tokenCount.textContent = dailyTokens.toLocaleString(); 
    }
  }
  
  // ─────── PAYMENT SYSTEM ───────
  function loadYocoScript() {
    if (window.YocoSDK) return Promise.resolve();
    return new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
      s.onload = res; 
      s.onerror = rej;
      document.head.appendChild(s);
    });
  }
  
  async function startYocoPayment() {
    try {
      await loadYocoScript();
      const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
      const result = await yoco.showPopup({
        amountInCents: 7900,
        currency: 'ZAR',
        name: 'Vynix Buddy Unlimited',
        description: 'R79/month – Unlimited AI tutoring',
        metadata: { userId: auth.currentUser.uid },
        callbackUrl: location.href
      });
     
      if (result?.paymentResult?.status === 'successful') {
        await update(ref(db, `users/${auth.currentUser.uid}`), { 
          premium: true, 
          premiumSince: new Date().toISOString() 
        });
        isPremium = true; 
        await loadTokens(); 
        els.upgradeSheet.classList.remove('active');
        customAlert("Payment successful! You're now on Unlimited!");
      }
    } catch (e) { 
      customAlert("Payment cancelled or failed."); 
    }
  }
  
  els.mockUpgrade.onclick = () => yocoEnabled ? startYocoPayment() : customAlert("Upgrade coming soon!");
  els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');
  
  // ─────── EXAM PAPER GENERATION ───────
  async function generateExamPaper(subject, grade, topic) {
    const marks = 50;
    const prompt = `Generate a CAPS exam paper for ${subject} Grade ${grade} on the topic: "${topic}".
     
      REQUIREMENTS:
      - Exactly 5 TOUGH questions testing deep understanding
      - Total marks: ${marks} (10 marks per question)
      - Each question must have clear sub-parts (a), (b), (c) where relevant
      - Use proper mathematical notation (write formulas clearly)
      - Include diagrams or descriptions where needed
      - Provide detailed memorandum with FULL solutions
      - Separate question paper and memorandum with "---MEMO---"
      - Format clearly with spacing between questions
     
      FORMAT:
      COVER: Subject, Grade, Topic, Time, Marks
      INSTRUCTIONS
      QUESTION 1 (10 marks): [Tough question on ${topic}]
      QUESTION 2 (10 marks): [Tough question on ${topic}]
      QUESTION 3 (10 marks): [Tough question on ${topic}]
      QUESTION 4 (10 marks): [Tough question on ${topic}]
      QUESTION 5 (10 marks): [Tough question on ${topic}]
      ---MEMO---
      MEMORANDUM with detailed solutions for all 5 questions.`;
     
    addThinking();
    const cost = 2500;
    if (!(await deductTokens(cost))) { removeThinking(); return null; }
    
    try {
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({ 
          model: "grok-4-1-fast-non-reasoning", 
          messages: [{role:"user",content:prompt}], 
          max_tokens: 8000, 
          temperature: 0.7 
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || null;
    } catch (e) {
      console.error(e);
      return null;
    } finally {
      removeThinking();
    }
  }
  
  function showPastPapersSheet() {
    const grade = userProfile?.grade || "12";
    const name = userProfile?.name || "learner";
   
    els.papersContent.innerHTML = `
      <h3 class="text-xl font-bold mb-4">Generate CAPS Practice Paper</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Subject</label>
          <select id="subjectSelect" class="w-full border rounded-lg p-2 bg-white">
            <option value="Mathematics">Mathematics</option>
            <option value="Physical Sciences">Physical Sciences</option>
            <option value="Life Sciences">Life Sciences</option>
            <option value="Accounting">Accounting</option>
            <option value="Business Studies">Business Studies</option>
            <option value="Geography">Geography</option>
            <option value="History">History</option>
            <option value="English HL">English HL</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Topic (e.g., Calculus, Chemical Equilibrium)</label>
          <input type="text" id="topicInput" class="w-full border rounded-lg p-2" placeholder="Enter specific topic">
        </div>
        <button id="generatePaperBtn" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">Generate 5 Tough Questions + Memo</button>
      </div>`;
     
    els.papersSheet.classList.add('active');
   
    document.getElementById('generatePaperBtn').addEventListener('click', async () => {
      const subject = document.getElementById('subjectSelect').value;
      const topic = document.getElementById('topicInput').value.trim();
     
      if (!topic) { customAlert("Please enter a topic"); return; }
     
      els.papersSheet.classList.remove('active');
      const examText = await generateExamPaper(subject, grade, topic);
     
      if (!examText) { 
        customAlert("Failed to generate paper. Check your internet or tokens."); 
        return; 
      }
     
      // ... rest of PDF generation code (unchanged) ...
    });
  }
  
  // ─────── VISION MARKING ───────
  async function markStudentWork(studentImageUrl, subject, grade, questionContext) {
    const prompt = `You are a strict South African DBE examiner marking CAPS ${subject} Grade ${grade} work.
STUDENT WORK: Analyze the handwritten answer in the attached image.
QUESTION CONTEXT: ${questionContext}
MARKING TASK:
1. Mark the work according to SAGA (South African General Assessment) guidelines
2. Allocate marks out of 10 using official CAPS marking principles
3. Place virtual ticks (√) where marks are earned
4. Identify CAPS-specific errors SA learners commonly make
5. Provide examiner-style comments with mark deductions
OUTPUT FORMAT:
MARKS: X/10
EXAMINER COMMENTS:
- √ [1 mark] Correct formula identified
- ✗ [LOST] Did not convert to SI units (CAPS requirement)
- √ [2 marks] Substitution correct
- ✗ [LOST] Final answer not rounded to 2 decimal places
FEEDBACK: [Specific advice for improvement]
CAPS ALIGNMENT: [Reference to assessment standard]`;
     
    addThinking();
    const cost = 3000;
    if (!(await deductTokens(cost))) { removeThinking(); return null; }
    
    try {
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${xaiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "grok-2-vision-1212",
          messages: [{
            role: "user",
            content: [
              { type: "text", text: prompt },
              { type: "image_url", image_url: { url: studentImageUrl } }
            ]
          }],
          max_tokens: 4000,
          temperature: 0.3
        })
      });
     
      const data = await res.json();
      return data.choices?.[0]?.message?.content || "Could not mark this paper.";
    } catch (e) {
      console.error("Vision marking failed:", e);
      return "Marking error. Please ensure image is clear and well-lit.";
    } finally {
      removeThinking();
    }
  }
  
  // ─────── KEYBOARD & INPUT HANDLING ───────
  const viewport = window.visualViewport || window;
  function handleKeyboard() {
    const kh = window.innerHeight - (viewport.height || window.innerHeight);
    document.querySelector('.input-bar').style.transform = kh > 100 ? `translateY(-${kh}px)` : 'translateY(0)';
  }
  
  viewport.addEventListener('resize', handleKeyboard);
  viewport.addEventListener('scroll', handleKeyboard);
  
  els.chatInput.addEventListener('focus', () => setTimeout(handleKeyboard, 300));
  els.chatInput.addEventListener('input', () => {
    els.chatInput.style.height = 'auto';
    els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
    updateSendButton();
  });
  
  function updateSendButton() {
    const hasText = els.chatInput.value.trim().length > 0;
    const hasFile = currentImage !== null || currentFile !== null;
    els.sendBtn.disabled = !hasText && !hasFile;
  }
  
  // ─────── FILE UPLOAD ───────
  els.uploadBtn.onclick = () => els.hiddenFile.click();
  
  els.hiddenFile.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
   
    const isImage = file.type.startsWith('image/');
    if (isImage) {
      els.filePreview.src = URL.createObjectURL(file);
      els.filePreview.style.display = 'block';
      els.docPreview.style.display = 'none';
    } else {
      els.docPreview.style.display = 'flex';
      els.filePreview.style.display = 'none';
    }
   
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', 'banter_box');
    fd.append('resource_type', 'auto');
   
    try {
      customAlert("Uploading file...", 2000);
      const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/upload", {
        method: "POST",
        body: fd
      });
      const data = await res.json();
     
      if (data.secure_url) {
        currentImage = data.secure_url;
        currentFile = file;
        updateSendButton();
        customAlert("File uploaded successfully!");
      } else {
        throw new Error("Upload failed");
      }
    } catch (e) {
      console.error("Cloudinary upload error:", e);
      customAlert("Upload error. Check your connection.");
      hidePreview();
    }
  };
  
  function hidePreview() {
    els.filePreview.style.display = 'none';
    els.docPreview.style.display = 'none';
    currentImage = null;
    currentFile = null;
    updateSendButton();
  }
  
  // ─────── MESSAGE RENDERING ───────
  function addMessage(content, sender, plainText = '') {
    const div = document.createElement('div');
    div.className = `message ${sender}`;
    const isImage = content.includes('<img');
    const time = formatTime();
   
    if (sender === 'ai' && !isImage) {
      div.innerHTML = `
        <div class="content">${marked.parse(content)}</div>
        <div class="ai-actions">
          <button class="action-btn copy-btn" aria-label="Copy"><i data-lucide="copy"></i></button>
          <button class="action-btn voice-btn" aria-label="Listen"><i data-lucide="volume-2"></i></button>
          <button class="action-btn pdf-btn" aria-label="Download PDF"><i data-lucide="download"></i></button>
          <button class="action-btn papers-btn" aria-label="Past Papers"><i data-lucide="file-text" class="text-purple-700"></i></button>
          <button class="action-btn mark-btn" aria-label="Mark My Work"><i data-lucide="check-square" class="text-green-600"></i></button>
        </div>
        <div class="timestamp">${time}</div>`;
    } else {
      const userText = isImage ? content : content.replace(/\n/g, '<br>');
      div.innerHTML = `<div class="content">${userText}</div><div class="timestamp">${time}</div>`;
    }
   
    els.chatPane.appendChild(div);
    els.chatPane.scrollTop = els.chatPane.scrollHeight;
    lucide.createIcons({ attrs: { width: 18, height: 18 } });
   
    // Add action listeners
    if (sender === 'ai' && !isImage) {
      // Copy button
      div.querySelector('.copy-btn')?.addEventListener('click', async () => {
        const text = plainText || content;
        try {
          await navigator.clipboard.writeText(text);
          const i = div.querySelector('.copy-btn i');
          i.setAttribute('data-lucide', 'check'); 
          lucide.createIcons();
          setTimeout(() => { 
            i.setAttribute('data-lucide', 'copy'); 
            lucide.createIcons(); 
          }, 2000);
        } catch (e) {
          customAlert('Copy failed. Please copy manually.');
        }
      });
     
      // Voice button
      div.querySelector('.voice-btn')?.addEventListener('click', async () => {
        const text = plainText || content;
        if (!text) return;
        const btn = div.querySelector('.voice-btn');
        const icon = btn.querySelector('i');
        const originalIcon = 'volume-2';
       
        icon.setAttribute('data-lucide', 'loader-2');
        lucide.createIcons();
        btn.disabled = true;
       
        try {
          if (!elevenlabsKey) throw new Error('Voice not configured');
          const voiceId = 'pNInz6obpgDQGcFmaJgB';
         
          const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': elevenlabsKey
            },
            body: JSON.stringify({
              text: text,
              model_id: 'eleven_monolingual_v1',
              voice_settings: { stability: 0.5, similarity_boost: 0.5 }
            })
          });
         
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
         
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
         
          audio.onended = () => {
            URL.revokeObjectURL(audioUrl);
            icon.setAttribute('data-lucide', originalIcon);
            lucide.createIcons();
            btn.disabled = false;
          };
         
          audio.onerror = () => {
            URL.revokeObjectURL(audioUrl);
            icon.setAttribute('data-lucide', originalIcon);
            lucide.createIcons();
            btn.disabled = false;
            customAlert('Playback failed');
          };
         
          await audio.play();
        } catch (err) {
          console.error(err);
          customAlert('Voice temporarily unavailable');
          icon.setAttribute('data-lucide', originalIcon);
          lucide.createIcons();
          btn.disabled = false;
        }
      });
     
      // PDF button
      div.querySelector('.pdf-btn')?.addEventListener('click', () => {
        const doc = new jsPDF();
        doc.setFontSize(16); 
        doc.text("Vynix Buddy Answer", 20, 20);
        doc.setFontSize(11); 
        doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
        doc.save(`Vynix_Answer_${new Date().toISOString().slice(0,10)}.pdf`);
      });
     
      // Past papers button
      div.querySelector('.papers-btn')?.addEventListener('click', showPastPapersSheet);
     
      // Mark button
      div.querySelector('.mark-btn')?.addEventListener('click', async () => {
        if (!currentImage) {
          customAlert("Upload your answer sheet first!");
          return;
        }
       
        const subject = userProfile?.favoriteSubject || "Mathematics";
        const grade = userProfile?.grade || "12";
        const markingResult = await markStudentWork(currentImage, subject, grade, plainText);
        if (markingResult) {
          addMessage(markingResult, 'ai', markingResult);
        }
      });
    }
  }
  
  function addThinking() {
    const d = document.createElement('div');
    d.id = 'thinking';
    d.className = 'message ai';
    d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
    els.chatPane.appendChild(d);
    els.chatPane.scrollTop = els.chatPane.scrollHeight;
  }
  
  function removeThinking() { 
    document.getElementById('thinking')?.remove(); 
  }
  
  // ─────── MAIN SEND FUNCTION ───────
  async function send() {
    if (waitingForProfile) return;
    let text = els.chatInput.value.trim();
    if (!text && !currentImage) return;

    const cost = currentImage ? 1500 : estimateTokens(text);
    if (!(await deductTokens(cost))) {
      addMessage("You've run out of tokens today! Upgrade to unlimited for just R79/month.", 'ai');
      return;
    }

    if (currentImage) {
      addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="User upload">`, 'user');
      history.push({ role: "user", content: `[Image: ${currentImage}]` });
      if (!text) text = "Explain what's in this image";
    } else {
      addMessage(text, 'user');
      history.push({ role: "user", content: text });
    }

    await saveMessage(text); // Save user message

    els.chatInput.value = '';
    hidePreview();
    els.chatInput.style.height = 'auto';
    addThinking();

    const reply = await getReply(text);
    removeThinking();
    addMessage(reply, 'ai', reply);
    history.push({ role: "assistant", content: reply });

    await saveMessage(text, reply); // Save AI reply
  }
  
  // ─────── AI RESPONSE ───────
  async function getReply(msg) {
    if (!xaiKey) return "Connecting to Grok...";
    const roleText = userProfile ? `${userProfile.role} (Grade ${userProfile.grade})` : "learner";
    const systemPrompt = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. You are helping ${userProfile?.name || "a student"} who is a ${roleText}. Always use their name naturally. Be encouraging and explain step-by-step.`;
    try {
      const res = await fetch("https://api.x.ai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "grok-4-1-fast-non-reasoning",
          messages: [{ role: "system", content: systemPrompt }, ...history.slice(-15), { role: "user", content: msg }],
          temperature: 0.7
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || "I'm thinking...";
    } catch (e) {
      console.error(e);
      return "No internet connection. Please check your network.";
    }
  }
  
  // ─────── PROFILE SETUP ───────
  async function checkAndAskProfile() {
    const authUser = auth.currentUser;
    const authName = authUser?.displayName?.trim();
    const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/profile`));
    const dbProfile = snap.val();
    
    userProfile = dbProfile || {};
    if (!userProfile.name && authName) {
      userProfile.name = authName;
      await set(ref(db, `users/${auth.currentUser.uid}/profile/name`), authName);
    }

    if (!userProfile.name || !userProfile.grade || !userProfile.role) {
      waitingForProfile = true;
      addMessage("Sawubona! I'm Vynix Buddy, your personal CAPS tutor.\n\nMay I know your name?", 'ai');
    } else {
      addMessage(`Welcome back, ${userProfile.name}! Ready for Grade ${userProfile.grade} today?`, 'ai');
      waitingForProfile = false;
    }
    updateProfileDisplay();
  }
  
  els.chatInput.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!waitingForProfile) return send();
      const text = els.chatInput.value.trim();
      if (!text) return;
      els.chatInput.value = '';
      if (!userProfile?.name) {
        userProfile = { name: text };
        addMessage(`Nice to meet you, ${text}! Which grade are you in?`, 'ai');
      } else if (!userProfile?.grade) {
        userProfile.grade = text;
        addMessage(`Got it! Grade ${text}. Are you a **student**, **teacher**, or **parent**?`, 'ai');
      } else if (!userProfile?.role) {
        userProfile.role = text.toLowerCase();
        await set(ref(db, `users/${auth.currentUser.uid}/profile`), userProfile);
        waitingForProfile = false;
        addMessage(`Perfect, ${userProfile.name}! I'm now your personal CAPS tutor. Ask me anything!`, 'ai');
      }
    }
  });
  
  async function init() {
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    xaiKey = getString(rc, 'xai_api_key')?.trim();
    elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
    yocoPublicKey = getString(rc, 'yoco_public_key')?.trim();
    yocoEnabled = getBoolean(rc, 'yoco_enabled');
  }
  
  // ─────── PROFILE DROPDOWN ───────
  const profileBtn = document.getElementById('profileBtn');
  const profileDropdown = document.getElementById('profileDropdown');
  
  function updateProfileDisplay() {
    if (!userProfile?.name) {
      document.getElementById('userInitial').textContent = '?';
      document.getElementById('userName').textContent = 'Student';
      document.getElementById('userGrade').textContent = '—';
      document.getElementById('dropdownName').textContent = 'Student';
      document.getElementById('dropdownGrade').textContent = '—';
      return;
    }
    const name = userProfile.name.trim();
    const initial = name.charAt(0).toUpperCase();
    const grade = userProfile.grade ? `Grade ${userProfile.grade}` : 'Not set';

    document.getElementById('userInitial').textContent = initial;
    document.getElementById('userName').textContent = name;
    document.getElementById('userGrade').textContent = grade;
    document.getElementById('dropdownName').textContent = name;
    document.getElementById('dropdownGrade').textContent = grade;
  }
  
  profileBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    profileDropdown.classList.toggle('show');
  });
  
  document.addEventListener('click', (e) => {
    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
      profileDropdown.classList.remove('show');
    }
  });
  
  document.getElementById('signOutBtn')?.addEventListener('click', async () => {
    if (confirm('Sign out of Vynix Buddy?')) {
      await auth.signOut();
      customAlert('Signed out');
      setTimeout(() => location.href = 'login.html', 800);
    }
  });
  
  // ─────── CONVERSATIONS SIDEBAR ───────
  function loadConversations() {
    if (!auth.currentUser) return;
    const convosRef = ref(db, `users/${auth.currentUser.uid}/conversations`);
    onValue(convosRef, (snapshot) => {
      const data = snapshot.val();
      conversations = data ? Object.keys(data).map(key => ({
        id: key,
        ...data[key],
        time: new Date(data[key].lastMessageAt || data[key].createdAt).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' })
      })).sort((a, b) => (b.lastMessageAt || b.createdAt) - (a.lastMessageAt || a.createdAt)) : [];
      renderConversations();
    });
  }
  
  function renderConversations() {
    if (conversations.length === 0) {
      els.convoList.innerHTML = `<div class="p-8 text-center text-gray-500">No chats yet. Start a new one!</div>`;
      return;
    }

    els.convoList.innerHTML = conversations.map(c => `
      <div class="convo-item ${c.id === currentConvoId ? 'active' : ''}" data-id="${c.id}">
        <i data-lucide="message-square" class="w-5 h-5 text-purple-500"></i>
        <div class="title">${escapeHtml(c.title || 'New Chat')}</div>
        <div class="timestamp">${c.time}</div>
        <button class="delete-btn">
          <i data-lucide="trash-2" class="w-5 h-5"></i>
        </button>
      </div>
    `).join('');

    lucide.createIcons();

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = async (e) => {
        e.stopPropagation();
        const item = btn.closest('.convo-item');
        const id = item.dataset.id;
        if (confirm('Delete this chat permanently?')) {
          await remove(ref(db, `users/${auth.currentUser.uid}/conversations/${id}`));
          if (currentConvoId === id) {
            currentConvoId = null;
            startNewChat();
          }
        }
      };
    });

    document.querySelectorAll('.convo-item').forEach(item => {
      item.onclick = async (e) => {
        if (e.target.closest('.delete-btn')) return;
        const id = item.dataset.id;
        currentConvoId = id;
        await loadConversationHistory(id);
        document.querySelectorAll('.convo-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        closeSidebar();
      };
    });
  }
  
  async function startNewChat() {
    els.chatPane.innerHTML = `<div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>`;
    history = [];
    currentConvoId = null;
    customAlert("New chat started!");
  }
  
  async function loadConversationHistory(convoId) {
    const snap = await get(ref(db, `users/${auth.currentUser.uid}/conversations/${convoId}/messages`));
    const messages = snap.val();
    els.chatPane.innerHTML = `<div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Loading your chat...</p>
    </div>`;

    if (!messages) {
      history = [];
      return;
    }

    history = Object.values(messages);
    els.chatPane.innerHTML = '';
    history.forEach(msg => {
      const isUser = msg.role === 'user';
      const content = isUser ? msg.content : marked.parse(msg.content);
      addMessage(content, isUser ? 'user' : 'ai', isUser ? '' : msg.content);
    });
  }
  
  async function saveMessage(userMsg, aiReply = null) {
    if (!auth.currentUser) return;

    let convoRef;
    if (!currentConvoId) {
      convoRef = push(ref(db, `users/${auth.currentUser.uid}/conversations`));
      currentConvoId = convoRef.key;
      await set(convoRef, {
        title: userMsg.slice(0, 40) + (userMsg.length > 40 ? '...' : ''),
        createdAt: Date.now(),
        lastMessageAt: Date.now()
      });
    } else {
      convoRef = ref(db, `users/${auth.currentUser.uid}/conversations/${currentConvoId}`);
      await update(convoRef, { lastMessageAt: Date.now() }); // FIXED: use update()
    }

    const messagesRef = child(convoRef, 'messages');
    await push(messagesRef, { role: 'user', content: userMsg, timestamp: Date.now() });
    if (aiReply) {
      await push(messagesRef, { role: 'assistant', content: aiReply, timestamp: Date.now() });
    }
  }
  
  // ─────── SIDEBAR CONTROLS ───────
  function openSidebar() {
    els.sidebar.classList.add('translate-x-0');
    els.overlay.classList.remove('hidden');
    setTimeout(() => els.overlay.classList.add('active'), 10);
  }
  
  function closeSidebar() {
    els.sidebar.classList.remove('translate-x-0');
    els.overlay.classList.remove('active');
    setTimeout(() => els.overlay.classList.add('hidden'), 300);
  }
  
  document.getElementById('openSidebarMobile').onclick = openSidebar;
  document.getElementById('closeSidebar').onclick = closeSidebar;
  document.getElementById('sidebarOverlay').onclick = closeSidebar;
  document.getElementById('desktopSidebarToggle').onclick = () => els.sidebar.classList.toggle('translate-x-0');
  document.getElementById('newChatBtn').onclick = () => {
    startNewChat();
    closeSidebar();
  };
  
  // ─────── INITIALIZATION ───────
  els.sendBtn.onclick = send;
  
  // ❌ REMOVED duplicate onAuthStateChanged
  
  // ✅ SINGLE AUTH LISTENER
  onAuthStateChanged(auth, async (user) => {
    if (!user) { 
      location.href = "login.html"; 
      return; 
    }
    await init();
    await loadTokens();
    await checkAndAskProfile();
    loadConversations(); // Start loading conversations
  });
</script>
