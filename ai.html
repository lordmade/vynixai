<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>StudyBuddy – Your AI Tutor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #0d1117; color: #e6edf3; margin: 0; height: 100vh; display: flex; flex-direction: column; }
    
    /* Grok-style dark input bar */
    .input-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      background: #0d1117;
      border-top: 1px solid #30363d;
      z-index: 50;
    }
    .input-container {
      max-width: 800px;
      margin: 0 auto;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 1.5rem;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: flex-end;
      gap: 0.75rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.2s;
    }
    .input-container:focus-within {
      border-color: #58a6ff;
      box-shadow: 0 0 0 1px #58a6ff;
    }
    #chatInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #e6edf3;
      font-size: 1rem;
      resize: none;
      max-height: 200px;
      line-height: 1.5;
    }
    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #238636;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .send-btn:hover { background: #2ea043; }
    .send-btn:disabled { background: #30363d; cursor: not-allowed; }

    /* Upload button */
    .upload-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #30363d;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* Messages */
    .chat-area { flex: 1; overflow-y: auto; padding: 1rem 1rem 6rem; max-width: 800px; margin: 0 auto; width: 100%; }
    .message { margin: 1rem 0; }
    .message.ai .content {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      max-width: 100%;
      position: relative;
    }
    .message.user .content {
      background: #238636;
      color: white;
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      margin-left: auto;
      max-width: 80%;
    }

    /* Always visible icons (Grok style) */
    .msg-icons {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      opacity: 0.7;
    }
    .msg-icon {
      width: 32px;
      height: 32px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
    }
    .msg-icon:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    /* Thinking dots */
    .thinking {
      display: flex;
      gap: 6px;
      padding: 1rem;
    }
    .thinking span {
      width: 8px;
      height: 8px;
      background: #8b949e;
      border-radius: 50%;
      animation: pulse 1.4s infinite;
    }
    .thinking span:nth-child(2) { animation-delay: 0.2s; }
    .thinking span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>

  <section id="chatPane" class="chat-area">
    <div class="text-center text-gray-400 mt-20">
      <h1 class="text-3xl font-bold mb-2">Hey! I'm StudyBuddy</h1>
      <p>Ask anything · Upload homework · Get clear explanations</p>
    </div>
  </section>

  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn">
        <svg width="20" height="20" fill="none" stroke="#8b949e" viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
      </button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Message StudyBuddy..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" disabled>
        <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
          <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a887says.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);
    let userId = null;
    let xaiKey = null;
    let history = [];
    let currentImage = null;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile')
    };

    // Auto-resize textarea
    els.chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
      els.sendBtn.disabled = !this.value.trim() && !currentImage;
    });

    // Upload
    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async () => {
      const file = els.hiddenFile.files[0];
      if (!file) return;
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', 'studybuddy');
      const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: form });
      const data = await res.json();
      if (data.secure_url) {
        currentImage = data.secure_url;
        els.sendBtn.disabled = false;
      }
    };

    // Send message
    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;

      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full">`, 'user');
        history.push({ role: "user", content: currentImage });
        text = "Explain this homework";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.chatInput.value = ''; currentImage = null;
      els.sendBtn.disabled = true;
      els.chatInput.style.height = 'auto';

      addThinking();
      const reply = await getReply(text);
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      div.innerHTML = `
        <div class="content">
          ${isImage ? content : marked.parse(content)}
          ${sender === 'ai' && !isImage ? `
            <div class="msg-icons">
              <button class="msg-icon" onclick="navigator.clipboard.writeText(${JSON.stringify(plainText || content)})">
                Copy
              </button>
              <button class="msg-icon" onclick="new SpeechSynthesisUtterance(${JSON.stringify(plainText || content)}).speak()">
                Speaker
              </button>
            </div>
          ` : ''}
        </div>
      `;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }

    function addThinking() {
      const div = document.createElement('div');
      div.id = 'thinking';
      div.className = 'message ai';
      div.innerHTML = `<div class="content"><div class="thinking"><span></span><span></span><span></span></div></div>`;
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    async function getReply(msg) {
      if (!xaiKey) return "API key not loaded yet...";
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${xaiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "grok-2-latest",
            messages: [
              { role: "system", content: "You are StudyBuddy, a kind, clear AI tutor for South African students. Be encouraging and explain step-by-step." },
              ...history.slice(-10),
              { role: "user", content: msg }
            ],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "No response";
      } catch (e) {
        return "Sorry, I can't connect right now.";
      }
    }

    // Init
    async function init() {
      const rc = getRemoteConfig(app);
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key').trim();
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        userId = user.uid;
        init();
      } else {
        location.href = "login.html";
      }
    });

    els.sendBtn.onclick = send;
    els.chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
