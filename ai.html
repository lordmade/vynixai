<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Lingua ‚Äì Feed + Chat</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Space+Grotesk:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <style>
    :root{
      --bg-color:#ffffff;
      --surface-color:#f3f6fc;
      --text-primary:#1e1e1e;
      --text-secondary:#444746;
      --text-muted:#9aa0a6;
      --accent-blue:#2563eb;
      --accent-purple:#d946ef;
      --accent-green:#10b981;
      --logo-gradient:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 50%,var(--accent-green) 100%);
      --radius-lg:32px;
      --radius-md:24px;
      --radius-sm:16px;
      --shadow-soft:0 8px 32px rgba(0,0,0,.06);
      --font-main:'Outfit',sans-serif;
      --font-head:'Space Grotesk',sans-serif;
      --font-mono:'Roboto Mono',monospace;
    }
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:var(--font-main);background:transparent;color:var(--text-primary);
         height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none;
         -webkit-font-smoothing:antialiased}

    /* ---------- Header + view switcher ------------------ */
    .header{height:64px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;
            background:rgba(255,255,255,.85);backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,0,0,.05);z-index:10}
    .vynix-logo{display:flex;align-items:center;gap:8px;cursor:pointer}
    .logo-icon{font-size:26px;background:var(--logo-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logo-text{font-family:var(--font-head);font-size:22px;font-weight:700;letter-spacing:-.5px}
    .lingua-badge{background:var(--logo-gradient);color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px}
    .profile-btn{width:40px;height:40px;border-radius:50%;border:none;background:var(--surface-color);color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center}
    .profile-btn span{font-size:24px}

    .view-switcher{display:flex;padding:0 20px;height:48px;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,0,0,.05);position:sticky;top:64px;z-index:9}
    .view-tab{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;border:none;background:transparent;font-family:var(--font-main);font-size:14px;font-weight:500;color:var(--text-secondary);cursor:pointer;position:relative;transition:color .2s}
    .view-tab.active{color:var(--accent-blue)}.view-tab.active::after{content:"";position:absolute;bottom:0;left:25%;right:25%;height:3px;background:var(--accent-blue);border-radius:2px}
    .view-tab .material-symbols-rounded{font-size:20px}

    /* ---------- Chat ------------------------------------ */
    .chat-container{flex:1;overflow-y:auto;padding:20px 0 180px;scroll-behavior:smooth}
    #messagesList{max-width:800px;margin:0 auto;width:100%;padding:0 20px}
    .message-row{display:flex;margin-bottom:20px;max-width:70%}
    .message-row.user{margin-left:auto;text-align:right;flex-direction:column;align-items:flex-end}
    .message-row.ai{margin-right:auto;padding-left:50px;flex-direction:column;align-items:flex-start}
    .message-content{padding:14px 18px;border-radius:20px;line-height:1.6;text-align:left;font-size:15px;white-space:pre-wrap;overflow-wrap:break-word;word-wrap:break-word;max-width:100%;display:inline-block}
    .message-row.user .message-content{background:var(--logo-gradient);color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 5px rgba(37,99,235,.2)}
    .message-row.ai  .message-content{background:rgba(255,255,255,.95);border-top-left-radius:4px;box-shadow:var(--shadow-soft)}
    .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:absolute}
    .message-row.ai .avatar{background:var(--logo-gradient);color:#fff;font-size:22px;left:0;top:-10px}
    .timestamp{font-size:10px;color:var(--text-muted);position:absolute;bottom:-15px}
    .thinking{display:flex;gap:5px;padding:10px 0}.dot{width:5px;height:5px;background:#9aa0a6;border-radius:50%;animation:pulse 1s infinite alternate}.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}

    /* ---------- Feed ------------------------------------ */
    .feed-container{flex:1;overflow-y:auto;padding:20px 0 180px;display:none}
    .feed-scroll{display:flex;flex-direction:column;gap:20px;max-width:680px;margin:0 auto;padding:0 20px}
    .post-card{background:rgba(255,255,255,.95);backdrop-filter:blur(8px);border-radius:var(--radius-md);padding:16px;box-shadow:var(--shadow-soft);border:1px solid rgba(0,0,0,.06);animation:fadeIn .4s ease}
    .post-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .post-avatar{width:40px;height:40px;border-radius:50%;background:var(--logo-gradient);display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px}
    .post-meta{flex:1}.post-name{font-weight:600;font-size:14px}.post-time{font-size:11px;color:var(--text-muted)}
    .post-content{font-size:15px;line-height:1.5;margin-bottom:12px;white-space:pre-wrap}
    .post-image{width:100%;border-radius:12px;margin-top:8px}
    .post-actions{display:flex;gap:12px;font-size:13px}
    .post-actions button{background:none;border:none;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:8px;transition:background .2s}
    .post-actions button:hover{background:var(--surface-color)}
    .post-actions .material-symbols-rounded{font-size:18px}

    /* ---------- Input bar (centered desktop) ------------ */
    .input-wrapper-fixed{position:fixed;left:0;right:0;bottom:0;z-index:30;background:var(--bg-color);
                         padding:12px max(20px,env(safe-area-inset-left)) max(20px,env(safe-area-inset-bottom)) max(20px,env(safe-area-inset-right));
                         box-shadow:0 -2px 10px rgba(0,0,0,.04);display:flex;flex-direction:column;align-items:center}
    @media (min-width:768px){
      .input-wrapper-fixed{left:50%;transform:translateX(-50%);width:90%;max-width:800px;border-radius:24px;margin-bottom:20px;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);box-shadow:0 -4px 20px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.08)}
    }
    .token-counter{position:absolute;top:-40px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.98);backdrop-filter:blur(8px);padding:6px 16px;border-radius:20px;font-size:12px;font-weight:500;color:var(--text-secondary);box-shadow:0 4px 12px rgba(0,0,0,.12);border:1px solid rgba(0,0,0,.06);z-index:31;white-space:nowrap;transition:all .2s ease;pointer-events:none}
    .token-counter.warning{background:rgba(255,193,7,.95);color:#333}.token-counter.danger{background:rgba(220,38,38,.95);color:#fff}
    .token-count{font-weight:700;color:var(--accent-blue)}
    .token-counter.warning .token-count{color:#d97706}.token-counter.danger .token-count{color:#fff}

    /* chat controls */
    .input-wrapper{width:100%;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);border-radius:28px;padding:6px;display:flex;align-items:center;transition:background .2s,box-shadow .2s;border:1px solid rgba(0,0,0,.06)}
    input{flex:1;border:none;background:none;outline:none;font-size:16px;font-family:var(--font-main);color:var(--text-primary);padding:12px 14px;user-select:text}
    .mic-btn,.send-btn,.translate-btn{width:44px;height:44px;border-radius:50%;border:none;background:transparent;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .mic-btn.listening{color:#dc2626;background:rgba(220,38,38,.1);animation:pulse-red 1.5s infinite}
    .send-btn.active{background:#1e1e1e;color:#fff}.translate-btn.active{background:var(--accent-green);color:#fff}
    .send-btn span,.translate-btn span{font-size:22px}

    /* feed composer */
    #feedInputWrapper{display:flex;align-items:flex-start;background:transparent;border-radius:20px;padding:6px;width:100%}
    #feedPost{flex:1;border:none;background:transparent;resize:none;max-height:120px;font-size:16px;font-family:var(--font-main);color:var(--text-primary);padding:12px 14px;line-height:1.4}
    .post-btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--accent-green);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s}
    .post-btn:active{transform:scale(.95)}
    #feedDisclaimer{font-size:11px;color:var(--text-muted);margin-top:8px;text-align:center;opacity:.8}

    /* image upload strip */
    .upload-strip{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .upload-btn{background:var(--surface-color);border:none;border-radius:12px;padding:6px 10px;font-size:12px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:4px}
    .upload-btn:hover{background:#e0e0e0}
    .preview-img{height:64px;border-radius:8px;margin-right:4px}
    .progress-bar{height:4px;background:rgba(0,0,0,.1);border-radius:2px;overflow:hidden;margin-top:4px}
    .progress-fill{height:100%;background:var(--accent-green);width:0%;transition:width .3s}

    /* snackbar */
    #customSnackbar{visibility:hidden;min-width:250px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:12px;position:fixed;z-index:1000;left:50%;bottom:100px;transform:translateX(-50%);box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;transition:opacity .3s,bottom .3s;font-size:14px;font-weight:500}#customSnackbar.show{visibility:visible;opacity:1;bottom:80px}

    /* scrollbar */
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:rgba(0,0,0,.15);border-radius:3px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse-red{0%{box-shadow:0 0 0 0 rgba(220,38,38,.4)}70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}
    @keyframes pulse{to{opacity:.3;transform:translateY(-2px)}}
  </style>
</head>

<body>
  <canvas id="rainCanvas"></canvas>
  <div id="customSnackbar"></div>

  <!-- ===== HEADER ===== -->
  <header class="header">
    <div class="vynix-logo" onclick="location.reload()">
      <span class="material-symbols-rounded logo-icon">auto_awesome</span>
      <span class="logo-text">Vynix</span>
      <span class="lingua-badge">Lingua</span>
    </div>
    <button class="profile-btn" id="profileBtn"><span class="material-symbols-rounded">person</span></button>
  </header>

  <!-- ===== VIEW SWITCHER ===== -->
  <nav class="view-switcher">
    <button class="view-tab active" id="chatTab" onclick="switchView('chat')">
      <span class="material-symbols-rounded">forum</span>Chat
    </button>
    <button class="view-tab" id="feedTab" onclick="switchView('feed')">
      <span class="material-symbols-rounded">newspaper</span>Feed
    </button>
  </nav>

  <!-- ===== CHAT ===== -->
  <main class="chat-container" id="chatContainer">
    <div id="messagesList"></div>
  </main>

  <!-- ===== FEED ===== -->
  <main class="feed-container" id="feedContainer">
    <div class="feed-scroll" id="feedScroll"></div>
  </main>

  <!-- ===== INPUT BAR ===== -->
  <div class="input-wrapper-fixed">
    <!-- token counter (chat only) -->
    <div class="token-counter" id="tokenCounter">
      <span class="token-count" id="tokenCount">0</span> / <span class="token-limit">10,000</span> tokens
    </div>

    <!-- CHAT INPUT -->
    <div class="input-wrapper" id="chatInputWrapper">
      <button class="mic-btn" id="micBtn"><span class="material-symbols-rounded">mic</span></button>
      <input type="text" id="input" placeholder="Message Vynix Lingua..." autocomplete="off">
      <button class="translate-btn" id="translateBtn" title="Auto-translate"><span class="material-symbols-rounded">g_translate</span></button>
      <button class="send-btn" id="sendBtn"><span class="material-symbols-rounded">arrow_upward</span></button>
    </div>
    <p class="disclaimer" id="chatDisclaimer">Vynix Lingua speaks 11 African languages. Responses may vary.</p>

    <!-- FEED COMPOSER -->
    <div class="input-wrapper" id="feedInputWrapper" style="display:none">
      <div class="upload-strip" id="uploadStrip">
        <button class="upload-btn" id="imageBtn"><span class="material-symbols-rounded">add_photo_alternate</span>Photo</button>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <div id="previewStrip"></div>
      </div>
      <textarea id="feedPost" maxlength="500" placeholder="Share something with the community‚Ä¶"></textarea>
      <button class="post-btn" id="postBtn"><span class="material-symbols-rounded">send</span></button>
    </div>
    <p class="disclaimer" id="feedDisclaimer" style="display:none">Press ‚èé to post. Respectful, multilingual posts welcome.</p>
  </div>

  <!-- ===== CLOUDINARY + FIREBASE CODE ===== -->
  <script type="module">
    /* --------------- CONFIG (your keys) --------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const DAILY_TOKEN_LIMIT = 10000;
    const CLOUDINARY_URL  = 'https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/image/upload';   // ‚Üê change
    const CLOUDINARY_PRESET = 'YOUR_UNSIGNED_PRESET';                                         // ‚Üê change

    /* --------------- IMPORTS --------------- */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getRemoteConfig, fetchAndActivate, getString } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, addDoc, onSnapshot, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    /* --------------- INIT --------------- */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const rc   = getRemoteConfig(app);
    await fetchAndActivate(rc);
    const XAI_KEY = getString(rc, 'xai_api_key') || "YOUR_XAI_KEY_HERE";

    /* --------------- GLOBALS --------------- */
    const $ = s => document.querySelector(s);
    const LANGUAGES = { en:{name:'English',native:'English',flag:'üá¨üáß',code:'en-US',greeting:'Hello'}, zu:{name:'Zulu',native:'isiZulu',flag:'üáøüá¶',code:'zu-ZA',greeting:'Sawubona'}, xh:{name:'Xhosa',native:'isiXhosa',flag:'üáøüá¶',code:'xh-ZA',greeting:'Molo'}, af:{name:'Afrikaans',native:'Afrikaans',flag:'üáøüá¶',code:'af-ZA',greeting:'Hallo'}, st:{name:'Sotho',native:'Sesotho',flag:'üáøüá¶',code:'st-ZA',greeting:'Lumela'}, tn:{name:'Tswana',native:'Setswana',flag:'üáßüáº',code:'tn-ZA',greeting:'Dumela'}, sw:{name:'Swahili',native:'Kiswahili',flag:'üá∞üá™',code:'sw-KE',greeting:'Jambo'}, yo:{name:'Yoruba',native:'Yor√πb√°',flag:'üá≥üá¨',code:'yo-NG',greeting:'Bawo'}, ig:{name:'Igbo',native:'As·ª•s·ª• Igbo',flag:'üá≥üá¨',code:'ig-NG',greeting:'Ndewo'}, ha:{name:'Hausa',native:'Hausa',flag:'üá≥üá¨',code:'ha-NG',greeting:'Sannu'}, am:{name:'Amharic',native:'·ä†·àõ·à≠·äõ',flag:'üá™üáπ',code:'am-ET',greeting:'·à∞·àã·àù'} };
    let currentLang = 'en'; let autoTranslate = false; let historyStack = [];

    /* --------------- DOM NODES --------------- */
    const chatContainer = $('#chatContainer');
    const feedContainer = $('#feedContainer');
    const chatTab       = $('#chatTab');
    const feedTab       = $('#feedTab');
    const feedScroll    = $('#feedScroll');
    const tokenCounter  = $('#tokenCounter');
    const tokenCount    = $('#tokenCount');
    const chatWrap      = $('#chatInputWrapper');
    const feedWrap      = $('#feedInputWrapper');
    const chatDisc      = $('#chatDisclaimer');
    const feedDisc      = $('#feedDisclaimer');
    const fileInput     = $('#fileInput');
    const previewStrip  = $('#previewStrip');

    /* --------------- VIEW SWITCH --------------- */
    window.switchView = v => {
      if(v==='chat'){
        chatContainer.style.display='flex'; feedContainer.style.display='none';
        chatTab.classList.add('active'); feedTab.classList.remove('active');
        chatWrap.style.display='flex'; chatDisc.style.display='block';
        feedWrap.style.display='none'; feedDisc.style.display='none';
        tokenCounter.style.display='block';
      }else{
        chatContainer.style.display='none'; feedContainer.style.display='block';
        feedTab.classList.add('active'); chatTab.classList.remove('active');
        chatWrap.style.display='none'; chatDisc.style.display='none';
        feedWrap.style.display='flex'; feedDisc.style.display='block';
        tokenCounter.style.display='none';
        loadFeed();
      }
    };

    /* --------------- REAL-TIME FEED --------------- */
    function loadFeed(){
      const q = query(collection(db,'publicPosts'), orderBy('timestamp','desc'), limit(50));
      onSnapshot(q,snap=>{
        feedScroll.innerHTML='';
        snap.forEach(d=>{
          const p=d.data();
          feedScroll.insertAdjacentHTML('afterbegin',postCard(p,d.id));
        });
      });
    }
    function postCard(p,id){
      const img=p.image?`<img class="post-image" src="${p.image}" alt=""/>`:'';
      return `
      <div class="post-card" data-id="${id}">
        <div class="post-header">
          <div class="post-avatar"><span class="material-symbols-rounded">person</span></div>
          <div class="post-meta">
            <div class="post-name">${escapeHTML(p.name)}</div>
            <div class="post-time">${timeAgo(p.timestamp?.toDate())}</div>
          </div>
        </div>
        <div class="post-content">${escapeHTML(p.content)}</div>
        ${img}
        <div class="post-actions">
          <button onclick="likePost('${id}')"><span class="material-symbols-rounded">thumb_up</span>Like</button>
          <button><span class="material-symbols-rounded">comment</span>Comment</button>
          <button><span class="material-symbols-rounded">share</span>Share</button>
        </div>
      </div>`;
    }
    function escapeHTML(str){return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function timeAgo(d){if(!d)return'';const s=Math.floor((Date.now()-d)/1000);return s<60?s+'s':s<3600?Math.floor(s/60)+'m':s<86400?Math.floor(s/3600)+'h':Math.floor(s/86400)+'d';}
    async function likePost(id){/* stub */}

    /* --------------- FEED POST + CLOUDINARY --------------- */
    let currentFile=null;
    $('#postBtn').addEventListener('click',submitPost);
    $('#feedPost').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();submitPost();}});
    $('#imageBtn').addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',e=>handleFile(e.target.files[0]));

    async function submitPost(){
      const text=$('#feedPost').value.trim();
      if(!text&&!currentFile)return;
      if(!auth.currentUser){showCustomSnackbar('Please log in'); return;}
      $('#postBtn').disabled=true;
      let url='';
      if(currentFile){
        url=await uploadToCloudinary(currentFile);
        if(!url){$('#postBtn').disabled=false; return;}
      }
      try{
        await addDoc(collection(db,'publicPosts'),{
          uid:auth.currentUser.uid,
          name:auth.currentUser.displayName||'Anonymous',
          content:text,
          image:url,
          lang:currentLang,
          timestamp:serverTimestamp()
        });
        $('#feedPost').value=''; currentFile=null; previewStrip.innerHTML='';
        showCustomSnackbar('Posted!');
      }catch(e){showCustomSnackbar('Post failed');}
      $('#postBtn').disabled=false;
    }
    function handleFile(file){
      if(!file||!file.type.startsWith('image/'))return;
      currentFile=file;
      const reader=new FileReader();
      reader.onload=e=>{
        previewStrip.innerHTML=`
          <img class="preview-img" src="${e.target.result}" />
          <button class="upload-btn" onclick="clearImage()"><span class="material-symbols-rounded">close</span></button>
          <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>`;
      };
      reader.readAsDataURL(file);
    }
    function clearImage(){currentFile=null; previewStrip.innerHTML='';}
    async function uploadToCloudinary(file){
      const form=new FormData();
      form.append('file',file);
      form.append('upload_preset',CLOUDINARY_PRESET);
      const xhr=new XMLHttpRequest();
      xhr.open('POST',CLOUDINARY_URL,false);
      xhr.upload.onprogress=e=>$('#progressBar').style.width=Math.round((e.loaded/e.total)*100)+'%';
      xhr.send(form);
      if(xhr.status===200){
        const res=JSON.parse(xhr.responseText);
        return res.secure_url;
      }else{
        showCustomSnackbar('Image upload failed');
        return null;
      }
    }

    /* --------------- CHAT --------------- */
    const $i=$('#input'), $send=$('#sendBtn'), $mic=$('#micBtn'), $translate=$('#translateBtn'), $list=$('#messagesList');
    window.sendMessage=async()=>{
      const msg=$i.value.trim(); if(!msg)return;
      if(!auth.currentUser){showCustomSnackbar('You must be logged in to chat.'); return;}
      $i.value=''; $send.classList.remove('active'); addMessage(msg,'user');
      const est=Math.ceil(msg.length/4)+200;
      const ok=await checkAndUpdateTokenUsage(est);
      if(!ok){addMessage('Daily token limit reached.','ai'); return;}
      addLoading();
      try{
        const messages=[...historyStack,{role:'user',content:msg}];
        const res=await fetch('https://api.x.ai/v1/chat/completions',{
          method:'POST',
          headers:{Authorization:`Bearer ${XAI_KEY}`,'Content-Type':'application/json'},
          body:JSON.stringify({model:'grok-4-1-fast-non-reasoning',messages,temperature:0.7,max_tokens:1500})
        });
        removeLoading();
        if(!res.ok){await checkAndUpdateTokenUsage(-est); throw new Error('API error');}
        const data=await res.json();
        const reply=data.choices[0]?.message?.content?.trim()||'No response.';
        const out=Math.ceil(reply.length/4);
        await checkAndUpdateTokenUsage(out);
        addMessage(reply,'ai',currentLang!=='en');
        historyStack.push({role:'user',content:msg},{role:'assistant',content:reply});
        updateTokenCounterAfterMessage();
      }catch(e){removeLoading(); addMessage('Connection error.','ai');}
    };
    $i.addEventListener('input',()=>$send.classList.toggle('active',$i.value.trim().length>0));
    $i.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); sendMessage();}});
    $send.addEventListener('click',sendMessage);
    $translate.addEventListener('click',()=>{autoTranslate=!autoTranslate; $translate.classList.toggle('active',autoTranslate); showCustomSnackbar(autoTranslate?'Auto-translate enabled':'Auto-translate disabled');});

    /* --------------- TOKEN COUNTER --------------- */
    async function checkAndUpdateTokenUsage(estimatedTokens){
      const user=auth.currentUser; if(!user)return true;
      const uid=user.uid; const today=new Date().toISOString().slice(0,10);
      const ref=doc(db,'tokenUsage',uid); const snap=await getDoc(ref); const data=snap.data()||{};
      if(data.date!==today){await setDoc(ref,{date:today,used:estimatedTokens,timestamp:serverTimestamp()}); return true;}
      const newTotal=data.used+estimatedTokens;
      if(newTotal>DAILY_TOKEN_LIMIT){showCustomSnackbar(`Daily limit reached (${DAILY_TOKEN_LIMIT.toLocaleString()} tokens). Try again tomorrow.`); return false;}
      await setDoc(ref,{used:newTotal,timestamp:serverTimestamp()},{merge:true}); return true;
    }
    async function updateTokenCounterAfterMessage(){
      const user=auth.currentUser; if(!user)return;
      const uid=user.uid; const today=new Date().toISOString().slice(0,10);
      const ref=doc(db,'tokenUsage',uid); const snap=await getDoc(ref); const data=snap.data()||{};
      const used=(data.date===today?data.used:0)||0;
      tokenCount.textContent=used.toLocaleString();
      const pct=used/DAILY_TOKEN_LIMIT;
      tokenCounter.classList.toggle('warning',pct>=0.75); tokenCounter.classList.toggle('danger',pct>=0.9);
    }

    /* --------------- MISC --------------- */
    function addMessage(text,type,showLangBadge=false){
      const row=document.createElement('div'); row.className=`message-row ${type}`;
      const content=document.createElement('div'); content.className='message-content'; content.innerHTML=text.replace(/```([\s\S]*?)```/g,(m,c)=>`<pre><code>${c.trim()}</code></pre>`).replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');
      if(showLangBadge&&currentLang!=='en'){const b=document.createElement('div'); b.className='lang-badge-msg'; b.textContent=LANGUAGES[currentLang].native; content.appendChild(b);}
      const time=document.createElement('div'); time.className='timestamp'; time.textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      if(type==='ai'){
        const avatar=document.createElement('div'); avatar.className='avatar ai'; avatar.innerHTML='<span class="material-symbols-rounded">auto_awesome</span>';
        const actions=document.createElement('div'); actions.className='copy-actions';
        const copyBtn=document.createElement('button'); copyBtn.className='copy-btn'; copyBtn.innerHTML='<span class="material-symbols-rounded">content_copy</span> Copy';
        copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(content.textContent.replace(/Copy$/,'').trim()); copyBtn.innerHTML='<span class="material-symbols-rounded">check</span> Copied'; setTimeout(()=>copyBtn.innerHTML='<span class="material-symbols-rounded">content_copy</span> Copy',2000);});
        actions.appendChild(copyBtn); content.appendChild(actions); row.append(avatar,content,time);
      }else{row.append(content,time);}
      $('#messagesList').appendChild(row); $('#chatContainer').scrollTop=$('#chatContainer').scrollHeight;
    }
    function addLoading(){const row=document.createElement('div'); row.id='loading'; row.className='message-row ai'; const avatar=document.createElement('div'); avatar.className='avatar ai'; avatar.innerHTML='<span class="material-symbols-rounded">auto_awesome</span>'; const content=document.createElement('div'); content.className='message-content'; content.innerHTML='<div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>'; row.append(avatar,content); $('#messagesList').appendChild(row); $('#chatContainer').scrollTop=$('#chatContainer').scrollHeight;}
    function removeLoading(){const l=$('#loading'); if(l) l.remove();}
    function showCustomSnackbar(msg){const s=$('#customSnackbar'); s.textContent=msg; s.classList.add('show'); setTimeout(()=>s.classList.remove('show'),3000);}

    /* --------------- AUTH HANDLERS (stubs) --------------- */
    $('#profileBtn').addEventListener('click',()=>{const u=auth.currentUser; u? (document.getElementById('userNameInput').value=u.displayName||'', document.getElementById('userEmail').textContent=u.email||'No email', window.openSheet('user')) : window.openSheet('auth');});
    window.openSheet=t=>{ $('#sheetOverlay').classList.add('open'); t==='user'? $('#userSheet').classList.add('open') : $('#authSheet').classList.add('open'); };
    window.closeSheet=t=>{ $('#sheetOverlay').classList.remove('open'); t==='user'? $('#userSheet').classList.remove('open') : $('#authSheet').classList.remove('open'); };
    $('#sheetOverlay').addEventListener('click',()=>window.closeSheet());
    onAuthStateChanged(auth,async(u)=>{
      if(u){await updateTokenCounterAfterMessage();}
    });

    /* --------------- RAIN BG --------------- */
    const canvas=document.createElement('canvas'); canvas.id='rainCanvas'; document.body.appendChild(canvas); const ctx=canvas.getContext('2d'); let w,h,drops=[]; const colors=['#2563eb','#d946ef','#10b981','#cbd5e1'];
    function resize(){w=innerWidth; h=innerHeight; canvas.width=w; canvas.height=h; drops=[]; const count=Math.floor(w/15); for(let i=0;i<count;i++) drops.push({x:Math.random()*w,y:Math.random()*h,len:Math.random()*20+10,speed:Math.random()*3+2,color:colors[Math.floor(Math.random()*colors.length)],opacity:Math.random()*.5+.1});}
    addEventListener('resize',resize); resize();
    function draw(){ctx.clearRect(0,0,w,h); for(const d of drops){ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x,d.y+d.len); ctx.strokeStyle=d.color; ctx.lineWidth=1; ctx.globalAlpha=d.opacity; ctx.stroke(); d.y+=d.speed; if(d.y>h){d.y=-d.len; d.x=Math.random()*w;}} requestAnimationFrame(draw);}
    draw();
  </script>

  <!-- ===== BOTTOM SHEETS (same as your original) ===== -->
  <div class="sheet-overlay" id="sheetOverlay"></div>
  <div class="bottom-sheet" id="userSheet">
    <div class="sheet-header">
      Account Settings
      <button class="sheet-close-btn" onclick="closeSheet('user')"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="user-avatar-large"><span class="material-symbols-rounded">person</span></div>
    <div class="user-email-text" id="userEmail">example@email.com</div>
    <div class="user-info-group">
      <label for="userNameInput">Display Name</label>
      <input type="text" id="userNameInput" class="sheet-input" placeholder="Enter your name">
      <button class="sheet-btn sheet-btn-primary" onclick="updateDisplayName()">Save Name</button>
    </div>
    <button class="sheet-btn sheet-btn-logout" onclick="logout()">
      <span class="material-symbols-rounded" style="font-size:18px">logout</span> Logout
    </button>
  </div>

  <div class="bottom-sheet" id="authSheet">
    <div class="sheet-header">
      Welcome to Vynix Lingua
      <button class="sheet-btn sheet-btn-google" onclick="signInWithGoogle()" aria-label="Sign in with Google">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 18c3.24 0 5.97-1.075 7.956-2.92l-2.908-2.26c-1.075.72-2.456 1.155-4.048 1.155-3.097 0-5.716-2.092-6.655-4.906H.89v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M2.345 10.064A5.367 5.367 0 0 1 2.345 7.94V5.608H.89a8.997 8.997 0 0 0 0 8.088l1.455-1.332z" fill="#FBBC05"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 3.58c1.592 0 3.022.546 4.14 1.61l3.067-3.067C14.97.84 12.24 0 9 0 5.49 0 2.276 1.917.89 4.876l2.455 1.884C3.748 4.67 6.167 3.58 9 3.58z" fill="#EA4335"/>
        </svg>
        <span style="font-family:'Roboto',sans-serif;font-weight:500;font-size:14px;color:#1F1F1F">Sign in with Google</span>
      </button>
    </div>
    <div class="sheet-tab-bar" id="authTabs">
      <div class="sheet-tab active" data-tab="signin">Sign In</div>
      <div class="sheet-tab" data-tab="signup">Sign Up</div>
    </div>
    <div id="signin-content" class="sheet-tab-content">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signInEmail">
      <input type="password" placeholder="Password" class="sheet-input" id="signInPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignIn()">Sign In</button>
    </div>
    <div id="signup-content" class="sheet-tab-content" style="display:none">
      <input type="text" placeholder="Display Name" class="sheet-input" id="signUpName">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signUpEmail">
      <input type="password" placeholder="Password (min 6 chars)" class="sheet-input" id="signUpPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignUp()">Sign Up</button>
    </div>
  </div>
</body>
      </html>
