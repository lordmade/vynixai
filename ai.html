<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix – Posts</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg: #ffffff; --card: #f7f9fa; --text: #0f1419; --text2: #536471; --border: #e1e8ed; --accent: #ff2a6d; }
    [data-theme="dark"] { --bg: #000000; --card: #16181c; --text: #e7e9ea; --text2: #71767b; --border: #2f3336; }
    body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
    
    /* Composer */
    .composer { position: sticky; top: 0; background: var(--bg); z-index: 10; border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; gap: 12px; backdrop-filter: blur(12px); }
    .composer img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea { flex: 1; background: transparent; border: none; outline: none; font-size: 20px; resize: none; color: var(--text); }
    .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
    .icon-btn { background: none; border: none; color: var(--text2); font-size: 24px; cursor: pointer; padding: 8px; border-radius: 50%; }
    .icon-btn:hover { background: #ff2a6d15; color: var(--accent); }
    .post-btn { background: var(--accent); color: white; border: none; border-radius: 999px; padding: 10px 24px; font-weight: bold; cursor: pointer; }
    .post-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Posts */
    .post { background: var(--card); border-bottom: 1px solid var(--border); padding: 12px 16px; }
    .post-header { display: flex; gap: 12px; align-items: flex-start; }
    .post-header img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    .post-meta { flex: 1; }
    .name { font-weight: bold; font-size: 15px; }
    .handle { color: var(--text2); font-size: 15px; }
    .post-body { margin-top: 8px; font-size: 15px; white-space: pre-wrap; word-break: break-word; }
    .post-image { max-width: 100%; border-radius: 12px; margin-top: 12px; }
    .post-actions { margin-top: 12px; display: flex; justify-content: space-between; max-width: 425px; }
    .action-btn { display: flex; align-items: center; gap: 8px; color: var(--text2); font-size: 13px; cursor: pointer; padding: 8px; border-radius: 50%; transition: all .2s; }
    .action-btn:hover { background: #ff2a6d15; color: var(--accent); }
    .action-btn.liked { color: #ff2a6d; }
    .action-btn.reposted { color: #00ba7c; }
    
    /* Replies */
    .reply-input { margin-top: 12px; display: flex; gap: 8px; align-items: center; }
    .reply-input textarea { flex: 1; border: 1px solid var(--border); border-radius: 20px; padding: 10px 16px; font-size: 14px; resize: none; background: var(--card); }
    .reply-input button { background: var(--accent); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: grid; place-items: center; }
    .replies { margin-left: 60px; border-left: 2px solid var(--border); margin-top: 12px; padding-left: 16px; }
    .reply { padding: 8px 0; font-size: 14px; }
    
    /* Toast */
    .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #ff2a6d; color: white; padding: 12px 24px; border-radius: 50px; z-index: 1000; animation: toast 3s forwards; font-weight: 600; }
    @keyframes toast { 0%,100% { opacity:0; transform:translateX(-50%) translateY(20px) } 15%,85% { opacity:1; transform:translateX(-50%) translateY(0) } }

    /* FULL-SCREEN OVERLAY SPINNER */
    #global-loader {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #global-loader.show {
      opacity: 1;
      pointer-events: all;
    }
    .spinner-large {
      width: 56px;
      height: 56px;
      border: 5px solid rgba(255,42,109,.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loader-text {
      margin-top: 20px;
      font-size: 16px;
      color: var(--text2);
      font-weight: 500;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- FULL-SCREEN OVERLAY SPINNER -->
  <div id="global-loader">
    <div class="spinner-large"></div>
    <div class="loader-text">Loading posts...</div>
  </div>

  <!-- Composer -->
  <div class="composer">
    <img id="myAvatar" src="" alt="You">
    <div style="flex:1">
      <textarea id="postText" placeholder="What's happening?" rows="2"></textarea>
      <img id="preview" class="post-image hidden" alt="Preview">
      <div class="actions">
        <div>
          <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
          <label for="fileInput" class="icon-btn material-icons">image</label>
        </div>
        <button id="postBtn" class="post-btn" disabled>
          <span id="btnText">Post</span>
          <div id="spinner" class="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin hidden"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Feed -->
  <div id="feed"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, serverTimestamp, increment, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);

    const loader = document.getElementById('global-loader');
    const postBtn = document.getElementById('postBtn');
    const postText = document.getElementById('postText');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('fileInput');
    const myAvatar = document.getElementById('myAvatar');
    const feed = document.getElementById('feed');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');

    let currentUser = null;
    let mediaUrl = '';
    let uploading = false;

    // Show/hide global loader
    const showLoader = (text = "Loading posts...") => {
      loader.querySelector('.loader-text').textContent = text;
      loader.classList.add('show');
    };
    const hideLoader = () => loader.classList.remove('show');

    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }
      currentUser = user;
      myAvatar.src = user.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${encodeURIComponent(user.displayName || 'U')}`;
      showLoader("Loading your feed...");
      loadPosts();
    });

    const updateButton = () => {
      postBtn.disabled = uploading || (!postText.value.trim() && !mediaUrl);
    };
    postText.addEventListener('input', updateButton);

    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.classList.remove('hidden'); };
      reader.readAsDataURL(file);
      showLoader("Uploading media...");
      uploadMedia(file);
    };

    function uploadMedia(file) {
      uploading = true;
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      updateButton();

      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'vynix_posts');

      fetch('https://api.cloudinary.com/v1_1/dk5d7xkhz/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          mediaUrl = data.secure_url;
          toast('Media ready!');
        })
        .catch(() => toast('Upload failed'))
        .finally(() => {
          uploading = false;
          btnText.classList.remove('hidden');
          spinner.classList.add('hidden');
          hideLoader();
          updateButton();
        });
    }

    postBtn.onclick = async () => {
      if (postBtn.disabled) return;
      const text = postText.value.trim();
      if (!text && !mediaUrl) return;

      showLoader("Posting...");
      const postRef = push(ref(db, 'posts'));
      await set(postRef, {
        authorId: currentUser.uid,
        authorName: currentUser.displayName || currentUser.email.split('@')[0],
        authorAvatar: currentUser.photoURL || myAvatar.src,
        text,
        image: mediaUrl || '',
        likes: 0,
        reposts: 0,
        replies: 0,
        timestamp: serverTimestamp()
      });

      postText.value = '';
      mediaUrl = '';
      preview.classList.add('hidden');
      fileInput.value = '';
      updateButton();
      hideLoader();
      toast('Posted!');
    };

    function loadPosts() {
      const postsRef = ref(db, 'posts');
      onValue(postsRef, snap => {
        const posts = [];
        snap.forEach(child => {
          const p = child.val();
          if (p.timestamp) posts.push({ id: child.key, ...p });
        });
        posts.sort((a, b) => b.timestamp - a.timestamp);
        feed.innerHTML = '';
        posts.forEach(p => feed.appendChild(createPost(p)));
        hideLoader(); // Hide loader once feed is ready
      }, { onlyOnce: false });
    }

    function createPost(p) {
      const div = document.createElement('div');
      div.className = 'post';
      const ago = timeAgo(p.timestamp);

      div.innerHTML = `
        <div class="post-header">
          <img src="${p.authorAvatar}" alt="avatar">
          <div class="post-meta">
            <div class="name">${escape(p.authorName)}</div>
            <div class="handle">@\( {p.authorName.replace(/\s/g,'').toLowerCase()} · \){ago}</div>
          </div>
        </div>
        <div class="post-body">${escape(p.text)}</div>
        \( {p.image ? `<img class="post-image" src=" \){p.image}" loading="lazy">` : ''}
        <div class="post-actions">
          <div class="action-btn" data-action="reply"><span class="material-icons text-20">mode_comment</span> ${p.replies || 0}</div>
          <div class="action-btn" data-action="repost"><span class="material-icons text-20">repeat</span> ${p.reposts || 0}</div>
          <div class="action-btn" data-action="like"><span class="material-icons text-20">favorite</span> ${p.likes || 0}</div>
          <div class="action-btn"><span class="material-icons text-20">share</span></div>
        </div>
        <div class="replies" id="replies-${p.id}"></div>
      `;

      div.querySelectorAll('.action-btn').forEach(btn => {
        btn.onclick = async (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          const postRef = ref(db, `posts/${p.id}`);
          showLoader(action === 'like' ? "Liking..." : action === 'repost' ? "Reposting..." : "Replying...");

          if (action === 'like') {
            await runTransaction(postRef, post => { if (post) post.likes = (post.likes || 0) + 1; return post; });
            btn.classList.add('liked');
          }
          if (action === 'repost') {
            await runTransaction(postRef, post => { if (post) post.reposts = (post.reposts || 0) + 1; return post; });
            btn.classList.add('reposted');
          }
          if (action === 'reply') {
            const input = document.createElement('div');
            input.className = 'reply-input';
            input.innerHTML = `<textarea placeholder="Post your reply"></textarea><button><span class="material-icons">send</span></button>`;
            div.querySelector(`#replies-${p.id}`).appendChild(input);
            input.querySelector('button').onclick = async () => {
              const text = input.querySelector('textarea').value.trim();
              if (!text) return;
              const replyRef = push(ref(db, `posts/${p.id}/replies`));
              await set(replyRef, { authorId: currentUser.uid, authorName: currentUser.displayName || 'User', text, timestamp: serverTimestamp() });
              await runTransaction(postRef, post => { if (post) post.replies = (post.replies || 0) + 1; return post; });
              input.remove();
            };
          }
          hideLoader();
        };
      });

      return div;
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'toast';
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    function escape(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function timeAgo(ts) {
      const sec = Math.floor((Date.now() - ts) / 1000);
      if (sec < 60) return sec + 's';
      if (sec < 3600) return Math.floor(sec/60) + 'm';
      if (sec < 86400) return Math.floor(sec/3600) + 'h';
      return Math.floor(sec/86400) + 'd';
    }
  </script>
</body>
</html>
