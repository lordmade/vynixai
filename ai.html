<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { transition: transform 0.3s ease; }
    .msg-time { font-size: 0.65rem; opacity: 0.6; margin-top: 0.35rem; text-align: right; }
    .msg-time.ai { text-align: left; }
    .hamburger { transition: all 0.3s; }
    .hamburger.active { transform: rotate(90deg); }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; height: 100vh; }
      .sidebar.open { transform: translateX(0); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Mobile Hamburger -->
  <button id="hamburger" class="hamburger fixed top-4 left-4 z-50 lg:hidden p-3 bg-white rounded-xl shadow-lg">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar w-80 bg-white shadow-2xl flex flex-col">
    <div class="p-6 border-b">
      <h2 class="text-2xl font-bold">Vynix AI</h2>
      <p class="text-sm text-gray-500 mt-1">Pure Community Brain</p>
    </div>
    <div class="flex-1 overflow-y-auto p-4">
      <button id="new-conversation" class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-semibold hover:scale-105 transition mb-6">
        + New Conversation
      </button>
      <div id="history-list" class="space-y-2">
        <!-- Conversations will appear here -->
      </div>
    </div>
    <div class="p-4 border-t text-center text-xs text-gray-500">
      <span id="pair-count">Loading...</span> responses
    </div>
  </div>

  <!-- Main Chat -->
  <div class="lg:ml-80 flex flex-col h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm p-4 border-b flex items-center justify-between">
      <h1 class="text-xl font-semibold">Chat</h1>
      <button id="new-conversation-desktop" class="hidden lg:block px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
        New Conversation
      </button>
    </div>

    <!-- Messages -->
    <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-6"></div>

    <!-- Input -->
    <div class="bg-white border-t p-4">
      <div class="max-w-4xl mx-auto flex gap-3">
        <input type="text" id="input" placeholder="Type your message..." class="flex-1 px-5 py-4 rounded-2xl border focus:outline-none focus:border-purple-500 text-lg" autofocus>
        <button id="send" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-bold hover:scale-105 transition">
          Send
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const el = {
      messages: document.getElementById('messages'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      sidebar: document.getElementById('sidebar'),
      hamburger: document.getElementById('hamburger'),
      historyList: document.getElementById('history-list'),
      pairCount: document.getElementById('pair-count'),
      newConvBtn: document.getElementById('new-conversation'),
      newConvDesktop: document.getElementById('new-conversation-desktop')
    };

    let pairs = [];
    let conversations = [];
    let currentConvId = null;

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function addMessage(text, sender, confidence = null) {
      const div = document.createElement('div');
      div.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';
      const bubble = document.createElement('div');
      bubble.className = `max-w-xs lg:max-w-md px-5 py-4 rounded-3xl shadow-lg ${sender === 'user' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-white text-gray-800'}`;
      bubble.textContent = text;

      const time = document.createElement('div');
      time.className = `msg-time text-xs mt-1 ${sender === 'user' ? 'text-right' : 'text-left'}`;
      time.textContent = formatTime(new Date());

      const wrapper = document.createElement('div');
      wrapper.appendChild(bubble);
      wrapper.appendChild(time);
      div.appendChild(wrapper);
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;
    }

    function jaroWinkler(a, b) {
      a = a.toLowerCase(); b = b.toLowerCase();
      if (a === b) return 1;
      const lenA = a.length, lenB = b.length;
      if (!lenA || !lenB) return 0;
      const matchWindow = Math.max(0, Math.floor(Math.max(lenA, lenB) / 2) - 1);
      const aMatches = Array(lenA).fill(false);
      const bMatches = Array(lenB).fill(false);
      let matches = 0, transpositions = 0;

      for (let i = 0; i < lenA; i++) {
        const start = Math.max(0, i - matchWindow);
        const end = Math.min(i + matchWindow + 1, lenB);
        for (let j = start; j < end; j++) {
          if (bMatches[j] || a[i] !== b[j]) continue;
          aMatches[i] = bMatches[j] = true;
          matches++; break;
        }
      }
      if (!matches) return 0;
      let k = 0;
      for (let i = 0; i < lenA; i++) if (aMatches[i]) {
        while (!bMatches[k]) k++;
        if (a[i] !== b[k++]) transpositions++;
      }
      const jaro = (matches/lenA + matches/lenB + (matches - transpositions/2)/matches) / 3;
      let prefix = 0;
      for (let i = 0; i < Math.min(4, lenA, lenB); i++) if (a[i] === b[i]) prefix++; else break;
      return jaro + prefix * 0.1 * (1 - jaro);
    }

    function getReply(message) {
      const msg = message.toLowerCase().trim();
      let best = null;
      let bestScore = 0;

      for (const p of pairs) {
        const score = jaroWinkler(msg, p.trigger.toLowerCase().trim());
        if (score > bestScore) {
          bestScore = score;
          best = p.reply;
        }
      }

      if (bestScore >= 0.92) return { reply: best, confidence: Math.round(bestScore * 100), type: "Very Close" };
      if (bestScore >= 0.85) return { reply: best, confidence: Math.round(bestScore * 100), type: "Close Match" };
      if (pairs.some(p => msg.includes(p.trigger.toLowerCase().trim()) || p.trigger.toLowerCase().trim().includes(msg))) {
        const partial = pairs.find(p => msg.includes(p.trigger.toLowerCase().trim()) || p.trigger.toLowerCase().trim().includes(msg));
        return { reply: partial.reply, confidence: 75, type: "Partial" };
      }

      return { reply: "I don't have a response for that yet.", confidence: 0, type: "No Match" };
    }

    function send() {
      const text = el.input.value.trim();
      if (!text) return;

      addMessage(text, 'user');
      el.input.value = '';

      setTimeout(() => {
        const result = getReply(text);
        addMessage(result.reply + (result.confidence > 0 ? `\n\n${result.type} â€¢ ${result.confidence}% match` : ''), 'ai');
      }, 400 + Math.random() * 400);
    }

    // Load pairs
    onValue(ref(db, 'pairs'), snap => {
      pairs = [];
      const data = snap.val() || {};
      Object.values(data).forEach(p => {
        if (p.trigger && p.reply) pairs.push({ trigger: p.trigger.trim(), reply: p.reply.trim() });
      });
      el.pairCount.textContent = pairs.length.toLocaleString();
    });

    // Mobile sidebar toggle
    el.hamburger.addEventListener('click', () => {
      el.sidebar.classList.toggle('open');
      el.hamburger.classList.toggle('active');
    });

    // New conversation
    function newConversation() {
      el.messages.innerHTML = '';
      addMessage("Hey! How can I help you today?", 'ai');
    }

    el.newConvBtn.addEventListener('click', newConversation);
    el.newConvDesktop.addEventListener('click', newConversation);

    el.send.addEventListener('click', send);
    el.input.addEventListener('keypress', e => e.key === 'Enter' && send());

    // Init
    onAuthStateChanged(auth, user => user || signInAnonymously(auth));
    newConversation();
  </script>
</body>
</html>
