<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Public Feed</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg:#fff; --card:#fff; --text:#0f1419; --text2:#536471; --border:#eff3f4; --accent:#ff2a6d; --hover-accent:rgba(255,42,109,0.1); }
    [data-theme="dark"] { --bg:#000; --card:#000; --text:#e7e9ea; --text2:#71767b; --border:#2f3336; }
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

    .composer { display:flex; gap:12px; padding:16px; border-bottom:1px solid var(--border); }
    .composer img.avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; }
    textarea { flex:1; resize:none; background:transparent; color:var(--text); border:none; outline:none; font-size:20px; padding-top:8px; min-height:60px; }
    .media-preview { width:100%; border-radius:16px; margin-top:12px; border:1px solid var(--border); }
    .composer-actions { display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
    .icon-btn { background:none; border:none; color:var(--accent); cursor:pointer; padding:8px; border-radius:50%; }
    .icon-btn:hover { background:var(--hover-accent); }
    .post-btn { background:var(--accent); color:#fff; border:none; border-radius:999px; padding:9px 20px; font-weight:700; cursor:pointer; }
    .post-btn:disabled { opacity:0.5; cursor:default; }

    .feed { padding-bottom:60px; }
    .post-card { border-bottom:1px solid var(--border); padding:12px 16px; }
    .post-card:hover { background:rgba(0,0,0,0.03); }
    [data-theme="dark"] .post-card:hover { background:rgba(255,255,255,0.03); }
    .post-header { display:flex; gap:12px; }
    .post-avatar { width:40px; height:40px; border-radius:50%; }
    .user-meta { font-size:15px; display:flex; align-items:center; gap:4px; }
    .name { font-weight:700; }
    .verified-badge { color:#1d9bf0; }
    .handle { color:var(--text2); }
    .post-content { margin-left:52px; margin-top:4px; font-size:15px; white-space:pre-wrap; line-height:1.4; }
    .post-image { border-radius:16px; margin-top:12px; max-width:100%; border:1px solid var(--border); }
    .post-actions { margin-left:52px; margin-top:12px; display:flex; gap:20px; color:var(--text2); font-size:13px; }
    .action-item { display:flex; align-items:center; gap:6px; cursor:pointer; padding:6px; border-radius:50%; }
    .action-item:hover.like { color:#f91880; }
    .action-item:hover.like .material-icons-outlined { background:rgba(249,24,128,0.1); }

    .custom-toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--accent); color:white; padding:12px 28px; border-radius:99px; font-weight:600; opacity:0; transition:0.4s; z-index:9999; }
    .custom-toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
  </style>
</head>
<body>

<div class="composer">
  <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=You" alt=""/>
  <div style="flex:1">
    <textarea id="post-text" placeholder="What is happening?!"></textarea>
    <img id="media-preview" class="media-preview hidden" alt=""/>
    <div class="composer-actions">
      <div>
        <input type="file" id="file-input" accept="image/*" class="hidden"/>
        <label for="file-input" class="icon-btn"><span class="material-icons-outlined">image</span></label>
      </div>
      <button id="post-btn" class="post-btn" disabled>Post</button>
    </div>
  </div>
</div>

<main id="feed" class="feed"></main>

<div class="text-center py-8">
  <button id="load-more" class="post-btn hidden">Load More</button>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, onChildAdded, query, limitToLast, orderByChild, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",   // FIXED LINE
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let myUid = null;
let myName = "Guest";
let myAvatar = "";

const feed = document.getElementById('feed');
const textarea = document.getElementById('post-text');
const preview = document.getElementById('media-preview');
const fileInput = document.getElementById('file-input');
const postBtn = document.getElementById('post-btn');
const loadMoreBtn = document.getElementById('load-more');

// Theme
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.setAttribute('data-theme', 'dark');
}

// Auth
onAuthStateChanged(auth, user => {
  if (!user) signInAnonymously(auth);
  myUid = user?.uid || 'guest_' + Math.random().toString(36).slice(2);
  myName = user?.displayName || 'Guest';
  myAvatar = user?.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${myName}`;
  document.getElementById('my-avatar').src = myAvatar;

  loadFirstPosts();
  listenForNewPosts();
});

// Load first 30 posts
function loadFirstPosts() {
  const q = query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(30));
  onChildAdded(q, snap => {
    const data = snap.val();
    data.key = snap.key;
    if (document.getElementById(`post-${data.key}`)) || feed.appendChild(createPost(data));
  }, { onlyOnce: true });
}

// Listen for new posts in real-time (appears instantly at top)
function listenForNewPosts() {
  const q = query(ref(db, 'posts'), orderByChild('timestamp'));
  onChildAdded(q, snap => {
    const data = snap.val();
    data.key = snap.key;
    if (!document.getElementById(`post-${data.key}`)) {
      feed.prepend(createPost(data));
    }
  });
}

// Post creation
postBtn.onclick = () => {
  const text = textarea.value.trim();
  if (!text) return;

  const newPostRef = push(ref(db, 'posts'));
  const tempKey = newPostRef.key;

  const post = {
    authorId: myUid,
    authorName: myName,
    authorAvatar: myAvatar,
    text: text,
    image: null,
    likes: 0,
    timestamp: serverTimestamp()
  };

  // Optimistic UI
  post.key = tempKey;
  post.timestamp = Date.now();
  feed.prepend(createPost(post));

  set(newPostRef, post).then(() => {
    textarea.value = '';
    postBtn.disabled = true;
    toast('Posted!');
  }).catch(() => {
    document.getElementById(`post-${tempKey}`)?.remove();
    toast('Failed');
  });
};

textarea.oninput = () => {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
  postBtn.disabled = !textarea.value.trim();
};

// Simple post HTML
function createPost(p) {
  const el = document.createElement('div');
  el.className = 'post-card';
  el.id = `post-${p.key}`;

  const del = p.authorId === myUid ? `<span class="material-icons-outlined" style="cursor:pointer;color:#f4212e" onclick="del('${p.key}')">delete</span>` : '';

  el.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar}" class="post-avatar">
      <div style="flex:1">
        <div class="user-meta">
          <span class="name">${escape(p.authorName)}</span>
          <span class="handle">@\( {p.authorName.toLowerCase().replace(/\s/g,'')} · \){timeAgo(p.timestamp)}</span>
        </div>
        <div class="post-content">${escape(p.text)}</div>
        \( {p.image ? `<img src=" \){p.image}" class="post-image" loading="lazy">` : ''}
        <div class="post-actions">
          <div class="action-item like"><span class="material-icons-outlined">favorite_border</span> ${p.likes||0}</div>
          ${del}
        </div>
      </div>
    </div>
  `;
  return el;
}

window.del = key => {
  if (confirm('Delete?')) {
    remove(ref(db, 'posts/' + key)).then(() => {
      document.getElementById(`post-${key}`)?.remove();
      toast('Deleted');
    });
  }
};

function escape(t) { return t ? t.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }

function timeAgo(ts) {
  if (!ts) return 'now';
  const sec = Math.floor((Date.now() - (ts.seconds ? ts.seconds*1000 : ts))/1000);
  if (sec < 60) return sec+'s';
  if (sec < 3600) return Math.floor(sec/60)+'m';
  if (sec < 86400) return Math.floor(sec/3600)+'h';
  return Math.floor(sec/86400)+'d';
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'custom-toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add('show'),10);
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),400); }, 2500);
}
</script>
</body>
</html>
