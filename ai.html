<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BBM 2025 - AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brain.js@2.0.0-beta.24/dist/brain-browser.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --card-bg: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --border: #333333;
      --accent: #d40000;
      --bbm-red: #d40000;
      --header-bg: #000000;
      --chat-bubble-sent: #2a2a2a;
      --chat-bubble-received: #1a1a1a;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
      --glow: 0 0 20px rgba(212, 0, 0, 0.5);
    }
    body.light {
      --bg: #f8f8f8;
      --card-bg: #ffffff;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border: #e0e0e0;
      --header-bg: #ffffff;
      --chat-bubble-sent: #e6f3ff;
      --chat-bubble-received: #ffffff;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--header-bg); z-index: 100;
      padding: 12px 20px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      height: 64px; box-shadow: var(--shadow-sm);
    }
    .logo { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 22px; color: var(--bbm-red); cursor: pointer; text-shadow: var(--glow); }
    .main-content { padding: 84px 20px 120px; min-height: calc(100vh - 84px); }
    #messages { display: flex; flex-direction: column; gap: 12px; padding: 20px 0; max-height: calc(100vh - 200px); overflow-y: auto; }
    .message { display: flex; max-width: 80%; padding: 12px 16px; border-radius: 20px; margin-bottom: 8px; }
    .message.user { align-self: flex-end; background: var(--bbm-red); color: #000; }
    .message.ai { align-self: flex-start; background: var(--card-bg); border: 1px solid var(--border); }
    .input-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); border-top: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; gap: 12px; }
    .input-bar input { flex: 1; background: none; border: none; outline: none; color: var(--text-primary); font-size: 16px; padding: 12px; }
    .send-btn { background: var(--bbm-red); color: #000; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .status { text-align: center; color: var(--text-secondary); padding: 20px; }
    .spinner { display: flex; gap: 8px; margin: 20px auto; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--bbm-red); animation: bounce 1s infinite; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
  </style>
</head>
<body class="dark">
  <header class="header">
    <div class="logo" onclick="window.location.href='index.html'">Vynix AI</div>
    <div style="flex: 1; text-align: center;">
      <span style="color: var(--text-secondary);">LSTM-enhanced AI with South African vibes</span>
    </div>
    <button onclick="logout()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
      <span class="material-icons">logout</span>
    </button>
  </header>

  <main class="main-content">
    <div id="status" class="status">Loading AI... Fetching public statuses.</div>
    <div id="messages" style="display: none;"></div>
  </main>

  <div class="input-bar">
    <input type="text" id="user-input" placeholder="Ask about SA trends, reply with some rizz, or chat lekker..." onkeypress="if(event.key==='Enter') sendMessage()">
    <button class="send-btn material-icons" onclick="sendMessage()">send</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = { apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc", authDomain: "fire-b-a8878.firebaseapp.com", databaseURL: "https://fire-b-a8878.firebaseio.com", projectId: "fire-b-a8878", storageBucket: "fire-b-a8878.firebasestorage.app", messagingSenderId: "658673187627", appId: "1:658673187627:web:6e4c29af661785f0afa36e", measurementId: "G-V4W97VMSKL" };

    let app, auth, db, currentUser, net, statusesData = [], isTraining = false;

    // AI Identity and Purpose with SA Context
    const AI_NAME = 'Vynix';
    const AI_CREATOR = 'VynixAI team from South Africa';
    const AI_PURPOSE = `I'm ${AI_NAME}, created by the ${AI_CREATOR}. My purpose is to provide contextual replies infused with South African culture—think braai chats, rugby banter, township vibes, and the latest slang like 'delulu' for wild dreams, 'rizz' for smooth charm, or 'lekker' for that feel-good flow. Trained on public statuses, I help users dive into SA trends, reply with local flair, and keep conversations ubuntu-style.`;

    // SA Cultural Seeds for Training (to infuse context)
    const saCulturalSeeds = [
      "Braai on the weekend in Joburg, feeling lekker with some boerewors and pap.",
      "Rugby fever in Cape Town, Springboks smashing it! Who's got the rizz to predict the score?",
      "Township vibes in Soweto, dancing to amapiano—delulu if you think you can keep up!",
      "Load shedding got me glazing over candles, but sigma mindset keeps it positive.",
      "From the Highveld to the Karoo, SA stories full of ubuntu and that unbreakable spirit.",
      "What's sybau? Just SA slang for 'shut your beak and listen'—chat with some bop energy!"
    ];

    // SAST timezone check for auto-retrain (2 AM daily)
    function shouldRetrain() {
      const now = new Date();
      const sastNow = new Date(now.toLocaleString("en-US", {timeZone: "Africa/Johannesburg"}));
      const hour = sastNow.getHours();
      const lastTrainStr = localStorage.getItem('lastTrainTime');
      if (!lastTrainStr) return true;

      const lastTrain = new Date(lastTrainStr);
      const lastSAST = new Date(lastTrain.toLocaleString("en-US", {timeZone: "Africa/Johannesburg"}));
      const todayMidnight = new Date(sastNow.getFullYear(), sastNow.getMonth(), sastNow.getDate(), 2, 0, 0);

      return lastSAST < todayMidnight;
    }

    function setLastTrainTime() {
      localStorage.setItem('lastTrainTime', new Date().toISOString());
    }

    // Simple tokenizer for sentiment scan
    function tokenize(text) {
      return text.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .split(/\s+/)
        .filter(w => w.length > 0);
    }

    async function fetchPublicStatuses() {
      const statusesRef = ref(db, 'statuses');
      const snapshot = await get(statusesRef);
      if (snapshot.exists()) {
        statusesData = Object.values(snapshot.val()).filter(s => s.content && s.content.trim()).map(s => s.content);
      }
      return statusesData;
    }

    async function trainModel(auto = false) {
      if (isTraining || statusesData.length === 0) return;
      isTraining = true;
      document.getElementById('status').innerHTML = '<div class="spinner"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div> Optimizing data & training optimized LSTM with SA vibes...';

      try {
        // Filter: Only meaningful statuses (>50 chars for LSTM)
        let filteredTexts = statusesData.filter(text => text.length > 50);
        // Infuse SA cultural seeds to enhance training
        filteredTexts = [...filteredTexts, ...saCulturalSeeds];
        if (filteredTexts.length === 0) throw new Error('No sufficient data after filtering.');

        net = new brain.recurrent.LSTM({ hiddenLayers: [50] });
        const result = net.train(filteredTexts, { 
          iterations: 10000, 
          errorThresh: 0.005,
          log: true, 
          logPeriod: 50,
          learningRate: 0.01,
          momentum: 0.1 
        });

        document.getElementById('status').innerHTML = `LSTM-trained with SA flair! Loss: ${result.error.toFixed(4)}. Ready for contextual replies.`;
        document.getElementById('messages').style.display = 'flex';
        isTraining = false;
        setLastTrainTime();

        // Save model for persistence
        const saveData = { model: net.toJSON(), timestamp: Date.now() };
        localStorage.setItem('aiModel', JSON.stringify(saveData));

        // Introduce AI identity and purpose on first load
        addMessage('AI', AI_PURPOSE);

        // Context if statusId
        const urlParams = new URLSearchParams(window.location.search);
        const statusId = urlParams.get('statusId');
        if (statusId) {
          const statusRef = ref(db, `statuses/${statusId}`);
          const snap = await get(statusRef);
          if (snap.exists()) {
            const status = snap.val().content;
            addMessage('AI', `Context: "${status.substring(0, 100)}..." What would you like to know? Let's chat with some SA rizz!`);
          }
        }
      } catch (error) {
        document.getElementById('status').innerHTML = `Prep/Train error: ${error.message}`;
        isTraining = false;
      }
    }

    function addMessage(sender, text) {
      const messages = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = `message ${sender.toLowerCase()}`;
      msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    // LSTM generation: Char-level continuation with SA seed
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const prompt = input.value.trim();
      if (!prompt || !net) return;
      input.value = '';

      addMessage('User', prompt);

      // Check if user is asking about itself
      const lowerPrompt = prompt.toLowerCase();
      const selfQueries = ['who are you', 'what are you', 'explain yourself', 'tell me about yourself', 'your purpose'];
      const isSelfQuery = selfQueries.some(query => lowerPrompt.includes(query));

      if (isSelfQuery) {
        addMessage('AI', AI_PURPOSE);
        setTimeout(() => addMessage('AI', "Now that you know me better, what's on your mind today? Got any SA stories to share?"), 500);
        return;
      }

      // Seed prompt with AI identity and SA cultural context for consistent self-awareness and flair
      const saSeed = "In true SA style, with ubuntu and a dash of delulu dreams: ";
      const seededPrompt = `${AI_NAME}: ${AI_PURPOSE.split('.')[0]} ${saSeed}Responding to: ${prompt}. `;

      // Generate continuation with LSTM
      let fullResponse = net.run(seededPrompt, 150); // Generate up to 150 chars after prompt
      let response = fullResponse.substring(seededPrompt.length);
      // Limit to ~15 words for readability
      response = response.split(' ').slice(0, 15).join(' ');
      response = response || 'Based on SA trends, that's lekker! What next?';
      if (response.length > 120) response = response.substring(0, 120) + '...';

      // Tie in SA-infused trends (updated with local slang)
      const saTrendWords = ['lekker', 'braai', 'rizz', 'delulu', 'ubuntu', 'amapiano', 'sigma'];
      const sentiment = saTrendWords.some(w => statusesData.some(t => tokenize(t).includes(w))) ? 'positive SA vibes' : 'neutral Mzansi mood';
      response += ` (${sentiment}, powered by LSTM with cultural flow)`;

      // Add engaging follow-up question
      const followUps = [
        " Eish, what's your take on that?",
        " Lekker chat! Got a braai story to share?",
        " With that rizz, what's next on your mind?",
        " Ubuntu vibes—how does that hit for you?",
        " Delulu dreams aside, what's the real tea?"
      ];
      const randomFollowUp = followUps[Math.floor(Math.random() * followUps.length)];
      response += randomFollowUp;

      setTimeout(() => addMessage('AI', response), 500);
    }

    window.logout = async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    };

    // Init
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getDatabase(app);
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await fetchPublicStatuses();
        const savedModelStr = localStorage.getItem('aiModel');
        if (savedModelStr && !shouldRetrain()) {
          try {
            const saved = JSON.parse(savedModelStr);
            net = brain.recurrent.LSTM.fromJSON(saved.model);
            document.getElementById('status').innerHTML = `Loaded LSTM model with SA vibes (from ${new Date(saved.timestamp).toLocaleDateString()}). Ready for contextual replies!`;
            document.getElementById('messages').style.display = 'flex';

            // Introduce AI identity and purpose on load if model is loaded
            addMessage('AI', AI_PURPOSE);
          } catch (e) {
            console.warn('Saved model invalid, retraining...');
            await trainModel();
          }
        } else {
          await trainModel(true); // Auto if needed
        }
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
