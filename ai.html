<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix – Full Social Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ---------- CSS VARIABLES ---------- */
    :root {
      --bg: #ffffff; --card: #ffffff; --text: #0f1419; --text2: #536471;
      --border: #eff3f4; --accent: #ff2a6d; --hover-accent: rgba(255, 42, 109, 0.1);
    }
    [data-theme="dark"] {
      --bg: #000000; --card: #000000; --text: #e7e9ea; --text2: #71767b;
      --border: #2f3336;
    }
    * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    input, textarea { -webkit-user-select: auto; user-select: auto; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); overflow-y: scroll; }
    /* ---------- COMPOSER ---------- */
    .composer { display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--border); }
    .composer img.avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea { flex: 1; resize: none; background: transparent; color: var(--text); border: none; outline: none; font-size: 20px; padding-top: 10px; min-height: 60px; }
    .media-preview { width: 100%; border-radius: 16px; margin-top: 12px; border: 1px solid var(--border); }
    .composer-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
    .icon-btn { background: none; border: none; color: var(--accent); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--hover-accent); }
    .post-btn { background: var(--accent); color: #fff; border: none; border-radius: 999px; padding: 10px 24px; font-weight: 700; font-size: 15px; cursor: pointer; transition: opacity 0.2s; }
    .post-btn:disabled { opacity: 0.5; cursor: default; }
    /* ---------- FEED ---------- */
    .feed { padding-bottom: 40px; }
    .post-card { border-bottom: 1px solid var(--border); padding: 16px; cursor: pointer; transition: background 0.2s; }
    .post-card:hover { background: rgba(0,0,0,0.03); }
    [data-theme="dark"] .post-card:hover { background: rgba(255,255,255,0.03); }
    .post-header { display: flex; gap: 12px; align-items: flex-start; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .user-meta { display: flex; gap: 4px; align-items: center; font-size: 15px; }
    .name { font-weight: 700; color: var(--text); }
    .verified-badge { color: #1d9bf0; font-size: 16px !important; margin-left: 2px; }
    .handle, .time { color: var(--text2); font-weight: 400; }
    .post-content { margin-top: 4px; font-size: 15px; line-height: 1.5; white-space: pre-wrap; margin-left: 52px; }
    .post-image { border-radius: 16px; margin-top: 12px; max-width: 100%; border: 1px solid var(--border); }
    .post-actions { display: flex; justify-content: space-between; margin-top: 12px; margin-left: 52px; max-width: 400px; color: var(--text2); }
    .action-item { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .action-item .material-icons-outlined { font-size: 18px; padding: 8px; border-radius: 50%; transition: 0.2s; }
    .action-item:hover.reply { color: #1d9bf0; }
    .action-item:hover.reply .material-icons-outlined { background: rgba(29, 155, 240, 0.1); }
    .action-item:hover.repost { color: #00ba7c; }
    .action-item:hover.repost .material-icons-outlined { background: rgba(0, 186, 124, 0.1); }
    .action-item:hover.like { color: #f91880; }
    .action-item:hover.like .material-icons-outlined { background: rgba(249, 24, 128, 0.1); }
    .delete-btn:hover { color: #f4212e; }
    /* ---------- CUSTOM ALERT MODAL ---------- */
    #custom-alert-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.25s ease;
    }
    #custom-alert-overlay.show { opacity: 1; pointer-events: auto; }
    .custom-alert-box {
      background: var(--card); color: var(--text); border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; max-width: 320px; width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25); transform: scale(0.95);
      transition: transform 0.25s ease;
    }
    #custom-alert-overlay.show .custom-alert-box { transform: scale(1); }
    .custom-alert-title { font-weight: 700; font-size: 18px; margin-bottom: 8px; }
    .custom-alert-message { font-size: 15px; color: var(--text2); margin-bottom: 20px; }
    .custom-alert-buttons { display: flex; gap: 12px; justify-content: flex-end; }
    .custom-alert-btn { background: none; border: none; font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 999px; transition: background 0.2s; }
    .custom-alert-btn.cancel { color: var(--text2); }
    .custom-alert-btn.cancel:hover { background: rgba(0,0,0,0.05); }
    [data-theme="dark"] .custom-alert-btn.cancel:hover { background: rgba(255,255,255,0.05); }
    .custom-alert-btn.confirm { background: var(--accent); color: #fff; }
    .custom-alert-btn.confirm:hover { opacity: 0.9; }
    /* ---------- COMMENT BOTTOM SHEET ---------- */
    #comment-sheet-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    #comment-sheet-overlay.show { opacity: 1; pointer-events: auto; }
    .comment-sheet {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: var(--card); border-top: 1px solid var(--border);
      border-top-left-radius: 20px; border-top-right-radius: 20px;
      max-height: 75vh; display: flex; flex-direction: column;
      transform: translateY(100%); transition: transform 0.3s ease;
    }
    #comment-sheet-overlay.show .comment-sheet { transform: translateY(0); }
    .comment-sheet-header {
      padding: 16px; font-size: 18px; font-weight: 700; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .comment-sheet-close {
      background: none; border: none; color: var(--text2); cursor: pointer;
    }
    .comment-sheet-list {
      flex: 1; overflow-y: auto; padding: 0 16px;
    }
    .comment-item {
      display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border);
    }
    .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .comment-body { flex: 1; }
    .comment-name { font-size: 14px; font-weight: 700; }
    .comment-text { font-size: 15px; margin-top: 2px; }
    .comment-input-box {
      display: flex; gap: 12px; padding: 16px; border-top: 1px solid var(--border);
    }
    .comment-input {
      flex: 1; resize: none; background: transparent; color: var(--text);
      border: 1px solid var(--border); border-radius: 999px; padding: 10px 16px;
      font-size: 15px; outline: none;
    }
    .comment-send-btn {
      background: var(--accent); color: #fff; border: none; border-radius: 50%;
      width: 40px; height: 40px; display: grid; place-items: center;
      cursor: pointer; transition: opacity 0.2s;
    }
    .comment-send-btn:disabled { opacity: 0.5; cursor: default; }
    /* ---------- TOAST ---------- */
    .custom-toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--accent); color: white; padding: 12px 24px; border-radius: 99px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); font-weight: 600;
      opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50;
      display: flex; align-items: center; gap: 8px;
    }
    .custom-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .post-actions svg { width: 24px; height: 24px; }
.post-actions .filled-heart { display: none; }
.post-actions .like.liked .outline-heart { display: none; }
.post-actions .like.liked .filled-heart { display: block; }
.post-actions .action-item:hover svg { transform: scale(1.1); transition: all 0.2s; }
    .action-item.repost:hover svg {
  stroke: #00ba7c;
  transform: scale(1.15);
}
    .action-item.share:hover svg {
  stroke: #0095f6;
  transform: translateY(-2px) scale(1.1);
  transition: all 0.2s ease;
}
    #image-modal {
  animation: fadeIn 0.2s ease-out;
}
#image-modal.show {
  display: flex !important;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
  </style>
</head>
<body>

<!-- ========== COMPOSER ========== -->
<div class="composer">
  <img id="my-avatar" class="avatar" src="https://ui-avatars.com/api/?background=random&color=fff" alt="avatar"/>
  <div class="flex-1">
    <textarea id="post-text" placeholder="What is happening?!"></textarea>
    <img id="media-preview" class="media-preview hidden" alt=""/>
    <div class="composer-actions">
      <div>
        <input type="file" id="file-input" accept="image/*" class="hidden"/>
        <label for="file-input" class="icon-btn" title="Add Photo">
          <span class="material-icons-outlined">image</span>
        </label>
      </div>
      <button id="post-btn" class="post-btn" disabled>
        <span id="btn-text">Post</span>
        <span id="btn-spinner" class="spinner hidden"></span>
      </button>
    </div>
  </div>
</div>

<!-- ========== FEED ========== -->
<main id="feed" class="feed"></main>

<!-- ========== LOAD MORE ========== -->
<div class="text-center p-4">
  <button id="load-more-btn" class="post-btn hidden">Load More Posts</button>
</div>

<!-- ========== CUSTOM ALERT MODAL ========== -->
<div id="custom-alert-overlay">
  <div class="custom-alert-box">
    <div class="custom-alert-title" id="custom-alert-title">Confirm</div>
    <div class="custom-alert-message" id="custom-alert-message">Are you sure?</div>
    <div class="custom-alert-buttons">
      <button class="custom-alert-btn cancel" id="custom-alert-cancel">Cancel</button>
      <button class="custom-alert-btn confirm" id="custom-alert-confirm">Delete</button>
    </div>
  </div>
</div>

<!-- ========== COMMENT BOTTOM SHEET ========== -->
<div id="comment-sheet-overlay">
  <div class="comment-sheet">
    <div class="comment-sheet-header">
      <span>Comments</span>
      <button class="comment-sheet-close material-icons-outlined" id="comment-sheet-close">close</button>
    </div>
    <div class="comment-sheet-list" id="comment-sheet-list"></div>
    <div class="comment-input-box">
      <textarea class="comment-input" id="comment-input" placeholder="Write a comment..." rows="1"></textarea>
      <button class="comment-send-btn" id="comment-send-btn">
        <span class="material-icons-outlined">send</span>
      </button>
    </div>
  </div>
</div>

  <!-- FULL SCREEN IMAGE MODAL -->
<div id="image-modal" class="fixed inset-0 bg-black z-50 hidden items-center justify-center" onclick="this.classList.add('hidden')">
  <img id="modal-image" class="max-w-full max-h-full object-contain" src="" alt="Full image">
  <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100">
    <span class="material-icons-outlined text-5xl">close</span>
  </button>
</div>

<script type="module">
/* ========== FIREBASE & AUTH ========== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, onChildAdded, onValue, get, endAt, serverTimestamp, startAfter } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app     = initializeApp(firebaseConfig);
const auth    = getAuth(app);
const db      = getDatabase(app);
let uid, uname, uavatar;

/* ========== SHORTCUTS ========== */
const $ = s => document.querySelector(s);
const postBtn = $('#post-btn'), textEl = $('#post-text'), previewEl = $('#media-preview'),
      fileInput = $('#file-input'), feedEl = $('#feed'), myAvatarEl = $('#my-avatar'),
      loadMoreBtn = $('#load-more-btn'), POST_LIMIT = 50;

let lastTimestamp = null, lastKey = null, initialLoadDone = false;

/* ========== THEME ========== */
if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.body.setAttribute('data-theme', 'dark');

/* ========== AUTH ========== */
onAuthStateChanged(auth, user => {
  if (!user) {
    signInAnonymously(auth);
    uid   = "guest_" + Math.random().toString(36).slice(2);
    uname = "Guest";
  } else {
    uid   = user.uid;
    uname = user.displayName || user.email?.split('@')[0] || 'User';
  }
  uavatar = user?.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
  myAvatarEl.src = uavatar;
  initFeed();
});

/* ========== FEED LOGIC ========== */
async function initFeed() {
  try {
    const postsRef = ref(db, 'posts');
    const q = query(postsRef, orderByChild('timestamp'), limitToLast(POST_LIMIT));
    const snap = await get(q);
    
    const rows = [];
    snap.forEach(c => rows.unshift({key: c.key, ...c.val()}));
    
    rows.forEach(p => feedEl.appendChild(renderPostCard(p)));
    
    const last = rows[rows.length-1];
    if (last) { lastTimestamp = last.timestamp; lastKey = last.key; }
    
    loadMoreBtn.classList.toggle('hidden', rows.length < POST_LIMIT);
    initialLoadDone = true;
    listenNew();
  } catch (e) {
    console.error(e);
    toast('Error loading posts');
  }
}
function listenNew() {
  const postsRef = ref(db, 'posts');
  // Listen for all new posts and filter on client side
  onChildAdded(postsRef, snap => {
    if (!initialLoadDone) return; // Don't duplicate initial posts
    
    const data = snap.val();
    if (!data || !data.timestamp) return;
    
    // Only add if newer than last loaded post
    if (!lastTimestamp || data.timestamp > lastTimestamp) {
      feedEl.prepend(renderPostCard({key: snap.key, ...data}));
      // Update lastTimestamp to include this new post
      lastTimestamp = data.timestamp;
    }
  });
}

loadMoreBtn.onclick = async () => {
  loadMoreBtn.disabled = true;
  const q   = query(ref(db, 'posts'), orderByChild('timestamp'), endAt(lastTimestamp), limitToLast(POST_LIMIT+1));
  const snap= await get(q);
  const rows= []; snap.forEach(c => rows.push({key: c.key, ...c.val()}));
  const uniq= rows.filter(p => p.key !== lastKey);
  if (!uniq.length) { toast('No more posts'); loadMoreBtn.classList.add('hidden'); return; }
  uniq.reverse(); uniq.forEach(p => feedEl.appendChild(renderPostCard(p)));
  const last = uniq[uniq.length-1];
  lastTimestamp = last.timestamp; lastKey = last.key;
  if (uniq.length < POST_LIMIT) loadMoreBtn.classList.add('hidden');
  loadMoreBtn.disabled = false;
};

/* ========== POSTING ========== */
let imageUrl = '', uploading = false;
function toggleBtn() { postBtn.disabled = uploading || (!textEl.value.trim() && !imageUrl); }

fileInput.onchange = e => {
  const file = e.target.files[0]; if (!file) return;
  const r = new FileReader();
  r.onload = ev => { previewEl.src = ev.target.result; previewEl.classList.remove('hidden'); };
  r.readAsDataURL(file);
  uploadToCloudinary(file);
};

function uploadToCloudinary(file) {
  const CLOUD_NAME = "dqkujefxj", UPLOAD_PRESET = "banter_box";
  uploading = true; toggleBtn();
  $('#btn-spinner').classList.remove('hidden'); $('#btn-text').classList.add('hidden');
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(res => { imageUrl = res.secure_url; toast('Image ready'); })
    .catch(err => { toast('Upload failed'); imageUrl = ''; previewEl.classList.add('hidden'); console.error(err); })
    .finally(() => { uploading = false; $('#btn-spinner').classList.add('hidden'); $('#btn-text').classList.remove('hidden'); toggleBtn(); });
}

postBtn.onclick = async () => {
  const text = textEl.value.trim();
  if (!text && !imageUrl) return;

  // Disable button while posting
  postBtn.disabled = true;
  $('#btn-spinner').classList.remove('hidden');
  $('#btn-text').classList.add('hidden');

  const newRef = push(ref(db, 'posts'));
  const key = newRef.key;
  const postData = {
    authorId: uid,
    authorName: uname,
    authorAvatar: uavatar,
    text,
    image: imageUrl,
    verified: false,
    likes: 0,
    replies: 0,
    reposts: 0,
    timestamp: serverTimestamp()  // Use server timestamp
  };

  try {
    await set(newRef, postData);

    // DO NOT manually prepend — the real-time listener (listenNew) will add it correctly
    textEl.value = '';
    imageUrl = '';
    previewEl.classList.add('hidden');
    toggleBtn();
    toast('Posted!');
  } catch (err) {
    console.error(err);
    toast('Error posting');
  } finally {
    $('#btn-spinner').classList.add('hidden');
    $('#btn-text').classList.remove('hidden');
    postBtn.disabled = false;
  }
};
textEl.oninput = () => { textEl.style.height = 'auto'; textEl.style.height = textEl.scrollHeight + 'px'; toggleBtn(); };

/* ========== CARD RENDERER + LIVE COUNTERS ========== */
function renderPostCard(p) {
  const isMine = p.authorId === uid;
  const div    = document.createElement('div');
  div.id       = `post-${p.key}`;
  div.className= 'post-card';

  /* ---------- HEADER ---------- */
  div.innerHTML = `
    <div class="post-header">
      <img src="${p.authorAvatar}" class="post-avatar">
      <div class="flex-1">
        <div class="user-meta">
          <span class="name">${esc(p.authorName)}</span>
          ${p.verified ? '<span class="material-icons verified-badge">verified</span>' : ''}
          <span class="handle">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
        </div>
        <div class="post-content">${esc(p.text)}</div>
       ${p.image ? `<img class="post-image cursor-pointer hover:opacity-90 transition" src="${p.image}" loading="lazy" onclick="openImageModal('${p.image}')">` : ''}
        ${p.repostOf ? `<div class="repost-banner">Re-posted from @${p.repostOf.authorName}</div>` : ''}
                <div class="post-actions">
          <div class="action-item reply" data-post="${p.key}" data-action="reply">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            <span id="replies-${p.key}">${p.replies||0}</span>
          </div>
          
          <div class="action-item repost" data-post="${p.key}" data-action="repost">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 2l4 4-4 4"/>
    <path d="M3 11v-1a4 4 0 0 1 4-4h14"/>
    <path d="M7 22l-4-4 4-4"/>
    <path d="M21 13v1a4 4 0 0 1-4 4H3"/>
  </svg>
  <span id="reposts-${p.key}">${p.reposts||0}</span>
</div>
          
          <div class="action-item like" data-post="${p.key}" data-action="like">
            <svg class="outline-heart" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <svg class="filled-heart hidden" width="24" height="24" viewBox="0 0 24 24" fill="#f91880" stroke="#f91880" stroke-width="0"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            <span id="likes-${p.key}">${p.likes||0}</span>
          </div>
          
         <div class="action-item share" data-post="${p.key}" data-action="share">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="22" y1="2" x2="11" y2="13"></line>
    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
  </svg>
</div>
          
          ${isMine ? `<div class="action-item delete-btn" data-post="${p.key}" data-action="delete">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
          </div>` : ''}
        </div>
      </div>
    </div>`;

  /* ---------- ATTACH LISTENERS ---------- */
  div.addEventListener('click', e => {
    const action = e.target.closest('[data-action]')?.dataset.action;
    const postId = e.target.closest('[data-post]')?.dataset.post;
    if (!action || !postId) return;
    e.stopPropagation();
    if (action === 'reply')   openComments(postId);
    if (action === 'repost')  doRepost(postId);
    if (action === 'like')    toggleLike(postId);
    if (action === 'share')   navigator.share?.({title:'Post',url:location.href}).catch(()=>toast('Link copied'));
    if (action === 'delete')  confirmDelete(postId);
  });

  /* ---------- LIVE COUNTERS ---------- */
  listenCounters(p.key);
  return div;
}

/* ---------- COUNTERS ---------- */
function listenCounters(postId) {
  onValue(ref(db, `likes/${postId}`),   s => { const c=s.size; $('#likes-'+postId).textContent=c;
                                                $('#like-icon-'+postId).textContent=s.hasChild(uid)?'favorite':'favorite_border'; });
  onValue(ref(db, `comments/${postId}`),s => $('#replies-'+postId).textContent=s.size);
  onValue(ref(db, `reposts/${postId}`), s => $('#reposts-'+postId).textContent=s.size);
}

/* ---------- LIKE ---------- */
async function toggleLike(postId) {
  const likeRef = ref(db, `likes/${postId}/${uid}`);
  const snap = await get(likeRef);
  if (snap.exists()) {
    await remove(likeRef);
    document.querySelector(`[data-post="${postId}"].like`)?.classList.remove('liked');
  } else {
    await set(likeRef, true);
    document.querySelector(`[data-post="${postId}"].like`)?.classList.add('liked');
  }
}

/* ---------- REPOST ---------- */
async function doRepost(postId) {
  const orig = (await get(ref(db, `posts/${postId}`))).val();
  if (!orig) return;
  const newRef = push(ref(db, 'posts'));
  await set(newRef, {
    authorId: uid, authorName: uname, authorAvatar: uavatar,
    text: orig.text, image: orig.image, verified: false,
    repostOf: {authorName: orig.authorName, key: postId},
    likes: 0, replies: 0, reposts: 0, timestamp: Date.now()
  });
  toast('Re-posted');
}

/* ---------- COMMENTS BOTTOM SHEET ---------- */
let currentPostId = null, commentsListener = null;
const commentOverlay = $('#comment-sheet-overlay'),
      commentList   = $('#comment-sheet-list'),
      commentInput  = $('#comment-input'),
      commentSendBtn= $('#comment-send-btn');

function openComments(postId) {
  currentPostId = postId;
  commentInput.value = '';
  commentList.innerHTML = '<div class="p-4 text-sm text-gray-500">Loading…</div>';
  commentOverlay.classList.add('show');

  if (commentsListener) commentsListener();
  commentsListener = onValue(ref(db, `comments/${postId}`), snap => {
    commentList.innerHTML = '';
    if (!snap.exists()) { commentList.innerHTML = '<div class="p-4 text-sm text-gray-500">No comments yet</div>'; return; }
    snap.forEach(c => {
      const v = c.val(), d = document.createElement('div'); d.className = 'comment-item';
      d.innerHTML = `<img src="${v.authorAvatar}" class="comment-avatar"><div class="comment-body"><div class="comment-name">${esc(v.authorName)}</div><div class="comment-text">${esc(v.text)}</div></div>`;
      commentList.appendChild(d);
    });
  });
}

$('#comment-sheet-close').onclick = closeComments;
commentOverlay.onclick = e => { if (e.target === commentOverlay) closeComments(); };

function closeComments() {
  commentOverlay.classList.remove('show');
  if (commentsListener) { commentsListener(); commentsListener = null; }
  currentPostId = null;
}

commentSendBtn.onclick = async () => {
  const text = commentInput.value.trim();
  if (!text || !currentPostId) return;
  await set(push(ref(db, `comments/${currentPostId}`)), { authorId: uid, authorName: uname, authorAvatar: uavatar, text, timestamp: Date.now() });
  commentInput.value = '';
  toast('Comment posted');
};

commentInput.oninput = () => commentSendBtn.disabled = !commentInput.value.trim();

/* ---------- DELETE CONFIRM ---------- */
let deleteKeyStore = null;
const alertOverlay = $('#custom-alert-overlay'), alertTitle = $('#custom-alert-title'),
      alertMessage = $('#custom-alert-message'), alertCancel = $('#custom-alert-cancel'), alertConfirm = $('#custom-alert-confirm');

function confirmDelete(key) {
  deleteKeyStore = key;
  alertTitle.textContent = 'Delete Post';
  alertMessage.textContent = 'Are you sure you want to delete this post?';
  alertOverlay.classList.add('show');
}
alertCancel.onclick = () => { deleteKeyStore = null; alertOverlay.classList.remove('show'); };
alertConfirm.onclick = async () => {
  if (!deleteKeyStore) return;
  const key = deleteKeyStore; deleteKeyStore = null; alertOverlay.classList.remove('show');
  try { await remove(ref(db, `posts/${key}`)); 

       // Instantly remove the post from the page (no refresh!)
    const postElement = document.getElementById(`post-${key}`);
    if (postElement) {
      postElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      postElement.style.opacity = '0';
      postElement.style.transform = 'translateY(-10px)';
      setTimeout(() => postElement.remove(), 320);
    }
       toast('Deleted'); }
  catch { toast('Error deleting'); }
};

/* ---------- TOAST ---------- */
function toast(msg) {
  const t = document.createElement('div'); t.className = 'custom-toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
}
const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
const timeAgo = ts => { if (!ts) return 'now'; const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`; };

function openImageModal(src) {
  const modal = $('#image-modal');
  $('#modal-image').src = src;
  modal.classList.remove('hidden');
  modal.classList.add('show');
}

// Close modal when clicking close button or background
$('#image-modal').addEventListener('click', function(e) {
  if (e.target === this || e.target.closest('button')) {
    this.classList.add('hidden');
    this.classList.remove('show');
  }
});

  
</script>
</body>
</html>
