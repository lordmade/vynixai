<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Prism.js for beautiful code highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>

  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-secondary); min-height: 100vh; margin: 0; touch-action: manipulation; }
    * { -webkit-tap-highlight-color: transparent; }
    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; background: var(--bg); border-bottom: 1px solid var(--border); }
    .menu-btn { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 9999px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .menu-btn:hover { background: var(--highlight); }
    .v-logo { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 4px; }
    .v-logo svg { width: 22px; height: 22px; fill: white; }
    .welcome-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; margin-top: 3rem; }
    .welcome-container h1 { font-size: 1.25rem; font-weight: 600; color: #1E1E1E; }
    .hidden { display: none; }
    .chat-input-container { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); display: flex; align-items: flex-start; width: 90%; max-width: 600px; background: var(--card-bg); border-radius: 1.5rem; padding: 0.5rem 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 0.5rem; }
    #chat-input { background: transparent; color: var(--text-primary); border: none; padding: 0.75rem 0.5rem; outline: none; font-size: 1rem; flex: 1; }
    #send-button { background: transparent; border: none; padding: 0.5rem; cursor: pointer; }
    #send-button svg { width: 1.5rem; height: 1.5rem; stroke: var(--text-primary); }
    #chat-messages { margin: 5rem 1rem 6rem 1rem; padding: 1rem; overflow-y: auto; max-height: calc(100vh - 11rem); -webkit-overflow-scrolling: touch; }

    .message {
      max-width: 70%;
      padding: 0.75rem 1.25rem;
      border-radius: 1.5rem;
      margin: 0.5rem 1rem;
      word-wrap: break-word;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease-out;
      position: relative;
      display: inline-block;
    }
    .message.user {
      background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE);
      color: #1E1E1E;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    .message.ai {
      background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748);
      color: var(--text-primary);
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
    }
    .message-time { font-size: 0.65rem; opacity: 0.6; margin-top: 0.35rem; text-align: right; }
    .message-time.ai { text-align: left; }

    /* Code blocks styling */
    pre {
      background: #2d2d2d !important;
      border-radius: 12px !important;
      padding: 16px !important;
      margin: 12px 0 !important;
      overflow-x: auto;
      border: 1px solid #444;
    }
    code { font-family: 'JetBrains Mono', Consolas, monospace !important; }

    /* Copy Button */
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(4px);
      border: none;
      border-radius: 8px;
      padding: 6px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message.ai:hover .copy-btn,
    .message.ai.touched .copy-btn { opacity: 1; }
    .copy-btn svg { width: 16px; height: 16px; stroke: white; }

    #api-status { position: absolute; right: 16px; top: 16px; width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s; }
    #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <main class="flex flex-col h-screen">
    <div class="header-container">
      <button id="menu-btn" class="menu-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>Menu</span>
      </button>
      <div class="v-logo">
        <svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg>
      </div>
      <div id="api-status"></div>
    </div>

    <div class="welcome-container" id="welcome-container">
      <h1>Hey there!</h1>
      <p class="mt-4 text-gray-600">Start chatting — replies are instant</p>
    </div>

    <div id="chat-messages"></div>

    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Type a message..." autofocus>
      <button id="send-button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M5 12l6-6m-6 6l6 6"/>
        </svg>
      </button>
    </div>

    <!-- Sidebar & Alert (same as before) -->
    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="v-logo"><svg viewBox="0 0 24 24"><path fill="#fff" d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/></svg></div>
        <h2 class="text-xl font-bold">Conversations</h2>
      </div>
      <button id="new-conv-sidebar" class="w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold">+ New Conversation</button>
      <div id="conv-list" class="mt-4"></div>
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="custom-alert">
      <h3 class="text-xl font-bold mb-4">Delete Conversation?</h3>
      <p>This cannot be undone.</p>
      <div id="alert-buttons" class="mt-6 flex gap-4 justify-center">
        <button id="alert-cancel" class="px-6 py-2 bg-gray-500 text-white rounded-lg">Cancel</button>
        <button id="alert-confirm" class="px-6 py-2 bg-red-500 text-white rounded-lg">Delete</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let xaiApiKey = null;
    let xaiEndpoint = "https://api.x.ai/v1/chat/completions";
    const statusDot = document.getElementById('api-status');

    const SYSTEM_PROMPT = `You are Vynix AI, a super helpful, witty, and friendly AI assistant created by the vynix.ai team.
Never mention Grok, xAI, Elon Musk, or any other model. You are Vynix AI — that's your full identity.
If asked who you are, say: "I'm Vynix AI, proudly built by the vynix.ai team ❤️".
When writing code, always use proper markdown code blocks with the correct language tag.`;

    async function initXaiConfig() {
      const remoteConfig = getRemoteConfig(app);
      remoteConfig.settings.minimumFetchIntervalMillis = 3600000;
      remoteConfig.defaultConfig = { xai_api_key: "", xai_endpoint: "https://api.x.ai/v1/chat/completions" };
      try {
        await fetchAndActivate(remoteConfig);
        xaiApiKey = getString(remoteConfig, 'xai_api_key').trim();
        const ep = getString(remoteConfig, 'xai_endpoint').trim();
        if (ep) xaiEndpoint = ep;
        if (xaiApiKey && xaiApiKey.length > 10) {
          statusDot.classList.add('connected');
        }
      } catch (err) { console.error(err); }
    }

    async function getReplyFromXai(userMessage, history = []) {
      if (!xaiApiKey) return "Vynix AI is waking up…";
      const messages = [{ role: "system", content: SYSTEM_PROMPT }];
      history.slice(-20).forEach(m => messages.push({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text }));
      messages.push({ role: "user", content: userMessage });

      const res = await fetch(xaiEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${xaiApiKey}` },
        body: JSON.stringify({ model: "grok-3", messages, temperature: 0.8, stream: false })
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      return data.choices[0].message.content.trim();
    }

    // Markdown → HTML with code highlighting
    function renderMarkdown(text) {
      return text
        .replace(/\*\*(.*?)\)*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/```([\w]*)\n([\s\S]*?)```/g, (match, lang, code) => {
          lang = lang || 'text';
          const highlighted = Prism.highlight(code.trim(), Prism.languages[lang] || Prism.languages.text, lang);
          return `<pre><code class="language-${lang}">${highlighted}</code></pre>`;
        })
        .replace(/\n/g, '<br>');
    }

    // Typing effect only on current bubble
    let currentTypingBubble = null;

    async function typeMessage(text, contentDiv) {
      contentDiv.innerHTML = '';
      const html = renderMarkdown(text);
      let i = 0;
      const rawText = text.replace(/```[\s\S]*?```/g, '```code block```'); // preserve code blocks as single unit
      while (i < rawText.length) {
        let char = rawText[i];
        if (rawText.substring(i, i+3) === '```') {
          const codeMatch = rawText.substring(i).match(/```([\w]*)\n([\s\S]*?)\n```/);
          if (codeMatch) {
            contentDiv.innerHTML += renderMarkdown(codeMatch[0]);
            i += codeMatch[0].length;
            continue;
          }
        }
        contentDiv.innerHTML += char === '\n' ? '<br>' : char.escapeHtml();
        contentDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
        await new Promise(r => setTimeout(r, 15 + Math.random() * 20));
        i++;
      }
      // Final render with full markdown
      contentDiv.innerHTML = renderMarkdown(text);
      Prism.highlightAllUnder(contentDiv);
    }

    String.prototype.escapeHtml = function() {
      const div = document.createElement('div');
      div.textContent = this;
      return div.innerHTML;
    };

    function addMessage(text, sender, timestamp = Date.now()) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;

      const content = document.createElement('div');
      content.className = 'content';

      const time = document.createElement('div');
      time.className = `message-time ${sender}`;
      time.textContent = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      div.appendChild(content);
      div.appendChild(time);

      if (sender === 'ai') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`;
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(text);
          copyBtn.innerHTML = '✓';
          setTimeout(() => copyBtn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`, 1500);
        };
        div.appendChild(copyBtn);

        div.addEventListener('touchstart', () => div.classList.add('touched'));
        div.addEventListener('touchend', () => setTimeout(() => div.classList.remove('touched'), 2000));
      }

      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;

      if (sender === 'ai' && text !== "Typing...") {
        currentTypingBubble = content;
        typeMessage(text, content);
      } else if (text !== "Typing...") {
        content.innerHTML = sender === 'ai' ? renderMarkdown(text) : text.replace(/\n/g, '<br>');
        if (sender === 'ai') Prism.highlightAllUnder(content);
      }
    }

    const el = { /* all elements same as before */ };
    let messageHistory = [], currentConvId = null, userId = null;

    // ... (all your previous functions: send(), startNewConversation, etc. remain exactly the same)

    async function send() {
      const text = el.input.value.trim();
      if (!text) return;
      if (!currentConvId) startNewConversation();

      addMessage(text, 'user');
      saveMessage(text, 'user');
      messageHistory.push({ sender: 'user', text });

      el.input.value = '';
      addMessage("Typing...", 'ai');

      const reply = await getReplyFromXai(text, messageHistory);
      el.messages.lastElementChild.remove();
      addMessage(reply, 'ai');
      messageHistory.push({ sender: 'ai', text: reply });
      saveMessage(reply, 'ai');
    }

    // ... rest of your code (sidebar, auth, etc.) unchanged

    onAuthStateChanged(auth, user => {
      if (user) {
        loadUserData(user.uid);
        initXaiConfig();
      } else signInAnonymously(auth);
    });
  </script>
</body>
</html>
