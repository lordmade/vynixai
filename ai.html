<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix ‚Äì Home</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg: #ffffff; --card: #f7f9fa; --text: #0f1419; --text2: #536471; --border: #e1e8ed; --accent: #ff2a6d; }
    [data-theme="dark"] { --bg: #000000; --card: #16181c; --text: #e7e9ea; --text2: #71767b; --border: #2f3336; }
    body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; margin: 0; }
    .composer { display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--border); background: var(--bg); }
    .composer img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    textarea { flex: 1; background: transparent; border: none; outline: none; font-size: 20px; resize: none; color: var(--text); }
    .media-preview { max-width: 100%; border-radius: 12px; margin-top: 12px; }
    .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
    .icon-btn { background: none; border: none; color: var(--text2); font-size: 24px; cursor: pointer; padding: 8px; border-radius: 50%; }
    .icon-btn:hover { background: #ff2a6d15; color: var(--accent); }
    .post-btn { background: var(--accent); color: white; border: none; border-radius: 999px; padding: 10px 24px; font-weight: bold; cursor: pointer; }
    .post-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .spinner { width: 18px; height: 18px; border: 2px solid #ffffff50; border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .feed { padding-bottom: 80px; }
    .post-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; margin: 12px 16px; padding: 16px; }
    .post-header { display: flex; gap: 12px; align-items: center; }
    .post-header img { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }
    .name { font-weight: bold; font-size: 15px; }
    .handle { color: var(--text2); font-size: 15px; }
    .post-body { margin-top: 8px; font-size: 15px; white-space: pre-wrap; }
    .post-image { max-width: 100%; border-radius: 12px; margin-top: 12px; }
    .post-footer { margin-top: 16px; display: flex; justify-content: space-between; color: var(--text2); font-size: 14px; }
    .post-footer span { cursor: pointer; padding: 8px; border-radius: 50%; }
    .post-footer span:hover { background: #ff2a6d15; color: var(--accent); }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #ff2a6d; color: white; padding: 12px 24px; border-radius: 50px; z-index: 1000; animation: toast 3s forwards; }
    @keyframes toast { 0%,100% { opacity:0; transform:translateX(-50%) translateY(20px) } 15%,85% { opacity:1; transform:translateX(-50%) translateY(0) } }
  </style>
</head>
<body>

  <!-- Composer -->
  <div class="composer">
    <img id="myAvatar" src="https://ui-avatars.com/api/?background=05d9e8&color=fff&name=U">
    <div style="flex:1">
      <textarea id="postText" placeholder="What's happening?" rows="3"></textarea>
      <img id="preview" class="media-preview hidden" alt="Preview">
      <div class="actions">
        <div>
          <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
          <label for="fileInput" class="icon-btn material-icons">image</label>
        </div>
        <button id="postBtn" class="post-btn" disabled>
          <span id="btnText">Post</span>
          <div id="spinner" class="spinner hidden"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Feed -->
  <main id="feed" class="feed"></main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, serverTimestamp, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });

    const auth = getAuth(app);
    const db = getDatabase(app);

    const postBtn = document.getElementById('postBtn');
    const postText = document.getElementById('postText');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('fileInput');
    const myAvatar = document.getElementById('myAvatar');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const feed = document.getElementById('feed');

    let currentUser = null;
    let mediaUrl = '';
    let uploading = false;

    // Check login
    onAuthStateChanged(auth, user => {
      if (!user) {
        location.href = 'login.html';
        return;
      }
      currentUser = user;
      myAvatar.src = user.photoURL || `https://ui-avatars.com/api/?background=05d9e8&color=fff&name=${encodeURIComponent(user.displayName || user.email[0])}`;
      loadPosts();
    });

    // Enable/disable post button
    const updateButton = () => {
      postBtn.disabled = uploading || (!postText.value.trim() && !mediaUrl);
    };
    postText.addEventListener('input', updateButton);

    // Media upload
    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.classList.remove('hidden'); };
      reader.readAsDataURL(file);
      uploadToCloudinary(file);
    };

    function uploadToCloudinary(file) {
      uploading = true;
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      updateButton();

      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'vynix_posts');

      fetch('https://api.cloudinary.com/v1_1/dk5d7xkhz/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          mediaUrl = data.secure_url;
          toast('Media ready!');
        })
        .catch(() => toast('Upload failed'))
        .finally(() => {
          uploading = false;
          btnText.classList.remove('hidden');
          spinner.classList.add('hidden');
          updateButton();
        });
    }

    // Post
    postBtn.onclick = async () => {
      if (postBtn.disabled) return;
      const text = postText.value.trim();
      if (!text && !mediaUrl) return;

      const newPostRef = push(ref(db, 'posts'));
      await set(newPostRef, {
        authorId: currentUser.uid,
        authorName: currentUser.displayName || currentUser.email.split('@')[0],
        authorAvatar: currentUser.photoURL || myAvatar.src,
        text,
        image: mediaUrl || '',
        likes: 0, reposts: 0, replies: 0,
        timestamp: serverTimestamp()
      });

      postText.value = '';
      mediaUrl = '';
      preview.classList.add('hidden');
      fileInput.value = '';
      updateButton();
      toast('Posted!');
    };

    // Load posts
    function loadPosts() {
      const postsRef = query(ref(db, 'posts'), orderByChild('timestamp'));
      onValue(postsRef, snap => {
        const posts = [];
        snap.forEach(child => {
          const p = child.val();
          if (p.timestamp) posts.push({ id: child.key, ...p });
        });
        posts.sort((a, b) => b.timestamp - a.timestamp);
        feed.innerHTML = '';
        posts.forEach(p => feed.appendChild(createCard(p)));
      });
    }

    function createCard(p) {
      const div = document.createElement('div');
      div.className = 'post-card';
      const ago = timeAgo(p.timestamp);
      div.innerHTML = `
        <div class="post-header">
          <img src="${p.authorAvatar}">
          <div>
            <div class="name">${escape(p.authorName)}</div>
            <div class="handle">@\( {p.authorName.replace(/\s/g,'').toLowerCase()} ¬∑ \){ago}</div>
          </div>
        </div>
        <div class="post-body">${escape(p.text)}</div>
        \( {p.image ? `<img class="post-image" src=" \){p.image}" loading="lazy">` : ''}
        <div class="post-footer">
          <span>üí¨ ${p.replies || 0}</span>
          <span>üîÅ ${p.reposts || 0}</span>
          <span>‚ù§Ô∏è ${p.likes || 0}</span>
          <span>üì§</span>
        </  </div>
      `;
      return div;
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'toast';
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    function escape(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function timeAgo(ts) {
      const sec = Math.floor((Date.now() - ts) / 1000);
      if (sec < 60) return sec + 's';
      if (sec < 3600) return Math.floor(sec/60) + 'm';
      if (sec < 86400) return Math.floor(sec/3600) + 'h';
      return Math.floor(sec/86400) + 'd';
    }
  </script>
</body>
</html>
