<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI - Emergency Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    :root {
      --primary-purple: #6D28D9;
      --secondary-teal: #06B6D4;
      --danger-red: #DC2626;
      --text-dark: #111827;
      --text-light: #6B7280;
      --border: #D1D5DB;
      --white: #fff;
      --background: #F9FAFB;
      --card-background: #fff;
      --text-dark-dark: #E5E7EB;
      --text-light-dark: #9CA3AF;
      --border-dark: #374151;
      --white-dark: #1F2937;
      --highlight: #F3F4F6;
      --focus-ring: #8B5CF6;
    }

    [data-theme="dark"] {
      --background: #111827;
      --text-dark: var(--text-dark-dark);
      --text-light: var(--text-light-dark);
      --border: var(--border-dark);
      --white: var(--white-dark);
      --card-background: #1F2937;
      --highlight: #374151;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: background 0.3s ease, opacity 0.3s ease;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -webkit-touch-callout: none;
    }

    .transition-base {
      transition: all 0.3s ease;
    }

    .top-bar {
      background: linear-gradient(90deg, var(--primary-purple), var(--secondary-teal));
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    .title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--white);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--white);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }

    .theme-toggle:hover, .theme-toggle:focus {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      outline: 2px solid var(--focus-ring);
    }

    .theme-toggle svg {
      width: 24px;
      height: 24px;
    }

    .chat-container {
      width: 100%;
      max-width: none;
      margin: 5rem 0 6rem 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 7rem);
      box-sizing: border-box;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding-bottom: 5rem;
    }

    .message {
      display: flex;
      flex-direction: column;
      max-width: 80%;
      align-items: flex-start;
    }

    .message.ai {
      align-self: flex-start;
      align-items: flex-start;
    }

    .message.user {
      align-self: flex-end;
      align-items: flex-end;
    }

    .message-content {
      background: var(--white);
      padding: 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      max-width: 100%;
      word-wrap: break-word;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .message.user .message-content {
      background: linear-gradient(45deg, var(--primary-purple), var(--secondary-teal));
      color: var(--white);
      border: none;
    }

    [data-theme="dark"] .message-content {
      background: var(--highlight);
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary-purple), var(--secondary-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
      color: var(--white);
      flex-shrink: 0;
      overflow: hidden;
    }

    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .message-body {
      flex: 1;
    }

    .message-header {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .message.user .message-header {
      color: var(--white);
    }

    .verified-icon {
      width: 16px;
      height: 16px;
    }

    .message-timestamp {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }

    .message.user .message-timestamp {
      color: var(--white-dark);
    }

    .message-actions {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      align-self: flex-end;
    }

    .message.ai .message-actions {
      align-self: flex-start;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.2s ease, transform 0.2s ease;
    }

    .action-btn:hover {
      color: var(--primary-purple);
      transform: scale(1.1);
    }

    .action-btn.active {
      color: var(--secondary-teal);
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
    }

    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--text-dark);
      border-radius: 50%;
      animation: typing 1s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 100% { opacity: 0.3; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-2px); }
    }

    .chat-input-container {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      max-width: none;
      width: calc(100% - 2rem);
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--card-background);
      border: 1px solid var(--border);
      border-radius: 9999px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 20;
    }

    .chat-input {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 9999px;
      font-size: 0.95rem;
      color: var(--text-dark);
      background: transparent;
      outline: none;
      transition: box-shadow 0.3s ease;
    }

    .chat-input:focus {
      box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.2);
    }

    .send-button {
      padding: 0.75rem;
      background: linear-gradient(45deg, var(--primary-purple), var(--secondary-teal));
      color: var(--white);
      border: none;
      border-radius: 9999px;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .send-button:hover,
    .send-button:focus {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      outline: 2px solid var(--focus-ring);
    }

    .send-button svg {
      width: 20px;
      height: 20px;
    }

    .conversation-sidebar {
      position: fixed;
      top: 64px;
      left: 0;
      width: 60px;
      height: calc(100vh - 64px);
      background: var(--card-background);
      border-right: 1px solid var(--border);
      z-index: 20;
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
    }

    .conversation-sidebar:hover {
      width: 350px;
    }

    .conversation-sidebar.active {
      transform: translateX(0);
      width: 100%;
      max-width: 280px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      visibility: hidden;
    }

    .conversation-sidebar:hover .sidebar-header {
      visibility: visible;
    }

    .user-avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .user-avatar-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary-purple), var(--secondary-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--white);
      overflow: hidden;
    }

    .user-avatar-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .user-avatar-name {
      display: none;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .conversation-sidebar:hover .user-avatar {
      justify-content: flex-start;
      gap: 0.75rem;
    }

    .conversation-sidebar:hover .user-avatar-name {
      display: block;
    }

    .sidebar-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .close-sidebar-btn {
      background: none;
      border: none;
      color: var(--primary-purple);
      cursor: pointer;
      display: none;
    }

    .close-sidebar-btn:hover,
    .close-sidebar-btn:focus {
      transform: scale(1.2);
      outline: 2px solid var(--focus-ring);
    }

    .conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .conversation-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      color: var(--text-dark);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .conversation-item .conversation-title {
      display: none;
      flex: 1;
    }

    .conversation-sidebar:hover .conversation-item .conversation-title {
      display: inline;
    }

    .conversation-item:hover,
    .conversation-item:focus {
      background: var(--highlight);
      outline: none;
    }

    .conversation-item:last-child {
      border-bottom: none;
    }

    .conversation-icon {
      width: 20px;
      height: 20px;
      stroke: var(--primary-purple);
    }

    .delete-convo-btn {
      background: none;
      border: none;
      color: var(--danger-red);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .conversation-sidebar:hover .delete-convo-btn,
    .conversation-sidebar.active .delete-convo-btn {
      display: flex;
    }

    .delete-convo-btn:hover {
      transform: scale(1.1);
    }

    .new-conversation-button {
      background: linear-gradient(45deg, var(--primary-purple), var(--secondary-teal));
      color: var(--white);
      border: none;
      border-radius: 8px;
      padding: 0.75rem;
      margin: 1rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .new-conversation-button .button-text {
      display: none;
    }

    .conversation-sidebar:hover .new-conversation-button .button-text {
      display: inline;
    }

    .new-conversation-button:hover,
    .new-conversation-button:focus {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      outline: 2px solid var(--focus-ring);
    }

    .fab {
      position: fixed;
      bottom: 5rem;
      right: 1.5rem;
      background: linear-gradient(45deg, var(--primary-purple), var(--secondary-teal));
      color: var(--white);
      border: none;
      border-radius: 9999px;
      width: 80px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 40;
      animation: pulse 2s infinite ease-in-out;
    }

    .fab:hover,
    .fab:focus {
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      outline: 2px solid var(--focus-ring);
    }

    .fab svg {
      width: 24px;
      height: 24px;
    }

    .welcome-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-dark);
      text-align: center;
      z-index: 10;
      transition: opacity 0.3s ease;
    }

    .welcome-message.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-background);
      padding: 1.5rem;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
      z-index: 30;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .bottom-sheet.active {
      transform: translateY(0);
    }

    .bottom-sheet-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .bottom-sheet-content p {
      font-size: 1rem;
      color: var(--text-dark);
      text-align: center;
      margin: 0;
    }

    .upgrade-button {
      background: linear-gradient(45deg, var(--primary-purple), var(--secondary-teal));
      color: var(--white);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .upgrade-button:hover,
    .upgrade-button:focus {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      outline: 2px solid var(--focus-ring);
    }

    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .dialog-overlay.active {
      display: flex;
    }

    .dialog-box {
      background: var(--card-background);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .dialog-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1rem;
    }

    .dialog-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .dialog-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .dialog-btn:hover, .dialog-btn:focus {
      transform: scale(1.05);
      outline: 2px solid var(--focus-ring);
    }

    .dialog-confirm {
      background: var(--primary-purple);
      color: var(--white);
    }

    .dialog-cancel {
      background: var(--border);
      color: var(--text-dark);
    }

    .emergency-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .emergency-form select,
    .emergency-form input {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      color: var(--text-dark);
      background: var(--white);
      width: 100%;
      box-sizing: border-box;
    }

    .emergency-form select:focus,
    .emergency-form input:focus {
      outline: 2px solid var(--focus-ring);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @media (max-width: 767px) {
      .top-bar { padding: 0.75rem; }
      .title { font-size: 1.25rem; }
      .theme-toggle svg { width: 20px; height: 20px; }
      .chat-container { padding: 0.5rem; margin: 4.5rem 0; }
      .message-avatar { width: 28px; height: 28px; font-size: 0.9rem; }
      .message-content { padding: 0.5rem; font-size: 0.9rem; }
      .message-header { font-size: 0.8rem; }
      .message-timestamp { font-size: 0.7rem; }
      .chat-input { padding: 0.5rem; font-size: 0.9rem; }
      .send-button { padding: 0.5rem; }
      .send-button svg { width: 16px; height: 16px; }
      .chat-input-container { width: calc(100% - 1rem); padding: 0.25rem; left: 0.5rem; right: 0.5rem; }
      .conversation-sidebar {
        top: 60px;
        width: 100%;
        max-width: 280px;
        height: calc(100vh - 60px);
        transform: translateX(-100%);
        left: 0;
      }
      .conversation-sidebar:hover {
        width: 100%;
      }
      .conversation-sidebar.active {
        transform: translateX(0);
      }
      .conversation-sidebar.active .sidebar-header,
      .conversation-sidebar.active .user-avatar-name,
      .conversation-sidebar.active .conversation-item .conversation-title,
      .conversation-sidebar.active .new-conversation-button .button-text,
      .conversation-sidebar.active .delete-convo-btn {
        display: block;
      }
      .conversation-sidebar.active .user-avatar {
        justify-content: flex-start;
        gap: 0.75rem;
      }
      .close-sidebar-btn {
        display: block;
      }
      .fab {
        bottom: 4.5rem;
        right: 1rem;
        width: 64px;
        height: 36px;
      }
      .fab svg {
        width: 20px;
        height: 20px;
      }
      .user-avatar-img { width: 32px; height: 32px; font-size: 1rem; }
      .user-avatar-name { font-size: 0.875rem; }
      .welcome-message {
        font-size: 1.25rem;
      }
      .bottom-sheet {
        padding: 1rem;
      }
      .bottom-sheet-content p {
        font-size: 0.9rem;
      }
      .upgrade-button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      .typing-dot { width: 5px; height: 5px; }
      .dialog-box {
        max-width: 90%;
      }
    }

    @media (min-width: 768px) {
      .chat-container {
        width: calc(100% - 80px);
        margin-left: 60px;
        margin-right: 1rem;
        padding: 1rem;
      }
      .chat-container.sidebar-expanded {
        width: calc(100% - 370px);
        margin-left: 350px;
      }
      .chat-input-container {
        width: calc(100% - 100px);
        left: 70px;
        right: 1rem;
      }
      .chat-container.sidebar-expanded .chat-input-container {
        width: calc(100% - 390px);
        left: 360px;
      }
      .conversation-sidebar {
        position: fixed;
        top: 64px;
        left: 0;
        width: 60px;
        height: calc(100vh - 64px);
        transform: none;
        display: flex;
      }
      .conversation-sidebar:hover {
        width: 350px;
      }
      .fab {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar" role="banner">
    <h1 class="title">Vynix AI - Emergency Assistant</h1>
    <button class="theme-toggle transition-base" id="theme-toggle" aria-label="Toggle dark mode">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </div>

  <div class="chat-container" id="chat-container">
    <div class="welcome-message" id="welcome-message">Welcome to Vynix AI. I'm here to assist with emergencies or answer your questions.</div>
    <div class="chat-messages" id="chat-messages" aria-live="polite"></div>
    <div id="emergency-announcements" aria-live="assertive" class="sr-only"></div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" class="chat-input" placeholder="Report an emergency or ask a question..." aria-label="Type to report an emergency or ask a question" aria-describedby="chat-input-desc" maxlength="500">
      <div id="chat-input-desc" class="sr-only">Enter your message to report an emergency or ask Vynix AI a question. Press Enter to send.</div>
      <button class="send-button transition-base" id="send-button" aria-label="Send message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <div id="conversation-sidebar" class="conversation-sidebar" role="complementary" aria-label="Previous conversations">
    <div class="user-avatar">
      <div class="user-avatar-img" id="user-avatar-img">
        <span id="user-avatar-initial">U</span>
      </div>
      <span class="user-avatar-name" id="user-avatar-name">User</span>
    </div>
    <div class="sidebar-header">
      <h2 class="sidebar-title">Conversations</h2>
      <button class="close-sidebar-btn transition-base" id="close-sidebar-btn" aria-label="Close conversations sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div id="conversation-list" class="conversation-list"></div>
    <button class="new-conversation-button transition-base" id="new-conversation-button" aria-label="Start new conversation">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        <path d="M12 8v4m-2 2h4"/>
      </svg>
      <span class="button-text">New Chat</span>
    </button>
  </div>

  <button class="fab transition-base" id="new-conversation-fab" aria-label="Start new conversation" title="Start new conversation">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      <path d="M12 8v4m-2 2h4"/>
    </svg>
  </button>

  <div id="bottom-sheet" class="bottom-sheet">
    <div class="bottom-sheet-content">
      <p id="bottom-sheet-message">You've reached the free query limit of 10. Please wait 15 minutes or upgrade to SuperVynix for unlimited queries.</p>
      <button class="upgrade-button transition-base" id="upgrade-button" aria-label="Upgrade to SuperVynix">Upgrade to SuperVynix</button>
    </div>
  </div>

  <div id="delete-dialog" class="dialog-overlay">
    <div class="dialog-box" role="dialog" aria-labelledby="delete-dialog-title">
      <h3 id="delete-dialog-title" class="dialog-title">Delete Conversation?</h3>
      <div class="dialog-buttons">
        <button class="dialog-btn dialog-confirm" id="dialog-confirm">Delete</button>
        <button class="dialog-btn dialog-cancel" id="dialog-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <div id="emergency-confirm-dialog" class="dialog-overlay">
    <div class="dialog-box" role="dialog" aria-labelledby="emergency-dialog-title" aria-modal="true">
      <h3 id="emergency-dialog-title" class="dialog-title">Confirm Emergency Details</h3>
      <form class="emergency-form">
        <label for="emergency-type" class="sr-only">Emergency Type</label>
        <select id="emergency-type" aria-label="Select emergency type">
          <option value="">Select Emergency Type</option>
          <option value="Police Emergency">Police Emergency</option>
          <option value="Ambulance">Ambulance</option>
          <option value="Fire Fighter">Fire Fighter</option>
          <option value="Environmental Hazard">Environmental Hazard</option>
        </select>
        <label for="emergency-location" class="sr-only">Location</label>
        <input type="text" id="emergency-location" placeholder="Enter location or leave blank for current location" aria-label="Enter emergency location">
      </form>
      <div class="dialog-buttons">
        <button class="dialog-btn dialog-confirm" id="emergency-confirm-btn">Confirm</button>
        <button class="dialog-btn dialog-cancel" id="emergency-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, get, remove, off } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e",
  measurementId: "G-V4W97VMSKL"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const remoteConfig = getRemoteConfig(app);
remoteConfig.settings = {
  minimumFetchIntervalMillis: 3600000,
  fetchTimeoutMillis: 60000
};
remoteConfig.defaultConfig = { gemini_api_key: "" };

const chatMessages = document.getElementById("chat-messages");
const emergencyAnnouncements = document.getElementById("emergency-announcements");
const chatInput = document.getElementById("chat-input");
const sendButton = document.getElementById("send-button");
const themeToggle = document.getElementById("theme-toggle");
const conversationSidebar = document.getElementById("conversation-sidebar");
const newConversationButton = document.getElementById("new-conversation-button");
const newConversationFab = document.getElementById("new-conversation-fab");
const closeSidebarBtn = document.getElementById("close-sidebar-btn");
const chatContainer = document.getElementById("chat-container");
const welcomeMessage = document.getElementById("welcome-message");
const bottomSheet = document.getElementById("bottom-sheet");
const upgradeButton = document.getElementById("upgrade-button");
const userAvatarImg = document.getElementById("user-avatar-img");
const userAvatarInitial = document.getElementById("user-avatar-initial");
const userAvatarName = document.getElementById("user-avatar-name");
const deleteDialog = document.getElementById("delete-dialog");
const dialogConfirm = document.getElementById("dialog-confirm");
const dialogCancel = document.getElementById("dialog-cancel");
const emergencyConfirmDialog = document.getElementById("emergency-confirm-dialog");
const emergencyConfirmBtn = document.getElementById("emergency-confirm-btn");
const emergencyCancelBtn = document.getElementById("emergency-cancel-btn");
const emergencyTypeSelect = document.getElementById("emergency-type");
const emergencyLocationInput = document.getElementById("emergency-location");

const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';
const QUERY_LIMIT = 10;
const QUERY_WINDOW_MS = 15 * 60 * 1000;
let queryTimestamps = JSON.parse(localStorage.getItem('queryTimestamps') || '[]');
let isSuperVynix = false;
let currentConversationId = null;
let userLocation = null;
let displayUser = null;
let pendingDeleteId = null;
let cachedGeminiKey = null;
let conversationListener = null;
let messageListener = null;
let incidentListeners = new Map();
let pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };

const AI_AVATAR_URL = 'https://i.postimg.cc/ZR0jj3Yr/Black-and-White-Minimalist-Simple-Modern-Technology-AI-Logo-20250824-182710-0000.png';
const NOTIFICATION_SOUND_URL = 'https://freesound.org/data/previews/316/316847_4939433-lq.mp3';

// Show toast notification
function showToast(message, type = 'error') {
  const toast = document.createElement("div");
  toast.className = `fixed top-4 right-4 p-4 rounded shadow text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
  toast.textContent = message;
  toast.setAttribute('role', 'alert');
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Play notification sound
function playNotificationSound() {
  const audio = new Audio(NOTIFICATION_SOUND_URL);
  audio.play().catch(() => console.error("Failed to play notification sound"));
}

// Fetch user data
async function fetchUserData(userId) {
  try {
    const userRef = ref(db, `users/${userId}`);
    const userSnap = await get(userRef);
    if (userSnap.exists()) return userSnap.val();
    const defaultUser = {
      displayName: "User",
      photoURL: null,
      email: "unknown@example.com",
      mobileNumber: null,
      subscription: "free"
    };
    await set(userRef, defaultUser);
    return defaultUser;
  } catch (error) {
    showToast("Failed to fetch user data.");
    return { displayName: "User", photoURL: null, email: "unknown@example.com", mobileNumber: null, subscription: "free" };
  }
}

// Check auth state
async function checkAuthState() {
  try {
    await setPersistence(auth, browserLocalPersistence);
    return await new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        showToast("Authentication timed out.");
        document.body.classList.add("fade-out");
        setTimeout(() => window.location.href = "signup.html", 500);
        reject(new Error("Authentication timed out"));
      }, 15000);

      onAuthStateChanged(auth, async (user) => {
        clearTimeout(timeout);
        if (!user) {
          document.body.classList.add("fade-out");
          setTimeout(() => window.location.href = "signup.html", 500);
          resolve(null);
        } else {
          const userData = await fetchUserData(user.uid);
          const displayUser = {
            uid: user.uid,
            displayName: userData?.displayName || user.email?.split("@")[0] || "User",
            photoURL: userData?.photoURL || user.photoURL,
            email: user.email || "unknown@example.com",
            mobileNumber: userData?.mobileNumber || null,
            subscription: userData?.subscription || "free"
          };
          resolve(displayUser);
        }
      }, reject);
    });
  } catch (error) {
    showToast("Authentication setup failed.");
    return null;
  }
}

// Setup user profile
function setupUserProfile(displayUser) {
  userAvatarName.textContent = displayUser.displayName;
  userAvatarInitial.textContent = displayUser.displayName?.charAt(0).toUpperCase() || "U";
  if (displayUser.photoURL) {
    const img = document.createElement("img");
    img.src = displayUser.photoURL;
    img.alt = `${displayUser.displayName}'s avatar`;
    userAvatarImg.innerHTML = "";
    userAvatarImg.appendChild(img);
  }
  isSuperVynix = displayUser.subscription === "supervynix";
}

// Get user location
async function getUserLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      showToast("Location services not supported.");
      resolve(null);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude } = position.coords;
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?access_token=${MAPBOX_ACCESS_TOKEN}`
          );
          if (!response.ok) {
            showToast("Failed to fetch location data.");
            resolve({ latitude, longitude, placeName: "Current Location" });
            return;
          }
          const data = await response.json();
          const placeName = data.features?.[0]?.place_name || "Current Location";
          resolve({ latitude, longitude, placeName });
        } catch (error) {
          showToast("Error fetching location name.");
          resolve({ latitude, longitude, placeName: "Current Location" });
        }
      },
      () => {
        showToast("Location access denied.");
        resolve(null);
      },
      { timeout: 10000, enableHighAccuracy: true }
    );
  });
}

// Encrypt coordinates
function encryptCoordinate(coord) {
  try {
    const key = CryptoJS.enc.Utf8.parse("your-encryption-key-here");
    const iv = CryptoJS.enc.Utf8.parse("your-iv-here");
    const encrypted = CryptoJS.AES.encrypt(coord.toString(), key, { iv }).toString();
    return encrypted;
  } catch (error) {
    console.error("Encryption error:", error);
    return null;
  }
}

// Theme toggle
themeToggle.addEventListener('click', () => {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
});

// Sidebar hover for desktop
conversationSidebar.addEventListener("mouseenter", () => {
  if (window.innerWidth >= 768) chatContainer.classList.add("sidebar-expanded");
});
conversationSidebar.addEventListener("mouseleave", () => {
  if (window.innerWidth >= 768) chatContainer.classList.remove("sidebar-expanded");
});

// Sidebar toggle for mobile
newConversationFab.addEventListener("click", () => {
  conversationSidebar.classList.toggle("active");
  bottomSheet.classList.remove("active");
  emergencyConfirmDialog.classList.remove("active");
});
closeSidebarBtn.addEventListener("click", () => {
  conversationSidebar.classList.remove("active");
});

// Upgrade button
upgradeButton.addEventListener("click", () => {
  window.location.href = "https://x.ai/grok";
});

// Delete dialog handling
function showDeleteDialog(convoId) {
  pendingDeleteId = convoId;
  deleteDialog.classList.add("active");
  dialogConfirm.focus();
}
dialogCancel.addEventListener("click", () => {
  deleteDialog.classList.remove("active");
  pendingDeleteId = null;
  chatInput.focus();
});
dialogConfirm.addEventListener("click", async () => {
  deleteDialog.classList.remove("active");
  if (pendingDeleteId) {
    try {
      await remove(ref(db, `conversations/${pendingDeleteId}`));
      if (currentConversationId === pendingDeleteId) {
        chatMessages.innerHTML = "";
        welcomeMessage.classList.remove("hidden");
        currentConversationId = null;
      }
      showToast("Conversation deleted.", "success");
    } catch (error) {
      showToast("Failed to delete conversation.");
    }
    pendingDeleteId = null;
    chatInput.focus();
  }
});

// Emergency confirmation dialog
function showEmergencyConfirmDialog(suggestedType = '', suggestedLocation = '') {
  emergencyTypeSelect.value = suggestedType || '';
  emergencyLocationInput.value = suggestedLocation || (userLocation ? userLocation.placeName : '');
  emergencyConfirmDialog.classList.add("active");
  emergencyTypeSelect.focus();

  // Trap focus within dialog
  const focusableElements = emergencyConfirmDialog.querySelectorAll('select, input, button');
  const firstFocusable = focusableElements[0];
  const lastFocusable = focusableElements[focusableElements.length - 1];

  emergencyConfirmDialog.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      if (e.shiftKey && document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable.focus();
      } else if (!e.shiftKey && document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable.focus();
      }
    } else if (e.key === 'Escape') {
      emergencyCancelBtn.click();
    }
  });
}

emergencyCancelBtn.addEventListener("click", () => {
  emergencyConfirmDialog.classList.remove("active");
  emergencyTypeSelect.value = '';
  emergencyLocationInput.value = '';
  pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };
  chatInput.focus();
});

emergencyConfirmBtn.addEventListener("click", async () => {
  const emergencyType = emergencyTypeSelect.value;
  const locationText = emergencyLocationInput.value.trim() || (userLocation ? userLocation.placeName : "user's current location");
  if (!emergencyType) {
    showToast("Please select an emergency type.");
    return;
  }
  emergencyConfirmDialog.classList.remove("active");
  const location = locationText === userLocation?.placeName ? userLocation : await resolveLocation(locationText);
  if (!location) {
    await appendMessage("I couldn't determine the location. Please try again or use the SOS button.", "ai", "Vynix AI", currentConversationId);
    return;
  }
  const incidentId = await reportEmergency(emergencyType, location, currentConversationId);
  if (incidentId) {
    const response = `I'm here to help. A ${emergencyType} has been dispatched to ${location.placeName}. Please stay safe and provide any additional details if needed.`;
    await appendMessage(response, "ai", "Vynix AI", currentConversationId);
    emergencyAnnouncements.textContent = `Emergency reported: ${emergencyType} at ${location.placeName}.`;
  } else {
    await appendMessage("I encountered an issue reporting the emergency. Please try again or use the SOS button.", "ai", "Vynix AI", currentConversationId);
  }
  emergencyTypeSelect.value = '';
  emergencyLocationInput.value = '';
  pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };
  chatInput.focus();
});

emergencyConfirmDialog.addEventListener("keypress", (e) => {
  if (e.key === "Enter") emergencyConfirmBtn.click();
});

// Render message
function renderMessage(msg, messageId, conversationId) {
  const messageElement = document.createElement("div");
  messageElement.className = `message ${msg.sender}`;
  messageElement.setAttribute('role', 'listitem');
  const contentElement = document.createElement("div");
  contentElement.className = "message-content";
  const avatarElement = document.createElement("div");
  avatarElement.className = "message-avatar";
  if (msg.sender === "user" && displayUser.photoURL) {
    const img = document.createElement("img");
    img.src = displayUser.photoURL;
    img.alt = `${msg.displayName}'s avatar`;
    avatarElement.appendChild(img);
  } else if (msg.sender === "ai") {
    const img = document.createElement("img");
    img.src = AI_AVATAR_URL;
    img.alt = "Vynix AI avatar";
    avatarElement.appendChild(img);
  } else {
    avatarElement.textContent = msg.displayName.charAt(0).toUpperCase();
  }
  const bodyElement = document.createElement("div");
  bodyElement.className = "message-body";
  const headerElement = document.createElement("div");
  headerElement.className = "message-header";
  headerElement.textContent = msg.displayName;
  if (msg.sender === "ai") {
    const verifiedSpan = document.createElement("span");
    verifiedSpan.innerHTML = '<svg class="verified-icon" viewBox="0 0 24 24" fill="none" stroke="#1DA1F2" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M5 12l5 5l9-9"/></svg>';
    verifiedSpan.setAttribute('aria-label', 'Verified Vynix AI');
    headerElement.appendChild(verifiedSpan);
  }
  bodyElement.appendChild(headerElement);
  const textElement = document.createElement("p");
  textElement.textContent = msg.text;
  bodyElement.appendChild(textElement);
  const timestampElement = document.createElement("div");
  timestampElement.className = "message-timestamp";
  timestampElement.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  bodyElement.appendChild(timestampElement);
  contentElement.append(avatarElement, bodyElement);
  messageElement.appendChild(contentElement);

  const actionsElement = document.createElement("div");
  actionsElement.className = "message-actions";
  const copyBtn = document.createElement("button");
  copyBtn.className = "action-btn";
  copyBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';
  copyBtn.setAttribute("aria-label", "Copy message text");
  copyBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(msg.text).then(() => {
      copyBtn.style.color = "green";
      setTimeout(() => copyBtn.style.color = "", 1000);
      showToast("Text copied to clipboard.", "success");
    }).catch(() => showToast("Failed to copy text."));
  });
  actionsElement.appendChild(copyBtn);

  if (msg.sender === "ai") {
    const thumbsUpBtn = document.createElement("button");
    thumbsUpBtn.className = `action-btn ${msg.reactions?.thumbsUp ? 'active' : ''}`;
    thumbsUpBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3zM7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3"/></svg>';
    thumbsUpBtn.setAttribute("aria-label", "Thumbs up reaction");
    const thumbsDownBtn = document.createElement("button");
    thumbsDownBtn.className = `action-btn ${msg.reactions?.thumbsDown ? 'active' : ''}`;
    thumbsDownBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 003 3l4-9V2H5.72a2 2 0 00-2 1.7l-1.38 9a2 2 0 002 2.3zm7-13h3a2 2 0 012 2v7a2 2 0 01-2 2h-3"/></svg>';
    thumbsDownBtn.setAttribute("aria-label", "Thumbs down reaction");

    thumbsUpBtn.addEventListener("click", async () => {
      try {
        const active = thumbsUpBtn.classList.toggle("active");
        thumbsDownBtn.classList.remove("active");
        await set(ref(db, `conversations/${conversationId}/messages/${messageId}/reactions`), {
          thumbsUp: active,
          thumbsDown: false
        });
      } catch (error) {
        showToast("Failed to update reaction.");
      }
    });

    thumbsDownBtn.addEventListener("click", async () => {
      try {
        const active = thumbsDownBtn.classList.toggle("active");
        thumbsUpBtn.classList.remove("active");
        await set(ref(db, `conversations/${conversationId}/messages/${messageId}/reactions`), {
          thumbsUp: false,
          thumbsDown: active
        });
      } catch (error) {
        showToast("Failed to update reaction.");
      }
    });

    actionsElement.prepend(thumbsDownBtn, thumbsUpBtn);
  }

  messageElement.appendChild(actionsElement);
  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return messageElement;
}

// Append message with typing animation
async function appendMessage(text, sender, displayName, conversationId) {
  try {
    const messageId = push(ref(db, `conversations/${conversationId}/messages`)).key;
    await set(ref(db, `conversations/${conversationId}/messages/${messageId}`), {
      text,
      sender,
      displayName,
      timestamp: Date.now(),
      reactions: { thumbsUp: false, thumbsDown: false }
    });

    if (sender === "user") {
      renderMessage({ text, sender, displayName, timestamp: Date.now(), reactions: { thumbsUp: false, thumbsDown: false } }, messageId, conversationId);
    } else {
      const tempMsg = { text: '', sender, displayName, timestamp: Date.now(), reactions: { thumbsUp: false, thumbsDown: false } };
      const messageElement = renderMessage(tempMsg, messageId, conversationId);
      const textElement = messageElement.querySelector("p");

      const typingIndicator = document.createElement("div");
      typingIndicator.className = "typing-indicator";
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("span");
        dot.className = "typing-dot";
        typingIndicator.appendChild(dot);
      }
      textElement.appendChild(typingIndicator);

      await new Promise(resolve => setTimeout(resolve, 3000));
      let i = 0;
      const typeText = () => {
        if (i < text.length) {
          textElement.textContent = text.slice(0, i + 1);
          i++;
          setTimeout(typeText, 30);
        } else {
          typingIndicator.remove();
          textElement.textContent = text;
          playNotificationSound();
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      };
      typeText();
    }

    welcomeMessage.classList.add("hidden");
  } catch (error) {
    showToast("Failed to send message.");
  }
}

// Load conversation messages
function loadConversationMessages(conversationId) {
  if (messageListener) messageListener();
  currentConversationId = conversationId;
  chatMessages.innerHTML = "";
  emergencyAnnouncements.textContent = "";
  const messagesRef = ref(db, `conversations/${conversationId}/messages`);
  messageListener = () => onValue(messagesRef, (snapshot) => {
    chatMessages.innerHTML = "";
    if (snapshot.exists()) {
      const messages = snapshot.val();
      Object.entries(messages).forEach(([messageId, msg]) => {
        renderMessage(msg, messageId, conversationId);
      });
    }
  }, (error) => showToast("Error loading messages."));
  messageListener();
}

// Load conversations
function loadConversations(userId) {
  if (conversationListener) conversationListener();
  const conversationList = document.getElementById("conversation-list");
  const conversationsRef = ref(db, `conversations`);
  conversationListener = () => onValue(conversationsRef, (snapshot) => {
    conversationList.innerHTML = "";
    if (snapshot.exists()) {
      const conversations = snapshot.val();
      Object.entries(conversations)
        .filter(([_, convo]) => convo.userId === userId)
        .sort((a, b) => b[1].timestamp - a[1].timestamp)
        .forEach(([id, convo]) => {
          const item = document.createElement("div");
          item.className = "conversation-item";
          item.dataset.conversationId = id;
          item.setAttribute('role', 'button');
          item.setAttribute('aria-label', `Open conversation: ${convo.title || 'Untitled Chat'}`);
          item.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="conversation-icon">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <span class="conversation-title">${convo.title || 'Untitled Chat'}</span>
          `;
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-convo-btn";
          deleteBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>';
          deleteBtn.setAttribute("aria-label", "Delete conversation");
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            showDeleteDialog(id);
          });
          item.appendChild(deleteBtn);
          item.addEventListener("click", () => {
            loadConversationMessages(id);
            conversationSidebar.classList.remove("active");
          });
          conversationList.appendChild(item);
        });
    }
  }, (error) => showToast("Error loading conversations."));
  conversationListener();
}

// Update query limit timer
function updateQueryLimitTimer() {
  if (isSuperVynix) return;
  const now = Date.now();
  queryTimestamps = queryTimestamps.filter(ts => now - ts < QUERY_WINDOW_MS);
  if (queryTimestamps.length >= QUERY_LIMIT) {
    const timeLeft = QUERY_WINDOW_MS - (now - queryTimestamps[0]);
    if (timeLeft > 0) {
      const minutes = Math.floor(timeLeft / 60000);
      const seconds = Math.floor((timeLeft % 60000) / 1000);
      bottomSheet.querySelector("#bottom-sheet-message").textContent = `Query limit reached. Resets in ${minutes}m ${seconds}s.`;
      setTimeout(updateQueryLimitTimer, 1000);
    } else {
      queryTimestamps = [];
      localStorage.setItem('queryTimestamps', JSON.stringify(queryTimestamps));
      bottomSheet.classList.remove("active");
      showToast("Query limit reset.", "success");
    }
  }
}

// Check query limit
function checkQueryLimit() {
  if (isSuperVynix) return true;
  const now = Date.now();
  queryTimestamps = queryTimestamps.filter(ts => now - ts < QUERY_WINDOW_MS);
  if (queryTimestamps.length >= QUERY_LIMIT) {
    bottomSheet.classList.add("active");
    updateQueryLimitTimer();
    return false;
  }
  queryTimestamps.push(now);
  localStorage.setItem('queryTimestamps', JSON.stringify(queryTimestamps));
  return true;
}

// Get Gemini API key
async function getGeminiApiKey() {
  if (cachedGeminiKey) return cachedGeminiKey;
  try {
    await fetchAndActivate(remoteConfig);
    cachedGeminiKey = getString(remoteConfig, 'gemini_api_key');
    if (!cachedGeminiKey) throw new Error("Gemini API key not available");
    return cachedGeminiKey;
  } catch (error) {
    showToast("Failed to fetch Gemini API key.");
    throw error;
  }
}

// Sanitize input
function sanitizeInput(input) {
  return input.replace(/[<>&"]/g, (char) => ({
    '<': '&lt;',
    '>': '&gt;',
    '&': '&amp;',
    '"': '&quot;'
  }[char]));
}

// Resolve location to coordinates
async function resolveLocation(locationText) {
  if (locationText === "user's current location" && userLocation) {
    return { latitude: userLocation.latitude, longitude: userLocation.longitude, placeName: userLocation.placeName };
  }
  try {
    const response = await fetch(
      `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(locationText)}.json?access_token=${MAPBOX_ACCESS_TOKEN}&limit=1`
    );
    if (!response.ok) throw new Error("Geocoding failed");
    const data = await response.json();
    if (data.features?.[0]) {
      const { center, place_name } = data.features[0];
      return { latitude: center[1], longitude: center[0], placeName: place_name };
    }
    return null;
  } catch (error) {
    showToast("Could not resolve location.");
    return null;
  }
}

// Report emergency to Firebase
async function reportEmergency(emergencyType, location, conversationId) {
  try {
    const incidentId = `incident_${Date.now()}_${displayUser.uid}`;
    const incidentRef = ref(db, `incidents/${incidentId}`);
    const encryptedLng = encryptCoordinate(location.longitude);
    const encryptedLat = encryptCoordinate(location.latitude);
    if (!encryptedLng || !encryptedLat) throw new Error("Failed to encrypt coordinates");
    const incidentData = {
      userId: displayUser.uid,
      type: emergencyType,
      location: { encryptedLng, encryptedLat, placeName: location.placeName },
      timestamp: Date.now(),
      status: 'pending',
      conversationId
    };
    await set(incidentRef, incidentData);
    monitorIncidentStatus(incidentId, emergencyType, location.placeName, conversationId);
    return incidentId;
  } catch (error) {
    showToast("Failed to report emergency.");
    return null;
  }
}

// Monitor incident status
function monitorIncidentStatus(incidentId, emergencyType, placeName, conversationId) {
  const statusRef = ref(db, `incidents/${incidentId}/status`);
  const listener = onValue(statusRef, async (snapshot) => {
    if (snapshot.exists() && currentConversationId === conversationId) {
      const status = snapshot.val();
      const message = `Update: The ${emergencyType} request at ${placeName} is now ${status}.`;
      await appendMessage(message, "ai", "Vynix AI", conversationId);
      emergencyAnnouncements.textContent = message;
    }
  });
  incidentListeners.set(incidentId, listener);
}

// Process emergency request
async function processEmergencyRequest(question) {
  try {
    const GEMINI_API_KEY = await getGeminiApiKey();
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `You are an emergency assistant. Analyze the user message to identify if it is an emergency request. If it is, extract the emergency type (Police Emergency, Ambulance, Fire Fighter, Environmental Hazard) and location (use "user's current location" if not specified). If uncertain about the type or location, set them as null. Return a JSON object with { isEmergency, emergencyType, location, confidence } where confidence is a number from 0 to 1 indicating certainty (0.5 or less means uncertain).

            Examples:
            - "I need an ambulance at my location"  { isEmergency: true, emergencyType: "Ambulance", location: "user's current location", confidence: 0.9 }
            - "Report a fire in New York"  { isEmergency: true, emergencyType: "Fire Fighter", location: "New York", confidence: 0.95 }
            - "Help, emergency!"  { isEmergency: true, emergencyType: null, location: null, confidence: 0.4 }
            - "What's the weather?"  { isEmergency: false, emergencyType: null, location: null, confidence: 0 }

            User message: "${question}"`
          }]
        }]
      })
    });
    if (!response.ok) throw new Error(`Gemini API error: ${response.statusText}`);
    const data = await response.json();
    const result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json\n|\n```/g, ''));
    return result;
  } catch (error) {
    showToast("Failed to process emergency request.");
    return { isEmergency: false, emergencyType: null, location: null, confidence: 0 };
  }
}

// Generate response
async function generateResponse(question) {
  if (!checkQueryLimit()) return null;

  question = sanitizeInput(question.toLowerCase().trim());
  if (!userLocation && (question.includes("my location") || question.includes("current location"))) {
    userLocation = await getUserLocation();
  }

  // Handle follow-up questions
  if (pendingEmergency.isPending) {
    pendingEmergency.attempts += 1;
    const followUpResult = await processEmergencyRequest(`${pendingEmergency.originalQuery} | Follow-up: ${question}`);
    if (followUpResult.isEmergency && followUpResult.emergencyType && followUpResult.location && followUpResult.confidence > 0.5) {
      const location = followUpResult.location === "user's current location" ? userLocation : await resolveLocation(followUpResult.location);
      if (!location) {
        pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };
        return "I couldn't determine the location. Please specify the location or use the SOS button.";
      }
      const incidentId = await reportEmergency(followUpResult.emergencyType, location, currentConversationId);
      if (incidentId) {
        pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };
        const response = `I'm here to help. A ${followUpResult.emergencyType} has been dispatched to ${location.placeName}. Please stay safe and provide any additional details if needed.`;
        emergencyAnnouncements.textContent = `Emergency reported: ${followUpResult.emergencyType} at ${location.placeName}.`;
        return response;
      } else {
        pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };
        return "I encountered an issue reporting the emergency. Please try again or use the SOS button.";
      }
    } else if (pendingEmergency.attempts >= 2) {
      pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };
      showEmergencyConfirmDialog(followUpResult.emergencyType || '', followUpResult.location || '');
      return "I need more details to proceed. Please confirm the emergency type and location.";
    } else {
      return "Can you describe the situation or specify the emergency type? For example, do you need an ambulance or police?";
    }
  }

  // Process new query
  const emergencyResult = await processEmergencyRequest(question);
  if (emergencyResult.isEmergency) {
    if (emergencyResult.emergencyType && emergencyResult.location && emergencyResult.confidence > 0.5) {
      const location = emergencyResult.location === "user's current location" ? userLocation : await resolveLocation(emergencyResult.location);
      if (!location) {
        showEmergencyConfirmDialog(emergencyResult.emergencyType, emergencyResult.location);
        return "I need to confirm the emergency details. Please select the emergency type and location.";
      }
      const incidentId = await reportEmergency(emergencyResult.emergencyType, location, currentConversationId);
      if (incidentId) {
        const response = `I'm here to help. A ${emergencyResult.emergencyType} has been dispatched to ${location.placeName}. Please stay safe and provide any additional details if needed.`;
        emergencyAnnouncements.textContent = `Emergency reported: ${emergencyResult.emergencyType} at ${location.placeName}.`;
        return response;
      } else {
        return "I encountered an issue reporting the emergency. Please try again or use the SOS button.";
      }
    } else {
      pendingEmergency = { isPending: true, originalQuery: question, attempts: 0 };
      showEmergencyConfirmDialog(emergencyResult.emergencyType || '', emergencyResult.location || '');
      return "I need to confirm the emergency details. Please select the emergency type and location.";
    }
  }

  // Handle non-emergency queries
  let info = '';
  if (question.includes("location of") || question.includes("where is")) {
    if (question.includes("my location") || question.includes("current location")) {
      info = userLocation ? `Current location: ${userLocation.placeName} at latitude ${userLocation.latitude}, longitude ${userLocation.longitude}.` : "Unable to determine current location.";
    } else {
      const placeMatch = question.match(/(location of|where is) (.+)/);
      if (placeMatch) {
        const place = placeMatch[2].trim();
        const location = await resolveLocation(place);
        info = location ? `${location.placeName} is at latitude ${location.latitude}, longitude ${location.longitude}.` : `Couldn't find ${place}.`;
      }
    }
  } else {
    const systemPrompt = `You are Vynix AI, a friendly emergency assistant. Respond in a calm, professional, and empathetic tone, as a human emergency dispatcher would. For non-emergency queries, provide concise, helpful answers. Use the provided info if relevant.`;
    const prompt = `User query: ${question}\n\nInfo: ${info}`;
    try {
      const GEMINI_API_KEY = await getGeminiApiKey();
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: systemPrompt }, { text: prompt }] }]
        })
      });
      if (!response.ok) throw new Error(`Gemini API error: ${response.statusText}`);
      const data = await response.json();
      return data.candidates[0].content.parts[0].text;
    } catch (error) {
      showToast("Failed to process your request.");
      return "Sorry, I couldn't process your request. Please try again.";
    }
  }
  return info || "I'm here to assist. Could you clarify your request or report an emergency if needed?";
}

// Send message
sendButton.addEventListener("click", async () => {
  const question = chatInput.value.trim();
  if (question && !sendButton.disabled) {
    sendButton.disabled = true;
    try {
      if (!currentConversationId) {
        const conversationsRef = ref(db, `conversations`);
        const newConversationRef = push(conversationsRef);
        currentConversationId = newConversationRef.key;
        await set(newConversationRef, {
          userId: displayUser?.uid || "anonymous",
          timestamp: Date.now(),
          title: question.substring(0, 30) + (question.length > 30 ? '...' : '')
        });
      }
      await appendMessage(question, "user", displayUser?.displayName || "User", currentConversationId);
      chatInput.value = "";
      const response = await generateResponse(question);
      if (response) {
        await appendMessage(response, "ai", "Vynix AI", currentConversationId);
      }
    } catch (error) {
      showToast("Error sending message.");
    } finally {
      sendButton.disabled = false;
      chatInput.focus();
    }
  }
});

chatInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter" && !sendButton.disabled) sendButton.click();
});

// New conversation
newConversationButton.addEventListener("click", () => {
  if (messageListener) {
    messageListener();
    messageListener = null;
  }
  currentConversationId = null;
  chatMessages.innerHTML = "";
  emergencyAnnouncements.textContent = "";
  welcomeMessage.classList.remove("hidden");
  bottomSheet.classList.remove("active");
  pendingEmergency = { isPending: false, originalQuery: '', attempts: 0 };
  chatInput.focus();
});

// Cleanup listeners
window.addEventListener("unload", () => {
  if (conversationListener) conversationListener();
  if (messageListener) messageListener();
  incidentListeners.forEach((listener, incidentId) => off(ref(db, `incidents/${incidentId}/status`), 'value', listener));
  incidentListeners.clear();
});

// Initialize
document.addEventListener("DOMContentLoaded", async () => {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  sendButton.disabled = true;
  try {
    await fetchAndActivate(remoteConfig);
    displayUser = await checkAuthState();
    if (displayUser) {
      setupUserProfile(displayUser);
      userLocation = await getUserLocation();
      loadConversations(displayUser.uid);
    }
  } catch (error) {
    showToast("Initialization failed.");
  } finally {
    sendButton.disabled = false;
    chatInput.focus();
  }
});
  </script>
</body>
</html>
