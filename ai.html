<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text-secondary); min-height: 100vh; margin: 0; }
    .header { position: fixed; top: 0; left: 0; right: 0; padding: 1rem; text-align: center; background: var(--bg); border-bottom: 1px solid var(--border); z-index: 10; font-weight: 600; color: #1E1E1E; }
    .welcome { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 90%; }
    .welcome h1 { font-size: 1.8rem; font-weight: 700; color: #1E1E1E; margin-bottom: 0.5rem; }
    .welcome p { color: #666; }
    .hidden { display: none; }
    .chat-container { margin: 5.5rem 1rem 6rem 1rem; overflow-y: auto; max-height: calc(100vh - 11.5rem); padding: 1rem; }
    .input-bar { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background: var(--card-bg); border-radius: 2rem; padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    #user-input { flex: 1; background: transparent; color: white; border: none; outline: none; font-size: 1.1rem; }
    #send-btn { background: transparent; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: background 0.2s; }
    #send-btn:hover { background: rgba(255,255,255,0.1); }
    #send-btn svg { width: 1.6rem; height: 1.6rem; stroke: white; }
    .msg { max-width: 75%; padding: 1rem 1.4rem; border-radius: 1.6rem; margin: 0.5rem 0; word-wrap: break-word; box-shadow: 0 3px 12px rgba(0,0,0,0.15); animation: fadeIn 0.3s ease-out; }
    .user { background: linear-gradient(135deg, #E0E7FF, #C7D2FE); color: #1E1E1E; margin-left: auto; border-bottom-right-radius: 0.4rem; }
    .ai { background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748); color: white; margin-right: auto; border-bottom-left-radius: 0.4rem; }
    .confidence { font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
  </style>
</head>
<body>
  <div class="header">Vynix AI</div>

  <div class="welcome" id="welcome">
    <h1>Hey there!</h1>
    <p>Type anything — I understand typos too</p>
  </div>

  <div class="chat-container" id="messages"></div>

  <div class="input-bar">
    <input type="text" id="user-input" placeholder="Message..." autofocus autocomplete="off">
    <button id="send-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M5 12l6-6m-6 6l6 6"/>
      </svg>
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const el = {
      messages: document.getElementById('messages'),
      input: document.getElementById('user-input'),
      send: document.getElementById('send-btn'),
      welcome: document.getElementById('welcome')
    };

    let pairs = [];
    let firstMessage = true;

    // Advanced Jaro-Winkler + Levenshtein hybrid
    function jaroWinkler(a, b) {
      a = a.toLowerCase(); b = b.toLowerCase();
      if (a === b) return 1;
      const lenA = a.length, lenB = b.length;
      if (lenA === 0 || lenB === 0) return 0;
      const matchWindow = Math.max(0, Math.floor(Math.max(lenA, lenB) / 2) - 1);
      const aMatches = Array(lenA).fill(false);
      const bMatches = Array(lenB).fill(false);
      let matches = 0, transpositions = 0;

      for (let i = 0; i < lenA; i++) {
        const start = Math.max(0, i - matchWindow);
        const end = Math.min(i + matchWindow + 1, lenB);
        for (let j = start; j < end; j++) {
          if (bMatches[j] || a[i] !== b[j]) continue;
          aMatches[i] = bMatches[j] = true;
          matches++; break;
        }
      }
      if (matches === 0) return 0;

      let k = 0;
      for (let i = 0; i < lenA; i++) if (aMatches[i]) {
        while (!bMatches[k]) k++;
        if (a[i] !== b[k++]) transpositions++;
      }

      const jaro = (matches/lenA + matches/lenB + (matches - transpositions/2)/matches) / 3;
      let prefix = 0;
      for (let i = 0; i < Math.min(4, lenA, lenB); i++) if (a[i] === b[i]) prefix++; else break;
      return jaro + prefix * 0.1 * (1 - jaro);
    }

    function levenshtein(a, b) {
      const matrix = Array(b.length + 1).fill().map(() => Array(a.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
      for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
      for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
          const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
          matrix[j][i] = Math.min(
            matrix[j][i - 1] + 1,
            matrix[j - 1][i] + 1,
            matrix[j - 1][i - 1] + indicator
          );
        }
      }
      return matrix[b.length][a.length];
    }

    function advancedMatch(userMsg, trigger) {
      const msg = userMsg.toLowerCase().trim();
      const trg = trigger.toLowerCase().trim();

      // Exact
      if (msg === trg) return { score: 100, type: "EXACT" };

      // Jaro-Winkler for similarity
      const jw = jaroWinkler(msg, trg);
      if (jw >= 0.92) return { score: Math.round(jw * 100), type: "VERY CLOSE" };

      // Levenshtein distance (normalized)
      const maxLen = Math.max(msg.length, trg.length);
      if (maxLen === 0) return { score: 0 };
      const levDist = levenshtein(msg, trg);
      const levScore = Math.round((1 - levDist / maxLen) * 100);
      if (levScore >= 85) return { score: levScore, type: "CLOSE (typos)" };

      // Partial contains
      if (msg.includes(trg) || trg.includes(msg)) {
        const ratio = Math.max(msg.length, trg.length) / Math.min(msg.length, trg.length);
        return { score: Math.min(90, Math.round(70 / ratio)), type: "PARTIAL" };
      }

      return { score: 0 };
    }

    function getBestReply(message) {
      let best = null;
      let bestScore = 0;

      for (const p of pairs) {
        const match = advancedMatch(message, p.trigger);
        if (match.score > bestScore) {
          bestScore = match.score;
          best = { reply: p.reply, ...match };
        }
      }

      if (best && bestScore >= 70) return best;
      return { reply: "I don't have a response for that yet.", score: 0, type: "NO MATCH" };
    }

    function addMsg(text, type, extra = null) {
      const div = document.createElement('div');
      div.className = `msg ${type}`;
      let html = text;
      if (extra && extra.score > 0) {
        const color = extra.score === 100 ? "#10b981" : extra.score >= 90 ? "#8b5cf6" : "#f59e0b";
        html += `<div class="confidence" style="color:${color}">${extra.type} • ${extra.score}% match</div>`;
      }
      div.innerHTML = html;
      el.messages.appendChild(div);
      el.messages.scrollTop = el.messages.scrollHeight;
    }

    function reply() {
      const msg = el.input.value.trim();
      if (!msg) return;

      if (firstMessage) {
        firstMessage = false;
        el.welcome.classList.add('hidden');
      }

      addMsg(msg, 'user');
      el.input.value = '';

      setTimeout(() => {
        const result = getBestReply(msg);
        addMsg(result.reply, 'ai', result.score > 0 ? result : null);
      }, 400 + Math.random() * 300);
    }

    onValue(ref(db, 'pairs'), snap => {
      pairs = [];
      const data = snap.val() || {};
      Object.values(data).forEach(p => {
        if (p.trigger && p.reply) {
          pairs.push({ trigger: p.trigger.trim(), reply: p.reply.trim() });
        }
      });
    });

    el.send.addEventListener('click', reply);
    el.input.addEventListener('keypress', e => e.key === 'Enter' && reply());

    onAuthStateChanged(auth, user => user || signInAnonymously(auth));
  </script>
</body>
</html>
