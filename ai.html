<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix â€¢ Feed</title>
  <meta name="theme-color" content="#ff2a6d">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root { --accent: #ff2a6d; --bg: #ffffff; --card: #f7f9fa; --text: #0f1419; --text2: #536471; --border: #e1e8ed; }
    [data-theme="dark"] { --bg: #0f1419; --card: #1a1f25; --text: #ffffff; --text2: #8b98a5; --border: #2f3336; }
    body { background: var(--bg); color: var(--text); font-family: system-ui; margin: 0; min-height: 100vh; }
    .header { position: fixed; top: 0; left: 0; right: 0; height: 64px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 10; backdrop-filter: blur(12px); }
    .logo { font-weight: 800; font-size: 22px; background: linear-gradient(90deg, var(--accent), #05d9e8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .main { padding: 64px 0 80px; max-width: 600px; margin: 0 auto; }
    .post { padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .post-header { display: flex; gap: 12px; align-items: center; }
    .avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    .name { font-weight: 700; display: flex; align-items: center; gap: 4px; }
    .username { color: var(--text2); font-size: 14px; }
    .post-text { margin: 8px 0; white-space: pre-wrap; word-break: break-word; font-size: 15px; }
    .post-image { max-width: 100%; border-radius: 16px; margin: 8px 0; }
    .post-actions { display: flex; justify-content: space-between; max-width: 425px; margin-top: 8px; color: var(--text2); font-size: 14px; }
    .action { cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 999px; transition: all 0.2s; }
    .action:hover { background: rgba(255, 42, 109, 0.1); color: var(--accent); }
    .action.liked { color: #f91880; }
    .action.reposted { color: #00ba7c; }
    .action .count { font-weight: 600; }

    /* FAB */
    .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: var(--accent); color: white; border-radius: 50%; box-shadow: 0 4px 20px rgba(255, 42, 109, 0.4); display: grid; place-items: center; font-size: 28px; z-index: 20; cursor: pointer; transition: all 0.3s; }
    .fab:hover { transform: scale(1.1); }

    /* Bottom Sheet */
    .sheet { position: fixed; bottom: 0; left: 0; right: 0; height: 0; background: var(--card); border-top-left-radius: 24px; border-top-right-radius: 24px; overflow: hidden; transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; box-shadow: 0 -10px 30px rgba(0,0,0,0.2); }
    .sheet.open { height: 80vh; }
    .sheet-header { padding: 16px; text-align: center; border-bottom: 1px solid var(--border); }
    .sheet-handle { width: 40px; height: 5px; background: var(--border); border-radius: 3px; margin: 0 auto 12px; }
    .sheet textarea { width: 100%; min-height: 120px; padding: 16px; border: none; outline: none; font-size: 18px; background: transparent; resize: none; }
    .sheet-actions { padding: 16px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); }
    .post-btn { background: var(--accent); color: white; padding: 10px 24px; border-radius: 999px; font-weight: 600; }

    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--card); border-top: 1px solid var(--border); display: flex; z-index: 10; backdrop-filter: blur(12px); }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text2); font-size: 12px; }
    .nav-item.active { color: var(--accent); }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="logo">Vynix</div>
    <img id="my-avatar" class="avatar" style="cursor:pointer;">
  </header>

  <!-- Main Feed -->
  <main class="main" id="feed">
    <div class="text-center py-10 text-var(--text2)">Loading posts...</div>
  </main>

  <!-- Floating Action Button -->
  <div class="fab material-icons" id="open-sheet">edit</div>

  <!-- Bottom Sheet for Posting -->
  <div class="sheet" id="post-sheet">
    <div class="sheet-header">
      <div class="sheet-handle"></div>
      <h3 style="font-weight:700; margin:0">Create Post</h3>
    </div>
    <div style="padding:16px; flex:1; overflow-y:auto">
      <textarea id="post-input" placeholder="What's happening?"></textarea>
      <div style="margin:12px 0">
        <img id="image-preview" class="post-image" style="display:none; max-height:300px;">
      </div>
      <input type="file" id="image-upload" accept="image/*" style="display:none">
      <div style="display:flex; gap:16px; align-items:center; color:var(--accent); cursor:pointer" onclick="document.getElementById('image-upload').click()">
        <span class="material-icons">image</span>
        <span>Add Photo</span>
      </div>
    </div>
    <div class="sheet-actions">
      <button style="color:var(--text2)" onclick="closeSheet()">Cancel</button>
      <button class="post-btn" id="send-post">Post</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <span class="material-icons">chat</span> Chats
    </a>
    <div class="nav-item active">
      <span class="material-icons">home</span> Feed
    </div>
    <a href="profile.html" class="nav-item">
      <span class="material-icons">person</span> Profile
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, serverTimestamp, increment, set, remove, runTransaction } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    let uid = null;

    onAuthStateChanged(auth, user => {
      if (!user) return location.href = 'login.html';
      uid = user.uid;
      document.getElementById('my-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'U')}&background=ff2a6d&color=fff`;
      loadFeed();
    });

    // Open/Close Sheet
    document.getElementById('open-sheet').onclick = () => document.getElementById('post-sheet').classList.add('open');
    window.closeSheet = () => {
      document.getElementById('post-sheet').classList.remove('open');
      document.getElementById('post-input').value = '';
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('image-upload').value = '';
    };

    // Image Preview
    document.getElementById('image-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const prev = document.getElementById('image-preview');
          prev.src = ev.target.result;
          prev.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // Send Post
    document.getElementById('send-post').onclick = async () => {
      const text = document.getElementById('post-input').value.trim();
      const file = document.getElementById('image-upload').files[0];
      if (!text && !file) return;

      const btn = document.getElementById('send-post');
      btn.disabled = true;
      btn.textContent = 'Posting...';

      let imageUrl = null;
      if (file) {
        const storageRef = sRef(storage, `posts/\( {uid}/ \){Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        imageUrl = await getDownloadURL(storageRef);
      }

      await push(ref(db, 'posts'), {
        uid,
        text,
        imageUrl,
        timestamp: serverTimestamp(),
        likes: 0,
        reposts: 0,
        commentCount: 0
      });

      closeSheet();
      btn.disabled = false;
      btn.textContent = 'Post';
    };

    // Load Feed
    function loadFeed() {
      const feed = document.getElementById('feed');
      onValue(ref(db, 'posts'), async (snap) => {
        feed.innerHTML = '';
        if (snap.numChildren() === 0) {
          feed.innerHTML = '<div class="text-center py-20 text-var(--text2)">No posts yet. Be the first!</div>';
          return;
        }

        const posts = [];
        snap.forEach(child => posts.push({ id: child.key, ...child.val() }));
        posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        for (const post of posts) {
          const userSnap = await get(ref(db, `users/${post.uid}`));
          const user = userSnap.val() || { displayName: 'User', photoURL: null };

          const liked = (await get(ref(db, `posts/\( {post.id}/likedBy/ \){uid}`))).val();
          const reposted = (await get(ref(db, `posts/\( {post.id}/repostedBy/ \){uid}`))).val();

          const div = document.createElement('div');
          div.className = 'post';
          div.innerHTML = `
            <div class="post-header">
              <img src="\( {user.photoURL || `https://ui-avatars.com/api/?name= \){encodeURIComponent(user.displayName || 'U')}&background=05d9e8&color=fff`}" class="avatar">
              <div>
                <div class="name">\( {user.displayName || 'User'} \){user.verified ? '<span class="material-icons text-sky-500 text-18" style="vertical-align:middle">verified</span>' : ''}</div>
                <div class="username">@${(user.displayName || 'user').toLowerCase().replace(/\s/g,'')}</div>
              </div>
            </div>
            <div class="post-text">${post.text || ''}</div>
            \( {post.imageUrl ? `<img src=" \){post.imageUrl}" class="post-image">` : ''}
            <div class="post-actions">
              <div class="action \( {liked ? 'liked' : ''}" onclick="toggleLike(' \){post.id}', this)">
                <span class="material-icons text-20">${liked ? 'favorite' : 'favorite_border'}</span>
                <span class="count">${post.likes || 0}</span>
              </div>
              <div class="action \( {reposted ? 'reposted' : ''}" onclick="toggleRepost(' \){post.id}', this)">
                <span class="material-icons text-20">repeat</span>
                <span class="count">${post.reposts || 0}</span>
              </div>
              <div class="action" onclick="alert('Comments coming soon!')">
                <span class="material-icons text-20">comment</span>
                <span class="count">${post.commentCount || 0}</span>
              </div>
            </div>
          `;
          feed.appendChild(div);
        }
      });
    }

    window.toggleLike = async (postId, el) => {
      const likedRef = ref(db, `posts/\( {postId}/likedBy/ \){uid}`);
      const likesRef = ref(db, `posts/${postId}/likes`);
      const snap = await get(likedRef);
      if (snap.exists()) {
        await remove(likedRef);
        await runTransaction(likesRef, v => (v || 1) - 1);
        el.classList.remove('liked');
        el.querySelector('.material-icons').textContent = 'favorite_border';
      } else {
        await set(likedRef, true);
        await runTransaction(likesRef, v => (v || 0) + 1);
        el.classList.add('liked');
        el.querySelector('.material-icons').textContent = 'favorite';
      }
    };

    window.toggleRepost = async (postId, el) => {
      const repostedRef = ref(db, `posts/\( {postId}/repostedBy/ \){uid}`);
      const repostsRef = ref(db, `posts/${postId}/reposts`);
      const snap = await get(repostedRef);
      if (snap.exists()) return;
      await set(repostedRef, true);
      await runTransaction(repostsRef, v => (v || 0) + 1);
      el.classList.add('reposted');
    };
  </script>
</body>
</html>
