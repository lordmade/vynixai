<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Buddy ‚Äì Your AI Friend</title>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js"></script>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root{--accent:#ff2a6d;--glow:0 0 15px rgba(255,42,109,.4)}
    [data-theme="dark"]{--bg:#0f1419;--card:#1a1f25;--text:#fff;--text2:#8b98a5;--border:#2f3336}
    body{background:var(--bg,#fff);color:var(--text,#0f1419);font-family:system-ui,-apple-system,sans-serif;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden;transition:background .3s,color .3s}
    .header{position:fixed;top:0;left:0;right:0;height:64px;background:var(--card,#f7f9fa);border-bottom:1px solid var(--border,#e1e8ed);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:50;
      background:linear-gradient(135deg,var(--accent),#05d9e8)}
    .header h1{font-weight:900;font-size:22px;background:linear-gradient(90deg,#fff,#ddd);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    #chat{flex:1;overflow-y:auto;padding:80px 16px 100px}
    .msg{margin:16px 0;display:flex;flex-direction:column}
    .msg.user{align-items:flex-end}
    .msg .bubble{max-width:85%;padding:14px 18px;border-radius:24px;line-height:1.5;
      box-shadow:0 4px 15px rgba(0,0,0,.1);word-break:break-word}
    .msg.user .bubble{background:var(--accent);color:#fff;border-bottom-right-radius:6px}
    .msg.ai .bubble{background:var(--card,#f7f9fa);color:var(--text,#0f1419);border:1px solid var(--border,#e1e8ed);border-bottom-left-radius:6px}
    .input-bar{position:fixed;bottom:0;left:0;right:0;background:var(--card,#fff);border-top:1px solid var(--border,#e1e8ed);
      padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom));display:flex;gap:12px;align-items:flex-end;z-index:100}
    .input-box{flex:1;background:var(--card,#f7f9fa);border:2px solid var(--border,#e1e8ed);border-radius:28px;
      padding:12px 16px;display:flex;gap:12px;align-items:center;transition:all .2s}
    .input-box:focus-within{border-color:var(--accent);box-shadow:var(--glow)}
    #input{flex:1;background:transparent;border:none;outline:none;font-size:16px;resize:none;max-height:120px}
    .btn-circle{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:all .2s}
    .send{background:var(--accent);color:#fff;box-shadow:var(--glow)}
    .send:disabled{background:#94a3b8;cursor:not-allowed}
    .attach{background:var(--card,#f7f9fa);border:2px solid var(--border,#e1e8ed)}
    .thinking{display:flex;gap:8px;padding:16px 20px}
    .dot{width:10px;height:10px;background:var(--accent);border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
    .actions{display:flex;gap:12px;margin-top:8px}
    .act{width:40px;height:40px;background:var(--card,#fff);border-radius:50%;display:grid;place-items:center;
      box-shadow:0 4px 12px rgba(0,0,0,.1);cursor:pointer;transition:all .2s}
    .act:hover{transform:scale(1.15);box-shadow:var(--glow)}
  </style>
</head>
<body class="text-base">

  <!-- Header -->
  <header class="header">
    <h1>Vynix Buddy</h1>
    <div class="flex items-center gap-3">
      <div id="online" class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
      <span class="text-white font-medium">Always here for you</span>
    </div>
  </header>

  <!-- Chat -->
  <main id="chat" class="scroll-smooth">
    <div class="text-center mt-20 px-6">
      <h2 class="text-4xl font-black mb-3 bg-gradient-to-r from-var(--accent) to-#05d9e8 bg-clip-text text-transparent">
        Hey, I'm your AI Buddy
      </h2>
      <p class="text-lg text-gray-600 dark:text-gray-400">Ask anything ‚Ä¢ Send photos ‚Ä¢ Voice chat ‚Ä¢ I remember everything ‚ù§Ô∏è</p>
    </div>
  </main>

  <!-- Input Bar -->
  <div class="input-bar">
    <div class="input-box">
      <button id="attachBtn" class="attach btn-circle"><i data-lucide="plus"></i></button>
      <input type="file" id="fileInput" accept="image/*,video/*" hidden>
      <textarea id="input" placeholder="Message Buddy..." rows="1"></textarea>
      <button id="voiceBtn" class="btn-circle attach"><i data-lucide="mic"></i></button>
      <button id="sendBtn" class="send btn-circle" disabled><i data-lucide="send"></i></button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getRemoteConfig, fetchAndActivate, getString } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
    lucide.createIcons();

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const rc = getRemoteConfig(app);
    rc.settings.minimumFetchIntervalMillis = 3600000;

    let uid = null;
    let xaiKey = null;
    let history = [{ role: "system", content: "You are Buddy ‚Äì a fun, caring, slightly sassy AI friend on Vynix. You're always excited to help, you remember everything, and you love using emojis. Be warm, witty, and real. Never be boring." }];

    const els = {
      chat: document.getElementById('chat'),
      input: document.getElementById('input'),
      send: document.getElementById('sendBtn'),
      attach: document.getElementById('attachBtn'),
      voice: document.getElementById('voiceBtn'),
      fileInput: document.getElementById('fileInput')
    };

    // Auto-resize input
    els.input.addEventListener('input', () => {
      els.input.style.height = 'auto';
      els.input.style.height = els.input.scrollHeight + 'px';
      els.send.disabled = !els.input.value.trim() && !currentImage;
    });

    // Upload image
    let currentImage = null;
    els.attach.onclick = () => els.fileInput.click();
    els.fileInput.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'vynix_public');
      const res = await fetch('https://api.cloudinary.com/v1_1/dqkujefxj/upload', { method: 'POST', body: fd });
      const data = await res.json();
      if (data.secure_url) {
        currentImage = data.secure_url;
        addMsg(`<img src="${currentImage}" class="rounded-2xl max-w-full mt-3">`, 'user');
        els.send.disabled = false;
      }
    };

    function addMsg(content, sender, plain = '') {
      const div = document.createElement('div');
      div.className = `msg ${sender}`;
      const time = new Date().toLocaleTimeString('en-ZA', { hour: 'numeric', minute: '2-digit' });
      div.innerHTML = `
        <div class="bubble">${content}</div>
        ${sender === 'ai' ? `
          <div class="actions">
            <button class="act copy"><i data-lucide="copy"></i></button>
            <button class="act voice"><i data-lucide="volume-2"></i></button>
          </div>` : ''}
        <div class="text-xs opacity-70 mt-1">${time}</div>
      `;
      els.chat.appendChild(div);
      els.chat.scrollTop = els.chat.scrollHeight;
      lucide.createIcons();

      if (sender === 'ai') {
        div.querySelector('.copy')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plain || content.replace(/<[^>]*>/g, ''));
          alert("Copied!");
        });
      }
    }

    function thinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'msg ai';
      d.innerHTML = `<div class="bubble"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chat.appendChild(d);
      els.chat.scrollTop = els.chat.scrollHeight;
    }

    async function send() {
      let text = els.input.value.trim();
      if (!text && !currentImage) return;

      if (currentImage) {
        addMsg(`<img src="${currentImage}" class="rounded-2xl max-w-full">`, 'user');
        history.push({ role: "user", content: [{ type: "text", text: text || "What do you see?" }, { type: "image_url", image_url: { url: currentImage } }] });
        currentImage = null;
      } else {
        addMsg(text, 'user');
        history.push({ role: "user", content: text });
      }

      els.input.value = ''; els.input.style.height = 'auto'; els.send.disabled = true;
      thinking();

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-beta",
            messages: history,
            temperature: 0.8,
            max_tokens: 4096
          })
        });
        const data = await res.json();
        const reply = data.choices[0].message.content;
        document.getElementById('thinking')?.remove();
        addMsg(reply, 'ai', reply);
        history.push({ role: "assistant", content: reply });
      } catch (err) {
        document.getElementById('thinking')?.remove();
        addMsg("I'm having trouble connecting right now üòî Try again?", 'ai');
      }
    }

    els.send.onclick = send;
    els.input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    // Auth + Remote Config
    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = "login.html"; return; }
      uid = user.uid;
      await fetchAndActivate(rc);
      xaiKey = getString(rc, 'xai_api_key')?.trim();

      if (!xaiKey) {
        addMsg("Warning: Buddy is not connected yet. Admin needs to add xAI key in Firebase Remote Config.", 'ai');
        return;
      }

      addMsg("Hey bestie! What's on your mind today? üíï", 'ai');
    });
  </script>
</body>
</html>
