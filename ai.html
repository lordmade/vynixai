<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix â€¢ Posts</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root{--accent:#ff2a6d;--bg:#ffffff;--card:#f7f9fa;--text:#0f1419;--text2:#536471;--border:#e1e8ed}
    [data-theme="dark"]{--bg:#0f1419;--card:#1a1f25;--text:#ffffff;--text2:#8b98a5;--border:#2f3336}
    body{background:var(--bg);color:var(--text);font-family:system-ui,min-height:100vh;margin:0}
    .header{position:fixed;top:0;left:0;right:0;height:64px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:10}
    .main{padding:64px 0 80px}
    .post-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px}
    .post-input{width:100%;min-height:80px;background:transparent;border:none;outline:none;font-size:16px;resize:none}
    .post-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .post-btn{background:var(--accent);color:white;padding:10px 20px;border-radius:999px;font-weight:600;cursor:pointer}
    .post-btn:disabled{opacity:0.6;cursor:not-allowed}
    .feed{max-width:600px;margin:0 auto}
    .post{border-bottom:1px solid var(--border);padding:12px 16px}
    .post-header{display:flex;gap:12px;align-items:center}
    .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover}
    .name{font-weight:700}
    .username{color:var(--text2);font-size:14px}
    .post-text{margin:8px 0;white-space:pre-wrap;word-break:break-word}
    .post-image{max-width:100%;border-radius:12px;margin:8px 0}
    .post-footer{display:flex;justify-content:space-between;color:var(--text2);font-size:14px;margin-top:8px}
    .action{cursor:pointer;display:flex;align-items:center;gap:6px}
    .action:hover{color:var(--accent)}
    .action.liked{color:var(--accent)}
    .action.reposted{color:#22c55e}
    .comments{margin-top:12px;padding-left:40px;border-left:2px solid var(--border)}
    .comment{display:flex;gap:10px;margin:8px 0}
    .comment-input{width:100%;padding:8px;border:1px solid var(--border);border-radius:12px;outline:none}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--card);border-top:1px solid var(--border);display:flex;z-index:10}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--text2);font-size:12px}
    .nav-item.active,.nav-item:active{color:var(--accent)}
  </style>
</head>
<body>
  <header class="header">
    <h1 style="font-weight:800;font-size:22px;background:linear-gradient(90deg,var(--accent),#05d9e8);-webkit-background-clip:text;-webkit-text-fill-color:transparent">
      Vynix
    </h1>
    <img id="my-avatar" class="avatar" style="cursor:pointer">
  </header>

  <main class="main feed">
    <div class="post-box">
      <textarea id="post-text" class="post-input" placeholder="What's happening?"></textarea>
      <div style="margin:8px 0">
        <img id="post-preview" class="post-image" style="display:none">
      </div>
      <div class="post-actions">
        <input type="file" id="image-upload" accept="image/*" style="display:none">
        <span class="material-icons" style="cursor:pointer;color:var(--accent)" onclick="document.getElementById('image-upload').click()">
          image
        </span>
        <button id="post-btn" class="post-btn">Post</button>
      </div>
    </div>

    <div id="feed"></div>
  </main>

  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <span class="material-icons">chat</span> Chats
    </a>
    <div class="nav-item active">
      <span class="material-icons">home</span> Posts
    </div>
    <a href="profile.html" class="nav-item">
      <span class="material-icons">person</span> Profile
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, serverTimestamp, increment, runTransaction } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    let uid = null;

    onAuthStateChanged(auth, user => {
      if (!user) return location.href = 'login.html';
      uid = user.uid;
      document.getElementById('my-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=ff2a6d&color=fff`;
      document.getElementById('my-avatar').onclick = () => location.href = 'profile.html';
      loadFeed();
    });

    // Image preview
    document.getElementById('image-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const prev = document.getElementById('post-preview');
          prev.src = ev.target.result;
          prev.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // Post
    document.getElementById('post-btn').addEventListener('click', async () => {
      const text = document.getElementById('post-text').value.trim();
      const file = document.getElementById('image-upload').files[0];
      if (!text && !file) return;

      const btn = document.getElementById('post-btn');
      btn.disabled = true;
      btn.textContent = 'Posting...';

      let imageUrl = null;
      if (file) {
        const storageRef = sRef(storage, `posts/\( {uid}/ \){Date.now()}`);
        await uploadBytes(storageRef, file);
        imageUrl = await getDownloadURL(storageRef);
      }

      const postsRef = ref(db, 'posts');
      await push(postsRef, {
        uid,
        text,
        imageUrl,
        timestamp: serverTimestamp(),
        likes: 0,
        reposts: 0,
        comments: 0
      });

      document.getElementById('post-text').value = '';
      document.getElementById('image-upload').value = '';
      document.getElementById('post-preview').style.display = 'none';
      btn.disabled = false;
      btn.textContent = 'Post';
    });

    // Load feed
    function loadFeed() {
      const feed = document.getElementById('feed');
      const postsRef = ref(db, 'posts');
      onValue(postsRef, async snap => {
        feed.innerHTML = '';
        const posts = [];
        snap.forEach(child => posts.push({ id: child.key, ...child.val() }));
        posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        for (const post of posts) {
          const userSnap = await get(ref(db, `users/${post.uid}`));
          const user = userSnap.val() || { displayName: 'User', photoURL: null };

          const hasLiked = await runTransaction(ref(db, `posts/\( {post.id}/likedBy/ \){uid}`), v => v ? null : true);
          const hasReposted = await runTransaction(ref(db, `posts/\( {post.id}/repostedBy/ \){uid}`), v => v ? null : true);

          const div = document.createElement('div');
          div.className = 'post';
          div.innerHTML = `
            <div class="post-header">
              <img src="\( {user.photoURL || `https://ui-avatars.com/api/?name= \){user.displayName}&background=05d9e8&color=fff`}" class="avatar">
              <div>
                <div class="name">\( {user.displayName || 'User'} \){user.verified ? '<span class="material-icons" style="font-size:18px;color:#1d9bf0;vertical-align:middle">verified</span>' : ''}</div>
                <div class="username">@${user.displayName?.toLowerCase().replace(/\s/g,'') || 'user'}</div>
              </div>
            </div>
            <div class="post-text">${post.text || ''}</div>
            \( {post.imageUrl ? `<img src=" \){post.imageUrl}" class="post-image">` : ''}
            <div class="post-footer">
              <div class="action \( {hasLiked ? 'liked' : ''}" onclick="toggleLike(' \){post.id}')">
                <span class="material-icons">favorite</span> <span>${post.likes || 0}</span>
              </div>
              <div class="action \( {hasReposted ? 'reposted' : ''}" onclick="repost(' \){post.id}')">
                <span class="material-icons">repeat</span> <span>${post.reposts || 0}</span>
              </div>
              <div class="action" onclick="toggleComment('${post.id}')">
                <span class="material-icons">comment</span> <span>${post.comments || 0}</span>
              </div>
            </div>
            <div id="comments-${post.id}" class="comments" style="display:none"></div>
          `;
          feed.appendChild(div);
        }
      }, { onlyOnce: false });
    }

    window.toggleLike = async (postId) => {
      const likeRef = ref(db, `posts/${postId}/likes`);
      const userLikeRef = ref(db, `posts/\( {postId}/likedBy/ \){uid}`);
      const snapshot = await get(userLikeRef);
      if (snapshot.exists()) {
        await runTransaction(likeRef, v => (v || 1) - 1);
        await remove(userLikeRef);
      } else {
        await runTransaction(likeRef, v => (v || 0) + 1);
        await set(userLikeRef, true);
      }
    };

    window.repost = async (postId) => {
      const repostRef = ref(db, `posts/${postId}/reposts`);
      const userRepostRef = ref(db, `posts/\( {postId}/repostedBy/ \){uid}`);
      const snap = await get(userRepostRef);
      if (!snap.exists()) {
        await runTransaction(repostRef, v => (v || 0) + 1);
        await set(userRepostRef, true);
      }
    };

    window.toggleComment = (postId) => {
      const el = document.getElementById(`comments-${postId}`);
      if (el.style.display === 'block') {
        el.style.display = 'none';
      } else {
        el.style.display = 'block';
        if (!el.innerHTML) {
          el.innerHTML = `
            <div class="comment">
              <img src="${document.getElementById('my-avatar').src}" class="avatar" style="width:36px;height:36px">
              <input type="text" class="comment-input" placeholder="Write a comment..." onkeypress="if(event.key==='Enter') addComment('${postId}', this)">
            </div>
            <div id="comment-list-${postId}"></div>
          `;
          loadComments(postId);
        }
      }
    };

    window.addComment = async (postId, input) => {
      const text = input.value.trim();
      if (!text) return;
      await push(ref(db, `posts/${postId}/comments`), {
        uid,
        text,
        timestamp: serverTimestamp()
      });
      await runTransaction(ref(db, `posts/${postId}/commentsCount`), v => (v || 0) + 1);
      input.value = '';
    };

    async function loadComments(postId) {
      const commentsRef = ref(db, `posts/${postId}/comments`);
      onValue(commentsRef, async snap => {
        const list = document.getElementById(`comment-list-${postId}`);
        if (!list) return;
        list.innerHTML = '';
        const comments = [];
        snap.forEach(c => comments.push({ id: c.key, ...c.val() }));
        comments.sort((a, b) => a.timestamp - b.timestamp);
        for (const c of comments) {
          const userSnap = await get(ref(db, `users/${c.uid}`));
          const user = userSnap.val() || { displayName: 'User' };
          const div = document.createElement('div');
          div.className = 'comment';
          div.innerHTML = `
            <img src="\( {user.photoURL || `https://ui-avatars.com/api/?name= \){user.displayName}`}" class="avatar" style="width:32px;height:32px">
            <div>
              <div style="font-weight:600">${user.displayName}</div>
              <div>${c.text}</div>
            </div>
          `;
          list.appendChild(div);
        }
      });
    }
  </script>
</body>
</html>
