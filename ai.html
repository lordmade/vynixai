<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>StudyBuddy â€“ AI Tutor (Grade 1-12)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg: #F7F7F8;
      --card-bg: #1C2526;
      --text-primary: #FFFFFF;
      --text-secondary: #4B5EAA;
      --border: #4A5568;
      --highlight: #38B2AC;
      --user-msg-bg: #E0E7FF;
      --ai-msg-bg: #1C2526;
    }
    * {
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      user-select: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }
    input, textarea, .content {
      -webkit-user-select: text !important;
      user-select: text !important;
    }
    html, body {
      overscroll-behavior: none;
      height: 100vh;
      margin: 0;
    }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
    }

    /* ---------- TOP BAR ---------- -->
    .top-bar {
      flex-shrink: 0;
      height: 64px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      z-index: 10;
    }
    .v-logo {
      width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 4px;
    }
    .v-logo svg { width: 22px; height: 22px; fill: white; }
    #api-status {
      width: 12px; height: 12px; border-radius: 50%; background: red; box-shadow: 0 0 8px red; transition: all 0.4s;
    }
    #api-status.connected { background: lime; box-shadow: 0 0 15px lime; }

    /* ---------- CHAT AREA ---------- -->
    .chat-area {
      flex: 1 1 0%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      overscroll-behavior: contain;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      padding-bottom: 9rem; /* space for input + upload */
    }
    .message {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    .message.user { align-items: flex-end; }
    .message.ai  { align-items: flex-start; }
    .message .content {
        max-width: 75%;
        padding: 0.75rem 1.1rem;
        border-radius: 1.1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,.18);
        line-height: 1.5;
        position: relative;
    }
    .message.user .content {
        background: linear-gradient(135deg, var(--user-msg-bg), #C7D2FE);
        color: #1E1E1E;
    }
    .message.ai .content {
        background: linear-gradient(135deg, var(--ai-msg-bg), #2D3748);
        color: var(--text-primary);
    }
    .message-time {
        font-size: 0.65rem; opacity: 0.6; margin-top: 0.25rem; padding: 0 0.4rem;
    }
    .message-time.ai { align-self: flex-start; }
    .message-time.user { align-self: flex-end; }

    /* ---------- UNIFIED INPUT BOX ---------- -->
    .input-bar {
        position: fixed; left: 0; right: 0; bottom: 0;
        padding: 0.75rem 1rem; border-top: 1px solid var(--border);
        background: var(--bg); z-index: 20; transition: transform 0.25s ease;
    }
    .input-container {
        background: var(--card-bg); border-radius: 1.5rem; padding: 0.75rem 1rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 0.65rem;
    }
    .input-row { display: flex; align-items: center; gap: 0.75rem; }
    #chatInput {
        flex: 1; background: transparent; border: none; outline: none;
        color: var(--text-primary); font-size: 1rem; padding: 0.5rem 0;
    }
    #chatInput::placeholder { color: #888; }
    .send-btn {
        background: var(--highlight); color: white; border: none;
        width: 46px; height: 46px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
    }
    .send-btn:hover { background: #4ADEDE; transform: scale(1.08); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .upload-row-inner {
        display: flex; align-items: center; gap: 0.5rem; padding: 0 0.25rem; opacity: 0.9;
    }
    #uploadBtnInner {
        background: rgba(255,255,255,0.15); color: #ccc; border: none;
        border-radius: 9999px; padding: 0.5rem 1rem; font-size: 0.85rem;
        cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;
    }
    #uploadBtnInner:hover { background: rgba(255,255,255,0.25); }
    #fileName { color: #aaa; font-size: 0.8rem; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #hiddenFile { display: none; }

    <!-- SIDEBAR (same design) -->
    .sidebar {
        position: fixed; inset: 0; width: 280px; height: 100vh;
        background: white; box-shadow: 2px 0 10px rgba(0,0,0,.1);
        transform: translateX(-100%); transition: transform .3s ease; z-index: 40;
        display: flex; flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header {
        background: #000; color: white; padding: 1.5rem; text-align: center;
    }
    #convList { flex: 1; overflow-y: auto; }
    .conv-item {
        padding: 1rem 1.5rem; border-bottom: 1px solid #eee; cursor: pointer;
        display: flex; justify-content: space-between; align-items: center;
    }
    .conv-item:hover { background: #f0f0f0; }
    .conv-item.active { background: #e0e7ff; font-weight: 600; }
    .delete-conv { color: #ef4444; opacity: .7; cursor: pointer; }
    #userPlanBadge {
        margin: 1rem; padding: .6rem 1rem; border-radius: 9999px;
        background: linear-gradient(135deg, var(--highlight), #4ADEDE);
        color: white; font-weight: 700; font-size: .8rem; text-align: center;
    }

    <!-- OVERLAY & TOAST -->
    <div id="overlay" class=""></div>
    <div id="toast"></div>

    <!-- UPGRADE MODAL -->
    <div id="upgradeModal">
        <div class="modal-content">
            <h2 class="modal-title">Upgrade to Pro</h2>
            <p class="text-lg mb-6">Unlimited tutoring Â· Homework photos Â· All subjects</p>
            <button id="mockCheckout" class="mock-checkout">Start Free Trial â†’ R799/month</button>
            <button id="closeModal" class="close-modal mt-4 text-gray-500">Maybe later</button>
        </div>
    </div>

    <!-- ---------- Firebase ---------- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
        import { getRemoteConfig, getString, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // ---------- CLOUDINARY CONFIG ----------
        const CLOUD_NAME = 'dqkujefxj';          // â† insert
        const UPLOAD_PRESET = 'banter_box';  // â† insert

        // ---------- ELEMENTS ----------
        const chatPane = document.getElementById('chatPane');
        const welcome = document.getElementById('welcome');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const convList = document.getElementById('convList');
        const newConvBtn = document.getElementById('newConvBtn');
        const slideProfile = document.getElementById('slideProfile');
        const slideName = document.getElementById('slideName');
        const userPlanBadge = document.getElementById('userPlanBadge');
        const tokenCount = document.getElementById('tokenCount');
        const tokenFill = document.getElementById('tokenFill');
        const upgradeModal = document.getElementById('upgradeModal');
        const mockCheckout = document.getElementById('mockCheckout');
        const closeModal = document.getElementById('closeModal');
        const uploadBtnInner = document.getElementById('uploadBtnInner');
        const hiddenFile = document.getElementById('hiddenFile');
        const fileName = document.getElementById('fileName');
        const inputBar = document.getElementById('inputBar');

        let xaiApiKey = null;
        let userId = null;
        let currentConvId = null;
        let conversations = {};
        let history = [];
        let todayTokensUsed = 0;
        let currentImage = null;
        let userRole = null; // 'student' | 'teacher'
        let userName = null;

        const DAILY_LIMIT = 15000; // same for everyone
        const PRO_LIMIT = 1000000;

        const SYSTEM_PROMPT = `You are StudyBuddy â€” the kindest, smartest tutor for Grades 1â€“12 in South Africa.
You help with homework, explain concepts, and make learning fun.
- Auto-detect grade level from question
- Use simple language for younger kids, deeper for teens
- Always ask: "Got it? Want another example?"
- Celebrate wins with emojis
- For photos: solve step-by-step like a real teacher
You are warm, patient, and never boring.`;

        marked.setOptions({ breaks: true, gfm: true, highlight: (code, lang) => Prism.languages[lang] ? Prism.highlight(code, Prism.languages[lang], lang) : code });

        function renderMarkdown(text) {
            let html = marked.parse(text);
            return html.replace(/<pre><code class="language-([^"]+)">([\s\S]*?)<\/code><\/pre>/g,
                '<pre><code class="language-$1">$2</code><button class="code-copy-btn">Copy</button></pre>');
        }

        async function initRemote() {
            const rc = getRemoteConfig(app);
            await fetchAndActivate(rc);
            xaiApiKey = getString(rc, 'xai_api_key').trim();
            if (xaiApiKey) document.getElementById('api-status').classList.add('connected');
        }

        async function loadUsage() {
            const today = new Date().toISOString().slice(0,10);
            const snap = await get(ref(db, `usage/${userId}/${today}`));
            todayTokensUsed = snap.val() || 0;
            updateTokenUI();
        }

        function updateTokenUI() {
            const limit = DAILY_LIMIT;
            tokenCount.textContent = `${todayTokensUsed.toLocaleString()} / ${limit.toLocaleString()}`;
            tokenFill.style.width = `${(todayTokensUsed / limit) * 100}%`;
            userPlanBadge.textContent = `Free â€¢ ${limit.toLocaleString()} tokens/day`;
        }

        async function addUsage(input, output) {
            todayTokensUsed += input + output;
            const today = new Date().toISOString().slice(0,10);
            await set(ref(db, `users/${userId}/usage/${today}`), todayTokensUsed);
            updateTokenUI();
            if (todayTokensUsed >= DAILY_LIMIT) showUpgrade();
        }

        // ---------- DAILY RESET (client-side) ----------
        async function resetIfNeeded() {
            const today = new Date().toISOString().slice(0,10);
            const last = await get(ref(db, `users/${userId}/lastReset`));
            if (last.val() !== today) {
                await set(ref(db, `users/${userId}/lastReset`), today);
                await set(ref(db, `users/${userId}/usage/${today}`), 0);
                todayTokensUsed = 0;
                updateTokenUI();
            }
        }

        // ---------- UPGRADE MODAL ----------
        function showUpgrade() {
            document.querySelector('.modal-title').textContent = `Upgrade to Pro`;
            document.querySelector('.modal-content p').textContent = `Unlimited tutoring Â· Homework photos Â· All subjects`;
            mockCheckout.textContent = `Start Free Trial â†’ R799/month`;
            upgradeModal.classList.add('show');
        }

        // ---------- CORE CHAT ----------
        async function getReply(userMsg) {
            const messages = [
                { role: "system", content: `You are StudyBuddy â€“ a friendly tutor for Grades 1-12 in South Africa. User: ${userName || 'Learner'} | Role: ${userRole || 'Guest'}` },
                ...history.slice(-20).map(m => ({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text })),
                { role: "user", content: userMsg }
            ];

            if (currentImage) {
                const base64 = await fetch(currentImage).then(r => r.blob()).then(b => new Promise(res => {
                    const reader = new FileReader(); reader.onloadend = () => res(reader.result.split(',')[1]); reader.readAsDataURL(b);
                }));
                messages[messages.length-1].content = [
                    { type: "text", text: userMsg || "Explain this homework photo" },
                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                ];
            }

            const inputTokens = estimateTokens(JSON.stringify(messages));
            if (todayTokensUsed + inputTokens > DAILY_LIMIT) { showUpgrade(); return "Daily limit reached! Upgrade to Pro for unlimited access."; }

            const res = await fetch("https://api.x.ai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${xaiApiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "grok-3", messages, temperature: 0.7 })
            }).then(r => r.json());

            const reply = res.choices?.[0]?.message?.content || "I'm thinking... try again!";
            await addUsage(inputTokens, estimateTokens(reply));
            return reply;
        }

        function addMessage(text, sender, timestamp = Date.now(), typing = false) {
            const msg = document.createElement('div');
            msg.className = `message ${sender}`;
            msg.innerHTML = `
                <div class="content"></div>
                <div class="message-time \) {sender}">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
            `;
            if (sender === 'ai') {
                const btn = document.createElement('button');
                btn.innerHTML = 'Copy';
                btn.className = 'code-copy-btn';
                btn.style.cssText = 'position: absolute; top: 8px; right: 8px; opacity: 0.6;';
                btn.onclick = () => { navigator.clipboard.writeText(text); btn.textContent = 'Copied'; setTimeout(() => btn.textContent = 'Copy', 1500); };
                msg.querySelector('.content').appendChild(btn);
            }
            chatPane.appendChild(msg);
            chatPane.scrollTop = chatPane.scrollHeight;

            const content = msg.querySelector('.content');
            if (typing) {
                content.textContent = 'Typing...';
                setTimeout(() => typeText(text, content), 500);
            } else {
                typeText(text, content);
            }
        }

        async function typeText(text, el) {
            el.innerHTML = '';
            for (let i = 0; i < text.length; i += 7) {
                el.textContent += text.slice(i, i+7);
                await new Promise(r => setTimeout(r, 20));
                el.scrollIntoView({behavior: 'smooth', block: 'nearest'});
            }
            el.innerHTML = renderMarkdown(text);
            Prism.highlightAllUnder(el);
        }

        async function send() {
            const text = chatInput.value.trim();
            if (!text && !currentImage) return;
            if (!currentConvId) startNewConversation();

            if (currentImage) addMessage(`<img src="${currentImage}" class="rounded-lg max-w-xs mt-2">`, 'user');
            else addMessage(text, 'user');

            saveMessage(text || "[Photo]", 'user');
            history.push({ sender: 'user', text: text || "[Photo]" });
            chatInput.value = '';
            currentImage = null;
            fileName.textContent = '';
            updateSendButton();

            addMessage('', 'ai', Date.now(), true);
            const reply = await getReply(text || "Explain this homework photo");
            document.querySelector('.message.ai:last-child .content').parentElement.remove();
            addMessage(reply, 'ai');
            history.push({ sender: 'ai', text: reply });
            saveMessage(reply, 'ai');
        }

        // ---------- CLOUDINARY UPLOAD ----------
        uploadBtnInner.onclick = () => hiddenFile.click();
        hiddenFile.onchange = async () => {
            const file = hiddenFile.files[0];
            if (!file) return;
            fileName.textContent = file.name;
            const form = new FormData();
            form.append('file', file);
            form.append('upload_preset', UPLOAD_PRESET);
            toast('Uploading photo...');
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: form });
            const data = await res.json();
            if (data.secure_url) {
                currentImage = data.secure_url;
                toast('Photo ready â€“ hit send âœˆï¸');
                updateSendButton();
            } else {
                toast('Upload failed');
                fileName.textContent = '';
            }
        };

        function updateSendButton() {
            const hasContent = chatInput.value.trim() || currentImage;
            sendBtn.disabled = !hasContent;
            sendBtn.style.opacity = hasContent ? '1' : '0.4';
        }
        chatInput.addEventListener('input', updateSendButton);
        updateSendButton();

        function startNewConversation() {
            history = []; chatPane.innerHTML = ''; welcome.classList.add('hidden');
            const newRef = push(ref(db, `users/${userId}/conversations`));
            currentConvId = newRef.key;
            set(newRef, { createdAt: Date.now(), title: 'New Tutoring Session' });
        }
        function loadConversation(id, data) {
            currentConvId = id; history = []; chatPane.innerHTML = ''; welcome.classList.add('hidden');
            const msgs = data.messages || {};
            Object.entries(msgs).sort((a, b) => a[1].timestamp - b[1].timestamp).forEach(([_, m]) => {
                addMessage(m.text, m.sender, m.timestamp);
                if (m.sender !== 'system') history.push({ sender: m.sender, text: m.text });
            });
        }
        function deleteConversation(id) {
            remove(ref(db, `users/${userId}/conversations/${id}`));
            if (id === currentConvId) startNewConversation();
        }
        function renderSidebar() {
            convList.innerHTML = '';
            Object.entries(conversations)
                .sort((a, b) => b[1].createdAt - a[1].createdAt)
                .forEach(([id, conv]) => {
                    const div = document.createElement('div');
                    div.className = `conv-item ${id === currentConvId ? 'active' : ''}`;
                    div.dataset.id = id;
                    div.innerHTML = `<span>${conv.title || 'Session'}</span><span class="delete-conv">Delete</span>`;
                    div.onclick = () => loadConversation(id, conv);
                    div.querySelector('.delete-conv').onclick = e => { e.stopPropagation(); deleteConversation(id); };
                    convList.appendChild(div);
                });
        }
        function saveMessage(text, sender) {
            if (!currentConvId) return;
            push(ref(db, `users/${userId}/conversations/${currentConvId}/messages`), { text, sender, timestamp: Date.now() });
        }
        async function loadProfile() {
            const snap = await get(ref(db, `users/${userId}`));
            const data = snap.val() || {};
            slideName.textContent = data.displayName || 'Student';
            slideProfile.textContent = (data.displayName || 'S')[0].toUpperCase();
            isPro = data.plan === 'pro';
            updateTokenUI();
        }
        function toast(msg, dur = 2500) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), dur);
        }

        // ---------- EVENTS (all functional) ----------
        sendBtn.onclick = send;
        chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
        menuBtn.onclick = () => { sidebar.classList.add('open'); overlay.classList.add('on'); };
        overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('on'); };
        newConvBtn.onclick = () => { overlay.click(); startNewConversation(); };
        mockCheckout.onclick = async () => {
            await set(ref(db, `users/${userId}/plan`), 'pro');
            isPro = true; updateTokenUI(); upgradeModal.classList.remove('show');
            toast("ðŸŽ‰ Pro unlocked â€“ unlimited tutoring!");
        };
        closeModal.onclick = () => upgradeModal.classList.remove('show');

        function shiftInput() {
            const gap = window.innerHeight - document.documentElement.clientHeight;
            inputBar.style.transform = gap > 0 ? `translateY(-${gap}px)` : '';
        }
        window.addEventListener('resize', shiftInput);
        window.addEventListener('focusin', shiftInput);
        window.addEventListener('focusout', () => { inputBar.style.transform = ''; });

        document.addEventListener('paste', e => {
            const file = e.clipboardData?.files[0];
            if (file?.type.startsWith('image/')) {
                hiddenFile.files = e.clipboardData.files;
                hiddenFile.dispatchEvent(new Event('change'));
            }
        });

        // ---------- AUTH + ROLE + RESET ----------
        onAuthStateChanged(auth, async user => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            userId = user.uid;
            await initRemote();
            await resetIfNeeded();
            await askRoleAndName();
            await loadUsage();
            await loadProfile();
            onValue(ref(db, `users/${userId}/conversations`), snap => {
                conversations = snap.val() || {};
                renderSidebar();
            });
        });
    </script>
</body>
</html>
