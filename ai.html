<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy - Your CAPS Tutor</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Vynix%20Buddy%22,%22short_name%22:%22Vynix%22,%22description%22:%22Your%20CAPS%20AI%20Tutor%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192%22,%22sizes%22:%22192x192%22},{%22src%22:%22https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512%22,%22sizes%22:%22512x512%22}]}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    textarea,input,.content{-webkit-user-select:text;user-select:text}
    body{font-family:'Inter',sans-serif;background:#fff;color:#111827;margin:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    #chatPane{flex:1;overflow-y:auto;padding:1rem 1rem 140px;-webkit-overflow-scrolling:touch}
    .message{margin:1.5rem 0;position:relative}
    .message.ai .content{background:#f8f9fa;border:1px solid #e9ecef;border-radius:1rem;padding:1rem 1.2rem;max-width:88%}
    .message.user .content{background:#9ca3af;color:#111827;border-radius:1rem;padding:1rem 1.2rem;margin-left:auto;max-width:85%;white-space:pre-wrap;word-break:break-word}
    .timestamp{font-size:.75rem;color:#6b7280;margin-top:4px}
    .message.ai .timestamp{margin-left:8px}
    .message.user .timestamp{margin-right:8px;text-align:right}
    .ai-actions{display:flex;gap:12px;margin-top:8px;margin-left:8px;opacity:.8}
    .action-btn{width:36px;height:36px;background:#f1f3f4;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
    .action-btn:hover{background:#e0e0e0;transform:scale(1.1)}
    .thinking{display:flex;gap:8px;padding:1rem 1.2rem}
    .dot{width:10px;height:10px;background:#8b5cf6;border-radius:50%;animation:pulse 1.4s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
    .input-bar{position:fixed;bottom:0;left:0;right:0;padding:.75rem;padding-bottom:calc(.75rem + env(safe-area-inset-bottom));background:#fff;border-top:1px solid #e5e7eb;box-shadow:0 -4px 20px rgba(0,0,0,.08);z-index:100}
    .input-container{background:#f9fafb;border:1px solid #d1d5db;border-radius:1.5rem;padding:.75rem 1rem;display:flex;align-items:flex-end;gap:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.1);position:relative}
    .input-container:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.15)}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1rem;resize:none;max-height:120px;line-height:1.5}
    .send-btn{width:44px;height:44px;border-radius:50%;background:#8b5cf6;display:flex;align-items:center;justify-content:center}
    .send-btn:disabled{background:#9ca3af}
    .upload-btn{width:44px;height:44px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
    .token-bar{position:fixed;top:0;left:0;right:0;background:#8b5cf6;color:#fff;padding:.6rem 1rem;font-size:.9rem;text-align:center;z-index:50;display:flex;align-items:center;justify-content:center;gap:.5rem}
    .bottom-sheet{position:fixed;bottom:-100%;left:0;right:0;background:#fff;border-radius:1.5rem 1.5rem 0 0;padding:1.5rem;box-shadow:0 -10px 40px rgba(0,0,0,.25);transition:bottom .4s cubic-bezier(.32,.72,0,1);z-index:200;max-height:92dvh;overflow-y:auto}
    .bottom-sheet.active{bottom:0}
    .sheet-handle{width:40px;height:5px;background:#ddd;border-radius:3px;margin:0 auto 1rem}
    #customAlert{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-150%);background:linear-gradient(135deg,#8b5cf6 0%,#ec4899 100%);color:#fff;padding:1rem 1.5rem;border-radius:9999px;font-weight:600;box-shadow:0 10px 25px rgba(0,0,0,.25);z-index:9999;transition:transform .3s ease}
    #customAlert.show{transform:translateX(-50%) translateY(0)}
    
    /* NEW: CAPS Tracker and Exam Banner */
    .caps-tracker{position:fixed;top:40px;left:0;right:0;background:#fff3cd;border-bottom:1px solid #ffeaa7;padding:.5rem 1rem;font-size:.8rem;z-index:49;display:flex;justify-content:space-between;align-items:center}
    .exam-banner{position:fixed;top:75px;left:0;right:0;background:#fee;border-bottom:1px solid #fcc;padding:.5rem 1rem;font-size:.8rem;z-index:48;display:none}
    .exam-banner.active{display:block}
    
    /* NEW: Role Toggle */
    .role-toggle{position:absolute;top:-32px;left:0;right:0;display:flex;justify-content:center;gap:.5rem}
    .role-btn{padding:.3rem .8rem;border-radius:9999px;font-size:.75rem;font-weight:600;transition:all .2s;border:1px solid #d1d5db;background:#f9fafb}
    .role-btn.active{background:#8b5cf6;color:#fff;border-color:#8b5cf6}
    
    /* Custom Icons */
    .icon-caps{width:18px;height:18px;fill:none;stroke:currentColor;stroke-width:2}
  </style>
</head>
<body>

  <!-- Token Bar -->
  <div class="token-bar">
    <span>ðŸŽ“ Study Bundle: </span>
    <span id="tokenCount">15,000 MB</span>
    <button id="upgradePill" class="ml-3 px-4 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold text-sm rounded-full border border-white/40 transition active:scale-95">Recharge R79 ðŸš€</button>
  </div>

  <!-- CAPS Tracker -->
  <div id="capsTracker" class="caps-tracker">
    <div class="flex items-center gap-2">
      <span class="text-amber-800">ðŸ“Š Term 2 Progress:</span>
      <div class="w-32 h-2 bg-amber-200 rounded-full overflow-hidden">
        <div id="progressBar" class="w-0 h-full bg-amber-500 transition-all duration-500"></div>
      </div>
      <span id="progressPercent" class="text-amber-700">0%</span>
    </div>
    <button onclick="showCapsBreakdown()" class="text-purple-600 hover:text-purple-700 font-semibold">View ATP</button>
  </div>

  <!-- Exam Countdown -->
  <div id="examBanner" class="exam-banner">
    <div class="flex items-center justify-center gap-2">
      <span id="countdownText">Loading exam dates...</span>
      <button onclick="generateRevisionPlan()" class="text-red-600 font-semibold">Generate 90-day plan ðŸŽ¯</button>
    </div>
  </div>

  <!-- Chat Pane -->
  <section id="chatPane">
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor â€¢ Grades 10â€“12 â€¢ ðŸ‡¿ðŸ‡¦</p>
    </div>
  </section>

  <!-- Input Bar -->
  <div class="input-bar">
    <div class="input-container">
      <div class="role-toggle">
        <button onclick="setRole('learner')" class="role-btn active">Learner</button>
        <button onclick="setRole('parent')" class="role-btn">Parent</button>
        <button onclick="setRole('teacher')" class="role-btn">Teacher</button>
      </div>
      <button class="upload-btn" id="uploadBtn" aria-label="Attach image">
        <svg class="icon-caps" viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
      </button>
      <input type="file" id="hiddenFile" accept="image/*" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1" aria-label="Chat input"></textarea>
      <button id="sendBtn" class="send-btn" disabled aria-label="Send">
        <svg class="icon-caps text-white" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
      </button>
    </div>
  </div>

  <!-- Upgrade Sheet -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">Ã—</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-3">Never Run Out of Help Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to <span class="text-purple-600 font-bold">Unlimited</span> and study without limits</p>
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-10 py-7 rounded-2xl shadow-2xl transform -rotate-2 mb-10">
        <div class="text-5xl font-black">UNLIMITED</div>
        <div class="text-xl opacity-90">No more bundles, just freedom ðŸ“š</div>
        <div class="text-sm mt-2">Like night-time data, but for studying!</div>
      </div>
      <div class="space-y-6 text-left bg-gray-50 rounded-3xl p-8 mb-8 text-lg font-medium">
        <div class="flex items-center gap-4">âœ“ Unlimited AI messages</div>
        <div class="flex items-center gap-4">âœ“ Premium ElevenLabs voice</div>
        <div class="flex items-center gap-4">âœ“ Download answers as PDF</div>
        <div class="flex items-center gap-4">âœ“ Faster responses</div>
        <div class="flex items-center gap-4">âœ“ Support SA education (5% donated)</div>
      </div>
      <button id="mockUpgrade" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-2xl py-6 rounded-3xl shadow-2xl hover:scale-105 active:scale-95">Yes! Upgrade Me Now â€“ R79/month</button>
    </div>
  </div>

  <!-- Past Papers Sheet -->
  <div id="papersSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('papersSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">Ã—</button>
    <div id="papersContent" class="px-2"></div>
  </div>

  <!-- Custom Alert -->
  <div id="customAlert" role="alert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";

    const { jsPDF } = window.jspdf;

    // SA Role Models for subjects
    const saRoleModels = {
      Mathematics: ["Prof. Mamokgethi Phakeng", "Prof. Sibusiso Moyo"],
      "Physical Sciences": ["Prof. Himla Soodyall", "Dr. Tshiamo Molefe"],
      "Life Sciences": ["Prof. Kelly Chibale", "Dr. Nox Makunga"],
      Accounting: ["Prof. Nicolaas van Wyk"],
      "Business Studies": ["Dr. Phumzile Mmope"],
      Geography: ["Prof. Hein de Boer"],
      History: ["Prof. Shadreck Chirikure"],
      "English HL": ["Prof. Sarah Hlengethwa"]
    };

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });
    const auth = getAuth(app);
    const db = getDatabase(app);

    let userProfile = { role: 'learner' };
    let xaiKey = null;
    let elevenlabsKey = null;
    let yocoPublicKey = null;
    let yocoEnabled = false;
    let history = [];
    let currentImage = null;
    let waitingForProfile = false;
    let dailyTokens = 15000;
    let isPremium = false;

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      mockUpgrade: document.getElementById('mockUpgrade'),
      upgradePill: document.getElementById('upgradePill'),
      papersSheet: document.getElementById('papersSheet'),
      papersContent: document.getElementById('papersContent'),
      progressBar: document.getElementById('progressBar'),
      progressPercent: document.getElementById('progressPercent'),
      examBanner: document.getElementById('examBanner'),
      countdownText: document.getElementById('countdownText')
    };

    // Service Worker for Offline Mode
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript,' + encodeURIComponent(`
        const CACHE_NAME = 'vynix-caps-v1';
        const urlsToCache = ['/', '/index.html'];
        self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache))));
        self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
      `)).then(() => console.log('ðŸ“´ Offline Mode: Activated'));
    }

    function customAlert(msg, duration = 2500) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }

    function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }
    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { 
        els.upgradeSheet.classList.add('active'); 
        return false; 
      }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString() + ' MB';
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const userData = userSnap.val();
        if (userData?.premium) {
          isPremium = true; dailyTokens = 999999;
          document.querySelector('.token-bar').innerHTML = `<div class="flex items-center justify-center gap-3"><span>ðŸš€ Unlimited access â€¢ Premium</span></div>`;
          return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val(); const now = Date.now(); const oneDay = 24 * 60 * 60 * 1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000; await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString() + ' MB';
      } catch { 
        dailyTokens = 15000; 
        els.tokenCount.textContent = dailyTokens.toLocaleString() + ' MB'; 
      }
    }

    function loadYocoScript() {
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }

    async function startYocoPayment() {
      try {
        await loadYocoScript();
        const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
        const result = await yoco.showPopup({
          amountInCents: 7900, currency: 'ZAR', name: 'Vynix Buddy Unlimited',
          description: 'R79/month â€“ Unlimited AI tutoring',
          metadata: { userId: auth.currentUser.uid }, callbackUrl: location.href
        });
        if (result?.paymentResult?.status === 'successful') {
          await update(ref(db, `users/${auth.currentUser.uid}`), { premium: true, premiumSince: new Date().toISOString() });
          isPremium = true; await loadTokens(); els.upgradeSheet.classList.remove('active');
          customAlert("Payment successful! You're now on Unlimited!");
        }
      } catch (e) { customAlert("Payment cancelled or failed."); }
    }

    // SA Onboarding
    async function saOnboarding() {
      const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/saProfile`));
      userProfile = snap.val() || { role: 'learner' };
      
      if (!userProfile?.name) {
        waitingForProfile = true;
        const questions = [
          "Sawubona! I'm Vynix Buddy, your CAPS tutor. What's your name? ðŸ‘‹",
          "Molo! Which grade are you in? (10, 11, or 12)",
          "CAPS or IEB? Type 'CAPS' or 'IEB'",
          "Which province? (Gauteng, WC, KZN, etc.)",
          "Home language? (e.g., isiZulu, Afrikaans, Sepedi)"
        ];
        
        let i = 0;
        addMessage(questions[i], 'ai');
        
        const handler = async (e) => {
          if (e.key !== 'Enter' || e.shiftKey) return;
          e.preventDefault();
          const answer = els.chatInput.value.trim();
          if (!answer) return;
          els.chatInput.value = '';
          addMessage(answer, 'user');
          
          if (i === 0) userProfile.name = answer;
          else if (i === 1) userProfile.grade = answer;
          else if (i === 2) userProfile.curriculum = answer;
          else if (i === 3) userProfile.province = answer;
          else if (i === 4) {
            userProfile.homeLang = answer;
            await set(ref(db, `users/${auth.currentUser.uid}/saProfile`), userProfile);
            waitingForProfile = false;
            addMessage(`Perfect, ${userProfile.name}! I'll tailor your ${userProfile.curriculum} Grade ${userProfile.grade} content for ${userProfile.province}. Lebaka!`, 'ai');
            els.chatInput.removeEventListener('keydown', handler);
            updateExamCountdown();
            return;
          }
          i++;
          if (i < questions.length) setTimeout(() => addMessage(questions[i], 'ai'), 500);
        };
        els.chatInput.addEventListener('keydown', handler);
      } else {
        addMessage(`Welcome back, ${userProfile.name}! Ready for Grade ${userProfile.grade} ${userProfile.curriculum}?`, 'ai');
        updateExamCountdown();
      }
    }

    function updateExamCountdown() {
      if (!userProfile?.province) return;
      const examDates = {
        'Gauteng': '2025-10-20', 'Western Cape': '2025-10-18', 'KwaZulu-Natal': '2025-10-22',
        'Eastern Cape': '2025-10-19', 'Free State': '2025-10-21', 'Limpopo': '2025-10-23',
        'Mpumalanga': '2025-10-20', 'North West': '2025-10-19', 'Northern Cape': '2025-10-18'
      };
      const examDate = new Date(examDates[userProfile.province] || '2025-10-20');
      const today = new Date();
      const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
      
      if (daysLeft > 0 && daysLeft < 120) {
        els.examBanner.classList.add('active');
        els.countdownText.textContent = `â° ${daysLeft} days to NSC finals in ${userProfile.province}!`;
      }
    }

    async function generateRevisionPlan() {
      addMessage(`Generate a 90-day revision plan for Grade ${userProfile.grade} ${userProfile.curriculum}`, 'user');
      await send();
    }

    async function showCapsBreakdown() {
      customAlert("ATP View coming soon! Tracking your CAPS progress...");
    }

    function setRole(role) {
      userProfile.role = role;
      document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      customAlert(`Switched to ${role} mode`);
    }

    // Enhanced CAPS Exam Generator
    async function generateCapsExamPaper(subject, grade, topic) {
      const prompt = `Generate a CAPS ${grade} ${subject} exam paper on "${topic}" following EXACT DBE format:
      
      COVER PAGE:
      NATIONAL SENIOR CERTIFICATE
      GRADE ${grade} ${subject.toUpperCase()}
      ${userProfile.province?.toUpperCase() || 'SOUTH AFRICA'} ${new Date().getFullYear()}
      
      INSTRUCTIONS:
      1. Write your name & province
      2. Answer ALL questions
      3. Show ALL calculations
      4. Use black/blue pen only
      
      QUESTION 1 (20 marks) - Cognitive Level 2: Routine Procedures
      [Straightforward question on ${topic} with clear steps]
      
      QUESTION 2 (25 marks) - Cognitive Level 3: Complex Procedures
      [Multi-step problem with diagrams]
      
      QUESTION 3 (30 marks) - Cognitive Level 4: Problem Solving
      [SA context: "A learner in ${userProfile.province}...", "A taxi driver..."]
      
      QUESTION 4 (25 marks) - Analysis
      [Evaluate/justify question]
      
      ---MEMO---
      
      MEMORANDUM
      QUESTION 1
      1.1 âœ“ Correct formula (2 marks) âœ“ Substitution (2 marks) âœ“ Answer (1 mark)
      
      TOTAL MARKS: 100 | TIME: 2 hours`;
      
      addThinking();
      const cost = 2500;
      if (!(await deductTokens(cost))) {
        removeThinking();
        return null;
      }

      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-3", messages: [{role:"user",content:prompt}], max_tokens: 8000, temperature: 0.7 })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || null;
      } catch (e) {
        console.error(e);
        return null;
      } finally {
        removeThinking();
      }
    }

    function showPastPapersSheet() {
      const grade = userProfile?.grade || "12";
      const name = userProfile?.name || "learner";
      
      els.papersContent.innerHTML = `
        <h3 class="text-xl font-bold mb-4">Generate CAPS Practice Paper</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Subject</label>
            <select id="subjectSelect" class="w-full border rounded-lg p-2 bg-white">
              <option value="Mathematics">Mathematics</option>
              <option value="Physical Sciences">Physical Sciences</option>
              <option value="Life Sciences">Life Sciences</option>
              <option value="Accounting">Accounting</option>
              <option value="Business Studies">Business Studies</option>
              <option value="Geography">Geography</option>
              <option value="History">History</option>
              <option value="English HL">English HL</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Topic (e.g., Calculus, Chemical Equilibrium)</label>
            <input type="text" id="topicInput" class="w-full border rounded-lg p-2" placeholder="Enter specific topic">
          </div>
          <button id="generatePaperBtn" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">Generate 5 Tough Questions + Memo</button>
        </div>
      `;
      els.papersSheet.classList.add('active');
      
      document.getElementById('generatePaperBtn').addEventListener('click', async () => {
        const subject = document.getElementById('subjectSelect').value;
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) return customAlert("Please enter a topic");
        els.papersSheet.classList.remove('active');
        
        const examText = await generateCapsExamPaper(subject, grade, topic);
        if (!examText) return customAlert("Failed to generate paper. Check tokens.");
        
        const [qp, memo] = examText.split("---MEMO---");
        const doc = new jsPDF();
        
        // Cover
        doc.setFontSize(22); doc.setTextColor(139,92,246);
        doc.text("VYNIX BUDDY CAPS", 105, 30, {align:"center"});
        doc.setTextColor(0); doc.setFontSize(18);
        doc.text("PRACTICE EXAM PAPER", 105, 45, {align:"center"});
        doc.setFontSize(14); doc.text(`${subject} - Grade ${grade}`, 105, 60, {align:"center"});
        doc.text(`Topic: ${topic}`, 105, 75, {align:"center"});
        doc.text(`For: ${name} | ${userProfile.province || 'SA'}`, 105, 90, {align:"center"});
        doc.setFontSize(12); doc.text(`Generated: ${new Date().toLocaleDateString('en-ZA')}`, 105, 105, {align:"center"});
        
        // Question Paper
        doc.addPage();
        doc.setFontSize(16); doc.text("QUESTION PAPER", 105, 20, {align:"center"});
        doc.setFontSize(11);
        doc.text(doc.splitTextToSize("Instructions: Answer all questions. Show ALL working. Use black pen.", 170), 15, 35);
        
        let yPos = 50;
        const questions = (qp || examText).split(/QUESTION \d+/gi).filter(q => q.trim());
        questions.slice(0, 5).forEach((q, idx) => {
          if (yPos > 240) { doc.addPage(); yPos = 20; }
          doc.setFontSize(12); doc.setFont(undefined, "bold");
          doc.text(`QUESTION ${idx + 1} (20 marks)`, 15, yPos); yPos += 8;
          doc.setFont(undefined, "normal");
          const cleanQ = q.replace(/\*\*/g, '').replace(/\*/g, '').replace(/\$/g, '');
          doc.text(doc.splitTextToSize(cleanQ, 170), 20, yPos); yPos += 6;
        });
        
        // Memo
        doc.addPage();
        doc.setFontSize(16); doc.text("MEMORANDUM", 105, 20, {align:"center"});
        doc.setFontSize(11);
        const cleanMemo = (memo || "No memo").replace(/\*\*/g, '').replace(/\*/g, '').replace(/\$/g, '');
        doc.text(doc.splitTextToSize(cleanMemo, 180), 15, 35);
        
        doc.save(`CAPS_${subject.replace(/\s/g,"_")}_G${grade}_${topic.replace(/\s/g,"_")}.pdf`);
        customAlert("Practice paper downloaded! Hawu, you're ready!");
      });
    }

    // Custom icon renderer
    function renderIcon(name) {
      const icons = {
        copy: '<svg class="icon-caps" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><rect x="2" y="2" width="13" height="13" rx="2"/></svg>',
        'volume-2': '<svg class="icon-caps" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>',
        download: '<svg class="icon-caps" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>',
        'file-text': '<svg class="icon-caps" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>'
      };
      return icons[name] || icons.copy;
    }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      const time = formatTime();
      
      if (sender === 'ai' && !isImage) {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn" aria-label="Copy">${renderIcon('copy')}</button>
            <button class="action-btn voice-btn" aria-label="Listen">${renderIcon('volume-2')}</button>
            <button class="action-btn pdf-btn" aria-label="Download PDF">${renderIcon('download')}</button>
            <button class="action-btn papers-btn" aria-label="Past Papers">${renderIcon('file-text')}</button>
          </div>
          <div class="timestamp">${time}</div>`;
      } else {
        const userText = isImage ? content : content.replace(/\n/g, '<br>');
        div.innerHTML = `<div class="content">${userText}</div><div class="timestamp">${time}</div>`;
      }
      
      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;

      if (sender === 'ai' && !isImage) {
        div.querySelector('.copy-btn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plainText || content);
          const btn = div.querySelector('.copy-btn');
          btn.innerHTML = renderIcon('check');
          setTimeout(() => btn.innerHTML = renderIcon('copy'), 2000);
        });
        
        div.querySelector('.voice-btn')?.addEventListener('click', async () => {
          const text = plainText || content; if (!text) return;
          const btn = div.querySelector('.voice-btn');
          btn.disabled = true;
          btn.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
          
          try {
            if (!elevenlabsKey) throw new Error('Voice not configured');
            const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${'pNInz6obpgDQGcFmaJgB'}`, {
              method: 'POST',
              headers: { 'Accept': 'audio/mpeg', 'Content-Type': 'application/json', 'xi-api-key': elevenlabsKey },
              body: JSON.stringify({ text: text, model_id: 'eleven_monolingual_v1', voice_settings: { stability: 0.5, similarity_boost: 0.5 } })
            });
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.onended = () => { URL.revokeObjectURL(audioUrl); btn.innerHTML = renderIcon('volume-2'); btn.disabled = false; };
            await audio.play();
          } catch (err) {
            customAlert('Voice temporarily unavailable');
            btn.innerHTML = renderIcon('volume-2'); btn.disabled = false;
          }
        });

        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11); doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_Answer_${new Date().toISOString().slice(0,10)}.pdf`);
        });

        div.querySelector('.papers-btn')?.addEventListener('click', showPastPapersSheet);
      }
    }

    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking';
      d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    async function send() {
      if (waitingForProfile) return;
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      
      const cost = estimateTokens(text) + (currentImage ? 500 : 0);
      if (!(await deductTokens(cost))) {
        addMessage("Hawu! You've run out of study data. Recharge for just R79/month and get unlimited access.", 'ai');
        return;
      }
      
      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="User upload">`, 'user');
        history.push({ role: "user", content: `[Image: ${currentImage}] Explain this homework` });
        text = "Explain this homework";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }
      
      els.chatInput.value = ''; currentImage = null; els.sendBtn.disabled = true; els.chatInput.style.height = 'auto';
      addThinking();
      
      const reply = await getReply(text);
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting to Grok...";
      
      // Build CAPS-specific system prompt
      const roleModel = saRoleModels[userProfile?.favSubject || "Mathematics"]?.[0] || "a South African scientist";
      let promptModifier = "";
      if (userProfile.role === 'parent') {
        promptModifier = `Explain as if to a parent helping their child. Use "Mama, check if they..."`;
      } else if (userProfile.role === 'teacher') {
        promptModifier = `Provide lesson plan format. Include "Teacher Notes" & "Common Misconceptions".`;
      }
      
      const systemPrompt = `You are Vynix Buddy, a warm Sotho/Tswana-style tutor who says "lebaka!" (great job) and "hawu!" (wow!). 
      Reference CAPS ATP, "Cognitive Level 4", "SBA requirements". Structure answers:
      1. **Key Concept**
      2. **Worked Example** (step-by-step)
      3. **Check Your Understanding** (practice)
      4. **Common Mistakes** (SA learners)
      
      Reference ${roleModel}'s work. Use ${userProfile.name}'s name naturally.
      ${promptModifier}`;
      
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-3",
            messages: [{ role: "system", content: systemPrompt }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        console.error(e);
        return "No internet connection. Please check your network.";
      }
    }

    // Viewport & Input handling
    const viewport = window.visualViewport || window;
    function handleKeyboard() {
      const kh = window.innerHeight - (viewport.height || window.innerHeight);
      document.querySelector('.input-bar').style.transform = kh > 100 ? `translateY(-${kh}px)` : 'translateY(0)';
    }
    viewport.addEventListener('resize', handleKeyboard);
    viewport.addEventListener('scroll', handleKeyboard);
    els.chatInput.addEventListener('focus', () => setTimeout(handleKeyboard, 300));

    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      els.sendBtn.disabled = !els.chatInput.value.trim() && !currentImage;
    });

    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file); fd.append('upload_preset', 'studybuddy');
      const res = await fetch("https://api.cloudinary.com/v1_1/dhvzhirjf/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.secure_url) { currentImage = data.secure_url; els.sendBtn.disabled = false; }
    };

    // Upgrade handlers
    els.mockUpgrade.onclick = () => yocoEnabled ? startYocoPayment() : customAlert("Upgrade coming soon!");
    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');
    els.upgradeSheet.addEventListener('click', (e) => {
      if (e.target === els.upgradeSheet) els.upgradeSheet.classList.remove('active');
    });

    els.sendBtn.onclick = send;

    // Initialize
    const rc = getRemoteConfig(app);
    await fetchAndActivate(rc);
    xaiKey = getString(rc, 'xai_api_key')?.trim();
    elevenlabsKey = getString(rc, 'elevenlabs_api_key')?.trim();
    yocoPublicKey = getString(rc, 'yoco_public_key')?.trim();
    yocoEnabled = getBoolean(rc, 'yoco_enabled');

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      await loadTokens();
      await saOnboarding();
    });

    // Simulate CAPS progress after login
    setTimeout(() => {
      els.progressBar.style.width = '60%';
      els.progressPercent.textContent = '60%';
    }, 3000);
  </script>
</body>
</html>
