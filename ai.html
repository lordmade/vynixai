<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix FB Style</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #050505;
      --text-sec: #65676b;
      --accent: #1877f2; /* Facebook Blue */
      --divider: #ced0d4;
      --sheet-bg: #ffffff;
    }
    
    [data-theme="dark"] {
      --bg: #18191a;
      --card: #242526;
      --text: #e4e6eb;
      --text-sec: #b0b3b8;
      --accent: #2d88ff;
      --divider: #3e4042;
      --sheet-bg: #242526;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      /* Disable Long Press Highlight */
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    /* Allow text selection only on content for readability/copying */
    .selectable-text { user-select: text; }

    /* --- COMPOSER --- */
    .composer-card {
      background: var(--card);
      padding: 12px 16px;
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .composer-top { display: flex; gap: 10px; align-items: center; }
    .composer-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .composer-input {
      background: var(--bg);
      border-radius: 20px;
      padding: 10px 15px;
      flex: 1;
      color: var(--text);
      font-size: 16px;
      border: none;
      outline: none;
      cursor: text;
    }
    .composer-actions {
      display: flex;
      justify-content: space-between;
      border-top: 1px solid var(--divider);
      margin-top: 12px;
      padding-top: 8px;
    }
    .comp-btn {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 8px;
      border-radius: 8px;
      color: var(--text-sec);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
    .comp-btn:active { background: rgba(0,0,0,0.05); }

    /* --- FEED POSTS (FB STYLE) --- */
    .post-card {
      background: var(--card);
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .post-header {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      align-items: center;
    }
    .header-left { display: flex; gap: 10px; }
    .p-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .p-meta { display: flex; flex-direction: column; justify-content: center; }
    .p-name { font-weight: 600; font-size: 15px; color: var(--text); }
    .p-time { font-size: 13px; color: var(--text-sec); display: flex; align-items: center; gap: 4px; }
    
    .post-content {
      padding: 4px 16px 16px 16px;
      font-size: 15px;
      line-height: 1.5;
    }
    
    .post-media {
      width: 100%;
      height: auto;
      display: block;
      border-top: 1px solid var(--divider);
      border-bottom: 1px solid var(--divider);
      background: #000;
    }

    .post-stats {
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text-sec);
      border-bottom: 1px solid var(--divider);
    }
    .stat-icon { display: flex; align-items: center; gap: 4px; }
    .like-bubble { background: var(--accent); color: white; border-radius: 50%; padding: 3px; font-size: 10px; }

    .post-actions-grid {
      display: flex;
      padding: 4px;
    }
    .action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      border-radius: 4px;
      color: var(--text-sec);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.1s;
    }
    .action-btn:active { background: rgba(0,0,0,0.05); }
    [data-theme="dark"] .action-btn:active { background: rgba(255,255,255,0.1); }

    /* Active States */
    .action-btn.liked { color: var(--accent); }
    .action-btn.liked .material-icons-outlined { font-family: 'Material Icons'; } /* Fill icon */

    /* --- BOTTOM SHEET --- */
    .overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      z-index: 40;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .overlay.show { opacity: 1; pointer-events: auto; }

    .bottom-sheet {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--sheet-bg);
      border-radius: 16px 16px 0 0;
      height: 70vh;
      z-index: 50;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex; flex-direction: column;
    }
    .bottom-sheet.show { transform: translateY(0); }

    .sheet-header {
      padding: 10px; text-align: center;
      border-bottom: 1px solid var(--divider);
      position: relative;
    }
    .drag-handle {
      width: 40px; height: 5px; background: var(--divider);
      border-radius: 10px; margin: 0 auto 10px auto;
    }
    .close-sheet { position: absolute; right: 16px; top: 16px; cursor: pointer; }

    .comments-container { flex: 1; overflow-y: auto; padding: 16px; }
    
    .comment-item { display: flex; gap: 10px; margin-bottom: 16px; }
    .c-avatar { width: 32px; height: 32px; border-radius: 50%; }
    .c-bubble {
      background: var(--bg);
      padding: 8px 12px;
      border-radius: 18px;
    }
    .c-name { font-weight: 700; font-size: 13px; color: var(--text); }
    .c-text { font-size: 14px; color: var(--text); margin-top: 2px; }

    .comment-input-area {
      padding: 12px;
      border-top: 1px solid var(--divider);
      display: flex; gap: 8px; align-items: center;
    }
    .c-input {
      flex: 1; background: var(--bg); border: none; outline: none;
      padding: 10px 14px; border-radius: 20px; color: var(--text);
    }
    .send-btn { color: var(--accent); cursor: pointer; }

    /* Spinner */
    .spinner { border: 3px solid rgba(128,128,128,0.3); border-top: 3px solid var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="composer-card">
  <div class="composer-top">
    <img id="my-avatar" class="composer-avatar" src=""/>
    <div class="composer-input" id="composer-trigger">What's on your mind?</div>
  </div>
  <div class="composer-actions">
    <label for="file-input" class="comp-btn">
      <span class="material-icons" style="color:#45bd62">photo_library</span> Photo
    </label>
    <div class="comp-btn"><span class="material-icons" style="color:#f7b928">sentiment_satisfied</span> Feeling</div>
  </div>
</div>

<input type="file" id="file-input" accept="image/*" class="hidden"/>

<main id="feed"></main>

<div id="scroll-trigger" class="spinner hidden"></div>

<div id="overlay" class="overlay" onclick="closeSheet()"></div>
<div id="comment-sheet" class="bottom-sheet">
  <div class="sheet-header">
    <div class="drag-handle"></div>
    <span style="font-weight:600">Comments</span>
    <span class="material-icons close-sheet" onclick="closeSheet()">close</span>
  </div>
  <div id="sheet-comments-list" class="comments-container"></div>
  <div class="comment-input-area">
    <input type="text" id="comment-text" class="c-input selectable-text" placeholder="Write a comment..." />
    <span class="material-icons send-btn" id="send-comment-btn">send</span>
  </div>
</div>

<div id="toast" style="position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:20px; opacity:0; transition:0.3s; pointer-events:none; font-size:14px; z-index:100;">Action</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, push, set, remove, query, limitToLast, orderByChild, endAt, get, serverTimestamp, runTransaction, onValue, off } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// --- STATE ---
let uid, uname, uavatar;
let activePostId = null; // For comments
let lastPostTime = null;
let isLoadingPosts = false;
let allPostsLoaded = false;

// --- AUTH ---
onAuthStateChanged(auth, user => {
  if (user) {
    setupUser(user);
  } else {
    signInAnonymously(auth).catch(e => console.error(e));
  }
});

function setupUser(user) {
  uid = user.uid;
  uname = "User " + uid.substring(0,4); // Simplified name
  uavatar = `https://ui-avatars.com/api/?background=1877f2&color=fff&name=${uname}`;
  document.getElementById('my-avatar').src = uavatar;
  loadPosts();
}

// --- CLOUDINARY UPLOAD ---
// Replace these with your actual Cloudinary details
const CLOUD_NAME = "YOUR_CLOUD_NAME"; 
const UPLOAD_PRESET = "YOUR_UNSIGNED_PRESET"; 

async function handleUpload(file) {
  if(!file) return null;
  showToast("Uploading image...");
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  
  try {
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: fd });
    const data = await res.json();
    return data.secure_url;
  } catch(e) {
    showToast("Upload failed");
    return null;
  }
}

// --- POSTING ---
const composerTrigger = document.getElementById('composer-trigger');
const fileInput = document.getElementById('file-input');

// Simple prompt for text posting (to keep UI clean)
composerTrigger.onclick = async () => {
  const text = prompt("What's on your mind?");
  if(text) createPost(text, null);
};

fileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  
  const text = prompt("Add a caption (optional):") || "";
  const imageUrl = await handleUpload(file);
  if(imageUrl) createPost(text, imageUrl);
};

function createPost(text, image) {
  const newRef = push(ref(db, 'posts'));
  const postData = {
    authorId: uid, authorName: uname, authorAvatar: uavatar,
    text, image,
    likesCount: 0, commentsCount: 0,
    timestamp: serverTimestamp()
  };
  set(newRef, postData).then(() => {
    showToast("Posted!");
    // Optimistic render at top
    feedEl.prepend(renderPostCard({ key: newRef.key, ...postData, timestamp: Date.now() }));
  });
}

// --- INFINITE FEED LOGIC ---
const feedEl = document.getElementById('feed');
const loaderEl = document.getElementById('scroll-trigger');

async function loadPosts() {
  if(isLoadingPosts || allPostsLoaded) return;
  isLoadingPosts = true;
  loaderEl.classList.remove('hidden');

  const postsRef = ref(db, 'posts');
  let q;

  if (lastPostTime === null) {
    q = query(postsRef, orderByChild('timestamp'), limitToLast(5));
  } else {
    q = query(postsRef, orderByChild('timestamp'), endAt(lastPostTime - 1), limitToLast(5));
  }

  const snapshot = await get(q);
  loaderEl.classList.add('hidden');
  isLoadingPosts = false;

  if (!snapshot.exists()) {
    allPostsLoaded = true;
    if(lastPostTime === null) feedEl.innerHTML = "<div style='text-align:center; padding:20px; color:#999'>No posts found.</div>";
    return;
  }

  const posts = [];
  snapshot.forEach(c => posts.push({ key: c.key, ...c.val() }));
  posts.reverse(); // Newest first

  lastPostTime = posts[posts.length - 1].timestamp;

  posts.forEach(p => {
    // Check if user liked this post to highlight button
    const isLiked = p.likes && p.likes[uid] === true;
    feedEl.appendChild(renderPostCard(p, isLiked));
  });
}

window.onscroll = () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
    loadPosts();
  }
};

// --- RENDER POST (FB STYLE) ---
function renderPostCard(p, isLiked = false) {
  const div = document.createElement('div');
  div.className = 'post-card';
  div.id = `post-${p.key}`;

  // Sanitize
  const safeText = p.text ? p.text.replace(/</g, "&lt;") : "";
  const likesCount = p.likes ? Object.keys(p.likes).length : 0;
  
  div.innerHTML = `
    <div class="post-header">
      <div class="header-left">
        <img src="${p.authorAvatar}" class="p-avatar">
        <div class="p-meta">
          <span class="p-name">${p.authorName}</span>
          <span class="p-time">${timeAgo(p.timestamp)} <span class="material-icons" style="font-size:12px">public</span></span>
        </div>
      </div>
      ${p.authorId === uid ? `<span class="material-icons" style="color:#65676b; cursor:pointer" onclick="deletePost('${p.key}')">more_horiz</span>` : ''}
    </div>

    <div class="post-content selectable-text">${safeText}</div>

    ${p.image ? `<img src="${p.image}" class="post-media" loading="lazy">` : ''}

    <div class="post-stats">
      <div class="stat-icon">
        <span class="material-icons like-bubble">thumb_up</span>
        <span id="like-count-${p.key}">${likesCount}</span>
      </div>
      <div>
        <span id="comment-count-${p.key}">${p.commentsCount || 0}</span> comments
      </div>
    </div>

    <div class="post-actions-grid">
      <div class="action-btn ${isLiked ? 'liked' : ''}" id="btn-like-${p.key}" onclick="toggleLike('${p.key}')">
        <span class="material-icons-outlined">thumb_up</span> Like
      </div>
      <div class="action-btn" onclick="openComments('${p.key}')">
        <span class="material-icons-outlined">chat_bubble_outline</span> Comment
      </div>
      <div class="action-btn" onclick="sharePost('${p.key}', '${safeText}')">
        <span class="material-icons-outlined">share</span> Share
      </div>
    </div>
  `;
  return div;
}

// --- ACTIONS ---

// 1. LIKE (Transaction to prevent duplicates)
window.toggleLike = (postId) => {
  const postRef = ref(db, `posts/${postId}`);
  const btn = document.getElementById(`btn-like-${postId}`);
  const countEl = document.getElementById(`like-count-${postId}`);
  
  // Optimistic UI update
  const isLikedNow = btn.classList.contains('liked');
  if(isLikedNow) {
     btn.classList.remove('liked');
     countEl.innerText = parseInt(countEl.innerText) - 1;
  } else {
     btn.classList.add('liked');
     countEl.innerText = parseInt(countEl.innerText) + 1;
  }

  runTransaction(postRef, (post) => {
    if (post) {
      if (!post.likes) post.likes = {};
      if (post.likes[uid]) {
        post.likes[uid] = null; // Unlike
      } else {
        post.likes[uid] = true; // Like
      }
      post.likesCount = Object.keys(post.likes).length;
    }
    return post;
  });
};

// 2. DELETE
window.deletePost = (key) => {
  if(confirm("Delete this post?")) {
    remove(ref(db, `posts/${key}`));
    document.getElementById(`post-${key}`).remove();
    showToast("Post deleted");
  }
};

// 3. SHARE (Web Share API)
window.sharePost = (key, text) => {
  if (navigator.share) {
    navigator.share({
      title: 'Vynix Post',
      text: text,
      url: window.location.href
    }).catch(console.error);
  } else {
    // Fallback
    navigator.clipboard.writeText(window.location.href);
    showToast("Link copied to clipboard");
  }
};

// --- COMMENTS (BOTTOM SHEET) ---
const sheetEl = document.getElementById('comment-sheet');
const overlayEl = document.getElementById('overlay');
const commentsListEl = document.getElementById('sheet-comments-list');
let commentsUnsubscribe = null;

window.openComments = (postId) => {
  activePostId = postId;
  sheetEl.classList.add('show');
  overlayEl.classList.add('show');
  commentsListEl.innerHTML = '<div class="spinner"></div>';
  
  // Realtime listener for comments on this post
  const commentsRef = ref(db, `comments/${postId}`);
  commentsUnsubscribe = onValue(commentsRef, (snapshot) => {
    commentsListEl.innerHTML = '';
    if(!snapshot.exists()) {
      commentsListEl.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px">No comments yet. Be the first!</div>';
      return;
    }
    snapshot.forEach(child => {
      const c = child.val();
      const div = document.createElement('div');
      div.className = 'comment-item';
      div.innerHTML = `
        <img src="${c.avatar}" class="c-avatar">
        <div>
          <div class="c-bubble">
            <div class="c-name">${c.name}</div>
            <div class="c-text selectable-text">${c.text}</div>
          </div>
        </div>
      `;
      commentsListEl.appendChild(div);
    });
    // Scroll to bottom
    commentsListEl.scrollTop = commentsListEl.scrollHeight;
  });
};

window.closeSheet = () => {
  sheetEl.classList.remove('show');
  overlayEl.classList.remove('show');
  activePostId = null;
  if(commentsUnsubscribe) commentsUnsubscribe(); // Stop listening to save bandwidth
};

// Send Comment
document.getElementById('send-comment-btn').onclick = () => {
  const input = document.getElementById('comment-text');
  const text = input.value.trim();
  if(!text || !activePostId) return;

  push(ref(db, `comments/${activePostId}`), {
    uid, name: uname, avatar: uavatar, text, timestamp: serverTimestamp()
  });

  // Update comment count on post (Transaction)
  runTransaction(ref(db, `posts/${activePostId}/commentsCount`), (current) => {
    return (current || 0) + 1;
  });
  
  // Update UI count immediately
  const countEl = document.getElementById(`comment-count-${activePostId}`);
  if(countEl) countEl.innerText = parseInt(countEl.innerText) + 1;

  input.value = '';
};

// --- UTILS ---
function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.opacity = '1';
  t.style.bottom = '50px';
  setTimeout(() => {
    t.style.opacity = '0';
    t.style.bottom = '80px';
  }, 3000);
}

function timeAgo(ts) {
  if (!ts) return 'Just now';
  const seconds = Math.floor((Date.now() - ts) / 1000);
  if (seconds < 60) return 'Just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return minutes + 'm';
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return hours + 'h';
  return Math.floor(hours / 24) + 'd';
}

</script>
</body>
</html>
