<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Vynix Buddy – CAPS AI Tutor</title>

  <!-- PWA -->
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;Vynix Buddy&quot;,
    &quot;short_name&quot;:&quot;Vynix&quot;,
    &quot;description&quot;:&quot;Your CAPS AI Tutor for South African Education&quot;,
    &quot;start_url&quot;:&quot;/&quot;,
    &quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#ffffff&quot;,
    &quot;theme_color&quot;:&quot;#8b5cf6&quot;,
    &quot;orientation&quot;:&quot;portrait&quot;,
    &quot;scope&quot;:&quot;/&quot;,
    &quot;categories&quot;:[&quot;education&quot;,&quot;productivity&quot;],
    &quot;icons&quot;:[
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=192&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},
      {&quot;src&quot;:&quot;https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=512&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}
    ]
  }">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vynix Buddy">
  <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=Vynix&backgroundColor=8b5cf6&size=180">

  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    textarea,input,.content,.selectable{-webkit-user-select:text;user-select:text}
    body{
      font-family:'Inter',sans-serif;
      background:#faf8ff;
      color:#1f1f1f;
      margin:0;
      height:100dvh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    /* ---- TOKEN BAR ---- */
    .token-bar{
      position:fixed;top:0;left:0;right:0;
      background:linear-gradient(135deg,#8b5cf6,#ec4899);
      color:#fff;
      padding:0.75rem 1rem;
      padding-top:calc(0.75rem + env(safe-area-inset-top));
      font-size:0.95rem;
      text-align:center;
      z-index:50;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 4px 20px rgba(139,92,246,0.25);
    }
    #upgradePill{
      margin-left:12px;
      padding:6px 16px;
      background:#fff3;
      border:1px solid #fff4;
      border-radius:50px;
      font-weight:600;
      transition:all .2s;
    }
    #upgradePill:active{transform:scale(0.94)}
    /* ---- CHAT ---- */
    #chatPane{
      flex:1;
      overflow-y:auto;
      padding:1rem 1rem 160px;
      -webkit-overflow-scrolling:touch;
    }
    .message{
      margin:1.2rem 0;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      animation:fadeIn 0.4s ease-out forwards;
      width:100%;
    }
    .message.user{align-items:flex-end}
    .message .content{
      max-width:100%;
      width:auto;
      padding:14px 18px;
      border-radius:24px;
      line-height:1.55;
      font-size:1.02rem;
      word-wrap:break-word;
      box-shadow:0 3px 10px rgba(0,0,0,0.09);
    }
    .message.ai .content{
      background:linear-gradient(135deg,#f8f6ff 0%,#f0e8ff 100%);
      border:1px solid #e0d6ff;
      border-bottom-left-radius:6px;
      color:#312e69;
    }
    .message.user .content{
      background:#fff;
      border:1.8px solid #c4b5fd;
      border-bottom-right-radius:6px;
      color:#1f1f1f;
      font-weight:500;
    }
    .timestamp{
      font-size:0.75rem;
      color:#9ca3af;
      margin-top:4px;
      opacity:0.85;
    }
    .message.ai .timestamp{margin-left:18px}
    .message.user .timestamp{margin-right:18px;text-align:right}
    /* ---- AI ACTIONS ---- */
    .ai-actions{display:flex;gap:12px;padding:8px 18px 0 18px;justify-content:flex-start}
    .action-btn{
      width:40px;height:40px;background:#fff;border:none;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 16px rgba(0,0,0,0.14);
      transition:all .22s ease;cursor:pointer;
    }
    .action-btn:hover{transform:translateY(-4px) scale(1.1);box-shadow:0 10px 25px rgba(139,92,246,0.3)}
    /* ---- INPUT BAR ---- */
    .input-bar{
      position:fixed;bottom:0;left:0;right:0;
      padding:0.75rem;
      padding-bottom:calc(0.75rem + env(safe-area-inset-bottom));
      background:#fff;
      border-top:1px solid #e2e8f0;
      box-shadow:0 -6px 30px rgba(0,0,0,0.1);
      z-index:100;
      display:flex;justify-content:center;align-items:center;
    }
    .input-container{
      background:#f8fafc;border:2px solid #e2e8f0;border-radius:28px;
      padding:10px 16px;display:flex;align-items:center;gap:12px;
      transition:all .2s;width:100%;max-width:780px;box-sizing:border-box;
    }
    .input-container:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 4px rgba(139,92,246,0.18);background:#fff}
    #chatInput{flex:1;background:transparent;border:none;outline:none;font-size:1.05rem;resize:none;max-height:140px;line-height:1.5}
    .send-btn,.upload-btn{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .send-btn{background:#8b5cf6;color:#fff;box-shadow:0 4px 15px rgba(139,92,246,0.4)}
    .send-btn:disabled{background:#cbd5e1;cursor:not-allowed}
    .upload-btn{background:#e2e8f0}
    /* ---- BOTTOM SHEETS ---- */
    .bottom-sheet{
      position:fixed;bottom:-100%;left:0;right:0;
      background:#fff;border-radius:24px 24px 0 0;padding:1.5rem;
      box-shadow:0 -10px 40px rgba(0,0,0,0.25);
      transition:bottom .4s cubic-bezier(.32,.72,0,1);
      z-index:200;max-height:92dvh;overflow-y:auto;
    }
    .bottom-sheet.active{bottom:0}
    .sheet-handle{width:40px;height:5px;background:#ddd;border-radius:3px;margin:0 auto 1rem}
    /* ---- ANIMATIONS ---- */
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    /* ---- THINKING ---- */
    .thinking{display:flex;gap:9px;padding:16px 20px}
    .dot{width:11px;height:11px;background:#a78bfa;border-radius:50%;animation:pulse 1.5s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes pulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}
    /* ---- PLAN CARDS ---- */
    .plan-card{
      border:2px solid #e2e8f0;border-radius:20px;padding:24px;
      transition:all .25s ease;cursor:pointer;position:relative;
    }
    .plan-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.12)}
    .plan-card.selected{border-color:#8b5cf6;background:#f5f2ff}
    .plan-card .badge{
      position:absolute;top:16px;right:16px;background:#8b5cf6;color:#fff;
      font-size:0.75rem;padding:4px 10px;border-radius:9999px;font-weight:600;
    }
    /* ---- PAPERS SHEET STEPS ---- */
    .step-indicator{display:flex;justify-content:center;gap:12px;margin-bottom:1.5rem}
    .step-dot{width:10px;height:10px;border-radius:50%;background:#ddd}
    .step-dot.active{background:#8b5cf6}
  </style>
</head>
<body>
  <!-- TOKEN BAR -->
  <div class="token-bar">
    <div class="flex items-center gap-2">
      <span id="tokenCount">15,000</span> tokens left today
      <button id="upgradePill" class="ml-3 px-4 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold text-sm rounded-full border border-white/40 transition active:scale-95">Upgrade</button>
    </div>
  </div>

  <!-- CHAT -->
  <section id="chatPane">
    <div class="text-center mt-28 text-gray-600 px-4">
      <h1 class="text-4xl font-black mb-2 text-purple-600">Vynix Buddy</h1>
      <p class="text-lg">Your CAPS AI Tutor • Grades 1–12 • South Africa</p>
    </div>
  </section>

  <!-- INPUT BAR -->
  <div class="input-bar">
    <div class="input-container">
      <button class="upload-btn" id="uploadBtn" aria-label="Attach file"><i data-lucide="paperclip"></i></button>
      <input type="file" id="hiddenFile" accept="image/*,.pdf,.doc,.docx" hidden>
      <textarea id="chatInput" placeholder="Ask me anything..." rows="1" aria-label="Chat input"></textarea>
      <button id="sendBtn" class="send-btn" disabled aria-label="Send"><i data-lucide="send" class="text-white"></i></button>
    </div>
  </div>

  <!-- UPGRADE SHEET -->
  <div id="upgradeSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('upgradeSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>
    <div class="text-center px-4">
      <h2 class="text-3xl font-black text-gray-900 mb-2">Never Run Out of Help Again</h2>
      <p class="text-lg text-gray-600 mb-6">Upgrade to unlimited and study without limits</p>

      <!-- PLAN CARDS -->
      <div class="grid grid-cols-1 gap-4 mb-6">
        <!-- Student Plan -->
        <label class="plan-card block">
          <input type="radio" name="plan" value="student" class="absolute opacity-0" checked>
          <div class="badge">Popular</div>
          <div class="text-left">
            <div class="text-2xl font-extrabold">R29<span class="text-base font-medium text-gray-500">/mo</span></div>
            <div class="text-gray-700 font-semibold mt-1">Student Plan</div>
            <ul class="mt-3 space-y-1 text-sm text-gray-600">
              <li>✓ Unlimited messages</li>
              <li>✓ All subjects & grades</li>
              <li>✓ Practice papers</li>
              <li class="line-through text-gray-400">Voice listening</li>
              <li class="line-through text-gray-400">PDF downloads</li>
              <li class="line-through text-gray-400">Mark my work</li>
            </ul>
          </div>
        </label>

        <!-- Unlimited Plan -->
        <label class="plan-card block">
          <input type="radio" name="plan" value="unlimited" class="absolute opacity-0">
          <div class="badge bg-green-600">Best value</div>
          <div class="text-left">
            <div class="text-2xl font-extrabold">R79<span class="text-base font-medium text-gray-500">/mo</span></div>
            <div class="text-gray-700 font-semibold mt-1">Unlimited Plan</div>
            <ul class="mt-3 space-y-1 text-sm text-gray-600">
              <li>✓ Everything in Student</li>
              <li>✓ Premium ElevenLabs voice</li>
              <li>✓ Download answers as PDF</li>
              <li>✓ Mark my work (AI marking)</li>
              <li>✓ Faster responses</li>
              <li>✓ Support SA education (5 % donated)</li>
            </ul>
          </div>
        </label>
      </div>

      <button id="proceedPaymentBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-xl py-4 rounded-2xl shadow-2xl hover:scale-105 active:scale-95">Proceed to Payment</button>
      <p class="text-xs text-gray-500 mt-3">Secure payments by Yoco • Cancel anytime</p>
    </div>
  </div>

  <!-- PAST PAPERS SHEET -->
  <div id="papersSheet" class="bottom-sheet">
    <div class="sheet-handle"></div>
    <button onclick="document.getElementById('papersSheet').classList.remove('active')" class="absolute top-4 right-4 text-2xl text-gray-400">×</button>

    <!-- Step 1: Subject & Grade -->
    <div id="papersStep1" class="px-2">
      <h3 class="text-xl font-bold mb-4">Generate CAPS Practice Paper</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Subject</label>
          <select id="subjectSelect" class="w-full border rounded-lg p-2 bg-white">
            <option value="Mathematics">Mathematics</option>
            <option value="Physical Sciences">Physical Sciences</option>
            <option value="Life Sciences">Life Sciences</option>
            <option value="Accounting">Accounting</option>
            <option value="Business Studies">Business Studies</option>
            <option value="Geography">Geography</option>
            <option value="History">History</option>
            <option value="English HL">English HL</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Grade</label>
          <select id="gradeSelect" class="w-full border rounded-lg p-2 bg-white">
            <option value="8">Grade 8</option><option value="9">Grade 9</option>
            <option value="10">Grade 10</option><option value="11">Grade 11</option>
            <option value="12">Grade 12</option>
          </select>
        </div>
        <button id="nextToTopicBtn" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">Next</button>
      </div>
    </div>

    <!-- Step 2: Topic & Difficulty -->
    <div id="papersStep2" class="px-2 hidden">
      <div class="step-indicator">
        <div class="step-dot"></div><div class="step-dot active"></div>
      </div>
      <h3 class="text-xl font-bold mb-4">Topic & Difficulty</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Topic (e.g., Calculus, Chemical Equilibrium)</label>
          <input type="text" id="topicInput" class="w-full border rounded-lg p-2" placeholder="Enter specific topic">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Difficulty</label>
          <select id="difficultySelect" class="w-full border rounded-lg p-2 bg-white">
            <option value="standard">Standard CAPS</option>
            <option value="challenging">Challenging (Paper-2 style)</option>
            <option value="exam">Exam-level tough</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button id="backToSubjectBtn" class="flex-1 border border-gray-300 text-gray-700 font-semibold py-3 rounded-xl hover:bg-gray-50 transition">Back</button>
          <button id="generatePaperBtn" class="flex-1 bg-purple-600 text-white font-semibold py-3 rounded-xl hover:bg-purple-700 transition">Generate Paper</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ALERT -->
  <div id="customAlert" role="alert" class="fixed top-6 left-1/2 -translate-x-1/2 translate-y-[-120%] bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-full font-bold shadow-xl transition-transform duration-300 z-50"></div>

  <!-- FIREBASE + APP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getRemoteConfig, fetchAndActivate, getString, getBoolean } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-remote-config.js";
    lucide.createIcons();
    const { jsPDF } = window.jspdf;

    const app = initializeApp({
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    });
    const auth = getAuth(app);
    const db = getDatabase(app);

    let userProfile = null;
    let xaiKey = null;
    let elevenlabsKey = null;
    let yocoPublicKey = null;
    let yocoEnabled = false;
    let history = [];
    let currentImage = null;
    let dailyTokens = 15000;
    let isPremium = false;
    let userPlan = 'free'; // 'free' | 'student' | 'unlimited'

    const els = {
      chatPane: document.getElementById('chatPane'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      hiddenFile: document.getElementById('hiddenFile'),
      tokenCount: document.getElementById('tokenCount'),
      upgradeSheet: document.getElementById('upgradeSheet'),
      upgradePill: document.getElementById('upgradePill'),
      papersSheet: document.getElementById('papersSheet'),
      papersStep1: document.getElementById('papersStep1'),
      papersStep2: document.getElementById('papersStep2'),
      subjectSelect: document.getElementById('subjectSelect'),
      gradeSelect: document.getElementById('gradeSelect'),
      topicInput: document.getElementById('topicInput'),
      difficultySelect: document.getElementById('difficultySelect'),
      nextToTopicBtn: document.getElementById('nextToTopicBtn'),
      backToSubjectBtn: document.getElementById('backToSubjectBtn'),
      generatePaperBtn: document.getElementById('generatePaperBtn'),
      proceedPaymentBtn: document.getElementById('proceedPaymentBtn')
    };

    function customAlert(msg, duration = 2500) {
      const box = document.getElementById('customAlert');
      box.textContent = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), duration);
    }
    function formatTime() { return new Date().toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' }); }
    function estimateTokens(t) { return Math.ceil((t?.length || 0) / 4) + 150; }

    async function deductTokens(amount) {
      if (isPremium) return true;
      if (dailyTokens < amount) { els.upgradeSheet.classList.add('active'); return false; }
      dailyTokens -= amount;
      els.tokenCount.textContent = dailyTokens.toLocaleString();
      await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: Date.now() });
      return true;
    }

    async function loadTokens() {
      try {
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const userData = userSnap.val();
        if (userData?.premium) {
          isPremium = true; dailyTokens = 999999; userPlan = userData.plan || 'unlimited';
          document.querySelector('.token-bar').innerHTML = `<div class="flex items-center justify-center gap-3"><span>Unlimited access • ${userPlan === 'student' ? 'Student' : 'Premium'}</span></div>`;
          els.tokenCount.textContent = 'Unlimited'; return;
        }
        const snap = await get(child(ref(db), `users/${auth.currentUser.uid}/tokens`));
        const data = snap.val(); const now = Date.now(); const oneDay = 24 * 60 * 60 * 1000;
        if (!data || (now - (data.lastReset || 0) > oneDay)) {
          dailyTokens = 15000; await set(ref(db, `users/${auth.currentUser.uid}/tokens`), { daily: dailyTokens, lastReset: now });
        } else dailyTokens = data.daily || 15000;
        els.tokenCount.textContent = dailyTokens.toLocaleString();
      } catch { dailyTokens = 15000; els.tokenCount.textContent = dailyTokens.toLocaleString(); }
    }

    async function loadYocoScript() {
      if (window.YocoSDK) return Promise.resolve();
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }

    async function startYocoPayment(plan) {
      await loadYocoScript();
      const yoco = new window.YocoSDK({ publicKey: yocoPublicKey });
      const amount = plan === 'student' ? 2900 : 7900;
      const result = await yoco.showPopup({
        amountInCents: amount,
        currency: 'ZAR',
        name: `Vynix Buddy ${plan === 'student' ? 'Student' : 'Unlimited'}`,
        description: `R${amount / 100}/month – AI tutoring`,
        metadata: { userId: auth.currentUser.uid, plan },
        callbackUrl: location.href
      });
      if (result?.paymentResult?.status === 'successful') {
        await update(ref(db, `users/${auth.currentUser.uid}`), { premium: true, plan, premiumSince: new Date().toISOString() });
        isPremium = true; userPlan = plan; await loadTokens(); els.upgradeSheet.classList.remove('active');
        customAlert("Payment successful! You're now on " + (plan === 'student' ? 'Student' : 'Unlimited') + " plan!");
      }
    }

    els.proceedPaymentBtn.onclick = () => {
      const plan = document.querySelector('input[name="plan"]:checked').value;
      yocoEnabled ? startYocoPayment(plan) : customAlert("Payments coming soon!");
    };
    els.upgradePill.onclick = () => els.upgradeSheet.classList.add('active');
    els.upgradeSheet.addEventListener('click', (e) => {
      if (e.target === els.upgradeSheet) els.upgradeSheet.classList.remove('active');
    });

    /* ---- PAST PAPERS FLOW ---- */
    els.nextToTopicBtn.onclick = () => {
      els.papersStep1.classList.add('hidden');
      els.papersStep2.classList.remove('hidden');
    };
    els.backToSubjectBtn.onclick = () => {
      els.papersStep2.classList.add('hidden');
      els.papersStep1.classList.remove('hidden');
    };
    els.generatePaperBtn.onclick = async () => {
      const subject = els.subjectSelect.value;
      const grade = els.gradeSelect.value;
      const topic = els.topicInput.value.trim();
      const difficulty = els.difficultySelect.value;
      if (!topic) { customAlert("Please enter a topic"); return; }
      els.papersSheet.classList.remove('active');
      const examText = await generateExamPaper(subject, grade, topic, difficulty);
      if (!examText) { customAlert("Failed to generate paper. Check internet/tokens."); return; }
      downloadPaperAsPDF(examText, subject, grade, topic);
    };

    function showPastPapersSheet() {
      els.papersSheet.classList.add('active');
      els.papersStep1.classList.remove('hidden');
      els.papersStep2.classList.add('hidden');
    }

    async function generateExamPaper(subject, grade, topic, difficulty) {
      const marks = 50;
      const prompt = `Generate a CAPS ${subject} Grade ${grade} exam paper on "${topic}" (${difficulty} difficulty).
Requirements:
- 5 questions, total ${marks} marks (10 each)
- Clear sub-parts (a), (b), (c) where relevant
- Proper maths notation, diagrams if needed
- Detailed memorandum with full solutions
- Separate question paper and memo with "---MEMO---"
- Format clearly with spacing between questions`;
      addThinking();
      const cost = 2500;
      if (!(await deductTokens(cost))) { removeThinking(); return null; }
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: "grok-4-1-fast-non-reasoning", messages: [{ role: "user", content: prompt }], max_tokens: 8000, temperature: 0.7 })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || null;
      } catch (e) {
        console.error(e);
        return null;
      } finally {
        removeThinking();
      }
    }

    function downloadPaperAsPDF(examText, subject, grade, topic) {
      const [qp, memo] = examText.split("---MEMO---");
      const doc = new jsPDF();
      doc.setFontSize(22); doc.setTextColor(139, 92, 246); doc.text("VYNIX BUDDY", 105, 30, { align: "center" });
      doc.setFontSize(18); doc.text("CAPS PRACTICE PAPER", 105, 45, { align: "center" });
      doc.setFontSize(14); doc.text(`${subject} - Grade ${grade}`, 105, 60, { align: "center" });
      doc.text(`Topic: ${topic}`, 105, 75, { align: "center" });
      doc.setFontSize(12); doc.text(`Generated on ${new Date().toLocaleDateString('en-ZA')}`, 105, 90, { align: "center" });

      doc.addPage(); doc.setFontSize(16); doc.text("QUESTION PAPER", 105, 20, { align: "center" });
      doc.setFontSize(12); doc.text(`Subject: ${subject} | Grade: ${grade} | Topic: ${topic}`, 15, 35);
      doc.text(`Time: 1 hour | Marks: 50`, 15, 45);
      doc.text("Instructions: Answer all questions. Show all working.", 15, 55);

      let yPos = 70;
      const questions = (qp || examText).split(/QUESTION \d+:/gi).filter(q => q.trim());
      questions.slice(0, 5).forEach((q, i) => {
        if (yPos > 240) { doc.addPage(); yPos = 20; }
        doc.setFontSize(12); doc.setFont(undefined, "bold");
        doc.text(`Question ${i + 1} (10 marks)`, 15, yPos);
        doc.setFont(undefined, "normal"); yPos += 8;
        const lines = doc.splitTextToSize(q.trim().replace(/\*\*/g, ''), 170);
        lines.forEach(line => { if (yPos > 270) { doc.addPage(); yPos = 20; } doc.text(line, 20, yPos); yPos += 6; });
        yPos += 8;
      });

      doc.addPage(); doc.setFontSize(16); doc.text("MEMORANDUM", 105, 20, { align: "center" });
      doc.setFontSize(12);
      const memoLines = doc.splitTextToSize((memo || "No memorandum generated.").replace(/\*\*/g, ''), 180);
      let memoY = 35;
      memoLines.forEach(line => { if (memoY > 270) { doc.addPage(); memoY = 20; } doc.text(line, 15, memoY); memoY += 6; });

      doc.save(`CAPS_${subject.replace(/\s/g, "_")}_Grade${grade}_${topic.replace(/\s/g, "_")}.pdf`);
      customAlert("Practice paper downloaded!");
    }

    /* ---- CHAT HELPERS ---- */
    function addThinking() {
      const d = document.createElement('div');
      d.id = 'thinking'; d.className = 'message ai';
      d.innerHTML = `<div class="content"><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
      els.chatPane.appendChild(d);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
    }
    function removeThinking() { document.getElementById('thinking')?.remove(); }

    function addMessage(content, sender, plainText = '') {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const isImage = content.includes('<img');
      const time = formatTime();

      if (sender === 'ai' && !isImage) {
        div.innerHTML = `
          <div class="content">${marked.parse(content)}</div>
          <div class="ai-actions">
            <button class="action-btn copy-btn" aria-label="Copy"><i data-lucide="copy"></i></button>
            ${userPlan === 'unlimited' ? `<button class="action-btn voice-btn" aria-label="Listen"><i data-lucide="volume-2"></i></button>` : ''}
            ${userPlan === 'unlimited' ? `<button class="action-btn pdf-btn" aria-label="Download PDF"><i data-lucide="download"></i></button>` : ''}
            <button class="action-btn papers-btn" aria-label="Past Papers"><i data-lucide="file-text" class="text-purple-700"></i></button>
            ${userPlan === 'unlimited' ? `<button class="action-btn mark-btn" aria-label="Mark My Work"><i data-lucide="check-square" class="text-green-600"></i></button>` : ''}
          </div>
          <div class="timestamp">${time}</div>`;
      } else {
        const userText = isImage ? content : content.replace(/\n/g, '<br>');
        div.innerHTML = `<div class="content">${userText}</div><div class="timestamp">${time}</div>`;
      }

      els.chatPane.appendChild(div);
      els.chatPane.scrollTop = els.chatPane.scrollHeight;
      lucide.createIcons();

      if (sender === 'ai' && !isImage) {
        div.querySelector('.copy-btn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(plainText || content);
          const i = div.querySelector('.copy-btn i');
          i.setAttribute('data-lucide', 'check'); lucide.createIcons();
          setTimeout(() => { i.setAttribute('data-lucide', 'copy'); lucide.createIcons(); }, 2000);
        });
        div.querySelector('.voice-btn')?.addEventListener('click', async () => {
          // ElevenLabs TTS – only for unlimited
          let text = (plainText || content || "").trim();
          if (!text) return;
          const btn = div.querySelector('.voice-btn');
          const icon = btn.querySelector('i');
          icon.setAttribute('data-lucide', 'loader-2');
          icon.classList.add('animate-spin');
          lucide.createIcons(); btn.disabled = true;
          try {
            const response = await fetch("https://api.elevenlabs.io/v1/text-to-speech/ErXwobaYiN019PkySvjV/stream", {
              method: "POST",
              headers: {
                "Accept": "audio/mpeg",
                "Content-Type": "application/json",
                "xi-api-key": elevenlabsKey
              },
              body: JSON.stringify({
                text: text.replace(/[#*`>~\[\]]/g, ''),
                model_id: "eleven_multilingual_v2",
                voice_settings: { stability: 0.65, similarity_boost: 0.85, style: 0.1, use_speaker_boost: true }
              })
            });
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.onended = () => { URL.revokeObjectURL(audioUrl); icon.setAttribute('data-lucide', 'volume-2'); icon.classList.remove('animate-spin'); lucide.createIcons(); btn.disabled = false; };
            await audio.play();
          } catch {
            customAlert("Voice not working right now");
            icon.setAttribute('data-lucide', 'volume-2'); icon.classList.remove('animate-spin'); lucide.createIcons(); btn.disabled = false;
          }
        });
        div.querySelector('.pdf-btn')?.addEventListener('click', () => {
          const doc = new jsPDF();
          doc.setFontSize(16); doc.text("Vynix Buddy Answer", 20, 20);
          doc.setFontSize(11); doc.text(doc.splitTextToSize((plainText || content).replace(/[#*`>]/g, ''), 170), 20, 35);
          doc.save(`Vynix_Answer_${new Date().toISOString().slice(0, 10)}.pdf`);
        });
        div.querySelector('.papers-btn')?.addEventListener('click', showPastPapersSheet);
        div.querySelector('.mark-btn')?.addEventListener('click', async () => {
          if (!currentImage) { customAlert("Upload your answer sheet first!"); return; }
          const subject = userProfile?.favoriteSubject || "Mathematics";
          const grade = userProfile?.grade || "12";
          const markingResult = await markStudentWork(currentImage, subject, grade, plainText);
          if (markingResult) addMessage(markingResult, 'ai', markingResult);
        });
      }
    }

    async function markStudentWork(studentImageUrl, subject, grade, questionContext) {
      const prompt = `You are a strict South African DBE examiner marking CAPS ${subject} Grade ${grade} work.
  STUDENT WORK: Analyze the handwritten answer in the attached image.
  QUESTION CONTEXT: ${questionContext}
  MARKING TASK:
  1. Mark the work according to SAGA guidelines
  2. Allocate marks out of 10 using official CAPS marking principles
  3. Place virtual ticks (√) where marks are earned
  4. Identify CAPS-specific errors SA learners commonly make
  5. Provide examiner-style comments with mark deductions
  OUTPUT FORMAT:
  MARKS: X/10
  EXAMINER COMMENTS:
  - √ [1 mark] Correct formula identified
  - ✗ [LOST] Did not convert to SI units (CAPS requirement)
  - √ [2 marks] Substitution correct
  - ✗ [LOST] Final answer not rounded to 2 decimal places
  FEEDBACK: [Specific advice for improvement]
  CAPS ALIGNMENT: [Reference to assessment standard]`;
      addThinking();
      const cost = 3000;
      if (!(await deductTokens(cost))) { removeThinking(); return null; }
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-2-vision-1212",
            messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: studentImageUrl } }] }],
            max_tokens: 4000,
            temperature: 0.3
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "Could not mark this paper.";
      } catch (e) {
        console.error("Vision marking failed:", e);
        return "Marking error. Please ensure image is clear and well-lit.";
      } finally {
        removeThinking();
      }
    }

    /* ---- INPUT HANDLING ---- */
    els.chatInput.addEventListener('input', () => {
      els.chatInput.style.height = 'auto';
      els.chatInput.style.height = els.chatInput.scrollHeight + 'px';
      els.sendBtn.disabled = !els.chatInput.value.trim() && !currentImage;
    });
    els.uploadBtn.onclick = () => els.hiddenFile.click();
    els.hiddenFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', 'banter_box');
      fd.append('resource_type', 'auto');
      try {
        customAlert("Uploading file...", 2000);
        const res = await fetch("https://api.cloudinary.com/v1_1/dqkujefxj/upload", { method: "POST", body: fd });
        const data = await res.json();
        if (data.secure_url) {
          currentImage = data.secure_url;
          els.sendBtn.disabled = false;
          customAlert("File uploaded successfully!");
        } else {
          customAlert("Upload failed. Please try again.");
          currentImage = null;
        }
      } catch (e) {
        console.error("Cloudinary upload error:", e);
        customAlert("Upload error. Check your connection.");
        currentImage = null;
      }
    };

    async function send() {
      let text = els.chatInput.value.trim();
      if (!text && !currentImage) return;
      const cost = currentImage ? 1500 : estimateTokens(text);
      if (!(await deductTokens(cost))) {
        addMessage("You've run out of tokens today! Upgrade to unlimited for just R29 or R79 per month.", 'ai');
        return;
      }
      if (currentImage) {
        addMessage(`<img src="${currentImage}" class="rounded-lg max-w-full" alt="User upload">`, 'user');
        history.push({ role: "user", content: `[Image: ${currentImage}]` });
        if (!text) text = "Explain what's in this image";
      } else {
        addMessage(text, 'user');
        history.push({ role: "user", content: text });
      }
      els.chatInput.value = '';
      currentImage = null;
      els.chatInput.style.height = 'auto';
      addThinking();
      const reply = await getReply(text);
      removeThinking();
      addMessage(reply, 'ai', reply);
      history.push({ role: "assistant", content: reply });
    }

    async function getReply(msg) {
      if (!xaiKey) return "Connecting to Grok...";
      const roleText = userProfile ? `${userProfile.role} (Grade ${userProfile.grade})` : "learner";
      const systemPrompt = `You are Vynix Buddy, a warm, expert CAPS tutor for South Africa. You are helping ${userProfile?.name || "a student"} who is a ${roleText}. Always use their name naturally. Be encouraging and explain step-by-step.`;
      try {
        const res = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${xaiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "grok-4-1-fast-non-reasoning",
            messages: [{ role: "system", content: systemPrompt }, ...history.slice(-15), { role: "user", content: msg }],
            temperature: 0.7
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "I'm thinking...";
      } catch (e) {
        console.error(e);
        return "No internet connection. Please check your network.";
      }
    }

    els.sendBtn.onclick = send;

    /* ---- AUTH ---- */
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }
      await init();
      await loadTokens();
      addMessage(`Welcome back, ${user.displayName || "learner"}! Ready for Grade ${userProfile?.grade || ""} today?`, 'ai');
    });

    async function init() {
      const rc = getRemoteConfig(app);
      rc.settings.minimumFetchIntervalMillis = 3600000;
      try {
        await fetchAndActivate(rc);
        xaiKey = getString(rc, 'xai_api_key')?.trim();
        elevenlabsKey = "sk_ad2f4d587897946bd44f877611980f4a601b46e5d8c1437a";
        yocoPublicKey = getString(rc, 'yoco_public_key')?.trim();
        yocoEnabled = getBoolean(rc, 'yoco_enabled');
      } catch (err) {
        console.error("Remote Config failed:", err);
      }
    }
  </script>
</body>
</html>
