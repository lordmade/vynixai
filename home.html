<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
      --status-bar: #D9D9D9;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--background);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 500;
      cursor: pointer;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-name {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
    }

    .action-btn svg {
      width: 24px;
      height: 24px;
    }

    .search-container {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      display: none;
    }

    .search-container.active {
      display: block;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      background: var(--chat-bg);
      color: var(--text-primary);
      outline: none;
    }

    .search-input:focus {
      border-color: var(--accent);
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .chat-item, .user-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chat-item:hover, .user-item:hover {
      background: var(--chat-bg);
    }

    .chat-avatar, .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 500;
      margin-right: 0.75rem;
      text-decoration: none;
      color: #FFFFFF;
    }

    .chat-avatar img, .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-info, .user-info {
      flex: 1;
    }

    .chat-name, .user-name {
      font-size: 1rem;
      font-weight: 500;
      margin: 0 0 0.25rem;
    }

    .chat-preview, .user-status {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }

    .chat-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .unread-count {
      background: var(--accent);
      color: #FFFFFF;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      margin-top: 0.25rem;
    }

    .media-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 0.25rem;
      vertical-align: middle;
    }

    .image-icon {
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23667781" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>') no-repeat center;
      background-size: contain;
    }

    .video-icon {
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23667781" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>') no-repeat center;
      background-size: contain;
    }

    .add-btn {
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .add-btn:hover {
      background: #00976F;
    }

    .add-btn:disabled {
      background: var(--border);
      cursor: not-allowed;
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--background);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      max-height: 80vh;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .bottom-sheet.active {
      transform: translateY(0);
    }

    .bottom-sheet-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .bottom-sheet-title {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .bottom-sheet-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
    }

    .bottom-sheet-close svg {
      width: 24px;
      height: 24px;
    }

    .bottom-sheet-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .bottom-sheet-search {
      margin-bottom: 1rem;
    }

    .bottom-sheet-search input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      background: var(--chat-bg);
      color: var(--text-primary);
      outline: none;
    }

    .bottom-sheet-search input:focus {
      border-color: var(--accent);
    }

    .bottom-sheet-footer {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }

    .btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn:hover {
      background: #00976F;
    }

    .status-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000000;
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    .status-viewer.active {
      display: flex;
    }

    .status-header {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
    }

    .status-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 500;
    }

    .status-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .status-info {
      flex: 1;
      color: #FFFFFF;
    }

    .status-name {
      font-size: 1rem;
      font-weight: 500;
    }

    .status-time {
      font-size: 0.75rem;
      color: #D9D9D9;
    }

    .status-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: #FFFFFF;
    }

    .status-close svg {
      width: 24px;
      height: 24px;
    }

    .status-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .status-image, .status-video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .status-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.5);
      color: #FFFFFF;
      padding: 0.75rem;
      text-align: center;
      font-size: 0.875rem;
    }

    .status-progress {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--status-bar);
      display: flex;
      gap: 2px;
      padding: 0.5rem;
    }

    .progress-bar {
      flex: 1;
      height: 100%;
      background: #FFFFFF;
      transform: scaleX(0);
      transform-origin: left;
    }

    .progress-bar.active {
      animation: progress 5s linear forwards;
    }

    .status-tap-area {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
    }

    .status-tap-area.left {
      left: 0;
    }

    .status-tap-area.right {
      right: 0;
    }

    .fab {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: background 0.2s ease;
    }

    .fab:hover {
      background: #00976F;
    }

    .tabs {
      display: flex;
      border-top: 1px solid var(--border);
      background: var(--background);
    }

    .tab {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      position: relative;
    }

    .tab.active {
      color: var(--accent);
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .tab.active::after {
      transform: scaleX(1);
    }

    .tab-badge {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      background: var(--accent);
      color: #FFFFFF;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      display: none;
    }

    .tab-badge.active {
      display: inline-flex;
    }

    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .custom-alert.active {
      display: flex;
    }

    .alert-content {
      background: var(--background);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .alert-content p {
      margin: 0 0 1rem;
      font-size: 1rem;
    }

    .alert-content input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
    }

    .alert-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .alert-buttons button {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    #alert-confirm {
      background: var(--accent);
      color: #FFFFFF;
    }

    #alert-cancel {
      background: var(--border);
      color: var(--text-primary);
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .shimmer-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .shimmer-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--border);
      margin-right: 0.75rem;
    }

    .shimmer-text {
      flex: 1;
    }

    .shimmer-line {
      height: 10px;
      background: var(--border);
      margin: 0.25rem 0;
      border-radius: 4px;
    }

    .shimmer-line.long {
      width: 60%;
    }

    .shimmer-line.short {
      width: 40%;
    }

    .shimmer {
      background: linear-gradient(90deg, var(--border) 25%, #e8ecef 50%, var(--border) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    .menu {
      position: fixed;
      top: 0;
      right: 0;
      background: var(--background);
      border-bottom-left-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
    }

    .menu.active {
      display: block;
    }

    .menu-item {
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-item:hover {
      background: var(--chat-bg);
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes progress {
      to { transform: scaleX(1); }
    }

    @media (max-width: 640px) {
      .header { padding: 0.75rem; }
      .user-avatar { width: 36px; height: 36px; font-size: 1rem; }
      .user-name { font-size: 1rem; }
      .search-container { padding: 0.5rem 0.75rem; }
      .chat-list { padding: 0.5rem 0; }
      .chat-item, .user-item { padding: 0.5rem; }
      .chat-avatar, .user-avatar { width: 40px; height: 40px; font-size: 1.25rem; }
      .chat-name, .user-name { font-size: 0.95rem; }
      .chat-preview, .user-status { font-size: 0.8rem; max-width: 150px; }
      .chat-time, .unread-count { font-size: 0.7rem; }
      .add-btn { padding: 0.5rem; font-size: 0.8rem; }
      .fab { width: 48px; height: 48px; font-size: 0.8rem; }
      .bottom-sheet-header { padding: 0.75rem; }
      .bottom-sheet-title { font-size: 1rem; }
      .bottom-sheet-content { padding: 0.75rem; }
      .bottom-sheet-search input { font-size: 0.9rem; }
      .btn { padding: 0.5rem; font-size: 0.95rem; }
      .status-header { padding: 0.75rem; }
      .status-avatar { width: 36px; height: 36px; font-size: 1rem; }
      .status-name { font-size: 0.95rem; }
      .status-time { font-size: 0.7rem; }
      .status-caption { font-size: 0.8rem; padding: 0.5rem; }
      .menu-item { font-size: 0.9rem; padding: 0.5rem 1rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="user-info">
      <a href="profile.html" class="user-avatar" id="user-avatar"><span id="user-initial">U</span></a>
      <span class="user-name" id="user-name">Loading...</span>
    </div>
    <div class="action-buttons">
      <button class="action-btn" id="search-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
      <button class="action-btn" id="menu-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle>
        </svg>
      </button>
    </div>
  </div>
  <div class="search-container" id="search-container">
    <input type="text" class="search-input" id="search-input" placeholder="Search..." />
  </div>
  <div class="chat-list" id="chat-list"></div>
  <div class="bottom-sheet" id="add-friend-sheet">
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-title">Add Friend</span>
      <button class="bottom-sheet-close" onclick="hideBottomSheet('add-friend-sheet')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="bottom-sheet-search">
        <input type="text" id="friend-search" placeholder="Search users..." />
      </div>
      <div id="user-list"></div>
    </div>
  </div>
  <div class="bottom-sheet" id="create-room-sheet">
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-title">Create Room</span>
      <button class="bottom-sheet-close" onclick="hideBottomSheet('create-room-sheet')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="input-group">
        <label for="room-name">Room Name</label>
        <input type="text" id="room-name" placeholder="Enter room name" />
      </div>
      <div class="input-group">
        <label for="room-type">Room Type</label>
        <select id="room-type">
          <option value="public">Public</option>
          <option value="private">Private</option>
        </select>
      </div>
      <div class="input-group" id="room-code-group" style="display: none;">
        <label for="room-code">Invite Code</label>
        <input type="text" id="room-code" placeholder="Enter invite code" />
      </div>
    </div>
    <div class="bottom-sheet-footer">
      <button class="btn" id="create-room-btn">Create Room</button>
    </div>
  </div>
  <div class="bottom-sheet" id="create-group-sheet">
    <div class="bottom-sheet-header">
      <span class="bottom-sheet-title">Create Group</span>
      <button class="bottom-sheet-close" onclick="hideBottomSheet('create-group-sheet')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="input-group">
        <label for="group-name">Group Name</label>
        <input type="text" id="group-name" placeholder="Enter group name" />
      </div>
      <div class="bottom-sheet-search">
        <input type="text" id="group-member-search" placeholder="Search friends..." />
      </div>
      <div id="group-member-list"></div>
    </div>
    <div class="bottom-sheet-footer">
      <button class="btn" id="create-group-btn">Create Group</button>
    </div>
  </div>
  <div class="status-viewer" id="status-viewer">
    <div class="status-header">
      <div class="status-avatar" id="status-avatar"><span id="status-initial">U</span></div>
      <div class="status-info">
        <div class="status-name" id="status-name">Loading...</div>
        <div class="status-time" id="status-time"></div>
      </div>
      <button class="status-close" id="status-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="status-progress" id="status-progress"></div>
    <div class="status-content">
      <img class="status-image" id="status-image" style="display: none;" />
      <video class="status-video" id="status-video" style="display: none;" autoplay muted></video>
      <div class="status-caption" id="status-caption" style="display: none;"></div>
      <div class="status-tap-area left" id="status-prev"></div>
      <div class="status-tap-area right" id="status-next"></div>
    </div>
  </div>
  <button class="fab" id="fab">Add</button>
  <div class="tabs">
    <div class="tab active" data-tab="chats">Chats<span id="chats-unread-count" class="tab-badge"></span></div>
    <div class="tab" data-tab="status">Status<span id="status-unread-count" class="tab-badge"></span></div>
    <div class="tab" data-tab="rooms">Rooms</div>
    <div class="tab" data-tab="groups">Groups</div>
  </div>
  <div class="menu" id="menu">
    <div class="menu-item" onclick="window.location.href='profile.html'">Profile</div>
    <div class="menu-item" onclick="window.location.href='settings.html'">Settings</div>
  </div>
  <div class="custom-alert" id="custom-alert">
    <div class="alert-content">
      <p id="alert-message"></p>
      <input id="alert-input" style="display: none;" />
      <div id="alert-buttons" class="alert-buttons">
        <button id="alert-confirm">OK</button>
        <button id="alert-cancel">Cancel</button>
      </div>
    </div>
  </div>
  <div class="spinner-overlay" id="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <input type="file" id="status-upload" accept="image/*,video/*" style="display: none;" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const userAvatar = document.getElementById('user-avatar');
    const userInitial = document.getElementById('user-initial');
    const userName = document.getElementById('user-name');
    const searchBtn = document.getElementById('search-btn');
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('search-input');
    const menuBtn = document.getElementById('menu-btn');
    const menu = document.getElementById('menu');
    const chatList = document.getElementById('chat-list');
    const addFriendSheet = document.getElementById('add-friend-sheet');
    const createRoomSheet = document.getElementById('create-room-sheet');
    const createGroupSheet = document.getElementById('create-group-sheet');
    const friendSearch = document.getElementById('friend-search');
    const userList = document.getElementById('user-list');
    const roomNameInput = document.getElementById('room-name');
    const roomTypeSelect = document.getElementById('room-type');
    const roomCodeGroup = document.getElementById('room-code-group');
    const roomCodeInput = document.getElementById('room-code');
    const createRoomBtn = document.getElementById('create-room-btn');
    const groupNameInput = document.getElementById('group-name');
    const groupMemberSearch = document.getElementById('group-member-search');
    const groupMemberList = document.getElementById('group-member-list');
    const createGroupBtn = document.getElementById('create-group-btn');
    const statusViewer = document.getElementById('status-viewer');
    const statusAvatar = document.getElementById('status-avatar');
    const statusInitial = document.getElementById('status-initial');
    const statusName = document.getElementById('status-name');
    const statusTime = document.getElementById('status-time');
    const statusImage = document.getElementById('status-image');
    const statusVideo = document.getElementById('status-video');
    const statusCaption = document.getElementById('status-caption');
    const statusProgress = document.getElementById('status-progress');
    const statusPrev = document.getElementById('status-prev');
    const statusNext = document.getElementById('status-next');
    const statusClose = document.getElementById('status-close');
    const fab = document.getElementById('fab');
    const statusUpload = document.getElementById('status-upload');
    const spinnerOverlay = document.getElementById('spinner-overlay');
    const customAlert = document.getElementById('custom-alert');
    const alertMessage = document.getElementById('alert-message');
    const alertInput = document.getElementById('alert-input');
    const alertConfirm = document.getElementById('alert-confirm');
    const alertCancel = document.getElementById('alert-cancel');
    const tabs = document.querySelectorAll('.tab');
    let currentTab = 'chats';
    let currentStatusIndex = 0;
    let statuses = [];
    let statusInterval;
    let selectedMembers = [];

    const CLOUDINARY_CLOUD_NAME = "dqkujefxj";
    const CLOUDINARY_UPLOAD_PRESET = "banter_box";
    const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
    const ENCRYPTION_KEY = "my-secret-key-123";
    const ROUTES = {
      SETTINGS: 'settings.html',
      PROFILE: 'profile.html',
      MESSAGES: 'messages.html',
      ROOM: 'room.html',
      GROUP: 'group.html'
    };
    const MESSAGES = {
      SIGN_IN_REQUIRED: 'Please sign in to continue.',
      ADD_FRIEND_SUCCESS: 'Added {name} as a friend!',
      ADD_FRIEND_FAIL: 'Failed to add friend.',
      STATUS_UPLOAD_SUCCESS: 'Status uploaded successfully!',
      STATUS_UPLOAD_FAIL: 'Failed to upload status.',
      ROOM_CREATE_SUCCESS: 'Room created successfully!',
      ROOM_CREATE_FAIL: 'Failed to create room.',
      GROUP_CREATE_SUCCESS: 'Group created successfully!',
      GROUP_CREATE_FAIL: 'Failed to create group.',
      FILE_SIZE_EXCEEDED: 'File size exceeds 10MB limit.',
      INVALID_FILE_TYPE: 'Please select an image or video file.',
      CHAT_FAIL: 'Failed to load chats.'
    };

    function applyTheme(theme) {
      if (theme === "dark") {
        document.documentElement.style.setProperty("--background", "#111B21");
        document.documentElement.style.setProperty("--chat-bg", "#202C33");
        document.documentElement.style.setProperty("--text-primary", "#E9ECEF");
        document.documentElement.style.setProperty("--text-secondary", "#8696A0");
        document.documentElement.style.setProperty("--border", "#2A3942");
        document.documentElement.style.setProperty("--accent", "#00A884");
        document.documentElement.style.setProperty("--status-bar", "#2A3942");
      } else {
        document.documentElement.style.setProperty("--background", "#FFFFFF");
        document.documentElement.style.setProperty("--chat-bg", "#F5F7FB");
        document.documentElement.style.setProperty("--text-primary", "#111B21");
        document.documentElement.style.setProperty("--text-secondary", "#667781");
        document.documentElement.style.setProperty("--border", "#E9ECEF");
        document.documentElement.style.setProperty("--accent", "#00A884");
        document.documentElement.style.setProperty("--status-bar", "#D9D9D9");
      }
    }

    window.showAlert = function(message, autoHide = true, showInput = false, confirmCallback = null, cancelCallback = null) {
      return new Promise(resolve => {
        alertMessage.textContent = message;
        alertInput.style.display = showInput ? 'block' : 'none';
        alertConfirm.style.display = confirmCallback ? 'block' : 'none';
        alertCancel.style.display = cancelCallback ? 'block' : 'none';
        customAlert.classList.add('active');
        if (showInput) alertInput.focus();
        if (autoHide && !confirmCallback && !cancelCallback) {
          setTimeout(() => window.hideAlert(), 5000);
        }
        alertConfirm.onclick = () => {
          if (confirmCallback) confirmCallback(alertInput.value);
          resolve(true);
          window.hideAlert();
        };
        alertCancel.onclick = () => {
          if (cancelCallback) cancelCallback();
          resolve(false);
          window.hideAlert();
        };
      });
    };

    window.hideAlert = function() {
      customAlert.classList.remove('active');
      alertInput.style.display = 'none';
      alertInput.value = '';
      alertConfirm.style.display = 'none';
      alertCancel.style.display = 'none';
    };

    window.showBottomSheet = function(id) {
      document.getElementById(id).classList.add('active');
    };

    window.hideBottomSheet = function(id) {
      document.getElementById(id).classList.remove('active');
      if (id === 'create-group-sheet') {
        selectedMembers = [];
        groupMemberList.innerHTML = '';
        groupNameInput.value = '';
      }
    };

    function showShimmer(count = 5, target = chatList) {
      target.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const shimmerItem = document.createElement('div');
        shimmerItem.className = 'shimmer-item shimmer';
        shimmerItem.innerHTML = `
          <div class="shimmer-avatar"></div>
          <div class="shimmer-text">
            <div class="shimmer-line long"></div>
            <div class="shimmer-line short"></div>
          </div>
        `;
        target.appendChild(shimmerItem);
      }
    }

    async function loadUserProfile(userId) {
      try {
        const userRef = ref(db, `users/${userId}`);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          const user = snapshot.val();
          userName.textContent = user.name || 'Unknown';
          userInitial.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
          if (user.avatar) {
            userAvatar.innerHTML = `<img src="${user.avatar}" alt="Avatar" onerror="this.parentElement.innerHTML='<span>${userInitial.textContent}</span>'" />`;
          } else {
            userAvatar.innerHTML = `<span>${userInitial.textContent}</span>`;
          }
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
      }
    }

    async function loadChats(userId) {
      showShimmer(5, chatList);
      try {
        const friendsRef = ref(db, `friends/${userId}`);
        const snapshot = await get(friendsRef, { onlyOnce: true });
        const friends = [];
        if (snapshot.exists()) {
          const friendIds = Object.keys(snapshot.val());
          for (const friendId of friendIds) {
            const friendRef = ref(db, `users/${friendId}`);
            const friendSnap = await get(friendRef);
            if (friendSnap.exists()) {
              const friend = friendSnap.val();
              const chatRef = ref(db, `chats/${userId}/${friendId}`);
              const chatSnap = await get(chatRef);
              let lastMessage = null;
              let messageType = null;
              let timestamp = null;
              let unreadCount = 0;
              if (chatSnap.exists()) {
                const messages = chatSnap.val();
                const messageIds = Object.keys(messages).sort((a, b) => messages[b].timestamp - messages[a].timestamp);
                if (messageIds.length > 0) {
                  const lastMessageId = messageIds[0];
                  lastMessage = messages[lastMessageId].content;
                  messageType = messages[lastMessageId].type;
                  timestamp = messages[lastMessageId].timestamp;
                  unreadCount = Object.values(messages).filter(msg => !msg.read && msg.sender !== userId).length;
                }
              }
              friends.push({
                uid: friendId,
                name: friend.name,
                avatar: friend.avatar,
                lastMessage,
                messageType,
                timestamp,
                unreadCount
              });
            }
          }
        }
        renderChats(friends);
      } catch (error) {
        console.error('Error loading chats:', error);
        window.showAlert(MESSAGES.CHAT_FAIL, false);
      }
    }

    function renderChats(friends) {
      chatList.innerHTML = '';
      if (friends.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No friends found.</p>';
        return;
      }
      friends.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      const totalUnread = friends.reduce((sum, friend) => sum + (friend.unreadCount || 0), 0);
      const chatsUnreadBadge = document.getElementById('chats-unread-count');
      if (chatsUnreadBadge) {
        chatsUnreadBadge.textContent = totalUnread;
        chatsUnreadBadge.style.display = totalUnread > 0 ? 'inline-flex' : 'none';
      }
      friends.forEach(({ uid, name, avatar, lastMessage, messageType, timestamp, unreadCount }) => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        const firstLetter = name ? name.charAt(0).toUpperCase() : 'U';
        const avatarContent = avatar ? `<img src="${avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
        let messagePreview = '';
        if (lastMessage) {
          if (messageType === 'image') {
            messagePreview = `<span class="media-icon image-icon"></span> Photo`;
          } else if (messageType === 'video') {
            messagePreview = `<span class="media-icon video-icon"></span> Video`;
          } else {
            messagePreview = decryptMessage(lastMessage);
          }
        } else {
          messagePreview = 'No messages yet';
        }
        const unreadBadge = unreadCount > 0 ? `<span class="unread-count">${unreadCount}</span>` : '';
        chatItem.innerHTML = `
          <a href="profile.html?userId=${uid}" class="chat-avatar">${avatarContent}</a>
          <div class="chat-info">
            <h3 class="chat-name">${name || 'Unknown'}</h3>
            <p class="chat-preview">${messagePreview}</p>
          </div>
          <div class="flex flex-col items-end">
            <span class="chat-time">${formatTimestamp(timestamp || Date.now())}</span>
            ${unreadBadge}
          </div>
        `;
        chatItem.querySelector('.chat-avatar').addEventListener('click', (e) => {
          e.stopPropagation();
        });
        chatItem.addEventListener('click', () => {
          window.location.href = `${ROUTES.MESSAGES}?friendId=${uid}`;
        });
        chatList.appendChild(chatItem);
      });
    }

    async function loadStatuses(userId) {
      showShimmer(5, chatList);
      try {
        const friendsRef = ref(db, `friends/${userId}`);
        const snapshot = await get(friendsRef, { onlyOnce: true });
        const friends = [];
        if (snapshot.exists()) {
          const friendIds = Object.keys(snapshot.val());
          for (const friendId of friendIds) {
            const statusRef = ref(db, `statuses/${friendId}`);
            const statusSnap = await get(statusRef);
            if (statusSnap.exists()) {
              const friendRef = ref(db, `users/${friendId}`);
              const friendSnap = await get(friendRef);
              if (friendSnap.exists()) {
                const friend = friendSnap.val();
                const statusIds = Object.keys(statusSnap.val()).sort((a, b) => statusSnap.val()[b].timestamp - statusSnap.val()[a].timestamp);
                const unseenStatuses = statusIds.filter(id => !statusSnap.val()[id].viewers || !statusSnap.val()[id].viewers[userId]);
                friends.push({
                  uid: friendId,
                  name: friend.name,
                  avatar: friend.avatar,
                  statuses: statusIds.map(id => ({
                    id,
                    ...statusSnap.val()[id]
                  })),
                  unseenCount: unseenStatuses.length
                });
              }
            }
          }
        }
        renderStatuses(friends);
      } catch (error) {
        console.error('Error loading statuses:', error);
      }
    }

    function renderStatuses(friends) {
      chatList.innerHTML = '';
      if (friends.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No statuses found.</p>';
        return;
      }
      friends.sort((a, b) => (b.statuses[0]?.timestamp || 0) - (a.statuses[0]?.timestamp || 0));
      const totalUnseen = friends.reduce((sum, friend) => sum + friend.unseenCount, 0);
      const statusUnreadBadge = document.getElementById('status-unread-count');
      if (statusUnreadBadge) {
        statusUnreadBadge.textContent = totalUnseen;
        statusUnreadBadge.style.display = totalUnseen > 0 ? 'inline-flex' : 'none';
      }
      const ownStatusItem = document.createElement('div');
      ownStatusItem.className = 'chat-item';
      ownStatusItem.innerHTML = `
        <div class="chat-avatar">${userAvatar.innerHTML}</div>
        <div class="chat-info">
          <h3 class="chat-name">My Status</h3>
          <p class="chat-preview">Tap to add status</p>
        </div>
      `;
      ownStatusItem.addEventListener('click', () => statusUpload.click());
      chatList.appendChild(ownStatusItem);
      friends.forEach(({ uid, name, avatar, statuses, unseenCount }) => {
        const statusItem = document.createElement('div');
        statusItem.className = 'chat-item';
        const firstLetter = name ? name.charAt(0).toUpperCase() : 'U';
        const avatarContent = avatar ? `<img src="${avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
        const unseenBadge = unseenCount > 0 ? `<span class="unread-count">${unseenCount}</span>` : '';
        statusItem.innerHTML = `
          <a href="profile.html?userId=${uid}" class="chat-avatar">${avatarContent}</a>
          <div class="chat-info">
            <h3 class="chat-name">${name || 'Unknown'}</h3>
            <p class="chat-preview">${formatTimestamp(statuses[0]?.timestamp || Date.now())}</p>
          </div>
          <div class="flex flex-col items-end">
            ${unseenBadge}
          </div>
        `;
        statusItem.querySelector('.chat-avatar').addEventListener('click', (e) => {
          e.stopPropagation();
        });
        statusItem.addEventListener('click', () => viewStatus(uid, statuses));
        chatList.appendChild(statusItem);
      });
    }

    async function viewStatus(userId, userStatuses) {
      statuses = userStatuses;
      currentStatusIndex = 0;
      statusViewer.classList.add('active');
      const userRef = ref(db, `users/${userId}`);
      const userSnap = await get(userRef);
      const user = userSnap.exists() ? userSnap.val() : { name: 'Unknown' };
      const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
      statusName.textContent = user.name || 'Unknown';
      statusInitial.textContent = firstLetter;
      if (user.avatar) {
        statusAvatar.innerHTML = `<img src="${user.avatar}" alt="Avatar" onerror="this.parentElement.innerHTML='<span>${firstLetter}</span>'" />`;
      } else {
        statusAvatar.innerHTML = `<span>${firstLetter}</span>`;
      }
      showStatus(userId);
    }

    function showStatus(userId) {
      if (currentStatusIndex < 0 || currentStatusIndex >= statuses.length) {
        statusViewer.classList.remove('active');
        clearInterval(statusInterval);
        return;
      }
      const status = statuses[currentStatusIndex];
      statusTime.textContent = formatTimestamp(status.timestamp);
      statusImage.style.display = status.type === 'image' ? 'block' : 'none';
      statusVideo.style.display = status.type === 'video' ? 'block' : 'none';
      statusCaption.style.display = status.caption ? 'block' : 'none';
      statusCaption.textContent = status.caption || '';
      if (status.type === 'image') {
        statusImage.src = status.url;
      } else {
        statusVideo.src = status.url;
      }
      statusProgress.innerHTML = statuses.map((_, i) => `<div class="progress-bar ${i === currentStatusIndex ? 'active' : ''}"></div>`).join('');
      clearInterval(statusInterval);
      const duration = status.type === 'image' ? 5000 : statusVideo.duration * 1000 || 5000;
      statusInterval = setInterval(() => {
        currentStatusIndex++;
        showStatus(userId);
      }, duration);
      if (!status.viewers || !status.viewers[auth.currentUser.uid]) {
        update(ref(db, `statuses/${userId}/${status.id}/viewers`), {
          [auth.currentUser.uid]: true
        });
      }
    }

    statusPrev.addEventListener('click', () => {
      clearInterval(statusInterval);
      currentStatusIndex--;
      showStatus(auth.currentUser.uid);
    });

    statusNext.addEventListener('click', () => {
      clearInterval(statusInterval);
      currentStatusIndex++;
      showStatus(auth.currentUser.uid);
    });

    statusClose.addEventListener('click', () => {
      statusViewer.classList.remove('active');
      clearInterval(statusInterval);
    });

    async function uploadToCloudinary(file) {
      if (file.size > 10 * 1024 * 1024) {
        throw new Error(MESSAGES.FILE_SIZE_EXCEEDED);
      }
      if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
        throw new Error(MESSAGES.INVALID_FILE_TYPE);
      }
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', CLOUDINARY_API_URL, true);
        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            console.log(`Upload progress: ${percent.toFixed(2)}%`);
          }
        };
        xhr.onload = () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.secure_url) {
              resolve(data.secure_url);
            } else {
              reject(new Error(data.error?.message || 'Upload failed'));
            }
          } else {
            reject(new Error(`Upload failed with status ${xhr.status}`));
          }
        };
        xhr.onerror = () => reject(new Error('Network error during upload'));
        xhr.send(formData);
      });
    }

    statusUpload.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        spinnerOverlay.classList.add('active');
        try {
          const url = await uploadToCloudinary(file);
          const statusRef = ref(db, `statuses/${auth.currentUser.uid}`);
          const newStatusRef = push(statusRef);
          await set(newStatusRef, {
            type: file.type.startsWith('image/') ? 'image' : 'video',
            url,
            timestamp: Date.now(),
            caption: '',
            viewers: {}
          });
          window.showAlert(MESSAGES.STATUS_UPLOAD_SUCCESS, true);
          loadStatuses(auth.currentUser.uid);
        } catch (error) {
          console.error('Error uploading status:', error);
          window.showAlert(error.message, false);
        } finally {
          spinnerOverlay.classList.remove('active');
          statusUpload.value = '';
        }
      }
    });

    async function loadSuggestedFriends(userId) {
      showShimmer(5, userList);
      try {
        const usersRef = ref(db, 'users');
        const usersSnap = await get(usersRef);
        const friendsRef = ref(db, `friends/${userId}`);
        const friendsSnap = await get(friendsRef);
        const friendIds = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];
        const users = [];
        if (usersSnap.exists()) {
          const allUsers = usersSnap.val();
          for (const uid in allUsers) {
            if (uid !== userId && !friendIds.includes(uid)) {
              users.push({ uid, ...allUsers[uid] });
            }
          }
        }
        renderSuggestedFriends(users);
      } catch (error) {
        console.error('Error loading suggested friends:', error);
      }
    }

    function renderSuggestedFriends(users) {
      userList.innerHTML = '';
      if (users.length === 0) {
        userList.innerHTML = '<p style="text-align: center; padding: 1rem;">No users found.</p>';
        return;
      }
      users.forEach(({ uid, name, avatar }) => {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        const firstLetter = name ? name.charAt(0).toUpperCase() : 'U';
        const avatarContent = avatar ? `<img src="${avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
        userItem.innerHTML = `
          <a href="profile.html?userId=${uid}" class="user-avatar">${avatarContent}</a>
          <div class="user-info">
            <h3 class="user-name">${name || 'Unknown'}</h3>
            <p class="user-status">Tap to add as friend</p>
          </div>
          <button class="add-btn" data-uid="${uid}">Add</button>
        `;
        userList.appendChild(userItem);
      });
      document.querySelectorAll('.add-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          e.stopPropagation();
          const friendUid = button.getAttribute('data-uid');
          const userId = auth.currentUser?.uid;
          if (!userId) {
            window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
            return;
          }
          try {
            await set(ref(db, `friends/${userId}/${friendUid}`), true);
            button.textContent = 'Added';
            button.disabled = true;
            window.showAlert(MESSAGES.ADD_FRIEND_SUCCESS.replace('{name}', users.find(f => f.uid === friendUid).name), true);
            loadChats(userId);
            loadSuggestedFriends(userId);
          } catch (error) {
            console.error('Error adding friend:', error);
            window.showAlert(MESSAGES.ADD_FRIEND_FAIL, false);
          }
        });
      });
    }

    async function loadRooms() {
      showShimmer(5, chatList);
      try {
        const roomsRef = ref(db, 'rooms');
        const snapshot = await get(roomsRef);
        const rooms = [];
        if (snapshot.exists()) {
          const allRooms = snapshot.val();
          for (const roomId in allRooms) {
            rooms.push({ id: roomId, ...allRooms[roomId] });
          }
        }
        renderRooms(rooms);
      } catch (error) {
        console.error('Error loading rooms:', error);
      }
    }

    function renderRooms(rooms) {
      chatList.innerHTML = '';
      if (rooms.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No rooms found.</p>';
        return;
      }
      rooms.forEach(({ id, name, type }) => {
        const roomItem = document.createElement('div');
        roomItem.className = 'chat-item';
        roomItem.innerHTML = `
          <div class="chat-avatar">${name ? name.charAt(0).toUpperCase() : 'R'}</div>
          <div class="chat-info">
            <h3 class="chat-name">${name || 'Unnamed Room'}</h3>
            <p class="chat-preview">${type === 'public' ? 'Public Room' : 'Private Room'}</p>
          </div>
        `;
        roomItem.addEventListener('click', () => {
          if (type === 'private') {
            window.showAlert('Enter invite code:', false, true, async (code) => {
              const roomRef = ref(db, `rooms/${id}`);
              const snapshot = await get(roomRef);
              if (snapshot.exists() && snapshot.val().inviteCode === code) {
                window.location.href = `${ROUTES.ROOM}?roomId=${id}`;
              } else {
                window.showAlert('Invalid invite code.', false);
              }
            });
          } else {
            window.location.href = `${ROUTES.ROOM}?roomId=${id}`;
          }
        });
        chatList.appendChild(roomItem);
      });
    }

    async function loadGroups(userId) {
      showShimmer(5, chatList);
      try {
        const groupsRef = ref(db, `groups`);
        const snapshot = await get(groupsRef);
        const groups = [];
        if (snapshot.exists()) {
          const allGroups = snapshot.val();
          for (const groupId in allGroups) {
            if (allGroups[groupId].members && allGroups[groupId].members[userId]) {
              groups.push({ id: groupId, ...allGroups[groupId] });
            }
          }
        }
        renderGroups(groups);
      } catch (error) {
        console.error('Error loading groups:', error);
      }
    }

    function renderGroups(groups) {
      chatList.innerHTML = '';
      if (groups.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No groups found.</p>';
        return;
      }
      groups.forEach(({ id, name }) => {
        const groupItem = document.createElement('div');
        groupItem.className = 'chat-item';
        groupItem.innerHTML = `
          <div class="chat-avatar">${name ? name.charAt(0).toUpperCase() : 'G'}</div>
          <div class="chat-info">
            <h3 class="chat-name">${name || 'Unnamed Group'}</h3>
            <p class="chat-preview">Group chat</p>
          </div>
        `;
        groupItem.addEventListener('click', () => {
          window.location.href = `${ROUTES.GROUP}?groupId=${id}`;
        });
        chatList.appendChild(groupItem);
      });
    }

    function switchTab(tab) {
      currentTab = tab;
      tabs.forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
      chatList.innerHTML = '';
      const userId = auth.currentUser?.uid;
      if (!userId) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      if (tab === 'chats') {
        fab.textContent = 'Chat';
        fab.onclick = () => window.showBottomSheet('add-friend-sheet');
        loadChats(userId);
      } else if (tab === 'status') {
        fab.textContent = 'Status';
        fab.onclick = () => statusUpload.click();
        loadStatuses(userId);
      } else if (tab === 'rooms') {
        fab.textContent = 'Room';
        fab.onclick = () => window.showBottomSheet('create-room-sheet');
        loadRooms();
      } else if (tab === 'groups') {
        fab.textContent = 'Group';
        fab.onclick = () => window.showBottomSheet('create-group-sheet');
        loadGroups(userId);
      }
    }

    function encryptMessage(message) {
      return CryptoJS.AES.encrypt(message, ENCRYPTION_KEY).toString();
    }

    function decryptMessage(ciphertext) {
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_KEY);
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (error) {
        return 'Decryption error';
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = (now - date) / 1000;
      if (diff < 60) return 'Just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
      return date.toLocaleDateString();
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    async function filterContent(query) {
      const userId = auth.currentUser?.uid;
      if (!userId) return;
      if (currentTab === 'chats') {
        const friendsRef = ref(db, `friends/${userId}`);
        const snapshot = await get(friendsRef);
        const friends = [];
        if (snapshot.exists()) {
          const friendIds = Object.keys(snapshot.val());
          for (const friendId of friendIds) {
            const friendRef = ref(db, `users/${friendId}`);
            const friendSnap = await get(friendRef);
            if (friendSnap.exists() && friendSnap.val().name.toLowerCase().includes(query.toLowerCase())) {
              const friend = friendSnap.val();
              const chatRef = ref(db, `chats/${userId}/${friendId}`);
              const chatSnap = await get(chatRef);
              let lastMessage = null;
              let messageType = null;
              let timestamp = null;
              let unreadCount = 0;
              if (chatSnap.exists()) {
                const messages = chatSnap.val();
                const messageIds = Object.keys(messages).sort((a, b) => messages[b].timestamp - messages[a].timestamp);
                if (messageIds.length > 0) {
                  const lastMessageId = messageIds[0];
                  lastMessage = messages[lastMessageId].content;
                  messageType = messages[lastMessageId].type;
                  timestamp = messages[lastMessageId].timestamp;
                  unreadCount = Object.values(messages).filter(msg => !msg.read && msg.sender !== userId).length;
                }
              }
              friends.push({
                uid: friendId,
                name: friend.name,
                avatar: friend.avatar,
                lastMessage,
                messageType,
                timestamp,
                unreadCount
              });
            }
          }
        }
        renderChats(friends);
      } else if (currentTab === 'status') {
        const friendsRef = ref(db, `friends/${userId}`);
        const snapshot = await get(friendsRef);
        const friends = [];
        if (snapshot.exists()) {
          const friendIds = Object.keys(snapshot.val());
          for (const friendId of friendIds) {
            const friendRef = ref(db, `users/${friendId}`);
            const friendSnap = await get(friendRef);
            if (friendSnap.exists() && friendSnap.val().name.toLowerCase().includes(query.toLowerCase())) {
              const statusRef = ref(db, `statuses/${friendId}`);
              const statusSnap = await get(statusRef);
              if (statusSnap.exists()) {
                const friend = friendSnap.val();
                const statusIds = Object.keys(statusSnap.val()).sort((a, b) => statusSnap.val()[b].timestamp - statusSnap.val()[a].timestamp);
                const unseenStatuses = statusIds.filter(id => !statusSnap.val()[id].viewers || !statusSnap.val()[id].viewers[userId]);
                friends.push({
                  uid: friendId,
                  name: friend.name,
                  avatar: friend.avatar,
                  statuses: statusIds.map(id => ({
                    id,
                    ...statusSnap.val()[id]
                  })),
                  unseenCount: unseenStatuses.length
                });
              }
            }
          }
        }
        renderStatuses(friends);
      } else if (currentTab === 'rooms') {
        const roomsRef = ref(db, 'rooms');
        const snapshot = await get(roomsRef);
        const rooms = [];
        if (snapshot.exists()) {
          const allRooms = snapshot.val();
          for (const roomId in allRooms) {
            if (allRooms[roomId].name.toLowerCase().includes(query.toLowerCase())) {
              rooms.push({ id: roomId, ...allRooms[roomId] });
            }
          }
        }
        renderRooms(rooms);
      } else if (currentTab === 'groups') {
        const groupsRef = ref(db, 'groups');
        const snapshot = await get(groupsRef);
        const groups = [];
        if (snapshot.exists()) {
          const allGroups = snapshot.val();
          for (const groupId in allGroups) {
            if (allGroups[groupId].members && allGroups[groupId].members[userId] && allGroups[groupId].name.toLowerCase().includes(query.toLowerCase())) {
              groups.push({ id: groupId, ...allGroups[groupId] });
            }
          }
        }
        renderGroups(groups);
      }
    }

    async function loadGroupMembers(userId) {
      showShimmer(5, groupMemberList);
      try {
        const friendsRef = ref(db, `friends/${userId}`);
        const snapshot = await get(friendsRef);
        const friends = [];
        if (snapshot.exists()) {
          const friendIds = Object.keys(snapshot.val());
          for (const friendId of friendIds) {
            const friendRef = ref(db, `users/${friendId}`);
            const friendSnap = await get(friendRef);
            if (friendSnap.exists()) {
              const friend = friendSnap.val();
              friends.push({ uid: friendId, name: friend.name, avatar: friend.avatar });
            }
          }
        }
        renderGroupMembers(friends);
      } catch (error) {
        console.error('Error loading group members:', error);
      }
    }

    function renderGroupMembers(friends) {
      groupMemberList.innerHTML = '';
      if (friends.length === 0) {
        groupMemberList.innerHTML = '<p style="text-align: center; padding: 1rem;">No friends found.</p>';
        return;
      }
      friends.forEach(({ uid, name, avatar }) => {
        const memberItem = document.createElement('div');
        memberItem.className = 'user-item';
        const firstLetter = name ? name.charAt(0).toUpperCase() : 'U';
        const avatarContent = avatar ? `<img src="${avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
        const isSelected = selectedMembers.includes(uid);
        memberItem.innerHTML = `
          <div class="user-avatar">${avatarContent}</div>
          <div class="user-info">
            <h3 class="user-name">${name || 'Unknown'}</h3>
          </div>
          <input type="checkbox" class="member-checkbox" data-uid="${uid}" ${isSelected ? 'checked' : ''} />
        `;
        groupMemberList.appendChild(memberItem);
      });
      document.querySelectorAll('.member-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const uid = e.target.getAttribute('data-uid');
          if (e.target.checked) {
            if (!selectedMembers.includes(uid)) selectedMembers.push(uid);
          } else {
            selectedMembers = selectedMembers.filter(id => id !== uid);
          }
        });
      });
    }

    searchBtn.addEventListener('click', () => {
      searchContainer.classList.toggle('active');
      if (searchContainer.classList.contains('active')) {
        searchInput.focus();
      } else {
        searchInput.value = '';
        filterContent('');
      }
    });

    menuBtn.addEventListener('click', () => {
      menu.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
        menu.classList.remove('active');
      }
      if (!addFriendSheet.contains(e.target) && !fab.contains(e.target) && !createRoomSheet.contains(e.target) && !createGroupSheet.contains(e.target)) {
        window.hideBottomSheet('add-friend-sheet');
        window.hideBottomSheet('create-room-sheet');
        window.hideBottomSheet('create-group-sheet');
      }
    });

    searchInput.addEventListener('input', debounce((e) => {
      filterContent(e.target.value);
    }, 300));

    friendSearch.addEventListener('input', debounce(async (e) => {
      const userId = auth.currentUser?.uid;
      if (!userId) return;
      const query = e.target.value;
      const usersRef = ref(db, 'users');
      const usersSnap = await get(usersRef);
      const friendsRef = ref(db, `friends/${userId}`);
      const friendsSnap = await get(friendsRef);
      const friendIds = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];
      const users = [];
      if (usersSnap.exists()) {
        const allUsers = usersSnap.val();
        for (const uid in allUsers) {
          if (uid !== userId && !friendIds.includes(uid) && allUsers[uid].name.toLowerCase().includes(query.toLowerCase())) {
            users.push({ uid, ...allUsers[uid] });
          }
        }
      }
      renderSuggestedFriends(users);
    }, 300));

    groupMemberSearch.addEventListener('input', debounce(async (e) => {
      const userId = auth.currentUser?.uid;
      if (!userId) return;
      const query = e.target.value;
      const friendsRef = ref(db, `friends/${userId}`);
      const snapshot = await get(friendsRef);
      const friends = [];
      if (snapshot.exists()) {
        const friendIds = Object.keys(snapshot.val());
        for (const friendId of friendIds) {
          const friendRef = ref(db, `users/${friendId}`);
          const friendSnap = await get(friendRef);
          if (friendSnap.exists() && friendSnap.val().name.toLowerCase().includes(query.toLowerCase())) {
            const friend = friendSnap.val();
            friends.push({ uid: friendId, name: friend.name, avatar: friend.avatar });
          }
        }
      }
      renderGroupMembers(friends);
    }, 300));

    roomTypeSelect.addEventListener('change', () => {
      roomCodeGroup.style.display = roomTypeSelect.value === 'private' ? 'block' : 'none';
    });

    createRoomBtn.addEventListener('click', async () => {
      const userId = auth.currentUser?.uid;
      if (!userId) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      const name = roomNameInput.value.trim();
      const type = roomTypeSelect.value;
      const inviteCode = type === 'private' ? roomCodeInput.value.trim() : null;
      if (!name) {
        window.showAlert('Room name is required.', false);
        return;
      }
      if (type === 'private' && !inviteCode) {
        window.showAlert('Invite code is required for private rooms.', false);
        return;
      }
      spinnerOverlay.classList.add('active');
      try {
        const roomsRef = ref(db, 'rooms');
        const newRoomRef = push(roomsRef);
        await set(newRoomRef, {
          name,
          type,
          inviteCode: type === 'private' ? inviteCode : null,
          creator: userId,
          createdAt: Date.now()
        });
        window.showAlert(MESSAGES.ROOM_CREATE_SUCCESS, true);
        window.hideBottomSheet('create-room-sheet');
        loadRooms();
      } catch (error) {
        console.error('Error creating room:', error);
        window.showAlert(MESSAGES.ROOM_CREATE_FAIL, false);
      } finally {
        spinnerOverlay.classList.remove('active');
      }
    });

    createGroupBtn.addEventListener('click', async () => {
      const userId = auth.currentUser?.uid;
      if (!userId) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      const name = groupNameInput.value.trim();
      if (!name) {
        window.showAlert('Group name is required.', false);
        return;
      }
      if (selectedMembers.length === 0) {
        window.showAlert('Select at least one member.', false);
        return;
      }
      spinnerOverlay.classList.add('active');
      try {
        const groupsRef = ref(db, 'groups');
        const newGroupRef = push(groupsRef);
        const members = { [userId]: true };
        selectedMembers.forEach(uid => {
          members[uid] = true;
        });
        await set(newGroupRef, {
          name,
          members,
          creator: userId,
          createdAt: Date.now()
        });
        window.showAlert(MESSAGES.GROUP_CREATE_SUCCESS, true);
        window.hideBottomSheet('create-group-sheet');
        loadGroups(userId);
      } catch (error) {
        console.error('Error creating group:', error);
        window.showAlert(MESSAGES.GROUP_CREATE_FAIL, false);
      } finally {
        spinnerOverlay.classList.remove('active');
      }
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        searchContainer.classList.remove('active');
        searchInput.value = '';
        switchTab(tab.getAttribute('data-tab'));
      });
    });

    onAuthStateChanged(auth, async (user) => {
  if (user) {
    const settingsRef = ref(db, `users/${user.uid}/settings`);
    const snapshot = await get(settingsRef);
    if (snapshot.exists()) {
      const settings = snapshot.val();
      applyTheme(settings.theme || 'light');
    } else {
      applyTheme('light'); // Default to light theme if no settings found
    }
    await loadUserProfile(user.uid);
    switchTab(currentTab); // Load content for the current tab
    loadSuggestedFriends(user.uid); // Populate add friend sheet
    loadGroupMembers(user.uid); // Populate group creation sheet
  } else {
    window.location.href = 'login.html'; // Redirect to login if unauthenticated
  }
});

// Initialize default tab
switchTab('chats');
  </script>
</body>
</html>
