<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix - AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #3B82F6;
      --secondary: #FFFFFF;
      --text-dark: #111827;
      --text-light: #6B7280;
      --border: rgba(255, 255, 255, 0.3);
      --background: rgba(255, 255, 255, 0.1);
      --background-fallback: #F3F4F6;
      --background-dark: rgba(0, 0, 0, 0.2);
      --background-dark-fallback: #111827;
      --text-dark-dark: #F9FAFB;
      --text-light-dark: #9CA3AF;
      --border-dark: rgba(255, 255, 255, 0.2);
      --white-dark: rgba(31, 41, 55, 0.3);
      --user-bubble: rgba(59, 130, 246, 0.2);
      --ai-bubble: rgba(255, 255, 255, 0.2);
      --avatar-bg: #3B82F6;
    }

    [data-theme="dark"] {
      --background: var(--background-dark);
      --background-fallback: var(--background-dark-fallback);
      --text-dark: var(--text-dark-dark);
      --text-light: var(--text-light-dark);
      --border: var(--border-dark);
      --white: var(--white-dark);
      --user-bubble: rgba(59, 130, 246, 0.3);
      --ai-bubble: rgba(55, 65, 81, 0.3);
      --avatar-bg: #1E3A8A;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: url('https://source.unsplash.com/random/1920x1080?abstract') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: background 0.3s ease;
    }

    .main-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: var(--background);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-right: 1px solid var(--border);
      padding: 1.5rem;
      display: none;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .sidebar.active {
      display: flex;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      background: var(--avatar-bg);
      color: var(--secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 600;
      text-transform: uppercase;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .username {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .sidebar h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 1rem;
    }

    .new-chat-btn {
      background: var(--primary);
      color: var(--secondary);
      padding: 0.5rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .new-chat-btn:hover {
      background: #1E3A8A;
      transform: scale(1.05);
    }

    .sidebar .chat-history {
      flex-grow: 1;
      overflow-y: auto;
    }

    .sidebar .chat-history p {
      padding: 0.5rem;
      color: var(--text-light);
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--background);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      margin: 0.5rem 0;
    }

    .sidebar .chat-history p:hover {
      background: rgba(59, 130, 246, 0.2);
      color: var(--text-dark);
    }

    .chat-history .timestamp {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .chat-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--background);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .chat-header h1 {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-dark);
    }

    .chat-header button {
      background: none;
      border: none;
      cursor: pointer;
      display: none;
    }

    .chat-output {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      background: transparent;
    }

    .chat-output .message {
      margin: 0.5rem 0;
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      line-height: 1.4;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
    }

    .chat-output .user-message {
      background: var(--user-bubble);
      color: var(--text-dark);
      margin-left: auto;
      border-bottom-right-radius: 2px;
    }

    .chat-output .ai-message {
      background: var(--ai-bubble);
      color: var(--text-dark);
      margin-right: auto;
      border-bottom-left-radius: 2px;
    }

    .chat-output .timestamp {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.25rem;
      align-self: flex-end;
    }

    .chat-output .thinking-dots {
      margin: 0.5rem 0;
      max-width: 70%;
      padding: 0.75rem 1rem;
      color: var(--text-dark);
      margin-right: auto;
      font-size: 1rem;
      background: var(--ai-bubble);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
    }

    .thinking-dots::after {
      content: '...';
      display: inline-block;
      animation: pulse 1.5s infinite;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--background);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
    }

    .input-group input {
      flex-grow: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: 0.95rem;
      background: var(--background);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      color: var(--text-dark);
    }

    .input-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .input-group button {
      padding: 0.75rem;
      background: var(--primary);
      color: var(--secondary);
      border: none;
      border-radius: 9999px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .input-group button:hover {
      background: #1E3A8A;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .input-group button svg {
      width: 24px;
      height: 24px;
      fill: var(--secondary);
    }

    .signout-btn {
      background: var(--background);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text-dark);
      padding: 0.75rem;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      border: 1px solid var(--border);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .signout-btn:hover {
      background: rgba(75, 85, 99, 0.3);
      transform: scale(1.05);
    }

    .spinner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--primary);
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .toast {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--background);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text-dark);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      font-weight: 500;
      animation: slideIn 0.3s ease-out forwards;
      border: 1px solid var(--border);
    }

    .toast.active {
      display: block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    @media (min-width: 768px) {
      .sidebar {
        display: flex;
      }

      .chat-container {
        padding: 2rem;
      }

      .chat-header button {
        display: none;
      }
    }

    @media (max-width: 767px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: -250px;
        width: 250px;
        height: 100%;
        z-index: 1000;
        transition: left 0.3s ease;
      }

      .sidebar.active {
        left: 0;
      }

      .chat-header button {
        display: block;
        font-size: 1.5rem;
        color: var(--text-dark);
      }

      .chat-container {
        padding: 1rem;
      }

      .input-group {
        padding: 0.5rem;
      }

      .input-group input {
        padding: 0.5rem 1rem;
      }

      .input-group button {
        padding: 0.5rem;
        width: 40px;
        height: 40px;
      }

      .chat-output .message {
        max-width: 85%;
      }
    }

    @supports not (backdrop-filter: blur(10px)) {
      .sidebar, .chat-header, .input-group, .chat-output .message, .chat-output .thinking-dots, .toast, .signout-btn {
        background: var(--background-fallback);
      }
      [data-theme="dark"] .sidebar, [data-theme="dark"] .chat-header, [data-theme="dark"] .input-group, [data-theme="dark"] .chat-output .message, [data-theme="dark"] .chat-output .thinking-dots, [data-theme="dark"] .toast, [data-theme="dark"] .signout-btn {
        background: var(--background-dark-fallback);
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar" id="sidebar">
      <div>
        <div class="user-profile">
          <div class="avatar" id="user-avatar"></div>
          <span class="username" id="username"></span>
        </div>
        <div class="new-chat-btn" id="new-chat-btn">New Conversation</div>
        <h2>Chat History</h2>
        <div class="chat-history" id="chat-history">
          <!-- Chat history will be populated here -->
        </div>
      </div>
      <div class="signout-btn" id="signout-btn">Sign Out</div>
    </div>
    <div class="chat-container">
      <div class="chat-header">
        <h1>Vynix AI</h1>
        <button id="toggle-sidebar">â˜°</button>
      </div>
      <div class="chat-output" id="chat-output"></div>
      <div class="input-group">
        <input type="text" id="user-input" placeholder="Ask Vynix anything..." aria-label="Chat input" />
        <button onclick="sendMessage()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="spinner-overlay" id="spinner">
    <div class="spinner"></div>
  </div>

  <div class="toast" id="toast">
    <p id="toast-message"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/brain.js@2.0.0-beta.2/dist/brain-browser.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, addDoc, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const net = new brain.NeuralNetwork({ hiddenLayers: [10], activation: 'sigmoid' });
    let trainingData = [];
    let currentConversationId = null;
    let conversations = [];

    const spinner = document.getElementById("spinner");
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toast-message");
    const signoutBtn = document.getElementById("signout-btn");
    const toggleSidebar = document.getElementById("toggle-sidebar");
    const sidebar = document.getElementById("sidebar");
    const chatHistory = document.getElementById("chat-history");
    const userAvatar = document.getElementById("user-avatar");
    const usernameElement = document.getElementById("username");
    const newChatBtn = document.getElementById("new-chat-btn");
    const chatOutput = document.getElementById("chat-output");

    function showSpinner() {
      spinner.classList.add("active");
    }

    function hideSpinner() {
      spinner.classList.remove("active");
    }

    function showToast(message) {
      toastMessage.textContent = message;
      toast.classList.add("active");
      setTimeout(() => toast.classList.remove("active"), 3000);
    }

    function formatTimestamp(timestamp) {
      if (timestamp instanceof Timestamp) {
        const date = timestamp.toDate();
        return date.toLocaleString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit', 
          hour12: true 
        });
      }
      return new Date().toLocaleString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit', 
        hour12: true 
      });
    }

    function setUserProfile(user) {
      if (user) {
        const displayName = user.displayName || "User";
        usernameElement.textContent = displayName;
        if (user.photoURL) {
          userAvatar.style.background = "none";
          userAvatar.innerHTML = `<img src="${user.photoURL}" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%;" />`;
        } else {
          userAvatar.textContent = displayName.charAt(0);
        }
      }
    }

    async function checkFirstInteraction(user) {
      if (!user) return false;
      const userDocRef = doc(db, `users/${user.uid}`);
      const userDoc = await getDoc(userDocRef);
      if (!userDoc.exists() || !userDoc.data().firstInteraction) {
        await setDoc(userDocRef, { firstInteraction: true }, { merge: true });
        return true;
      }
      return false;
    }

    async function loadTrainingData() {
      try {
        const querySnapshot = await getDocs(collection(db, `global-model/training-data`));
        trainingData = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (
            data.input &&
            data.output &&
            data.text &&
            Object.values(data.input).every(v => typeof v === 'number' && !isNaN(v)) &&
            Object.values(data.output).every(v => typeof v === 'number' && !isNaN(v))
          ) {
            trainingData.push(data);
          }
        });
        if (trainingData.length > 0) {
          net.train(trainingData.map(d => ({ input: d.input, output: d.output })), {
            iterations: 1000,
            errorThresh: 0.005,
            log: true,
            logPeriod: 100
          });
          showToast("Shared model loaded successfully.");
        } else {
          showToast("No training data found in shared model. Using default model.");
        }
      } catch (error) {
        console.error("Failed to load shared training data:", error.message);
        showToast(`Failed to load shared model: ${error.message}`);
      }
    }

    async function loadConversations() {
      try {
        const user = auth.currentUser;
        if (!user) return;
        const querySnapshot = await getDocs(collection(db, `users/${user.uid}/conversations`));
        conversations = [];
        chatHistory.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          conversations.push({ id: doc.id, ...data });
          const firstMessage = data.messages[0]?.text || "Conversation";
          const timestamp = formatTimestamp(data.createdAt);
          const historyItem = document.createElement("p");
          historyItem.innerHTML = `${firstMessage.substring(0, 20)}${firstMessage.length > 20 ? "..." : ""} <span class="timestamp">${timestamp}</span>`;
          historyItem.dataset.conversationId = doc.id;
          historyItem.addEventListener("click", () => loadConversation(doc.id));
          chatHistory.appendChild(historyItem);
        });
      } catch (error) {
        console.error("Failed to load conversations:", error.message);
        showToast(`Failed to load conversations: ${error.message}`);
      }
    }

    async function loadConversation(conversationId) {
      try {
        const user = auth.currentUser;
        if (!user) return;
        const conversation = conversations.find(c => c.id === conversationId);
        if (!conversation) return;
        currentConversationId = conversationId;
        chatOutput.innerHTML = "";
        conversation.messages.forEach(msg => {
          const timestamp = formatTimestamp(msg.timestamp);
          chatOutput.innerHTML += `<div class="message ${msg.sender === 'user' ? 'user-message' : 'ai-message'}">${msg.text}<span class="timestamp">${timestamp}</span></div>`;
        });
        chatOutput.scrollTop = chatOutput.scrollHeight;
      } catch (error) {
        console.error("Failed to load conversation:", error.message);
        showToast(`Failed to load conversation: ${error.message}`);
      }
    }

    async function saveMessageToConversation(text, sender) {
      try {
        const user = auth.currentUser;
        if (!user) return;
        const message = {
          text,
          sender,
          timestamp: Timestamp.now()
        };
        if (!currentConversationId) {
          const docRef = await addDoc(collection(db, `users/${user.uid}/conversations`), {
            createdAt: Timestamp.now(),
            messages: [message]
          });
          currentConversationId = docRef.id;
          conversations.push({ id: docRef.id, createdAt: Timestamp.now(), messages: [message] });
          const historyItem = document.createElement("p");
          historyItem.innerHTML = `${text.substring(0, 20)}${text.length > 20 ? "..." : ""} <span class="timestamp">${formatTimestamp(Timestamp.now())}</span>`;
          historyItem.dataset.conversationId = docRef.id;
          historyItem.addEventListener("click", () => loadConversation(docRef.id));
          chatHistory.appendChild(historyItem);
        } else {
          const conversation = conversations.find(c => c.id === currentConversationId);
          conversation.messages.push(message);
          await setDoc(doc(db, `users/${user.uid}/conversations/${currentConversationId}`), {
            messages: conversation.messages,
            createdAt: conversation.createdAt
          }, { merge: true });
          const historyItem = chatHistory.querySelector(`[data-conversation-id="${currentConversationId}"]`);
          if (historyItem) {
            historyItem.innerHTML = `${conversation.messages[0].text.substring(0, 20)}${conversation.messages[0].text.length > 20 ? "..." : ""} <span class="timestamp">${formatTimestamp(conversation.createdAt)}</span>`;
          }
        }
      } catch (error) {
        console.error("Failed to save message:", error.message);
        showToast(`Failed to save message: ${error.message}`);
      }
    }

    function processInput(text) {
      if (!text) return null;
      const words = text.toLowerCase().split(" ");
      return {
        happy: words.includes("happy") || words.includes("awesome") ? 1 : 0,
        great: words.includes("great") || words.includes("good") ? 1 : 0,
        sad: words.includes("sad") || words.includes("terrible") ? 1 : 0,
        bad: words.includes("bad") || words.includes("awful") ? 1 : 0
      };
    }

    function generateHumanLikeResponse(output, inputText, isFirstInteraction, username) {
      const isPositive = output.positive > output.negative;
      const sentiment = isPositive ? "positive" : "negative";
      const matchingData = trainingData.filter(d =>
        (d.output.positive > d.output.negative && isPositive) ||
        (d.output.negative > d.output.positive && !isPositive)
      );

      let response;
      if (matchingData.length === 0) {
        response = isPositive
          ? "Sounds like you're in a great mood!"
          : "I'm sorry you're feeling down.";
      } else {
        const randomIndex = Math.floor(Math.random() * matchingData.length);
        const baseText = matchingData[randomIndex].text;
        const responses = [
          `Hey, that reminds me of "${baseText}"! You're feeling ${sentiment}, right?`,
          `Sounds like you're ${sentiment}, kinda like "${baseText}". What's up?`,
          `${isPositive ? "Awesome" : "Oh no"}, that's giving me "${baseText}" vibes! Tell me more!`
        ];
        response = responses[Math.floor(Math.random() * responses.length)];
      }

      if (isFirstInteraction && username) {
        return `Hello, ${username}! Welcome to Vynix AI. ${response}`;
      }
      return response;
    }

    window.sendMessage = async function () {
      const userInput = document.getElementById("user-input").value.trim();
      if (!userInput) {
        showToast("Please enter a message.");
        return;
      }

      const user = auth.currentUser;
      const isFirstInteraction = user ? await checkFirstInteraction(user) : false;
      const username = user ? (user.displayName || "User") : "User";
      const timestamp = formatTimestamp(Timestamp.now());
      chatOutput.innerHTML += `<div class="message user-message">${userInput}<span class="timestamp">${timestamp}</span></div>`;
      await saveMessageToConversation(userInput, "user");
      chatOutput.scrollTop = chatOutput.scrollHeight;

      const thinkingDiv = document.createElement("div");
      thinkingDiv.className = "thinking-dots";
      chatOutput.appendChild(thinkingDiv);
      chatOutput.scrollTop = chatOutput.scrollHeight;

      const input = processInput(userInput);
      if (!input) {
        setTimeout(async () => {
          chatOutput.removeChild(thinkingDiv);
          const errorMessage = "Invalid input. Please try again.";
          chatOutput.innerHTML += `<div class="message ai-message">${errorMessage}<span class="timestamp">${timestamp}</span></div>`;
          await saveMessageToConversation(errorMessage, "ai");
          chatOutput.scrollTop = chatOutput.scrollHeight;
        }, 3000);
        return;
      }

      try {
        setTimeout(async () => {
          chatOutput.removeChild(thinkingDiv);
          const output = net.run(input);
          const response = generateHumanLikeResponse(output, userInput, isFirstInteraction, username);
          chatOutput.innerHTML += `<div class="message ai-message">${response}<span class="timestamp">${timestamp}</span></div>`;
          await saveMessageToConversation(response, "ai");
          chatOutput.scrollTop = chatOutput.scrollHeight;
        }, 3000);
      } catch (error) {
        setTimeout(async () => {
          chatOutput.removeChild(thinkingDiv);
          console.error("Model prediction failed:", error.message);
          const errorMessage = "Error processing input. Please try again.";
          chatOutput.innerHTML += `<div class="message ai-message">${errorMessage}<span class="timestamp">${timestamp}</span></div>`;
          await saveMessageToConversation(errorMessage, "ai");
          chatOutput.scrollTop = chatOutput.scrollHeight;
        }, 3000);
      }

      document.getElementById("user-input").value = "";
      chatHistory.scrollTop = chatHistory.scrollHeight;
    };

    window.startNewConversation = function () {
      currentConversationId = null;
      chatOutput.innerHTML = "";
      document.getElementById("user-input").value = "";
      showToast("Started a new conversation.");
    };

    window.signOutUser = async function () {
      showSpinner();
      try {
        const user = auth.currentUser;
        if (user) {
          await setDoc(doc(db, `users/${user.uid}`), { online: false }, { merge: true });
          await signOut(auth);
          showToast("Signed out successfully.");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 500);
        } else {
          showToast("No user is signed in.");
        }
      } catch (error) {
        console.error("Sign out failed:", error.message);
        showToast(`Failed to sign out: ${error.message}`);
      } finally {
        hideSpinner();
      }
    };

    toggleSidebar.addEventListener("click", () => {
      sidebar.classList.toggle("active");
    });

    newChatBtn.addEventListener("click", startNewConversation);

    document.getElementById("user-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    signoutBtn.addEventListener("click", signOutUser);

    document.addEventListener("DOMContentLoaded", async () => {
      await new Promise((resolve, reject) => {
        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            console.log("No user authenticated, redirecting to index.html");
            window.location.href = "index.html";
          } else {
            console.log("User authenticated:", user.uid);
            setUserProfile(user);
            await loadTrainingData();
            await loadConversations();
            resolve();
          }
        }, (error) => {
          console.error("Auth state check failed:", error);
          showToast("Authentication check failed.");
          reject(error);
        });
      });
    });
  </script>
</body>
</html>
