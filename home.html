<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Home - ChatSphere</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
  <style>
    :root {
      --background: #FFFFFF; /* White background */
      --text-dark: #2C2C2C; /* Near-black for primary text */
      --text-light: #A9A9A9; /* Light gray for secondary text */
      --border: #D3D3D3; /* Light gray for borders */
      --white: #FFFFFF; /* White for elements */
      --black: #000000; /* Black for active states */
      --gray-accent: #696969; /* Medium gray for accents */
      --gradient-bg: linear-gradient(135deg, #F5F5F5 0%, #FFFFFF 100%); /* Subtle gradient */
    }

    [data-theme="dark"] {
      --background: #1C2526; /* Dark background for dark mode */
      --text-dark: #FFFFFF; /* White text for dark mode */
      --text-light: #A9A9A9; /* Light gray for consistency */
      --border: #2F3336; /* Darker border for dark mode */
      --white: #1C2526; /* Dark background for elements */
      --gradient-bg: linear-gradient(135deg, #2C2C2C 0%, #1C2526 100%); /* Dark gradient */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: opacity 0.5s ease, background 0.3s ease, color 0.3s ease;
    }

    body.fade-out {
      opacity: 0;
    }

    .top-bar {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--black);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo svg {
      width: 24px;
      height: 24px;
      fill: var(--black);
    }

    .profile-menu {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .profile-pic-small {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gray-accent);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
      border: 1px solid var(--border);
      text-transform: uppercase;
    }

    .profile-btn {
      background: none;
      border: none;
      color: var(--text-dark);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .profile-btn:hover, .profile-btn:focus {
      color: var(--black);
    }

    .tabs {
      display: flex;
      justify-content: center;
      background: var(--white);
      padding: 0.75rem 1rem;
      gap: 0.25rem;
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 5;
    }

    .tab-btn {
      flex: 1;
      max-width: 140px;
      padding: 0.6rem 1rem;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      color: var(--text-dark);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      position: relative;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      outline: none;
    }

    .tab-btn.active {
      background: var(--black);
      color: var(--white);
      border-color: var(--black);
      z-index: 4;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px);
    }

    .tab-btn:hover, .tab-btn:focus {
      background: var(--gray-accent);
      color: var(--white);
      transform: scale(1.03);
      z-index: 3;
    }

    .tab-btn:not(.active) {
      transform: translateY(3px);
    }

    .tab-btn svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
    }

    .tab-unread-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--black);
      color: var(--white);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
      min-height: calc(100vh - 120px);
      display: flex;
      flex-direction: column;
    }

    .tab-content {
      display: none;
      flex: 1;
    }

    .tab-content.active {
      display: block;
    }

    .chat-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .chat-item:hover {
      background: var(--gradient-bg);
      transform: translateY(-2px);
    }

    .chat-item .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 0.75rem;
      border: 1px solid var(--border);
      object-fit: cover;
    }

    .chat-item .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-accent);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      border: 1px solid var(--border);
      margin-right: 0.75rem;
      text-transform: uppercase;
    }

    .chat-info {
      flex: 1;
    }

    .chat-info h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
    }

    .chat-info p {
      font-size: 0.85rem;
      color: var(--text-light);
      margin: 0.25rem 0 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .chat-info p svg {
      width: 16px;
      height: 16px;
    }

    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
    }

    .chat-meta span {
      font-size: 0.75rem;
      color: var(--text-light);
    }

    .unread-badge {
      background: var(--black);
      color: var(--white);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
    }

    .status-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      gap: 0.5rem;
    }

    .status-upload input {
      display: none;
    }

    .upload-btn {
      padding: 0.5rem 1.5rem;
      background: var(--black);
      color: var(--white);
      border: none;
      border-radius: 24px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .upload-btn:hover, .upload-btn:focus {
      background: var(--gray-accent);
      transform: scale(1.05);
    }

    .upload-btn svg {
      width: 18px;
      height: 18px;
      stroke: var(--white);
    }

    .upload-progress-container {
      width: 80%;
      max-width: 300px;
      height: 6px;
      background: var(--text-light);
      border-radius: 3px;
      overflow: hidden;
      display: none;
    }

    .upload-progress-container.active {
      display: block;
    }

    .upload-progress {
      width: 0%;
      height: 100%;
      background: var(--black);
      transition: width 0.3s ease;
      animation: pulse 1.5s infinite ease-in-out;
    }

    .upload-progress-text {
      font-size: 0.8rem;
      color: var(--text-dark);
      margin-top: 0.25rem;
      display: none;
    }

    .upload-progress-text.active {
      display: block;
    }

    .cancel-upload-btn {
      padding: 0.5rem 1rem;
      background: var(--border);
      color: var(--text-dark);
      border: none;
      border-radius: 24px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      display: none;
    }

    .cancel-upload-btn.active {
      display: block;
    }

    .cancel-upload-btn:hover, .cancel-upload-btn:focus {
      background: var(--gray-accent);
      color: var(--white);
      transform: scale(1.05);
    }

    .status-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: calc(150px * 3);
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .status-list::-webkit-scrollbar {
      display: none;
    }

    .status-card {
      background: var(--gradient-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .status-card:hover {
      transform: translateY(-2px);
    }

    .status-card .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 0.75rem;
      border: 1px solid var(--border);
      object-fit: cover;
    }

    .status-card .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-accent);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      border: 1px solid var(--border);
      margin-right: 0.75rem;
      text-transform: uppercase;
    }

    .status-card-info {
      flex: 1;
    }

    .status-card-info h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
    }

    .status-card-info p {
      font-size: 0.85rem;
      color: var(--text-light);
      margin: 0.25rem 0 0;
    }

    .status-thumbnails {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .status-thumbnails::-webkit-scrollbar {
      display: none;
    }

    .status-thumbnail {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--black);
      cursor: pointer;
      position: relative;
    }

    .status-thumbnail.video::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><polygon points="5 3 19 12 5 21 5 3"/></svg>') no-repeat center;
      background-size: contain;
      opacity: 0.8;
    }

    .status-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: slideIn 0.3s ease-out;
    }

    .status-modal.active {
      display: flex;
    }

    .status-modal-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .status-media-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .status-media {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 0;
      transition: transform 0.3s ease;
    }

    .video-container {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .video-container video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 0;
    }

    .video-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--white);
    }

    .control-btn {
      display: none; /* Hide play/pause and mute/unmute buttons */
    }

    .progress-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #progress-bar {
      flex: 1;
      -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.3);
      height: 5px;
      border-radius: 3px;
      cursor: pointer;
    }

    #progress-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: var(--black);
      border-radius: 50%;
    }

    #progress-bar::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--black);
      border-radius: 50%;
      border: none;
    }

    .time-display {
      font-size: 0.8rem;
      color: var(--white);
    }

    .status-modal-close,
    .status-modal-delete {
      position: absolute;
      top: 20px;
      background: var(--white);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: background 0.2s ease;
      z-index: 1001;
    }

    .status-modal-close:hover,
    .status-modal-delete:hover {
      background: var(--gray-accent);
    }

    .status-modal-close {
      right: 20px;
    }

    .status-modal-delete {
      right: 70px;
    }

    .status-modal-close svg,
    .status-modal-delete svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-dark);
    }

    .swipe-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease;
      z-index: 1001;
    }

    .swipe-indicator:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .swipe-indicator svg {
      width: 24px;
      height: 24px;
      stroke: var(--white);
    }

    .swipe-indicator.left {
      left: 20px;
    }

    .swipe-indicator.right {
      right: 20px;
    }

    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--black);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .fab.hidden {
      display: none;
    }

    .fab:hover, .fab:focus {
      background: var(--gray-accent);
      transform: scale(1.1);
    }

    .fab svg {
      width: 24px;
      height: 24px;
      stroke: var(--white);
    }

    .custom-alert {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--white);
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      color: var(--text-dark);
      font-weight: 500;
      text-align: center;
      max-width: 90%;
      width: 320px;
      animation: fadeIn 0.3s ease-out forwards;
      border: 1px solid var(--border);
    }

    .custom-alert.active {
      display: block;
    }

    .custom-alert .close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: var(--black);
      cursor: pointer;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .custom-alert .close-btn:hover {
      transform: scale(1.2);
      color: var(--gray-accent);
    }

    .custom-alert .close-btn svg {
      width: 100%;
      height: 100%;
    }

    .custom-alert .alert-buttons {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .custom-alert .alert-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .custom-alert .confirm-btn {
      background: var(--black);
      color: var(--white);
    }

    .custom-alert .confirm-btn:hover {
      background: var(--gray-accent);
      transform: scale(1.05);
    }

    .custom-alert .cancel-btn {
      background: var(--border);
      color: var(--text-dark);
    }

    .custom-alert .cancel-btn:hover {
      background: var(--gray-accent);
      color: var(--white);
      transform: scale(1.05);
    }

    .spinner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--black);
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .toast {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--black);
      color: var(--white);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      font-weight: 500;
      animation: slideIn 0.3s ease-out forwards;
    }

    .toast.active {
      display: block;
    }

    .delete-bin {
      display: none;
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--black);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      z-index: 1002;
      transition: transform 0.1s ease;
    }

    .delete-bin.active {
      display: flex;
    }

    .delete-bin svg {
      width: 32px;
      height: 32px;
      stroke: var(--white);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    @keyframes slideIn {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    @media (max-width: 640px) {
      .top-bar {
        padding: 0.5rem;
      }

      .logo {
        font-size: 1.5rem;
      }

      .logo svg {
        width: 20px;
        height: 20px;
      }

      .profile-pic-small, .avatar {
        width: 28px;
        height: 28px;
        font-size: 0.9rem;
      }

      .tab-btn {
        font-size: 0.8rem;
        padding: 0.5rem 0.8rem;
        max-width: 120px;
      }

      .tab-btn svg {
        width: 16px;
        height: 16px;
      }

      .tab-unread-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }

      .container {
        padding: 0.5rem;
      }

      .chat-item {
        padding: 0.5rem;
      }

      .chat-item .profile-pic, .chat-item .avatar {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }

      .chat-info h3 {
        font-size: 0.9rem;
      }

      .chat-info p {
        font-size: 0.8rem;
      }

      .chat-info p svg {
        width: 14px;
        height: 14px;
      }

      .chat-meta span {
        font-size: 0.7rem;
      }

      .unread-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }

      .status-card .profile-pic, .status-card .avatar {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }

      .status-card-info h3 {
        font-size: 0.9rem;
      }

      .status-card-info p {
        font-size: 0.8rem;
      }

      .status-thumbnail {
        width: 60px;
        height: 60px;
      }

      .status-modal-close,
      .status-modal-delete {
        width: 36px;
        height: 36px;
      }

      .status-modal-close svg,
      .status-modal-delete svg {
        width: 20px;
        height: 20px;
      }

      .status-modal-delete {
        right: 60px;
      }

      .swipe-indicator {
        width: 32px;
        height: 32px;
      }

      .swipe-indicator svg {
        width: 20px;
        height: 20px;
      }

      .swipe-indicator.left {
        left: 10px;
      }

      .swipe-indicator.right {
        right: 10px;
      }

      .fab {
        width: 48px;
        height: 48px;
      }

      .fab svg {
        width: 20px;
        height: 20px;
      }

      .custom-alert {
        width: 85%;
        padding: 1rem;
      }

      .toast {
        right: 10px;
        max-width: 80%;
      }

      .video-controls {
        padding: 0.4rem;
        bottom: 10px;
        left: 10px;
        right: 10px;
      }

      .progress-container {
        gap: 0.3rem;
      }

      #progress-bar {
        height: 4px;
      }

      .time-display {
        font-size: 0.7rem;
      }

      .delete-bin {
        width: 50px;
        height: 50px;
      }

      .delete-bin svg {
        width: 28px;
        height: 28px;
      }

      .upload-progress-container {
        width: 90%;
      }

      .upload-progress-text {
        font-size: 0.75rem;
      }

      .cancel-upload-btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      ChatSphere
    </div>
    <div class="profile-menu">
      <div id="profile-pic-container"></div>
      <button class="profile-btn" id="profile-btn" aria-label="View profile">Profile</button>
      <button class="profile-btn" id="signout-btn" aria-label="Sign out">Sign Out</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="chats" aria-label="Chats tab" aria-selected="true" tabindex="0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      Chats
      <span id="chats-unread-badge" class="tab-unread-badge" style="display: none;"></span>
    </button>
    <button class="tab-btn" data-tab="status" aria-label="Status tab" aria-selected="false" tabindex="0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
      Status
    </button>
  </div>

  <div class="container">
    <div class="tab-content active" id="chats-tab">
      <div class="chat-list" id="chat-list"></div>
    </div>
    <div class="tab-content" id="status-tab">
      <div class="status-upload">
        <label for="status-file-input" class="upload-btn" aria-label="Upload status image or video">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
          </svg>
          Upload Status
        </label>
        <input type="file" id="status-file-input" accept="image/*,video/*" aria-label="Upload status image or video" />
        <div class="upload-progress-container" id="upload-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div class="upload-progress" id="upload-progress"></div>
        </div>
        <span class="upload-progress-text" id="upload-progress-text">Uploading: 0%</span>
        <button class="cancel-upload-btn" id="cancel-upload-btn" aria-label="Cancel upload">Cancel</button>
      </div>
      <div class="status-list" id="status-list"></div>
    </div>
  </div>

  <button class="fab" id="fab" aria-label="Add friends">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
      <circle cx="8.5" cy="7" r="4"></circle>
      <line x1="20" y1="8" x2="20" y2="14"></line>
      <line x1="17" y1="11" x2="23" y2="11"></line>
    </svg>
  </button>

  <div id="status-modal" class="status-modal">
    <div class="status-modal-content">
      <button class="status-modal-close" id="status-modal-close" aria-label="Close status" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <button class="status-modal-delete" id="status-modal-delete" style="display: none;" aria-label="Delete status" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </button>
      <div class="delete-bin" id="delete-bin">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </div>
      <button class="swipe-indicator left" id="swipe-left" style="display: none;" aria-label="Previous status" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="swipe-indicator right" id="swipe-right" style="display: none;" aria-label="Next status" tabindex="0">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
      <div class="status-media-container">
        <img id="status-image" class="status-media" src="" alt="Status content" style="display: none;" />
        <div class="video-container" style="display: none;">
          <video id="status-video" class="status-media" autoplay></video>
          <div class="video-controls" id="video-controls">
            <div class="progress-container">
              <input type="range" id="progress-bar" min="0" max="100" value="0" aria-label="Video progress">
              <span class="time-display" id="current-time">0:00</span>
              <span class="time-display" id="duration">0:00</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="custom-alert" class="custom-alert">
    <button class="close-btn" aria-label="Close alert" tabindex="0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <p id="alert-message">An error occurred. Please try again.</p>
    <div class="alert-buttons" id="alert-buttons" style="display: none;">
      <button class="alert-btn confirm-btn" id="confirm-delete">Delete</button>
      <button class="alert-btn cancel-btn" id="cancel-delete">Cancel</button>
    </div>
  </div>

  <div class="spinner-overlay" id="spinner">
    <div class="spinner"></div>
  </div>

  <div class="toast" id="toast">
    <p id="toast-message"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getDatabase, ref, get, set, remove, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e",
  measurementId: "G-V4W97VMSKL"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const signoutBtn = document.getElementById("signout-btn");
const profileBtn = document.getElementById("profile-btn");
const profilePicContainer = document.getElementById("profile-pic-container");
const chatList = document.getElementById("chat-list");
const statusFileInput = document.getElementById("status-file-input");
const statusList = document.getElementById("status-list");
const statusModal = document.getElementById("status-modal");
const statusImage = document.getElementById("status-image");
const statusVideo = document.getElementById("status-video");
const statusModalClose = document.getElementById("status-modal-close");
const statusModalDelete = document.getElementById("status-modal-delete");
const deleteBin = document.getElementById("delete-bin");
const swipeLeft = document.getElementById("swipe-left");
const swipeRight = document.getElementById("swipe-right");
const customAlert = document.getElementById("custom-alert");
const alertMessage = document.getElementById("alert-message");
const alertButtons = document.getElementById("alert-buttons");
const confirmDelete = document.getElementById("confirm-delete");
const cancelDelete = document.getElementById("cancel-delete");
const spinner = document.getElementById("spinner");
const toast = document.getElementById("toast");
const toastMessage = document.getElementById("toast-message");
const tabButtons = document.querySelectorAll(".tab-btn");
const tabContents = document.querySelectorAll(".tab-content");
const fab = document.getElementById("fab");
const chatsUnreadBadge = document.getElementById("chats-unread-badge");
const uploadProgressContainer = document.getElementById("upload-progress-container");
const uploadProgress = document.getElementById("upload-progress");
const uploadProgressText = document.getElementById("upload-progress-text");
const cancelUploadBtn = document.getElementById("cancel-upload-btn");

let currentUserId;
let currentUsername;
let currentProfilePic;
let encryptionKey;
const STATUS_EXPIRY_MS = 24 * 60 * 60 * 1000; // 24 hours
let currentStatuses = [];
let currentStatusIndex = 0;
let currentStatusUserId = null;
let touchStartX = 0;
let touchStartY = 0;
let touchEndX = 0;
let touchEndY = 0;
let isSwipingUp = false;
let xhr = null; // For cancelling uploads

const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/dqkujefxj/auto/upload";
const CLOUDINARY_UPLOAD_PRESET = "banter_box";

async function generateEncryptionKey(userId) {
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(userId + "ChatSphere2025"),
    { name: "PBKDF2" },
    false,
    ["deriveBits", "deriveKey"]
  );
  encryptionKey = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: new TextEncoder().encode("ChatSphereSalt"),
      iterations: 100000,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
}

async function decryptMessage(encryptedData, iv) {
  try {
    const ivArray = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
    const encryptedArray = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
    const decrypted = await crypto.subtle.decrypt(
      { name: "AES-GCM", iv: ivArray },
      encryptionKey,
      encryptedArray
    );
    return new TextDecoder().decode(decrypted);
  } catch (error) {
    console.error("Decryption failed:", error);
    return null;
  }
}

function showAlert(message, autoHide = true, showButtons = false) {
  alertMessage.textContent = message;
  alertButtons.style.display = showButtons ? "flex" : "none";
  customAlert.classList.add("active");
  if (autoHide) {
    setTimeout(hideAlert, 5000);
  }
}

function hideAlert() {
  customAlert.classList.remove("active");
  alertButtons.style.display = "none";
}

function showSpinner() {
  spinner.classList.add("active");
}

function hideSpinner() {
  spinner.classList.remove("active");
}

function showToast(message) {
  toastMessage.textContent = message;
  toast.classList.add("active");
  setTimeout(() => {
    toast.classList.remove("active");
  }, 3000);
}

function resetUploadUI() {
  uploadProgressContainer.classList.remove("active");
  uploadProgressText.classList.remove("active");
  cancelUploadBtn.classList.remove("active");
  uploadProgress.style.width = "0%";
  uploadProgressText.textContent = "Uploading: 0%";
  uploadProgressContainer.setAttribute("aria-valuenow", 0);
  xhr = null;
}

document.querySelector(".custom-alert .close-btn").addEventListener("click", hideAlert);

function getAvatarElement(username, sizeClass = "profile-pic-small") {
  const firstLetter = username ? username.charAt(0).toUpperCase() : "U";
  return `<div class="avatar ${sizeClass}">${firstLetter}</div>`;
}

function isValidImageUrl(url) {
  return url && !url.includes("via.placeholder.com") && !url.includes("data:image/svg+xml");
}

async function checkAndDeleteExpiredStatuses() {
  try {
    const statusesRef = ref(db, `statuses`);
    const snapshot = await get(statusesRef);
    if (snapshot.exists()) {
      const statuses = snapshot.val();
      for (const userId in statuses) {
        for (const statusId in statuses[userId]) {
          const status = statuses[userId][statusId];
          if (Date.now() - status.createdAt > STATUS_EXPIRY_MS) {
            await remove(ref(db, `statuses/${userId}/${statusId}`));
          }
        }
      }
    }
  } catch (error) {
    console.error("Error checking/deleting expired statuses:", error);
    showAlert("Failed to clean up expired statuses.", true);
  }
}

async function uploadToCloudinary(file, isVideo = false) {
  return new Promise((resolve, reject) => {
    const compressorOptions = isVideo
      ? {
          mimeType: "video/mp4",
          quality: 0.6,
          maxWidth: 1280,
          maxHeight: 720,
        }
      : {
          mimeType: "image/jpeg",
          quality: 0.8,
          maxWidth: 512,
          maxHeight: 512,
        };
    new Compressor(file, {
      ...compressorOptions,
      success(compressedFile) {
        const formData = new FormData();
        formData.append("file", compressedFile);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        formData.append("resource_type", isVideo ? "video" : "image");
        formData.append("eager", isVideo ? "w_80,h_80,c_fill,r_max" : "w_80,h_80,c_fill,r_max");
        xhr = new XMLHttpRequest();
        xhr.open("POST", CLOUDINARY_UPLOAD_URL, true);
        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            uploadProgress.style.width = `${percent}%`;
            uploadProgressText.textContent = `Uploading: ${percent}%`;
            uploadProgressContainer.setAttribute("aria-valuenow", percent);
          }
        };
        xhr.onreadystatechange = () => {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              const data = JSON.parse(xhr.responseText);
              resolve(data);
            } else {
              reject(new Error("Upload failed"));
            }
          }
        };
        xhr.onerror = () => reject(new Error("Upload failed"));
        xhr.send(formData);
      },
      error(err) {
        reject(err);
      },
    });
  });
}

async function uploadStatus(file) {
  if (!file) {
    showAlert("Please select a file.", true);
    return;
  }
  const isVideo = file.type.startsWith("video/");
  uploadProgressContainer.classList.add("active");
  uploadProgressText.classList.add("active");
  cancelUploadBtn.classList.add("active");
  try {
    const data = await uploadToCloudinary(file, isVideo);
    if (data.secure_url) {
      const statusId = data.public_id;
      let thumbnail = null;
      if (isVideo) {
        const video = document.createElement("video");
        video.src = data.secure_url;
        thumbnail = await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.currentTime = video.duration || 0;
            video.onseeked = () => {
              const canvas = document.createElement("canvas");
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              canvas.getContext("2d").drawImage(video, 0, 0);
              resolve(canvas.toDataURL("image/jpeg"));
            };
          };
          video.onerror = () => resolve(data.eager[0]?.secure_url || `${data.secure_url.replace(/\/upload\//, '/upload/so_0/')}.jpg`);
        });
      }
      await set(ref(db, `statuses/${currentUserId}/${statusId}`), {
        url: data.secure_url,
        type: data.resource_type,
        timestamp: Date.now(),
        createdAt: Date.now(),
        thumbnail: isVideo ? thumbnail || data.eager[0]?.secure_url || `${data.secure_url.replace(/\/upload\//, '/upload/so_0/')}.jpg` : null,
      });
      await checkAndDeleteExpiredStatuses();
      showToast("Status uploaded successfully!");
    } else {
      throw new Error("Failed to upload status");
    }
    resetUploadUI();
  } catch (error) {
    console.error("Status upload failed:", error);
    showAlert("Failed to upload status. Please try again.", true);
    resetUploadUI();
  }
}

async function deleteStatus(userId, statusId) {
  showSpinner();
  try {
    const statusRef = ref(db, `statuses/${userId}/${statusId}`);
    await remove(statusRef);
    showToast("Status deleted successfully!");
    if (currentStatuses.length > 1) {
      currentStatuses = currentStatuses.filter(s => s.statusId !== statusId);
      currentStatusIndex = Math.min(currentStatusIndex, currentStatuses.length - 1);
      openStatusModal(currentStatuses[currentStatusIndex], currentUsername);
    } else {
      statusModal.classList.remove("active");
      statusVideo.pause();
    }
    hideSpinner();
  } catch (error) {
    console.error("Status deletion failed:", error);
    showAlert("Failed to delete status. Please try again.", true);
    hideSpinner();
  }
}

async function checkAuthState() {
  showSpinner();
  try {
    await setPersistence(auth, browserLocalPersistence);
    await new Promise((resolve, reject) => {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            currentUserId = user.uid;
            await generateEncryptionKey(user.uid);
            const userRef = ref(db, `users/${user.uid}`);
            const userSnapshot = await get(userRef);
            if (userSnapshot.exists()) {
              const userData = userSnapshot.val();
              currentUsername = userData.username || user.displayName || "User";
              currentProfilePic = userData.profilePic || user.photoURL;
              profilePicContainer.innerHTML = isValidImageUrl(currentProfilePic)
                ? `<img class="profile-pic-small" src="${currentProfilePic}" alt="${currentUsername}'s profile picture" />`
                : getAvatarElement(currentUsername);
              await set(userRef, { ...userData, online: true });
              await onDisconnect(userRef).update({ online: false });
              showToast(`${currentUsername} is now online`);
              await checkAndDeleteExpiredStatuses();
              loadFriends(user.uid);
              loadStatuses();
            } else {
              showAlert("User data not found. Please sign in again.", false);
              await signOut(auth);
              document.body.classList.add("fade-out");
              setTimeout(() => window.location.href = "signup.html", 500);
            }
            hideSpinner();
            resolve();
          } catch (error) {
            console.error("Error fetching user data:", error);
            showAlert("Failed to load user data. Please try again.", false);
            hideSpinner();
            reject(error);
          }
        } else {
          document.body.classList.add("fade-out");
          setTimeout(() => window.location.href = "signup.html", 500);
          hideSpinner();
          resolve();
        }
      }, reject);
    });
  } catch (error) {
    console.error("Auth check failed:", error);
    showAlert("Failed to verify authentication. Please try again.", false);
    hideSpinner();
  }
}

async function loadFriends(userId) {
  const friendsRef = ref(db, `friends/${userId}`);
  onValue(friendsRef, async (snapshot) => {
    chatList.innerHTML = "";
    let totalUnreadCount = 0;
    if (snapshot.exists()) {
      const friends = snapshot.val();
      for (const friendId of Object.keys(friends)) {
        const friendRef = ref(db, `users/${friendId}`);
        const friendSnapshot = await get(friendRef);
        if (friendSnapshot.exists()) {
          const friendData = friendSnapshot.val();
          const chatRef = ref(db, `chats/${userId}/${friendId}`);
          const chatSnapshot = await get(chatRef);
          let lastMessage = "No messages yet";
          let timestamp = "";
          let unreadCount = 0;
          if (chatSnapshot.exists()) {
            const messages = Object.values(chatSnapshot.val()).sort((a, b) => a.timestamp - b.timestamp);
            const lastMsg = messages[messages.length - 1];
            if (lastMsg.type === "image") {
              lastMessage = `
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-light)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                Photo
              `;
            } else if (lastMsg.type === "video") {
              lastMessage = `
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-light)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Video
              `;
            } else {
              lastMessage = lastMsg.encrypted
                ? await decryptMessage(lastMsg.encrypted, lastMsg.iv) || "Unable to decrypt message"
                : lastMsg.text || "No messages yet";
            }
            timestamp = new Date(lastMsg.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            unreadCount = messages.filter(msg => msg.unread && msg.sender !== userId).length;
            totalUnreadCount += unreadCount;
          }
          const chatItem = document.createElement("div");
          chatItem.className = "chat-item";
          chatItem.dataset.friendId = friendId;
          const avatarElement = isValidImageUrl(friendData.profilePic)
            ? `<img class="profile-pic" src="${friendData.profilePic}" alt="${friendData.username}'s profile picture" />`
            : getAvatarElement(friendData.username, "profile-pic");
          chatItem.innerHTML = `
            ${avatarElement}
            <div class="chat-info">
              <h3>${friendData.username}</h3>
              <p>${lastMessage}</p>
            </div>
            <div class="chat-meta">
              <span>${timestamp}</span>
              ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ""}
            </div>
          `;
          chatItem.addEventListener("click", () => {
            document.body.classList.add("fade-out");
            setTimeout(() => window.location.href = `chat.html?friendId=${friendId}`, 500);
          });
          chatList.appendChild(chatItem);
        }
      }
      chatsUnreadBadge.textContent = totalUnreadCount > 0 ? totalUnreadCount : "";
      chatsUnreadBadge.style.display = totalUnreadCount > 0 ? "block" : "none";
    } else {
      chatList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No friends added yet.</p>';
      chatsUnreadBadge.style.display = "none";
    }
  });
}

async function loadStatuses() {
  const statusesRef = ref(db, `statuses`);
  onValue(statusesRef, async (snapshot) => {
    statusList.innerHTML = "";
    if (snapshot.exists()) {
      const statuses = snapshot.val();
      let statusCards = [];
      for (const userId in statuses) {
        let username, profilePic;
        if (userId === currentUserId) {
          username = currentUsername;
          profilePic = currentProfilePic;
        } else {
          const userRef = ref(db, `users/${userId}`);
          const userSnapshot = await get(userRef);
          if (!userSnapshot.exists()) continue;
          const userData = userSnapshot.val();
          username = userData.username;
          profilePic = userData.profilePic;
        }
        const userStatuses = Object.entries(statuses[userId])
          .map(([statusId, status]) => ({ statusId, ...status }))
          .filter(status => Date.now() - status.createdAt <= STATUS_EXPIRY_MS);
        if (userStatuses.length === 0) continue;
        const latestTimestamp = Math.max(...userStatuses.map(s => s.timestamp));
        statusCards.push({
          userId,
          username,
          profilePic,
          statuses: userStatuses,
          latestTimestamp
        });
      }
      statusCards.sort((a, b) => {
        if (a.userId === currentUserId) return -1;
        if (b.userId === currentUserId) return 1;
        return b.latestTimestamp - a.latestTimestamp;
      });
      statusCards.slice(0, 3).forEach(card => {
        const statusCard = document.createElement("div");
        statusCard.className = "status-card";
        statusCard.dataset.userId = card.userId;
        statusCard.setAttribute("aria-label", `${card.username}'s statuses`);
        const avatarElement = isValidImageUrl(card.profilePic)
          ? `<img class="profile-pic" src="${card.profilePic}" alt="${card.username}'s profile picture" />`
          : getAvatarElement(card.username, "profile-pic");
        const thumbnails = card.statuses.map(status => `
          <img 
            src="${status.type === 'video' && status.thumbnail ? status.thumbnail : status.url}" 
            class="status-thumbnail ${status.type === 'video' ? 'video' : ''}" 
            data-status-id="${status.statusId}" 
            data-type="${status.type}" 
            data-user-id="${card.userId}"
            alt="${card.username}'s status"
          >
        `).join("");
        statusCard.innerHTML = `
          ${avatarElement}
          <div class="status-card-info">
            <h3>${card.username}</h3>
            <p>${new Date(card.latestTimestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</p>
          </div>
          <div class="status-thumbnails">${thumbnails}</div>
        `;
        statusCard.querySelectorAll(".status-thumbnail").forEach(thumbnail => {
          thumbnail.addEventListener("click", () => {
            currentStatuses = card.statuses;
            currentStatusUserId = card.userId;
            currentStatusIndex = card.statuses.findIndex(s => s.statusId === thumbnail.dataset.statusId);
            openStatusModal(card.statuses[currentStatusIndex], card.username);
          });
        });
        statusList.appendChild(statusCard);
      });
      if (statusCards.length === 0) {
        statusList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No statuses yet.</p>';
      }
    } else {
      statusList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No statuses yet.</p>';
    }
  });
}

function openStatusModal(status, username) {
  console.log("Opening status modal for user:", status.userId, "Status ID:", status.statusId);
  statusImage.style.display = status.type === "image" ? "block" : "none";
  document.querySelector(".video-container").style.display = status.type === "video" ? "block" : "none";
  statusModalDelete.style.display = status.userId === currentUserId ? "flex" : "none";
  deleteBin.style.display = status.userId === currentUserId ? "none" : "none";
  swipeLeft.style.display = currentStatusIndex > 0 ? "flex" : "none";
  swipeRight.style.display = currentStatusIndex < currentStatuses.length - 1 ? "flex" : "none";
  if (status.type === "image") {
    statusImage.src = status.url;
    statusImage.alt = `${username}'s status`;
  } else {
    showSpinner();
    statusVideo.src = status.url;
    statusVideo.muted = false;
    statusVideo.play().then(() => {
      hideSpinner();
      updateProgressBar();
    }).catch(error => {
      console.error("Video autoplay failed:", error);
      hideSpinner();
      showAlert("Video could not autoplay. Please play manually.", true);
    });
  }
  statusModal.classList.add("active");
}

function formatTime(seconds) {
  const minutes = Math.floor(seconds / 60);
  seconds = Math.floor(seconds % 60);
  return `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
}

function updateProgressBar() {
  const progressBar = document.getElementById("progress-bar");
  const currentTimeDisplay = document.getElementById("current-time");
  const durationDisplay = document.getElementById("duration");
  if (statusVideo.duration) {
    progressBar.max = statusVideo.duration;
    durationDisplay.textContent = formatTime(statusVideo.duration);
  }
  const update = () => {
    progressBar.value = statusVideo.currentTime;
    currentTimeDisplay.textContent = formatTime(statusVideo.currentTime);
    if (!statusVideo.paused) {
      requestAnimationFrame(update);
    }
  };
  statusVideo.addEventListener("play", () => {
    requestAnimationFrame(update);
  }, { once: true });
  statusVideo.addEventListener("pause", () => {
    cancelAnimationFrame(update);
  }, { once: true });
  statusVideo.addEventListener("loadedmetadata", () => {
    progressBar.max = statusVideo.duration;
    durationDisplay.textContent = formatTime(statusVideo.duration);
  }, { once: true });
  progressBar.addEventListener("input", () => {
    statusVideo.currentTime = progressBar.value;
  });
}

function setupVideoControls() {
  const progressBar = document.getElementById("progress-bar");
  statusVideo.addEventListener("contextmenu", (e) => {
    e.preventDefault();
  });
}

function setupSwipeNavigation() {
  swipeLeft.addEventListener("click", () => {
    if (currentStatusIndex > 0) {
      statusVideo.pause();
      currentStatusIndex--;
      openStatusModal(currentStatuses[currentStatusIndex], currentUsername);
    }
  });

  swipeRight.addEventListener("click", () => {
    if (currentStatusIndex < currentStatuses.length - 1) {
      statusVideo.pause();
      currentStatusIndex++;
      openStatusModal(currentStatuses[currentStatusIndex], currentUsername);
    }
  });

  statusModal.addEventListener("touchstart", (e) => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  });

  statusModal.addEventListener("touchmove", (e) => {
    if (currentStatusUserId !== currentUserId) return;
    const touchY = e.changedTouches[0].screenY;
    const deltaY = touchStartY - touchY;
    if (deltaY > 50 && !isSwipingUp) {
      isSwipingUp = true;
      deleteBin.classList.add("active");
      console.log("Swipe up started, showing delete bin");
    }
    if (isSwipingUp) {
      const binY = Math.max(0, window.innerHeight - touchY - 80);
      deleteBin.style.transform = `translateX(-50%) translateY(-${binY}px)`;
    }
  });

  statusModal.addEventListener("touchend", (e) => {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    const swipeDistanceX = touchStartX - touchEndX;
    const swipeDistanceY = touchStartY - touchEndY;
    
    if (isSwipingUp && swipeDistanceY > 150 && currentStatusUserId === currentUserId) {
      console.log("Swipe up completed, showing delete confirmation");
      deleteBin.classList.remove("active");
      deleteBin.style.transform = "translateX(-50%)";
      isSwipingUp = false;
      showAlert("Are you sure you want to delete this status?", false, true);
      confirmDelete.onclick = () => {
        deleteStatus(currentStatusUserId, currentStatuses[currentStatusIndex].statusId);
        hideAlert();
      };
      cancelDelete.onclick = hideAlert;
    } else if (isSwipingUp) {
      console.log("Swipe up cancelled, not far enough");
      deleteBin.classList.remove("active");
      deleteBin.style.transform = "translateX(-50%)";
      isSwipingUp = false;
    } else if (Math.abs(swipeDistanceX) > 50) {
      if (swipeDistanceX > 0 && currentStatusIndex < currentStatuses.length - 1) {
        statusVideo.pause();
        currentStatusIndex++;
        openStatusModal(currentStatuses[currentStatusIndex], currentUsername);
      } else if (swipeDistanceX < 0 && currentStatusIndex > 0) {
        statusVideo.pause();
        currentStatusIndex--;
        openStatusModal(currentStatuses[currentStatusIndex], currentUsername);
      }
    } else if (Math.abs(swipeDistanceX) <= 50 && Math.abs(swipeDistanceY) <= 50 && currentStatuses[currentStatusIndex]?.type === "video") {
      console.log("Screen tapped, toggling play/pause");
      if (statusVideo.paused) {
        statusVideo.play();
      } else {
        statusVideo.pause();
      }
    }
  });
}

function setupModalControls() {
  statusModalClose.addEventListener("click", () => {
    console.log("Close button clicked");
    statusModal.classList.remove("active");
    statusVideo.pause();
    statusVideo.currentTime = 0;
    document.getElementById("progress-bar").value = 0;
    document.getElementById("current-time").textContent = "0:00";
    currentStatuses = [];
    currentStatusIndex = 0;
    currentStatusUserId = null;
    deleteBin.classList.remove("active");
    deleteBin.style.transform = "translateX(-50%)";
    isSwipingUp = false;
  });

  statusModalDelete.addEventListener("click", () => {
    console.log("Delete button clicked", currentStatusUserId, currentStatuses[currentStatusIndex].statusId);
    if (currentStatusUserId === currentUserId) {
      showAlert("Are you sure you want to delete this status?", false, true);
      confirmDelete.onclick = () => {
        deleteStatus(currentStatusUserId, currentStatuses[currentStatusIndex].statusId);
        hideAlert();
      };
      cancelDelete.onclick = hideAlert;
    }
  });
}

async function handleSignOut() {
  showSpinner();
  try {
    const userRef = ref(db, `users/${currentUserId}`);
    await set(userRef, { ...userRef.val(), online: false });
    await signOut(auth);
    document.body.classList.add("fade-out");
    setTimeout(() => window.location.href = "signup.html", 500);
  } catch (error) {
    console.error("Sign out failed:", error);
    showAlert("Failed to sign out. Please try again.", true);
    hideSpinner();
  }
}

function setupTabListeners() {
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-selected", "false");
      });
      tabContents.forEach(c => c.classList.remove("active"));
      btn.classList.add("active");
      btn.setAttribute("aria-selected", "true");
      document.getElementById(`${btn.dataset.tab}-tab`).classList.add("active");
      if (btn.dataset.tab === "chats") {
        fab.classList.remove("hidden");
      } else {
        fab.classList.add("hidden");
      }
    });
    btn.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        btn.click();
      }
    });
  });
}

function applyTheme() {
  const theme = localStorage.getItem("theme") || "light";
  document.documentElement.setAttribute("data-theme", theme);
}

function setupEventListeners() {
  signoutBtn.addEventListener("click", () => {
    handleSignOut();
    signoutBtn.classList.add("tap-active");
    setTimeout(() => signoutBtn.classList.remove("tap-active"), 100);
  });

  profileBtn.addEventListener("click", () => {
    document.body.classList.add("fade-out");
    setTimeout(() => window.location.href = "profile.html", 500);
  });

  statusFileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      uploadStatus(file);
      e.target.value = "";
    }
  });

  cancelUploadBtn.addEventListener("click", () => {
    if (xhr) {
      xhr.abort();
      showToast("Upload cancelled");
      resetUploadUI();
    }
  });

  fab.addEventListener("click", () => {
    document.body.classList.add("fade-out");
    setTimeout(() => window.location.href = "add-friends.html", 500);
  });

  setupVideoControls();
  setupSwipeNavigation();
  setupModalControls();
}

document.addEventListener("DOMContentLoaded", async () => {
  applyTheme();
  await checkAuthState();
  setupTabListeners();
  setupEventListeners();
  fab.classList.remove("hidden");
});

  </script>
</body>
</html>
