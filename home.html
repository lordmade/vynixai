<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix GB</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
      --status-bar: #D9D9D9;
      --dark-bg: #121212;
      --dark-chat-bg: #1F2A44;
      --dark-text-primary: #E5E5E5;
      --dark-text-secondary: #B0B0B0;
      --dark-border: #2A2A2A;
      --dark-accent: #00A884;
    }

    [data-theme="dark"] {
      --background: var(--dark-bg);
      --chat-bg: var(--dark-chat-bg);
      --text-primary: var(--dark-text-primary);
      --text-secondary: var(--dark-text-secondary);
      --border: var(--dark-border);
      --accent: var(--dark-accent);
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--background);
      position: sticky;
      top: 0;
      z-index: 20;
      transition: background 0.3s ease;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      overflow: hidden;
      transition: transform 0.2s ease;
    }

    .avatar:hover {
      transform: scale(1.05);
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
      transition: color 0.2s ease, transform 0.2s ease;
    }

    .icon-btn:hover {
      color: var(--accent);
      transform: scale(1.1);
    }

    .icon-btn svg {
      width: 24px;
      height: 24px;
    }

    .search-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: var(--background);
      border-bottom: 1px solid var(--border);
      display: none;
      z-index: 10;
      animation: slideDown 0.3s ease;
    }

    .search-bar.active {
      display: block;
    }

    .search-bar input {
      width: 100%;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--chat-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
    }

    .search-bar input:focus {
      border-color: var(--accent);
    }

    .bottom-sheet-search {
      width: 100%;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--chat-bg);
      color: var(--text-primary);
      outline: none;
      margin-bottom: 1rem;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }

    .chat-item, .status-item, .room-item, .group-item, .user-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chat-item:hover, .status-item:hover, .room-item:hover, .group-item:hover, .user-item:hover {
      background: var(--chat-bg);
    }

    .chat-avatar, .status-preview, .room-avatar, .group-avatar, .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      margin-right: 0.75rem;
      overflow: hidden;
      position: relative;
      transition: transform 0.2s ease;
    }

    .chat-avatar:hover, .status-preview:hover, .room-avatar:hover, .group-avatar:hover, .user-avatar:hover {
      transform: scale(1.05);
    }

    .chat-avatar img, .status-preview img, .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-info, .status-info, .room-info, .group-info, .user-info {
      flex: 1;
    }

    .chat-name, .status-name, .room-name, .group-name, .user-name {
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
    }

    .chat-preview, .status-time, .room-preview, .group-preview, .user-status {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0;
    }

    .chat-time, .room-members, .group-members {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .unread-count {
      background: var(--accent);
      color: #FFFFFF;
      border-radius: 12px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .add-btn {
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .add-btn:hover {
      background: #00976F;
      transform: scale(1.05);
    }

    .add-btn:disabled {
      background: var(--border);
      cursor: not-allowed;
    }

    .delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-secondary);
      transition: color 0.2s ease;
    }

    .delete-btn:hover {
      color: #FF3B30;
    }

    .delete-btn svg {
      width: 20px;
      height: 20px;
    }

    .bottom-tab-view {
      display: flex;
      border-top: 1px solid var(--border);
      background: var(--background);
      position: relative;
      z-index: 10;
      transition: background 0.3s ease;
    }

    .tab-item {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: color 0.2s ease, border-bottom 0.2s ease;
    }

    .tab-item.active {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
    }

    .tab-item svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-secondary);
      transition: stroke 0.2s ease;
    }

    .tab-item.active svg {
      stroke: var(--accent);
    }

    .fab {
      position: fixed;
      bottom: 5rem;
      right: 1rem;
      min-width: 120px;
      height: 56px;
      border-radius: 28px;
      background-color: var(--accent);
      color: #FFFFFF;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 50;
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
    }

    .fab:hover {
      background-color: #00976F;
      transform: scale(1.05);
    }

    @media (max-width: 640px) {
      .fab {
        min-width: 100px;
        font-size: 0.75rem;
        height: 48px;
        border-radius: 24px;
      }
      .tab-item svg {
        width: 18px;
        height: 18px;
      }
      .header { padding: 0.75rem; }
      .avatar { width: 32px; height: 32px; }
      .chat-list { padding: 0.5rem; }
      .chat-item, .status-item, .room-item, .group-item, .user-item { padding: 0.5rem; }
      .chat-avatar, .status-preview, .room-avatar, .group-avatar, .user-avatar { width: 40px; height: 40px; }
      .chat-name, .status-name, .room-name, .group-name, .user-name { font-size: 0.95rem; }
      .chat-preview, .status-time, .room-preview, .group-preview, .user-status { font-size: 0.8rem; }
      .fab { bottom: 4rem; right: 0.75rem; }
    }

    .bottom-sheet, #create-room-sheet, #create-group-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--background);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 15;
    }

    .bottom-sheet.active, #create-room-sheet.active, #create-group-sheet.active {
      transform: translateY(0);
    }

    .bottom-sheet-header, #create-room-sheet .bottom-sheet-header, #create-group-sheet .bottom-sheet-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .bottom-sheet-header h2, #create-room-sheet .bottom-sheet-header h2, #create-group-sheet .bottom-sheet-header h2 {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0;
    }

    .bottom-sheet-content, #create-room-sheet .bottom-sheet-content, #create-group-sheet .bottom-sheet-content {
      padding: 1.5rem;
    }

    .user-item, .friend-checkbox {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s ease;
    }

    .user-item:hover, .friend-checkbox:hover {
      background: var(--chat-bg);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      margin-right: 0.75rem;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .menu-dropdown {
      position: absolute;
      top: 60px;
      right: 1rem;
      background: var(--chat-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    .menu-dropdown.active {
      display: block;
    }

    .menu-item {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: background 0.2s ease;
    }

    .menu-item:hover {
      background: var(--background);
    }

    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .custom-alert.active {
      display: flex;
    }

    .alert-content {
      background: var(--background);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      transition: background 0.3s ease;
    }

    .alert-content p {
      margin: 0 0 1rem;
      font-size: 1rem;
    }

    .alert-content input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
      display: none;
    }

    .alert-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .alert-buttons button {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s ease;
    }

    #alert-confirm {
      background: var(--accent);
      color: #FFFFFF;
    }

    #alert-confirm:hover {
      background: #00976F;
    }

    #alert-cancel {
      background: var(--border);
      color: var(--text-primary);
    }

    #alert-cancel:hover {
      background: #D0D0D0;
    }

    .status-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000000;
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    .status-viewer.active {
      display: flex;
    }

    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.7);
      position: relative;
      z-index: 10;
    }

    .status-user {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #FFFFFF;
    }

    .status-user img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .progress-bar-container {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.7);
    }

    .progress-bar {
      flex: 1;
      height: 4px;
      background: var(--status-bar);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: var(--accent);
      width: 0;
      transition: width linear;
    }

    .status-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .status-content img, .status-content video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
    }

    .status-caption {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      color: #FFFFFF;
      background: rgba(0, 0, 0, 0.7);
      padding: 0.5rem;
      border-radius: 8px;
      text-align: center;
      font-size: 0.875rem;
    }

    .tap-area {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
      z-index: 10;
    }

    .tap-area-left {
      left: 0;
    }

    .tap-area-right {
      right: 0;
    }

    .view-count {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      color: #FFFFFF;
      background: rgba(0, 0, 0, 0.7);
      padding: 0.25rem 0.5rem;
      border-radius: 8px;
      font-size: 0.75rem;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .progress-container {
      position: fixed;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--background);
      padding: 1rem;
      border-radius: 8px;
      display: none;
      z-index: 1001;
      width: 80%;
      max-width: 400px;
    }

    .progress-container.active {
      display: block;
    }

    .progress-bar-upload {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-upload div {
      height: 100%;
      background: var(--accent);
      width: 0;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .new-message-notification {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--background);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
      max-width: 90%;
      animation: slideDown 0.3s ease;
    }

    .new-message-notification.active {
      display: block;
    }

    .shimmer {
      animation: shimmer 1.2s ease-in-out infinite;
      background: linear-gradient(to right, var(--border) 0%, #e0e0e0 20%, var(--border) 40%, var(--border) 100%);
      background-size: 200% 100%;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .shimmer-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .shimmer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--border);
      margin-right: 0.75rem;
    }

    .shimmer-text {
      flex: 1;
    }

    .shimmer-line {
      height: 12px;
      background: var(--border);
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }

    .shimmer-line.long { width: 80%; }
    .shimmer-line.short { width: 50%; }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      background: var(--chat-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      border-color: var(--accent);
    }

    .input-group textarea {
      resize: none;
      height: 100px;
    }

    .btn.primary {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .btn.primary:hover {
      background: #00976F;
      transform: scale(1.02);
    }

    .online-dot {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      background-color: #00FF00;
      border-radius: 50%;
      border: 2px solid var(--background);
    }

    @media (max-width: 640px) {
      .online-dot {
        width: 10px;
        height: 10px;
        border: 1px solid var(--background);
      }
    }

    .chat-preview .media-icon,
    .room-preview .media-icon,
    .group-preview .media-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    .chat-preview .image-icon,
    .room-preview .image-icon,
    .group-preview .image-icon {
      background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>') no-repeat center;
      background-size: contain;
    }

    .chat-preview .video-icon,
    .room-preview .video-icon,
    .group-preview .video-icon {
      background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>') no-repeat center;
      background-size: contain;
    }

    .chat-preview.typing {
      font-style: italic;
      color: var(--accent);
    }

    #call-modal {
      position: fixed;
      top: 0;
      right: 0;
      width: 300px;
      max-height: 400px;
      background: var(--background);
      border-bottom-right-radius: 16px;
      border-top-left-radius: 0;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    #call-modal.active {
      transform: translateX(0);
    }

    .call-modal-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem;
    }

    .call-modal-content .caller-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .call-modal-content .caller-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      overflow: hidden;
    }

    .call-modal-content .caller-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .call-modal-content .caller-name {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .call-modal-content .call-type {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .call-modal-content .call-buttons {
      display: flex;
      gap: 1rem;
    }

    .call-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s ease;
    }

    .call-btn.accept {
      background: var(--accent);
      color: #FFFFFF;
    }

    .call-btn.accept:hover {
      background: #00976F;
    }

    .call-btn.decline {
      background: #FF3B30;
      color: #FFFFFF;
    }

    .call-btn.decline:hover {
      background: #E02A20;
    }

    @media (max-width: 640px) {
      #call-modal {
        width: 100%;
        max-height: 50vh;
        border-top-left-radius: 16px;
        border-bottom-right-radius: 0;
      }
    }

    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="user-profile">
      <div id="user-avatar" class="avatar" role="img" aria-label="User avatar">U</div>
      <span id="user-name">Loading...</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn search-icon" onclick="window.toggleSearchBar()" aria-label="Search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
      <button class="icon-btn" onclick="window.toggleMenu()" aria-label="Menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
  <div id="menu-dropdown" class="menu-dropdown">
    <div class="menu-item" onclick="window.location.href='profile.html'" role="menuitem">Profile</div>
    <div class="menu-item" onclick="window.location.href='discover.html'" role="menuitem">Business Channels</div>
    <div class="menu-item" onclick="window.toggleTheme()" role="menuitem">Toggle Theme</div>
    <div class="menu-item" onclick="window.location.href='settings.html'" role="menuitem">Settings</div>
    <div class="menu-item" onclick="firebase.auth().signOut()" role="menuitem">Sign Out</div>
  </div>
  <div id="search-bar" class="search-bar">
    <input id="search-input" type="text" placeholder="Search..." oninput="window.filterContent(this.value)" aria-label="Search chats, statuses, rooms, or groups" />
  </div>
  <div id="chat-list" class="chat-list" role="list" aria-busy="true"></div>
  <div id="bottom-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Add Friends</h2>
      <button class="close-btn" onclick="window.hideBottomSheet()" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <input id="bottom-sheet-search" class="bottom-sheet-search" type="text" placeholder="Search users..." oninput="window.filterUsers(this.value)" aria-label="Search users" />
      <div id="user-list" role="list"></div>
    </div>
  </div>
  <div id="create-room-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Chat Room</h2>
      <button class="close-btn" onclick="window.hideRoomSheet()" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="input-group">
        <label for="room-name-input">Room Name</label>
        <input type="text" id="room-name-input" placeholder="Enter room name (max 50 characters)" maxlength="50" aria-required="true" />
      </div>
      <div class="input-group">
        <label for="room-type">Room Type</label>
        <select id="room-type" aria-label="Room type">
          <option value="public">Public</option>
          <option value="private">Private</option>
        </select>
      </div>
      <div class="input-group">
        <label for="room-description">Description (optional)</label>
        <textarea id="room-description" placeholder="Describe your room (max 200 characters)" maxlength="200" aria-label="Room description"></textarea>
      </div>
      <button id="create-room-btn" class="btn primary" aria-label="Create room">Create Room</button>
    </div>
  </div>
  <div id="create-group-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Group</h2>
      <button class="close-btn" onclick="window.hideGroupSheet()" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="input-group">
        <label for="group-name-input">Group Name</label>
        <input type="text" id="group-name-input" placeholder="Enter group name (max 50 characters)" maxlength="50" aria-required="true" />
      </div>
      <div class="input-group">
        <label>Select Friends</label>
        <div id="friend-list" role="list"></div>
      </div>
      <button id="create-group-btn" class="btn primary" aria-label="Create group">Create Group</button>
    </div>
  </div>
  <div id="status-viewer" class="status-viewer">
    <div class="status-header">
      <div class="status-user"></div>
      <button class="close-btn" onclick="window.closeStatusViewer()" aria-label="Close status">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="status-content">
      <img id="status-image" aria-label="Status image" />
      <video id="status-video" autoplay playsinline aria-label="Status video"></video>
      <div class="status-caption" id="status-caption"></div>
    </div>
  </div>
  <div id="new-message-notification" class="new-message-notification">
    <span id="notification-message"></span>
  </div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-content">
      <p id="alert-message"></p>
      <input id="alert-input" type="text" aria-label="Alert input" />
      <div id="alert-buttons" class="alert-buttons">
        <button id="alert-confirm" aria-label="Confirm">OK</button>
        <button id="alert-cancel" aria-label="Cancel">Cancel</button>
      </div>
    </div>
  </div>
  <div id="call-modal" class="bottom-sheet">
    <div class="call-modal-content">
      <div class="caller-info">
        <div class="caller-avatar" id="caller-avatar" role="img" aria-label="Caller avatar">?</div>
        <div>
          <h3 class="caller-name" id="caller-name">Unknown</h3>
          <p class="call-type" id="call-type">Incoming Call...</p>
        </div>
      </div>
      <div class="call-buttons">
        <button class="call-btn accept" id="accept-call-btn" aria-label="Accept call">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
            <path d="M20 4L9 15l-3-3"></path>
          </svg>
          Accept
        </button>
        <button class="call-btn decline" id="decline-call-btn" aria-label="Decline call">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Decline
        </button>
      </div>
    </div>
  </div>
  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
    <div id="progress-container" class="progress-container">
      <div id="progress-bar-upload" class="progress-bar-upload">
        <div></div>
      </div>
      <div id="progress-text" class="progress-text">0%</div>
    </div>
  </div>
  <input type="file" id="status-upload" accept="image/*,video/*" style="display: none;" aria-label="Upload status" />
  <div class="bottom-tab-view" role="tablist">
    <div class="tab-item active" data-tab="chats" role="tab" aria-selected="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      Chats <span id="chats-unread-count" class="unread-count" style="display: none;"></span>
    </div>
    <div class="tab-item" data-tab="status" role="tab" aria-selected="false">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="4"></circle>
      </svg>
      Status
    </div>
    <div class="tab-item" data-tab="rooms" role="tab" aria-selected="false">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <circle cx="20" cy="7" r="4"></circle>
      </svg>
      Rooms
    </div>
    <div class="tab-item" data-tab="groups" role="tab" aria-selected="false">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        <circle cx="20" cy="7" r="4"></circle>
      </svg>
      Groups
    </div>
  </div>
  <div id="fab" class="fab" role="button" aria-label="Action button">Add Friend</div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, set, push, remove, get, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const ROUTES = {
      PROFILE: 'profile.html',
      MESSAGES: 'messages.html',
      SETTINGS: 'settings.html',
      ROOM: 'room.html',
      GROUP: 'group.html'
    };

    const MESSAGES = {
      SIGN_IN_REQUIRED: 'Please sign in to view this section.',
      STATUS_UPLOAD_SUCCESS: 'Status uploaded successfully!',
      STATUS_UPLOAD_FAIL: 'Failed to upload status.',
      STATUS_DOWNLOAD_SUCCESS: 'Status downloaded successfully!',
      STATUS_DOWNLOAD_FAIL: 'Failed to download status.',
      ADD_FRIEND_SUCCESS: 'Added {name} as a friend!',
      ADD_FRIEND_FAIL: 'Failed to add friend. Please try again.',
      PROFILE_FAIL: 'Failed to load profile.',
      STATUS_FAIL: 'Failed to load statuses. Please try again.',
      USER_FAIL: 'Failed to load users. Please try again.',
      CHAT_FAIL: 'Failed to load chats. Please try again.',
      STATUS_DELETE_SUCCESS: 'Status deleted successfully!',
      STATUS_DELETE_FAIL: 'Failed to delete status. Please try again.',
      FILE_SIZE_EXCEEDED: 'File size exceeds 50MB limit.',
      CAPTION_TOO_LONG: 'Caption cannot exceed 100 characters.',
      ROOM_CREATE_SUCCESS: 'Chat room created successfully!',
      ROOM_CREATE_FAIL: 'Failed to create chat room.',
      ROOM_JOIN_SUCCESS: 'Joined {name} successfully!',
      ROOM_JOIN_FAIL: 'Failed to join room.',
      ROOM_NOT_FOUND: 'Room not found.',
      ROOM_NAME_REQUIRED: 'Room name is required.',
      GROUP_CREATE_SUCCESS: 'Group created successfully!',
      GROUP_CREATE_FAIL: 'Failed to create group.',
      GROUP_NAME_REQUIRED: 'Group name is required.',
      GROUP_MIN_MEMBERS: 'Select at least one friend to create a group.',
      SCHEDULE_MESSAGE_SUCCESS: 'Message scheduled successfully!',
      SCHEDULE_MESSAGE_FAIL: 'Failed to schedule message.',
      AUTO_REPLY_SAVED: 'Auto-reply settings saved!',
      AUTO_REPLY_FAIL: 'Failed to save auto-reply settings.'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    const alertInput = document.getElementById("alert-input");
    const alertConfirm = document.getElementById("alert-confirm");
    const alertCancel = document.getElementById("alert-cancel");
    const chatList = document.getElementById("chat-list");
    const bottomSheet = document.getElementById("bottom-sheet");
    const createRoomSheet = document.getElementById("create-room-sheet");
    const createGroupSheet = document.getElementById("create-group-sheet");
    const userList = document.getElementById("user-list");
    const tabItems = document.querySelectorAll(".tab-item");
    const searchBar = document.getElementById("search-bar");
    const menuDropdown = document.getElementById("menu-dropdown");
    const userAvatar = document.getElementById("user-avatar");
    const userName = document.getElementById("user-name");
    const statusViewer = document.getElementById("status-viewer");
    const statusImage = document.getElementById("status-image");
    const statusVideo = document.getElementById("status-video");
    const statusCaption = document.getElementById("status-caption");
    const fab = document.getElementById("fab");
    const statusUpload = document.getElementById("status-upload");
    const spinnerOverlay = document.getElementById("spinner-overlay");
    const progressContainer = document.getElementById("progress-container");
    const progressBarUpload = document.getElementById("progress-bar-upload");
    const progressText = document.getElementById("progress-text");
    let friendsData = [];
    let suggestedFriends = [];
    let statusesData = {};
    let statusTimer;
    let currentTab = "chats";
    let isPaused = false;
    let alertResolve = null;
    let debounceTimer;
    let settings = { theme: 'light', readReceipts: true, typingIndicator: true };

    // Cloudinary configuration
    const CLOUDINARY_CLOUD_NAME = "dqkujefxj";
    const CLOUDINARY_UPLOAD_PRESET = "banter_box";
    const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

    // Encryption key (should be securely managed in production)
    const ENCRYPTION_KEY = "my-secret-key-123";

    // WebRTC configuration (placeholder)
    const webrtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'turn:turn.example.com', username: 'user', credential: 'pass' }
      ]
    };

    // Window functions
    window.hideAlert = function () {
      customAlert.classList.remove("active");
      alertInput.style.display = "none";
      alertConfirm.style.display = "none";
      alertCancel.style.display = "none";
      alertInput.value = "";
      alertResolve = null;
    };

    window.showAlert = function (message, autoHide = true, input = false, confirmCallback = null, cancelCallback = null) {
      return new Promise((resolve) => {
        alertMessage.textContent = message;
        alertInput.style.display = input ? "block" : "none";
        alertConfirm.style.display = confirmCallback ? "block" : "none";
        alertCancel.style.display = cancelCallback ? "block" : "none";
        customAlert.classList.add("active");
        alertResolve = resolve;

        if (input) {
          alertInput.focus();
        }

        if (autoHide && !confirmCallback && !cancelCallback) {
          setTimeout(window.hideAlert, 5000);
        }

        alertConfirm.onclick = () => {
          if (confirmCallback) {
            confirmCallback(input ? alertInput.value : true);
          }
          resolve(input ? alertInput.value : true);
          window.hideAlert();
        };

        alertCancel.onclick = () => {
          if (cancelCallback) {
            cancelCallback();
          }
          resolve(false);
          window.hideAlert();
        };
      });
    };

    window.showBottomSheet = function () {
      bottomSheet.classList.add("active");
      const searchInput = document.getElementById("bottom-sheet-search");
      searchInput.value = "";
      searchInput.focus();
      loadSuggestedFriends(auth.currentUser?.uid);
    };

    window.hideBottomSheet = function () {
      bottomSheet.classList.remove("active");
      document.getElementById("bottom-sheet-search").value = "";
      userList.innerHTML = "";
    };

    window.showRoomSheet = function () {
      createRoomSheet.classList.add("active");
      document.getElementById("room-name-input").focus();
    };

    window.hideRoomSheet = function () {
      createRoomSheet.classList.remove("active");
      document.getElementById("room-name-input").value = "";
      document.getElementById("room-type").value = "public";
      document.getElementById("room-description").value = "";
    };

    window.showGroupSheet = function () {
      createGroupSheet.classList.add("active");
      loadFriendsForGroup();
      document.getElementById("group-name-input").focus();
    };

    window.hideGroupSheet = function () {
      createGroupSheet.classList.remove("active");
      document.getElementById("group-name-input").value = "";
      document.getElementById("friend-list").innerHTML = "";
    };

    window.toggleSearchBar = function () {
      searchBar.classList.toggle("active");
      const searchInput = document.getElementById("search-input");
      if (searchBar.classList.contains("active")) {
        searchInput.focus();
      } else {
        searchInput.value = "";
        window.filterContent("");
      }
    };

    window.toggleMenu = function () {
      menuDropdown.classList.toggle("active");
    };

    window.toggleTheme = function () {
      settings.theme = settings.theme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', settings.theme);
      localStorage.setItem('theme', settings.theme);
      if (auth.currentUser) {
        update(ref(db, `users/${auth.currentUser.uid}/settings`), { theme: settings.theme });
      }
    };

    window.closeStatusViewer = function () {
      statusViewer.classList.remove("active");
      statusImage.style.display = "none";
      statusVideo.style.display = "none";
      statusVideo.pause();
      statusCaption.textContent = "";
      statusViewer.querySelector('.status-user')?.remove();
      statusViewer.querySelector('.progress-bar-container')?.remove();
      statusViewer.querySelector('.tap-area-left')?.remove();
      statusViewer.querySelector('.tap-area-right')?.remove();
      statusViewer.querySelector('#view-count')?.remove();
      clearInterval(statusTimer);
      isPaused = false;
    };

    window.showNotification = function (senderName, message) {
      const notification = document.getElementById('new-message-notification');
      const notificationMessage = document.getElementById('notification-message');
      notificationMessage.textContent = `${senderName}: ${message}`;
      notification.classList.add('active');
      setTimeout(window.hideNotification, 5000);
    };

    window.hideNotification = function () {
      const notification = document.getElementById('new-message-notification');
      notification.classList.remove('active');
    };

    window.showCallModal = function (callerId, callType = 'voice') {
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      const callerRef = ref(db, `users/${callerId}`);
      get(callerRef).then((snapshot) => {
        if (snapshot.exists()) {
          const caller = snapshot.val();
          const callerName = document.getElementById('caller-name');
          const callerAvatar = document.getElementById('caller-avatar');
          const callTypeEl = document.getElementById('call-type');
          callerName.textContent = caller.name || 'Unknown';
          callTypeEl.textContent = `Incoming ${callType.charAt(0).toUpperCase() + callType.slice(1)} Call...`;
          const firstLetter = caller.name ? caller.name.charAt(0).toUpperCase() : '?';
          callerAvatar.innerHTML = caller.avatar
            ? `<img src="${caller.avatar}" alt="Avatar of ${caller.name || 'Unknown'}" onerror="this.parentElement.textContent='${firstLetter}'" />`
            : firstLetter;
          document.getElementById('call-modal').classList.add('active');
        }
      }).catch((error) => {
        console.error('Error fetching caller info:', error);
        window.showAlert('Failed to load caller information.', false);
      });
    };

    window.hideCallModal = function () {
      document.getElementById('call-modal').classList.remove('active');
      document.getElementById('caller-name').textContent = 'Unknown';
      document.getElementById('call-type').textContent = 'Incoming Call...';
      document.getElementById('caller-avatar').innerHTML = '?';
    };

    window.filterContent = function (query) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        if (currentTab === "chats") {
          const filteredChats = friendsData.filter(friend =>
            friend.name.toLowerCase().includes(query.toLowerCase())
          );
          renderChats(filteredChats);
        } else if (currentTab === "status") {
          const filteredStatuses = {};
          Object.entries(statusesData).forEach(([uid, statuses]) => {
            const filtered = statuses.filter(status =>
              status.caption.toLowerCase().includes(query.toLowerCase())
            );
            if (filtered.length > 0) {
              filteredStatuses[uid] = filtered;
            }
          });
          renderStatuses(filteredStatuses);
        } else if (currentTab === "rooms") {
          const roomsRef = ref(db, 'chatrooms');
          const roomsSnapshot = await get(roomsRef);
          const rooms = roomsSnapshot.val() || {};
          renderRooms(rooms, query);
        } else if (currentTab === "groups") {
          const groupsRef = ref(db, 'groups');
          const groupsSnapshot = await get(groupsRef);
          const groups = groupsSnapshot.val() || {};
          renderGroups(groups, query);
        }
      }, 300);
    };

    window.filterUsers = function (query) {
      const filteredUsers = suggestedFriends.filter(user =>
        user.name.toLowerCase().includes(query.toLowerCase())
      );
      renderSuggestedFriends(filteredUsers);
    };

    // Helper functions
    function showShimmer(element, count = 5) {
      element.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const shimmerItem = document.createElement('div');
        shimmerItem.className = 'shimmer-item shimmer';
        shimmerItem.innerHTML = `
          <div class="shimmer-avatar"></div>
          <div class="shimmer-text">
            <div class="shimmer-line long"></div>
            <div class="shimmer-line short"></div>
          </div>
        `;
        element.appendChild(shimmerItem);
      }
    }

    function encryptMessage(message) {
      return CryptoJS.AES.encrypt(message, ENCRYPTION_KEY).toString();
    }

    function decryptMessage(ciphertext) {
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_KEY);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        return decrypted || '[Decryption Failed]';
      } catch (error) {
        console.error("Decryption error:", error);
        return '[Decryption Failed]';
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } else if (diffDays === 1) {
        return 'Yesterday';
      } else {
        return date.toLocaleDateString();
      }
    }

    async function uploadToCloudinary(file, onProgress) {
      if (file.size > 50 * 1024 * 1024) {
        throw new Error(MESSAGES.FILE_SIZE_EXCEEDED);
      }
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", CLOUDINARY_API_URL, true);

        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percentComplete = Math.round((event.loaded / event.total) * 100);
            if (onProgress) {
              onProgress(percentComplete);
            }
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.secure_url) {
              resolve({
                url: data.secure_url,
                resource_type: data.resource_type,
                public_id: data.public_id,
              });
            } else {
              reject(new Error(data.error?.message || "Upload failed"));
            }
          } else {
            reject(new Error(`Upload failed with status ${xhr.status}`));
          }
        };

        xhr.onerror = () => {
          reject(new Error("Network error during upload"));
        };

        xhr.send(formData);
      });
    }

    async function downloadStatus(statusUrl, filename) {
      try {
        const response = await fetch(statusUrl);
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'status_download';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        window.showAlert(MESSAGES.STATUS_DOWNLOAD_SUCCESS, true);
      } catch (error) {
        console.error("Error downloading status:", error);
        window.showAlert(MESSAGES.STATUS_DOWNLOAD_FAIL, false);
      }
    }

    async function uploadStatus(file, userId, userProfile) {
      if (!file) return;
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      if (file.size > 50 * 1024 * 1024) {
        window.showAlert(MESSAGES.FILE_SIZE_EXCEEDED, false);
        return;
      }
      const caption = await window.showAlert(
        "Enter a caption for your status (max 100 characters):",
        false,
        true,
        (value) => {
          if (value.length > 100) {
            window.showAlert(MESSAGES.CAPTION_TOO_LONG, false);
            return;
          }
        },
        () => {}
      );
      if (caption === false) return;
      if (caption.length > 100) {
        window.showAlert(MESSAGES.CAPTION_TOO_LONG, false);
        return;
      }
      const privacy = await window.showAlert(
        "Select status privacy:",
        false,
        true,
        (value) => {
          if (!['everyone', 'friends', 'custom'].includes(value.toLowerCase())) {
            window.showAlert('Invalid privacy setting. Use "everyone", "friends", or "custom".', false);
            return;
          }
        },
        () => {}
      );
      if (privacy === false) return;
      let allowedUsers = [];
      if (privacy.toLowerCase() === 'custom') {
        const selectedUsers = await selectUsersForStatus();
        if (!selectedUsers) return;
        allowedUsers = selectedUsers;
      }
      spinnerOverlay.classList.add("active");
      progressContainer.classList.add("active");
      spinnerOverlay.querySelector('.spinner').style.display = 'none';
      progressBarUpload.style.width = '0%';
      progressText.textContent = '0%';
      try {
        const uploadResult = await uploadToCloudinary(file, (percent) => {
          progressBarUpload.querySelector('div').style.width = `${percent}%`;
          progressText.textContent = `${percent}%`;
        });
        const statusData = {
          url: uploadResult.url,
          resource_type: uploadResult.resource_type,
          timestamp: Date.now(),
          caption: caption || "",
          privacy: privacy.toLowerCase(),
          allowedUsers: allowedUsers.length > 0 ? allowedUsers : null,
          views: {}
        };
        await push(ref(db, `statuses/${userId}`), statusData);
        window.showAlert(MESSAGES.STATUS_UPLOAD_SUCCESS, true);
        loadStatuses(userId, { name: userName.textContent });
      } catch (error) {
        console.error("Error uploading status:", error);
        window.showAlert(`${MESSAGES.STATUS_UPLOAD_FAIL}: ${error.message}`, false);
      } finally {
        spinnerOverlay.classList.remove("active");
        progressContainer.classList.remove("active");
        spinnerOverlay.querySelector('.spinner').style.display = 'block';
        progressBarUpload.querySelector('div').style.width = '0%';
        progressText.textContent = '0%';
        statusUpload.value = '';
      }
    }

    async function selectUsersForStatus() {
      const friendsRef = ref(db, `friends/${auth.currentUser.uid}`);
      const friendsSnapshot = await get(friendsRef);
      const friends = friendsSnapshot.val() || {};
      const usersRef = ref(db, 'users');
      const usersSnapshot = await get(usersRef);
      const users = usersSnapshot.val() || {};
      const friendList = document.createElement('div');
      friendList.className = 'friend-checkbox';
      Object.keys(friends).forEach(uid => {
        const user = users[uid] || { name: 'Unknown', avatar: null };
        const friendItem = document.createElement('div');
        friendItem.className = 'friend-checkbox';
        const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
        const avatarContent = user.avatar ? `<img src="${user.avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
        friendItem.innerHTML = `
          <div class="user-avatar">${avatarContent}</div>
          <div class="user-info">
            <h3 class="user-name">${user.name}</h3>
          </div>
          <input type="checkbox" class="friend-select" value="${uid}">
        `;
        friendList.appendChild(friendItem);
      });
      const bottomSheet = document.createElement('div');
      bottomSheet.className = 'bottom-sheet active';
      bottomSheet.innerHTML = `
        <div class="bottom-sheet-header">
          <h2>Select Viewers</h2>
          <button class="close-btn" onclick="this.closest('.bottom-sheet').remove()" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="bottom-sheet-content">${friendList.innerHTML}</div>
      `;
      document.body.appendChild(bottomSheet);
      return new Promise((resolve) => {
        bottomSheet.querySelector('.close-btn').addEventListener('click', () => {
          bottomSheet.remove();
          resolve(null);
        });
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'btn primary';
        confirmBtn.textContent = 'Confirm';
        confirmBtn.onclick = () => {
          const selected = Array.from(bottomSheet.querySelectorAll('.friend-select:checked')).map(input => input.value);
          bottomSheet.remove();
          resolve(selected);
        };
        bottomSheet.querySelector('.bottom-sheet-content').appendChild(confirmBtn);
      });
    }

    // Track online status
    async function setOnlineStatus(userId, isOnline) {
      try {
        await update(ref(db, `users/${userId}`), { isOnline });
      } catch (error) {
        console.error("Error setting online status:", error);
      }
    }

    // Listener management
    const listeners = [];
    function addListener(ref, callback) {
      onValue(ref, callback);
      listeners.push({ ref, callback });
    }
    function cleanupListeners() {
      listeners.forEach(({ ref, callback }) => off(ref, 'value', callback));
      listeners.length = 0;
    }

    // Listen for incoming calls
    function listenForIncomingCalls(userId) {
      const callRef = ref(db, `calls/${userId}`);
      addListener(callRef, (snapshot) => {
        if (snapshot.exists()) {
          const callData = snapshot.val();
          const latestCall = Object.entries(callData).pop();
          if (latestCall) {
            const [callId, call] = latestCall;
            if (call.status === 'ringing') {
              window.showCallModal(call.callerId, call.type || 'voice');
              setTimeout(() => {
                if (document.getElementById('call-modal').classList.contains('active')) {
                  window.hideCallModal();
                  update(ref(db, `calls/${userId}/${callId}`), { status: 'declined' });
                }
              }, 30000);
            }
          }
        }
      });
    }

    // Listen for friend status changes
    function listenForFriendStatus(userId) {
      const friendsRef = ref(db, `friends/${userId}`);
      addListener(friendsRef, async (snapshot) => {
        if (snapshot.exists()) {
          const friendIds = [...new Set(Object.keys(snapshot.val()))];
          friendIds.forEach(friendId => {
            const friendStatusRef = ref(db, `users/${friendId}/isOnline`);
            addListener(friendStatusRef, (statusSnapshot) => {
              const isOnline = statusSnapshot.val() || false;
              const friendData = friendsData.find(f => f.uid === friendId);
              if (friendData && friendData.isOnline !== isOnline) {
                friendData.isOnline = isOnline;
                if (isOnline && currentTab === 'chats') {
                  const usersRef = ref(db, `users/${friendId}`);
                  get(usersRef).then(userSnapshot => {
                    const user = userSnapshot.val() || { name: 'Unknown' };
                    window.showNotification(user.name, 'is now online');
                  });
                }
                if (currentTab === 'chats') {
                  renderChats(friendsData);
                }
              }
            });
          });
        }
      });
    }

    // Listen for typing status changes
    function listenForTypingStatus(userId, friendId, chatItem, chatPreview) {
      if (!settings.typingIndicator) return;
      const typingRef = ref(db, `users/${friendId}/isTyping`);
      addListener(typingRef, (snap) => {
        const isTyping = snap.exists() && snap.val();
        chatPreview.classList.toggle('typing', isTyping);
        if (isTyping) {
          chatPreview.textContent = 'Typing...';
        } else {
          const friendData = friendsData.find(f => f.uid === friendId);
          if (friendData && friendData.lastMessage) {
            if (friendData.messageType === 'image') {
              chatPreview.innerHTML = `<span class="media-icon image-icon" aria-hidden="true"></span> Photo`;
            } else if (friendData.messageType === 'video') {
              chatPreview.innerHTML = `<span class="media-icon video-icon" aria-hidden="true"></span> Video`;
            } else {
              chatPreview.textContent = decryptMessage(friendData.lastMessage);
            }
          } else {
            chatPreview.textContent = 'No messages yet';
          }
        }
      });
    }

    // Schedule message
    async function scheduleMessage(userId, friendId, message, type = 'text', scheduleTime) {
      try {
        const scheduledMessage = {
          content: encryptMessage(message),
          type,
          senderId: userId,
          timestamp: scheduleTime,
          scheduled: true
        };
        await push(ref(db, `scheduledMessages/${userId}_${friendId}`), scheduledMessage);
        window.showAlert(MESSAGES.SCHEDULE_MESSAGE_SUCCESS, true);
      } catch (error) {
        console.error("Error scheduling message:", error);
        window.showAlert(MESSAGES.SCHEDULE_MESSAGE_FAIL, false);
      }
    }

    // Auto-reply configuration
    async function saveAutoReply(userId, autoReplyText, enabled = false) {
      try {
        await update(ref(db, `users/${userId}/settings`), {
          autoReply: { text: autoReplyText, enabled }
        });
        window.showAlert(MESSAGES.AUTO_REPLY_SAVED, true);
      } catch (error) {
        console.error("Error saving auto-reply:", error);
        window.showAlert(MESSAGES.AUTO_REPLY_FAIL, false);
      }
    }

    // Render chats
    function renderChats(friends) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      if (friends.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No friends found.</p>';
        return;
      }
      const uniqueFriends = [...new Map(friends.map(item => [item.uid, item])).values()];
      uniqueFriends.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      const totalUnread = uniqueFriends.reduce((sum, friend) => sum + (friend.unreadCount || 0), 0);
      const chatsUnreadBadge = document.getElementById('chats-unread-count');
      if (chatsUnreadBadge) {
        chatsUnreadBadge.textContent = totalUnread;
        chatsUnreadBadge.style.display = totalUnread > 0 ? 'inline-flex' : 'none';
      }
      uniqueFriends.forEach(({ uid, name, avatar, lastMessage, messageType, timestamp, unreadCount, isOnline }) => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.setAttribute('role', 'button');
        chatItem.setAttribute('aria-label', `Chat with ${name || 'Unknown'}`);
        const firstLetter = name ? name.charAt(0).toUpperCase() : 'U';
        const avatarContent = avatar ? `<img src="${avatar}" alt="Avatar of ${name || 'Unknown'}" onerror="this.parentElement.textContent='${firstLetter}'" />` : firstLetter;
        const onlineDot = isOnline ? '<span class="online-dot" aria-label="Online"></span>' : '';
        let messagePreview = 'No messages yet';
        if (lastMessage) {
          if (messageType === 'image') {
            messagePreview = `<span class="media-icon image-icon" aria-hidden="true"></span> Photo`;
          } else if (messageType === 'video') {
            messagePreview = `<span class="media-icon video-icon" aria-hidden="true"></span> Video`;
          } else {
            messagePreview = decryptMessage(lastMessage);
          }
        }
        const unreadBadge = unreadCount > 0 ? ````html
<span class="unread-count">${unreadCount}</span>` : '';
        chatItem.innerHTML = `
          <div class="chat-avatar" role="img" aria-label="Avatar of ${name || 'Unknown'}">${avatarContent}${onlineDot}</div>
          <div class="chat-info">
            <h3 class="chat-name">${name || 'Unknown'}</h3>
            <p class="chat-preview">${messagePreview}</p>
          </div>
          <div class="chat-time">${timestamp ? formatTimestamp(timestamp) : ''}${unreadBadge}</div>
          <button class="delete-btn" onclick="window.removeFriend('${uid}')" aria-label="Remove friend ${name || 'Unknown'}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2L19 6"></path>
            </svg>
          </button>
        `;
        chatItem.onclick = (e) => {
          if (e.target.closest('.delete-btn')) return;
          window.location.href = `${ROUTES.MESSAGES}?friendId=${uid}`;
        };
        chatList.appendChild(chatItem);
        const chatPreview = chatItem.querySelector('.chat-preview');
        listenForTypingStatus(auth.currentUser?.uid, uid, chatItem, chatPreview);
      });
    }

    function renderStatuses(statuses, userProfile = { name: 'Unknown', avatar: null }) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      if (Object.keys(statuses).length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No statuses available.</p>';
        return;
      }
      const myStatusDiv = document.createElement('div');
      myStatusDiv.className = 'status-item';
      myStatusDiv.setAttribute('role', 'button');
      myStatusDiv.setAttribute('aria-label', 'View your status');
      const firstLetter = userProfile.name ? userProfile.name.charAt(0).toUpperCase() : 'U';
      const avatarContent = userProfile.avatar
        ? `<img src="${userProfile.avatar}" alt="Your avatar" onerror="this.parentElement.textContent='${firstLetter}'" />`
        : firstLetter;
      myStatusDiv.innerHTML = `
        <div class="status-preview" role="img" aria-label="Your status">${avatarContent}</div>
        <div class="status-info">
          <h3 class="status-name">My Status</h3>
          <p class="status-time">Tap to add status update</p>
        </div>
      `;
      myStatusDiv.onclick = () => statusUpload.click();
      chatList.appendChild(myStatusDiv);

      Object.entries(statuses).forEach(([uid, userStatuses]) => {
        if (uid === auth.currentUser?.uid) return;
        get(ref(db, `users/${uid}`)).then((snapshot) => {
          const user = snapshot.val() || { name: 'Unknown', avatar: null };
          const statusItem = document.createElement('div');
          statusItem.className = 'status-item';
          statusItem.setAttribute('role', 'button');
          statusItem.setAttribute('aria-label', `View ${user.name || 'Unknown'}'s status`);
          const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
          const avatarContent = user.avatar
            ? `<img src="${user.avatar}" alt="Avatar of ${user.name || 'Unknown'}" onerror="this.parentElement.textContent='${firstLetter}'" />`
            : firstLetter;
          const latestStatus = userStatuses.reduce((latest, status) =>
            (status.timestamp || 0) > (latest.timestamp || 0) ? status : latest, userStatuses[0]);
          statusItem.innerHTML = `
            <div class="status-preview" role="img" aria-label="Status preview">${avatarContent}</div>
            <div class="status-info">
              <h3 class="status-name">${user.name || 'Unknown'}</h3>
              <p class="status-time">${latestStatus.timestamp ? formatTimestamp(latestStatus.timestamp) : 'Unknown'}</p>
            </div>
            <button class="delete-btn" onclick="window.deleteStatus('${uid}', '${latestStatus.id}')" aria-label="Delete status" style="display: ${uid === auth.currentUser?.uid ? 'block' : 'none'}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2L19 6"></path>
              </svg>
            </button>
          `;
          statusItem.onclick = (e) => {
            if (e.target.closest('.delete-btn')) return;
            viewStatus(uid, userStatuses, user);
          };
          chatList.appendChild(statusItem);
        });
      });
    }

    function renderRooms(rooms, query = '') {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      const filteredRooms = Object.entries(rooms).filter(([_, room]) =>
        room.name.toLowerCase().includes(query.toLowerCase())
      );
      if (filteredRooms.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No rooms found.</p>';
        return;
      }
      filteredRooms.forEach(([roomId, room]) => {
        const roomItem = document.createElement('div');
        roomItem.className = 'room-item';
        roomItem.setAttribute('role', 'button');
        roomItem.setAttribute('aria-label', `Join room ${room.name}`);
        const firstLetter = room.name.charAt(0).toUpperCase();
        const avatarContent = room.avatar
          ? `<img src="${room.avatar}" alt="Room avatar" onerror="this.parentElement.textContent='${firstLetter}'" />`
          : firstLetter;
        let messagePreview = 'No messages yet';
        if (room.lastMessage) {
          if (room.messageType === 'image') {
            messagePreview = `<span class="media-icon image-icon" aria-hidden="true"></span> Photo`;
          } else if (room.messageType === 'video') {
            messagePreview = `<span class="media-icon video-icon" aria-hidden="true"></span> Video`;
          } else {
            messagePreview = decryptMessage(room.lastMessage);
          }
        }
        roomItem.innerHTML = `
          <div class="room-avatar" role="img" aria-label="Room avatar">${avatarContent}</div>
          <div class="room-info">
            <h3 class="room-name">${room.name}</h3>
            <p class="room-preview">${messagePreview}</p>
          </div>
          <div class="room-members">${room.members ? Object.keys(room.members).length : 0} members</div>
        `;
        roomItem.onclick = () => {
          window.location.href = `${ROUTES.ROOM}?roomId=${roomId}`;
        };
        chatList.appendChild(roomItem);
      });
    }

    function renderGroups(groups, query = '') {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      const filteredGroups = Object.entries(groups).filter(([_, group]) =>
        group.name.toLowerCase().includes(query.toLowerCase())
      );
      if (filteredGroups.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No groups found.</p>';
        return;
      }
      filteredGroups.forEach(([groupId, group]) => {
        const groupItem = document.createElement('div');
        groupItem.className = 'group-item';
        groupItem.setAttribute('role', 'button');
        groupItem.setAttribute('aria-label', `Join group ${group.name}`);
        const firstLetter = group.name.charAt(0).toUpperCase();
        const avatarContent = group.avatar
          ? `<img src="${group.avatar}" alt="Group avatar" onerror="this.parentElement.textContent='${firstLetter}'" />`
          : firstLetter;
        let messagePreview = 'No messages yet';
        if (group.lastMessage) {
          if (group.messageType === 'image') {
            messagePreview = `<span class="media-icon image-icon" aria-hidden="true"></span> Photo`;
          } else if (group.messageType === 'video') {
            messagePreview = `<span class="media-icon video-icon" aria-hidden="true"></span> Video`;
          } else {
            messagePreview = decryptMessage(group.lastMessage);
          }
        }
        groupItem.innerHTML = `
          <div class="group-avatar" role="img" aria-label="Group avatar">${avatarContent}</div>
          <div class="group-info">
            <h3 class="group-name">${group.name}</h3>
            <p class="group-preview">${messagePreview}</p>
          </div>
          <div class="group-members">${group.members ? Object.keys(group.members).length : 0} members</div>
        `;
        groupItem.onclick = () => {
          window.location.href = `${ROUTES.GROUP}?groupId=${groupId}`;
        };
        chatList.appendChild(groupItem);
      });
    }

    function renderSuggestedFriends(users) {
      userList.innerHTML = '';
      if (users.length === 0) {
        userList.innerHTML = '<p style="text-align: center; padding: 1rem;">No users found.</p>';
        return;
      }
      users.forEach(({ uid, name, avatar }) => {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.setAttribute('role', 'button');
        userItem.setAttribute('aria-label', `Add friend ${name || 'Unknown'}`);
        const firstLetter = name ? name.charAt(0).toUpperCase() : 'U';
        const avatarContent = avatar
          ? `<img src="${avatar}" alt="Avatar of ${name || 'Unknown'}" onerror="this.parentElement.textContent='${firstLetter}'" />`
          : firstLetter;
        userItem.innerHTML = `
          <div class="user-avatar" role="img" aria-label="User avatar">${avatarContent}</div>
          <div class="user-info">
            <h3 class="user-name">${name || 'Unknown'}</h3>
            <p class="user-status">${friendsData.some(f => f.uid === uid) ? 'Already a friend' : 'Add as friend'}</p>
          </div>
          <button class="add-btn" onclick="window.addFriend('${uid}', '${name || 'Unknown'}')" aria-label="Add ${name || 'Unknown'} as friend" ${friendsData.some(f => f.uid === uid) ? 'disabled' : ''}>
            Add
          </button>
        `;
        userList.appendChild(userItem);
      });
    }

    function viewStatus(uid, statuses, user) {
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      let currentIndex = 0;
      statusViewer.classList.add('active');
      const statusUser = document.createElement('div');
      statusUser.className = 'status-user';
      const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
      statusUser.innerHTML = `
        <img src="${user.avatar || ''}" alt="Avatar of ${user.name || 'Unknown'}" onerror="this.parentElement.innerHTML='<div>${firstLetter}</div>'" />
        <span>${user.name || 'Unknown'}</span>
      `;
      statusViewer.querySelector('.status-header').prepend(statusUser);
      const progressContainer = document.createElement('div');
      progressContainer.className = 'progress-bar-container';
      statuses.forEach((_, index) => {
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        progressBar.innerHTML = '<div class="progress"></div>';
        progressContainer.appendChild(progressBar);
      });
      statusViewer.querySelector('.status-header').after(progressContainer);
      const tapLeft = document.createElement('div');
      tapLeft.className = 'tap-area tap-area-left';
      tapLeft.onclick = () => {
        if (currentIndex > 0) {
          currentIndex--;
          displayStatus(statuses, currentIndex, uid, user);
        }
      };
      const tapRight = document.createElement('div');
      tapRight.className = 'tap-area tap-area-right';
      tapRight.onclick = () => {
        if (currentIndex < statuses.length - 1) {
          currentIndex++;
          displayStatus(statuses, currentIndex, uid, user);
        } else {
          window.closeStatusViewer();
        }
      };
      statusViewer.querySelector('.status-content').appendChild(tapLeft);
      statusViewer.querySelector('.status-content').appendChild(tapRight);
      const viewCount = document.createElement('div');
      viewCount.id = 'view-count';
      statusViewer.querySelector('.status-content').appendChild(viewCount);
      statusViewer.onmouseenter = () => { isPaused = true; };
      statusViewer.onmouseleave = () => { isPaused = false; };
      displayStatus(statuses, currentIndex, uid, user);
    }

    function displayStatus(statuses, index, uid, user) {
      const status = statuses[index];
      if (!status) return;
      statusImage.style.display = status.resource_type === 'image' ? 'block' : 'none';
      statusVideo.style.display = status.resource_type === 'video' ? 'block' : 'none';
      statusImage.src = status.resource_type === 'image' ? status.url : '';
      statusVideo.src = status.resource_type === 'video' ? status.url : '';
      statusCaption.textContent = status.caption || '';
      statusViewer.querySelector('#view-count').textContent = status.views ? Object.keys(status.views).length : 0;
      const progressBars = statusViewer.querySelectorAll('.progress');
      progressBars.forEach((bar, i) => {
        bar.style.width = i < index ? '100%' : '0%';
        bar.style.transitionDuration = i === index ? '5s' : '0s';
      });
      if (index === 0 && auth.currentUser && auth.currentUser.uid !== uid) {
        update(ref(db, `statuses/${uid}/${status.id}/views`), {
          [auth.currentUser.uid]: Date.now()
        });
      }
      clearInterval(statusTimer);
      if (!isPaused) {
        progressBars[index].style.width = '100%';
        statusTimer = setInterval(() => {
          if (!isPaused && index < statuses.length - 1) {
            index++;
            displayStatus(statuses, index, uid, user);
          } else {
            window.closeStatusViewer();
          }
        }, 5000);
      }
    }

    async function loadSuggestedFriends(userId) {
      if (!userId) return;
      try {
        showShimmer(userList);
        const friendsRef = ref(db, `friends/${userId}`);
        const friendsSnapshot = await get(friendsRef);
        const friends = friendsSnapshot.val() || {};
        const usersRef = ref(db, 'users');
        const usersSnapshot = await get(usersRef);
        const users = usersSnapshot.val() || {};
        suggestedFriends = Object.entries(users)
          .filter(([uid]) => uid !== userId && !friends[uid])
          .map(([uid, user]) => ({
            uid,
            name: user.name || 'Unknown',
            avatar: user.avatar || null
          }));
        renderSuggestedFriends(suggestedFriends);
      } catch (error) {
        console.error('Error loading suggested friends:', error);
        window.showAlert(MESSAGES.USER_FAIL, false);
      }
    }

    async function loadFriendsForGroup() {
      const friendList = document.getElementById('friend-list');
      friendList.innerHTML = '';
      try {
        showShimmer(friendList);
        const friendsRef = ref(db, `friends/${auth.currentUser.uid}`);
        const friendsSnapshot = await get(friendsRef);
        const friends = friendsSnapshot.val() || {};
        const usersRef = ref(db, 'users');
        const usersSnapshot = await get(usersRef);
        const users = usersSnapshot.val() || {};
        friendList.innerHTML = '';
        Object.keys(friends).forEach(uid => {
          const user = users[uid] || { name: 'Unknown', avatar: null };
          const friendItem = document.createElement('div');
          friendItem.className = 'friend-checkbox';
          const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
          const avatarContent = user.avatar
            ? `<img src="${user.avatar}" alt="Avatar" onerror="this.parentElement.textContent='${firstLetter}'" />`
            : firstLetter;
          friendItem.innerHTML = `
            <div class="user-avatar">${avatarContent}</div>
            <div class="user-info">
              <h3 class="user-name">${user.name}</h3>
            </div>
            <input type="checkbox" class="friend-select" value="${uid}">
          `;
          friendList.appendChild(friendItem);
        });
      } catch (error) {
        console.error('Error loading friends for group:', error);
        window.showAlert(MESSAGES.USER_FAIL, false);
      }
    }

    async function loadChats(userId) {
      if (!userId) return;
      try {
        showShimmer(chatList);
        const friendsRef = ref(db, `friends/${userId}`);
        addListener(friendsRef, async (snapshot) => {
          if (snapshot.exists()) {
            friendsData = [];
            const friendIds = [...new Set(Object.keys(snapshot.val()))];
            for (const friendId of friendIds) {
              const userRef = ref(db, `users/${friendId}`);
              const userSnapshot = await get(userRef);
              const user = userSnapshot.val() || { name: 'Unknown', avatar: null, isOnline: false };
              const chatRef = query(
                ref(db, `messages/${userId}_${friendId}`),
                orderByChild('timestamp'),
                limitToLast(1)
              );
              const chatSnapshot = await get(chatRef);
              let lastMessage = null;
              let messageType = 'text';
              let timestamp = null;
              let unreadCount = 0;
              if (chatSnapshot.exists()) {
                const messages = chatSnapshot.val();
                const lastMessageKey = Object.keys(messages).pop();
                lastMessage = messages[lastMessageKey].content;
                messageType = messages[lastMessageKey].type || 'text';
                timestamp = messages[lastMessageKey].timestamp;
                unreadCount = Object.values(messages).filter(
                  msg => msg.senderId !== userId && !msg.read
                ).length;
              }
              friendsData.push({
                uid: friendId,
                name: user.name,
                avatar: user.avatar,
                lastMessage,
                messageType,
                timestamp,
                unreadCount,
                isOnline: user.isOnline || false
              });
            }
            if (currentTab === 'chats') {
              renderChats(friendsData);
            }
          } else {
            chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No friends yet. Add some friends to start chatting!</p>';
          }
        });
        listenForFriendStatus(userId);
      } catch (error) {
        console.error('Error loading chats:', error);
        chatList.setAttribute('aria-busy', 'false');
        window.showAlert(MESSAGES.CHAT_FAIL, false);
      }
    }

    async function loadStatuses(userId, userProfile) {
      if (!userId) return;
      try {
        showShimmer(chatList);
        const now = Date.now();
        const twentyFourHoursAgo = now - 24 * 60 * 60 * 1000;
        const friendsRef = ref(db, `friends/${userId}`);
        const friendsSnapshot = await get(friendsRef);
        const friends = friendsSnapshot.val() || {};
        const statusPromises = [userId, ...Object.keys(friends)].map(async (uid) => {
          const statusRef = ref(db, `statuses/${uid}`);
          const statusSnapshot = await get(statusRef);
          if (statusSnapshot.exists()) {
            const statuses = Object.entries(statusSnapshot.val())
              .map(([id, status]) => ({ id, ...status }))
              .filter(status => status.timestamp > twentyFourHoursAgo);
            if (statuses.length > 0) {
              statusesData[uid] = statuses;
            }
          }
        });
        await Promise.all(statusPromises);
        if (currentTab === 'status') {
          renderStatuses(statusesData, userProfile);
        }
      } catch (error) {
        console.error('Error loading statuses:', error);
        chatList.setAttribute('aria-busy', 'false');
        window.showAlert(MESSAGES.STATUS_FAIL, false);
      }
    }

    async function loadRooms(userId) {
      if (!userId) return;
      try {
        showShimmer(chatList);
        const roomsRef = ref(db, 'chatrooms');
        addListener(roomsRef, (snapshot) => {
          if (snapshot.exists()) {
            const rooms = snapshot.val();
            if (currentTab === 'rooms') {
              renderRooms(rooms);
            }
          } else {
            chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No rooms available. Create one!</p>';
          }
        });
      } catch (error) {
        console.error('Error loading rooms:', error);
        chatList.setAttribute('aria-busy', 'false');
        window.showAlert('Failed to load rooms.', false);
      }
    }

    async function loadGroups(userId) {
      if (!userId) return;
      try {
        showShimmer(chatList);
        const groupsRef = ref(db, 'groups');
        addListener(groupsRef, (snapshot) => {
          if (snapshot.exists()) {
            const groups = snapshot.val();
            if (currentTab === 'groups') {
              renderGroups(groups);
            }
          } else {
            chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No groups available. Create one!</p>';
          }
        });
      } catch (error) {
        console.error('Error loading groups:', error);
        chatList.setAttribute('aria-busy', 'false');
        window.showAlert('Failed to load groups.', false);
      }
    }

    window.addFriend = async function (friendId, friendName) {
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      try {
        await set(ref(db, `friends/${auth.currentUser.uid}/${friendId}`), {
          addedAt: Date.now()
        });
        await set(ref(db, `friends/${friendId}/${auth.currentUser.uid}`), {
          addedAt: Date.now()
        });
        window.showAlert(MESSAGES.ADD_FRIEND_SUCCESS.replace('{name}', friendName), true);
        loadSuggestedFriends(auth.currentUser.uid);
        loadChats(auth.currentUser.uid);
      } catch (error) {
        console.error('Error adding friend:', error);
        window.showAlert(MESSAGES.ADD_FRIEND_FAIL, false);
      }
    };

    window.removeFriend = async function (friendId) {
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      const confirm = await window.showAlert(
        `Are you sure you want to remove this friend?`,
        false,
        false,
        () => true,
        () => false
      );
      if (!confirm) return;
      try {
        await remove(ref(db, `friends/${auth.currentUser.uid}/${friendId}`));
        await remove(ref(db, `friends/${friendId}/${auth.currentUser.uid}`));
        friendsData = friendsData.filter(f => f.uid !== friendId);
        if (currentTab === 'chats') {
          renderChats(friendsData);
        }
        window.showAlert('Friend removed successfully!', true);
      } catch (error) {
        console.error('Error removing friend:', error);
        window.showAlert('Failed to remove friend.', false);
      }
    };

    window.deleteStatus = async function (uid, statusId) {
      if (!auth.currentUser || uid !== auth.currentUser.uid) {
        window.showAlert('Unauthorized action.', false);
        return;
      }
      const confirm = await window.showAlert(
        'Are you sure you want to delete this status?',
        false,
        false,
        () => true,
        () => false
      );
      if (!confirm) return;
      try {
        await remove(ref(db, `statuses/${uid}/${statusId}`));
        delete statusesData[uid];
        if (currentTab === 'status') {
          renderStatuses(statusesData, { name: userName.textContent, avatar: userAvatar.innerHTML });
        }
        window.showAlert(MESSAGES.STATUS_DELETE_SUCCESS, true);
      } catch (error) {
        console.error('Error deleting status:', error);
        window.showAlert(MESSAGES.STATUS_DELETE_FAIL, false);
      }
    };

    async function createRoom() {
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      const roomName = document.getElementById('room-name-input').value.trim();
      const roomType = document.getElementById('room-type').value;
      const roomDescription = document.getElementById('room-description').value.trim();
      if (!roomName) {
        window.showAlert(MESSAGES.ROOM_NAME_REQUIRED, false);
        return;
      }
      try {
        const roomRef = push(ref(db, 'chatrooms'));
        await set(roomRef, {
          name: roomName,
          type: roomType,
          description: roomDescription,
          createdBy: auth.currentUser.uid,
          createdAt: Date.now(),
          members: { [auth.currentUser.uid]: true }
        });
        window.showAlert(MESSAGES.ROOM_CREATE_SUCCESS, true);
        window.hideRoomSheet();
        if (currentTab === 'rooms') {
          loadRooms(auth.currentUser.uid);
        }
      } catch (error) {
        console.error('Error creating room:', error);
        window.showAlert(MESSAGES.ROOM_CREATE_FAIL, false);
      }
    }

    async function createGroup() {
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      const groupName = document.getElementById('group-name-input').value.trim();
      const selectedFriends = Array.from(document.querySelectorAll('.friend-select:checked')).map(input => input.value);
      if (!groupName) {
        window.showAlert(MESSAGES.GROUP_NAME_REQUIRED, false);
        return;
      }
      if (selectedFriends.length === 0) {
        window.showAlert(MESSAGES.GROUP_MIN_MEMBERS, false);
        return;
      }
      try {
        const groupRef = push(ref(db, 'groups'));
        const members = { [auth.currentUser.uid]: true };
        selectedFriends.forEach(uid => { members[uid] = true; });
        await set(groupRef, {
          name: groupName,
          createdBy: auth.currentUser.uid,
          createdAt: Date.now(),
          members,
          admins: { [auth.currentUser.uid]: true }
        });
        window.showAlert(MESSAGES.GROUP_CREATE_SUCCESS, true);
        window.hideGroupSheet();
        if (currentTab === 'groups') {
          loadGroups(auth.currentUser.uid);
        }
      } catch (error) {
        console.error('Error creating group:', error);
        window.showAlert(MESSAGES.GROUP_CREATE_FAIL, false);
      }
    }

    // WebRTC call handling
    async function initiateCall(friendId, type = 'voice') {
      if (!auth.currentUser) {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        return;
      }
      try {
        const callRef = push(ref(db, `calls/${friendId}`));
        await set(callRef, {
          callerId: auth.currentUser.uid,
          type,
          status: 'ringing',
          timestamp: Date.now()
        });
        window.showCallModal(auth.currentUser.uid, type);
        const peerConnection = new RTCPeerConnection(webrtcConfig);
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            update(ref(db, `calls/${friendId}/${callRef.key}/iceCandidates`), {
              [Date.now()]: event.candidate
            });
          }
        };
        if (type === 'video') {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        } else {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        }
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        await update(ref(db, `calls/${friendId}/${callRef.key}`), { offer });
        // Handle call acceptance/decline
        const callStatusRef = ref(db, `calls/${friendId}/${callRef.key}/status`);
        addListener(callStatusRef, (snapshot) => {
          if (snapshot.exists() && snapshot.val() === 'accepted') {
            // Proceed with call
            console.log('Call accepted');
          } else if (snapshot.exists() && snapshot.val() === 'declined') {
            window.hideCallModal();
            peerConnection.close();
          }
        });
      } catch (error) {
        console.error('Error initiating call:', error);
        window.showAlert('Failed to initiate call.', false);
      }
    }

    // Initialize app
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const userRef = ref(db, `users/${user.uid}`);
          const snapshot = await get(userRef);
          if (snapshot.exists()) {
            const userData = snapshot.val();
            userName.textContent = userData.name || 'User';
            const firstLetter = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
            userAvatar.innerHTML = userData.avatar
              ? `<img src="${userData.avatar}" alt="Your avatar" onerror="this.parentElement.textContent='${firstLetter}'" />`
              : firstLetter;
            settings = userData.settings || settings;
            document.body.setAttribute('data-theme', settings.theme || 'light');
            loadChats(user.uid);
            loadStatuses(user.uid, { name: userData.name, avatar: userData.avatar });
            loadRooms(user.uid);
            loadGroups(user.uid);
            listenForIncomingCalls(user.uid);
            setOnlineStatus(user.uid, true);
            window.addEventListener('beforeunload', () => setOnlineStatus(user.uid, false));
          } else {
            window.showAlert(MESSAGES.PROFILE_FAIL, false);
            firebase.auth().signOut();
          }
        } catch (error) {
          console.error('Error loading user profile:', error);
          window.showAlert(MESSAGES.PROFILE_FAIL, false);
          firebase.auth().signOut();
        }
      } else {
        cleanupListeners();
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        window.location.href = 'login.html';
      }
    });

    // Tab switching
    tabItems.forEach(tab => {
      tab.addEventListener('click', () => {
        if (!auth.currentUser) {
          window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
          return;
        }
        tabItems.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        currentTab = tab.getAttribute('data-tab');
        fab.style.display = 'block';
        if (currentTab === 'chats') {
          fab.textContent = 'Add Friend';
          fab.onclick = window.showBottomSheet;
          renderChats(friendsData);
        } else if (currentTab === 'status') {
          fab.textContent = 'Add Status';
          fab.onclick = () => statusUpload.click();
          renderStatuses(statusesData, { name: userName.textContent, avatar: userAvatar.innerHTML });
        } else if (currentTab === 'rooms') {
          fab.textContent = 'Create Room';
          fab.onclick = window.showRoomSheet;
          loadRooms(auth.currentUser?.uid);
        } else if (currentTab === 'groups') {
          fab.textContent = 'Create Group';
          fab.onclick = window.showGroupSheet;
          loadGroups(auth.currentUser?.uid);
        }
        window.filterContent(document.getElementById('search-input').value);
      });
    });

    // Status upload handler
    statusUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file && auth.currentUser) {
        uploadStatus(file, auth.currentUser.uid, { name: userName.textContent });
      }
    });

    // Create room handler
    document.getElementById('create-room-btn').addEventListener('click', createRoom);

    // Create group handler
    document.getElementById('create-group-btn').addEventListener('click', createGroup);

    // Call handling
    document.getElementById('accept-call-btn').addEventListener('click', async () => {
      const callRef = ref(db, `calls/${auth.currentUser.uid}`);
      const callSnapshot = await get(callRef);
      if (callSnapshot.exists()) {
        const callData = callSnapshot.val();
        const latestCall = Object.entries(callData).pop();
        if (latestCall) {
          const [callId] = latestCall;
          await update(ref(db, `calls/${auth.currentUser.uid}/${callId}`), { status: 'accepted' });
          window.hideCallModal();
          // Proceed with WebRTC connection
          console.log('Call accepted');
        }
      }
    });

    document.getElementById('decline-call-btn').addEventListener('click', async () => {
      const callRef = ref(db, `calls/${auth.currentUser.uid}`);
      const callSnapshot = await get(callRef);
      if (callSnapshot.exists()) {
        const callData = callSnapshot.val();
        const latestCall = Object.entries(callData).pop();
        if (latestCall) {
          const [callId] = latestCall;
          await update(ref(db, `calls/${auth.currentUser.uid}/${callId}`), { status: 'declined' });
          window.hideCallModal();
        }
      }
    });

    // Load theme from localStorage
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
  </script>
</body>
</html>
