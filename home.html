<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ConnectSphere</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
      --status-bar: #D9D9D9;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --fab-bg: var(--accent);
      --fab-text: #FFFFFF;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .header {
      background: var(--chat-bg);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }

    .header-search {
      flex: 1;
      background: var(--background);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      margin-right: 1rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
    }

    #search-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: var(--fab-text);
      overflow: hidden;
      cursor: pointer;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .menu-icon {
      cursor: pointer;
      color: var(--text-secondary);
      transition: color 0.2s ease;
    }

    .menu-icon:hover {
      color: var(--accent);
    }

    .menu-dropdown {
      position: absolute;
      top: 3.5rem;
      right: 1rem;
      background: var(--background);
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: none;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
    }

    .menu-dropdown.active {
      display: flex;
    }

    .menu-item {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-primary);
      transition: background 0.2s ease;
    }

    .menu-item:hover {
      background: var(--chat-bg);
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      scroll-behavior: smooth;
    }

    .chat-list[aria-busy='true']::before {
      content: '';
      display: block;
      height: 10rem;
      background: linear-gradient(180deg, var(--chat-bg), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    .status-scroll {
      display: flex;
      overflow-x: auto;
      padding: 0.5rem;
      gap: 0.5rem;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .status-scroll::-webkit-scrollbar {
      display: none;
    }

    .status-item {
      flex: 0 0 auto;
      width: 100px;
      background: var(--chat-bg);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      scroll-snap-align: start;
      box-shadow: var(--shadow);
      border: 2px solid var(--accent);
    }

    .status-item.viewed {
      opacity: 0.7;
      border: 2px solid var(--status-bar);
    }

    .status-item:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .status-preview {
      width: 100%;
      height: 70%;
      object-fit: cover;
      display: block;
    }

    .status-preview-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 70%;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3), transparent);
      pointer-events: none;
    }

    .status-info {
      padding: 0.5rem;
      text-align: center;
    }

    .status-name {
      font-size: 0.85rem;
      font-weight: 500;
      margin: 0;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .status-time {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 0.2rem;
    }

    .status-item .delete-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      padding: 0.3rem;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .status-item .delete-btn svg {
      width: 14px;
      height: 14px;
      stroke: #FFFFFF;
    }

    .chat-item,
    .room-item,
    .group-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      background: var(--background);
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .chat-item:hover,
    .room-item:hover,
    .group-item:hover {
      transform: translateY(-2px);
      background: var(--chat-bg);
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .chat-message {
      font-size: 0.85rem;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .bottom-sheet {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      background: var(--background);
      border-radius: 16px 16px 0 0;
      box-shadow: var(--shadow);
      max-height: 80vh;
      transition: bottom 0.3s ease;
      z-index: 1000;
    }

    .bottom-sheet.active {
      bottom: 0;
    }

    .bottom-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .bottom-sheet-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .bottom-sheet-content {
      padding: 1rem;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-group button {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent);
      color: var(--fab-text);
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .form-group button:hover {
      background: color-mix(in srgb, var(--accent) 80%, #000);
    }

    .fab {
      position: fixed;
      bottom: 4.5rem; /* Above bottom nav */
      right: 1rem;
      background: var(--fab-bg);
      color: var(--fab-text);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: var(--shadow);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 1000;
    }

    .fab:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .fab svg {
      width: 20px;
      height: 20px;
    }

    .bottom-nav {
      display: flex;
      justify-content: space-around;
      background: var(--chat-bg);
      padding: 0.75rem 0;
      position: sticky;
      bottom: 0;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .nav-item.active {
      color: var(--accent);
    }

    .nav-item.active svg {
      stroke: var(--accent);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .alert {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--background);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 1000;
      max-width: 90%;
      text-align: center;
    }

    .alert.active {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    @media (max-width: 768px) {
      .status-scroll {
        padding: 0.4rem;
        gap: 0.4rem;
      }
      .status-item {
        width: 80px;
        border-radius: 12px;
      }
      .status-preview {
        height: 65%;
      }
    }

    @media (max-width: 480px) {
      .status-scroll {
        padding: 0.3rem;
        gap: 0.3rem;
      }
      .status-item {
        width: 70px;
        border-radius: 10px;
      }
      .status-preview {
        height: 60%;
      }
      .status-name {
        font-size: 0.8rem;
      }
      .status-time {
        font-size: 0.65rem;
      }
      .header-search {
        margin-right: 0.5rem;
      }
      .fab {
        bottom: 4rem;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
      .fab svg {
        width: 18px;
        height: 18px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-search">
      <input type="text" id="search-input" placeholder="Search chats, statuses..." aria-label="Search" />
    </div>
    <div class="header-actions">
      <div class="avatar" onclick="window.location.href='profile.html'" aria-label="Go to profile"></div>
      <div class="menu-icon" onclick="window.toggleMenu()" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </div>
    </div>
  </header>

  <div class="menu-dropdown" id="menu-dropdown">
    <div class="menu-item" onclick="window.location.href='profile.html'">Profile</div>
    <div class="menu-item" onclick="window.location.href='discover.html'">Business Channels</div>
    <div class="menu-item" onclick="window.location.href='settings.html'">Settings</div>
    <div class="menu-item" onclick="firebase.auth().signOut()">Sign Out</div>
  </div>

  <main class="chat-list" id="chat-list" role="region" aria-live="polite"></main>

  <div class="fab" id="fab" aria-label="Floating action button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    <span>Add Friend</span>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats" aria-label="Chats">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 11.5a8.38 8.38 0 0 1-8.5 8m8.5-8a8.38 8.38 0 0 0-8.5-8m8.5 8H3m5.5 8a8.38 8.38 0 0 1-8-8.5m8 8.5c1.66 0 3.22-.55 4.5-1.5m-4.5-17c-1.28.95-2.83 1.5-4.5 1.5m8 1.5a8.38 8.38 0 0 1 8 8.5"></path>
      </svg>
      Chats
    </div>
    <div class="nav-item" data-tab="status" aria-label="Status">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v.01M12 8v4"></path>
      </svg>
      Status
    </div>
    <div class="nav-item" data-tab="rooms" aria-label="Rooms">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <path d="M3 9h18M9 21V9"></path>
      </svg>
      Rooms
    </div>
    <div class="nav-item" data-tab="groups" aria-label="Groups">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path>
      </svg>
      Groups
    </div>
  </nav>

  <div id="bottom-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Add Friend</h2>
      <button class="close-btn" onclick="window.hideBottomSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="form-group">
        <label for="friend-id">Friend's User ID</label>
        <input type="text" id="friend-id" placeholder="Enter friend's user ID" required />
        <button onclick="window.addFriend()">Add Friend</button>
      </div>
    </div>
  </div>

  <div id="create-room-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Room</h2>
      <button class="close-btn" onclick="window.hideRoomSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="form-group">
        <label for="room-name">Room Name</label>
        <input type="text" id="room-name" placeholder="Enter room name" required />
        <button onclick="window.createRoom()">Create Room</button>
      </div>
    </div>
  </div>

  <div id="create-group-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Group</h2>
      <button class="close-btn" onclick="window.hideGroupSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="form-group">
        <label for="group-name">Group Name</label>
        <input type="text" id="group-name" placeholder="Enter group name" required />
        <label for="group-members">Select Members</label>
        <select id="group-members" multiple></select>
        <button onclick="window.createGroup()">Create Group</button>
      </div>
    </div>
  </div>

  <div id="status-upload-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Upload Status</h2>
      <button class="close-btn" onclick="window.hideStatusSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="form-group">
        <label for="status-file">Choose Image or Video</label>
        <input type="file" id="status-file" accept="image/*,video/*" required />
        <label for="status-caption">Caption</label>
        <input type="text" id="status-caption" placeholder="Add a caption" />
        <button onclick="window.uploadStatus()">Upload Status</button>
      </div>
    </div>
  </div>

  <div class="alert" id="alert"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, remove, onValue, off } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const CLOUDINARY_URL = "cloudinary://<your-cloud-name>";
    const ENCRYPTION_KEY = "your-encryption-key";

    const themes = [
      {
        id: "light",
        name: "Light",
        properties: {
          "--background": "#FFFFFF",
          "--chat-bg": "#F5F7FB",
          "--text-primary": "#111B21",
          "--text-secondary": "#667781",
          "--border": "#E9ECEF",
          "--accent": "#00A884",
          "--status-bar": "#D9D9D9",
          "--fab-bg": "#00A884",
          "--fab-text": "#FFFFFF"
        }
      },
      {
        id: "dark",
        name: "Dark",
        properties: {
          "--background": "#1A202C",
          "--chat-bg": "#2D3748",
          "--text-primary": "#E2E8F0",
          "--text-secondary": "#A0AEC0",
          "--border": "#4A5568",
          "--accent": "#38B2AC",
          "--status-bar": "#718096",
          "--fab-bg": "#38B2AC",
          "--fab-text": "#FFFFFF"
        }
      },
      {
        id: "ocean",
        name: "Ocean",
        properties: {
          "--background": "#E6F3FA",
          "--chat-bg": "#B3E5FC",
          "--text-primary": "#1A3C5E",
          "--text-secondary": "#4A739B",
          "--border": "#90CDF4",
          "--accent": "#2B6CB0",
          "--status-bar": "#A3BFFA",
          "--fab-bg": "#2B6CB0",
          "--fab-text": "#FFFFFF"
        }
      },
      {
        id: "sunset",
        name: "Sunset",
        properties: {
          "--background": "#FFF5F5",
          "--chat-bg": "#FEE2E2",
          "--text-primary": "#742A2A",
          "--text-secondary": "#B7791F",
          "--border": "#FED7D7",
          "--accent": "#F56565",
          "--status-bar": "#FBB6CE",
          "--fab-bg": "#F56565",
          "--fab-text": "#FFFFFF"
        }
      }
    ];

    const userAvatar = document.querySelector('.header-actions .avatar');
    const searchInput = document.getElementById('search-input');
    const menuDropdown = document.getElementById('menu-dropdown');
    const chatList = document.getElementById('chat-list');
    const fab = document.getElementById('fab');
    const bottomSheet = document.getElementById('bottom-sheet');
    const createRoomSheet = document.getElementById('create-room-sheet');
    const createGroupSheet = document.getElementById('create-group-sheet');
    const statusUploadSheet = document.getElementById('status-upload-sheet');
    const alertBox = document.getElementById('alert');
    const tabItems = document.querySelectorAll('.nav-item');
    let currentTab = 'chats';
    let listeners = [];
    let statusesData = {};

    const MESSAGES = {
      SIGN_IN_REQUIRED: "Please sign in to perform this action.",
      PROFILE_FAIL: "Failed to load profile. Please try again.",
      USER_FAIL: "Failed to load users. Please try again.",
      STATUS_FAIL: "Failed to load statuses. Please try again.",
      STATUS_UPLOAD_SUCCESS: "Status uploaded successfully!",
      STATUS_UPLOAD_FAIL: "Failed to upload status. Please try again.",
      STATUS_DELETE_SUCCESS: "Status deleted successfully!",
      STATUS_DELETE_FAIL: "Failed to delete status. Please try again.",
      FRIEND_REQUEST_SENT: "Friend request sent successfully!",
      FRIEND_REQUEST_FAIL: "Failed to send friend request. Please try again.",
      ROOM_CREATE_SUCCESS: "Room created successfully!",
      ROOM_CREATE_FAIL: "Failed to create room. Please try again.",
      GROUP_CREATE_SUCCESS: "Group created successfully!",
      GROUP_CREATE_FAIL: "Failed to create group. Please try again."
    };

    function showShimmer(element) {
      element.setAttribute('aria-busy', 'true');
      element.innerHTML = '';
    }

    function cleanupListeners() {
      listeners.forEach(({ ref, callback }) => {
        off(ref, 'value', callback);
      });
      listeners = [];
    }

    function addListener(ref, callback, errorCallback) {
      const wrappedCallback = (snapshot) => {
        try {
          callback(snapshot);
        } catch (error) {
          console.error("Listener error:", error);
          if (errorCallback) errorCallback(error);
        }
      };
      onValue(ref, wrappedCallback);
      listeners.push({ ref, callback: wrappedCallback });
    }

    window.toggleMenu = function () {
      menuDropdown.classList.toggle('active');
    };

    window.showBottomSheet = function () {
      bottomSheet.classList.add('active');
    };

    window.hideBottomSheet = function () {
      bottomSheet.classList.remove('active');
      document.getElementById('friend-id').value = '';
    };

    window.showRoomSheet = function () {
      createRoomSheet.classList.add('active');
    };

    window.hideRoomSheet = function () {
      createRoomSheet.classList.remove('active');
      document.getElementById('room-name').value = '';
    };

    window.showGroupSheet = function () {
      createGroupSheet.classList.add('active');
      loadGroupMembers();
    };

    window.hideGroupSheet = function () {
      createGroupSheet.classList.remove('active');
      document.getElementById('group-name').value = '';
      document.getElementById('group-members').innerHTML = '';
    };

    window.showStatusSheet = function () {
      statusUploadSheet.classList.add('active');
    };

    window.hideStatusSheet = function () {
      statusUploadSheet.classList.remove('active');
      document.getElementById('status-file').value = '';
      document.getElementById('status-caption').value = '';
    };

    window.showAlert = async function (message, isSuccess = false, showCancel = false, onConfirm = () => {}, onCancel = () => {}) {
      alertBox.textContent = message;
      alertBox.style.background = isSuccess ? 'var(--accent)' : '#FF6B6B';
      alertBox.style.color = isSuccess ? 'var(--fab-text)' : '#FFFFFF';
      alertBox.classList.add('active');
      if (showCancel) {
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'Confirm';
        confirmBtn.style.marginLeft = '1rem';
        confirmBtn.onclick = () => {
          alertBox.classList.remove('active');
          confirmBtn.remove();
          cancelBtn.remove();
          onConfirm();
        };
        alertBox.appendChild(confirmBtn);
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.marginLeft = '0.5rem';
        cancelBtn.onclick = () => {
          alertBox.classList.remove('active');
          confirmBtn.remove();
          cancelBtn.remove();
          onCancel();
        };
        alertBox.appendChild(cancelBtn);
        return new Promise(resolve => {
          confirmBtn.onclick = () => {
            alertBox.classList.remove('active');
            confirmBtn.remove();
            cancelBtn.remove();
            resolve(true);
            onConfirm();
          };
          cancelBtn.onclick = () => {
            alertBox.classList.remove('active');
            confirmBtn.remove();
            cancelBtn.remove();
            resolve(false);
            onCancel();
          };
        });
      } else {
        setTimeout(() => alertBox.classList.remove('active'), 3000);
      }
    };

    async function applyUserTheme(userId) {
      try {
        const userRef = ref(db, `users/${userId}`);
        addListener(userRef, (snapshot) => {
          if (snapshot.exists()) {
            const user = snapshot.val();
            const themeId = user.theme || "light";
            const selectedTheme = themes.find(theme => theme.id === themeId) || themes[0];
            Object.entries(selectedTheme.properties).forEach(([key, value]) => {
              document.documentElement.style.setProperty(key, value);
            });
          }
        }, (error) => {
          console.error("Error listening to user theme:", error);
        });
      } catch (error) {
        console.error("Error applying theme:", error);
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      if (diff < 60 * 1000) return 'Just now';
      if (diff < 60 * 60 * 1000) return `${Math.floor(diff / (60 * 1000))}m ago`;
      if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / (60 * 60 * 1000))}h ago`;
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    async function setOnlineStatus(userId, isOnline) {
      try {
        await update(ref(db, `users/${userId}`), { online: isOnline });
      } catch (error) {
        console.error("Error updating online status:", error);
      }
    }

    async function loadChats(userId) {
      showShimmer(chatList);
      const friendsRef = ref(db, `users/${userId}/friends`);
      addListener(friendsRef, async (snapshot) => {
        const friends = snapshot.val() || {};
        const usersRef = ref(db, 'users');
        const usersSnapshot = await get(usersRef);
        const users = usersSnapshot.val() || {};
        const chats = [];
        for (const friendId in friends) {
          if (users[friendId]) {
            const lastMessageRef = ref(db, `messages/${userId}_${friendId}`);
            const lastMessageSnapshot = await get(lastMessageRef);
            const lastMessage = lastMessageSnapshot.val() ? Object.values(lastMessageSnapshot.val()).pop() : null;
            chats.push({
              id: friendId,
              name: users[friendId].name || 'Unknown',
              avatar: users[friendId].avatar,
              lastMessage: lastMessage ? lastMessage.text : 'No messages yet',
              timestamp: lastMessage ? lastMessage.timestamp : 0
            });
          }
        }
        chats.sort((a, b) => b.timestamp - a.timestamp);
        renderChats(chats, userId, users);
      }, (error) => {
        console.error("Error loading chats:", error);
        window.showAlert(MESSAGES.USER_FAIL, false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load chats.</p>';
      });
    }

    async function renderChats(chats, userId, users) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      
      // Add horizontal status scroll for Chats tab
      if (currentTab === 'chats') {
        const statusScroll = document.createElement('div');
        statusScroll.className = 'status-scroll';
        const statusesRef = ref(db, 'statuses');
        try {
          const snapshot = await get(statusesRef);
          statusesData = snapshot.val() || {};
          const now = Date.now();
          const processedStatuses = {};
          for (const uid in statusesData) {
            processedStatuses[uid] = Object.entries(statusesData[uid])
              .map(([statusId, status]) => ({
                statusId,
                ...status
              }))
              .filter(status => now - status.timestamp < 24 * 60 * 60 * 1000)
              .sort((a, b) => b.timestamp - a.timestamp);
          }

          // Add user's own status first
          if (processedStatuses[userId]?.length > 0) {
            processedStatuses[userId].forEach((status, index) => {
              const statusItem = document.createElement('div');
              statusItem.className = `status-item ${status.views?.[userId] ? 'viewed' : ''}`;
              statusItem.setAttribute('role', 'button');
              statusItem.setAttribute('aria-label', `View your status ${status.caption || `Status #${index + 1}`}`);
              const thumbnail = status.resource_type === 'image'
                ? `${CLOUDINARY_URL}/${status.url}?q_auto,f_auto,w_120,h_120,c_fill`
                : `${CLOUDINARY_URL}/${status.url.replace(/\.mp4$/, '.jpg')}?w_120,h_120,c_fill,q_auto,f_auto#t_0.1`;
              statusItem.innerHTML = `
                <img src="${thumbnail}" class="status-preview" alt="Your Status Preview" onerror="this.src='https://via.placeholder.com/120'" />
                <div class="status-preview-overlay"></div>
                <div class="status-info">
                  <h3 class="status-name">${status.caption || `My Status #${index + 1}`}</h3>
                  <p class="status-time">${formatTimestamp(status.timestamp)}</p>
                </div>
                <button class="delete-btn" data-status-id="${status.statusId}" aria-label="Delete status">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m-10 4v10a2 2 0 002 2h6a2 2 0 002-2V10m-9 0v10m4-10v10m-4-10h8" />
                  </svg>
                </button>
              `;
              statusItem.onclick = (e) => {
                if (!e.target.closest('.delete-btn')) {
                  viewStatus(userId, processedStatuses[userId], { name: users[userId]?.name || 'You' });
                }
              };
              statusItem.querySelector('.delete-btn').onclick = async (e) => {
                e.stopPropagation();
                const confirmed = await window.showAlert(
                  "Are you sure you want to delete this status?",
                  false,
                  true,
                  () => {},
                  () => {}
                );
                if (confirmed) {
                  try {
                    await remove(ref(db, `statuses/${userId}/${status.statusId}`));
                    window.showAlert(MESSAGES.STATUS_DELETE_SUCCESS, true);
                  } catch (error) {
                    console.error("Error deleting status:", error);
                    window.showAlert(MESSAGES.STATUS_DELETE_FAIL, false);
                  }
                }
              };
              statusScroll.appendChild(statusItem);
            });
          }

          // Add friends' statuses
          Object.entries(processedStatuses)
            .filter(([uid]) => uid !== userId && processedStatuses[uid]?.length > 0)
            .forEach(([uid, userStatuses]) => {
              const user = users[uid] || { name: 'Unknown', avatar: null };
              const statusCount = userStatuses.length;
              const latestStatus = userStatuses[0];
              const thumbnail = latestStatus.resource_type === 'image'
                ? `${CLOUDINARY_URL}/${latestStatus.url}?q_auto,f_auto,w_120,h_120,c_fill`
                : `${CLOUDINARY_URL}/${latestStatus.url.replace(/\.mp4$/, '.jpg')}?w_120,h_120,c_fill,q_auto,f_auto#t_0.1`;
              const statusItem = document.createElement('div');
              statusItem.className = `status-item ${latestStatus.views?.[userId] ? 'viewed' : ''}`;
              statusItem.setAttribute('role', 'button');
              statusItem.setAttribute('aria-label', `View ${user.name}'s status`);
              statusItem.innerHTML = `
                <img src="${thumbnail}" class="status-preview" alt="${user.name}'s Status Preview" onerror="this.src='https://via.placeholder.com/120'" />
                <div class="status-preview-overlay"></div>
                <div class="status-info">
                  <h3 class="status-name">${user.name} (${statusCount})</h3>
                  <p class="status-time">${formatTimestamp(latestStatus.timestamp)}</p>
                </div>
              `;
              statusItem.onclick = () => viewStatus(uid, userStatuses, user);
              statusScroll.appendChild(statusItem);
            });

          if (statusScroll.children.length > 0) {
            chatList.appendChild(statusScroll);
          }
        } catch (error) {
          console.error("Error loading statuses for chats:", error);
        }
      }

      // Render chats
      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.setAttribute('role', 'button');
        chatItem.setAttribute('aria-label', `Chat with ${chat.name}`);
        chatItem.innerHTML = `
          <div class="avatar">${chat.avatar ? `<img src="${CLOUDINARY_URL}/${chat.avatar}?q_auto,f_auto,w_48,h_48,c_fill" alt="${chat.name}'s avatar" onerror="this.parentElement.textContent='${chat.name.charAt(0).toUpperCase()}'" />` : chat.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${chat.name}</h3>
            <p class="chat-message">${chat.lastMessage}</p>
          </div>
          <span class="chat-time">${formatTimestamp(chat.timestamp)}</span>
        `;
        chatItem.onclick = () => window.location.href = `chat.html?friendId=${chat.id}`;
        chatList.appendChild(chatItem);
      });

      if (chats.length === 0 && (!statusScroll || statusScroll.children.length === 0)) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No chats or statuses available.</p>';
      }
    }

    async function loadStatuses(userId, userProfile) {
      if (!userId) return;
      showShimmer(chatList);
      const statusesRef = ref(db, 'statuses');
      cleanupListeners();
      addListener(statusesRef, (snapshot) => {
        statusesData = snapshot.val() || {};
        if (currentTab === 'status') {
          renderStatuses(statusesData);
        }
      }, (error) => {
        console.error("Error loading statuses:", error);
        window.showAlert(MESSAGES.STATUS_FAIL, false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load statuses.</p>';
      });
    }

    async function renderStatuses(statuses) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      const statusSection = document.createElement('div');
      statusSection.className = 'status-section';

      const userId = auth.currentUser?.uid;
      if (!userId) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Please sign in to view statuses.</p>';
        return;
      }

      const now = Date.now();
      const processedStatuses = {};
      for (const uid in statuses) {
        processedStatuses[uid] = Object.entries(statuses[uid])
          .map(([statusId, status]) => ({
            statusId,
            ...status
          }))
          .filter(status => now - status.timestamp < 24 * 60 * 60 * 1000)
          .sort((a, b) => b.timestamp - a.timestamp);
      }

      const usersRef = ref(db, 'users');
      let users = {};
      try {
        const usersSnapshot = await get(usersRef);
        users = usersSnapshot.val() || {};
      } catch (error) {
        console.error("Error fetching users:", error);
        window.showAlert(MESSAGES.USER_FAIL, false);
        return;
      }

      if (processedStatuses[userId]?.length > 0) {
        processedStatuses[userId].forEach((status, index) => {
          const statusItem = document.createElement('div');
          statusItem.className = `status-item ${status.views?.[userId] ? 'viewed' : ''}`;
          statusItem.setAttribute('role', 'button');
          statusItem.setAttribute('aria-label', `View your status ${status.caption || `Status #${index + 1}`}`);
          const thumbnail = status.resource_type === 'image'
            ? `${CLOUDINARY_URL}/${status.url}?q_auto,f_auto,w_120,h_120,c_fill`
            : `${CLOUDINARY_URL}/${status.url.replace(/\.mp4$/, '.jpg')}?w_120,h_120,c_fill,q_auto,f_auto#t_0.1`;
          statusItem.innerHTML = `
            <img src="${thumbnail}" class="status-preview" alt="Your Status Preview" onerror="this.src='https://via.placeholder.com/120'" />
            <div class="status-preview-overlay"></div>
            <div class="status-info">
              <h3 class="status-name">${status.caption || `My Status #${index + 1}`}</h3>
              <p class="status-time">${formatTimestamp(status.timestamp)}</p>
            </div>
            <button class="delete-btn" data-status-id="${status.statusId}" aria-label="Delete status">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m-10 4v10a2 2 0 002 2h6a2 2 0 002-2V10m-9 0v10m4-10v10m-4-10h8" />
              </svg>
            </button>
          `;
          statusItem.onclick = (e) => {
            if (!e.target.closest('.delete-btn')) {
              viewStatus(userId, processedStatuses[userId], { name: users[userId]?.name || 'You' });
            }
          };
          statusItem.querySelector('.delete-btn').onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await window.showAlert(
              "Are you sure you want to delete this status?",
              false,
              true,
              () => {},
              () => {}
            );
            if (confirmed) {
              try {
                await remove(ref(db, `statuses/${userId}/${status.statusId}`));
                window.showAlert(MESSAGES.STATUS_DELETE_SUCCESS, true);
              } catch (error) {
                console.error("Error deleting status:", error);
                window.showAlert(MESSAGES.STATUS_DELETE_FAIL, false);
              }
            }
          };
          statusSection.appendChild(statusItem);
        });
      }

      Object.entries(processedStatuses)
        .filter(([uid]) => uid !== userId && processedStatuses[uid]?.length > 0)
        .forEach(([uid, userStatuses]) => {
          const user = users[uid] || { name: 'Unknown', avatar: null };
          const statusCount = userStatuses.length;
          const latestStatus = userStatuses[0];
          const thumbnail = latestStatus.resource_type === 'image'
            ? `${CLOUDINARY_URL}/${latestStatus.url}?q_auto,f_auto,w_120,h_120,c_fill`
            : `${CLOUDINARY_URL}/${latestStatus.url.replace(/\.mp4$/, '.jpg')}?w_120,h_120,c_fill,q_auto,f_auto#t_0.1`;
          const statusItem = document.createElement('div');
          statusItem.className = `status-item ${latestStatus.views?.[userId] ? 'viewed' : ''}`;
          statusItem.setAttribute('role', 'button');
          statusItem.setAttribute('aria-label', `View ${user.name}'s status`);
          statusItem.innerHTML = `
            <img src="${thumbnail}" class="status-preview" alt="${user.name}'s Status Preview" onerror="this.src='https://via.placeholder.com/120'" />
            <div class="status-preview-overlay"></div>
            <div class="status-info">
              <h3 class="status-name">${user.name} (${statusCount})</h3>
              <p class="status-time">${formatTimestamp(latestStatus.timestamp)}</p>
            </div>
          `;
          statusItem.onclick = () => viewStatus(uid, userStatuses, user);
          statusSection.appendChild(statusItem);
        });

      if (statusSection.children.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No statuses available.</p>';
      } else {
        chatList.appendChild(statusSection);
      }
    }

    async function uploadStatus() {
      const fileInput = document.getElementById('status-file');
      const captionInput = document.getElementById('status-caption');
      const file = fileInput.files[0];
      if (!file) {
        window.showAlert("Please select a file.", false);
        return;
      }
      try {
        const statusId = Date.now().toString();
        const storagePath = `statuses/${auth.currentUser.uid}/${statusId}`;
        const fileRef = storageRef(storage, storagePath);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);
        const statusData = {
          url,
          caption: captionInput.value.trim(),
          resource_type: file.type.startsWith('video') ? 'video' : 'image',
          timestamp: Date.now(),
          views: {}
        };
        await set(ref(db, `statuses/${auth.currentUser.uid}/${statusId}`), statusData);
        window.showAlert(MESSAGES.STATUS_UPLOAD_SUCCESS, true);
        window.hideStatusSheet();
      } catch (error) {
        console.error("Error uploading status:", error);
        window.showAlert(MESSAGES.STATUS_UPLOAD_FAIL, false);
      }
    }

    async function viewStatus(userId, statuses, user) {
      // Placeholder for status viewer
      console.log(`Viewing status for user ${userId}`, statuses, user);
      // Implement a full-screen status viewer with swipe navigation here
    }

    async function loadGroupMembers() {
      const select = document.getElementById('group-members');
      select.innerHTML = '';
      try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const users = snapshot.val() || {};
        Object.entries(users).forEach(([uid, user]) => {
          if (uid !== auth.currentUser.uid) {
            const option = document.createElement('option');
            option.value = uid;
            option.textContent = user.name || 'Unknown';
            select.appendChild(option);
          }
        });
      } catch (error) {
        console.error("Error loading group members:", error);
        window.showAlert(MESSAGES.USER_FAIL, false);
      }
    }

    async function addFriend() {
      const friendId = document.getElementById('friend-id').value.trim();
      if (!friendId) {
        window.showAlert("Please enter a valid user ID.", false);
        return;
      }
      try {
        const userRef = ref(db, `users/${friendId}`);
        const snapshot = await get(userRef);
        if (!snapshot.exists()) {
          window.showAlert("User not found.", false);
          return;
        }
        await update(ref(db, `users/${auth.currentUser.uid}/friends`), { [friendId]: true });
        window.showAlert(MESSAGES.FRIEND_REQUEST_SENT, true);
        window.hideBottomSheet();
      } catch (error) {
        console.error("Error adding friend:", error);
        window.showAlert(MESSAGES.FRIEND_REQUEST_FAIL, false);
      }
    }

    async function createRoom() {
      const roomName = document.getElementById('room-name').value.trim();
      if (!roomName) {
        window.showAlert("Please enter a room name.", false);
        return;
      }
      try {
        const roomId = Date.now().toString();
        await set(ref(db, `chatrooms/${roomId}`), {
          name: roomName,
          creator: auth.currentUser.uid,
          createdAt: Date.now()
        });
        window.showAlert(MESSAGES.ROOM_CREATE_SUCCESS, true);
        window.hideRoomSheet();
      } catch (error) {
        console.error("Error creating room:", error);
        window.showAlert(MESSAGES.ROOM_CREATE_FAIL, false);
      }
    }

    async function createGroup() {
      const groupName = document.getElementById('group-name').value.trim();
      const members = Array.from(document.getElementById('group-members').selectedOptions).map(opt => opt.value);
      if (!groupName || members.length === 0) {
        window.showAlert("Please enter a group name and select members.", false);
        return;
      }
      try {
        const groupId = Date.now().toString();
        const groupData = {
          name: groupName,
          members: { [auth.currentUser.uid]: true, ...Object.fromEntries(members.map(id => [id, true])) },
          createdAt: Date.now()
        };
        await set(ref(db, `groups/${groupId}`), groupData);
        window.showAlert(MESSAGES.GROUP_CREATE_SUCCESS, true);
        window.hideGroupSheet();
      } catch (error) {
        console.error("Error creating group:", error);
        window.showAlert(MESSAGES.GROUP_CREATE_FAIL, false);
      }
    }

    function renderRooms(rooms) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      const roomList = Object.entries(rooms).map(([roomId, room]) => ({
        id: roomId,
        name: room.name,
        creator: room.creator,
        createdAt: room.createdAt
      }));
      roomList.sort((a, b) => b.createdAt - a.createdAt);
      roomList.forEach(room => {
        const roomItem = document.createElement('div');
        roomItem.className = 'room-item';
        roomItem.setAttribute('role', 'button');
        roomItem.setAttribute('aria-label', `Open room ${room.name}`);
        roomItem.innerHTML = `
          <div class="avatar">${room.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${room.name}</h3>
            <p class="chat-message">Created by ${room.creator === auth.currentUser.uid ? 'You' : 'Someone'}</p>
          </div>
          <span class="chat-time">${formatTimestamp(room.createdAt)}</span>
        `;
        roomItem.onclick = () => window.location.href = `room.html?roomId=${room.id}`;
        chatList.appendChild(roomItem);
      });
      if (roomList.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No rooms available.</p>';
      }
    }

    function renderGroups(groups) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      const groupList = Object.entries(groups).map(([groupId, group]) => ({
        id: groupId,
        name: group.name,
        members: group.members,
        createdAt: group.createdAt
      }));
      groupList.sort((a, b) => b.createdAt - a.createdAt);
      groupList.forEach(group => {
        const groupItem = document.createElement('div');
        groupItem.className = 'group-item';
        groupItem.setAttribute('role', 'button');
        groupItem.setAttribute('aria-label', `Open group ${group.name}`);
        groupItem.innerHTML = `
          <div class="avatar">${group.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${group.name}</h3>
            <p class="chat-message">${Object.keys(group.members).length} members</p>
          </div>
          <span class="chat-time">${formatTimestamp(group.createdAt)}</span>
        `;
        groupItem.onclick = () => window.location.href = `group.html?groupId=${group.id}`;
        chatList.appendChild(groupItem);
      });
      if (groupList.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No groups available.</p>';
      }
    }

    tabItems.forEach(tab => {
      tab.addEventListener('click', async () => {
        if (!auth.currentUser) {
          window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
          return;
        }
        tabItems.forEach(t => {
          t.classList.remove('active');
          t.querySelector('svg')?.setAttribute('stroke', 'var(--text-secondary)');
        });
        tab.classList.add('active');
        tab.querySelector('svg')?.setAttribute('stroke', 'var(--accent)');
        currentTab = tab.getAttribute('data-tab');
        searchInput.value = '';
        chatList.setAttribute('aria-busy', 'true');
        showShimmer(chatList);

        try {
          if (currentTab === 'rooms') {
            fab.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>Create Room</span>`;
            const roomsRef = ref(db, 'chatrooms');
            const roomsSnapshot = await get(roomsRef);
            renderRooms(roomsSnapshot.val() || {});
          } else if (currentTab === 'chats') {
            fab.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>Add Friend</span>`;
            cleanupListeners();
            await loadChats(auth.currentUser.uid);
          } else if (currentTab === 'status') {
            fab.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>Add Status</span>`;
            cleanupListeners();
            await loadStatuses(auth.currentUser.uid, {});
          } else if (currentTab === 'groups') {
            fab.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>Create Group</span>`;
            const groupsRef = ref(db, 'groups');
            const groupsSnapshot = await get(groupsRef);
            renderGroups(groupsSnapshot.val() || {});
          }
        } catch (error) {
          console.error(`Error loading ${currentTab}:`, error);
          chatList.setAttribute('aria-busy', 'false');
          chatList.innerHTML = `<p style="text-align: center; padding: 1rem;">Failed to load ${currentTab}.</p>`;
          window.showAlert(`Failed to load ${currentTab}. Please try again.`, false);
        }
      });
    });

    fab.addEventListener('click', () => {
      if (currentTab === 'chats') {
        window.showBottomSheet();
      } else if (currentTab === 'rooms') {
        window.showRoomSheet();
      } else if (currentTab === 'status') {
        window.showStatusSheet();
      } else if (currentTab === 'groups') {
        window.showGroupSheet();
      }
    });

    document.addEventListener('click', (event) => {
      if (menuDropdown.classList.contains('active') && !menuDropdown.contains(event.target) && !event.target.closest('.menu-icon')) {
        window.toggleMenu();
      }
      if (bottomSheet.classList.contains('active') && !bottomSheet.contains(event.target) && !event.target.closest('#fab')) {
        window.hideBottomSheet();
      }
      if (createRoomSheet.classList.contains('active') && !createRoomSheet.contains(event.target) && !event.target.closest('#fab')) {
        window.hideRoomSheet();
      }
      if (createGroupSheet.classList.contains('active') && !createGroupSheet.contains(event.target) && !event.target.closest('#fab')) {
        window.hideGroupSheet();
      }
      if (statusUploadSheet.classList.contains('active') && !statusUploadSheet.contains(event.target) && !event.target.closest('#fab')) {
        window.hideStatusSheet();
      }
    });

    menuDropdown.addEventListener('click', (event) => event.stopPropagation());
    bottomSheet.addEventListener('click', (event) => event.stopPropagation());
    createRoomSheet.addEventListener('click', (event) => event.stopPropagation());
    createGroupSheet.addEventListener('click', (event) => event.stopPropagation());
    statusUploadSheet.addEventListener('click', (event) => event.stopPropagation());

    window.addFriend = addFriend;
    window.createRoom = createRoom;
    window.createGroup = createGroup;
    window.uploadStatus = uploadStatus;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            userAvatar.textContent = userData.avatar ? '' : userData.name?.charAt(0).toUpperCase() || 'U';
            if (userData.avatar) {
              userAvatar.innerHTML = `<img src="${CLOUDINARY_URL}/${userData.avatar}?q_auto,f_auto,w_48,h_48,c_fill" alt="Avatar" onerror="this.parentElement.textContent='${userData.name?.charAt(0).toUpperCase() || 'U'}'" />`;
            }
            applyUserTheme(user.uid);
            setOnlineStatus(user.uid, true);
            loadChats(user.uid);
          } else {
            window.showAlert(MESSAGES.PROFILE_FAIL, false);
          }
        }).catch((error) => {
          console.error("Error loading profile:", error);
          window.showAlert(MESSAGES.PROFILE_FAIL, false);
        });

        window.addEventListener('beforeunload', () => {
          setOnlineStatus(user.uid, false);
          cleanupListeners();
        });
      } else {
        cleanupListeners();
        window.location.href = 'signup.html';
      }
    });
  </script>
</body>
</html>
