<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --twitter-blue: #1DA1F2;
      --background: #F7F7F7;
      --chat-bg: #FFFFFF;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --header-bg: linear-gradient(90deg, #1DA1F2, #00D4FF);
      --accent: #E6F3FA;
      --unread-bg: #25D366;
      --status-ring: #25D366;
      --status-bg: #FFFFFF;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      color: var(--text-primary);
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .header {
      background: var(--header-bg);
      color: #FFFFFF;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
      letter-spacing: 0.02em;
    }

    .header-actions {
      display: flex;
      gap: 1.5rem;
    }

    .header-actions svg {
      width: 24px;
      height: 24px;
      cursor: pointer;
      fill: #FFFFFF;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .header-actions svg:hover {
      transform: scale(1.15);
      opacity: 0.9;
    }

    .menu-dropdown {
      display: none;
      position: absolute;
      top: 50px;
      right: 1.5rem;
      background: var(--chat-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      min-width: 140px;
      overflow: hidden;
    }

    .menu-dropdown.active {
      display: block;
    }

    .menu-item {
      padding: 0.75rem 1rem;
      color: var(--text-primary);
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-item:hover {
      background: var(--accent);
    }

    .search-bar {
      display: none;
      position: sticky;
      top: 64px;
      background: var(--chat-bg);
      padding: 0.75rem 1.5rem;
      z-index: 9;
      border-bottom: 1px solid var(--border);
    }

    .search-bar.active {
      display: block;
    }

    .search-input {
      width: 100%;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .search-input:focus {
      border-color: var(--twitter-blue);
      box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.1);
    }

    .user-profile {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      background: var(--chat-bg);
      transition: background 0.2s ease;
    }

    .user-profile:hover {
      background: var(--accent);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--twitter-blue);
      color: #FFFFFF;
      font-weight: 500;
      font-size: 1.25rem;
      text-transform: uppercase;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-name {
      font-weight: 500;
      font-size: 1rem;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      background: var(--chat-bg);
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chat-item:hover {
      background: var(--accent);
    }

    .chat-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--twitter-blue);
      color: #FFFFFF;
      font-weight: 500;
      font-size: 1.25rem;
      text-transform: uppercase;
    }

    .chat-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-weight: 500;
      font-size: 1rem;
      margin: 0;
    }

    .chat-preview {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin: 0.25rem 0 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .unread-count {
      background: var(--unread-bg);
      color: #FFFFFF;
      font-size: 0.75rem;
      font-weight: 500;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 1rem;
    }

    .custom-alert {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--chat-bg);
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      color: var(--text-primary);
      font-weight: 500;
      text-align: center;
      max-width: 90%;
      width: 320px;
      animation: fadeIn 0.3s ease-out forwards;
      border: 1px solid var(--border);
    }

    .custom-alert.active {
      display: block;
    }

    .custom-alert .close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: var(--twitter-blue);
      cursor: pointer;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .custom-alert .close-btn:hover {
      transform: scale(1.2);
      color: #1A91DA;
    }

    .custom-alert .close-btn svg {
      width: 100%;
      height: 100%;
    }

    .custom-alert .alert-input {
      width: 100%;
      padding: 0.5rem 1rem;
      margin: 1rem 0;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .custom-alert .alert-input:focus {
      border-color: var(--twitter-blue);
    }

    .custom-alert .alert-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .custom-alert .alert-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .custom-alert .alert-btn.confirm {
      background: var(--twitter-blue);
      color: #FFFFFF;
    }

    .custom-alert .alert-btn.confirm:hover {
      background: #1A91DA;
      transform: scale(1.05);
    }

    .custom-alert .alert-btn.cancel {
      background: #F1F3F5;
      color: var(--text-primary);
    }

    .custom-alert .alert-btn.cancel:hover {
      background: #E9ECEF;
      transform: scale(1.05);
    }

    .bottom-tab-view {
      background: var(--chat-bg);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      position: sticky;
      bottom: 0;
      z-index: 10;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
    }

    .tab-item {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s ease, transform 0.2s ease;
    }

    .tab-item.active {
      color: var(--twitter-blue);
      transform: scale(1.05);
    }

    .tab-item:hover {
      color: var(--twitter-blue);
    }

    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--twitter-blue);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
      z-index: 1000;
    }

    .fab:hover {
      transform: scale(1.1);
      background: #1A91DA;
    }

    .fab svg {
      width: 24px;
      height: 24px;
      fill: #FFFFFF;
    }

    .bottom-sheet {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--chat-bg);
      border-top: 1px solid var(--border);
      max-height: 80vh;
      overflow-y: auto;
      z-index: 2000;
      animation: slideUp 0.3s ease-out forwards;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    }

    .bottom-sheet.active {
      display: block;
    }

    .bottom-sheet-header {
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .bottom-sheet-header h2 {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0;
    }

    .bottom-sheet .close-btn {
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: var(--twitter-blue);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .bottom-sheet .close-btn:hover {
      transform: scale(1.2);
    }

    .bottom-sheet .close-btn svg {
      width: 100%;
      height: 100%;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .user-item .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--twitter-blue);
      color: #FFFFFF;
      font-weight: 500;
      font-size: 1.1rem;
      text-transform: uppercase;
    }

    .user-item .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-info {
      flex: 1;
    }

    .user-item .user-name {
      font-weight: 500;
      font-size: 1rem;
      margin: 0;
    }

    .add-btn {
      padding: 0.5rem 1rem;
      background: var(--twitter-blue);
      color: #FFFFFF;
      border: none;
      border-radius: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .add-btn:hover {
      background: #1A91DA;
      transform: scale(1.05);
    }

    .add-btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
    }

    /* Status Tab Styles */
    .status-section {
      flex: 1;
      overflow-y: auto;
      background: var(--status-bg);
      padding: 0.5rem 1rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 12px;
      cursor: pointer;
      background: var(--chat-bg);
      margin-bottom: 0.5rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .status-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .status-item .status-preview {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      margin-right: 0.75rem;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .status-item .status-info {
      flex: 1;
    }

    .status-item .status-name {
      font-weight: 600;
      font-size: 1rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-item .status-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .status-item .delete-btn {
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: #FF4D4F;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .status-item .delete-btn:hover {
      transform: scale(1.2);
    }

    .status-item .delete-btn svg {
      width: 100%;
      height: 100%;
    }

    .status-viewer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000000;
      z-index: 3000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }

    .status-viewer.active {
      display: flex;
    }

    .status-viewer .status-content {
      max-width: 100%;
      max-height: 80%;
      object-fit: contain;
      border-radius: 8px;
    }

    .status-viewer .progress-bar-container {
      position: absolute;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      display: flex;
      gap: 4px;
    }

    .status-viewer .progress-bar {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
    }

    .status-viewer .progress-bar .progress {
      height: 100%;
      background: #FFFFFF;
      width: 0;
      border-radius: 2px;
      transition: width linear;
    }

    .status-viewer .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      color: #FFFFFF;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .status-viewer .close-btn:hover {
      transform: scale(1.2);
    }

    .status-viewer .close-btn svg {
      width: 100%;
      height: 100%;
    }

    .status-viewer .status-caption {
      position: absolute;
      bottom: 3rem;
      left: 1rem;
      right: 1rem;
      color: #FFFFFF;
      font-size: 1rem;
      font-weight: 400;
      text-align: center;
      background: rgba(0, 0, 0, 0.6);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-viewer .status-user {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #FFFFFF;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .status-viewer .reaction-container {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-viewer .reaction-btn {
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      color: #FFFFFF;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .status-viewer .reaction-btn:hover {
      transform: scale(1.2);
    }

    .status-viewer .reaction-btn svg {
      width: 100%;
      height: 100%;
    }

    .status-viewer .reaction-btn.reacted {
      color: #FF4D4F;
    }

    .status-viewer .reaction-count {
      color: #FFFFFF;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .status-viewer .tap-area {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
      z-index: 3100;
    }

    .status-viewer .tap-area-left {
      left: 0;
    }

    .status-viewer .tap-area-right {
      right: 0;
    }

    /* Shimmer Effect */
    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    .shimmer-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .shimmer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 1rem;
      background: #e0e0e0;
    }

    .shimmer-text {
      flex: 1;
    }

    .shimmer-line {
      height: 16px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 0.25rem 0;
    }

    .shimmer-line.short {
      width: 60%;
    }

    .shimmer-line.long {
      width: 80%;
    }

    /* Overlay Spinner */
    .spinner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 4000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #FFFFFF;
      border-top: 4px solid var(--twitter-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @keyframes slideUp {
      0% { transform: translateY(100%); }
      100% { transform: translateY(0); }
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    @media (max-width: 640px) {
      .header h1 {
        font-size: 1.25rem;
      }

      .header-actions svg {
        width: 20px;
        height: 20px;
      }

      .menu-dropdown {
        right: 1rem;
        top: 48px;
      }

      .menu-item {
        font-size: 0.9rem;
        padding: 0.6rem 0.8rem;
      }

      .search-bar {
        padding: 0.5rem 1rem;
      }

      .search-input {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
      }

      .user-profile {
        padding: 0.75rem 1rem;
      }

      .user-profile .user-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }

      .user-profile .user-name {
        font-size: 0.95rem;
      }

      .chat-item {
        padding: 0.5rem 1rem;
      }

      .chat-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }

      .chat-name {
        font-size: 0.95rem;
      }

      .chat-preview {
        font-size: 0.8rem;
      }

      .chat-time {
        font-size: 0.7rem;
      }

      .unread-count {
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
      }

      .custom-alert {
        width: 85%;
        padding: 1rem;
      }

      .tab-item {
        font-size: 0.8rem;
        padding: 0.5rem;
      }

      .fab {
        width: 48px;
        height: 48px;
        bottom: 70px;
        right: 15px;
      }

      .fab svg {
        width: 20px;
        height: 20px;
      }

      .bottom-sheet-header h2 {
        font-size: 1.1rem;
      }

      .user-item {
        padding: 0.75rem 1rem;
      }

      .user-item .user-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.95rem;
      }

      .user-item .user-name {
        font-size: 0.95rem;
      }

      .add-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }

      .status-item {
        padding: 0.5rem;
      }

      .status-item .status-preview {
        width: 40px;
        height: 40px;
      }

      .status-item .status-name {
        font-size: 0.95rem;
      }

      .status-item .status-time {
        font-size: 0.7rem;
      }

      .status-viewer .status-caption {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
      }

      .status-viewer .status-user {
        font-size: 0.8rem;
      }

      .status-viewer .reaction-btn {
        width: 28px;
        height: 28px;
      }

      .status-viewer .reaction-count {
        font-size: 0.8rem;
      }

      .shimmer-avatar {
        width: 40px;
        height: 40px;
      }

      .shimmer-line {
        height: 14px;
      }
    }

    #chats-unread-count {
      margin-left: 0.5rem;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Vynix</h1>
    <div class="header-actions">
      <svg viewBox="0 0 24 24" class="search-icon" onclick="window.toggleSearchBar()">
        <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 001.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 00-7.27 7.27c.34 2.8 2.56 5.12 5.59 5.59a6.5 6.5 0 005.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
      </svg>
      <svg viewBox="0 0 24 24" class="menu-icon" onclick="window.toggleMenu()">
        <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
      </svg>
      <div class="menu-dropdown" id="menu-dropdown">
        <div class="menu-item" onclick="window.showAlert('Profile view coming soon!', true)">Profile</div>
        <div class="menu-item" onclick="window.location.href='#'">Settings</div>
      </div>
    </div>
  </header>

  <div class="search-bar" id="search-bar">
    <input type="text" class="search-input" id="search-input" placeholder="Search suggested friends..." oninput="window.filterSuggestedFriends(this.value)" />
  </div>

  <div class="user-profile" id="user-profile" onclick="window.location.href='profile.html'">
    <div class="user-avatar" id="user-avatar"></div>
    <div class="user-name" id="user-name">Loading...</div>
  </div>

  <div class="chat-list" id="chat-list">
    <!-- Chat items, status items, or shimmer placeholders will be dynamically populated -->
  </div>

  <div class="bottom-tab-view">
    <div class="tab-item active" data-tab="chats">Chats <span id="chats-unread-count" class="unread-count" style="display: none;">0</span></div>
    <div class="tab-item" data-tab="status">Status</div>
    <div class="tab-item" data-tab="calls">Calls</div>
  </div>

  <div class="fab" id="fab">
    <svg id="fab-icon" viewBox="0 0 24 24">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13h-4v4h-2v-4H7v-2h4V7h2v6h4v2z" />
    </svg>
    <input type="file" id="status-upload" style="display: none;" accept="image/jpeg,image/png,video/mp4" />
  </div>

  <div id="custom-alert" class="custom-alert">
    <button class="close-btn" onclick="window.hideAlert()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <p id="alert-message">An error occurred. Please try again later.</p>
    <input type="text" id="alert-input" class="alert-input" style="display: none;" maxlength="100" placeholder="Enter caption..." />
    <div class="alert-buttons" id="alert-buttons">
      <button class="alert-btn confirm" id="alert-confirm" style="display: none;">OK</button>
      <button class="alert-btn cancel" id="alert-cancel" style="display: none;">Cancel</button>
    </div>
  </div>

  <div id="bottom-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Add Friends</h2>
      <button class="close-btn" onclick="window.hideBottomSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div id="user-list">
      <!-- User items will be dynamically populated -->
    </div>
  </div>

  <div id="status-viewer" class="status-viewer">
    <img id="status-image" class="status-content" style="display: none;" />
    <video id="status-video" class="status-content" controls style="display: none;"></video>
    <div id="status-caption" class="status-caption"></div>
    <button class="close-btn" onclick="window.closeStatusViewer()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

 <!--<div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>-->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    storageBucket: "fire-b-a8878.firebasestorage.app",
    messagingSenderId: "658673187627",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e",
    measurementId: "G-V4W97VMSKL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const customAlert = document.getElementById("custom-alert");
  const alertMessage = document.getElementById("alert-message");
  const alertInput = document.getElementById("alert-input");
  const alertConfirm = document.getElementById("alert-confirm");
  const alertCancel = document.getElementById("alert-cancel");
  const alertButtons = document.getElementById("alert-buttons");
  const chatList = document.getElementById("chat-list");
  const bottomSheet = document.getElementById("bottom-sheet");
  const userList = document.getElementById("user-list");
  const tabItems = document.querySelectorAll(".tab-item");
  const searchBar = document.getElementById("search-bar");
  const menuDropdown = document.getElementById("menu-dropdown");
  const userAvatar = document.getElementById("user-avatar");
  const userName = document.getElementById("user-name");
  const statusViewer = document.getElementById("status-viewer");
  const statusImage = document.getElementById("status-image");
  const statusVideo = document.getElementById("status-video");
  const statusCaption = document.getElementById("status-caption");
  const fab = document.getElementById("fab");
  const fabIcon = document.getElementById("fab-icon");
  const statusUpload = document.getElementById("status-upload");
  const spinnerOverlay = document.getElementById("spinner-overlay");
  let friendsData = [];
  let suggestedFriends = [];
  let statusTimer;
  let currentTab = "chats";
  let isPaused = false;
  let alertResolve = null;

  // Cloudinary configuration
  const CLOUDINARY_CLOUD_NAME = "dqkujefxj"; // Replace with your Cloudinary cloud name
  const CLOUDINARY_UPLOAD_PRESET = "banter_box"; // Replace with your unsigned upload preset
  const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

  // Encryption key (for demo; use secure key management in production)
  const ENCRYPTION_KEY = "my-secret-key-123";

  window.hideAlert = function () {
    customAlert.classList.remove("active");
    alertInput.style.display = "none";
    alertConfirm.style.display = "none";
    alertCancel.style.display = "none";
    alertInput.value = "";
    alertResolve = null;
  };

  window.showAlert = function (message, autoHide = true, input = false, confirmCallback = null, cancelCallback = null) {
    return new Promise((resolve) => {
      alertMessage.textContent = message;
      alertInput.style.display = input ? "block" : "none";
      alertConfirm.style.display = confirmCallback ? "block" : "none";
      alertCancel.style.display = cancelCallback ? "block" : "none";
      customAlert.classList.add("active");
      alertResolve = resolve;

      if (input) {
        alertInput.focus();
      }

      if (autoHide && !confirmCallback && !cancelCallback) {
        setTimeout(window.hideAlert, 5000);
      }

      alertConfirm.onclick = () => {
        if (confirmCallback) {
          confirmCallback(input ? alertInput.value : true);
        }
        resolve(input ? alertInput.value : true);
        window.hideAlert();
      };

      alertCancel.onclick = () => {
        if (cancelCallback) {
          cancelCallback();
        }
        resolve(false);
        window.hideAlert();
      };
    });
  };

  window.showBottomSheet = function () {
    bottomSheet.classList.add("active");
  };

  window.hideBottomSheet = function () {
    bottomSheet.classList.remove("active");
  };

  window.toggleSearchBar = function () {
    searchBar.classList.toggle("active");
    const searchInput = document.getElementById("search-input");
    if (searchBar.classList.contains("active")) {
      searchInput.focus();
    } else {
      searchInput.value = "";
      window.filterSuggestedFriends("");
    }
  };

  window.toggleMenu = function () {
    menuDropdown.classList.toggle("active");
  };

  window.filterSuggestedFriends = function (query) {
    const filteredFriends = suggestedFriends.filter(friend =>
      friend.name.toLowerCase().includes(query.toLowerCase())
    );
    renderSuggestedFriends(filteredFriends);
  };

  window.closeStatusViewer = function () {
    statusViewer.classList.remove("active");
    statusImage.style.display = "none";
    statusVideo.style.display = "none";
    statusVideo.pause();
    statusCaption.textContent = "";
    statusViewer.querySelector('.status-user')?.remove();
    statusViewer.querySelector('.progress-bar-container')?.remove();
    statusViewer.querySelector('.tap-area-left')?.remove();
    statusViewer.querySelector('.tap-area-right')?.remove();
    statusViewer.querySelector('.reaction-container')?.remove();
    clearInterval(statusTimer);
    isPaused = false;
  };

  function showShimmer(count = 5) {
    chatList.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const shimmerItem = document.createElement('div');
      shimmerItem.className = 'shimmer-item shimmer';
      shimmerItem.innerHTML = `
        <div class="shimmer-avatar"></div>
        <div class="shimmer-text">
          <div class="shimmer-line long"></div>
          <div class="shimmer-line short"></div>
        </div>
      `;
      chatList.appendChild(shimmerItem);
    }
  }

  function encryptMessage(message) {
    return CryptoJS.AES.encrypt(message, ENCRYPTION_KEY).toString();
  }

  function decryptMessage(ciphertext) {
    try {
      const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_KEY);
      return bytes.toString(CryptoJS.enc.Utf8);
    } catch (error) {
      console.error("Decryption error:", error);
      return "";
    }
  }

  function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    if (diffDays === 0) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else {
      return date.toLocaleDateString();
    }
  }

  async function uploadToCloudinary(file) {
    if (file.size > 10 * 1024 * 1024) {
      throw new Error("File size exceeds 10MB limit.");
    }
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
    try {
      const response = await fetch(CLOUDINARY_API_URL, {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      console.log("Cloudinary response:", data);
      if (data.secure_url) {
        return {
          url: data.secure_url,
          resource_type: data.resource_type,
          public_id: data.public_id,
        };
      } else {
        throw new Error(data.error?.message || "Upload failed");
      }
    } catch (error) {
      console.error("Cloudinary upload error:", error);
      throw error;
    }
  }

  async function uploadStatus(file, userId, userProfile) {
    if (!file) return;
    if (!auth.currentUser) {
      window.showAlert("Please sign in to upload a status.", false);
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      window.showAlert("File size exceeds 10MB limit.", false);
      return;
    }
    const caption = await window.showAlert(
      "Enter a caption for your status (max 100 characters):",
      false,
      true,
      (value) => {
        if (value.length > 100) {
          window.showAlert("Caption cannot exceed 100 characters.", false);
          return;
        }
      },
      () => {}
    );
    if (caption === false) return;
    if (caption.length > 100) {
      window.showAlert("Caption cannot exceed 100 characters.", false);
      return;
    }
    // Show overlay spinner only for status upload
    spinnerOverlay.classList.add("active");
    try {
      const uploadResult = await uploadToCloudinary(file);
      const statusData = {
        url: uploadResult.url,
        resource_type: uploadResult.resource_type,
        timestamp: Date.now(),
        caption: caption || "",
        reactions: {}
      };
      await push(ref(db, `statuses/${userId}`), statusData);
      window.showAlert("Status uploaded successfully!", true);
      loadStatuses(userId, userProfile);
    } catch (error) {
      console.error("Error uploading status:", error.message, error.stack);
      window.showAlert(`Failed to upload status: ${error.message}`, false);
    } finally {
      // Hide overlay spinner after upload completes or fails
      spinnerOverlay.classList.remove("active");
      statusUpload.value = '';
    }
  }

  function renderChats(friends) {
    chatList.innerHTML = '';
    if (friends.length === 0) {
      chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No friends found.</p>';
      return;
    }
    friends.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    const totalUnread = friends.reduce((sum, friend) => sum + (friend.unreadCount || 0), 0);
    const chatsUnreadBadge = document.getElementById('chats-unread-count');
    if (chatsUnreadBadge) {
      chatsUnreadBadge.textContent = totalUnread;
      chatsUnreadBadge.style.display = totalUnread > 0 ? 'inline-flex' : 'none';
    }
    friends.forEach(({ uid, name, avatar, lastMessage, timestamp, unreadCount }) => {
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      const firstLetter = name ? name.charAt(0) : 'U';
      const avatarContent = avatar ? `<img src="${avatar}" alt="Avatar" />` : firstLetter;
      const decryptedMessage = lastMessage ? decryptMessage(lastMessage) : '';
      const unreadBadge = unreadCount > 0 ? `<span class="unread-count">${unreadCount}</span>` : '';
      chatItem.innerHTML = `
        <div class="chat-avatar">${avatarContent}</div>
        <div class="chat-info">
          <h3 class="chat-name">${name || 'Unknown'}</h3>
          <p class="chat-preview">${decryptedMessage}</p>
        </div>
        <div class="flex flex-col items-end">
          <span class="chat-time">${formatTimestamp(timestamp || Date.now())}</span>
          ${unreadBadge}
        </div>
      `;
      chatItem.onclick = () => {
        window.location.href = `messages.html?friendId=${uid}`;
      };
      chatList.appendChild(chatItem);
    });
  }

  function renderSuggestedFriends(friends) {
    chatList.innerHTML = '';
    if (friends.length === 0) {
      chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No suggested friends found.</p>';
      return;
    }
    friends.forEach(({ uid, name, avatar }) => {
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      const firstLetter = name ? name.charAt(0) : 'U';
      const avatarContent = avatar ? `<img src="${avatar}" alt="Avatar" />` : firstLetter;
      chatItem.innerHTML = `
        <div class="chat-avatar">${avatarContent}</div>
        <div class="chat-info">
          <h3 class="chat-name">${name || 'Unknown'}</h3>
          <p class="chat-preview">Suggested friend</p>
        </div>
        <button class="add-btn" data-uid="${uid}">Add</button>
      `;
      chatList.appendChild(chatItem);
    });
    document.querySelectorAll('.add-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const friendUid = button.getAttribute('data-uid');
        const userId = auth.currentUser?.uid;
        if (!userId) {
          window.showAlert("Please sign in to add friends.", false);
          return;
        }
        try {
          await set(ref(db, `friends/${userId}/${friendUid}`), true);
          button.textContent = 'Added';
          button.disabled = true;
          window.showAlert(`Added ${friends.find(f => f.uid === friendUid).name} as a friend!`, true);
          loadChats(userId);
        } catch (error) {
          console.error("Error adding friend:", error);
          window.showAlert("Failed to add friend. Please try again.", false);
        }
      });
    });
  }

  function renderStatuses(statuses, userId, userProfile) {
    console.log("Rendering statuses:", statuses);
    chatList.innerHTML = '';
    const statusSection = document.createElement('div');
    statusSection.className = 'status-section';

    // Filter statuses to expire after 24 hours
    const now = Date.now();
    for (const uid in statuses) {
      statuses[uid] = Object.entries(statuses[uid]).map(([statusId, status]) => ({
        statusId,
        ...status
      })).filter(status => now - status.timestamp < 24 * 60 * 60 * 1000);
    }

    // My Status Cards
    if (statuses[userId]?.length > 0) {
      statuses[userId].sort((a, b) => b.timestamp - a.timestamp).forEach((status, index) => {
        const statusItem = document.createElement('div');
        statusItem.className = 'status-item';
        const thumbnail = status.resource_type === 'image'
          ? `${status.url}?q_auto,f_auto,w_48,h_48,c_fill`
          : `${status.url.replace(/\.mp4$/, '.jpg')}?w_48,h_48,c_fill,q_auto,f_auto#t_0.1`;
        statusItem.innerHTML = `
          <img src="${thumbnail}" class="status-preview" alt="Status Preview" onerror="this.src='https://via.placeholder.com/48'" />
          <div class="status-info">
            <h3 class="status-name">${status.caption || `My Status #${index + 1}`}</h3>
            <p class="status-time">${formatTimestamp(status.timestamp)}</p>
          </div>
          <button class="delete-btn" data-status-id="${status.statusId}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m-10 4v10a2 2 0 002 2h6a2 2 0 002-2V10m-9 0v10m4-10v10m-4-10h8" />
            </svg>
          </button>
        `;
        statusItem.onclick = (e) => {
          if (!e.target.closest('.delete-btn')) {
            viewStatus(userId, statuses[userId], userProfile);
          }
        };
        statusItem.querySelector('.delete-btn').onclick = async (e) => {
          e.stopPropagation();
          const confirmed = await window.showAlert(
            "Are you sure you want to delete this status?",
            false,
            false,
            () => {},
            () => {}
          );
          if (confirmed) {
            try {
              await remove(ref(db, `statuses/${userId}/${status.statusId}`));
              window.showAlert("Status deleted successfully!", true);
              loadStatuses(userId, userProfile);
            } catch (error) {
              console.error("Error deleting status:", error);
              window.showAlert("Failed to delete status. Please try again.", false);
            }
          }
        };
        statusSection.appendChild(statusItem);
      });
    }

    // All Users' Statuses
    const usersRef = ref(db, 'users');
    onValue(usersRef, (userSnapshot) => {
      if (userSnapshot.exists()) {
        const users = userSnapshot.val();
        Object.keys(statuses).forEach(uid => {
          if (uid !== userId && statuses[uid]?.length > 0) {
            const user = users[uid] || { name: 'Unknown', avatar: null };
            const statusItem = document.createElement('div');
            statusItem.className = 'status-item';
            const statusCount = statuses[uid].length;
            const latestStatus = statuses[uid][0];
            const thumbnail = latestStatus.resource_type === 'image'
              ? `${latestStatus.url}?q_auto,f_auto,w_48,h_48,c_fill`
              : `${latestStatus.url.replace(/\.mp4$/, '.jpg')}?w_48,h_48,c_fill,q_auto,f_auto#t_0.1`;
            statusItem.innerHTML = `
              <img src="${thumbnail}" class="status-preview" alt="Status Preview" onerror="this.src='https://via.placeholder.com/48'" />
              <div class="status-info">
                <h3 class="status-name">${user.name || 'Unknown'} (${statusCount} ${statusCount > 1 ? 'statuses' : 'status'})</h3>
                <p class="status-time">${formatTimestamp(latestStatus.timestamp)}</p>
              </div>
            `;
            statusItem.onclick = () => viewStatus(uid, statuses[uid], user);
            statusSection.appendChild(statusItem);
          }
        });
      }
    }, { onlyOnce: true }, (error) => {
      console.error("Error fetching users:", error);
      window.showAlert("Failed to load user data.", false);
    });

    chatList.appendChild(statusSection);
  }

  function viewStatus(userId, statusArray, userProfile) {
    if (!statusArray || statusArray.length === 0) return;
    let currentIndex = 0;
    const duration = 5000; // 5 seconds per status
    let currentUserId = auth.currentUser?.uid;

    // Clear previous viewer elements
    statusViewer.querySelector('.status-user')?.remove();
    statusViewer.querySelector('.progress-bar-container')?.remove();
    statusViewer.querySelector('.tap-area-left')?.remove();
    statusViewer.querySelector('.tap-area-right')?.remove();
    statusViewer.querySelector('.reaction-container')?.remove();

    // Add user info
    const userDiv = document.createElement('div');
    userDiv.className = 'status-user';
    userDiv.innerHTML = `<span>${userProfile.name || 'Unknown'}</span>`;
    statusViewer.appendChild(userDiv);

    // Add progress bars
    const progressContainer = document.createElement('div');
    progressContainer.className = 'progress-bar-container';
    statusArray.forEach((_, index) => {
      const bar = document.createElement('div');
      bar.className = 'progress-bar';
      bar.innerHTML = `<div class="progress" id="progress-${index}"></div>`;
      progressContainer.appendChild(bar);
    });
    statusViewer.appendChild(progressContainer);

    // Add tap areas
    const tapLeft = document.createElement('div');
    tapLeft.className = 'tap-area tap-area-left';
    const tapRight = document.createElement('div');
    tapRight.className = 'tap-area tap-area-right';
    statusViewer.appendChild(tapLeft);
    statusViewer.appendChild(tapRight);

    // Add reaction button and count
    const reactionContainer = document.createElement('div');
    reactionContainer.className = 'reaction-container';
    statusViewer.appendChild(reactionContainer);

    function updateReactionButton(status) {
      reactionContainer.innerHTML = '';
      const reactionCount = status.reactions ? Object.keys(status.reactions).length : 0;
      const hasReacted = currentUserId && status.reactions && status.reactions[currentUserId];
      reactionContainer.innerHTML = `
        <button class="reaction-btn ${hasReacted ? 'reacted' : ''}" data-status-id="${status.statusId}">
          <svg viewBox="0 0 24 24" fill="${hasReacted ? '#FF4D4F' : 'none'}" stroke="currentColor" stroke-width="2">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </button>
        <span class="reaction-count">${reactionCount}</span>
      `;
      const reactionBtn = reactionContainer.querySelector('.reaction-btn');
      reactionBtn.onclick = async (e) => {
        e.stopPropagation();
        if (!currentUserId) {
          window.showAlert("Please sign in to react to statuses.", false);
          return;
        }
        try {
          const statusRef = ref(db, `statuses/${userId}/${status.statusId}/reactions/${currentUserId}`);
          if (hasReacted) {
            await remove(statusRef);
          } else {
            await set(statusRef, true);
          }
          // Refresh status to update reaction count
          const updatedStatusRef = ref(db, `statuses/${userId}/${status.statusId}`);
          onValue(updatedStatusRef, (snapshot) => {
            if (snapshot.exists()) {
              const updatedStatus = snapshot.val();
              updateReactionButton({ ...status, reactions: updatedStatus.reactions });
            }
          }, { onlyOnce: true });
        } catch (error) {
          console.error("Error updating reaction:", error);
          window.showAlert("Failed to update reaction. Please try again.", false);
        }
      };
    }

    function showStatus(index) {
      if (index < 0 || index >= statusArray.length) {
        window.closeStatusViewer();
        return;
      }
      const status = statusArray[index];
      statusImage.style.display = status.resource_type === 'image' ? 'block' : 'none';
      statusVideo.style.display = status.resource_type === 'video' ? 'block' : 'none';
      statusCaption.textContent = status.caption || "";
      if (status.resource_type === 'image') {
        statusImage.src = `${status.url}?q_auto,f_auto`;
      } else {
        statusVideo.src = `${status.url}?q_auto,f_auto`;
        statusVideo.play();
      }
      statusViewer.classList.add('active');

      // Reset all progress bars
      statusArray.forEach((_, i) => {
        const progress = document.getElementById(`progress-${i}`);
        if (progress) {
          progress.style.width = i < index ? '100%' : '0';
          progress.style.transition = 'none';
        }
      });

      // Animate current progress bar
      const currentProgress = document.getElementById(`progress-${index}`);
      if (currentProgress && !isPaused) {
        currentProgress.style.transition = `width ${duration}ms linear`;
        currentProgress.style.width = '100%';
      }

      // Update reaction button
      updateReactionButton(status);

      clearInterval(statusTimer);
      if (!isPaused) {
        statusTimer = setInterval(() => {
          currentIndex++;
          showStatus(currentIndex);
        }, duration);
      }
    }

    // Tap navigation
    tapLeft.onclick = () => {
      clearInterval(statusTimer);
      currentIndex--;
      showStatus(currentIndex);
    };
    tapRight.onclick = () => {
      clearInterval(statusTimer);
      currentIndex++;
      showStatus(currentIndex);
    };

    // Pause/resume on hold
    let holdTimer;
    statusViewer.onmousedown = statusViewer.ontouchstart = () => {
      if (!isPaused) {
        holdTimer = setTimeout(() => {
          isPaused = true;
          clearInterval(statusTimer);
          statusVideo.pause();
          const currentProgress = document.getElementById(`progress-${currentIndex}`);
          if (currentProgress) {
            currentProgress.style.transition = 'none';
          }
        }, 500);
      }
    };
    statusViewer.onmouseup = statusViewer.ontouchend = () => {
      clearTimeout(holdTimer);
      if (isPaused) {
        isPaused = false;
        showStatus(currentIndex);
        if (statusVideo.style.display === 'block') {
          statusVideo.play();
        }
      }
    };

    showStatus(currentIndex);
  }

  function loadUserProfile(userId) {
    showShimmer(1);
    const userRef = ref(db, `users/${userId}`);
    onValue(userRef, (snapshot) => {
      userAvatar.innerHTML = '';
      userName.textContent = 'Loading...';
      if (snapshot.exists()) {
        const user = snapshot.val();
        const firstLetter = user.name ? user.name.charAt(0) : 'U';
        userAvatar.innerHTML = user.avatar ? `<img src="${user.avatar}" alt="Avatar" />` : firstLetter;
        userName.textContent = user.name || 'Unknown';
      } else {
        userAvatar.innerHTML = 'U';
        userName.textContent = 'Unknown';
      }
    }, { onlyOnce: true }, (error) => {
      console.error("Error fetching user profile:", error);
      window.showAlert("Failed to load profile.", false);
    });
  }

  function loadChats(userId) {
    showShimmer();
    const friendsRef = ref(db, `friends/${userId}`);
    onValue(friendsRef, (friendSnapshot) => {
      if (friendSnapshot.exists()) {
        friendsData = [];
        const friendIds = Object.keys(friendSnapshot.val());
        let loadedCount = 0;
        friendIds.forEach(friendId => {
          const userRef = ref(db, `users/${friendId}`);
          onValue(userRef, (userSnapshot) => {
            if (userSnapshot.exists()) {
              const user = userSnapshot.val();
              const chatId = userId < friendId ? `${userId}_${friendId}` : `${friendId}_${userId}`;
              const chatRef = ref(db, `chats/${chatId}`);
              onValue(chatRef, (chatSnapshot) => {
                const chat = chatSnapshot.exists() ? chatSnapshot.val() : {};
                friendsData = friendsData.filter(f => f.uid !== friendId);
                friendsData.push({
                  uid: friendId,
                  name: user.name,
                  avatar: user.avatar,
                  lastMessage: chat.lastMessage,
                  timestamp: chat.timestamp,
                  unreadCount: chat.unreadCount ? chat.unreadCount[userId] || 0 : 0
                });
                loadedCount++;
                if (loadedCount === friendIds.length) {
                  renderChats(friendsData);
                }
              }, { onlyOnce: true }, (error) => {
                console.error("Error fetching chat:", error);
                window.showAlert("Failed to load chat data.", false);
              });
            }
          }, { onlyOnce: true }, (error) => {
            console.error("Error fetching user:", error);
            window.showAlert("Failed to load friend data.", false);
          });
        });
      } else {
        friendsData = [];
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No friends added yet.</p>';
      }
    }, { onlyOnce: true }, (error) => {
      console.error("Error fetching friends:", error);
      window.showAlert("Failed to load friends. Please try again.", false);
    });
  }

  function loadUsers(userId) {
    showShimmer();
    const usersRef = ref(db, 'users');
    onValue(usersRef, (snapshot) => {
      if (snapshot.exists()) {
        userList.innerHTML = '';
        const users = snapshot.val();
        const friendRef = ref(db, `friends/${userId}`);
        onValue(friendRef, (friendSnapshot) => {
          const friendIds = friendSnapshot.exists() ? Object.keys(friendSnapshot.val()) : [];
          suggestedFriends = [];
          Object.entries(users).forEach(([uid, user]) => {
            if (uid !== userId) {
              const userItem = document.createElement('div');
              userItem.className = 'user-item';
              const firstLetter = user.name ? user.name.charAt(0) : 'U';
              const avatarContent = user.avatar ? `<img src="${user.avatar}" alt="Avatar" />` : firstLetter;
              userItem.innerHTML = `
                <div class="user-avatar">${avatarContent}</div>
                <div class="user-info">
                  <h3 class="user-name">${user.name || 'Unknown'}</h3>
                </div>
                <button class="add-btn" data-uid="${uid}" ${friendIds.includes(uid) ? 'disabled' : ''}>
                  ${friendIds.includes(uid) ? 'Added' : 'Add'}
                </button>
              `;
              userList.appendChild(userItem);
              if (!friendIds.includes(uid)) {
                suggestedFriends.push({ uid, name: user.name, avatar: user.avatar });
              }
            }
          });
          document.querySelectorAll('.add-btn').forEach(button => {
            button.addEventListener('click', async () => {
              const friendUid = button.getAttribute('data-uid');
              try {
                await set(ref(db, `friends/${userId}/${friendUid}`), true);
                button.textContent = 'Added';
                button.disabled = true;
                window.showAlert(`Added ${users[friendUid].name} as a friend!`, true);
                suggestedFriends = suggestedFriends.filter(f => f.uid !== friendUid);
              } catch (error) {
                console.error("Error adding friend:", error);
                window.showAlert("Failed to add friend. Please try again.", false);
              }
            });
          });
        }, { onlyOnce: true }, (error) => {
          console.error("Error checking friends:", error);
          window.showAlert("Failed to load friend status.", false);
        });
      } else {
        userList.innerHTML = '<p style="text-align: center; padding: 1rem;">No users available.</p>';
      }
    }, { onlyOnce: true }, (error) => {
      console.error("Error fetching users:", error);
      window.showAlert("Failed to load users. Please try again.", false);
    });
  }

  function loadStatuses(userId, userProfile) {
    showShimmer();
    const statusesRef = ref(db, 'statuses');
    onValue(statusesRef, (snapshot) => {
      if (snapshot.exists()) {
        const statuses = snapshot.val();
        renderStatuses(statuses, userId, userProfile);
      } else {
        renderStatuses({}, userId, userProfile);
      }
    }, { onlyOnce: true }, (error) => {
      console.error("Error fetching statuses:", error);
      window.showAlert("Failed to load statuses. Please try again.", false);
    });
  }

  function handleTabSwitch(event) {
    tabItems.forEach(item => item.classList.remove('active'));
    event.target.classList.add('active');
    currentTab = event.target.getAttribute('data-tab');
    searchBar.classList.remove("active");
    // Update FAB icon and behavior
    if (currentTab === 'status') {
      fabIcon.innerHTML = `<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18l-2-2 6-6-6-6 2-2 8 8-8 8z" />`; // Camera icon
      fab.onclick = () => statusUpload.click();
    } else {
      fabIcon.innerHTML = `<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13h-4v4h-2v-4H7v-2h4V7h2v6h4v2z" />`; // Plus icon
      fab.onclick = window.showBottomSheet;
    }
    if (currentTab === 'chats') {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          loadChats(user.uid);
        } else {
          window.showAlert("Please sign in to view chats.", false);
          chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Please sign in to view chats.</p>';
        }
      });
    } else if (currentTab === 'status') {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const userRef = ref(db, `users/${user.uid}`);
          onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
              loadStatuses(user.uid, snapshot.val());
            } else {
              window.showAlert("Failed to load user profile.", false);
            }
          }, { onlyOnce: true });
        } else {
          window.showAlert("Please sign in to view statuses.", false);
          chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Please sign in to view statuses.</p>';
        }
      });
    } else if (currentTab === 'calls') {
      chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Calls section coming soon!</p>';
    }
  }

  // Handle FAB status upload
  statusUpload.onchange = () => {
    const file = statusUpload.files[0];
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const userRef = ref(db, `users/${user.uid}`);
        onValue(userRef, (snapshot) => {
          if (snapshot.exists()) {
            uploadStatus(file, user.uid, snapshot.val());
          } else {
            window.showAlert("Failed to load user profile.", false);
          }
        }, { onlyOnce: true });
      } else {
        window.showAlert("Please sign in to upload a status.", false);
      }
    });
  };

  tabItems.forEach(item => {
    item.addEventListener('click', handleTabSwitch);
  });

  document.addEventListener("DOMContentLoaded", () => {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadUserProfile(user.uid);
        loadChats(user.uid);
        loadUsers(user.uid);
      } else {
        window.showAlert("Please sign in to view chats and add friends.", false);
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Please sign in to view chats.</p>';
        userList.innerHTML = '<p style="text-align: center; padding: 1rem;">Please sign in to add friends.</p>';
        userAvatar.innerHTML = 'U';
        userName.textContent = 'Sign In';
      }
    });
  });
</script>
        
      
</body>
</html>
