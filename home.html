<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Vynix Snake</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --vynix-purple: #7C3AED;
      --vynix-orange: #F97316;
      --text-dark: #1F2937;
      --text-light: #6B7280;
      --border: #E5E7EB;
      --white: #FFFFFF;
      --background: linear-gradient(135deg, #F3E8FF 0%, #FED7AA 100%);
      --card-bg: #FFFFFF;
      --text-dark-dark: #FFFFFF;
      --text-light-dark: #9CA3AF;
      --border-dark: #374151;
      --card-bg-dark: #1F2937;
      --highlight: #F3F4F6;
    }

    [data-theme="dark"] {
      --background: linear-gradient(135deg, #4B0082 0%, #B45309 100%);
      --text-dark: var(--text-dark-dark);
      --text-light: var(--text-light-dark);
      --border: var(--border-dark);
      --card-bg: var(--card-bg-dark);
      --highlight: #374151;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s ease;
    }

    .top-bar {
      background: var(--vynix-purple);
      padding: 1rem;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--white);
      border-radius: 12px;
    }

    .top-bar-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .score-container {
      display: flex;
      gap: 1rem;
      font-size: 1rem;
      font-weight: 500;
    }

    .game-container {
      margin: 1rem 0;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      border: 4px solid var(--vynix-purple);
    }

    canvas {
      display: block;
      border-radius: 8px;
      background: #111827;
    }

    .controls {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }

    .btn {
      background: var(--vynix-purple);
      color: var(--white);
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .btn:hover, .btn:focus {
      background: #6D28D9;
      transform: scale(1.05);
    }

    .leaderboard {
      width: 100%;
      max-width: 600px;
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      margin-top: 1rem;
    }

    .leaderboard h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .leaderboard-item:last-child {
      border-bottom: none;
    }

    .skeleton {
      background: linear-gradient(90deg, var(--highlight) 25%, #e5e7eb 50%, var(--highlight) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 8px;
      height: 1.5rem;
      margin: 0.5rem 0;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .game-over-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .game-over-modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      max-width: 90%;
      width: 400px;
      text-align: center;
      border: 2px solid var(--vynix-purple);
      animation: slideIn 0.3s ease-out;
    }

    .modal-content h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1rem;
    }

    .modal-content input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--highlight);
      font-family: 'Poppins', sans-serif;
    }

    .modal-content .btn {
      margin: 0.5rem;
    }

    .custom-alert {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      color: var(--text-dark);
      font-weight: 500;
      text-align: center;
      max-width: 90%;
      width: 320px;
      animation: slideIn 0.3s ease-out;
      border: 1px solid var(--border);
    }

    .custom-alert.active {
      display: block;
    }

    .custom-alert .close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: var(--vynix-purple);
      cursor: pointer;
    }

    @keyframes slideIn {
      0% { opacity: 0; transform: translate(-50%, -60%); }
      100% { opacity: 1; transform: translate(-50%, -50%); }
    }

    @media (max-width: 767px) {
      .game-container {
        padding: 0.5rem;
      }
      canvas {
        width: 400px !important;
        height: 400px !important;
      }
      .top-bar {
        padding: 0.75rem;
      }
      .top-bar-title {
        font-size: 1.25rem;
      }
      .score-container {
        font-size: 0.9rem;
      }
      .btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar" role="banner">
    <span class="top-bar-title">Vynix Snake</span>
    <div class="score-container">
      <span id="score">Score: 0</span>
      <span id="high-score">High Score: 0</span>
    </div>
  </div>
  <div class="game-container">
    <canvas id="gameCanvas" width="600" height="600"></canvas>
    <div class="controls">
      <button class="btn" id="startBtn" aria-label="Start or restart game">Start Game</button>
    </div>
  </div>
  <div class="leaderboard" role="region" aria-label="High Scores">
    <h2>Leaderboard</h2>
    <div id="leaderboard-container"></div>
  </div>
  <div id="game-over-modal" class="game-over-modal" role="dialog" aria-label="Game Over">
    <div class="modal-content">
      <h2>Game Over</h2>
      <p>Your Score: <span id="final-score"></span></p>
      <input type="text" id="player-name" placeholder="Enter your name" aria-label="Player name for high score" />
      <button class="btn" id="save-score-btn" aria-label="Save score to leaderboard">Save Score</button>
      <button class="btn" id="restart-btn" aria-label="Restart game">Restart</button>
    </div>
  </div>
  <div id="custom-alert" class="custom-alert" role="alert">
    <button class="close-btn" aria-label="Close alert">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <p id="alert-message">An error occurred. Please try again later.</p>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getDatabase, ref, push, get, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");
    const scoreDisplay = document.getElementById("score");
    const highScoreDisplay = document.getElementById("highScore");
    const leaderboardContainer = document.getElementById("leaderboard-container");
    const gameOverModal = document.getElementById("game-over-modal");
    const finalScoreDisplay = document.getElementById("final-score");
    const playerNameInput = document.getElementById("player-name");
    const saveScoreBtn = document.getElementById("save-score-btn");
    const restartBtn = document.getElementById("restart-btn");
    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");

    const gridSize = 20;
    const tileCount = canvas.width / gridSize;
    let snake = [{ x: 10, y: 10 }];
    let food = { x: 15, y: 15 };
    let specialFood = null;
    let dx = 0;
    let dy = 0;
    let score = 0;
    let highScore = 0;
    let gameLoop;
    let touchStartX = 0;
    let touchStartY = 0;

    function showAlert(message, autoHide = true) {
      alertMessage.textContent = message;
      customAlert.classList.add("active");
      if (autoHide) setTimeout(() => customAlert.classList.remove("active"), 5000);
    }

    document.querySelector(".custom-alert .close-btn").addEventListener("click", () => customAlert.classList.remove("active"));

    function resizeCanvas() {
      const isMobile = window.innerWidth <= 767;
      canvas.width = isMobile ? 400 : 600;
      canvas.height = isMobile ? 400 : 600;
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function drawGame() {
      ctx.fillStyle = "#111827";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw snake
      snake.forEach((segment, index) => {
        ctx.fillStyle = index === 0 ? "#F97316" : "#7C3AED";
        ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
      });

      // Draw food
      ctx.fillStyle = "#F97316";
      ctx.beginPath();
      ctx.arc(food.x * gridSize + gridSize / 2, food.y * gridSize + gridSize / 2, gridSize / 2 - 2, 0, Math.PI * 2);
      ctx.fill();

      // Draw special food
      if (specialFood) {
        ctx.fillStyle = "#FFD700";
        ctx.beginPath();
        ctx.arc(specialFood.x * gridSize + gridSize / 2, specialFood.y * gridSize + gridSize / 2, gridSize / 2 - 2, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function moveSnake() {
      const head = { x: snake[0].x + dx, y: snake[0].y + dy };

      // Check collision with walls
      if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
        gameOver();
        return;
      }

      // Check collision with self
      if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
        gameOver();
        return;
      }

      snake.unshift(head);

      // Check if food eaten
      if (head.x === food.x && head.y === food.y) {
        score += 10;
        scoreDisplay.textContent = `Score: ${score}`;
        if (score > highScore) {
          highScore = score;
          highScoreDisplay.textContent = `High Score: ${highScore}`;
        }
        generateFood();
      } else if (specialFood && head.x === specialFood.x && head.y === specialFood.y) {
        score += 50;
        scoreDisplay.textContent = `Score: ${score}`;
        if (score > highScore) {
          highScore = score;
          highScoreDisplay.textContent = `High Score: ${highScore}`;
        }
        specialFood = null;
      } else {
        snake.pop();
      }
    }

    function generateFood() {
      food = {
        x: Math.floor(Math.random() * tileCount),
        y: Math.floor(Math.random() * tileCount)
      };
      if (snake.some(segment => segment.x === food.x && segment.y === food.y)) {
        generateFood();
      }
      if (Math.random() < 0.1) {
        specialFood = {
          x: Math.floor(Math.random() * tileCount),
          y: Math.floor(Math.random() * tileCount)
        };
        if (snake.some(segment => segment.x === specialFood.x && segment.y === specialFood.y) || (specialFood.x === food.x && specialFood.y === food.y)) {
          specialFood = null;
        }
      }
    }

    function gameOver() {
      clearInterval(gameLoop);
      finalScoreDisplay.textContent = score;
      gameOverModal.classList.add("active");
    }

    function startGame() {
      snake = [{ x: 10, y: 10 }];
      dx = 0;
      dy = 0;
      score = 0;
      scoreDisplay.textContent = `Score: ${score}`;
      generateFood();
      specialFood = null;
      gameOverModal.classList.remove("active");
      gameLoop = setInterval(() => {
        moveSnake();
        drawGame();
      }, 100);
    }

    document.addEventListener("keydown", (e) => {
      switch (e.key) {
        case "ArrowUp":
        case "w":
          if (dy !== 1) { dx = 0; dy = -1; }
          break;
        case "ArrowDown":
        case "s":
          if (dy !== -1) { dx = 0; dy = 1; }
          break;
        case "ArrowLeft":
        case "a":
          if (dx !== 1) { dx = -1; dy = 0; }
          break;
        case "ArrowRight":
        case "d":
          if (dx !== -1) { dx = 1; dy = 0; }
          break;
        case "Enter":
          if (gameOverModal.classList.contains("active")) {
            startGame();
          }
          break;
        case "Escape":
          gameOverModal.classList.remove("active");
          break;
      }
    });

    canvas.addEventListener("touchstart", (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    });

    canvas.addEventListener("touchmove", (e) => {
      const touchEndX = e.touches[0].clientX;
      const touchEndY = e.touches[0].clientY;
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;

      if (Math.abs(deltaX) > Math.abs(deltaY)) {
        if (deltaX > 50 && dx !== -1) { dx = 1; dy = 0; }
        else if (deltaX < -50 && dx !== 1) { dx = -1; dy = 0; }
      } else {
        if (deltaY > 50 && dy !== -1) { dx = 0; dy = 1; }
        else if (deltaY < -50 && dy !== 1) { dx = 0; dy = -1; }
      }

      touchStartX = touchEndX;
      touchStartY = touchEndY;
    });

    async function fetchHighScores() {
      try {
        leaderboardContainer.innerHTML = Array(5).fill().map(() => `<div class="skeleton"></div>`).join("");
        const highScoresRef = query(ref(db, "highscores/snake"), limitToLast(10));
        onValue(highScoresRef, (snapshot) => {
          const scores = [];
          if (snapshot.exists()) {
            snapshot.forEach(scoreSnap => {
              scores.push({ id: scoreSnap.key, ...scoreSnap.val() });
            });
            scores.sort((a, b) => b.score - a.score);
          }
          renderHighScores(scores.slice(0, 10));
        }, { onlyOnce: false });
      } catch (error) {
        console.error("Error fetching high scores:", error);
        leaderboardContainer.innerHTML = `<p class="text-[var(--text-light)] text-center">Failed to load leaderboard</p>`;
        showAlert("Failed to load leaderboard", false);
      }
    }

    function renderHighScores(scores) {
      leaderboardContainer.innerHTML = "";
      if (scores.length === 0) {
        leaderboardContainer.innerHTML = `<p class="text-[var(--text-light)] text-center">No high scores yet</p>`;
        return;
      }
      scores.forEach((score, index) => {
        const item = document.createElement("div");
        item.className = "leaderboard-item";
        item.innerHTML = `
          <span>${index + 1}. ${DOMPurify.sanitize(score.name)}</span>
          <span>${score.score}</span>
        `;
        leaderboardContainer.appendChild(item);
      });
    }

    startBtn.addEventListener("click", startGame);

    restartBtn.addEventListener("click", startGame);

    saveScoreBtn.addEventListener("click", async () => {
      const name = playerNameInput.value.trim();
      if (!name) {
        showAlert("Please enter a name", false);
        return;
      }
      try {
        await push(ref(db, "highscores/snake"), {
          name: DOMPurify.sanitize(name),
          score,
          timestamp: Date.now()
        });
        playerNameInput.value = "";
        gameOverModal.classList.remove("active");
        showAlert("Score saved successfully", true);
      } catch (error) {
        showAlert("Failed to save score", false);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        signInAnonymously(auth).catch(error => {
          showAlert("Authentication failed", false);
        });
      } else {
        fetchHighScores();
      }
    });
  </script>
</body>
</html>
