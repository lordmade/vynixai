<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Bolt Ride - Explore</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback for fetch polyfill
    if (!window.fetch) {
      document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js"></script>');
    }
  </script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js" onerror="handleMapboxError()"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root {
      --bolt-blue: #00A3E0;
      --bolt-dark: #1A1A1A;
      --bolt-white: #FFFFFF;
      --text-light: #A0A0A0;
      --shadow: rgba(0, 0, 0, 0.3);
      --accent-green: #34C759;
      --accent-red: #FF3B30;
      --accent-purple: #5856D6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--bolt-dark);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      height: 100vh;
      width: 100vw;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-sizing: border-box;
      pointer-events: none;
    }

    .search-container {
      background: var(--bolt-white);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      box-shadow: 0 4px 16px var(--shadow);
      max-width: 450px;
      width: 100%;
      margin: 0 auto;
      pointer-events: auto;
      display: flex;
      align-items: center;
      transition: box-shadow 0.3s ease, transform 0.2s ease;
    }

    .search-container:focus-within {
      box-shadow: 0 6px 20px rgba(0, 163, 224, 0.4);
      transform: translateY(-2px);
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 0.75rem 0.75rem 2.5rem;
      border: none;
      border-radius: 9999px;
      font-size: 16px;
      outline: none;
      background: transparent;
      color: var(--bolt-dark);
    }

    .search-input::placeholder {
      color: var(--text-light);
    }

    .search-icon {
      width: 20px;
      height: 20px;
      fill: var(--text-light);
      position: absolute;
      left: 1.25rem;
    }

    .results-container {
      background: var(--bolt-white);
      border-radius: 12px;
      max-height: 250px;
      overflow-y: auto;
      margin-top: 0.5rem;
      box-shadow: 0 4px 16px var(--shadow);
      pointer-events: auto;
      display: none;
      max-width: 450px;
      width: 100%;
      margin: 0.5rem auto;
    }

    .result-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.2s ease;
    }

    .result-item:hover {
      background: #f0f0f0;
    }

    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--bolt-dark);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 -2px 12px var(--shadow);
      z-index: 20;
      padding: 0.75rem 0;
    }

    .bottom-nav ul {
      display: flex;
      justify-content: space-around;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .bottom-nav li {
      flex: 1;
      text-align: center;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
      color: var(--text-light);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.3s ease, transform 0.2s ease;
      pointer-events: auto;
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      fill: var(--text-light);
      margin-bottom: 0.25rem;
      transition: fill 0.3s ease, transform 0.2s ease;
    }

    .nav-item.active,
    .nav-item:hover {
      color: var(--bolt-blue);
      transform: scale(1.1);
    }

    .nav-item.active svg,
    .nav-item:hover svg {
      fill: var(--bolt-blue);
      transform: scale(1.1);
    }

    .error-message {
      background: var(--accent-red);
      color: var(--bolt-white);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      margin: 1rem auto;
      max-width: 450px;
      pointer-events: auto;
      box-shadow: 0 4px 16px var(--shadow);
    }

    .landmark-marker {
      width: 32px;
      height: 32px;
      background-size: cover;
      cursor: pointer;
    }

    .landmark-marker.police {
      background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="%2300A3E0" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L3 9v12h18V9l-9-7zm0 2.83L18 10H6l6-5.17zM6 12h12v2H6v-2zm0 4h12v2H6v-2z"/></svg>');
    }

    .landmark-marker.hospital {
      background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="%23FF3B30" xmlns="http://www.w3.org/2000/svg"><path d="M18 21H6V3h12v18zm-5-12h-2v3H8v2h3v3h2v-3h3v-2h-3V9z"/></svg>');
    }

    .landmark-marker.shopping {
      background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="%2334C759" xmlns="http://www.w3.org/2000/svg"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM17 18c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zM8 13l4-6 4 6H8zM16.5 3h-9L6 9h12l-1.5-6z"/></svg>');
    }

    .landmark-marker.atm {
      background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" fill="%235856D6" xmlns="http://www.w3.org/2000/svg"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-4H6v-2h12v2zm0-4H6V6h12v2z"/></svg>');
    }

    .user-location-marker {
      background: var(--bolt-blue);
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--bolt-white);
      box-shadow: 0 0 8px var(--shadow);
      cursor: pointer;
    }

    @media (max-width: 640px) {
      .bottom-nav {
        display: block;
      }

      .search-container {
        max-width: 100%;
        padding: 0.5rem 0.75rem;
      }

      .search-input {
        font-size: 16px;
        padding: 0.5rem 0.5rem 0.5rem 2.25rem;
      }

      .search-icon {
        width: 18px;
        height: 18px;
        left: 1rem;
      }

      .results-container {
        max-width: 100%;
      }

      .landmark-marker {
        width: 24px;
        height: 24px;
      }

      .user-location-marker {
        width: 12px;
        height: 12px;
      }

      #map {
        height: calc(100% - 64px);
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="overlay">
    <div class="search-container">
      <svg class="search-icon" viewBox="0 0 24 24">
        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
      <input type="text" class="search-input" id="search" placeholder="Search for police stations, hospitals, malls, ATMs..." aria-label="Search locations" />
      <div class="results-container" id="search-results"></div>
    </div>
    <div id="error-message" class="error-message" style="display: none;"></div>
  </div>
  <nav class="bottom-nav">
    <ul>
      <li>
        <div class="nav-item active" onclick="navigate('home')">
          <svg viewBox="0 0 24 24">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
          </svg>
          <span>Home</span>
        </div>
      </li>
      <li>
        <div class="nav-item" onclick="navigate('search')">
          <svg viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
          <span>Search</span>
        </div>
      </li>
      <li>
        <div class="nav-item" onclick="navigate('rides')">
          <svg viewBox="0 0 24 24">
            <path d="M21 3H3v18h18V3zm-2 16H5V5h14v14zM10 7H7v2h3V7zm0 4H7v2h3v-2zm0 4H7v2h3v-2zm7-8h-3v6h3V7zm0 8h-3v2h3v-2z"/>
          </svg>
          <span>Rides</span>
        </div>
      </li>
      <li>
        <div class="nav-item" onclick="navigate('profile')">
          <svg viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          <span>Profile</span>
        </div>
      </li>
    </ul>
  </nav>

  <script>
    // Error handling for Mapbox script load failure
    function handleMapboxError() {
      showError('Failed to load Mapbox GL JS. Please check your network and try again.');
    }

    // Display error message
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    // Mapbox access token
    const accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw'; // Replace with your valid token
    if (!accessToken || accessToken === 'YOUR_MAPBOX_ACCESS_TOKEN') {
      showError('Error: Invalid Mapbox access token.');
      throw new Error('Invalid Mapbox access token');
    }
    mapboxgl.accessToken = accessToken;

    // Initialize map with custom style
    let map;
    try {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11', // Dark, vibrant style
        zoom: 14,
        center: [28.0473, -26.2041], // Default: Johannesburg
        pitch: 45, // Slight 3D effect
        bearing: -17.6 // Subtle rotation for dynamic look
      });
    } catch (error) {
      showError('Error: Failed to initialize Mapbox map. Check your network or access token.');
      console.error('Mapbox initialization error:', error);
      return;
    }

    map.on('error', (e) => {
      console.error('Mapbox error:', e);
      showError('Failed to load map. Try refreshing or using a different device.');
    });

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // Add geolocation control
    const geolocate = new mapboxgl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    });
    map.addControl(geolocate, 'top-right');

    let currentMarker = null;
    let landmarkMarkers = [];
    map.on('load', () => {
      try {
        // Optimize map for performance
        map.setConfigProperty('basemap', 'show3DBuildings', true);

        // Add user location on focus
        const searchInput = document.getElementById('search');
        searchInput.addEventListener('focus', () => {
          try {
            geolocate.trigger();
          } catch (error) {
            console.error('Geolocation trigger error:', error);
            showError('Unable to request location. Please enable location services.');
          }
        });

        // Add initial landmarks near default location
        addLandmarks([28.0473, -26.2041]);
      } catch (error) {
        console.error('Map load error:', error);
        showError('Error initializing map features.');
      }
    });

    geolocate.on('geolocate', (e) => {
      try {
        const lon = e.coords.longitude;
        const lat = e.coords.latitude;

        map.flyTo({ center: [lon, lat], duration: 1000 });

        if (currentMarker) {
          currentMarker.remove();
        }

        const markerEl = document.createElement('div');
        markerEl.className = 'user-location-marker';
        currentMarker = new mapboxgl.Marker({
          element: markerEl,
          anchor: 'center'
        })
          .setLngLat([lon, lat])
          .addTo(map);

        reverseGeocode([lon, lat]).then(address => {
          document.getElementById('search').value = address || 'Current Location';
        });

        // Update landmarks near user
        addLandmarks([lon, lat]);
      } catch (error) {
        console.error('Geolocation handling error:', error);
        showError('Error processing location data.');
      }
    });

    geolocate.on('error', (e) => {
      console.error('Geolocation error:', e);
      showError('Unable to access location. Please enable location services or enter manually.');
      map.flyTo({ center: [28.0473, -26.2041], duration: 1000 });
    });

    async function reverseGeocode(coordinates, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${coordinates[0]},${coordinates[1]}.json?access_token=${mapboxgl.accessToken}`
          );
          if (!response.ok) {
            throw new Error(`Geocoding request failed: ${response.status}`);
          }
          const data = await response.json();
          return data.features && data.features.length > 0 ? data.features[0].place_name : null;
        } catch (error) {
          console.error(`Reverse geocoding attempt ${i + 1} failed:`, error);
          if (i === retries - 1) return null;
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    async function searchLocations(query, userCoords) {
      try {
        const types = 'poi';
        const poiCategories = ['police', 'hospital', 'shopping', 'atm'];
        const proximity = userCoords ? `${userCoords[0]},${userCoords[1]}` : '';
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&types=${types}&poi_category=${poiCategories.join(',')}&limit=10${proximity ? `&proximity=${proximity}` : ''}`;
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Search request failed: ${response.status}`);
        }
        const data = await response.json();
        return data.features || [];
      } catch (error) {
        console.error('Search error:', error);
        showError('Error searching for locations. Try again.');
        return [];
      }
    }

    async function addLandmarks(userCoords) {
      try {
        // Clear existing landmarks
        landmarkMarkers.forEach(marker => marker.remove());
        landmarkMarkers = [];

        // Search for POIs
        const poiCategories = ['police', 'hospital', 'shopping', 'atm'];
        for (const category of poiCategories) {
          const results = await searchLocations(category, userCoords);
          results.forEach(feature => {
            const categoryType = feature.properties.category.split(',')[0].trim();
            const markerEl = document.createElement('div');
            markerEl.className = `landmark-marker ${categoryType}`;
            const marker = new mapboxgl.Marker({
              element: markerEl,
              anchor: 'center'
            })
              .setLngLat(feature.geometry.coordinates)
              .setPopup(
                new mapboxgl.Popup({ offset: 25 })
                  .setHTML(`<h3>${feature.place_name}</h3><p>${categoryType.charAt(0).toUpperCase() + categoryType.slice(1)}</p>`)
              )
              .addTo(map);
            landmarkMarkers.push(marker);
          });
        }
      } catch (error) {
        console.error('Landmark error:', error);
        showError('Error loading landmarks.');
      }
    }

    const searchInput = document.getElementById('search');
    const resultsContainer = document.getElementById('search-results');

    let debounceTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(async () => {
        try {
          const query = searchInput.value.trim();
          if (query.length < 3) {
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
            return;
          }

          const userCoords = currentMarker ? currentMarker.getLngLat().toArray() : [28.0473, -26.2041];
          const results = await searchLocations(query, userCoords);

          resultsContainer.innerHTML = '';
          if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="result-item">No results found</div>';
          } else {
            results.forEach(feature => {
              const div = document.createElement('div');
              div.className = 'result-item';
              div.textContent = feature.place_name;
              div.onclick = () => {
                try {
                  map.flyTo({ center: feature.geometry.coordinates, duration: 1000 });
                  if (currentMarker) {
                    currentMarker.remove();
                  }
                  const markerEl = document.createElement('div');
                  markerEl.className = `landmark-marker ${feature.properties.category.split(',')[0].trim()}`;
                  currentMarker = new mapboxgl.Marker({
                    element: markerEl,
                    anchor: 'center'
                  })
                    .setLngLat(feature.geometry.coordinates)
                    .setPopup(
                      new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`<h3>${feature.place_name}</h3><p>${feature.properties.category.split(',')[0].trim().charAt(0).toUpperCase() + feature.properties.category.split(',')[0].trim().slice(1)}</p>`)
                    )
                    .addTo(map)
                    .showPopup();
                  searchInput.value = feature.place_name;
                  resultsContainer.style.display = 'none';
                  addLandmarks(feature.geometry.coordinates);
                } catch (error) {
                  console.error('Marker placement error:', error);
                  showError('Error selecting location.');
                }
              };
              resultsContainer.appendChild(div);
            });
          }
          resultsContainer.style.display = 'block';
        } catch (error) {
          console.error('Search input error:', error);
          showError('Error processing search.');
        }
      }, 300);
    });

    function navigate(page) {
      try {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        event.currentTarget.classList.add('active');
        alert(`Navigating to ${page} page. Implement navigation logic here.`);
      } catch (error) {
        console.error('Navigation error:', error);
        showError('Error navigating to page.');
      }
    }
  </script>
</body>
</html>
