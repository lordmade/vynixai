<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix - Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --background: #F9FAFB;
      --card-bg: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --border: #E5E7EB;
      --accent: #10B981;
      --accent-dark: #059669;
      --gradient-start: #6EE7B7;
      --gradient-end: #10B981;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
      --alert-success: #10B981;
      --alert-error: #EF4444;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 600;
      background: var(--card-bg);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-avatar:hover {
      transform: scale(1.1);
    }

    .tab-container {
      display: flex;
      gap: 0.5rem;
      flex: 1;
      justify-content: center;
    }

    .tab-item {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-secondary);
      position: relative;
      transition: color 0.3s ease;
    }

    .tab-item.active {
      color: var(--text-primary);
    }

    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      border-radius: 2px;
    }

    .tab-item:hover {
      color: var(--text-primary);
    }

    .search-container {
      padding: 0.75rem;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
    }

    #search-input {
      width: 100%;
      padding: 0.65rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      background: #F9FAFB;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
    }

    #search-input:focus {
      border-color: var(--accent);
    }

    .chat-list, .status-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .chat-item, .room-item, .group-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chat-item:hover, .room-item:hover, .group-item:hover {
      background: #F3F4F6;
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 600;
      background: var(--card-bg);
      overflow: hidden;
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 0 0 4px var(--gradient-start);
    }

    .business-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 600;
      background: var(--card-bg);
      overflow: hidden;
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .business-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .business-preview:hover {
      transform: scale(1.05);
      box-shadow: 0 0 0 4px var(--gradient-start);
    }

    .chat-info {
      flex: 1;
      margin-left: 0.75rem;
    }

    .chat-name {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
    }

    .chat-message {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0;
    }

    .chat-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .kebab-menu {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
      transition: color 0.2s ease;
    }

    .kebab-menu:hover {
      color: var(--accent);
    }

    .kebab-menu svg {
      width: 20px;
      height: 20px;
    }

    .context-menu {
      position: absolute;
      right: 1rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 10;
    }

    .context-menu.active {
      display: block;
    }

    .context-menu-item {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .context-menu-item:hover {
      background: #F3F4F6;
    }

    .fab {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .fab:hover {
      transform: scale(1.1);
    }

    .fab svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: #FFFFFF;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .fab-label {
      position: absolute;
      right: 68px;
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
      box-shadow: var(--shadow);
      display: none;
    }

    .fab:hover .fab-label {
      display: block;
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
    }

    .bottom-sheet.active {
      transform: translateY(0);
    }

    .bottom-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .bottom-sheet-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-primary);
      transition: color 0.2s ease;
    }

    .close-btn:hover {
      color: var(--accent);
    }

    .close-btn svg {
      width: 24px;
      height: 24px;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 0.65rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      background: #F9FAFB;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-color: var(--accent);
    }

    .input-group select[multiple] {
      height: 120px;
    }

    .btn {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .status-card {
      background: var(--card-bg);
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .status-card:hover {
      transform: translateY(-4px);
    }

    .status-card-header {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .status-card-media {
      width: 100%;
      max-height: 400px;
      object-fit: cover;
    }

    .status-card-video {
      width: 100%;
      max-height: 400px;
      object-fit: cover;
    }

    .status-card-footer {
      padding: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-card-info {
      flex: 1;
      margin-left: 0.75rem;
    }

    .status-card-name {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
    }

    .status-card-time {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0;
    }

    .like-btn {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-primary);
      transition: color 0.2s ease;
    }

    .like-btn.liked {
      color: var(--alert-error);
    }

    .like-btn:hover {
      color: var(--accent);
    }

    .like-btn svg {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .like-count {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    .status-viewer.active {
      display: flex;
    }

    .status-header {
      padding: 1rem;
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .status-media, .status-media-video {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 8px;
    }

    .reaction-btns {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .reaction-btn {
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #FFFFFF;
      transition: transform 0.2s ease;
    }

    .reaction-btn:hover {
      transform: scale(1.1);
    }

    .reaction-btn svg {
      width: 20px;
      height: 20px;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .custom-alert.active {
      display: flex;
    }

    .alert-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow);
      animation: slideUp 0.3s ease;
    }

    .alert-content.success {
      border: 2px solid var(--alert-success);
    }

    .alert-content.error {
      border: 2px solid var(--alert-error);
    }

    .alert-content p {
      margin: 0 0 1rem;
      font-size: 1rem;
      font-weight: 500;
    }

    .alert-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }

    .alert-buttons button {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
    }

    #alert-ok {
      background: var(--accent);
      color: #FFFFFF;
    }

    #alert-cancel {
      background: var(--border);
      color: var(--text-primary);
    }

    progress {
      width: 100%;
      height: 4px;
      border-radius: 2px;
      margin-top: 0.5rem;
      background: var(--border);
    }

    progress::-webkit-progress-bar {
      background: var(--border);
      border-radius: 2px;
    }

    progress::-webkit-progress-value {
      background: var(--accent);
      border-radius: 2px;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 640px) {
      .header { padding: 0.5rem; }
      .chat-list, .status-list { padding: 0.5rem; }
      .chat-item, .room-item, .group-item, .status-card { padding: 0.5rem; }
      .avatar { width: 40px; height: 40px; font-size: 1.25rem; }
      .business-preview { width: 100px; height: 100px; font-size: 2rem; }
      .chat-name, .status-card-name { font-size: 0.9rem; }
      .chat-message, .status-card-time, .chat-time { font-size: 0.8rem; }
      .fab { width: 48px; height: 48px; bottom: 1rem; right: 1rem; }
      .fab svg { width: 20px; height: 20px; }
      .fab-label { font-size: 0.8rem; padding: 0.4rem 0.8rem; right: 60px; }
      .bottom-sheet { padding: 1rem; }
      .bottom-sheet-header h2 { font-size: 1.1rem; }
      .input-group input, .input-group select { font-size: 0.85rem; padding: 0.5rem; }
      .btn { font-size: 0.85rem; padding: 0.65rem; }
      .status-card-media, .status-card-video { max-height: 300px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="user-avatar" id="user-avatar" onclick="window.location.href='profile.html'">U</div>
    <div class="tab-container">
      <div class="tab-item active" data-tab="chats">Chats</div>
      <div class="tab-item" data-tab="status">Status</div>
      <div class="tab-item" data-tab="rooms">Rooms</div>
      <div class="tab-item" data-tab="groups">Groups</div>
    </div>
    <div></div>
  </div>
  <div class="search-container">
    <input type="text" id="search-input" placeholder="Search..." aria-label="Search chats, statuses, rooms, or groups" />
  </div>
  <div class="chat-list" id="chat-list" role="list"></div>
  <div class="status-list" id="status-list" role="list" style="display: none;"></div>
  <div class="fab" id="fab">
    <svg id="fab-icon" viewBox="0 0 24 24">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
      <circle cx="9" cy="7" r="4"></circle>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
    </svg>
    <span class="fab-label" id="fab-label">Users</span>
  </div>
  <div class="bottom-sheet" id="user-slide">
    <div class="bottom-sheet-header">
      <h2>Add Friend</h2>
      <button class="close-btn" onclick="window.hideBottomSheet()" aria-label="Close add friend sheet">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="input-group">
      <input type="text" id="user-search-input" placeholder="Search users..." aria-label="Search users" />
    </div>
    <div id="user-list" role="list"></div>
  </div>
  <div class="bottom-sheet" id="room-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Room</h2>
      <button class="close-btn" onclick="window.hideRoomSheet()" aria-label="Close create room sheet">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="input-group">
      <label for="room-name">Room Name</label>
      <input type="text" id="room-name" placeholder="Enter room name" aria-label="Room name" />
    </div>
    <button class="btn" onclick="window.createRoom()">Create Room</button>
  </div>
  <div class="bottom-sheet" id="group-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Group</h2>
      <button class="close-btn" onclick="window.hideGroupSheet()" aria-label="Close create group sheet">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="input-group">
      <label for="group-name">Group Name</label>
      <input type="text" id="group-name" placeholder="Enter group name" aria-label="Group name" />
    </div>
    <div class="input-group">
      <label for="group-members">Select Members</label>
      <select id="group-members" multiple aria-label="Select group members"></select>
    </div>
    <button class="btn" onclick="window.createGroup()">Create Group</button>
  </div>
  <div class="status-viewer" id="status-viewer"></div>
  <input type="file" id="status-upload" accept="image/*,video/*" style="display: none;" aria-label="Upload status" />
  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-content">
      <p id="alert-message"></p>
      <progress id="status-progress" value="0" max="100" style="display: none;"></progress>
      <div id="alert-buttons" class="alert-buttons">
        <button id="alert-ok">Close</button>
        <button id="alert-cancel" style="display: none;">Cancel</button>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, set, remove, update, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const chatList = document.getElementById('chat-list');
    const statusList = document.getElementById('status-list');
    const searchInput = document.getElementById('search-input');
    const userSearchInput = document.getElementById('user-search-input');
    const statusUploadInput = document.getElementById('status-upload');
    const statusViewer = document.getElementById('status-viewer');
    const fab = document.getElementById('fab');
    const fabIcon = document.getElementById('fab-icon');
    const fabLabel = document.getElementById('fab-label');
    const userAvatar = document.getElementById('user-avatar');
    const tabItems = document.querySelectorAll('.tab-item');

    const CLOUDINARY_CLOUD_NAME = "dqkujefxj";
    const CLOUDINARY_UPLOAD_PRESET = "banter_box";
    const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

    const MESSAGES = {
      SIGN_IN_REQUIRED: "Please sign in to view this page.",
      FRIEND_REQUEST_SENT: "Friend request sent!",
      FRIEND_REQUEST_FAIL: "Failed to send friend request.",
      ROOM_CREATE_SUCCESS: "Room created successfully!",
      ROOM_CREATE_FAIL: "Failed to create room.",
      ROOM_DELETE_CONFIRM: "Are you sure you want to delete this room?",
      ROOM_DELETE_SUCCESS: "Room deleted successfully!",
      ROOM_DELETE_FAIL: "Failed to delete room.",
      GROUP_CREATE_SUCCESS: "Group created successfully!",
      GROUP_CREATE_FAIL: "Failed to create group.",
      GROUP_DELETE_CONFIRM: "Are you sure you want to delete this group?",
      GROUP_DELETE_SUCCESS: "Group deleted successfully!",
      GROUP_DELETE_FAIL: "Failed to delete group.",
      STATUS_UPLOAD_SUCCESS: "Status uploaded successfully!",
      STATUS_UPLOAD_FAIL: "Failed to upload status.",
      STATUS_DELETE_CONFIRM: "Are you sure you want to delete this status?",
      STATUS_DELETE_SUCCESS: "Status deleted successfully!",
      STATUS_DELETE_FAIL: "Failed to delete status.",
      FILE_SIZE_EXCEEDED: "File size exceeds 5MB limit.",
      INVALID_IMAGE: "Please select a valid image or video file.",
      STATUS_FAIL: "Failed to load statuses.",
      CHAT_FAIL: "Failed to load chats.",
      LIKE_FAIL: "Failed to update like status."
    };

    const themes = [
      {
        id: "light",
        name: "Light",
        properties: {
          "--background": "#F9FAFB",
          "--card-bg": "#FFFFFF",
          "--text-primary": "#1F2937",
          "--text-secondary": "#6B7280",
          "--border": "#E5E7EB",
          "--accent": "#10B981",
          "--gradient-start": "#6EE7B7",
          "--gradient-end": "#10B981"
        }
      },
      {
        id: "dark",
        name: "Dark",
        properties: {
          "--background": "#1F2937",
          "--card-bg": "#374151",
          "--text-primary": "#F9FAFB",
          "--text-secondary": "#9CA3AF",
          "--border": "#4B5563",
          "--accent": "#34D399",
          "--gradient-start": "#6EE7B7",
          "--gradient-end": "#10B981"
        }
      },
      {
        id: "ocean",
        name: "Ocean",
        properties: {
          "--background": "#E6F3FA",
          "--card-bg": "#F0F9FF",
          "--text-primary": "#1E3A8A",
          "--text-secondary": "#3B82F6",
          "--border": "#BFDBFE",
          "--accent": "#3B82F6",
          "--gradient-start": "#93C5FD",
          "--gradient-end": "#3B82F6"
        }
      },
      {
        id: "sunset",
        name: "Sunset",
        properties: {
          "--background": "#FFF7ED",
          "--card-bg": "#FFFFFF",
          "--text-primary": "#431407",
          "--text-secondary": "#7C2D12",
          "--border": "#FED7AA",
          "--accent": "#F97316",
          "--gradient-start": "#FDBA74",
          "--gradient-end": "#F97316"
        }
      }
    ];

    let chatsData = [];
    let statusesData = [];
    let roomsData = [];
    let groupsData = [];
    let currentTab = 'chats';
    let currentStatusIndex = 0;
    let touchStartX = 0;
    let listeners = [];

    window.showAlert = function (message, success = true, confirmCallback = null) {
      return new Promise((resolve) => {
        const alertContent = document.querySelector('.alert-content');
        alertMessage.textContent = message;
        alertContent.classList.remove('success', 'error');
        alertContent.classList.add(success ? 'success' : 'error');
        document.getElementById('alert-ok').style.display = confirmCallback ? 'none' : 'block';
        document.getElementById('alert-cancel').style.display = confirmCallback ? 'block' : 'none';
        document.getElementById('status-progress').style.display = 'none';
        customAlert.classList.add('active');
        if (!confirmCallback) {
          setTimeout(() => window.hideAlert(), 2000);
        }
        document.getElementById('alert-ok').onclick = () => {
          window.hideAlert();
          resolve(true);
        };
        document.getElementById('alert-cancel').onclick = () => {
          if (confirmCallback) confirmCallback();
          window.hideAlert();
          resolve(false);
        };
      });
    };

    window.hideAlert = function () {
      customAlert.classList.remove('active');
    };

    function showSpinner() {
      document.getElementById('spinner-overlay').classList.add('active');
    }

    function hideSpinner() {
      document.getElementById('spinner-overlay').classList.remove('active');
    }

    function showShimmer(element) {
      element.setAttribute('aria-busy', 'true');
    }

    async function getUserName(uid) {
      try {
        const userRef = ref(db, `users/${uid}`);
        const snapshot = await get(userRef);
        return snapshot.exists() ? snapshot.val().name || 'Unknown' : 'Unknown';
      } catch (error) {
        console.error(`Error fetching user ${uid} name:`, error);
        return 'Unknown';
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function cleanupListeners() {
      listeners.forEach(({ ref, callback }) => off(ref, 'value', callback));
      listeners = [];
    }

    function addListener(ref, callback, errorCallback) {
      const listener = onValue(ref, callback, errorCallback);
      listeners.push({ ref, callback: listener });
    }

    async function setOnlineStatus(uid, isOnline) {
      try {
        await update(ref(db, `users/${uid}`), { online: isOnline });
      } catch (error) {
        console.error("Error setting online status:", error);
      }
    }

    async function applyUserTheme(uid) {
      try {
        const userRef = ref(db, `users/${uid}`);
        const snapshot = await get(userRef);
        if (snapshot.exists() && snapshot.val().theme) {
          const theme = themes.find(t => t.id === snapshot.val().theme) || themes[0];
          Object.entries(theme.properties).forEach(([key, value]) => {
            document.documentElement.style.setProperty(key, value);
          });
        }
      } catch (error) {
        console.error("Error applying user theme:", error);
      }
    }

    window.showUserSlide = function () {
      document.getElementById('user-slide').classList.add('active');
      loadAllUsers();
    };

    window.hideBottomSheet = function () {
      document.getElementById('user-slide').classList.remove('active');
    };

    window.showRoomSheet = function () {
      document.getElementById('room-sheet').classList.add('active');
    };

    window.hideRoomSheet = function () {
      document.getElementById('room-sheet').classList.remove('active');
    };

    window.showGroupSheet = function () {
      document.getElementById('group-sheet').classList.add('active');
      loadGroupMembers();
    };

    window.hideGroupSheet = function () {
      document.getElementById('group-sheet').classList.remove('active');
    };

    window.showStatusViewer = function (index) {
      renderStatusViewer(index);
    };

    window.hideStatusViewer = function () {
      statusViewer.classList.remove('active');
    };

    window.navigateStatus = function (direction) {
      renderStatusViewer(currentStatusIndex + direction);
    };

    window.deleteStatus = async function (uid, statusId) {
      window.showAlert(MESSAGES.STATUS_DELETE_CONFIRM, false, async () => {
        try {
          await remove(ref(db, `statuses/${uid}/${statusId}`));
          window.showAlert(MESSAGES.STATUS_DELETE_SUCCESS, true);
          loadStatuses(auth.currentUser.uid);
        } catch (error) {
          console.error("Error deleting status:", error);
          window.showAlert(MESSAGES.STATUS_DELETE_FAIL, false);
        }
      });
    };

    window.toggleLike = async function (uid, statusId) {
      try {
        const userId = auth.currentUser.uid;
        const likeRef = ref(db, `statuses/${uid}/${statusId}/likes/${userId}`);
        const snapshot = await get(likeRef);
        const isLiked = snapshot.exists();
        if (isLiked) {
          await remove(likeRef);
        } else {
          await set(likeRef, true);
        }
        // Update the specific status card
        const statusCard = document.querySelector(`.status-card[data-uid="${uid}"][data-status-id="${statusId}"]`);
        if (statusCard) {
          const likeBtn = statusCard.querySelector('.like-btn');
          const likeCountSpan = statusCard.querySelector('.like-count');
          const status = statusesData.find(s => s.uid === uid && s.statusId === statusId);
          const likeCount = status.likes ? Object.keys(status.likes).length : 0;
          const newLikeCount = isLiked ? likeCount - 1 : likeCount + 1;
          likeBtn.classList.toggle('liked', !isLiked);
          likeCountSpan.textContent = newLikeCount;
          // Update statusesData to reflect the new like state
          if (!status.likes) status.likes = {};
          if (isLiked) {
            delete status.likes[userId];
          } else {
            status.likes[userId] = true;
          }
          console.log(`Updated like for status ${statusId} by ${uid}:`, { isLiked: !isLiked, newLikeCount });
        }
        // Update status viewer if open for this status
        if (statusViewer.classList.contains('active') && currentStatusIndex < statusesData.length && statusesData[currentStatusIndex].uid === uid && statusesData[currentStatusIndex].statusId === statusId) {
          renderStatusViewer(currentStatusIndex);
        }
      } catch (error) {
        console.error("Error toggling like:", error);
        window.showAlert(MESSAGES.LIKE_FAIL, false);
      }
    };

    async function loadAllUsers() {
      const userList = document.getElementById('user-list');
      showShimmer(userList);
      try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        userList.setAttribute('aria-busy', 'false');
        userList.innerHTML = '';
        const users = snapshot.val() || {};
        const searchQuery = userSearchInput.value.toLowerCase();
        Object.entries(users).forEach(([uid, user]) => {
          if (uid === auth.currentUser.uid) return;
          if (searchQuery && !user.name?.toLowerCase().includes(searchQuery)) return;
          const userItem = document.createElement('div');
          userItem.className = 'chat-item';
          userItem.setAttribute('role', 'button');
          userItem.setAttribute('aria-label', `Add friend ${user.name}`);
          const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
          const avatarUrl = user.avatar
            ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/q_auto,f_auto,w_48,h_48,c_fill/${user.avatar}`
            : '';
          userItem.innerHTML = `
            <div class="avatar">
              ${avatarUrl ? `<img src="${avatarUrl}" alt="${user.name}'s avatar" onerror="this.parentElement.innerHTML='<span>${firstLetter}</span>'; console.error('Failed to load user avatar for ${user.name}:', this.src)" />` : `<span>${firstLetter}</span>`}
            </div>
            <div class="chat-info">
              <h3 class="chat-name">${user.name || 'Unknown'}</h3>
              <p class="chat-message">${user.status || 'No status'}</p>
            </div>
            <button class="btn" onclick="window.addFriend('${uid}')">Add</button>
          `;
          userList.appendChild(userItem);
        });
        if (userList.children.length === 0) {
          userList.innerHTML = '<p style="text-align: center; padding: 1rem;">No users found.</p>';
        }
      } catch (error) {
        console.error("Error loading users:", error);
        window.showAlert("Failed to load users.", false);
        userList.setAttribute('aria-busy', 'false');
        userList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load users.</p>';
      }
    }

    async function loadGroupMembers() {
      const groupMembers = document.getElementById('group-members');
      try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        groupMembers.innerHTML = '';
        const users = snapshot.val() || {};
        Object.entries(users).forEach(([uid, user]) => {
          if (uid === auth.currentUser.uid) return;
          const option = document.createElement('option');
          option.value = uid;
          option.textContent = user.name || 'Unknown';
          groupMembers.appendChild(option);
        });
      } catch (error) {
        console.error("Error loading group members:", error);
        window.showAlert("Failed to load users for group.", false);
      }
    }

    async function loadChats(userId) {
      showShimmer(chatList);
      const friendsRef = ref(db, `users/${userId}/friends`);
      cleanupListeners();
      addListener(friendsRef, async (snapshot) => {
        chatsData = [];
        const friends = snapshot.val() || {};
        for (const friendId of Object.keys(friends)) {
          try {
            const userRef = ref(db, `users/${friendId}`);
            const userSnapshot = await get(userRef);
            if (userSnapshot.exists()) {
              const user = userSnapshot.val();
              const messagesRef = ref(db, `messages/${userId}/${friendId}`);
              const messagesSnapshot = await get(messagesRef);
              const messages = messagesSnapshot.val() || {};
              const lastMessage = Object.values(messages).sort((a, b) => b.timestamp - a.timestamp)[0];
              chatsData.push({
                uid: friendId,
                name: user.name || 'Unknown',
                avatar: user.avatar,
                lastMessage
              });
            }
          } catch (error) {
            console.error(`Error loading friend ${friendId}:`, error);
          }
        }
        chatsData.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
        renderChats(chatsData, userId);
      }, (error) => {
        console.error("Error loading chats:", error);
        window.showAlert(MESSAGES.CHAT_FAIL, false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load chats.</p>';
      });
    }

    async function addFriend(friendId) {
      if (!friendId) {
        window.showAlert("Please select a user to add.", false);
        return;
      }
      try {
        const userId = auth.currentUser.uid;
        const friendRef = ref(db, `users/${userId}/friends/${friendId}`);
        await set(friendRef, { addedAt: Date.now() });
        window.showAlert(MESSAGES.FRIEND_REQUEST_SENT, true);
        window.hideBottomSheet();
        loadChats(userId);
      } catch (error) {
        console.error("Error adding friend:", error);
        window.showAlert(MESSAGES.FRIEND_REQUEST_FAIL, false);
      }
    }

    async function createRoom() {
      const roomName = document.getElementById('room-name').value.trim();
      if (!roomName) {
        window.showAlert("Please enter a room name.", false);
        return;
      }
      try {
        const roomId = Date.now().toString();
        await set(ref(db, `chatrooms/${roomId}`), {
          name: roomName,
          creator: auth.currentUser.uid,
          createdAt: Date.now()
        });
        window.showAlert(MESSAGES.ROOM_CREATE_SUCCESS, true);
        window.hideRoomSheet();
        roomsData.push({ id: roomId, name: roomName, creator: auth.currentUser.uid, createdAt: Date.now() });
        renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), auth.currentUser.uid);
      } catch (error) {
        console.error("Error creating room:", error);
        window.showAlert(MESSAGES.ROOM_CREATE_FAIL, false);
      }
    }

    async function createGroup() {
      const groupName = document.getElementById('group-name').value.trim();
      const selectedMembers = Array.from(document.getElementById('group-members').selectedOptions).map(option => option.value);
      if (!groupName || selectedMembers.length === 0) {
        window.showAlert("Please enter a group name and select at least one member.", false);
        return;
      }
      try {
        const groupId = Date.now().toString();
        const members = { [auth.currentUser.uid]: true };
        selectedMembers.forEach(memberId => { members[memberId] = true; });
        await set(ref(db, `groups/${groupId}`), {
          name: groupName,
          creator: auth.currentUser.uid,
          members,
          createdAt: Date.now()
        });
        window.showAlert(MESSAGES.GROUP_CREATE_SUCCESS, true);
        window.hideGroupSheet();
        groupsData.push({ id: groupId, name: groupName, creator: auth.currentUser.uid, members, createdAt: Date.now() });
        renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), auth.currentUser.uid);
      } catch (error) {
        console.error("Error creating group:", error);
        window.showAlert(MESSAGES.GROUP_CREATE_FAIL, false);
      }
    }

    async function loadRooms(userId) {
      showShimmer(chatList);
      const roomsRef = ref(db, 'chatrooms');
      cleanupListeners();
      addListener(roomsRef, (snapshot) => {
        roomsData = [];
        const rooms = snapshot.val() || {};
        roomsData = Object.entries(rooms).map(([id, room]) => ({ id, ...room }));
        renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), userId);
      }, (error) => {
        console.error("Error loading rooms:", error);
        window.showAlert(MESSAGES.ROOM_FAIL || "Failed to load rooms. Please try again.", false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load rooms.</p>';
      });
    }

    async function renderRooms(rooms, userId) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';

      const filteredRooms = searchInput.value
        ? Object.values(rooms).filter(room => room.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : Object.values(rooms);

      filteredRooms.forEach(room => {
        const roomItem = document.createElement('div');
        roomItem.className = 'room-item';
        roomItem.setAttribute('role', 'button');
        roomItem.setAttribute('aria-label', `Open room ${room.name}`);
        roomItem.innerHTML = `
          <div class="avatar">${room.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${room.name}</h3>
            <p class="chat-message">Created by ${room.creator === userId ? 'You' : 'Someone'}</p>
          </div>
          ${room.creator === userId ? `
            <button class="kebab-menu" data-room-id="${room.id}" aria-label="Room options">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="context-menu" data-room-id="${room.id}">
              <div class="context-menu-item" onclick="window.deleteRoom('${room.id}')">Delete</div>
            </div>
          ` : ''}
        `;
        roomItem.onclick = (e) => {
          if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
            window.location.href = `room.html?roomId=${room.id}`;
          }
        };
        if (room.creator === userId) {
          const kebabMenu = roomItem.querySelector('.kebab-menu');
          kebabMenu.onclick = (e) => {
            e.stopPropagation();
            const contextMenu = roomItem.querySelector('.context-menu');
            document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
            contextMenu.classList.toggle('active');
          };
        }
        chatList.appendChild(roomItem);
      });

      if (filteredRooms.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No rooms available.</p>';
      }
    }

    async function deleteRoom(roomId) {
      window.showAlert(MESSAGES.ROOM_DELETE_CONFIRM, false, async () => {
        try {
          await remove(ref(db, `chatrooms/${roomId}`));
          window.showAlert(MESSAGES.ROOM_DELETE_SUCCESS, true);
          roomsData = roomsData.filter(room => room.id !== roomId);
          renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), auth.currentUser.uid);
        } catch (error) {
          console.error("Error deleting room:", error);
          window.showAlert(MESSAGES.ROOM_DELETE_FAIL, false);
        }
      });
    }

    async function loadGroups(userId) {
      showShimmer(chatList);
      const groupsRef = ref(db, 'groups');
      cleanupListeners();
      addListener(groupsRef, (snapshot) => {
        groupsData = [];
        const groups = snapshot.val() || {};
        groupsData = Object.entries(groups)
          .filter(([_, group]) => group.members && group.members[userId])
          .map(([id, group]) => ({ id, ...group }));
        renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), userId);
      }, (error) => {
        console.error("Error loading groups:", error);
        window.showAlert(MESSAGES.GROUP_FAIL || "Failed to load groups. Please try again.", false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load groups.</p>';
      });
    }

    async function renderGroups(groups, userId) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';

      const filteredGroups = searchInput.value
        ? Object.values(groups).filter(group => group.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : Object.values(groups);

      filteredGroups.forEach(group => {
        const groupItem = document.createElement('div');
        groupItem.className = 'group-item';
        groupItem.setAttribute('role', 'button');
        groupItem.setAttribute('aria-label', `Open group ${group.name}`);
        groupItem.innerHTML = `
          <div class="avatar">${group.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${group.name}</h3>
            <p class="chat-message">${group.members ? `${Object.keys(group.members).length} members` : 'No members'}</p>
          </div>
          ${group.creator === userId ? `
            <button class="kebab-menu" data-group-id="${group.id}" aria-label="Group options">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="context-menu" data-group-id="${group.id}">
              <div class="context-menu-item" onclick="window.deleteGroup('${group.id}')">Delete</div>
            </div>
          ` : ''}
        `;
        groupItem.onclick = (e) => {
          if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
            window.location.href = `group.html?groupId=${group.id}`;
          }
        };
        if (group.creator === userId) {
          const kebabMenu = groupItem.querySelector('.kebab-menu');
          kebabMenu.onclick = (e) => {
            e.stopPropagation();
            const contextMenu = groupItem.querySelector('.context-menu');
            document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
            contextMenu.classList.toggle('active');
          };
        }
        chatList.appendChild(groupItem);
      });

      if (filteredGroups.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No groups available.</p>';
      }
    }

    async function deleteGroup(groupId) {
      window.showAlert(MESSAGES.GROUP_DELETE_CONFIRM, false, async () => {
        try {
          await remove(ref(db, `groups/${groupId}`));
          window.showAlert(MESSAGES.GROUP_DELETE_SUCCESS, true);
          groupsData = groupsData.filter(group => group.id !== groupId);
          renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), auth.currentUser.uid);
        } catch (error) {
          console.error("Error deleting group:", error);
          window.showAlert(MESSAGES.GROUP_DELETE_FAIL, false);
        }
      });
    }

    async function uploadToCloudinary(file) {
      if (file.size > 5 * 1024 * 1024) {
        throw new Error(MESSAGES.FILE_SIZE_EXCEEDED);
      }
      if (!["image/jpeg", "image/png", "video/mp4", "video/webm"].includes(file.type)) {
        throw new Error(MESSAGES.INVALID_IMAGE);
      }
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", CLOUDINARY_API_URL, true);
        xhr.onload = () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.secure_url && data.public_id && data.resource_type) {
              console.log("Cloudinary upload success:", { public_id: data.public_id, url: data.secure_url, resource_type: data.resource_type });
              resolve({ url: data.public_id, public_id: data.public_id, resource_type: data.resource_type });
            } else {
              console.error("Cloudinary response missing required fields:", data);
              reject(new Error(data.error?.message || "Upload failed: missing public_id or resource_type"));
            }
          } else {
            console.error("Cloudinary upload failed with status:", xhr.status, xhr.statusText);
            reject(new Error(`Upload failed with status ${xhr.status}`));
          }
        };
        xhr.onerror = () => {
          console.error("Network error during Cloudinary upload");
          reject(new Error("Network error during upload"));
        };
        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            document.getElementById('status-progress').style.display = 'block';
            document.getElementById('status-progress').value = percent;
          }
        };
        xhr.send(formData);
      });
    }

    async function uploadStatus(event) {
      const file = event.target.files[0];
      if (!file) {
        console.warn("No file selected for status upload");
        return;
      }
      try {
        showSpinner();
        const { url, public_id, resource_type } = await uploadToCloudinary(file);
        if (!public_id || !resource_type) {
          throw new Error("Invalid Cloudinary response: missing public_id or resource_type");
        }
        const statusId = Date.now().toString();
        const statusRef = ref(db, `statuses/${auth.currentUser.uid}/${statusId}`);
        const statusData = {
          url: public_id,
          resource_type,
          timestamp: Date.now(),
          likes: {}
        };
        await set(statusRef, statusData);
        console.log("Status uploaded to Firebase:", statusData);
        window.showAlert(MESSAGES.STATUS_UPLOAD_SUCCESS, true);
        loadStatuses(auth.currentUser.uid);
      } catch (error) {
        console.error("Error uploading status:", error.message, error.stack);
        window.showAlert(error.message || MESSAGES.STATUS_UPLOAD_FAIL, false);
      } finally {
        hideSpinner();
        statusUploadInput.value = '';
        document.getElementById('status-progress').style.display = 'none';
      }
    }

    async function loadStatuses(userId) {
      showShimmer(statusList);
      const statusesRef = ref(db, 'statuses');
      cleanupListeners();
      addListener(statusesRef, (snapshot) => {
        statusesData = [];
        const statuses = snapshot.val() || {};
        Object.entries(statuses).forEach(([uid, userStatuses]) => {
          Object.entries(userStatuses).forEach(([statusId, status]) => {
            if (!status.url || !status.resource_type || !['image', 'video'].includes(status.resource_type)) {
              console.warn(`Skipping status ${statusId} for user ${uid}: invalid or missing url/resource_type`, status);
              return;
            }
            statusesData.push({ uid, statusId, ...status });
          });
        });
        statusesData.sort((a, b) => b.timestamp - a.timestamp);
        console.log("Loaded statuses:", statusesData);
        renderStatuses(statusesData, userId);
      }, (error) => {
        console.error("Error loading statuses:", error);
        window.showAlert(MESSAGES.STATUS_FAIL, false);
        statusList.setAttribute('aria-busy', 'false');
        statusList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load statuses.</p>';
      });
    }

    async function renderStatuses(statuses, userId) {
      statusList.setAttribute('aria-busy', 'false');
      statusList.innerHTML = '';

      const filteredStatuses = searchInput.value
        ? await Promise.all(statuses.map(async status => {
            const userName = await getUserName(status.uid);
            return userName.toLowerCase().includes(searchInput.value.toLowerCase()) ? status : null;
          }))
        : statuses;

      const renderStatusPromises = filteredStatuses
        .filter(status => status !== null)
        .map(async (status, index) => {
          const userName = await getUserName(status.uid);
          const firstLetter = userName.charAt(0).toUpperCase() || 'U';
          const mediaUrl = status.url && status.resource_type
            ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/${status.resource_type}/upload/q_auto,f_auto,w_720,h_720,c_fill/${status.url}${status.resource_type === 'video' ? '#t_0.1' : ''}`
            : '';
          const avatarUrl = mediaUrl
            ? mediaUrl.replace('/upload/q_auto,f_auto,w_720,h_720,c_fill/', '/upload/q_auto,f_auto,w_48,h_48,c_fill/')
            : '';
          const likeCount = status.likes ? Object.keys(status.likes).length : 0;
          const isLiked = status.likes && status.likes[userId] ? 'liked' : '';
          console.log(`Rendering status card ${index} for ${userName}:`, { mediaUrl, resource_type: status.resource_type, statusId: status.statusId });

          const statusCard = document.createElement('div');
          statusCard.className = 'status-card';
          statusCard.setAttribute('role', 'button');
          statusCard.setAttribute('aria-label', `View ${userName}'s status`);
          statusCard.dataset.uid = status.uid;
          statusCard.dataset.statusId = status.statusId;
          let errorMessage = 'Failed to load media.';
          if (!status.url) errorMessage = 'Missing media URL.';
          else if (!['image', 'video'].includes(status.resource_type)) errorMessage = `Invalid resource type: ${status.resource_type}`;
          else if (!mediaUrl) errorMessage = 'Failed to construct media URL.';
          statusCard.innerHTML = `
            <div class="status-card-header">
              <div class="avatar">
                ${avatarUrl ? `<img src="${avatarUrl}" alt="${userName}'s avatar" onerror="this.parentElement.innerHTML='<span>${firstLetter}</span>'; console.error('Failed to load status avatar for ${userName}:', this.src)" />` : `<span>${firstLetter}</span>`}
              </div>
              <div class="status-card-info">
                <h3 class="status-card-name">${userName}</h3>
                <p class="status-card-time">${formatTimestamp(status.timestamp)}</p>
              </div>
              ${status.uid === userId ? `
                <button class="kebab-menu" data-status-id="${status.statusId}" data-uid="${status.uid}" aria-label="Status options">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                  </svg>
                </button>
                <div class="context-menu" data-status-id="${status.statusId}" data-uid="${status.uid}">
                  <div class="context-menu-item" onclick="window.deleteStatus('${status.uid}', '${status.statusId}')">Delete</div>
                </div>
              ` : ''}
            </div>
            ${mediaUrl && status.resource_type ? (
              status.resource_type === 'image'
                ? `<img class="status-card-media" src="${mediaUrl}" alt="Status media" onerror="this.parentElement.innerHTML='<p>${errorMessage}</p>'; console.error('Failed to load status media for ${userName}:', this.src, { status })" />`
                : `<video class="status-card-video" src="${mediaUrl}" controls playsinline alt="Status video" onerror="this.parentElement.innerHTML='<p>${errorMessage}</p>'; console.error('Failed to load status video for ${userName}:', this.src, { status })"></video>`
            ) : `<p>${errorMessage}</p>`}
            <div class="status-card-footer">
              <button class="like-btn ${isLiked}" onclick="window.toggleLike('${status.uid}', '${status.statusId}')">
                <svg viewBox="0 0 24 24">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <span class="like-count">${likeCount}</span>
              </button>
            </div>
          `;
          statusCard.onclick = (e) => {
            if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu') && !e.target.closest('.like-btn')) {
              window.showStatusViewer(index);
            }
          };
          if (status.uid === userId) {
            const kebabMenu = statusCard.querySelector('.kebab-menu');
            kebabMenu.onclick = (e) => {
              e.stopPropagation();
              const contextMenu = statusCard.querySelector('.context-menu');
              document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
              contextMenu.classList.toggle('active');
            };
          }
          statusList.appendChild(statusCard);
        });

      await Promise.all(renderStatusPromises);

      if (filteredStatuses.length === 0 || filteredStatuses.every(s => s === null)) {
        statusList.innerHTML = '<p style="text-align: center; padding: 1rem;">No statuses available.</p>';
      }
    }

    async function renderStatusViewer(index) {
      if (index < 0 || index >= statusesData.length) {
        console.warn(`Invalid status index: ${index}, total statuses: ${statusesData.length}`);
        window.hideStatusViewer();
        return;
      }
      currentStatusIndex = index;
      const status = statusesData[index];
      const userName = await getUserName(status.uid);
      const firstLetter = userName.charAt(0).toUpperCase() || 'U';
      const mediaUrl = status.url && status.resource_type
        ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/${status.resource_type}/upload/q_auto,f_auto,w_720,h_720,c_fill/${status.url}`
        : '';
      const likeCount = status.likes ? Object.keys(status.likes).length : 0;
      const isLiked = status.likes && status.likes[auth.currentUser.uid] ? 'liked' : '';
      console.log(`Rendering status viewer ${index} for ${userName}:`, { mediaUrl, resource_type: status.resource_type, statusId: status.statusId, fullStatus: status });

      let errorMessage = 'Failed to load media.';
      if (!status.url) errorMessage = 'Missing media URL.';
      else if (!['image', 'video'].includes(status.resource_type)) errorMessage = `Invalid resource type: ${status.resource_type}`;
      else if (!mediaUrl) errorMessage = 'Failed to construct media URL.';

      statusViewer.innerHTML = `
        <div class="status-header">
          <div class="avatar">
            ${mediaUrl ? `<img src="${mediaUrl.replace('/upload/q_auto,f_auto,w_720,h_720,c_fill/', '/upload/q_auto,f_auto,w_48,h_48,c_fill/')}" alt="${userName}'s avatar" onerror="this.parentElement.innerHTML='<span>${firstLetter}</span>'; console.error('Failed to load avatar for ${userName}:', this.src)" />` : `<span>${firstLetter}</span>`}
          </div>
          <div class="status-info">
            <h3 class="status-name">${userName}</h3>
            <p class="status-time">${formatTimestamp(status.timestamp)}</p>
          </div>
          <button class="close-btn" onclick="window.hideStatusViewer()" aria-label="Close status viewer">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6L6 18M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="status-content">
          ${mediaUrl && status.resource_type ? (
            status.resource_type === 'image'
              ? `<img class="status-media" src="${mediaUrl}" alt="Status media" onerror="this.parentElement.innerHTML='<p>${errorMessage}</p>'; console.error('Failed to load status media for ${userName}:', this.src, { status })" />`
              : `<video class="status-media-video" src="${mediaUrl}" autoplay loop controls playsinline alt="Status video" onerror="this.parentElement.innerHTML='<p>${errorMessage}</p>'; console.error('Failed to load status video for ${userName}:', this.src, { status })"></video>`
          ) : `<p>${errorMessage}</p>`}
          <div class="reaction-btns">
            <button class="reaction-btn like ${isLiked}" data-reaction="like" onclick="window.toggleLike('${status.uid}', '${status.statusId}')" aria-label="Like status">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
              <span>${likeCount}</span>
            </button>
            <button class="reaction-btn comment" data-reaction="comment" aria-label="Comment on status">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-8.5 7H7a8.38 8.38 0 0 1-5-14.5A8.38 8.38 0 0 1 12 4a8.38 8.38 0 0 1 9 7.5z"></path>
              </svg>
            </button>
          </div>
        </div>
      `;
      statusViewer.classList.add('active');
    }

       async function renderChats(chats, userId) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';

      const filteredChats = searchInput.value
        ? chats.filter(chat => chat.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : chats;

      for (const chat of filteredChats) {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.setAttribute('role', 'button');
        chatItem.setAttribute('aria-label', `Open chat with ${chat.name}`);
        const firstLetter = chat.name.charAt(0).toUpperCase() || 'U';
        const avatarUrl = chat.avatar
          ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/q_auto,f_auto,w_48,h_48,c_fill/${chat.avatar}`
          : '';
        console.log(`Chat avatar for ${chat.name}:`, avatarUrl || "Using initials");
        chatItem.innerHTML = `
          <div class="avatar">
            ${avatarUrl ? `<img src="${avatarUrl}" alt="${chat.name}'s avatar" onerror="this.parentElement.innerHTML='<span>${firstLetter}</span>'; console.error('Failed to load chat avatar for ${chat.name}:', this.src)" />` : `<span>${firstLetter}</span>`}
          </div>
          <div class="chat-info">
            <h3 class="chat-name">${chat.name}</h3>
            <p class="chat-message">${chat.lastMessage?.text || 'No messages yet'}</p>
          </div>
          <span class="chat-time">${chat.lastMessage ? formatTimestamp(chat.lastMessage.timestamp) : ''}</span>
        `;
        chatItem.onclick = () => {
          window.location.href = `chat.html?friendId=${chat.uid}`;
        };
        chatList.appendChild(chatItem);
      }

      const businessesRef = ref(db, 'businesses');
      const businessesSnapshot = await get(businessesRef);
      const businesses = businessesSnapshot.val() || {};
      const filteredBusinesses = searchInput.value
        ? Object.entries(businesses).filter(([_, business]) => business.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : Object.entries(businesses);

      filteredBusinesses.forEach(([businessId, business]) => {
        const businessItem = document.createElement('div');
        businessItem.className = 'chat-item';
        businessItem.setAttribute('role', 'button');
        businessItem.setAttribute('aria-label', `View business ${business.name}`);
        const firstLetter = business.name.charAt(0).toUpperCase() || 'B';
        const businessAvatarUrl = business.logo
          ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/q_auto,f_auto,w_120,h_120,c_fill/${business.logo}`
          : '';
        console.log(`Business preview for ${business.name}:`, businessAvatarUrl || "Using initials");
        businessItem.innerHTML = `
          <div class="business-preview">
            ${businessAvatarUrl ? `<img src="${businessAvatarUrl}" alt="${business.name} logo" onerror="this.parentElement.innerHTML='<span>${firstLetter}</span>'; console.error('Failed to load business logo for ${business.name}:', this.src)" />` : `<span>${firstLetter}</span>`}
          </div>
          <div class="chat-info">
            <h3 class="chat-name">${business.name}</h3>
            <p class="chat-message">${business.description || 'No description'}</p>
          </div>
        `;
        businessItem.onclick = () => {
          window.location.href = `business.html?businessId=${businessId}`;
        };
        chatList.appendChild(businessItem);
      });

      if (filteredChats.length === 0 && filteredBusinesses.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No chats or businesses available.</p>';
      }
    }

    function switchTab(tab) {
      currentTab = tab;
      tabItems.forEach(item => item.classList.remove('active'));
      document.querySelector(`.tab-item[data-tab="${tab}"]`).classList.add('active');
      chatList.style.display = tab === 'chats' ? 'block' : 'none';
      statusList.style.display = tab === 'status' ? 'block' : 'none';
      fabLabel.textContent = tab === 'chats' ? 'Users' : tab === 'status' ? 'Add Status' : tab === 'rooms' ? 'Create Room' : 'Create Group';
      fabIcon.innerHTML = tab === 'status' ? `
        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
        <polyline points="16 6 12 2 8 6"></polyline>
        <line x1="12" y1="2" x2="12" y2="15"></line>
      ` : tab === 'rooms' ? `
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      ` : tab === 'groups' ? `
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      ` : `
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      `;
      if (tab === 'chats') {
        loadChats(auth.currentUser.uid);
      } else if (tab === 'status') {
        loadStatuses(auth.currentUser.uid);
      } else if (tab === 'rooms') {
        loadRooms(auth.currentUser.uid);
      } else if (tab === 'groups') {
        loadGroups(auth.currentUser.uid);
      }
    }

    tabItems.forEach(item => {
      item.addEventListener('click', () => switchTab(item.dataset.tab));
    });

    fab.addEventListener('click', () => {
      if (currentTab === 'chats') {
        window.showUserSlide();
      } else if (currentTab === 'status') {
        statusUploadInput.click();
      } else if (currentTab === 'rooms') {
        window.showRoomSheet();
      } else if (currentTab === 'groups') {
        window.showGroupSheet();
      }
    });

    searchInput.addEventListener('input', () => {
      if (currentTab === 'chats') {
        renderChats(chatsData, auth.currentUser.uid);
      } else if (currentTab === 'status') {
        renderStatuses(statusesData, auth.currentUser.uid);
      } else if (currentTab === 'rooms') {
        renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), auth.currentUser.uid);
      } else if (currentTab === 'groups') {
        renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), auth.currentUser.uid);
      }
    });

    userSearchInput.addEventListener('input', loadAllUsers);

    statusUploadInput.addEventListener('change', uploadStatus);

    statusViewer.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    statusViewer.addEventListener('touchend', (e) => {
      const touchEndX = e.changedTouches[0].screenX;
      const deltaX = touchEndX - touchStartX;
      if (deltaX > 50) {
        window.navigateStatus(-1);
      } else if (deltaX < -50) {
        window.navigateStatus(1);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await applyUserTheme(user.uid);
        await setOnlineStatus(user.uid, true);
        const userRef = ref(db, `users/${user.uid}`);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          const userData = snapshot.val();
          const firstLetter = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
          const avatarUrl = userData.avatar
            ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/q_auto,f_auto,w_40,h_40,c_fill/${userData.avatar}`
            : '';
          userAvatar.innerHTML = avatarUrl
            ? `<img src="${avatarUrl}" alt="${userData.name}'s avatar" onerror="this.parentElement.innerHTML='<span>${firstLetter}</span>'; console.error('Failed to load user avatar for ${userData.name}:', this.src)" />`
            : `<span>${firstLetter}</span>`;
        }
        switchTab(currentTab);
        window.addEventListener('beforeunload', () => setOnlineStatus(user.uid, false));
      } else {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
      }
    });
  </script>
</body>
</html>
