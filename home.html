<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ConnectSphere</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
      --status-bar: #D9D9D9;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --fab-bg: var(--accent);
      --fab-text: #FFFFFF;
      --online: #4CAF50;
      --offline: #B0BEC5;
      --typing: #FFD54F;
      --alert-success: #E6FFF3;
      --alert-error: #FFE6E6;
      --status-ring: #00A884;
      --status-ring-viewed: #B0BEC5;
      --progress-bar: #00A884;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    .header {
      background: var(--chat-bg);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }

    .header-search {
      flex: 1;
      background: var(--background);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      margin-right: 1rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
    }

    #search-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: var(--fab-text);
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .status-ring {
      position: absolute;
      top: -2px;
      left: -2px;
      width: 52px;
      height: 52px;
      border: 2px solid var(--status-ring);
      border-radius: 50%;
      pointer-events: none;
    }

    .status-ring.viewed {
      border-color: var(--status-ring-viewed);
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      scroll-behavior: smooth;
    }

    .chat-list[aria-busy='true']::before {
      content: '';
      display: block;
      height: 10rem;
      background: linear-gradient(180deg, var(--chat-bg), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    .business-scroll {
      display: flex;
      overflow-x: auto;
      padding: 0.5rem;
      gap: 0.5rem;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .business-scroll::-webkit-scrollbar {
      display: none;
    }

    .business-item {
      flex: 0 0 auto;
      width: 100px;
      background: var(--chat-bg);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      scroll-snap-align: start;
      box-shadow: var(--shadow);
      border: 2px solid var(--accent);
    }

    .business-item:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .business-preview {
      width: 100%;
      height: 70%;
      object-fit: cover;
      display: block;
    }

    .business-preview-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 70%;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3), transparent);
      pointer-events: none;
    }

    .business-info {
      padding: 0.5rem;
      text-align: center;
    }

    .business-name {
      font-size: 0.85rem;
      font-weight: 500;
      margin: 0;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .business-category {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 0.2rem;
    }

    .chat-item,
    .room-item,
    .group-item,
    .status-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      background: var(--background);
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
      position: relative;
    }

    .chat-item:hover,
    .room-item:hover,
    .group-item:hover,
    .status-item:hover {
      transform: translateY(-2px);
      background: var(--chat-bg);
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .chat-message {
      font-size: 0.85rem;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-status {
      font-size: 0.75rem;
      margin-top: 0.2rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .chat-status.online {
      color: var(--online);
    }

    .chat-status.offline {
      color: var(--offline);
    }

    .chat-status.typing {
      color: var(--typing);
      font-style: italic;
    }

    .chat-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .kebab-menu {
      position: absolute;
      right: 0.75rem;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      padding: 0.3rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .kebab-menu:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .kebab-menu svg {
      width: 16px;
      height: 16px;
      stroke: var(--text-primary);
    }

    .context-menu {
      position: absolute;
      right: 0.75rem;
      top: 2.5rem;
      background: var(--background);
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      padding: 0.5rem 0;
      display: none;
    }

    .context-menu.active {
      display: block;
    }

    .context-menu-item {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .context-menu-item:hover {
      background: var(--chat-bg);
    }

    .user-slide {
      position: fixed;
      top: 0;
      right: -100%;
      width: 80%;
      max-width: 300px;
      height: 100%;
      background: var(--background);
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 1rem;
    }

    .user-slide.active {
      right: 0;
    }

    .user-slide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .user-slide-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .user-slide-search {
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
    }

    #user-search-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .user-slide-content {
      padding: 0.5rem 0;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
      position: relative;
    }

    .user-item:hover {
      background: var(--chat-bg);
    }

    .user-item .avatar {
      width: 40px;
      height: 40px;
      margin-right: 0.75rem;
    }

    .user-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .suggested-friend {
      font-size: 0.7rem;
      color: var(--accent);
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .bottom-sheet {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      background: var(--background);
      border-radius: 16px 16px 0 0;
      box-shadow: var(--shadow);
      max-height: 80vh;
      transition: bottom 0.3s ease;
      z-index: 1000;
      overflow: hidden;
    }

    .bottom-sheet.active {
      bottom: 0;
    }

    .bottom-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--chat-bg);
    }

    .bottom-sheet-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .bottom-sheet-content {
      padding: 1.5rem;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--accent);
      outline: none;
    }

    .form-group button {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent);
      color: var(--fab-text);
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .form-group button:hover {
      background: color-mix(in srgb, var(--accent) 80%, #000);
    }

    .fab {
      position: fixed;
      bottom: 5rem;
      right: 1rem;
      background: var(--fab-bg);
      color: var(--fab-text);
      border-radius: 24px;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: var(--shadow);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 1000;
    }

    .fab:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .fab svg {
      width: 24px;
      height: 24px;
    }

    .bottom-nav {
      display: flex;
      justify-content: space-around;
      background: var(--chat-bg);
      padding: 0.75rem 0;
      position: sticky;
      bottom: 0;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .nav-item.active {
      color: var(--accent);
    }

    .nav-item.active svg {
      stroke: var(--accent);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--background);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      max-width: 90%;
      width: 320px;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .alert.active {
      display: flex;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .alert.success {
      background: var(--alert-success);
      border: 1px solid var(--accent);
      color: var(--text-primary);
    }

    .alert.error {
      background: var(--alert-error);
      border: 1px solid #FF6B6B;
      color: var(--text-primary);
    }

    .alert-message {
      font-size: 0.95rem;
      text-align: center;
      line-height: 1.4;
    }

    .alert-close {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: var(--fab-text);
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .alert-close:hover {
      background: color-mix(in srgb, var(--accent) 80%, #000);
    }

    .upload-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      display: none;
    }

    .upload-overlay.active {
      display: flex;
    }

    .progress-bar-container {
      width: 80%;
      max-width: 400px;
      background: var(--chat-bg);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .progress-bar {
      width: 0%;
      height: 8px;
      background: var(--progress-bar);
      transition: width 0.2s ease;
    }

    .upload-text {
      color: var(--fab-text);
      font-size: 1rem;
      font-weight: 500;
    }

    .status-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000;
      z-index: 2000;
      display: none;
      flex-direction: column;
      justify-content: space-between;
      overflow: hidden;
    }

    .status-viewer.active {
      display: flex;
    }

    .status-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      touch-action: pan-x;
    }

    .status-media {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
    }

    .status-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .status-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.5), transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-progress-container {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.2rem;
    }

    .status-progress-bar {
      flex: 1;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      overflow: hidden;
    }

    .status-progress-fill {
      height: 100%;
      background: #FFF;
      width: 0%;
      transition: width linear;
    }

    .reaction-container {
      display: flex;
      gap: 0.5rem;
    }

    .reaction-btn {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .reaction-count {
      color: #FFF;
      font-size: 0.9rem;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, -40%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    @media (max-width: 768px) {
      .business-scroll {
        padding: 0.4rem;
        gap: 0.4rem;
      }
      .business-item {
        width: 80px;
        border-radius: 12px;
      }
      .business-preview {
        height: 65%;
      }
    }

    @media (max-width: 480px) {
      .business-scroll {
        padding: 0.3rem;
        gap: 0.3rem;
      }
      .business-item {
        width: 70px;
        border-radius: 10px;
      }
      .business-preview {
        height: 60%;
      }
      .business-name {
        font-size: 0.8rem;
      }
      .business-category {
        font-size: 0.65rem;
      }
      .header-search {
        margin-right: 0.5rem;
      }
      .fab {
        bottom: 4.5rem;
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
      }
      .fab svg {
        width: 20px;
        height: 20px;
      }
      .user-slide {
        width: 100%;
      }
      .alert {
        width: 280px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-search">
      <input type="text" id="search-input" placeholder="Search..." aria-label="Search" />
    </div>
    <div class="header-actions">
      <div class="avatar" onclick="window.location.href='profile.html'" aria-label="Go to profile"></div>
    </div>
  </header>

  <main class="chat-list" id="chat-list" role="region" aria-live="polite"></main>

  <div class="fab" id="fab" aria-label="Open action">
    <svg id="fab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
      <circle cx="9" cy="7" r="4"></circle>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path>
    </svg>
    <span id="fab-label">Users</span>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="chats" aria-label="Chats">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 11.5a8.38 8.38 0 0 1-8.5 8m8.5-8a8.38 8.38 0 0 0-8.5-8m8.5 8H3m5.5 8a8.38 8.38 0 0 1-8-8.5m8 8.5c1.66 0 3.22-.55 4.5-1.5m-4.5-17c-1.28.95-2.83 1.5-4.5 1.5m8 1.5a8.38 8.38 0 0 1 8 8.5"></path>
      </svg>
      Chats
    </div>
    <div class="nav-item" data-tab="status" aria-label="Status">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v.01M12 8v4"></path>
      </svg>
      Status
    </div>
    <div class="nav-item" data-tab="rooms" aria-label="Rooms">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <path d="M3 9h18M9 21V9"></path>
      </svg>
      Rooms
    </div>
    <div class="nav-item" data-tab="groups" aria-label="Groups">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path>
      </svg>
      Groups
    </div>
  </nav>

  <div id="user-slide" class="user-slide">
    <div class="user-slide-header">
      <h2>All Users</h2>
      <button class="close-btn" onclick="window.hideUserSlide()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="user-slide-search">
      <input type="text" id="user-search-input" placeholder="Search users..." aria-label="Search users" />
    </div>
    <div class="user-slide-content" id="user-list"></div>
  </div>

  <div id="bottom-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Add Friend</h2>
      <button class="close-btn" onclick="window.hideBottomSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="form-group">
        <label for="friend-id">Friend's User ID</label>
        <input type="text" id="friend-id" placeholder="Enter friend's user ID" required />
        <button onclick="window.addFriend()">Add Friend</button>
      </div>
    </div>
  </div>

  <div id="create-room-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Room</h2>
      <button class="close-btn" onclick="window.hideRoomSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="form-group">
        <label for="room-name">Room Name</label>
        <input type="text" id="room-name" placeholder="Enter room name" required />
        <button onclick="window.createRoom()">Create Room</button>
      </div>
    </div>
  </div>

  <div id="create-group-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h2>Create Group</h2>
      <button class="close-btn" onclick="window.hideGroupSheet()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="bottom-sheet-content">
      <div class="form-group">
        <label for="group-name">Group Name</label>
        <input type="text" id="group-name" placeholder="Enter group name" required />
        <label for="group-members">Select Members</label>
        <select id="group-members" multiple style="height: 120px;"></select>
        <button onclick="window.createGroup()">Create Group</button>
      </div>
    </div>
  </div>

  <input type="file" id="status-upload-input" accept="image/jpeg,image/png,video/mp4,video/webm" style="display: none;" />

  <div class="alert" id="alert">
    <span class="alert-message"></span>
    <button class="alert-close">Close</button>
  </div>

  <div class="upload-overlay" id="upload-overlay">
    <span class="upload-text">Uploading Status...</span>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <div class="status-viewer" id="status-viewer">
    <div class="status-header">
      <div class="avatar"></div>
      <span class="status-user-name"></span>
      <span class="status-timestamp"></span>
      <button class="close-btn" onclick="window.hideStatusViewer()">
        <svg viewBox="0 0 24 24" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="status-progress-container" id="status-progress-container"></div>
    <div class="status-content">
      <img class="status-media" id="status-media" alt="Status media" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
      <video class="status-media" id="status-media-video" style="display: none;" playsinline onerror="this.style.display='none'; this.parentElement.innerHTML+='<p style=\"color: white; text-align: center;\">Failed to load media.</p>';"></video>
    </div>
    <div class="status-footer">
      <div class="reaction-container">
        <button class="reaction-btn" data-reaction="üëç" aria-label="React with thumbs up">üëç</button>
        <button class="reaction-btn" data-reaction="‚ù§Ô∏è" aria-label="React with heart">‚ù§Ô∏è</button>
        <button class="reaction-btn" data-reaction="üòÜ" aria-label="React with laugh">üòÜ</button>
        <span class="reaction-count" id="reaction-count"></span>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, remove, onValue, off } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const CLOUDINARY_CLOUD_NAME = "dqkujefxj";
    const CLOUDINARY_UPLOAD_PRESET = "banter_box";
    const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
    const ENCRYPTION_KEY = "my-secret-key-123";

    const themes = [
      {
        id: "light",
        name: "Light",
        properties: {
          "--background": "#FFFFFF",
          "--chat-bg": "#F5F7FB",
          "--text-primary": "#111B21",
          "--text-secondary": "#667781",
          "--border": "#E9ECEF",
          "--accent": "#00A884",
          "--status-bar": "#D9D9D9",
          "--fab-bg": "#00A884",
          "--fab-text": "#FFFFFF",
          "--online": "#4CAF50",
          "--offline": "#B0BEC5",
          "--typing": "#FFD54F",
          "--alert-success": "#E6FFF3",
          "--alert-error": "#FFE6E6",
          "--status-ring": "#00A884",
          "--status-ring-viewed": "#B0BEC5",
          "--progress-bar": "#00A884"
        }
      },
      {
        id: "dark",
        name: "Dark",
        properties: {
          "--background": "#1A202C",
          "--chat-bg": "#2D3748",
          "--text-primary": "#E2E8F0",
          "--text-secondary": "#A0AEC0",
          "--border": "#4A5568",
          "--accent": "#38B2AC",
          "--status-bar": "#718096",
          "--fab-bg": "#38B2AC",
          "--fab-text": "#FFFFFF",
          "--online": "#66BB6A",
          "--offline": "#78909C",
          "--typing": "#FFCA28",
          "--alert-success": "#2D6B5E",
          "--alert-error": "#7B3F3F",
          "--status-ring": "#38B2AC",
          "--status-ring-viewed": "#78909C",
          "--progress-bar": "#38B2AC"
        }
      },
      {
        id: "ocean",
        name: "Ocean",
        properties: {
          "--background": "#E6F3FA",
          "--chat-bg": "#B3E5FC",
          "--text-primary": "#1A3C5E",
          "--text-secondary": "#4A739B",
          "--border": "#90CDF4",
          "--accent": "#2B6CB0",
          "--status-bar": "#A3BFFA",
          "--fab-bg": "#2B6CB0",
          "--fab-text": "#FFFFFF",
          "--online": "#4CAF50",
          "--offline": "#B0BEC5",
          "--typing": "#FFD54F",
          "--alert-success": "#E0F7FA",
          "--alert-error": "#FFCDD2",
          "--status-ring": "#2B6CB0",
          "--status-ring-viewed": "#90CDF4",
          "--progress-bar": "#2B6CB0"
        }
      },
      {
        id: "sunset",
        name: "Sunset",
        properties: {
          "--background": "#FFF5F5",
          "--chat-bg": "#FEE2E2",
          "--text-primary": "#742A2A",
          "--text-secondary": "#B7791F",
          "--border": "#FED7D7",
          "--accent": "#F56565",
          "--status-bar": "#FBB6CE",
          "--fab-bg": "#F56565",
          "--fab-text": "#FFFFFF",
          "--online": "#D81B60",
          "--offline": "#D6A4A4",
          "--typing": "#FFB300",
          "--alert-success": "#FFEBEE",
          "--alert-error": "#FFAB91",
          "--status-ring": "#F56565",
          "--status-ring-viewed": "#D6A4A4",
          "--progress-bar": "#F56565"
        }
      }
    ];

    const userAvatar = document.querySelector('.header-actions .avatar');
    const searchInput = document.getElementById('search-input');
    const userSearchInput = document.getElementById('user-search-input');
    const chatList = document.getElementById('chat-list');
    const fab = document.getElementById('fab');
    const fabIcon = document.getElementById('fab-icon');
    const fabLabel = document.getElementById('fab-label');
    const userSlide = document.getElementById('user-slide');
    const bottomSheet = document.getElementById('bottom-sheet');
    const createRoomSheet = document.getElementById('create-room-sheet');
    const createGroupSheet = document.getElementById('create-group-sheet');
    const statusUploadInput = document.getElementById('status-upload-input');
    const alertBox = document.getElementById('alert');
    const alertMessage = document.querySelector('.alert-message');
    const alertClose = document.querySelector('.alert-close');
    const uploadOverlay = document.getElementById('upload-overlay');
    const progressBar = document.getElementById('progress-bar');
    const statusViewer = document.getElementById('status-viewer');
    const statusMedia = document.getElementById('status-media');
    const statusMediaVideo = document.getElementById('status-media-video');
    const statusUserName = document.querySelector('.status-user-name');
    const statusTimestamp = document.querySelector('.status-timestamp');
    const statusProgressContainer = document.getElementById('status-progress-container');
    const reactionCount = document.getElementById('reaction-count');
    const tabItems = document.querySelectorAll('.nav-item');
    let currentTab = 'chats';
    let listeners = [];
    let chatsData = [];
    let roomsData = [];
    let groupsData = [];
    let statusesData = [];
    let usersData = {};
    let currentStatusIndex = 0;
    let currentStatusUserId = null;
    let statusTimer = null;
    let touchStartX = 0;

    const MESSAGES = {
      SIGN_IN_REQUIRED: "Please sign in to perform this action.",
      PROFILE_FAIL: "Failed to load profile. Please try again.",
      USER_FAIL: "Failed to load users. Please try again.",
      STATUS_FAIL: "Failed to load statuses. Please try again.",
      STATUS_UPLOAD_SUCCESS: "Status uploaded successfully!",
      STATUS_UPLOAD_FAIL: "Failed to upload status. Please try again.",
      STATUS_DELETE_SUCCESS: "Status deleted successfully!",
      STATUS_DELETE_FAIL: "Failed to delete status. Please try again.",
      ROOM_DELETE_SUCCESS: "Room deleted successfully!",
      ROOM_DELETE_FAIL: "Failed to delete room. Please try again.",
      GROUP_DELETE_SUCCESS: "Group deleted successfully!",
      GROUP_DELETE_FAIL: "Failed to delete group. Please try again.",
      FRIEND_REQUEST_SENT: "Friend request sent successfully!",
      FRIEND_REQUEST_FAIL: "Failed to send friend request. Please try again.",
      ROOM_CREATE_SUCCESS: "Room created successfully!",
      ROOM_CREATE_FAIL: "Failed to create room. Please try again.",
      GROUP_CREATE_SUCCESS: "Group created successfully!",
      GROUP_CREATE_FAIL: "Failed to create group. Please try again.",
      BUSINESS_FAIL: "Failed to load business accounts. Please try again.",
      NO_MEDIA_SELECTED: "Please select a media file.",
      STATUS_REACTION_SUCCESS: "Reaction added!",
      STATUS_REACTION_FAIL: "Failed to add reaction.",
      STATUS_DELETE_CONFIRM: "Are you sure you want to delete this status?",
      ROOM_DELETE_CONFIRM: "Are you sure you want to delete this room?",
      GROUP_DELETE_CONFIRM: "Are you sure you want to delete this group?"
    };

    function showShimmer(element) {
      element.setAttribute('aria-busy', 'true');
      element.innerHTML = '';
    }

    function cleanupListeners() {
      listeners.forEach(({ ref, callback }) => {
        off(ref, 'value', callback);
      });
      listeners = [];
    }

    function addListener(ref, callback, errorCallback) {
      const wrappedCallback = (snapshot) => {
        try {
          callback(snapshot);
        } catch (error) {
          console.error("Listener error:", error);
          if (errorCallback) errorCallback(error);
        }
      };
      onValue(ref, wrappedCallback);
      listeners.push({ ref, callback: wrappedCallback });
    }

    window.showUserSlide = function () {
      userSlide.classList.add('active');
      loadAllUsers();
    };

    window.hideUserSlide = function () {
      userSlide.classList.remove('active');
      document.getElementById('user-list').innerHTML = '';
      userSearchInput.value = '';
    };

    window.showBottomSheet = function () {
      bottomSheet.classList.add('active');
    };

    window.hideBottomSheet = function () {
      bottomSheet.classList.remove('active');
      document.getElementById('friend-id').value = '';
    };

    window.showRoomSheet = function () {
      createRoomSheet.classList.add('active');
    };

    window.hideRoomSheet = function () {
      createRoomSheet.classList.remove('active');
      document.getElementById('room-name').value = '';
    };

    window.showGroupSheet = function () {
      createGroupSheet.classList.add('active');
      loadGroupMembers();
    };

    window.hideGroupSheet = function () {
      createGroupSheet.classList.remove('active');
      document.getElementById('group-name').value = '';
      document.getElementById('group-members').innerHTML = '';
    };

    window.showAlert = function (message, isSuccess = false, onConfirm = null) {
      alertMessage.textContent = message;
      alertBox.classList.remove('success', 'error');
      alertBox.classList.add(isSuccess ? 'success' : 'error');
      alertBox.classList.add('active');
      alertClose.style.display = onConfirm ? 'block' : 'none';
      alertClose.onclick = () => {
        alertBox.classList.remove('active');
        if (onConfirm) onConfirm();
      };
      if (!onConfirm) {
        setTimeout(() => {
          alertBox.classList.remove('active');
        }, 2000);
      }
    };

    window.showStatusViewer = function (userId, statuses, user) {
      currentStatusUserId = userId;
      currentStatusIndex = 0;
      statusViewer.classList.add('active');
      renderStatusViewer(statuses, user);
    };

    window.hideStatusViewer = function () {
      statusViewer.classList.remove('active');
      statusMedia.src = '';
      statusMediaVideo.src = '';
      statusMediaVideo.style.display = 'none';
      statusMedia.style.display = 'none';
      statusMediaVideo.pause();
      clearInterval(statusTimer);
      currentStatusIndex = 0;
      currentStatusUserId = null;
      statusProgressContainer.innerHTML = '';
    };

    window.navigateStatus = function (direction) {
      const statuses = statusesData.filter(s => s.uid === currentStatusUserId);
      const newIndex = currentStatusIndex + direction;
      if (newIndex < 0 || newIndex >= statuses.length) {
        window.hideStatusViewer();
        return;
      }
      currentStatusIndex = newIndex;
      renderStatusViewer(statuses, usersData[currentStatusUserId] || { name: 'Unknown' });
    };

    async function applyUserTheme(userId) {
      try {
        const userRef = ref(db, `users/${userId}`);
        addListener(userRef, (snapshot) => {
          if (snapshot.exists()) {
            const user = snapshot.val();
            const themeId = user.theme || "light";
            const selectedTheme = themes.find(theme => theme.id === themeId) || themes[0];
            Object.entries(selectedTheme.properties).forEach(([key, value]) => {
              document.documentElement.style.setProperty(key, value);
            });
          }
        }, (error) => {
          console.error("Error listening to user theme:", error);
        });
      } catch (error) {
        console.error("Error applying theme:", error);
      }
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Never';
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      if (diff < 60 * 1000) return 'Just now';
      if (diff < 60 * 60 * 1000) return `${Math.floor(diff / (60 * 1000))}m ago`;
      if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / (60 * 60 * 1000))}h ago`;
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    async function setOnlineStatus(userId, isOnline) {
      try {
        await update(ref(db, `users/${userId}`), {
          online: isOnline,
          lastSeen: isOnline ? null : Date.now()
        });
      } catch (error) {
        console.error("Error updating online status:", error);
      }
    }

    async function loadChats(userId) {
      showShimmer(chatList);
      const friendsRef = ref(db, `users/${userId}/friends`);
      const messagesRef = ref(db, 'messages');
      const usersRef = ref(db, 'users');
      
      try {
        const [friendsSnapshot, messagesSnapshot, usersSnapshot] = await Promise.all([
          get(friendsRef),
          get(messagesRef),
          get(usersRef)
        ]);

        const friends = friendsSnapshot.val() || {};
        const messages = messagesSnapshot.val() || {};
        usersData = usersSnapshot.val() || {};

        const engagedFriends = new Set();
        for (const chatKey in messages) {
          if (chatKey.includes(userId)) {
            const otherUserId = chatKey.split('_').find(id => id !== userId);
            if (otherUserId && friends[otherUserId]) {
              engagedFriends.add(otherUserId);
            }
          }
        }

        chatsData = [];
        for (const friendId of engagedFriends) {
          const lastMessageRef = ref(db, `messages/${userId}_${friendId}`);
          const lastMessageSnapshot = await get(lastMessageRef);
          const lastMessage = lastMessageSnapshot.val() ? Object.values(lastMessageSnapshot.val()).pop() : null;
          chatsData.push({
            id: friendId,
            name: usersData[friendId]?.name || 'Unknown',
            avatar: usersData[friendId]?.avatar,
            lastMessage: lastMessage ? lastMessage.text : 'No messages yet',
            timestamp: lastMessage ? lastMessage.timestamp : 0,
            online: usersData[friendId]?.online || false,
            lastSeen: usersData[friendId]?.lastSeen || 0,
            typing: false
          });
        }

        chatsData.sort((a, b) => b.timestamp - a.timestamp);
        renderChats(chatsData, userId);

        engagedFriends.forEach(friendId => {
          const typingRef = ref(db, `typing/${friendId}_${userId}`);
          addListener(typingRef, (snapshot) => {
            const isTyping = snapshot.val() || false;
            const chat = chatsData.find(c => c.id === friendId);
            if (chat) {
              chat.typing = isTyping;
              renderChats(chatsData, userId);
            }
          }, (error) => console.error("Error listening to typing status:", error));
        });

        addListener(usersRef, (snapshot) => {
          const updatedUsers = snapshot.val() || {};
          chatsData.forEach(chat => {
            chat.online = updatedUsers[chat.id]?.online || false;
            chat.lastSeen = updatedUsers[chat.id]?.lastSeen || 0;
          });
          renderChats(chatsData, userId);
        }, (error) => console.error("Error listening to users:", error));
      } catch (error) {
        console.error("Error loading chats:", error);
        window.showAlert(MESSAGES.USER_FAIL, false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load chats.</p>';
      }
    }

    async function renderChats(chats, userId) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      
      if (currentTab === 'chats') {
        const businessScroll = document.createElement('div');
        businessScroll.className = 'business-scroll';
        try {
          const businessesRef = ref(db, 'businesses');
          const snapshot = await get(businessesRef);
          const businesses = snapshot.val() || {};

          Object.entries(businesses).forEach(([businessId, business]) => {
            const businessItem = document.createElement('div');
            businessItem.className = 'business-item';
            businessItem.setAttribute('role', 'button');
            businessItem.setAttribute('aria-label', `View business ${business.name}`);
            const thumbnail = business.avatar
              ? `${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${business.avatar}?q_auto,f_auto,w_120,h_120,c_fill`
              : 'https://via.placeholder.com/120';
            console.log(`Business thumbnail for ${business.name}:`, thumbnail);
            businessItem.innerHTML = `
              <img src="${thumbnail}" class="business-preview" alt="${business.name}'s Preview" onerror="this.src='https://via.placeholder.com/120';" />
              <div class="business-preview-overlay"></div>
              <div class="business-info">
                <h3 class="business-name">${business.name}</h3>
                <p class="business-category">${business.category || 'Business'}</p>
              </div>
            `;
            businessItem.onclick = () => window.location.href = `business.html?businessId=${businessId}`;
            businessScroll.appendChild(businessItem);
          });

          if (businessScroll.children.length > 0) {
            chatList.appendChild(businessScroll);
          }
        } catch (error) {
          console.error("Error loading business accounts:", error);
          window.showAlert(MESSAGES.BUSINESS_FAIL, false);
        }
      }

      const filteredChats = searchInput.value
        ? chats.filter(chat => chat.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : chats;

      filteredChats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.setAttribute('role', 'button');
        chatItem.setAttribute('aria-label', `Chat with ${chat.name}`);
        const statusText = chat.typing ? 'Typing...' : (chat.online ? 'Online' : `Last seen ${formatTimestamp(chat.lastSeen)}`);
        const statusClass = chat.typing ? 'typing' : (chat.online ? 'online' : 'offline');
        const avatarUrl = chat.avatar
          ? `${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${chat.avatar}?q_auto,f_auto,w_48,h_48,c_fill`
          : null;
        console.log(`Chat avatar for ${chat.name}:`, avatarUrl || 'Using initials');
        chatItem.innerHTML = `
          <div class="avatar">${avatarUrl ? `<img src="${avatarUrl}" alt="${chat.name}'s avatar" onerror="this.parentElement.textContent='${chat.name.charAt(0).toUpperCase()}'" />` : chat.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${chat.name}</h3>
            <p class="chat-message">${chat.lastMessage}</p>
            <p class="chat-status ${statusClass}">${statusText}</p>
          </div>
          <span class="chat-time">${formatTimestamp(chat.timestamp)}</span>
        `;
        chatItem.onclick = () => window.location.href = `chat.html?friendId=${chat.id}`;
        chatList.appendChild(chatItem);
      });

      if (filteredChats.length === 0 && (!businessScroll || businessScroll.children.length === 0)) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No chats or business accounts available.</p>';
      }
    }

    async function uploadStatus() {
      const file = statusUploadInput.files[0];
      if (!file) {
        window.showAlert(MESSAGES.NO_MEDIA_SELECTED, false);
        return;
      }
      const validTypes = ['image/jpeg', 'image/png', 'video/mp4', 'video/webm'];
      if (!validTypes.includes(file.type)) {
        window.showAlert("Unsupported file format. Use JPEG, PNG, MP4, or WebM.", false);
        return;
      }
      uploadOverlay.classList.add('active');
      progressBar.style.width = '0%';
      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress = Math.min(progress + 10, 80);
          progressBar.style.width = `${progress}%`;
        }, 200);

        const response = await fetch(CLOUDINARY_API_URL, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        if (!data.secure_url || !data.public_id) {
          console.error("Cloudinary upload failed:", data);
          throw new Error('Cloudinary upload failed: Invalid response');
        }
        const statusId = Date.now().toString();
        const statusData = {
          url: data.public_id,
          caption: '',
          resource_type: file.type.startsWith('video/') ? 'video' : 'image',
          timestamp: Date.now(),
          views: {},
          reactions: {}
        };
        await set(ref(db, `statuses/${auth.currentUser.uid}/${statusId}`), statusData);
        console.log("Status uploaded to Firebase:", { statusId, ...statusData });
        setTimeout(() => {
          uploadOverlay.classList.remove('active');
          window.showAlert(MESSAGES.STATUS_UPLOAD_SUCCESS, true);
        }, 500);
        statusUploadInput.value = '';
        const existingIndex = statusesData.findIndex(s => s.statusId === statusId && s.uid === auth.currentUser.uid);
        if (existingIndex === -1) {
          statusesData.unshift({ statusId, uid: auth.currentUser.uid, ...statusData });
        } else {
          statusesData[existingIndex] = { statusId, uid: auth.currentUser.uid, ...statusData };
        }
        renderStatuses(statusesData, auth.currentUser.uid);
      } catch (error) {
        console.error("Error uploading status:", error);
        clearInterval(progressInterval);
        uploadOverlay.classList.remove('active');
        window.showAlert(MESSAGES.STATUS_UPLOAD_FAIL, false);
      }
    }

    async function loadStatuses(userId) {
      if (!userId) return;
      showShimmer(chatList);
      const statusesRef = ref(db, 'statuses');
      cleanupListeners();
      addListener(statusesRef, (snapshot) => {
        statusesData = [];
        const statuses = snapshot.val() || {};
        const now = Date.now();
        for (const uid in statuses) {
          const userStatuses = Object.entries(statuses[uid])
            .map(([statusId, status]) => {
              if (!status.url) {
                console.warn(`Missing URL for status ${statusId} of user ${uid}`);
                return null;
              }
              return { statusId, uid, ...status };
            })
            .filter(status => status && now - status.timestamp < 24 * 60 * 60 * 1000)
            .sort((a, b) => b.timestamp - a.timestamp);
          statusesData.push(...userStatuses);
        }
        console.log("Loaded statuses:", statusesData);
        renderStatuses(statusesData, userId);
      }, (error) => {
        console.error("Error loading statuses:", error);
        window.showAlert(MESSAGES.STATUS_FAIL, false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load statuses.</p>';
      });
    }

    async function renderStatuses(statuses, userId) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';
      const statusSection = document.createElement('div');
      statusSection.className = 'status-section';

      const usersRef = ref(db, 'users');
      let users = {};
      try {
        const usersSnapshot = await get(usersRef);
        users = usersSnapshot.val() || {};
      } catch (error) {
        console.error("Error fetching users:", error);
        window.showAlert(MESSAGES.USER_FAIL, false);
        return;
      }

      const groupedStatuses = {};
      statuses.forEach(status => {
        if (!groupedStatuses[status.uid]) {
          groupedStatuses[status.uid] = [];
        }
        groupedStatuses[status.uid].push(status);
      });

      const filteredUsers = searchInput.value
        ? Object.keys(groupedStatuses).filter(uid => users[uid]?.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : Object.keys(groupedStatuses);

      filteredUsers.forEach(uid => {
        const userStatuses = groupedStatuses[uid].sort((a, b) => b.timestamp - a.timestamp);
        const latestStatus = userStatuses[0];
        const isOwnStatus = uid === userId;
        const allViewed = userStatuses.every(status => status.views?.[userId]);
        const statusItem = document.createElement('div');
        statusItem.className = `status-item ${allViewed ? 'viewed' : ''}`;
        statusItem.setAttribute('role', 'button');
        statusItem.setAttribute('aria-label', `View ${isOwnStatus ? 'your' : users[uid]?.name || 'Unknown'}'s status`);
        const thumbnail = latestStatus.url
          ? (latestStatus.resource_type === 'image'
              ? `${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${latestStatus.url}?q_auto,f_auto,w_48,h_48,c_fill`
              : `${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${latestStatus.url.replace(/\.mp4$/, '')}?w_48,h_48,c_fill,q_auto,f_jpg#t_0.1`)
          : 'https://via.placeholder.com/48';
        console.log(`Status thumbnail for ${users[uid]?.name || 'Unknown'}:`, thumbnail);
        statusItem.innerHTML = `
          <div class="avatar">
            ${users[uid]?.avatar ? `<img src="${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${users[uid].avatar}?q_auto,f_auto,w_48,h_48,c_fill" alt="${users[uid]?.name}'s avatar" onerror="this.parentElement.textContent='${users[uid]?.name?.charAt(0).toUpperCase() || 'U'}'" />` : users[uid]?.name?.charAt(0).toUpperCase() || 'U'}
            <div class="status-ring ${allViewed ? 'viewed' : ''}"></div>
          </div>
          <div class="chat-info">
            <h3 class="chat-name">${isOwnStatus ? 'My Status' : users[uid]?.name || 'Unknown'}</h3>
            <p class="chat-message">${formatTimestamp(latestStatus.timestamp)}</p>
          </div>
          ${isOwnStatus ? `
            <button class="kebab-menu" data-status-uid="${uid}" aria-label="Status options">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="context-menu" data-status-uid="${uid}">
              <div class="context-menu-item" onclick="window.deleteStatus('${uid}', '${latestStatus.statusId}')">Delete</div>
            </div>
          ` : ''}
        `;
        statusItem.onclick = (e) => {
          if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
            window.showStatusViewer(uid, userStatuses, users[uid] || { name: 'Unknown' });
          }
        };
        if (isOwnStatus) {
          const kebabMenu = statusItem.querySelector('.kebab-menu');
          kebabMenu.onclick = (e) => {
            e.stopPropagation();
            const contextMenu = statusItem.querySelector('.context-menu');
            document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
            contextMenu.classList.toggle('active');
          };
        }
        statusSection.appendChild(statusItem);
      });

      if (filteredUsers.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No statuses available.</p>';
      } else {
        chatList.appendChild(statusSection);
      }
    }

    async function renderStatusViewer(statuses, user) {
      clearInterval(statusTimer);
      const status = statuses[currentStatusIndex];
      if (!status || !status.url) {
        console.error("Invalid status or missing URL:", status);
        window.showAlert("Failed to load status media.", false);
        window.hideStatusViewer();
        return;
      }
      const isOwnStatus = status.uid === auth.currentUser.uid;

      statusUserName.textContent = isOwnStatus ? 'My Status' : user.name || 'Unknown';
      statusTimestamp.textContent = formatTimestamp(status.timestamp);
      statusViewer.querySelector('.avatar').innerHTML = user.avatar
        ? `<img src="${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${user.avatar}?q_auto,f_auto,w_48,h_48,c_fill" alt="${user.name}'s avatar" onerror="this.parentElement.textContent='${user.name?.charAt(0).toUpperCase() || 'U'}'" />`
        : user.name?.charAt(0).toUpperCase() || 'U';

      statusProgressContainer.innerHTML = '';
      statuses.forEach((_, index) => {
        const bar = document.createElement('div');
        bar.className = 'status-progress-bar';
        const fill = document.createElement('div');
        fill.className = 'status-progress-fill';
        if (index === currentStatusIndex) {
          fill.style.width = '0%';
          const duration = status.resource_type === 'video' ? 15000 : 5000;
          fill.style.transition = `width ${duration}ms linear`;
          setTimeout(() => {
            fill.style.width = '100%';
            statusTimer = setTimeout(() => {
              window.navigateStatus(1);
            }, duration);
          }, 100);
        } else if (index < currentStatusIndex) {
          fill.style.width = '100%';
        }
        bar.appendChild(fill);
        statusProgressContainer.appendChild(bar);
      });

      statusMedia.style.display = 'none';
      statusMediaVideo.style.display = 'none';
      statusMediaVideo.pause();
      if (status.resource_type === 'image') {
        statusMedia.src = `${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${status.url}?q_auto,f_auto`;
        statusMedia.style.display = 'block';
        console.log("Loading image status:", statusMedia.src);
      } else {
        statusMediaVideo.src = `${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${status.url}?q_auto,f_auto`;
        statusMediaVideo.style.display = 'block';
        statusMediaVideo.play().catch(error => {
          console.error("Error playing video:", error);
          window.showAlert("Failed to play video status.", false);
        });
        console.log("Loading video status:", statusMediaVideo.src);
      }

      if (!isOwnStatus && !status.views?.[auth.currentUser.uid]) {
        update(ref(db, `statuses/${status.uid}/${status.statusId}/views`), {
          [auth.currentUser.uid]: true
        });
        status.views = status.views || {};
        status.views[auth.currentUser.uid] = true;
        renderStatuses(statusesData, auth.currentUser.uid);
      }

      const reactions = status.reactions || {};
      const reactionCounts = {};
      Object.values(reactions).forEach(reaction => {
        reactionCounts[reaction] = (reactionCounts[reaction] || 0) + 1;
      });
      reactionCount.textContent = Object.keys(reactions).length > 0
        ? `${Object.keys(reactions).length} ${Object.entries(reactionCounts).map(([emoji, count]) => `${emoji} ${count}`).join(', ')}`
        : '';

      document.querySelectorAll('.reaction-btn').forEach(btn => {
        btn.onclick = async () => {
          const reaction = btn.dataset.reaction;
          try {
            await update(ref(db, `statuses/${status.uid}/${status.statusId}/reactions`), {
              [auth.currentUser.uid]: reaction
            });
            status.reactions = status.reactions || {};
            status.reactions[auth.currentUser.uid] = reaction;
            const updatedCounts = {};
            Object.values(status.reactions).forEach(r => {
              updatedCounts[r] = (updatedCounts[r] || 0) + 1;
            });
            reactionCount.textContent = Object.keys(status.reactions).length > 0
              ? `${Object.keys(status.reactions).length} ${Object.entries(updatedCounts).map(([emoji, count]) => `${emoji} ${count}`).join(', ')}`
              : '';
            window.showAlert(MESSAGES.STATUS_REACTION_SUCCESS, true);
          } catch (error) {
            console.error("Error adding reaction:", error);
            window.showAlert(MESSAGES.STATUS_REACTION_FAIL, false);
          }
        };
      });
    }

    async function deleteStatus(uid, statusId) {
      window.showAlert(MESSAGES.STATUS_DELETE_CONFIRM, false, async () => {
        try {
          await remove(ref(db, `statuses/${uid}/${statusId}`));
          window.showAlert(MESSAGES.STATUS_DELETE_SUCCESS, true);
          statusesData = statusesData.filter(s => s.statusId !== statusId || s.uid !== uid);
          renderStatuses(statusesData, auth.currentUser.uid);
        } catch (error) {
          console.error("Error deleting status:", error);
          window.showAlert(MESSAGES.STATUS_DELETE_FAIL, false);
        }
      });
    }

    async function loadGroupMembers() {
      const select = document.getElementById('group-members');
      select.innerHTML = '';
      try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const users = snapshot.val() || {};
        Object.entries(users).forEach(([uid, user]) => {
          if (uid !== auth.currentUser.uid) {
            const option = document.createElement('option');
            option.value = uid;
            option.textContent = user.name || 'Unknown';
            select.appendChild(option);
          }
        });
      } catch (error) {
        console.error("Error loading group members:", error);
        window.showAlert(MESSAGES.USER_FAIL, false);
      }
    }

    async function loadAllUsers() {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '';
      try {
        const usersRef = ref(db, 'users');
        const friendsRef = ref(db, `users/${auth.currentUser.uid}/friends`);
        const [usersSnapshot, friendsSnapshot] = await Promise.all([
          get(usersRef),
          get(friendsRef)
        ]);
        const users = usersSnapshot.val() || {};
        const friends = friendsSnapshot.val() || {};
        const filteredUsers = userSearchInput.value
          ? Object.entries(users).filter(([uid, user]) => 
              uid !== auth.currentUser.uid && user.name.toLowerCase().includes(userSearchInput.value.toLowerCase())
            )
          : Object.entries(users).filter(([uid]) => uid !== auth.currentUser.uid);

        filteredUsers.forEach(([uid, user]) => {
          const userItem = document.createElement('div');
          userItem.className = 'user-item';
          userItem.setAttribute('role', 'button');
          userItem.setAttribute('aria-label', `Start chat with ${user.name || 'Unknown'}`);
          const avatarUrl = user.avatar
            ? `${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${user.avatar}?q_auto,f_auto,w_40,h_40,c_fill`
            : null;
          console.log(`User slide avatar for ${user.name}:`, avatarUrl || 'Using initials');
          userItem.innerHTML = `
            <div class="avatar">${avatarUrl ? `<img src="${avatarUrl}" alt="${user.name}'s avatar" onerror="this.parentElement.textContent='${user.name?.charAt(0).toUpperCase() || 'U'}'" />` : user.name?.charAt(0).toUpperCase() || 'U'}</div>
            <span class="user-name">${user.name || 'Unknown'}</span>
            ${!friends[uid] ? '<span class="suggested-friend">Suggested Friend</span>' : ''}
          `;
          userItem.onclick = () => {
            window.hideUserSlide();
            window.location.href = `chat.html?friendId=${uid}`;
          };
          userList.appendChild(userItem);
        });

        if (!userList.hasChildNodes()) {
          userList.innerHTML = '<p style="text-align: center; padding: 1rem;">No users found.</p>';
        }
      } catch (error) {
        console.error("Error loading users:", error);
        window.showAlert(MESSAGES.USER_FAIL, false);
        userList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load users.</p>';
      }
    }

    async function addFriend() {
      const friendId = document.getElementById('friend-id').value.trim();
      if (!friendId) {
        window.showAlert("Please enter a valid user ID.", false);
        return;
      }
      try {
        const userId = auth.currentUser.uid;
        const friendRef = ref(db, `users/${userId}/friends/${friendId}`);
        await set(friendRef, { addedAt: Date.now() });
        window.showAlert(MESSAGES.FRIEND_REQUEST_SENT, true);
        window.hideBottomSheet();
        loadChats(userId);
      } catch (error) {
        console.error("Error adding friend:", error);
        window.showAlert(MESSAGES.FRIEND_REQUEST_FAIL, false);
      }
    }

    async function createRoom() {
      const roomName = document.getElementById('room-name').value.trim();
      if (!roomName) {
        window.showAlert("Please enter a room name.", false);
        return;
      }
      try {
        const roomId = Date.now().toString();
        await set(ref(db, `chatrooms/${roomId}`), {
          name: roomName,
          creator: auth.currentUser.uid,
          createdAt: Date.now()
        });
        window.showAlert(MESSAGES.ROOM_CREATE_SUCCESS, true);
        window.hideRoomSheet();
        roomsData.push({ id: roomId, name: roomName, creator: auth.currentUser.uid, createdAt: Date.now() });
        renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), auth.currentUser.uid);
      } catch (error) {
        console.error("Error creating room:", error);
        window.showAlert(MESSAGES.ROOM_CREATE_FAIL, false);
      }
    }

    async function createGroup() {
      const groupName = document.getElementById('group-name').value.trim();
      const selectedMembers = Array.from(document.getElementById('group-members').selectedOptions).map(option => option.value);
      if (!groupName || selectedMembers.length === 0) {
        window.showAlert("Please enter a group name and select at least one member.", false);
        return;
      }
      try {
        const groupId = Date.now().toString();
        const members = { [auth.currentUser.uid]: true };
        selectedMembers.forEach(memberId => { members[memberId] = true; });
        await set(ref(db, `groups/${groupId}`), {
          name: groupName,
          creator: auth.currentUser.uid,
          members,
          createdAt: Date.now()
        });
        window.showAlert(MESSAGES.GROUP_CREATE_SUCCESS, true);
        window.hideGroupSheet();
        groupsData.push({ id: groupId, name: groupName, creator: auth.currentUser.uid, members, createdAt: Date.now() });
        renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), auth.currentUser.uid);
      } catch (error) {
        console.error("Error creating group:", error);
        window.showAlert(MESSAGES.GROUP_CREATE_FAIL, false);
      }
    }

    async function loadRooms(userId) {
      showShimmer(chatList);
      const roomsRef = ref(db, 'chatrooms');
      cleanupListeners();
      addListener(roomsRef, (snapshot) => {
        roomsData = [];
        const rooms = snapshot.val() || {};
        roomsData = Object.entries(rooms).map(([id, room]) => ({ id, ...room }));
        renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), userId);
      }, (error) => {
        console.error("Error loading rooms:", error);
        window.showAlert(MESSAGES.ROOM_FAIL || "Failed to load rooms. Please try again.", false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load rooms.</p>';
      });
    }

    async function renderRooms(rooms, userId) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';

      const filteredRooms = searchInput.value
        ? Object.values(rooms).filter(room => room.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : Object.values(rooms);

      filteredRooms.forEach(room => {
        const roomItem = document.createElement('div');
        roomItem.className = 'room-item';
        roomItem.setAttribute('role', 'button');
        roomItem.setAttribute('aria-label', `Open room ${room.name}`);
        roomItem.innerHTML = `
          <div class="avatar">${room.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${room.name}</h3>
            <p class="chat-message">Created by ${room.creator === userId ? 'You' : 'Someone'}</p>
          </div>
          ${room.creator === userId ? `
            <button class="kebab-menu" data-room-id="${room.id}" aria-label="Room options">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="context-menu" data-room-id="${room.id}">
              <div class="context-menu-item" onclick="window.deleteRoom('${room.id}')">Delete</div>
            </div>
          ` : ''}
        `;
        roomItem.onclick = (e) => {
          if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
            window.location.href = `room.html?roomId=${room.id}`;
          }
        };
        if (room.creator === userId) {
          const kebabMenu = roomItem.querySelector('.kebab-menu');
          kebabMenu.onclick = (e) => {
            e.stopPropagation();
            const contextMenu = roomItem.querySelector('.context-menu');
            document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
            contextMenu.classList.toggle('active');
          };
        }
        chatList.appendChild(roomItem);
      });

      if (filteredRooms.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No rooms available.</p>';
      }
    }

    async function deleteRoom(roomId) {
      window.showAlert(MESSAGES.ROOM_DELETE_CONFIRM, false, async () => {
        try {
          await remove(ref(db, `chatrooms/${roomId}`));
          window.showAlert(MESSAGES.ROOM_DELETE_SUCCESS, true);
          roomsData = roomsData.filter(room => room.id !== roomId);
          renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), auth.currentUser.uid);
        } catch (error) {
          console.error("Error deleting room:", error);
          window.showAlert(MESSAGES.ROOM_DELETE_FAIL, false);
        }
      });
    }

    async function loadGroups(userId) {
      showShimmer(chatList);
      const groupsRef = ref(db, 'groups');
      cleanupListeners();
      addListener(groupsRef, (snapshot) => {
        groupsData = [];
        const groups = snapshot.val() || {};
        groupsData = Object.entries(groups)
          .filter(([_, group]) => group.members && group.members[userId])
          .map(([id, group]) => ({ id, ...group }));
        renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), userId);
      }, (error) => {
        console.error("Error loading groups:", error);
        window.showAlert(MESSAGES.GROUP_FAIL || "Failed to load groups. Please try again.", false);
        chatList.setAttribute('aria-busy', 'false');
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">Failed to load groups.</p>';
      });
    }

    async function renderGroups(groups, userId) {
      chatList.setAttribute('aria-busy', 'false');
      chatList.innerHTML = '';

      const filteredGroups = searchInput.value
        ? Object.values(groups).filter(group => group.name.toLowerCase().includes(searchInput.value.toLowerCase()))
        : Object.values(groups);

      filteredGroups.forEach(group => {
        const groupItem = document.createElement('div');
        groupItem.className = 'group-item';
        groupItem.setAttribute('role', 'button');
        groupItem.setAttribute('aria-label', `Open group ${group.name}`);
        groupItem.innerHTML = `
          <div class="avatar">${group.name.charAt(0).toUpperCase()}</div>
          <div class="chat-info">
            <h3 class="chat-name">${group.name}</h3>
            <p class="chat-message">${group.members ? `${Object.keys(group.members).length} members` : 'No members'}</p>
          </div>
          ${group.creator === userId ? `
            <button class="kebab-menu" data-group-id="${group.id}" aria-label="Group options">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="context-menu" data-group-id="${group.id}">
              <div class="context-menu-item" onclick="window.deleteGroup('${group.id}')">Delete</div>
            </div>
          ` : ''}
        `;
        groupItem.onclick = (e) => {
          if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
            window.location.href = `group.html?groupId=${group.id}`;
          }
        };
        if (group.creator === userId) {
          const kebabMenu = groupItem.querySelector('.kebab-menu');
          kebabMenu.onclick = (e) => {
            e.stopPropagation();
            const contextMenu = groupItem.querySelector('.context-menu');
            document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
            contextMenu.classList.toggle('active');
          };
        }
        chatList.appendChild(groupItem);
      });

      if (filteredGroups.length === 0) {
        chatList.innerHTML = '<p style="text-align: center; padding: 1rem;">No groups available.</p>';
      }
    }

    async function deleteGroup(groupId) {
      window.showAlert(MESSAGES.GROUP_DELETE_CONFIRM, false, async () => {
        try {
          await remove(ref(db, `groups/${groupId}`));
          window.showAlert(MESSAGES.GROUP_DELETE_SUCCESS, true);
          groupsData = groupsData.filter(group => group.id !== groupId);
          renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), auth.currentUser.uid);
        } catch (error) {
          console.error("Error deleting group:", error);
          window.showAlert(MESSAGES.GROUP_DELETE_FAIL, false);
        }
      });
    }

    function handleTabSwitch(tab) {
      currentTab = tab;
      tabItems.forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tab);
      });
      searchInput.value = '';
      cleanupListeners();
      if (tab === 'chats') {
        fab.style.display = 'flex';
        fabIcon.innerHTML = `
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path>
        `;
        fabLabel.textContent = 'Users';
        fab.onclick = window.showUserSlide;
        loadChats(auth.currentUser.uid);
      } else if (tab === 'status') {
        fab.style.display = 'flex';
        fabIcon.innerHTML = `
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 16v.01M12 8v4"></path>
        `;
        fabLabel.textContent = 'Add Status';
        fab.onclick = () => statusUploadInput.click();
        loadStatuses(auth.currentUser.uid);
      } else if (tab === 'rooms') {
        fab.style.display = 'flex';
        fabIcon.innerHTML = `
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <path d="M3 9h18M9 21V9"></path>
        `;
        fabLabel.textContent = 'Create Room';
        fab.onclick = window.showRoomSheet;
        loadRooms(auth.currentUser.uid);
      } else if (tab === 'groups') {
        fab.style.display = 'flex';
        fabIcon.innerHTML = `
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path>
        `;
        fabLabel.textContent = 'Create Group';
        fab.onclick = window.showGroupSheet;
        loadGroups(auth.currentUser.uid);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userAvatar.innerHTML = user.photoURL
          ? `<img src="${CLOUDINARY_API_URL.replace('/auto/upload', '')}/${user.photoURL}?q_auto,f_auto,w_48,h_48,c_fill" alt="User avatar" onerror="this.parentElement.textContent='${user.displayName?.charAt(0).toUpperCase() || 'U'}'" />`
          : user.displayName?.charAt(0).toUpperCase() || 'U';
        await setOnlineStatus(user.uid, true);
        await applyUserTheme(user.uid);
        handleTabSwitch(currentTab);
        window.addEventListener('beforeunload', () => setOnlineStatus(user.uid, false));
      } else {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        window.location.href = 'login.html';
      }
    });

    tabItems.forEach(item => {
      item.addEventListener('click', () => {
        if (!auth.currentUser) {
          window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
          return;
        }
        handleTabSwitch(item.dataset.tab);
      });
    });

    searchInput.addEventListener('input', () => {
      if (currentTab === 'chats') {
        renderChats(chatsData, auth.currentUser.uid);
      } else if (currentTab === 'status') {
        renderStatuses(statusesData, auth.currentUser.uid);
      } else if (currentTab === 'rooms') {
        renderRooms(roomsData.reduce((acc, room) => ({ ...acc, [room.id]: room }), {}), auth.currentUser.uid);
      } else if (currentTab === 'groups') {
        renderGroups(groupsData.reduce((acc, group) => ({ ...acc, [group.id]: group }), {}), auth.currentUser.uid);
      }
    });

    userSearchInput.addEventListener('input', loadAllUsers);

    statusUploadInput.addEventListener('change', uploadStatus);

    statusViewer.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    });

    statusViewer.addEventListener('touchend', (e) => {
      const touchEndX = e.changedTouches[0].clientX;
      const deltaX = touchEndX - touchStartX;
      if (deltaX > 50) {
        window.navigateStatus(-1);
      } else if (deltaX < -50) {
        window.navigateStatus(1);
      }
    });

    statusViewer.addEventListener('click', (e) => {
      if (e.target.closest('.status-content') && !e.target.closest('.reaction-btn')) {
        const statuses = statusesData.filter(s => s.uid === currentStatusUserId);
        if (currentStatusIndex === statuses.length - 1) {
          window.hideStatusViewer();
        }
      }
    });

    window.addFriend = addFriend;
    window.createRoom = createRoom;
    window.createGroup = createGroup;
    window.deleteStatus = deleteStatus;
    window.deleteRoom = deleteRoom;
    window.deleteGroup = deleteGroup;

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.kebab-menu') && !e.target.closest('.context-menu')) {
        document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
      }
    });

    document.querySelectorAll('.context-menu').forEach(menu => {
      menu.addEventListener('click', (e) => e.stopPropagation());
    });
  </script>
</body>
</html>
