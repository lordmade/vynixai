<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ChatSphere</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
  <style>
    :root {
      --whatsapp-green: #25D366;
      --whatsapp-teal: #128C7E;
      --text-dark: #111B21;
      --text-light: #8696A0;
      --border: #E9EDEF;
      --white: #FFFFFF;
      --background: #EFEFEF;
      --chat-background: #ECE5DD;
      --text-dark-dark: #FFFFFF;
      --text-light-dark: #8696A0;
      --border-dark: #2A3942;
      --white-dark: #1C2526;
      --highlight: #F0F2F5;
    }

    [data-theme="dark"] {
      --background: #0B141A;
      --text-dark: var(--text-dark-dark);
      --text-light: var(--text-light-dark);
      --border: var(--border-dark);
      --white: var(--white-dark);
      --chat-background: #0B141A;
      --highlight: #2A3942;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: opacity 0.5s ease, background 0.3s ease;
    }

    .fade-out {
      opacity: 0;
    }

    .top-bar {
      background: var(--whatsapp-teal);
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--white);
    }

    .top-bar-title {
      font-size: 1.2rem;
      font-weight: 500;
    }

    .top-bar-actions {
      display: flex;
      gap: 1rem;
    }

    .top-bar-actions button {
      background: none;
      border: none;
      color: var(--white);
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .tabs {
      display: flex;
      justify-content: space-around;
      background: var(--white);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 3.5rem;
      z-index: 9;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 0.75rem 0;
      font-size: 1rem;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab.active {
      color: var(--whatsapp-green);
      border-bottom: 2px solid var(--whatsapp-green);
    }

    .main-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
    }

    .main-container.chats {
      display: block;
    }

    .main-container.status {
      display: block;
    }

    .main-container.chats .status-container,
    .main-container.status .chat-container {
      display: none;
    }

    .chat-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .chat-item:hover {
      background: var(--highlight);
    }

    .status-card {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .status-card:hover {
      background: var(--highlight);
    }

    .status-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .status-modal.active {
      display: flex;
    }

    .status-media {
      max-width: 90%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 8px;
    }

    .status-video {
      display: none;
    }

    .video-controls {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 1rem;
    }

    .control-btn {
      display: none;
    }

    .progress-bar-container {
      width: 80%;
      max-width: 400px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      position: absolute;
      bottom: 5%;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar {
      width: 0;
      height: 100%;
      background: var(--whatsapp-green);
      transition: width linear;
    }

    .swipe-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.5);
      color: var(--white);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .swipe-left {
      left: 1rem;
    }

    .swipe-right {
      right: 1rem;
    }

    .delete-status-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--white);
      cursor: pointer;
      display: none;
    }

    .status-info {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--white);
    }

    .status-info img,
    .status-info span {
      width: 32px;
      height: 32px;
    }

    .status-username {
      font-weight: 500;
    }

    .status-timestamp {
      font-size: 0.8rem;
      color: var(--text-light-dark);
    }

    .fab {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--whatsapp-green);
      color: var(--white);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .fab:hover {
      transform: scale(1.1);
      background: #20b858;
    }

    .add-friend-input {
      position: fixed;
      bottom: 5rem;
      right: 1.5rem;
      display: none;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 24px;
      background: var(--white);
      width: 200px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .add-friend-input.active {
      display: flex;
    }

    .add-friend-input input {
      flex: 1;
      border: none;
      outline: none;
      background: none;
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .add-friend-input button {
      background: none;
      border: none;
      color: var(--whatsapp-green);
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .toast {
      display: none;
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--white);
      padding: 0.75rem 1.5rem;
      border-radius: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 50;
      color: var(--text-dark);
      font-weight: 500;
    }

    .toast.active {
      display: block;
      animation: slideIn 0.3s ease-out forwards;
    }

    .spinner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--white);
      border-top-color: var(--whatsapp-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .custom-alert {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--white);
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      color: var(--text-dark);
      font-weight: 500;
      text-align: center;
      max-width: 90%;
      width: 320px;
      animation: fadeIn 0.3s ease-out forwards;
      border: 1px solid var(--border);
    }

    .custom-alert.active {
      display: block;
    }

    .custom-alert .close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      color: var(--whatsapp-green);
      cursor: pointer;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .custom-alert .close-btn:hover {
      transform: scale(1.2);
      color: #20b858;
    }

    .custom-alert .close-btn svg {
      width: 100%;
      height: 100%;
    }

    .upload-progress-container {
      width: 80%;
      max-width: 300px;
      height: 6px;
      background: var(--text-light);
      border-radius: 3px;
      overflow: hidden;
      display: none;
      margin: 0 auto;
    }

    .upload-progress-container.active {
      display: block;
    }

    .upload-progress {
      width: 0%;
      height: 100%;
      background: var(--whatsapp-green);
      transition: width 0.3s ease;
      animation: pulse 1.5s infinite ease-in-out;
    }

    .upload-progress-text {
      font-size: 0.8rem;
      color: var(--text-dark);
      margin-top: 0.25rem;
      text-align: center;
      display: none;
    }

    .upload-progress-text.active {
      display: block;
    }

    .cancel-upload-btn {
      padding: 0.5rem 1rem;
      background: var(--border);
      color: var(--text-dark);
      border: none;
      border-radius: 24px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      display: none;
      margin: 0.5rem auto;
    }

    .cancel-upload-btn.active {
      display: block;
    }

    .cancel-upload-btn:hover,
    .cancel-upload-btn:focus {
      background: var(--whatsapp-green);
      color: var(--white);
      transform: scale(1.05);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      0% { transform: translateX(-50%) translateY(20px); opacity: 0; }
      100% { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    @media (max-width: 640px) {
      .top-bar-title {
        font-size: 1.1rem;
      }
      .main-container {
        padding: 0.5rem;
      }
      .chat-item, .status-card {
        padding: 0.5rem;
      }
      .status-media {
        max-height: 60vh;
      }
      .progress-bar-container {
        width: 90%;
      }
      .fab {
        bottom: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
      }
      .add-friend-input {
        bottom: 4rem;
        right: 1rem;
        width: 180px;
      }
      .upload-progress-container {
        width: 90%;
      }
      .upload-progress-text {
        font-size: 0.75rem;
      }
      .cancel-upload-btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
      }
    }

    ::-webkit-scrollbar {
      display: none;
    }

    html {
      scrollbar-width: none;
    }
  </style>
</head>
<body>
  <div class="top-bar" role="banner">
    <span class="top-bar-title">ChatSphere</span>
    <div class="top-bar-actions">
      <button id="profile-btn" aria-label="View profile">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-8 h-8">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
        </svg>
      </button>
      <button id="sign-out-btn" aria-label="Sign out">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-8 h-8">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />
        </svg>
      </button>
    </div>
  </div>
  <div class="tabs" role="tablist">
    <div class="tab active" role="tab" aria-selected="true" data-tab="chats">Chats</div>
    <div class="tab" role="tab" aria-selected="false" data-tab="status">Status</div>
  </div>
  <div class="main-container chats">
    <div class="chat-container">
      <div id="chat-list" role="list"></div>
    </div>
    <div class="status-container">
      <div id="status-list" role="list"></div>
    </div>
  </div>
  <div class="fab" id="fab" aria-label="Add friend or status">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-6 h-6">
      <path d="M12 5v14M5 12h14" />
    </svg>
  </div>
  <div class="add-friend-input" id="add-friend-input">
    <input type="email" placeholder="Enter friend's email" aria-label="Friend's email" />
    <button id="add-friend-btn" aria-label="Add friend">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
      </svg>
    </button>
  </div>
  <input type="file" id="status-file-input" accept="image/jpeg,image/png,video/mp4,video/webm" aria-label="Upload status image or video" style="display: none;" />
  <div class="upload-progress-container" id="upload-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
    <div class="upload-progress" id="upload-progress"></div>
  </div>
  <span class="upload-progress-text" id="upload-progress-text">Uploading: 0%</span>
  <button class="cancel-upload-btn" id="cancel-upload-btn" aria-label="Cancel upload">Cancel</button>
  <div class="status-modal" id="status-modal">
    <button class="delete-status-btn" id="delete-status-btn" aria-label="Delete status">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 6h18M8 6V4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2m-3 4v9m-4-9v9M5 6l1 12a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1l1-12H5z" />
      </svg>
    </button>
    <div class="status-info">
      <div id="status-profile-pic"></div>
      <div>
        <div class="status-username" id="status-username"></div>
        <div class="status-timestamp" id="status-timestamp"></div>
      </div>
    </div>
    <img class="status-media" id="status-image" alt="Status image" />
    <video class="status-media status-video" id="status-video" autoplay playsinline muted></video>
    <div class="video-controls">
      <button class="control-btn" aria-label="Play/Pause">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 3l14 9-14 9V3z" />
        </svg>
      </button>
      <button class="control-btn" aria-label="Mute/Unmute">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 5L6 9H2v6h4l5 4V5zM15 9l6 6m-6-6l6 6" />
        </svg>
      </button>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="swipe-indicator swipe-left" id="swipe-left">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6" />
      </svg>
    </div>
    <div class="swipe-indicator swipe-right" id="swipe-right">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 6l6 6-6 6" />
      </svg>
    </div>
    <button class="status-modal-close" id="status-modal-close" aria-label="Close status modal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12" />
      </svg>
    </button>
  </div>
  <div class="toast" id="toast">
    <span id="toast-message"></span>
  </div>
  <div class="spinner-overlay" id="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <div id="custom-alert" class="custom-alert" role="alert">
    <button class="close-btn" aria-label="Close alert">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <p id="alert-message">An error occurred. Please try again later.</p>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, remove, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const tabs = document.querySelectorAll(".tab");
    const mainContainer = document.getElementById("main-container");
    const statusList = document.getElementById("status-list");
    const chatList = document.getElementById("chat-list");
    const statusModal = document.getElementById("status-modal");
    const statusModalClose = document.getElementById("status-modal-close");
    const statusImage = document.getElementById("status-image");
    const statusVideo = document.getElementById("status-video");
    const progressBar = document.getElementById("progress-bar");
    const swipeLeft = document.getElementById("swipe-left");
    const swipeRight = document.getElementById("swipe-right");
    const deleteStatusBtn = document.getElementById("delete-status-btn");
    const statusProfilePic = document.getElementById("status-profile-pic");
    const statusUsername = document.getElementById("status-username");
    const statusTimestamp = document.getElementById("status-timestamp");
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toast-message");
    const spinnerOverlay = document.getElementById("spinner-overlay");
    const profileBtn = document.getElementById("profile-btn");
    const signOutBtn = document.getElementById("sign-out-btn");
    const fab = document.getElementById("fab");
    const addFriendInput = document.getElementById("add-friend-input");
    const addFriendBtn = document.getElementById("add-friend-btn");
    const statusFileInput = document.getElementById("status-file-input");
    const uploadProgressContainer = document.getElementById("upload-progress-container");
    const uploadProgress = document.getElementById("upload-progress");
    const uploadProgressText = document.getElementById("upload-progress-text");
    const cancelUploadBtn = document.getElementById("cancel-upload-btn");
    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");

    const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/dqkujefxj/upload";
    const CLOUDINARY_UPLOAD_PRESET = "banter_box";
    const STATUS_EXPIRY_MS = 24 * 60 * 60 * 1000;
    const MAX_FILE_SIZE_MB = 10; // 10MB limit
    const VALID_IMAGE_TYPES = ["image/jpeg", "image/png"];
    const VALID_VIDEO_TYPES = ["video/mp4", "video/webm"];
    let currentUserId = null;
    let currentUsername = null;
    let currentProfilePic = null;
    let encryptionKey = null;
    let currentStatusIndex = 0;
    let currentStatuses = [];
    let currentStatusUserId = null;
    let xhr = null;

    function showToast(message) {
      toastMessage.textContent = message;
      toast.classList.add("active");
      setTimeout(() => toast.classList.remove("active"), 3000);
    }

    function showSpinner() {
      spinnerOverlay.classList.add("active");
    }

    function hideSpinner() {
      spinnerOverlay.classList.remove("active");
    }

    function showAlert(message, autoHide = true) {
      alertMessage.textContent = message;
      customAlert.classList.add("active");
      if (autoHide) setTimeout(() => customAlert.classList.remove("active"), 3000);
    }

    function hideAlert() {
      customAlert.classList.remove("active");
    }

    function resetUploadUI() {
      uploadProgressContainer.classList.remove("active");
      uploadProgressText.classList.remove("active");
      cancelUploadBtn.classList.remove("active");
      uploadProgress.style.width = "0%";
      uploadProgressText.textContent = "Uploading: 0%";
      uploadProgressContainer.setAttribute("aria-valuenow", 0);
      xhr = null;
    }

    function generateAvatarColor(userId) {
      const colors = ['#007A4D', '#C8102E', '#FFB81C', '#003087', '#F58A07'];
      const hash = md5(userId);
      const index = parseInt(hash.substr(0, 8), 16) % colors.length;
      return colors[index];
    }

    async function generateEncryptionKey(userId) {
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        new TextEncoder().encode(userId + "ChatSphere2025"),
        { name: "PBKDF2" },
        false,
        ["deriveBits", "deriveKey"]
      );
      encryptionKey = await crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: new TextEncoder().encode("ChatSphereSalt"),
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt", "decrypt"]
      );
    }

    async function encryptMessage(message) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encoded = new TextEncoder().encode(message);
      const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        encryptionKey,
        encoded
      );
      return {
        ciphertext: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
        iv: btoa(String.fromCharCode(...iv))
      };
    }

    async function decryptMessage(ciphertext, iv) {
      try {
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: new Uint8Array(atob(iv).split("").map(c => c.charCodeAt(0))) },
          encryptionKey,
          new Uint8Array(atob(ciphertext).split("").map(c => c.charCodeAt(0)))
        );
        return new TextDecoder().decode(decrypted);
      } catch (error) {
        console.error("Decryption error:", error);
        return "[Decryption failed]";
      }
    }

    async function loadUserProfile(user) {
      currentUserId = user.uid;
      currentUsername = user.displayName || user.email.split("@")[0];
      currentProfilePic = user.photoURL;
      await generateEncryptionKey(user.uid);
      const userRef = ref(db, `users/${user.uid}`);
      await set(userRef, {
        username: currentUsername,
        profilePic: currentProfilePic,
        online: true
      });
      onDisconnect(userRef).update({ online: false });
      profileBtn.innerHTML = currentProfilePic
        ? `<img src="${currentProfilePic}" alt="${DOMPurify.sanitize(currentUsername)}'s profile picture" class="w-8 h-8 rounded-full" />`
        : `<span class="w-8 h-8 rounded-full flex items-center justify-center text-white" style="background-color: ${generateAvatarColor(user.uid)};">${currentUsername.charAt(0).toUpperCase()}</span>`;
    }

    async function loadChats() {
      const friendsRef = ref(db, `friends/${currentUserId}`);
      onValue(friendsRef, async (snapshot) => {
        chatList.innerHTML = "";
        if (!snapshot.exists()) {
          chatList.innerHTML = '<div class="text-center text-gray-500 py-4">No friends added yet.</div>';
          return;
        }
        const friends = snapshot.val();
        let chatItems = [];
        for (const friendId in friends) {
          const userRef = ref(db, `users/${friendId}`);
          const userSnapshot = await get(userRef);
          if (!userSnapshot.exists()) continue;
          const userData = userSnapshot.val();
          const chatRef = ref(db, `chats/${currentUserId}/${friendId}`);
          const chatSnapshot = await get(chatRef);
          let lastMessage = "";
          let timestamp = 0;
          let unreadCount = 0;
          if (chatSnapshot.exists()) {
            const messages = chatSnapshot.val();
            const lastMessageId = Object.keys(messages).pop();
            const message = messages[lastMessageId];
            lastMessage = message.senderId === currentUserId ? `You: ${await decryptMessage(message.ciphertext, message.iv)}` : await decryptMessage(message.ciphertext, message.iv);
            timestamp = message.timestamp;
            unreadCount = Object.values(messages).filter(m => m.senderId !== currentUserId && !m.read).length;
          }
          chatItems.push({
            friendId,
            username: userData.username,
            profilePic: userData.profilePic,
            lastMessage,
            timestamp,
            unreadCount
          });
        }
        chatItems.sort((a, b) => b.timestamp - a.timestamp);
        chatItems.forEach(item => {
          const chatItem = document.createElement("div");
          chatItem.className = "chat-item";
          const profilePicHtml = item.profilePic
            ? `<img src="${item.profilePic}" alt="${DOMPurify.sanitize(item.username)}'s profile picture" class="w-10 h-10 rounded-full" />`
            : `<span class="w-10 h-10 rounded-full flex items-center justify-center text-white" style="background-color: ${generateAvatarColor(item.friendId)};">${item.username.charAt(0).toUpperCase()}</span>`;
          chatItem.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="relative">${profilePicHtml}</div>
              <div class="flex-1">
                <div class="flex justify-between">
                  <span class="font-medium text-[--text-dark]">${DOMPurify.sanitize(item.username)}</span>
                  <span class="text-sm text-[--text-light]">${item.timestamp ? new Date(item.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) : ""}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-[--text-light] truncate max-w-[200px]">${DOMPurify.sanitize(item.lastMessage)}</span>
                  ${item.unreadCount > 0 ? `<span class="bg-[--whatsapp-green] text-white text-xs rounded-full px-2 py-1">${item.unreadCount}</span>` : ""}
                </div>
              </div>
            </div>
          `;
          chatItem.addEventListener("click", () => {
            window.location.href = `chat.html?friendId=${item.friendId}`;
          });
          chatList.appendChild(chatItem);
        });
      });
    }

    async function loadStatuses() {
      const statusesRef = ref(db, `statuses`);
      onValue(statusesRef, async (snapshot) => {
        statusList.innerHTML = "";
        if (!snapshot.exists()) {
          statusList.innerHTML = '<div class="text-center text-gray-500 py-4">No statuses yet.</div>';
          return;
        }
        const statuses = snapshot.val();
        let statusCards = [];
        for (const userId in statuses) {
          const userRef = ref(db, `users/${userId}`);
          const userSnapshot = await get(userRef);
          if (!userSnapshot.exists()) continue;
          const userData = userSnapshot.val();
          const userStatuses = Object.entries(statuses[userId])
            .map(([statusId, status]) => ({ statusId, ...status }))
            .filter(status => Date.now() - status.createdAt <= STATUS_EXPIRY_MS);
          if (userStatuses.length === 0) continue;
          statusCards.push({
            userId,
            username: userData.username,
            profilePic: userData.profilePic,
            statuses: userStatuses,
            latestTimestamp: Math.max(...userStatuses.map(s => s.timestamp))
          });
        }
        statusCards.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        statusCards.forEach(card => {
          const statusCard = document.createElement("div");
          statusCard.className = "status-card";
          const profilePicHtml = card.profilePic
            ? `<img src="${card.profilePic}" alt="${DOMPurify.sanitize(card.username)}'s profile picture" class="w-10 h-10 rounded-full border-2 border-[--whatsapp-green]" />`
            : `<span class="w-10 h-10 rounded-full flex items-center justify-center text-white border-2 border-[--whatsapp-green]" style="background-color: ${generateAvatarColor(card.userId)};">${card.username.charAt(0).toUpperCase()}</span>`;
          statusCard.innerHTML = `
            <div class="flex items-center gap-3">
              ${profilePicHtml}
              <div class="flex-1">
                <div class="font-medium text-[--text-dark]">${DOMPurify.sanitize(card.username)}</div>
                <div class="text-sm text-[--text-light]">${new Date(card.latestTimestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>
              </div>
            </div>
          `;
          statusCard.addEventListener("click", () => {
            currentStatusUserId = card.userId;
            currentStatuses = card.statuses;
            currentStatusIndex = 0;
            showStatus();
          });
          statusList.appendChild(statusCard);
        });
      });
    }

    async function checkAndDeleteExpiredStatuses() {
      const statusesRef = ref(db, `statuses`);
      const snapshot = await get(statusesRef);
      if (snapshot.exists()) {
        const statuses = snapshot.val();
        for (const userId in statuses) {
          for (const statusId in statuses[userId]) {
            const status = statuses[userId][statusId];
            if (Date.now() - status.createdAt > STATUS_EXPIRY_MS) {
              await remove(ref(db, `statuses/${userId}/${statusId}`));
            }
          }
        }
      }
    }

    async function showStatus() {
      if (currentStatusIndex < 0 || currentStatusIndex >= currentStatuses.length) return;
      const status = currentStatuses[currentStatusIndex];
      const userRef = ref(db, `users/${currentStatusUserId}`);
      const userSnapshot = await get(userRef);
      if (!userSnapshot.exists()) return;
      const userData = userSnapshot.val();
      statusProfilePic.innerHTML = userData.profilePic
        ? `<img src="${userData.profilePic}" alt="${DOMPurify.sanitize(userData.username)}'s profile picture" class="w-8 h-8 rounded-full" />`
        : `<span class="w-8 h-8 rounded-full flex items-center justify-center text-white" style="background-color: ${generateAvatarColor(currentStatusUserId)};">${userData.username.charAt(0).toUpperCase()}</span>`;
      statusUsername.textContent = userData.username;
      statusTimestamp.textContent = new Date(status.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      deleteStatusBtn.style.display = currentStatusUserId === currentUserId ? "block" : "none";
      if (status.type === "image") {
        statusImage.src = status.url;
        statusImage.style.display = "block";
        statusVideo.style.display = "none";
        progressBar.style.transition = "none";
        progressBar.style.width = "100%";
      } else {
        statusVideo.src = status.url;
        statusImage.style.display = "none";
        statusVideo.style.display = "block";
        statusVideo.currentTime = 0;
        progressBar.style.transition = `width ${statusVideo.duration || 10}s linear`;
        progressBar.style.width = "0%";
        statusVideo.play().catch(() => showToast("Unable to play video"));
        statusVideo.onplay = () => {
          progressBar.style.width = "100%";
        };
        statusVideo.onended = () => {
          currentStatusIndex++;
          showStatus();
        };
      }
      swipeLeft.style.display = currentStatusIndex > 0 ? "block" : "none";
      swipeRight.style.display = currentStatusIndex < currentStatuses.length - 1 ? "block" : "none";
      statusModal.classList.add("active");
    }

    async function uploadToCloudinary(file, isVideo = false) {
      return new Promise((resolve, reject) => {
        const compressorOptions = isVideo
          ? { mimeType: "video/mp4", quality: 0.6, maxWidth: 1280, maxHeight: 720 }
          : { mimeType: "image/jpeg", quality: 0.8, maxWidth: 512, maxHeight: 512 };
        
        new Compressor(file, {
          ...compressorOptions,
          success(compressedFile) {
            const formData = new FormData();
            formData.append("file", compressedFile);
            formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
            formData.append("resource_type", isVideo ? "video" : "image");
            if (isVideo) {
              formData.append("eager", "w_80,h_80,c_fill,r_max");
            }
            xhr = new XMLHttpRequest();
            xhr.open("POST", CLOUDINARY_UPLOAD_URL, true);
            xhr.upload.onprogress = (event) => {
              if (event.lengthComputable) {
                const percent = Math.round((event.loaded / event.total) * 100);
                uploadProgress.style.width = `${percent}%`;
                uploadProgressText.textContent = `Uploading: ${percent}%`;
                uploadProgressContainer.setAttribute("aria-valuenow", percent);
              }
            };
            xhr.onreadystatechange = () => {
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  const data = JSON.parse(xhr.responseText);
                  if (!data.secure_url) {
                    reject(new Error("No secure URL returned from Cloudinary"));
                    return;
                  }
                  resolve(data);
                } else {
                  let errorMessage = "Upload failed";
                  try {
                    const errorData = JSON.parse(xhr.responseText);
                    errorMessage = errorData.error?.message || `Upload failed with status ${xhr.status}`;
                  } catch (e) {
                    errorMessage = `Upload failed with status ${xhr.status}`;
                  }
                  console.error("Cloudinary error:", errorMessage);
                  reject(new Error(errorMessage));
                }
              }
            };
            xhr.onerror = () => {
              console.error("Network error during upload");
              reject(new Error("Network error during upload"));
            };
            xhr.send(formData);
          },
          error(err) {
            console.error("Compression error:", err.message);
            reject(new Error(`Compression failed: ${err.message}`));
          },
        });
      });
    }

    async function uploadStatus(file) {
      if (!file) {
        showAlert("Please select a file.", true);
        return;
      }

      // Validate file size and type
      if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
        showAlert(`File size exceeds ${MAX_FILE_SIZE_MB}MB limit.`, true);
        statusFileInput.value = "";
        return;
      }
      const isVideo = file.type.startsWith("video/");
      if (!VALID_IMAGE_TYPES.includes(file.type) && !VALID_VIDEO_TYPES.includes(file.type)) {
        showAlert("Unsupported file type. Please use JPEG/PNG images or MP4/WebM videos.", true);
        statusFileInput.value = "";
        return;
      }

      uploadProgressContainer.classList.add("active");
      uploadProgressText.classList.add("active");
      cancelUploadBtn.classList.add("active");
      try {
        showSpinner();
        const data = await uploadToCloudinary(file, isVideo);
        const statusId = data.public_id;
        const thumbnail = isVideo ? data.eager?.[0]?.secure_url : null;
        
        await set(ref(db, `statuses/${currentUserId}/${statusId}`), {
          url: data.secure_url,
          type: data.resource_type,
          timestamp: Date.now(),
          createdAt: Date.now(),
          thumbnail,
        });
        
        await checkAndDeleteExpiredStatuses();
        showToast("Status uploaded successfully!");
        resetUploadUI();
        hideSpinner();
      } catch (error) {
        console.error("Status upload failed:", error.message);
        showAlert(`Failed to upload status: ${error.message}`, true);
        resetUploadUI();
        hideSpinner();
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.classList.add("fade-out");
        setTimeout(() => window.location.href = "signup.html", 500);
      } else {
        showSpinner();
        await loadUserProfile(user);
        await loadChats();
        await loadStatuses();
        hideSpinner();
      }
    });

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => {
          t.classList.remove("active");
          t.setAttribute("aria-selected", "false");
        });
        tab.classList.add("active");
        tab.setAttribute("aria-selected", "true");
        const tabContent = tab.dataset.tab;
        mainContainer.className = `main-container ${tabContent}`;
        if (tabContent === "status") {
          statusFileInput.click();
        }
      });
    });

    statusModalClose.addEventListener("click", () => {
      statusModal.classList.remove("active");
      statusVideo.pause();
    });

    swipeLeft.addEventListener("click", () => {
      currentStatusIndex--;
      showStatus();
    });

    swipeRight.addEventListener("click", () => {
      currentStatusIndex++;
      showStatus();
    });

    deleteStatusBtn.addEventListener("click", async () => {
      const status = currentStatuses[currentStatusIndex];
      try {
        showSpinner();
        await remove(ref(db, `statuses/${currentStatusUserId}/${status.statusId}`));
        statusModal.classList.remove("active");
        showToast("Status deleted successfully!");
        hideSpinner();
      } catch (error) {
        console.error("Status deletion failed:", error);
        showAlert("Failed to delete status. Please try again.", true);
        hideSpinner();
      }
    });

    statusModal.addEventListener("touchstart", (e) => {
      statusModal.dataset.startX = e.touches[0].clientX;
    });

    statusModal.addEventListener("touchend", (e) => {
      const startX = parseFloat(statusModal.dataset.startX);
      const endX = e.changedTouches[0].clientX;
      const diffX = endX - startX;
      if (Math.abs(diffX) > 50) {
        if (diffX > 0 && currentStatusIndex > 0) {
          currentStatusIndex--;
          showStatus();
        } else if (diffX < 0 && currentStatusIndex < currentStatuses.length - 1) {
          currentStatusIndex++;
          showStatus();
        } else if (diffX < -100 && currentStatusUserId === currentUserId) {
          deleteStatusBtn.click();
        }
      }
    });

    profileBtn.addEventListener("click", () => {
      window.location.href = "settings.html";
    });

    signOutBtn.addEventListener("click", async () => {
      try {
        showSpinner();
        await update(ref(db, `users/${currentUserId}`), { online: false });
        await signOut(auth);
        document.body.classList.add("fade-out");
        setTimeout(() => window.location.href = "signup.html", 500);
      } catch (error) {
        console.error("Sign out failed:", error);
        showAlert("Failed to sign out. Please try again.", true);
        hideSpinner();
      }
    });

    fab.addEventListener("click", () => {
      addFriendInput.classList.toggle("active");
      addFriendInput.focus();
    });

    addFriendBtn.addEventListener("click", async () => {
      const email = addFriendInput.value.trim();
      if (!email) {
        showAlert("Please enter an email address.", true);
        return;
      }
      try {
        showSpinner();
        const usersRef = ref(db, "users");
        const snapshot = await get(usersRef);
        let friendId = null;
        if (snapshot.exists()) {
          const users = snapshot.val();
          friendId = Object.keys(users).find(id => users[id].email === email);
        }
        if (!friendId) {
          showAlert("User not found.", true);
          hideSpinner();
          return;
        }
        if (friendId === currentUserId) {
          showAlert("You cannot add yourself as a friend.", true);
          hideSpinner();
          return;
        }
        await set(ref(db, `friends/${currentUserId}/${friendId}`), { addedAt: Date.now() });
        addFriendInput.value = "";
        addFriendInput.classList.remove("active");
        showToast("Friend added successfully!");
        hideSpinner();
      } catch (error) {
        console.error("Add friend failed:", error);
        showAlert("Failed to add friend. Please try again.", true);
        hideSpinner();
      }
    });

    statusFileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        uploadStatus(file);
        e.target.value = "";
      }
    });

    cancelUploadBtn.addEventListener("click", () => {
      if (xhr) {
        xhr.abort();
        showAlert("Upload cancelled", true);
        resetUploadUI();
      }
    });

    document.querySelector(".custom-alert .close-btn").addEventListener("click", hideAlert);
  </script>
</body>
</html>
