<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Alerts – Vynix</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff;--card:#ffffff;--text:#0f1419;--text2:#536471;--border:#cfd9de;
      --accent:#ff2a6d;--hover-accent:rgba(255,42,109,.08);--radius:16px;--trans:.18s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"]{
      --bg:#000000;--card:#000000;--text:#e7e9ea;--text2:#71767b;--border:#2f3336;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:var(--text);margin:0;padding-bottom:80px;
    }
    *{box-sizing:border-box}
    /* ---- notification row ---- */
    .notification-item{
      display:flex;gap:16px;padding:14px 16px;align-items:flex-start;
      border-bottom:1px solid var(--border);cursor:pointer;transition:background var(--trans);
      position:relative;overflow:hidden;
    }
    .notification-item:hover{background:var(--hover-accent)}
    .notification-item.unread{background:rgba(255,42,109,.06);font-weight:600}
    .notification-item.selected{background:rgba(255,42,109,.12)}
    .notif-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;flex-shrink:0}
    .notif-icon{
      width:40px;height:40px;border-radius:50%;background:var(--accent);color:#fff;
      display:grid;place-items:center;font-size:22px;flex-shrink:0;
    }
    .notif-body{flex:1;min-width:0}
    .notif-title{font-weight:700;font-size:15px;line-height:1.3}
    .notif-message{color:var(--text2);font-size:14px;margin-top:3px;white-space:pre-wrap;
                   overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .notif-time{color:var(--text2);font-size:12px;margin-top:6px}
    /* ---- skeleton ---- */
    .skeleton{height:72px;background:linear-gradient(90deg,var(--border)25%,rgba(255,255,255,.3)50%,var(--border)75%);
              background-size:200% 100%;animation:shimmer 1.8s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    /* ---- empty ---- */
    .empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
    .empty-state .material-icons{font-size:72px;margin-bottom:16px;opacity:.3}
    /* ---- multi-select top bar ---- */
    #selectBar{position:fixed;top:0;left:0;right:0;height:56px;background:var(--card);
               border-bottom:1px solid var(--border);z-index:50;display:none;align-items:center;justify-content:space-between;padding:0 16px;}
    #selectBar.active{display:flex}
    /* ---- swipe delete button ---- */
    .swipeDelete{position:absolute;right:-80px;top:0;bottom:0;width:80px;background:#e53e3e;color:#fff;
                 display:flex;align-items:center;justify-content:center;transition:right .3s;}
    .notification-item.swiped .swipeDelete{right:0}
  </style>
</head>
<body class="min-h-screen">

  <!-- multi-select top bar -->
  <div id="selectBar" class="active:hidden">
    <span id="selectedCount">0 selected</span>
    <div class="flex gap-3">
      <button id="deleteSelectedBtn" class="text-sm px-3 py-1 rounded border border-[var(--border)]">Delete</button>
      <button id="deleteAllBtn" class="text-sm px-3 py-1 rounded bg-[var(--accent)] text-white">Delete all</button>
    </div>
  </div>

  <!-- notification list -->
  <div id="notifications-list" class="max-w-600 mx-auto pt-14"></div>

  <!-- empty state -->
  <div id="empty-state" class="empty-state hidden">
    <span class="material-icons">notifications_off</span>
    <h2 class="text-xl font-bold">All caught up!</h2>
    <p class="mt-2">You'll see likes, comments, and reposts here.</p>
  </div>

  <!-- bottom navbar (unchanged) -->
  <nav id="navbar" class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 z-40">
    <div class="h-full flex items-center justify-around text-gray-500">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">home</span><span class="text-xs mt-0.5">Home</span>
      </a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span>
      </a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">search</span><span class="text-xs mt-0.5">Search</span>
      </a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">auto_awesome</span><span class="text-xs mt-0.5">AI</span>
      </a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full text-[#ff2a6d]">
        <span class="material-icons text-24">notifications</span><span class="text-xs mt-0.5">Alerts</span>
      </a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">person</span><span class="text-xs mt-0.5">Profile</span>
      </a>
    </div>
  </nav>

  <!-- Firebase -->
  <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onValue, get, set, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

let uid = null;
const $   = s => document.querySelector(s);
const list = $('#notifications-list');
const empty= $('#empty-state');

/* ---------- config ---------- */
const PAGE_SIZE = 10;               // notifications per chunk
const LONG_PRESS = 500;             // ms

/* ---------- state ---------- */
let allNotifications = [];          // master array (sorted)
let renderedCount  = 0;             // how many already in DOM
let selectedIds = new Set();        // multi-select
let isSelecting = false;

/* ---------- theme ---------- */
if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches)
  document.body.setAttribute('data-theme', 'dark');

/* ---------- auth ---------- */
onAuthStateChanged(auth, user => {
  if (!user) signInAnonymously(auth);
  else { uid = user.uid; init(); }
});

/* ---------- init ---------- */
function init() {
  /* scroll listener */
  window.addEventListener('scroll', handleScroll);
  /* select bar buttons */
  $('#deleteSelectedBtn').onclick = deleteSelected;
  $('#deleteAllBtn').onclick = deleteAll;
  /* load first chunk */
  loadNotifications();
}

/* ---------- realtime: grab once, then monitor ---------- */
function loadNotifications() {
  const notifRef = ref(db, `notifications/${uid}`);
  onValue(notifRef, snap => {
    const data = snap.val() || {};
    allNotifications = Object.entries(data)
      .map(([k,v]) => ({id:k,...v}))
      .sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
    if (!allNotifications.length) { showEmpty(); return; }
    renderedCount = 0;
    list.innerHTML = '';
    renderChunk();
  }, {onlyOnce:true});
}

/* ---------- render one chunk ---------- */
async function renderChunk() {
  empty.classList.add('hidden');
  const fragment = document.createDocumentFragment();
  const end = Math.min(renderedCount + PAGE_SIZE, allNotifications.length);
  for (let i = renderedCount; i < end; i++) {
    const n = allNotifications[i];
    const actor = await getUserMeta(n.from);
    fragment.appendChild(createRow(n, actor));
  }
  list.appendChild(fragment);
  renderedCount = end;
}

/* ---------- create row ---------- */
function createRow(n, actor) {
  const div = document.createElement('div');
  div.className = 'notification-item';
  div.dataset.id = n.id;
  if (selectedIds.has(n.id)) div.classList.add('selected');

  let icon = 'notifications', title='New activity';
  switch (n.type) {
    case 'like':    icon='favorite';      title=`${actor.name} liked your post`; break;
    case 'comment': icon='chat_bubble';   title=`${actor.name} commented on your post`; break;
    case 'repost':  icon='repeat';        title=`${actor.name} reposted your post`; break;
  }
  const preview = n.text
    ? `"${n.text.substring(0,80)}${n.text.length>80?'…':''}"`
    : n.commentText
    ? `"${n.commentText.substring(0,80)}${n.commentText.length>80?'…':''}"`
    : '';

  div.innerHTML = `
    <div class="notif-icon"><span class="material-icons">${icon}</span></div>
    <img src="${actor.avatar}" class="notif-avatar" loading="lazy" alt="">
    <div class="notif-body">
      <div class="notif-title">${title}</div>
      ${preview ? `<div class="notif-message">${preview}</div>`:''}
      <div class="notif-time">${timeAgo(n.timestamp)}</div>
    </div>
    <div class="swipeDelete"><span class="material-icons">delete</span></div>`;

  /* tap to navigate */
  div.addEventListener('click', e => {
    if (isSelecting) { toggleSelect(n.id); return; }
    if (n.postId) location.href = `index.html#post-${n.postId}`;
  });

  /* long press -> select mode */
  let pressTimer;
  div.addEventListener('touchstart', () => {
    pressTimer = setTimeout(() => enterSelectMode(n.id), LONG_PRESS);
  });
  div.addEventListener('touchend', () => clearTimeout(pressTimer));
  div.addEventListener('touchmove', () => clearTimeout(pressTimer));

  /* swipe delete */
  let startX = 0;
  div.addEventListener('touchstart', e => startX = e.touches[0].clientX);
  div.addEventListener('touchend', e => {
    const endX = e.changedTouches[0].clientX;
    if (startX - endX > 80) div.classList.add('swiped');
    else div.classList.remove('swiped');
  });
  div.querySelector('.swipeDelete').onclick = e => {
    e.stopPropagation();
    removeNotification(n.id);
  };

  return div;
}

/* ---------- infinite scroll ---------- */
function handleScroll() {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
    if (renderedCount < allNotifications.length) renderChunk();
  }
}

/* ---------- select mode ---------- */
function enterSelectMode(id) {
  isSelecting = true;
  $('#selectBar').classList.add('active');
  toggleSelect(id);
}
function toggleSelect(id) {
  const row = list.querySelector(`[data-id="${id}"]`);
  if (selectedIds.has(id)) {
    selectedIds.delete(id);
    row.classList.remove('selected');
  } else {
    selectedIds.add(id);
    row.classList.add('selected');
  }
  $('#selectedCount').textContent = `${selectedIds.size} selected`;
}
function exitSelectMode() {
  isSelecting = false;
  selectedIds.clear();
  $('#selectBar').classList.remove('active');
  list.querySelectorAll('.selected').forEach(r => r.classList.remove('selected'));
}

/* ---------- delete ---------- */
async function deleteSelected() {
  if (!selectedIds.size) return;
  const promises = [...selectedIds].map(id => remove(ref(db, `notifications/${uid}/${id}`)));
  await Promise.all(promises);
  exitSelectMode();
}
async function deleteAll() {
  if (!confirm('Delete all notifications?')) return;
  await remove(ref(db, `notifications/${uid}`));
  exitSelectMode();
}
async function removeNotification(id) {
  await remove(ref(db, `notifications/${uid}/${id}`));
}

/* ---------- helpers ---------- */
async function getUserMeta(uid) {
  if (!uid) return { name:'Someone', avatar:'https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=?' };
  const snap = await get(ref(db, `users/${uid}/profile`));
  const p = snap.val() || {};
  return {
    name: p.displayName || 'User',
    avatar: p.avatar || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${encodeURIComponent(p.displayName||'User')}`
  };
}
function timeAgo(ts) {
  if (!ts) return 'just now';
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return `${s}s`;
  if (s < 3600) return `${Math.floor(s/60)}m`;
  if (s < 86400) return `${Math.floor(s/3600)}h`;
  return `${Math.floor(s/86400)}d`;
}
function showEmpty() {
  list.innerHTML = ''; empty.classList.remove('hidden');
}
  </script>
</body>
</html>
