<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Notifications â€¢ Vynix</title>

  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --accent: #ff2a6d; --bg: #ffffff; --text: #0f1419; --text2: #536471; --border: #eff3f4; }
    [data-theme="dark"] { --bg: #000000; --text: #e7e9ea; --text2: #71767b; --border: #2f3336; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 80px; -webkit-user-select: none; user-select: none; }
    .notif-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border); position: relative; }
    .notif-item.unread { background: rgba(255,42,109,.06); }
    .notif-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .notif-icon { position: absolute; left: 40px; top: 36px; background: var(--accent); color: #fff; border-radius: 50%; width: 20px; height: 20px; display: grid; place-items: center; font-size: 14px; }
    .notif-text { font-size: 15px; line-height: 1.35; }
    .notif-time { font-size: 13px; color: var(--text2); margin-top: 4px; }
    .empty { text-align: center; padding: 60px 20px; color: var(--text2); font-size: 16px; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- same header style as feed -->
  <header class="sticky top-0 bg-[var(--bg)] px-4 py-3 border-b border-[var(--border)] z-10">
    <h1 class="text-xl font-bold">Notifications</h1>
  </header>

  <main id="list" class="pb-20">
    <div class="empty">Loadingâ€¦</div>
  </main>

  <!-- bottom nav â€“ notifications tab highlighted -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 z-40">
    <div class="h-full flex items-center justify-around text-gray-500">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">home</span>
        <span class="text-xs mt-0.5">Home</span>
      </a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">chat_bubble_outline</span>
        <span class="text-xs mt-0.5">Chat</span>
      </a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">search</span>
        <span class="text-xs mt-0.5">Search</span>
      </a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">auto_awesome</span>
        <span class="text-xs mt-0.5">AI</span>
      </a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full text-[#ff2a6d]">
        <span class="material-icons text-24">notifications</span>
        <span class="text-xs mt-0.5 font-bold">Alerts</span>
      </a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full">
        <span class="material-icons-outlined text-24">person</span>
        <span class="text-xs mt-0.5">Profile</span>
      </a>
    </div>
  </nav>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
import { getDatabase, ref, onChildAdded, push, serverTimestamp, get } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let uid;
const listEl = document.getElementById('list');
const icons = { like: 'favorite', comment: 'chat_bubble', repost: 'repeat', follow: 'person_add', verified: 'verified' };

onAuthStateChanged(auth, user => {
  if (!user) return;
  uid = user.uid;
  initNotifs();
});

/* ---------- real-time listeners ---------- */
function initNotifs() {
  // likes
  onChildAdded(ref(db, `likes`), snap => {
    const postId = snap.key;
    const likerId = Object.keys(snap.val())[0];
    if (likerId === uid) return;
    getPostOwner(postId).then(owner => {
      if (owner !== uid) return;
      addNotif(likerId, 'like', postId);
    });
  });

  // comments
  onChildAdded(ref(db, `comments`), snap => {
    const postId = snap.key;
    snap.forEach(cc => {
      const c = cc.val();
      if (c.authorId === uid) return;
      getPostOwner(postId).then(owner => {
        if (owner !== uid) return;
        addNotif(c.authorId, 'comment', postId, c.text);
      });
    });
  });

  // reposts
  onChildAdded(ref(db, `reposts`), snap => {
    const postId = snap.key;
    snap.forEach(cc => {
      const reposterId = cc.key;
      if (reposterId === uid) return;
      getPostOwner(postId).then(owner => {
        if (owner !== uid) return;
        addNotif(reposterId, 'repost', postId);
      });
    });
  });

  // follows
  onChildAdded(ref(db, `followers/${uid}`), snap => {
    const followerId = snap.key;
    if (followerId === uid) return;
    addNotif(followerId, 'follow');
  });

  // verified
  onChildAdded(ref(db, `verifications/${uid}`), () => {
    addNotif('system', 'verified');
  });
}

function getPostOwner(pid) {
  return fetch(`${firebaseConfig.databaseURL}/posts/${pid}/authorId.json`).then(r => r.json());
}

function addNotif(fromUid, type, postId = '', snippet = '') {
  const notifRef = push(ref(db, `notifications/${uid}`));
  set(notifRef, {
    fromUid,
    type,
    postId,
    snippet: snippet.slice(0, 60),
    read: false,
    timestamp: serverTimestamp()
  });
  toastNew(type);
}

/* ---------- first paint + live updates ---------- */
function renderNotifs() {
  get(ref(db, `notifications/${uid}`)).then(snap => {
    const arr = [];
    snap.forEach(cc => arr.unshift({ key: cc.key, ...cc.val() }));
    if (!arr.length) { listEl.innerHTML = '<div class="empty">No notifications yet</div>'; return; }

    let html = '';
    arr.forEach(n => {
      const ago = timeAgo(n.timestamp || 0);
      html += `
        <div class="notif-item ${n.read ? '' : 'unread'}" data-key="${n.key}">
          <img src="${avatarOf(n.fromUid)}" class="notif-avatar">
          <span class="notif-icon material-icons">${icons[n.type] || 'notifications'}</span>
          <div class="flex-1">
            <div class="notif-text">${textOf(n)}</div>
            <div class="notif-time">${ago}</div>
          </div>
        </div>`;
    });
    listEl.innerHTML = html;

    /* mark read after shown */
    arr.filter(n => !n.read).forEach(n => {
      ref(db, `notifications/${uid}/${n.key}/read`).set(true);
    });
  });
}

onChildAdded(ref(db, `notifications/${uid}`), () => renderNotifs());

/* ---------- text / avatar helpers ---------- */
function textOf(n) {
  const name = n.fromUid === 'system' ? 'Vynix' : n.fromName || 'Someone';
  switch (n.type) {
    case 'like': return `<b>${name}</b> liked your post`;
    case 'comment': return `<b>${name}</b> commented: ${n.snippet}${n.snippet.length > 50 ? 'â€¦' : ''}`;
    case 'repost': return `<b>${name}</b> reposted your post`;
    case 'follow': return `<b>${name}</b> started following you`;
    case 'verified': return `ðŸŽ‰ Your profile was verified!`;
    default: return 'New activity';
  }
}

function avatarOf(uid) {
  return uid === 'system'
    ? 'https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png'
    : `https://ui-avatars.com/api/?name=${uid}&background=ff2a6d&color=fff`;
}

/* ---------- toast on new ---------- */
let lastTime = 0;
function toastNew(type) {
  const now = Date.now();
  if (now - lastTime < 1000) return;
  lastTime = now;
  const t = document.createElement('div');
  t.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-[#ff2a6d] text-white px-4 py-2 rounded-full text-sm shadow-lg z-50';
  t.textContent = { like: 'â™¥ New like', comment: 'ðŸ’¬ New comment', repost: 'ðŸ” New repost', follow: 'ðŸ‘¤ New follower', verified: 'âœ… Verified!' }[type] || 'New alert';
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

/* ---------- utils ---------- */
function timeAgo(ts) {
  if (!ts) return 'now';
  const s = Math.floor((Date.now() - ts) / 1000);
  return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
}

/* ---------- theme ---------- */
if (matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
</script>

</body>
</html>
