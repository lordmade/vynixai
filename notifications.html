<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Notifications • Vynix</title>

  <!-- PWA / theme -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0f1419; --text2:#536471;
      --border:#eff3f4; --accent:#ff2a6d; --hover-accent:rgba(255,42,109,.1);
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000; --text:#e7e9ea; --text2:#71767b;
      --border:#2f3336;
    }
    *{-webkit-user-select:none !important; user-select:none !important; -webkit-touch-callout:none !important; -webkit-tap-highlight-color:transparent !important;}
    input,textarea,button{-webkit-user-select:auto !important; user-select:text !important;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .toast{position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--accent); color:#fff; padding:12px 24px; border-radius:999px; box-shadow:0 10px 15px -3px rgba(0,0,0,.3); font-weight:600; opacity:0; transition:all .4s cubic-bezier(.175,.885,.32,1.275); z-index:50;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}
    main{padding-bottom:80px;}
    .ntime{font-size:12px; color:var(--text2);}
  </style>
</head>

<body>
  <!-- top bar -->
  <header class="sticky top-0 z-30 bg-white/80 dark:bg-black/80 backdrop-blur border-b border-[var(--border)] flex items-center px-4 h-14">
    <button onclick="history.back()" class="material-icons-outlined text-xl text-[var(--text2)]">arrow_back</button>
    <h1 class="ml-4 font-bold text-lg">Notifications</h1>
  </header>

  <!-- notifications list -->
  <main id="notif-list" class="px-4 py-3 space-y-3"></main>

  <!-- bottom nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-[var(--border)] z-40">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <!-- toast -->
  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, get, push, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey:"AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain:"fire-b-a8878.firebaseapp.com",
      databaseURL:"https://fire-b-a8878.firebaseio.com",
      projectId:"fire-b-a8878",
      storageBucket:"fire-b-a8878.firebasestorage.app",
      messagingSenderId:"658673187627",
      appId:"1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches) document.body.setAttribute('data-theme','dark');

    const $ = s => document.querySelector(s);
    const toast = msg => {
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };

    let uid, uname, uavatar;

    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }
      uid = user.uid;
      uname = user.displayName || user.email.split('@')[0];
      uavatar = user.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
      startListeners();
    });

    /* ---------- real-time listeners ---------- */
    function startListeners(){
      /* likes on my posts */
      onValue(ref(db, 'posts'), async snap => {
        snap.forEach(async postSnap => {
          const post = postSnap.val();
          if (post.authorId !== uid) return;
          onValue(ref(db, `likes/${postSnap.key}`), likeSnap => {
            likeSnap.forEach(l => {
              if (l.key === uid) return; // skip self
              addNotif('like', postSnap.key, l.key, `${post.text.slice(0, 30)}…`);
            });
          });
        });
      });

      /* comments on my posts */
      onValue(ref(db, 'posts'), async snap => {
        snap.forEach(async postSnap => {
          const post = postSnap.val();
          if (post.authorId !== uid) return;
          onValue(ref(db, `comments/${postSnap.key}`), comSnap => {
            comSnap.forEach(c => {
              const v = c.val();
              if (v.authorId === uid) return; // skip self
              addNotif('comment', postSnap.key, v.authorId, `${post.text.slice(0, 30)}…`);
            });
          });
        });
      });

      /* reposts of my posts */
      onValue(ref(db, 'posts'), async snap => {
        snap.forEach(async postSnap => {
          const post = postSnap.val();
          if (post.authorId !== uid) return;
          onValue(ref(db, `reposts/${postSnap.key}`), repSnap => {
            repSnap.forEach(r => {
              if (r.key === uid) return; // skip self
              addNotif('repost', postSnap.key, r.key, `${post.text.slice(0, 30)}…`);
            });
          });
        });
      });
    }

    /* ---------- add notification card ---------- */
    const seen = new Set(); // simple dedup per session
    async function addNotif(type, postId, fromUid, preview){
      const key = `${type}_${postId}_${fromUid}`;
      if (seen.has(key)) return;
      seen.add(key);

      const userSnap = await get(ref(db, `users/${fromUid}/profile`));
      const from = userSnap.val() || {};
      const icon = type === 'like' ? 'favorite' : type === 'comment' ? 'chat_bubble' : 'repeat';
      const text = type === 'like' ? 'liked your post' : type === 'comment' ? 'replied to your post' : 're-posted your post';

      const card = document.createElement('div');
      card.className = 'bg-[var(--card)] border border-[var(--border)] rounded-2xl p-3 cursor-pointer hover:opacity-90';
      card.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${from.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${from.displayName||'U'}`}" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1">
            <div class="text-sm"><b>${from.displayName||'Someone'}</b> ${text}</div>
            <div class="text-xs text-[var(--text2)] mt-1">${preview}</div>
          </div>
          <span class="material-icons text-[var(--accent)]">${icon}</span>
        </div>`;
      card.onclick = () => openPost(postId);
      $('#notif-list').prepend(card);
    }

    function openPost(pid){
      // open post in comment sheet (same as feed)
      const sheet = document.createElement('div');
      sheet.id = 'notif-sheet';
      sheet.innerHTML = `
        <div class="fixed inset-0 bg-black/50 z-50" onclick="this.remove()">
          <div class="absolute bottom-0 left-0 right-0 bg-[var(--card)] border-t border-[var(--border)] rounded-t-2xl p-4 max-h-[75vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-3">
              <span class="font-bold">Post</span>
              <span class="material-icons-outlined cursor-pointer" onclick="this.closest('#notif-sheet').remove()">close</span>
            </div>
            <div id="notif-post"></div>
          </div>
        </div>`;
      document.body.appendChild(sheet);
      // render post inside
      get(ref(db, `posts/${pid}`)).then(s=>{
        if(s.exists()) sheet.querySelector('#notif-post').appendChild(renderPostCard({key:pid,...s.val()}));
      });
    }

    /* ---------- render post card (same as feed) ---------- */
    function renderPostCard(p){
      const div = document.createElement('div'); div.className = 'post-card';
      div.innerHTML = `
        <div class="flex gap-3">
          <img src="${p.authorAvatar}" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1">
            <div class="flex items-center gap-2 text-sm">
              <span class="font-bold">${p.authorName}</span>
              <span class="text-[var(--text2)]">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
            </div>
            <div class="mt-1 text-[15px] whitespace-pre-wrap">${p.text}</div>
            ${p.image?`<img src="${p.image}" class="mt-2 rounded-2xl border border-[var(--border)]">`:''}
            <div class="flex gap-4 mt-2 text-sm text-[var(--text2)]">
              <span><span class="material-icons-outlined text-base">chat_bubble_outline</span> ${p.replies||0}</span>
              <span><span class="material-icons-outlined text-base">repeat</span> ${p.reposts||0}</span>
              <span><span class="material-icons-outlined text-base">favorite_border</span> ${p.likes||0}</span>
            </div>
          </div>
        </div>`;
      return div;
    }

    const timeAgo = ts => {
      if (!ts) return '';
      const s = Math.floor((Date.now() - (ts||0)) / 1000);
      return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s / 60)}m` : s < 86400 ? `${Math.floor(s / 3600)}h` : `${Math.floor(s / 86400)}d`;
    };
  </script>
</body>
</html>
