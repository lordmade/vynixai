<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Notifications • Vynix</title>

  <!-- PWA / theme -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVnluaXgiLCJzaG9ydF9uYW1lIjoiVnluaXgiLCJkZXNjcmlwdGlvbiI6IkNvbm5lY3Qgd2l0aCBmcmllbmRzIC0gZmFzdCwgYmVhdXRpZnVsLCBwcml2YXRlIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjJhNmQiLCJ0aGVtZV9jb2xvciI6IiNmZjJhNmQiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9LHsic3JjIjoiaHR0cHM6Ly9pLnBvc3RpbWcuY2MvSzhZV0tHMHovR2VtaW5pLUdlbmVyYXRlZC1JbWFnZS1qNHpuMGpqNHpuMGpqNHpuLTEtcmVtb3ZlYmctcHJldmlldy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
  <meta name="theme-color" content="#ff2a6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/K8YWKG0z/Gemini-Generated-Image-j4zn0jj4zn0jj4zn-1-removebg-preview.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0f1419; --text2:#536471;
      --border:#eff3f4; --accent:#ff2a6d; --hover-accent:rgba(255,42,109,.1);
    }
    [data-theme="dark"]{
      --bg:#000000; --card:#000000; --text:#e7e9ea; --text2:#71767b;
      --border:#2f3336;
    }
    *{-webkit-user-select:none !important; user-select:none !important; -webkit-touch-callout:none !important; -webkit-tap-highlight-color:transparent !important;}
    input,textarea,button{-webkit-user-select:auto !important; user-select:text !important;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}

    /* ---- toast ---- */
    .toast{position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--accent); color:#fff; padding:12px 24px; border-radius:999px; box-shadow:0 10px 15px -3px rgba(0,0,0,.3); font-weight:600; opacity:0; transition:all .4s cubic-bezier(.175,.885,.32,1.275); z-index:50;}
    .toast.show{transform:translateX(-50%) translateY(0); opacity:1;}

    /* ---- shimmer ---- */
    #global-shimmer{position:fixed; inset:0; background:var(--bg); z-index:100; display:flex; align-items:center; justify-content:center; opacity:1; pointer-events:auto; transition:opacity .3s;}
    #global-shimmer.hidden{opacity:0; pointer-events:none;}
    .shimmer-grid{display:grid; grid-template-columns:repeat(1,1fr); gap:12px; width:90%; max-width:400px;}
    .shimmer-card{height:72px; border-radius:16px; background:linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.3) 50%, var(--border) 75%); background-size:200% 100%; animation:shimmer 1.2s infinite;}
    [data-theme="dark"] .shimmer-card{background:linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.05) 50%, var(--border) 75%);}
    @keyframes shimmer{0%{background-position:-200% 0;}100%{background-position:200% 0;}}

    main{padding-bottom:80px;}
    .ntime{font-size:12px; color:var(--text2);}
  </style>
</head>

<body>
  <!-- global shimmer while loading -->
  <div id="global-shimmer">
    <div class="shimmer-grid">
      <div class="shimmer-card"></div><div class="shimmer-card"></div><div class="shimmer-card"></div>
      <div class="shimmer-card"></div><div class="shimmer-card"></div><div class="shimmer-card"></div>
    </div>
  </div>

  <!-- notifications list -->
  <main id="notif-list" class="px-4 py-3 space-y-3"></main>

  <!-- bottom nav -->
  <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-black border-t border-[var(--border)] z-40">
    <div class="h-full flex items-center justify-around text-[var(--text2)]">
      <a href="index.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">home</span><span class="text-xs mt-0.5">Home</span></a>
      <a href="chat.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">chat_bubble_outline</span><span class="text-xs mt-0.5">Chat</span></a>
      <a href="search.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">search</span><span class="text-xs mt-0.5">Search</span></a>
      <a href="ai.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">auto_awesome</span><span class="text-xs mt-0.5">AI</span></a>
      <a href="notifications.html" class="flex flex-col items-center justify-center h-full w-full text-[var(--accent)]"><span class="material-icons text-2xl">notifications</span><span class="text-xs mt-0.5">Alerts</span></a>
      <a href="profile.html" class="flex flex-col items-center justify-center h-full w-full"><span class="material-icons-outlined text-2xl">person</span><span class="text-xs mt-0.5">Profile</span></a>
    </div>
  </nav>

  <!-- toast -->
  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getDatabase, ref, onValue, get, push, serverTimestamp, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey:"AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain:"fire-b-a8878.firebaseapp.com",
      databaseURL:"https://fire-b-a8878.firebaseio.com",
      projectId:"fire-b-a8878",
      storageBucket:"fire-b-a8878.firebasestorage.app",
      messagingSenderId:"658673187627",
      appId:"1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const db    = getDatabase(app);
    const $     = s => document.querySelector(s);
    const toast = msg => {
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };

    let uid, uname, uavatar;

    onAuthStateChanged(auth, user => {
      if (!user) { location.href = 'login.html'; return; }
      uid = user.uid;
      uname = user.displayName || user.email.split('@')[0];
      uavatar = user.photoURL || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${uname}`;
      startListeners();
      renderNotifications();
      $('#global-shimmer').classList.add('hidden');
    });

    /* ---------- 1.  create notifications (only writes) ---------- */
    function startListeners(){
      // likes on my posts
      onValue(ref(db, 'posts'), snap => {
        snap.forEach(postSnap => {
          const post = postSnap.val();
          if(post.authorId !== uid) return;
          onValue(ref(db, `likes/${postSnap.key}`), likeSnap => {
            likeSnap.forEach(l => {
              if(l.key === uid) return;
              storeNotif('like', postSnap.key, l.key, post.text?.slice(0,40)+'…');
            });
          });
        });
      });

      // comments on my posts
      onValue(ref(db, 'posts'), snap => {
        snap.forEach(postSnap => {
          const post = postSnap.val();
          if(post.authorId !== uid) return;
          onValue(ref(db, `comments/${postSnap.key}`), comSnap => {
            comSnap.forEach(c => {
              const v = c.val();
              if(v.authorId === uid) return;
              storeNotif('comment', postSnap.key, v.authorId, post.text?.slice(0,40)+'…');
            });
          });
        });
      });

      // new followers
      onValue(ref(db, `social/${uid}/followers`), followSnap => {
        followSnap.forEach(f => {
          if(f.key === uid) return;
          storeNotif('follow', null, f.key, 'started following you');
        });
      });
    }

    const seen = new Set();        // ram dedup this session
    async function storeNotif(type, postId, fromUid, preview){
      const id = `${type}_${postId||'follow'}_${fromUid}`;
      if(seen.has(id)) return; seen.add(id);
      const stored = await get(ref(db, `notifications/${uid}/${id}`));
      if(stored.exists()) return;               // already persisted

      const userSnap = await get(ref(db, `users/${fromUid}/profile`));
      const from = userSnap.val() || {};
      const icon = type === 'like' ? 'favorite' : type === 'comment' ? 'chat_bubble' : 'person_add';
      const text = type === 'like' ? 'liked your post' : type === 'comment' ? 'replied to your post' : 'started following you';

      // store in FB
      await push(ref(db, `notifications/${uid}`), {
        type, postId, fromUid, fromName: from.displayName || 'Someone',
        fromAvatar: from.avatar || `https://ui-avatars.com/api/?background=ff2a6d&color=fff&name=${from.displayName || 'U'}`,
        preview, timestamp: serverTimestamp()
      });
    }

    /* ---------- 2.  real-time render ---------- */
    function renderNotifications(){
      onValue(ref(db, `notifications/${uid}`), snap => {
        const list = $('#notif-list');
        list.innerHTML = '';
        const rows = [];
        snap.forEach(c => rows.unshift({key:c.key, ...c.val()}));
        rows.forEach(n => list.appendChild(makeNotifCard(n)));
        if(!rows.length) list.innerHTML = '<div class="text-center text-sm text-[var(--text2)] py-10">No notifications yet</div>';
      });
    }

    function makeNotifCard(n){
      const icon = n.type==='like'?'favorite':n.type==='comment'?'chat_bubble':'person_add';
      const card = document.createElement('div');
      card.className = 'bg-[var(--card)] border border-[var(--border)] rounded-2xl p-3 cursor-pointer hover:opacity-90 relative';
      card.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${n.fromAvatar}" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1">
            <div class="text-sm"><b>${n.fromName}</b> ${n.type==='like'?'liked your post':n.type==='comment'?'replied to your post':'started following you'}</div>
            <div class="text-xs text-[var(--text2)] mt-1">${n.preview}</div>
          </div>
          <span class="material-icons text-[var(--accent)]">${icon}</span>
        </div>
        <button class="absolute top-2 right-2 text-[var(--text2)] hover:text-red-500" data-key="${n.key}">
          <span class="material-icons-outlined text-sm">delete</span>
        </button>`;
      
      card.querySelector('button').onclick = (e) => {
        e.stopPropagation();
        remove(ref(db, `notifications/${uid}/${n.key}`));
        toast('Notification deleted');
      };
      
      card.onclick = () => n.type==='follow'?openProfile(n.fromUid):openPost(n.postId);
      return card;
    }

    /* ---------- 3.  open post sheet ---------- */
    function openPost(pid){
      get(ref(db, `posts/${pid}`)).then(s=>{
        if(!s.exists()) return;
        const p = {key:pid, ...s.val()};
        const sheet = document.createElement('div');
        sheet.id = 'notif-sheet';
        sheet.innerHTML = `
          <div class="fixed inset-0 bg-black/50 z-50" onclick="this.remove()">
            <div class="absolute bottom-0 left-0 right-0 bg-[var(--card)] border-t border-[var(--border)] rounded-t-2xl p-4 max-h-[75vh] overflow-y-auto" onclick="event.stopPropagation()">
              <div class="flex items-center justify-between mb-3">
                <span class="font-bold">Post</span>
                <span class="material-icons-outlined cursor-pointer" onclick="this.closest('#notif-sheet').remove()">close</span>
              </div>
              <div id="notif-post"></div>
            </div>
          </div>`;
        document.body.appendChild(sheet);
        sheet.querySelector('#notif-post').appendChild(renderPostCard(p));
      });
    }
    function openProfile(uid){
      location.href=`profile.html?uid=${uid}`;
    }

    function renderPostCard(p){
      const div = document.createElement('div'); div.className = 'post-card';
      div.innerHTML = `
        <div class="flex gap-3">
          <img src="${p.authorAvatar}" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1">
            <div class="flex items-center gap-2 text-sm">
              <span class="font-bold">${p.authorName}</span>
              <span class="text-[var(--text2)]">@${p.authorName.replace(/\s/g,'').toLowerCase()} · ${timeAgo(p.timestamp)}</span>
            </div>
            <div class="mt-1 text-[15px] whitespace-pre-wrap">${p.text}</div>
            ${p.image?`<img src="${p.image}" class="mt-2 rounded-2xl border border-[var(--border)]">`:''}
          </div>
        </div>`;
      return div;
    }

    const timeAgo = ts => {
      if(!ts) return '';
      const s = Math.floor((Date.now() - (ts||0)) / 1000);
      return s < 60 ? `${s}s` : s < 3600 ? `${Math.floor(s/60)}m` : s < 86400 ? `${Math.floor(s/3600)}h` : `${Math.floor(s/86400)}d`;
    };
  </script>

  <!-- bottom nav active state -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cur = location.pathname.split('/').pop() || 'notifications.html';
      document.querySelectorAll('nav a').forEach(a => {
        if (a.getAttribute('href') === cur) {
          a.classList.add('text-[#ff2a6d]');
          const icon = a.querySelector('span:first-child');
          if (icon) icon.classList.replace('material-icons-outlined', 'material-icons');
        }
      });
    });
  </script>
</body>
</html>
