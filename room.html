<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix - Chat Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    /* Reuse styles from index.html and add room-specific styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      color: var(--text-primary);
    }

    .room-header {
      background: var(--header-bg);
      color: #FFFFFF;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .room-header h1 {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0;
    }

    .room-header .room-members {
      font-size: 0.875rem;
    }

    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--chat-bg);
    }

    .message-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
      max-width: 85%;
    }

    .message-item.self {
      align-self: flex-end;
      background: var(--twitter-blue);
      color: #FFFFFF;
      border-radius: 12px 12px 0 12px;
      padding: 0.75rem;
    }

    .message-item.other {
      align-self: flex-start;
      background: #FFFFFF;
      border: 1px solid var(--border);
      border-radius: 12px 12px 12px 0;
      padding: 0.75rem;
    }

    .message-sender {
      font-weight: 500;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    .message-content {
      font-size: 0.95rem;
      word-break: break-word;
    }

    .message-media {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 0.5rem;
    }

    .message-input-container {
      display: flex;
      padding: 0.75rem;
      background: var(--chat-bg);
      border-top: 1px solid var(--border);
      position: sticky;
      bottom: 0;
    }

    .message-input {
      flex: 1;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.95rem;
      outline: none;
      margin-right: 0.5rem;
    }

    .message-input:focus {
      border-color: var(--twitter-blue);
    }

    .send-btn, .media-btn {
      width: 40px;
      height: 40px;
      background: var(--twitter-blue);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .send-btn:hover, .media-btn:hover {
      transform: scale(1.1);
    }

    .send-btn svg, .media-btn svg {
      width: 24px;
      height: 24px;
      fill: #FFFFFF;
    }

    @media (max-width: 640px) {
      .room-header h1 {
        font-size: 1.1rem;
      }

      .room-header .room-members {
        font-size: 0.8rem;
      }

      .message-item {
        padding: 0.5rem;
      }

      .message-content {
        font-size: 0.9rem;
      }

      .message-input {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
      }

      .send-btn, .media-btn {
        width: 36px;
        height: 36px;
      }

      .send-btn svg, .media-btn svg {
        width: 20px;
        height: 20px;
      }
    }
  </style>
</head>
<body>
  <header class="room-header">
    <h1 id="room-name">Loading...</h1>
    <div class="room-members" id="room-members">0 members</div>
  </header>
  <div class="message-list" id="message-list"></div>
  <div class="message-input-container">
    <input type="text" id="message-input" class="message-input" placeholder="Type a message..." />
    <button class="media-btn" id="media-btn">
      <svg viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v6h4v2z" />
      </svg>
    </button>
    <button class="send-btn" id="send-btn">
      <svg viewBox="0 0 24 24">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
      </svg>
    </button>
    <input type="file" id="media-upload" style="display: none;" accept="image/jpeg,image/png,video/mp4" />
  </div>
  <div id="custom-alert" class="custom-alert">
    <button class="close-btn" onclick="window.hideAlert()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <p id="alert-message">An error occurred. Please try again later.</p>
    <div class="alert-buttons" id="alert-buttons">
      <button class="alert-btn confirm" id="alert-confirm" style="display: none;">OK</button>
      <button class="alert-btn cancel" id="alert-cancel" style="display: none;">Cancel</button>
    </div>
  </div>
  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
    <div id="progress-container" class="progress-container">
      <div id="progress-bar-upload" class="progress-bar-upload"></div>
      <span id="progress-text" class="progress-text">0%</span>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, push, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const roomName = document.getElementById('room-name');
    const roomMembers = document.getElementById('room-members');
    const messageList = document.getElementById('message-list');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const mediaBtn = document.getElementById('media-btn');
    const mediaUpload = document.getElementById('media-upload');
    const spinnerOverlay = document.getElementById('spinner-overlay');
    const progressContainer = document.getElementById('progress-container');
    const progressBarUpload = document.getElementById('progress-bar-upload');
    const progressText = document.getElementById('progress-text');

    // Reuse showAlert, hideAlert, encryptMessage, decryptMessage, formatTimestamp, uploadToCloudinary from index.html

    async function loadRoom(roomId, userId) {
      const roomRef = ref(db, `chatrooms/${roomId}`);
      const roomSnapshot = await get(roomRef);
      if (!roomSnapshot.exists()) {
        window.showAlert(MESSAGES.ROOM_NOT_FOUND, false);
        window.location.href = 'index.html';
        return;
      }
      const room = roomSnapshot.val();
      roomName.textContent = room.name;
      roomMembers.textContent = `${room.members ? Object.keys(room.members).length : 0} members`;

      onValue(ref(db, `chatrooms/${roomId}/messages`), async (snapshot) => {
        messageList.innerHTML = '';
        if (!snapshot.exists()) return;
        const messages = snapshot.val();
        const usersRef = ref(db, 'users');
        const userSnapshot = await get(usersRef);
        const users = userSnapshot.val() || {};
        Object.entries(messages).forEach(([messageId, message]) => {
          const messageItem = document.createElement('div');
          messageItem.className = `message-item ${message.senderId === userId ? 'self' : 'other'}`;
          const sender = users[message.senderId] || { name: 'Unknown' };
          const decryptedContent = message.content ? decryptMessage(message.content) : '';
          messageItem.innerHTML = `
            <div class="message-sender">${sender.name}</div>
            <div class="message-content">${decryptedContent}</div>
            ${message.mediaUrl ? `<img src="${message.mediaUrl}" class="message-media" alt="Media" />` : ''}
          `;
          messageList.appendChild(messageItem);
        });
        messageList.scrollTop = messageList.scrollHeight;
      });
    }

    async function sendMessage(roomId, userId, content, mediaFile = null) {
      try {
        let mediaUrl = null;
        let mediaType = 'text';
        if (mediaFile) {
          spinnerOverlay.classList.add('active');
          progressContainer.classList.add('active');
          spinnerOverlay.querySelector('.spinner').style.display = 'none';
          const uploadResult = await uploadToCloudinary(mediaFile, (percent) => {
            progressBarUpload.style.width = `${percent}%`;
            progressText.textContent = `${percent}%`;
          });
          mediaUrl = uploadResult.url;
          mediaType = uploadResult.resource_type;
        }
        const messageData = {
          senderId: userId,
          content: content ? encryptMessage(content) : '',
          mediaUrl,
          mediaType,
          timestamp: Date.now()
        };
        await push(ref(db, `chatrooms/${roomId}/messages`), messageData);
        messageInput.value = '';
        mediaUpload.value = '';
      } catch (error) {
        console.error('Error sending message:', error);
        window.showAlert(MESSAGES.ROOM_MESSAGE_FAIL, false);
      } finally {
        spinnerOverlay.classList.remove('active');
        progressContainer.classList.remove('active');
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const userId = user.uid;
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        if (roomId) {
          loadRoom(roomId, userId);
          sendBtn.onclick = () => {
            const content = messageInput.value.trim();
            if (content) {
              sendMessage(roomId, userId, content);
            }
          };
          mediaBtn.onclick = () => mediaUpload.click();
          mediaUpload.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
              sendMessage(roomId, userId, '', file);
            }
          };
        } else {
          window.showAlert(MESSAGES.ROOM_NOT_FOUND, false);
          window.location.href = 'index.html';
        }
      } else {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
