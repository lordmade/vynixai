<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix Statuses</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-md5@0.8.3/dist/md5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
  <style>
    :root {
      --primary-purple: #000;
      --secondary-teal: #000;
      --text-dark: #000;
      --text-light: #666;
      --border: #ddd;
      --white: #fff;
      --background: #fff;
      --card-background: #fff;
      --text-dark-dark: #f3f4f6;
      --text-light-dark: #9ca3af;
      --border-dark: #374151;
      --white-dark: #1f2937;
      --highlight: #f0f0f0;
    }

    [data-theme="dark"] {
      --background: #111827;
      --text-dark: var(--text-dark-dark);
      --text-light: var(--text-light-dark);
      --border: var(--border-dark);
      --white: var(--white-dark);
      --card-background: #1f2937;
      --highlight: #374151;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: background 0.3s ease, opacity 0.5s ease;
    }

    body.fade-out {
      opacity: 0;
    }

    .top-bar {
      background: var(--white);
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .title {
      font-size: 1.25rem;
      font-weight: bold;
      margin: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--white);
      background: linear-gradient(45deg, #7C3AED, #14B8A6);
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .notification-icon {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .main-content {
      padding: 1rem;
      background: var(--background);
      min-height: calc(100vh - 60px);
      box-sizing: border-box;
    }

    .search-container {
      margin-bottom: 1rem;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .search-input:focus {
      border-color: #000;
      outline: none;
    }

    .statuses-grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .status-card {
      background: var(--card-background);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .status-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .status-header .avatar {
      width: 48px;
      height: 48px;
      font-size: 1.5rem;
    }

    .status-user {
      flex: 1;
    }

    .status-username {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .status-timestamp {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .status-caption {
      font-size: 1rem;
      color: var(--text-dark);
    }

    .status-media {
      max-width: 100%;
      border-radius: 8px;
    }

    .status-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .like-btn, .comment-btn {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
    }

    .like-btn.liked {
      color: #ff4444;
    }

    .add-friend-btn {
      background: #4CAF50;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .comments-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .comment {
      background: var(--highlight);
      padding: 0.5rem;
      border-radius: 8px;
    }

    .comment-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 20px;
    }

    .post-fab {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      font-size: 2rem;
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .post-fab:hover {
      transform: scale(1.1);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 12px;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .modal-content button {
      padding: 0.5rem 1rem;
      background: var(--primary-purple);
      color: var(--white);
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }

    .loader {
      display: flex;
      gap: 10px;
      justify-content: center;
      padding: 2rem;
    }

    .dot {
      width: 14px;
      height: 14px;
      background: var(--primary-purple);
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .dot:nth-child(2) {
      animation-delay: 0.3s;
    }

    .dot:nth-child(3) {
      animation-delay: 0.6s;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.4); opacity: 0.3; }
    }

    .no-content {
      text-align: center;
      color: var(--text-light);
      font-size: 1.1rem;
      padding: 2rem;
    }

    @media (max-width: 767px) {
      .top-bar { padding: 0.75rem; }
      .title { font-size: 1.2rem; }
      .avatar { width: 28px; height: 28px; font-size: 1rem; }
      .notification-icon { width: 20px; height: 20px; }
      .status-card { padding: 0.75rem; }
      .status-header .avatar { width: 40px; height: 40px; }
      .status-username { font-size: 1rem; }
      .status-timestamp, .status-caption { font-size: 0.9rem; }
      .post-fab { bottom: 1rem; right: 1rem; }
      .modal-content { width: 95%; }
    }
  </style>
</head>
<body>
  <div class="top-bar" role="banner">
    <h1 class="title">Statuses</h1>
    <div class="user-info">
      <div class="avatar" id="user-avatar"></div>
      <svg class="notification-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
      </svg>
    </div>
  </div>
  <div class="main-content">
    <div class="search-container">
      <input type="text" id="search-statuses" placeholder="Search by username or caption" class="search-input" aria-label="Search Statuses">
    </div>
    <div class="statuses-grid" id="statuses-grid" aria-live="polite">
      <div class="loader">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>
  </div>
  <button class="post-fab" id="new-post-fab" aria-label="New Post">+</button>
  <div id="new-post-modal" class="modal">
    <div class="modal-content">
      <h2>New Status</h2>
      <textarea id="post-caption" placeholder="Caption" rows="3"></textarea>
      <input type="file" id="post-media" accept="image/*,video/*">
      <button id="upload-post">Post</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, get, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const statusesGrid = document.getElementById("statuses-grid");
    const searchInput = document.getElementById("search-statuses");
    const newPostFab = document.getElementById("new-post-fab");
    const newPostModal = document.getElementById("new-post-modal");
    const postCaption = document.getElementById("post-caption");
    const postMedia = document.getElementById("post-media");
    const uploadPost = document.getElementById("upload-post");
    const userAvatar = document.getElementById("user-avatar");

    const cloudName = 'your_cloud_name'; // Replace with your Cloudinary cloud name
    const uploadPreset = 'your_upload_preset'; // Replace with your unsigned upload preset

    let allStatuses = [];

    function generateAvatarColor(userId) {
      const colors = ['#7C3AED', '#14B8A6', '#EF4444', '#3B82F6', '#F59E0B'];
      const hash = md5(userId);
      return colors[parseInt(hash.substr(0, 8), 16) % colors.length];
    }

    function timeAgo(timestamp) {
      if (!timestamp) return "";
      const now = Date.now();
      const seconds = Math.floor((now - timestamp) / 1000);
      if (seconds < 60) return "Just now";
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} min${minutes > 1 ? "s" : ""} ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} hour${hours > 1 ? "s" : ""} ago`;
      const days = Math.floor(hours / 24);
      return `${days} day${days > 1 ? "s" : ""} ago`;
    }

    async function fetchUserData(userId) {
      const userRef = ref(db, `users/${userId}`);
      const userSnap = await get(userRef);
      return userSnap.exists() ? userSnap.val() : { displayName: "Unknown User" };
    }

    async function checkAuthState() {
      await setPersistence(auth, browserLocalPersistence);
      return new Promise((resolve) => {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            fetchUserData(user.uid).then(userData => {
              const displayUser = {
                uid: user.uid,
                displayName: userData.displayName || user.email.split("@")[0],
                photoURL: userData.photoURL
              };
              renderAvatar(displayUser);
              resolve(displayUser);
            });
          } else {
            window.location.href = "signup.html";
            resolve(null);
          }
        });
      });
    }

    function renderAvatar(user) {
      const initial = user.displayName.charAt(0).toUpperCase();
      if (user.photoURL) {
        userAvatar.innerHTML = `<img src="${DOMPurify.sanitize(user.photoURL)}" alt="${DOMPurify.sanitize(user.displayName)}'s profile picture" />`;
      } else {
        userAvatar.style.background = `linear-gradient(45deg, ${generateAvatarColor(user.uid)}, ${generateAvatarColor(user.uid + '1')})`;
        userAvatar.textContent = initial;
      }
    }

    function fisherYatesShuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    async function loadStatuses() {
      const statusesRef = ref(db, 'statuses');
      onValue(statusesRef, async (snapshot) => {
        allStatuses = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            allStatuses.push({ statusId: child.key, ...child.val() });
          });
        }
        allStatuses.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Recent at top
        // Optional partial shuffle after sorting (keeps recent near top)
        const shuffled = [...allStatuses];
        for (let i = allStatuses.length - 1; i > allStatuses.length * 0.3; i--) { // Shuffle last 70%
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        renderStatuses(shuffled);
      }, (error) => {
        console.error("Error loading statuses:", error);
        statusesGrid.innerHTML = '<p class="no-content">Failed to load statuses.</p>';
      });
    }

    async function renderStatuses(statuses) {
      statusesGrid.innerHTML = '';
      const userDataCache = {};
      const currentUserId = auth.currentUser?.uid;
      for (const status of statuses) {
        if (!userDataCache[status.userId]) {
          userDataCache[status.userId] = await fetchUserData(status.userId);
        }
        const userData = userDataCache[status.userId];
        const name = userData.displayName || "Unknown User";
        const isFriend = await checkFriendship(currentUserId, status.userId);
        const timeAgoStr = timeAgo(status.timestamp);
        const avatarContent = userData.photoURL ? `<img src="${DOMPurify.sanitize(userData.photoURL)}" alt="${name}'s avatar" />` : `<span>${name.charAt(0).toUpperCase()}</span>`;
        let mediaHtml = '';
        if (status.mediaUrl) {
          if (status.mediaUrl.endsWith('.mp4') || status.mediaUrl.includes('video')) {
            mediaHtml = `<video class="status-media" controls><source src="${DOMPurify.sanitize(status.mediaUrl)}" type="video/mp4"></video>`;
          } else {
            mediaHtml = `<img class="status-media" src="${DOMPurify.sanitize(status.mediaUrl)}" alt="Status media" />`;
          }
        }
        const card = document.createElement("div");
        card.className = "status-card";
        card.innerHTML = `
          <div class="status-header">
            <div class="avatar" style="background: linear-gradient(45deg, ${generateAvatarColor(status.userId)}, ${generateAvatarColor(status.userId + '1')})">${avatarContent}</div>
            <div class="status-user">
              <div class="status-username">${DOMPurify.sanitize(name)}</div>
              <div class="status-timestamp">${timeAgoStr}</div>
            </div>
            ${!isFriend && currentUserId !== status.userId ? '<button class="add-friend-btn" data-user-id="' + status.userId + '">Add Friend</button>' : ''}
          </div>
          <div class="status-caption">${DOMPurify.sanitize(status.caption || '')}</div>
          ${mediaHtml}
          <div class="status-actions">
            <button class="like-btn ${status.likers && status.likers.includes(currentUserId) ? 'liked' : ''}" data-status-id="${status.statusId}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
              <span class="like-count">${status.likes || 0}</span>
            </button>
            <button class="comment-btn" data-status-id="${status.statusId}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
              </svg>
            </button>
          </div>
          <div class="comments-section" data-status-id="${status.statusId}">
            <!-- Comments will be appended here -->
            <input type="text" class="comment-input" placeholder="Add a comment..." data-status-id="${status.statusId}">
          </div>
        `;
        statusesGrid.appendChild(card);
        loadComments(status.statusId);
      }
      attachEventListeners();
    }

    async function checkFriendship(userId, friendId) {
      if (!userId || !friendId || userId === friendId) return true; // Same user or no user
      const friendsRef = ref(db, `friends/${userId}/${friendId}`);
      const snapshot = await get(friendsRef);
      return snapshot.exists();
    }

    async function addFriend(userId, friendId) {
      const friendRef = ref(db, `friends/${userId}/${friendId}`);
      await set(friendRef, true);
      const userRef = ref(db, `friends/${friendId}/${userId}`);
      await set(userRef, true);
      console.log(`Added ${friendId} as friend for ${userId}`);
    }

    function attachEventListeners() {
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const statusId = btn.dataset.statusId;
          const userId = auth.currentUser.uid;
          const statusRef = ref(db, `statuses/${statusId}`);
          const statusSnap = await get(statusRef);
          let likers = statusSnap.val().likers || [];
          let likes = statusSnap.val().likes || 0;
          if (likers.includes(userId)) {
            likers = likers.filter(id => id !== userId);
            likes--;
            btn.classList.remove('liked');
          } else {
            likers.push(userId);
            likes++;
            btn.classList.add('liked');
          }
          update(statusRef, { likes, likers });
          btn.querySelector('.like-count').textContent = likes;
        });
      });

      document.querySelectorAll('.comment-input').forEach(input => {
        input.addEventListener('keypress', async (e) => {
          if (e.key === 'Enter' && input.value.trim()) {
            const statusId = input.dataset.statusId;
            const commentsRef = ref(db, `statuses/${statusId}/comments`);
            const newCommentRef = push(commentsRef);
            await set(newCommentRef, {
              userId: auth.currentUser.uid,
              text: input.value.trim(),
              timestamp: serverTimestamp()
            });
            input.value = '';
          }
        });
      });

      document.querySelectorAll('.add-friend-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const friendId = btn.dataset.userId;
          await addFriend(auth.currentUser.uid, friendId);
          btn.remove(); // Remove button after adding
        });
      });
    }

    function loadComments(statusId) {
      const commentsRef = ref(db, `statuses/${statusId}/comments`);
      onValue(commentsRef, async (snapshot) => {
        const commentsSection = document.querySelector(`.comments-section[data-status-id="${statusId}"]`);
        commentsSection.innerHTML = '<input type="text" class="comment-input" placeholder="Add a comment..." data-status-id="' + statusId + '">';
        if (snapshot.exists()) {
          const comments = [];
          snapshot.forEach(child => {
            comments.push({ commentId: child.key, ...child.val() });
          });
          comments.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
          const userDataCache = {};
          for (const comment of comments) {
            if (!userDataCache[comment.userId]) {
              userDataCache[comment.userId] = await fetchUserData(comment.userId);
            }
            const userData = userDataCache[comment.userId];
            const name = userData.displayName || "Unknown";
            const commentEl = document.createElement("div");
            commentEl.className = "comment";
            commentEl.innerHTML = `<strong>${DOMPurify.sanitize(name)}:</strong> ${DOMPurify.sanitize(comment.text)}`;
            commentsSection.insertBefore(commentEl, commentsSection.firstChild.nextSibling);
          }
        }
      });
    }

    function setupSearch() {
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const filtered = allStatuses.filter(status => {
          const userName = (await fetchUserData(status.userId)).displayName.toLowerCase();
          const caption = (status.caption || '').toLowerCase();
          return userName.includes(query) || caption.includes(query);
        });
        renderStatuses(filtered);
      });
    }

    function setupNewPost() {
      newPostFab.addEventListener('click', () => {
        newPostModal.classList.add('active');
      });
      newPostModal.addEventListener('click', (e) => {
        if (e.target === newPostModal) newPostModal.classList.remove('active');
      });
      uploadPost.addEventListener('click', async () => {
        const caption = postCaption.value.trim();
        const file = postMedia.files[0];
        if (!caption && !file) return;
        let mediaUrl = '';
        if (file) {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', uploadPreset);
          const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          mediaUrl = data.secure_url;
        }
        const statusesRef = ref(db, 'statuses');
        const newStatusRef = push(statusesRef);
        await set(newStatusRef, {
          userId: auth.currentUser.uid,
          caption,
          mediaUrl,
          timestamp: serverTimestamp(),
          likes: 0,
          likers: []
        });
        postCaption.value = '';
        postMedia.value = '';
        newPostModal.classList.remove('active');
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const user = await checkAuthState();
      if (user) {
        loadStatuses();
        setupSearch();
        setupNewPost();
      }
    });
  </script>
</body>
</html>
