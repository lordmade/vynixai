<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vynix - Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --background: #FFFFFF;
      --chat-bg: #F5F7FB;
      --text-primary: #111B21;
      --text-secondary: #667781;
      --border: #E9ECEF;
      --accent: #00A884;
      --status-bar: #D9D9D9;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      overscroll-behavior: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--background);
    }

    .header-back {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
    }

    .header-back svg {
      width: 24px;
      height: 24px;
    }

    .settings-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .settings-section {
      margin-bottom: 1.5rem;
    }

    .settings-section h2 {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }

    .settings-item label {
      font-size: 1rem;
      color: var(--text-primary);
    }

    .settings-item select,
    .settings-item input[type="checkbox"] {
      outline: none;
    }

    .settings-item select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
    }

    .settings-item input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      accent-color: var(--accent);
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      background: var(--chat-bg);
      color: var(--text-primary);
      outline: none;
    }

    .input-group input:focus {
      border-color: var(--accent);
    }

    .btn.primary {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn.primary:hover {
      background: #00976F;
    }

    .btn.danger {
      width: 100%;
      padding: 0.75rem;
      background: #FF3B30;
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn.danger:hover {
      background: #D32F2F;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .custom-alert.active {
      display: flex;
    }

    .alert-content {
      background: var(--background);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .alert-content p {
      margin: 0 0 1rem;
      font-size: 1rem;
    }

    .alert-content input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-primary);
      display: none;
    }

    .blocked-users-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--chat-bg);
    }

    .blocked-user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .blocked-user-item:last-child {
      border-bottom: none;
    }

    .blocked-user-item button {
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
      cursor: pointer;
    }

    .blocked-user-item button:hover {
      background: #00976F;
    }

    .policy-content {
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 640px) {
      .header { padding: 0.75rem; }
      .settings-container { padding: 1rem; }
      .settings-section h2 { font-size: 1.1rem; }
      .settings-item label { font-size: 0.95rem; }
      .settings-item select { font-size: 0.9rem; padding: 0.5rem; }
      .input-group input { font-size: 0.9rem; padding: 0.5rem; }
      .btn.primary, .btn.danger { padding: 0.5rem; font-size: 0.95rem; }
      .blocked-users-list { max-height: 150px; }
      .policy-content { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="header-back" onclick="window.history.back()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 18l-6-6 6-6"></path>
      </svg>
    </button>
    <span class="font-semibold">Settings</span>
    <div></div> <!-- Spacer for alignment -->
  </div>
  <div class="settings-container">
    <div class="settings-section">
      <h2>Account</h2>
      <div class="settings-item" id="change-password">
        <label>Change Password</label>
      </div>
      <div class="settings-item" id="two-factor-auth">
        <label>Two-Factor Authentication</label>
        <input type="checkbox" id="two-factor-toggle" />
      </div>
      <div class="settings-item" id="sign-out">
        <label>Sign Out</label>
      </div>
    </div>
    <div class="settings-section">
      <h2>Privacy and Policy</h2>
      <div class="settings-item" id="privacy-policy">
        <label>Privacy Policy</label>
      </div>
      <div class="settings-item" id="terms-service">
        <label>Terms of Service</label>
      </div>
      <div class="settings-item" id="manage-blocked-users">
        <label>Manage Blocked Users</label>
      </div>
    </div>
    <div class="settings-section">
      <h2>Preferences</h2>
      <div class="settings-item">
        <label>Notifications</label>
        <input type="checkbox" id="notifications-toggle" />
      </div>
      <div class="settings-item">
        <label>Theme</label>
        <select id="theme-select">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
      <div class="settings-item">
        <label>Language</label>
        <select id="language-select">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
        </select>
      </div>
    </div>
    <div class="settings-section">
      <h2>Data Controls</h2>
      <div class="settings-item" id="chat-backup">
        <label>Chat Backup</label>
        <input type="checkbox" id="chat-backup-toggle" />
      </div>
      <div class="settings-item" id="delete-chat-history">
        <label>Delete Chat History</label>
      </div>
      <div class="settings-item" id="disable-memory">
        <label>Disable Chat Memory</label>
      </div>
    </div>
  </div>
  <div id="custom-alert" class="custom-alert">
    <div class="alert-content">
      <p id="alert-message"></p>
      <input id="alert-input-current" type="password" placeholder="Current Password" style="display: none;" />
      <input id="alert-input-new" type="password" placeholder="New Password" style="display: none;" />
      <input id="alert-input-confirm" type="password" placeholder="Confirm New Password" style="display: none;" />
      <div id="blocked-users-list" class="blocked-users-list" style="display: none;"></div>
      <div id="policy-content" class="policy-content" style="display: none;"></div>
      <div id="alert-buttons" class="alert-buttons">
        <button id="alert-confirm">OK</button>
        <button id="alert-cancel">Cancel</button>
      </div>
    </div>
  </div>
  <div id="spinner-overlay" class="spinner-overlay">
    <div class="spinner"></div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const changePasswordItem = document.getElementById("change-password");
    const twoFactorToggle = document.getElementById("two-factor-toggle");
    const signOutItem = document.getElementById("sign-out");
    const notificationsToggle = document.getElementById("notifications-toggle");
    const themeSelect = document.getElementById("theme-select");
    const languageSelect = document.getElementById("language-select");
    const chatBackupToggle = document.getElementById("chat-backup-toggle");
    const deleteChatHistoryItem = document.getElementById("delete-chat-history");
    const disableMemoryItem = document.getElementById("disable-memory");
    const privacyPolicyItem = document.getElementById("privacy-policy");
    const termsServiceItem = document.getElementById("terms-service");
    const manageBlockedUsersItem = document.getElementById("manage-blocked-users");
    const spinnerOverlay = document.getElementById("spinner-overlay");
    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    const alertInputCurrent = document.getElementById("alert-input-current");
    const alertInputNew = document.getElementById("alert-input-new");
    const alertInputConfirm = document.getElementById("alert-input-confirm");
    const blockedUsersList = document.getElementById("blocked-users-list");
    const policyContent = document.getElementById("policy-content");
    const alertConfirm = document.getElementById("alert-confirm");
    const alertCancel = document.getElementById("alert-cancel");

    const MESSAGES = {
      SIGN_IN_REQUIRED: "Please sign in to view this page.",
      PASSWORD_UPDATE_SUCCESS: "Password updated successfully!",
      PASSWORD_UPDATE_FAIL: "Failed to update password.",
      REAUTHENTICATION_FAIL: "Current password is incorrect.",
      PASSWORDS_DO_NOT_MATCH: "New passwords do not match.",
      PASSWORD_TOO_SHORT: "New password must be at least 6 characters.",
      SETTINGS_UPDATE_SUCCESS: "Settings updated successfully!",
      SETTINGS_UPDATE_FAIL: "Failed to update settings.",
      TWO_FACTOR_SUCCESS: "Two-factor authentication updated successfully!",
      TWO_FACTOR_FAIL: "Failed to update two-factor authentication.",
      LANGUAGE_SUCCESS: "Language updated successfully!",
      LANGUAGE_FAIL: "Failed to update language.",
      CHAT_BACKUP_SUCCESS: "Chat backup settings updated successfully!",
      CHAT_BACKUP_FAIL: "Failed to update chat backup settings.",
      DELETE_CHAT_HISTORY_SUCCESS: "Chat history deleted successfully!",
      DELETE_CHAT_HISTORY_FAIL: "Failed to delete chat history.",
      DISABLE_MEMORY_GUIDE: "To disable chat memory, go to 'Settings' > 'Data Controls' > 'Disable Chat Memory' and confirm. To delete specific conversations, navigate to the chat and select 'Clear Chat'.",
      UNBLOCK_SUCCESS: "User unblocked successfully!",
      UNBLOCK_FAIL: "Failed to unblock user."
    };

    // Alert Functions
    window.showAlert = function (message, autoHide = true, inputs = [], contentElement = null, confirmCallback = null, cancelCallback = null) {
      return new Promise((resolve) => {
        alertMessage.textContent = message;
        alertInputCurrent.style.display = inputs.includes("current") ? "block" : "none";
        alertInputNew.style.display = inputs.includes("new") ? "block" : "none";
        alertInputConfirm.style.display = inputs.includes("confirm") ? "block" : "none";
        blockedUsersList.style.display = contentElement === "blocked-users" ? "block" : "none";
        policyContent.style.display = contentElement === "policy" ? "block" : "none";
        alertConfirm.style.display = confirmCallback ? "block" : "none";
        alertCancel.style.display = cancelCallback ? "block" : "none";
        customAlert.classList.add("active");

        if (inputs.includes("current")) alertInputCurrent.focus();
        else if (inputs.includes("new")) alertInputNew.focus();
        else if (inputs.includes("confirm")) alertInputConfirm.focus();

        if (autoHide && !confirmCallback && !cancelCallback) {
          setTimeout(() => window.hideAlert(), 5000);
        }

        alertConfirm.onclick = () => {
          if (confirmCallback) {
            confirmCallback({
              current: alertInputCurrent.value,
              new: alertInputNew.value,
              confirm: alertInputConfirm.value
            });
          }
          resolve(true);
          window.hideAlert();
        };

        alertCancel.onclick = () => {
          if (cancelCallback) cancelCallback();
          resolve(false);
          window.hideAlert();
        };
      });
    };

    window.hideAlert = function () {
      customAlert.classList.remove("active");
      alertInputCurrent.style.display = "none";
      alertInputNew.style.display = "none";
      alertInputConfirm.style.display = "none";
      blockedUsersList.style.display = "none";
      policyContent.style.display = "none";
      alertInputCurrent.value = "";
      alertInputNew.value = "";
      alertInputConfirm.value = "";
      blockedUsersList.innerHTML = "";
      policyContent.innerHTML = "";
      alertConfirm.style.display = "none";
      alertCancel.style.display = "none";
    };

    // Load User Settings
    async function loadUserSettings(userId) {
      spinnerOverlay.classList.add("active");
      try {
        const settingsRef = ref(db, `users/${userId}/settings`);
        const snapshot = await get(settingsRef);
        const settings = snapshot.exists() ? snapshot.val() : {
          notifications: true,
          theme: "light",
          twoFactor: false,
          language: "en",
          chatBackup: false
        };
        notificationsToggle.checked = settings.notifications !== false;
        themeSelect.value = settings.theme || "light";
        twoFactorToggle.checked = settings.twoFactor || false;
        languageSelect.value = settings.language || "en";
        chatBackupToggle.checked = settings.chatBackup || false;
        applyTheme(settings.theme || "light");
      } catch (error) {
        console.error("Error loading settings:", error);
        window.showAlert(MESSAGES.SETTINGS_UPDATE_FAIL, false);
      } finally {
        spinnerOverlay.classList.remove("active");
      }
    }

    // Save User Settings
    async function saveUserSettings(userId, settings) {
      try {
        await update(ref(db, `users/${userId}/settings`), settings);
        window.showAlert(MESSAGES.SETTINGS_UPDATE_SUCCESS, true);
      } catch (error) {
        console.error("Error saving settings:", error);
        window.showAlert(MESSAGES.SETTINGS_UPDATE_FAIL, false);
        throw error;
      }
    }

    // Apply Theme
    function applyTheme(theme) {
      if (theme === "dark") {
        document.documentElement.style.setProperty("--background", "#111B21");
        document.documentElement.style.setProperty("--chat-bg", "#202C33");
        document.documentElement.style.setProperty("--text-primary", "#E9ECEF");
        document.documentElement.style.setProperty("--text-secondary", "#8696A0");
        document.documentElement.style.setProperty("--border", "#2A3942");
        document.documentElement.style.setProperty("--accent", "#00A884");
        document.documentElement.style.setProperty("--status-bar", "#2A3942");
      } else {
        document.documentElement.style.setProperty("--background", "#FFFFFF");
        document.documentElement.style.setProperty("--chat-bg", "#F5F7FB");
        document.documentElement.style.setProperty("--text-primary", "#111B21");
        document.documentElement.style.setProperty("--text-secondary", "#667781");
        document.documentElement.style.setProperty("--border", "#E9ECEF");
        document.documentElement.style.setProperty("--accent", "#00A884");
        document.documentElement.style.setProperty("--status-bar", "#D9D9D9");
      }
    }

    // Load Blocked Users
    async function loadBlockedUsers(userId) {
      try {
        const blockedRef = ref(db, `users/${userId}/blocked`);
        const snapshot = await get(blockedRef);
        if (!snapshot.exists()) {
          blockedUsersList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No blocked users.</p>';
          return;
        }
        blockedUsersList.innerHTML = '';
        const blockedUsers = snapshot.val();
        for (const [blockedUserId, _] of Object.entries(blockedUsers)) {
          const userRef = ref(db, `users/${blockedUserId}`);
          const userSnapshot = await get(userRef);
          const userName = userSnapshot.exists() ? userSnapshot.val().name || 'Unknown' : 'Unknown';
          const userItem = document.createElement('div');
          userItem.className = 'blocked-user-item';
          userItem.innerHTML = `
            <span>${userName}</span>
            <button data-userid="${blockedUserId}">Unblock</button>
          `;
          userItem.querySelector('button').addEventListener('click', async () => {
            try {
              await remove(ref(db, `users/${userId}/blocked/${blockedUserId}`));
              window.showAlert(MESSAGES.UNBLOCK_SUCCESS, true);
              loadBlockedUsers(userId); // Refresh list
            } catch (error) {
              console.error("Error unblocking user:", error);
              window.showAlert(MESSAGES.UNBLOCK_FAIL, false);
            }
          });
          blockedUsersList.appendChild(userItem);
        }
      } catch (error) {
        console.error("Error loading blocked users:", error);
        window.showAlert(MESSAGES.SETTINGS_UPDATE_FAIL, false);
      }
    }

    // Delete All Chat History
    async function deleteAllChatHistory(userId) {
      try {
        const chatsRef = ref(db, `users/${userId}/chats`);
        const chatsSnapshot = await get(chatsRef);
        if (chatsSnapshot.exists()) {
          const chats = chatsSnapshot.val();
          for (const [chatId, chat] of Object.entries(chats)) {
            if (chat.type === 'friend') {
              const targetChatId = userId < chatId ? `${userId}_${chatId}` : `${chatId}_${userId}`;
              await remove(ref(db, `chats/${targetChatId}`));
            } else if (chat.type === 'room') {
              await remove(ref(db, `chatrooms/${chatId}/messages`));
            } else if (chat.type === 'group') {
              await remove(ref(db, `groups/${chatId}/messages`));
            }
          }
          await remove(chatsRef);
        }
        window.showAlert(MESSAGES.DELETE_CHAT_HISTORY_SUCCESS, true);
      } catch (error) {
        console.error("Error deleting chat history:", error);
        window.showAlert(MESSAGES.DELETE_CHAT_HISTORY_FAIL, false);
      }
    }

    // Initialize
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadUserSettings(user.uid);

        // Change Password
        changePasswordItem.addEventListener("click", async () => {
          await window.showAlert(
            "Enter your current and new password:",
            false,
            ["current", "new", "confirm"],
            async (passwords) => {
              if (passwords.new !== passwords.confirm) {
                window.showAlert(MESSAGES.PASSWORDS_DO_NOT_MATCH, false);
                return;
              }
              if (passwords.new.length < 6) {
                window.showAlert(MESSAGES.PASSWORD_TOO_SHORT, false);
                return;
              }
              spinnerOverlay.classList.add("active");
              try {
                const credential = EmailAuthProvider.credential(user.email, passwords.current);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, passwords.new);
                window.showAlert(MESSAGES.PASSWORD_UPDATE_SUCCESS, true);
              } catch (error) {
                console.error("Error updating password:", error);
                window.showAlert(error.code === "auth/wrong-password" ? MESSAGES.REAUTHENTICATION_FAIL : MESSAGES.PASSWORD_UPDATE_FAIL, false);
              } finally {
                spinnerOverlay.classList.remove("active");
              }
            },
            () => {}
          );
        });

        // Two-Factor Authentication
        twoFactorToggle.addEventListener("change", async () => {
          spinnerOverlay.classList.add("active");
          try {
            await saveUserSettings(user.uid, { twoFactor: twoFactorToggle.checked });
            window.showAlert(MESSAGES.TWO_FACTOR_SUCCESS, true);
          } catch (error) {
            twoFactorToggle.checked = !twoFactorToggle.checked; // Revert on error
            window.showAlert(MESSAGES.TWO_FACTOR_FAIL, false);
          } finally {
            spinnerOverlay.classList.remove("active");
          }
        });

        // Sign Out
        signOutItem.addEventListener("click", async () => {
          const confirmed = await window.showAlert(
            "Are you sure you want to sign out?",
            false,
            [],
            async () => {
              try {
                await auth.signOut();
                window.location.href = "login.html";
              } catch (error) {
                console.error("Error signing out:", error);
                window.showAlert("Failed to sign out.", false);
              }
            },
            () => {}
          );
        });

        // Notifications Toggle
        notificationsToggle.addEventListener("change", async () => {
          spinnerOverlay.classList.add("active");
          try {
            await saveUserSettings(user.uid, { notifications: notificationsToggle.checked });
          } catch (error) {
            notificationsToggle.checked = !notificationsToggle.checked; // Revert on error
            window.showAlert(MESSAGES.SETTINGS_UPDATE_FAIL, false);
          } finally {
            spinnerOverlay.classList.remove("active");
          }
        });

        // Theme Selection
        themeSelect.addEventListener("change", async () => {
          spinnerOverlay.classList.add("active");
          try {
            await saveUserSettings(user.uid, { theme: themeSelect.value });
            applyTheme(themeSelect.value);
          } catch (error) {
            themeSelect.value = themeSelect.value === "light" ? "dark" : "light"; // Revert on error
            window.showAlert(MESSAGES.SETTINGS_UPDATE_FAIL, false);
          } finally {
            spinnerOverlay.classList.remove("active");
          }
        });

        // Language Selection
        languageSelect.addEventListener("change", async () => {
          spinnerOverlay.classList.add("active");
          try {
            await saveUserSettings(user.uid, { language: languageSelect.value });
            window.showAlert(MESSAGES.LANGUAGE_SUCCESS, true);
          } catch (error) {
            languageSelect.value = languageSelect.value === "en" ? "es" : "en"; // Revert on error
            window.showAlert(MESSAGES.LANGUAGE_FAIL, false);
          } finally {
            spinnerOverlay.classList.remove("active");
          }
        });

        // Chat Backup Toggle
        chatBackupToggle.addEventListener("change", async () => {
          spinnerOverlay.classList.add("active");
          try {
            await saveUserSettings(user.uid, { chatBackup: chatBackupToggle.checked });
            window.showAlert(MESSAGES.CHAT_BACKUP_SUCCESS, true);
          } catch (error) {
            chatBackupToggle.checked = !chatBackupToggle.checked; // Revert on error
            window.showAlert(MESSAGES.CHAT_BACKUP_FAIL, false);
          } finally {
            spinnerOverlay.classList.remove("active");
          }
        });

        // Delete Chat History
        deleteChatHistoryItem.addEventListener("click", async () => {
          await window.showAlert(
            "Are you sure you want to delete all chat history? This cannot be undone.",
            false,
            [],
            async () => {
              spinnerOverlay.classList.add("active");
              try {
                await deleteAllChatHistory(user.uid);
              } catch (error) {
                window.showAlert(MESSAGES.DELETE_CHAT_HISTORY_FAIL, false);
              } finally {
                spinnerOverlay.classList.remove("active");
              }
            },
            () => {}
          );
        });

        // Disable Chat Memory
        disableMemoryItem.addEventListener("click", async () => {
          await window.showAlert(
            MESSAGES.DISABLE_MEMORY_GUIDE,
            false,
            [],
            () => {},
            () => {}
          );
        });

        // Privacy Policy
        privacyPolicyItem.addEventListener("click", async () => {
          const policyText = `
            <h3>Privacy Policy</h3>
            <p>Your privacy is important to us. This policy outlines how we collect, use, and protect your personal information. We collect data such as your email, username, and chat messages to provide and improve our services. All messages are encrypted for security. We do not share your data with third parties except as required by law. For more details, please contact our support team.</p>
          `;
          policyContent.innerHTML = policyText;
          await window.showAlert(
            "Privacy Policy",
            false,
            [],
            "policy",
            () => {},
            () => {}
          );
        });

        // Terms of Service
        termsServiceItem.addEventListener("click", async () => {
          const termsText = `
            <h3>Terms of Service</h3>
            <p>By using Vynix, you agree to our terms of service. You must not misuse our services, including sending spam or harmful content. We reserve the right to suspend accounts that violate these terms. For full terms, please contact our support team.</p>
          `;
          policyContent.innerHTML = termsText;
          await window.showAlert(
            "Terms of Service",
            false,
            [],
            "policy",
            () => {},
            () => {}
          );
        });

        // Manage Blocked Users
        manageBlockedUsersItem.addEventListener("click", async () => {
          await loadBlockedUsers(user.uid);
          await window.showAlert(
            "Manage Blocked Users",
            false,
            [],
            "blocked-users",
            () => {},
            () => {}
          );
        });
      } else {
        window.showAlert(MESSAGES.SIGN_IN_REQUIRED, false);
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
